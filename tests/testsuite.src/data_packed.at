## Copyright (C) 2003-2012, 2014-2016, 2018-2019, 2022-2023
## Free Software Foundation, Inc.
## Written by Keisuke Nishida, Roger While, Edward Hart, Simon Sobisch,
## Ron Norman
## 
## This file is part of GnuCOBOL.
## 
## The GnuCOBOL compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
## 
## GnuCOBOL is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with GnuCOBOL.  If not, see <https://www.gnu.org/licenses/>.

### GnuCOBOL Test Suite

### PACKED-DECIMAL


# dump
AT_SETUP([PACKED-DECIMAL dump])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([dump.c], [
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
dump (unsigned char *data)
{
  int i;
  for (i = 0; i < 10; i++)
    printf ("%02x", data[[i]]);
  puts ("");
  return 0;
}
])

sed -e 's/@USAGE@/PACKED-DECIMAL/' "${TEMPLATE}/numeric-dump.cob" > prog.cob

AT_CHECK([$COMPILE_MODULE dump.c], [0], [], [])
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[1f202020202020202020
012f2020202020202020
123f2020202020202020
01234f20202020202020
12345f20202020202020
0123456f202020202020
1234567f202020202020
012345678f2020202020
123456789f2020202020
01234567890f20202020
12345678901f20202020
0123456789012f202020
1234567890123f202020
012345678901234f2020
123456789012345f2020
01234567890123456f20
12345678901234567f20
0123456789012345678f
1d202020202020202020
012d2020202020202020
123d2020202020202020
01234d20202020202020
12345d20202020202020
0123456d202020202020
1234567d202020202020
012345678d2020202020
123456789d2020202020
01234567890d20202020
12345678901d20202020
0123456789012d202020
1234567890123d202020
012345678901234d2020
123456789012345d2020
01234567890123456d20
12345678901234567d20
0123456789012345678d
0f202020202020202020
000f2020202020202020
000f2020202020202020
00000f20202020202020
00000f20202020202020
0000000f202020202020
0000000f202020202020
000000000f2020202020
000000000f2020202020
00000000000f20202020
00000000000f20202020
0000000000000f202020
0000000000000f202020
000000000000000f2020
000000000000000f2020
00000000000000000f20
00000000000000000f20
0000000000000000000f
0c202020202020202020
000c2020202020202020
000c2020202020202020
00000c20202020202020
00000c20202020202020
0000000c202020202020
0000000c202020202020
000000000c2020202020
000000000c2020202020
00000000000c20202020
00000000000c20202020
0000000000000c202020
0000000000000c202020
000000000000000c2020
000000000000000c2020
00000000000000000c20
00000000000000000c20
0000000000000000000c
0f202020202020202020
000f2020202020202020
000f2020202020202020
00000f20202020202020
00000f20202020202020
0000000f202020202020
0000000f202020202020
000000000f2020202020
000000000f2020202020
00000000000f20202020
00000000000f20202020
0000000000000f202020
0000000000000f202020
000000000000000f2020
000000000000000f2020
00000000000000000f20
00000000000000000f20
0000000000000000000f
0c202020202020202020
000c2020202020202020
000c2020202020202020
00000c20202020202020
00000c20202020202020
0000000c202020202020
0000000c202020202020
000000000c2020202020
000000000c2020202020
00000000000c20202020
00000000000c20202020
0000000000000c202020
0000000000000c202020
000000000000000c2020
000000000000000c2020
00000000000000000c20
00000000000000000c20
0000000000000000000c
])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL used with DISPLAY])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-99          PIC 99   USAGE PACKED-DECIMAL.
       01 X-S99         PIC S99  USAGE PACKED-DECIMAL.
       01 X-999         PIC 999  USAGE PACKED-DECIMAL.
       01 X-S999        PIC S999 USAGE PACKED-DECIMAL.
       01 B-P1234       USAGE BINARY-LONG VALUE 1234.
       01 B-N1234       USAGE BINARY-LONG VALUE -1234.
       PROCEDURE        DIVISION.
           MOVE    0 TO X-99
           DISPLAY X-99.
           MOVE   99 TO X-99
           DISPLAY X-99.
           MOVE    0 TO X-S99
           DISPLAY X-S99.
           MOVE   -1 TO X-S99
           DISPLAY X-S99.
           MOVE    0 TO X-999
           DISPLAY X-999.
           MOVE  123 TO X-999
           DISPLAY X-999.
           MOVE    0 TO X-S999
           DISPLAY X-S999.
           MOVE -123 TO X-S999
           DISPLAY X-S999.
           MOVE B-P1234 TO X-S999
           DISPLAY X-S999.
           MOVE B-N1234 TO X-S999
           DISPLAY X-S999.
           MOVE B-N1234 TO X-999
           DISPLAY X-999.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00
99
+00
-01
000
123
+000
-123
+234
-234
234
])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL used with MOVE])
AT_KEYWORDS([DISPLAY])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-99          PIC 99   USAGE PACKED-DECIMAL.
       01 X-S99         PIC S99  USAGE PACKED-DECIMAL.
       01 X-999         PIC 999  USAGE PACKED-DECIMAL.
       01 X-S999        PIC S999 USAGE PACKED-DECIMAL.
       01 C-P1234       PIC 9999  VALUE 1234.
       01 C-N1234       PIC S9999 VALUE -1234.
       01 B-P1234       USAGE BINARY-LONG VALUE 1234.
       01 B-N1234       USAGE BINARY-LONG VALUE -1234.
       PROCEDURE        DIVISION.
           MOVE C-P1234 TO X-99
           DISPLAY X-99.
           MOVE C-P1234 TO X-S99
           DISPLAY X-S99.
           MOVE C-P1234 TO X-999
           DISPLAY X-999.
           MOVE C-P1234 TO X-S999
           DISPLAY X-S999.
           MOVE C-N1234 TO X-99
           DISPLAY X-99.
           MOVE C-N1234 TO X-S99
           DISPLAY X-S99.
           MOVE C-N1234 TO X-999
           DISPLAY X-999.
           MOVE C-N1234 TO X-S999
           DISPLAY X-S999.
           MOVE B-N1234 TO X-999
           DISPLAY X-999.
           MOVE B-N1234 TO X-S999
           DISPLAY X-S999.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[34
+34
234
+234
34
-34
234
-234
234
-234
])

AT_CLEANUP


AT_SETUP([MOVE PACKED-DECIMAL to PACKED-DECIMAL])
AT_KEYWORDS([fundamental PPP])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  P-S99V99     PIC S99V99 PACKED-DECIMAL VALUE  1.23.
       01  P-N99V99     PIC S99V99 PACKED-DECIMAL VALUE -1.32.
       01  P-9V99       PIC   9V99 PACKED-DECIMAL VALUE  1.1.
       01  P-S99        PIC S99    PACKED-DECIMAL VALUE  12.
       01  P-99         PIC  99    PACKED-DECIMAL VALUE  2.
       01  P-P99        PIC P99    PACKED-DECIMAL VALUE  0.02.
       01  P-9PP        PIC 9PP    PACKED-DECIMAL VALUE  200.
       01  B-S99V99     PIC S99V99 PACKED-DECIMAL.
       01  B-99V9       PIC  99V9  PACKED-DECIMAL.
       01  B-S999       PIC S999   PACKED-DECIMAL.
       01  B-99         PIC  99    PACKED-DECIMAL.
       01  B-P9         PIC  P9    PACKED-DECIMAL.
       01  B-9P         PIC  9P    PACKED-DECIMAL.
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.

       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 20000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.

           MOVE P-S99V99 TO B-S99V99
           IF B-S99V99 NOT = 1.23
              DISPLAY "B-S99V99 1: " B-S99V99.
           MOVE P-N99V99 TO B-S99V99
           IF B-S99V99 NOT = -1.32
              DISPLAY "B-S99V99 2: " B-S99V99.
           MOVE P-9V99   TO B-S99V99
           IF B-S99V99 NOT = 1.1
              DISPLAY "B-S99V99 3: " B-S99V99.
           MOVE P-S99    TO B-S99V99
           IF B-S99V99 NOT = 12
              DISPLAY "B-S99V99 4: " B-S99V99.
           MOVE P-99     TO B-S99V99
           IF B-S99V99 NOT = 2
              DISPLAY "B-S99V99 5: " B-S99V99.
           MOVE P-P99    TO B-S99V99
           IF B-S99V99 NOT = 0.02
              DISPLAY "B-S99V99 6: " B-S99V99.
           MOVE P-9PP    TO B-S99V99
           IF B-S99V99 NOT = 0
              DISPLAY "B-S99V99 7: " B-S99V99.

           MOVE P-S99V99 TO B-99V9 
           IF B-99V9  NOT = 1.2
              DISPLAY "B-99V99  1: " B-99V9  .
           MOVE P-N99V99 TO B-99V9 
           IF B-99V9  NOT = 1.3
              DISPLAY "B-99V99  2: " B-99V9  .
           MOVE P-9V99   TO B-99V9 
           IF B-99V9  NOT = 1.1
              DISPLAY "B-99V99  3: " B-99V9  .
           MOVE P-S99    TO B-99V9 
           IF B-99V9  NOT = 12
              DISPLAY "B-99V99  4: " B-99V9  .
           MOVE P-99     TO B-99V9 
           IF B-99V9  NOT = 2
              DISPLAY "B-99V99  5: " B-99V9  .
           MOVE P-P99    TO B-99V9 
           IF B-99V9  NOT = 0
              DISPLAY "B-99V99  6: " B-99V9  .
           MOVE P-9PP    TO B-99V9 
           IF B-99V9  NOT = 0
              DISPLAY "B-99V99  7: " B-99V9  .

           MOVE P-S99V99 TO B-S999
           IF B-S999   NOT = 1
              DISPLAY "B-S999   1: " B-S999  .
           MOVE P-N99V99 TO B-S999
           IF B-S999   NOT = -1
              DISPLAY "B-S999   2: " B-S999  .
           MOVE P-9V99   TO B-S999
           IF B-S999   NOT = 1
              DISPLAY "B-S999   3: " B-S999  .
           MOVE P-S99    TO B-S999
           IF B-S999   NOT = 12
              DISPLAY "B-S999   4: " B-S999  .
           MOVE P-99     TO B-S999
           IF B-S999   NOT = 2
              DISPLAY "B-S999   5: " B-S999  .
           MOVE P-P99    TO B-S999
           IF B-S999   NOT = 0
              DISPLAY "B-S999   6: " B-S999  .
           MOVE P-9PP    TO B-S999
           IF B-S999   NOT = 200
              DISPLAY "B-S999   7: " B-S999  .

           MOVE P-S99V99 TO B-99
           IF B-99     NOT = 1
              DISPLAY "B-99     1: " B-99    .
           MOVE P-N99V99 TO B-99
           IF B-99     NOT = 1
              DISPLAY "B-99     2: " B-99    .
           MOVE P-9V99   TO B-99
           IF B-99     NOT = 1
              DISPLAY "B-99     3: " B-99    .
           MOVE P-S99    TO B-99
           IF B-99     NOT = 12
              DISPLAY "B-99     4: " B-99    .
           MOVE P-99     TO B-99
           IF B-99     NOT = 2
              DISPLAY "B-99     5: " B-99    .
           MOVE P-P99    TO B-99
           IF B-99     NOT = 0
              DISPLAY "B-99     6: " B-99    .
           MOVE P-9PP    TO B-99
           IF B-99     NOT = 0
              DISPLAY "B-99     7: " B-99    .

           MOVE P-S99V99 TO B-P9
           IF B-P9     NOT = 0.03
              DISPLAY "B-P9     1: " B-P9    .
           MOVE P-N99V99 TO B-P9
           IF B-P9     NOT = 0.02
              DISPLAY "B-P9     2: " B-P9    .
           MOVE P-9V99   TO B-P9
           IF B-P9     NOT = 0
              DISPLAY "B-P9     3: " B-P9    .
           MOVE P-S99    TO B-P9
           IF B-P9     NOT = 0
              DISPLAY "B-P9     4: " B-P9    .
           MOVE P-99     TO B-P9
           IF B-P9     NOT = 0
              DISPLAY "B-P9     5: " B-P9    .
           MOVE P-P99    TO B-P9
           IF B-P9     NOT = 0.02
              DISPLAY "B-P9     6: " B-P9    .
           MOVE P-9PP    TO B-P9
           IF B-P9     NOT = 0
              DISPLAY "B-P9     7: " B-P9    .

           MOVE P-S99V99 TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     1: " B-9P    .
           MOVE P-N99V99 TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     2: " B-9P    .
           MOVE P-9V99   TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     3: " B-9P    .
           MOVE P-S99    TO B-9P
           IF B-9P     NOT = 10
              DISPLAY "B-9P     4: " B-9P    .
           MOVE P-99     TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     5: " B-9P    .
           MOVE P-P99    TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     6: " B-9P    .
           MOVE P-9PP    TO B-9P
           IF B-9P     NOT = 0
              DISPLAY "B-9P     7: " B-9P    .

           CONTINUE.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [])

AT_CLEANUP


AT_SETUP([MOVE PACKED-DECIMAL to DISPLAY])
AT_KEYWORDS([fundamenta PPPl])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  P-S99V99     PIC S99V99 PACKED-DECIMAL VALUE  1.23.
       01  P-N99V99     PIC S99V99 PACKED-DECIMAL VALUE -1.32.
       01  P-9V99       PIC   9V99 PACKED-DECIMAL VALUE  1.1.
       01  P-S99        PIC S99    PACKED-DECIMAL VALUE  12.
       01  P-99         PIC  99    PACKED-DECIMAL VALUE  2.
       01  P-P99        PIC P99    PACKED-DECIMAL VALUE  0.02.
       01  P-9PP        PIC 9PP    PACKED-DECIMAL VALUE  200.
       01  P-938        PIC 9(38)  PACKED-DECIMAL VALUE
           12345678901234567890123456789012345678.
       01  D-S99V99     PIC S99V99 DISPLAY.
       01  D-99V9       PIC  99V9  DISPLAY.
       01  D-S999       PIC S999   DISPLAY.
       01  D-99         PIC  99    DISPLAY.
       01  D-P9         PIC  P9    DISPLAY.
       01  D-9P         PIC  9P    DISPLAY.
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.

       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 20000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.
       
           MOVE P-938 TO D-99
           IF D-99     NOT = 78
              DISPLAY "D-99: " D-99.

           MOVE P-S99V99 TO D-S99V99
           IF D-S99V99 NOT = 1.23
              DISPLAY "D-S99V99 1: " D-S99V99.
           MOVE P-N99V99 TO D-S99V99
           IF D-S99V99 NOT = -1.32
              DISPLAY "D-S99V99 2: " D-S99V99.
           MOVE P-9V99   TO D-S99V99
           IF D-S99V99 NOT = 1.1
              DISPLAY "D-S99V99 3: " D-S99V99.
           MOVE P-S99    TO D-S99V99
           IF D-S99V99 NOT = 12
              DISPLAY "D-S99V99 4: " D-S99V99.
           MOVE P-99     TO D-S99V99
           IF D-S99V99 NOT = 2
              DISPLAY "D-S99V99 5: " D-S99V99.
           MOVE P-P99    TO D-S99V99
           IF D-S99V99 NOT = 0.02
              DISPLAY "D-S99V99 6: " D-S99V99.
           MOVE P-9PP    TO D-S99V99
           IF D-S99V99 NOT = 0
              DISPLAY "D-S99V99 7: " D-S99V99.

           MOVE P-S99V99 TO D-99V9 
           IF D-99V9  NOT = 1.2
              DISPLAY "D-99V99  1: " D-99V9  .
           MOVE P-N99V99 TO D-99V9 
           IF D-99V9  NOT = 1.3
              DISPLAY "D-99V99  2: " D-99V9  .
           MOVE P-9V99   TO D-99V9 
           IF D-99V9  NOT = 1.1
              DISPLAY "D-99V99  3: " D-99V9  .
           MOVE P-S99    TO D-99V9 
           IF D-99V9  NOT = 12
              DISPLAY "D-99V99  4: " D-99V9  .
           MOVE P-99     TO D-99V9 
           IF D-99V9  NOT = 2
              DISPLAY "D-99V99  5: " D-99V9  .
           MOVE P-P99    TO D-99V9 
           IF D-99V9  NOT = 0
              DISPLAY "D-99V99  6: " D-99V9  .
           MOVE P-9PP    TO D-99V9 
           IF D-99V9  NOT = 0
              DISPLAY "D-99V99  7: " D-99V9  .

           MOVE P-S99V99 TO D-S999
           IF D-S999   NOT = 1
              DISPLAY "D-S999   1: " D-S999  .
           MOVE P-N99V99 TO D-S999
           IF D-S999   NOT = -1
              DISPLAY "D-S999   2: " D-S999  .
           MOVE P-9V99   TO D-S999
           IF D-S999   NOT = 1
              DISPLAY "D-S999   3: " D-S999  .
           MOVE P-S99    TO D-S999
           IF D-S999   NOT = 12
              DISPLAY "D-S999   4: " D-S999  .
           MOVE P-99     TO D-S999
           IF D-S999   NOT = 2
              DISPLAY "D-S999   5: " D-S999  .
           MOVE P-P99    TO D-S999
           IF D-S999   NOT = 0
              DISPLAY "D-S999   6: " D-S999  .
           MOVE P-9PP    TO D-S999
           IF D-S999   NOT = 200
              DISPLAY "D-S999   7: " D-S999  .

           MOVE P-S99V99 TO D-99
           IF D-99     NOT = 1
              DISPLAY "D-99     1: " D-99    .
           MOVE P-N99V99 TO D-99
           IF D-99     NOT = 1
              DISPLAY "D-99     2: " D-99    .
           MOVE P-9V99   TO D-99
           IF D-99     NOT = 1
              DISPLAY "D-99     3: " D-99    .
           MOVE P-S99    TO D-99
           IF D-99     NOT = 12
              DISPLAY "D-99     4: " D-99    .
           MOVE P-99     TO D-99
           IF D-99     NOT = 2
              DISPLAY "D-99     5: " D-99    .
           MOVE P-P99    TO D-99
           IF D-99     NOT = 0
              DISPLAY "D-99     6: " D-99    .
           MOVE P-9PP    TO D-99
           IF D-99     NOT = 0
              DISPLAY "D-99     7: " D-99    .

           MOVE P-S99V99 TO D-P9
           IF D-P9     NOT = 0.03
              DISPLAY "D-P9     1: " D-P9    .
           MOVE P-N99V99 TO D-P9
           IF D-P9     NOT = 0.02
              DISPLAY "D-P9     2: " D-P9    .
           MOVE P-9V99   TO D-P9
           IF D-P9     NOT = 0
              DISPLAY "D-P9     3: " D-P9    .
           MOVE P-S99    TO D-P9
           IF D-P9     NOT = 0
              DISPLAY "D-P9     4: " D-P9    .
           MOVE P-99     TO D-P9
           IF D-P9     NOT = 0
              DISPLAY "D-P9     5: " D-P9    .
           MOVE P-P99    TO D-P9
           IF D-P9     NOT = 0.02
              DISPLAY "D-P9     6: " D-P9    .
           MOVE P-9PP    TO D-P9
           IF D-P9     NOT = 0
              DISPLAY "D-P9     7: " D-P9    .

           MOVE P-S99V99 TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     1: " D-9P    .
           MOVE P-N99V99 TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     2: " D-9P    .
           MOVE P-9V99   TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     3: " D-9P    .
           MOVE P-S99    TO D-9P
           IF D-9P     NOT = 10
              DISPLAY "D-9P     4: " D-9P    .
           MOVE P-99     TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     5: " D-9P    .
           MOVE P-P99    TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     6: " D-9P    .
           MOVE P-9PP    TO D-9P
           IF D-9P     NOT = 0
              DISPLAY "D-9P     7: " D-9P    .

           CONTINUE.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [])

AT_CLEANUP


AT_SETUP([MOVE DISPLAY to PACKED-DECIMAL])
AT_KEYWORDS([fundamental PPP])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  D-S99V99     PIC S99V99 DISPLAY VALUE  1.23.
       01  D-N99V99     PIC S99V99 DISPLAY VALUE -1.32.
       01  D-9V99       PIC   9V99 DISPLAY VALUE  1.1.
       01  D-S99        PIC S99    DISPLAY VALUE  12.
       01  D-99         PIC  99    DISPLAY VALUE  2.
       01  D-P99        PIC P99    DISPLAY VALUE  0.02.
       01  D-9PP        PIC 9PP    DISPLAY VALUE  200.
       01  P-S99V99     PIC S99V99 PACKED-DECIMAL.
       01  P-99V9       PIC  99V9  PACKED-DECIMAL.
       01  P-S999       PIC S999   PACKED-DECIMAL.
       01  P-99         PIC  99    PACKED-DECIMAL.
       01  P-P9         PIC  P9    PACKED-DECIMAL.
       01  P-9P         PIC  9P    PACKED-DECIMAL.
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.

       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 20000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.

           MOVE D-S99V99 TO P-S99V99
           IF P-S99V99 NOT = 1.23
              DISPLAY "P-S99V99 1: " P-S99V99.
           MOVE D-N99V99 TO P-S99V99
           IF P-S99V99 NOT = -1.32
              DISPLAY "P-S99V99 2: " P-S99V99.
           MOVE D-9V99   TO P-S99V99
           IF P-S99V99 NOT = 1.1
              DISPLAY "P-S99V99 3: " P-S99V99.
           MOVE D-S99    TO P-S99V99
           IF P-S99V99 NOT = 12
              DISPLAY "P-S99V99 4: " P-S99V99.
           MOVE D-99     TO P-S99V99
           IF P-S99V99 NOT = 2
              DISPLAY "P-S99V99 5: " P-S99V99.
           MOVE D-P99    TO P-S99V99
           IF P-S99V99 NOT = 0.02
              DISPLAY "P-S99V99 6: " P-S99V99.
           MOVE D-9PP    TO P-S99V99
           IF P-S99V99 NOT = 0
              DISPLAY "P-S99V99 7: " P-S99V99.

           MOVE D-S99V99 TO P-99V9 
           IF P-99V9  NOT = 1.2
              DISPLAY "P-99V9   1: " P-99V9  .
           MOVE D-N99V99 TO P-99V9 
           IF P-99V9  NOT = 1.3
              DISPLAY "P-99V9   2: " P-99V9  .
           MOVE D-9V99   TO P-99V9 
           IF P-99V9  NOT = 1.1
              DISPLAY "P-99V9   3: " P-99V9  .
           MOVE D-S99    TO P-99V9 
           IF P-99V9  NOT = 12
              DISPLAY "P-99V9   4: " P-99V9  .
           MOVE D-99     TO P-99V9 
           IF P-99V9  NOT = 2
              DISPLAY "P-99V9   5: " P-99V9  .
           MOVE D-P99    TO P-99V9 
           IF P-99V9  NOT = 0
              DISPLAY "P-99V9   6: " P-99V9  .
           MOVE D-9PP    TO P-99V9 
           IF P-99V9  NOT = 0
              DISPLAY "P-99V9   7: " P-99V9  .

           MOVE D-S99V99 TO P-S999
           IF P-S999   NOT = 1
              DISPLAY "P-S999   1: " P-S999  .
           MOVE D-N99V99 TO P-S999
           IF P-S999   NOT = -1
              DISPLAY "P-S999   2: " P-S999  .
           MOVE D-9V99   TO P-S999
           IF P-S999   NOT = 1
              DISPLAY "P-S999   3: " P-S999  .
           MOVE D-S99    TO P-S999
           IF P-S999   NOT = 12
              DISPLAY "P-S999   4: " P-S999  .
           MOVE D-99     TO P-S999
           IF P-S999   NOT = 2
              DISPLAY "P-S999   5: " P-S999  .
           MOVE D-P99    TO P-S999
           IF P-S999   NOT = 0
              DISPLAY "P-S999   6: " P-S999  .
           MOVE D-9PP    TO P-S999
           IF P-S999   NOT = 200
              DISPLAY "P-S999   7: " P-S999  .

           MOVE D-S99V99 TO P-99
           IF P-99     NOT = 1
              DISPLAY "P-99     1: " P-99    .
           MOVE D-N99V99 TO P-99
           IF P-99     NOT = 1
              DISPLAY "P-99     2: " P-99    .
           MOVE D-9V99   TO P-99
           IF P-99     NOT = 1
              DISPLAY "P-99     3: " P-99    .
           MOVE D-S99    TO P-99
           IF P-99     NOT = 12
              DISPLAY "P-99     4: " P-99    .
           MOVE D-99     TO P-99
           IF P-99     NOT = 2
              DISPLAY "P-99     5: " P-99    .
           MOVE D-P99    TO P-99
           IF P-99     NOT = 0
              DISPLAY "P-99     6: " P-99    .
           MOVE D-9PP    TO P-99
           IF P-99     NOT = 0
              DISPLAY "P-99     7: " P-99    .

           MOVE D-S99V99 TO P-P9
           IF P-P9     NOT = 0.03
              DISPLAY "P-P9     1: " P-P9    .
           MOVE D-N99V99 TO P-P9
           IF P-P9     NOT = 0.02
              DISPLAY "P-P9     2: " P-P9    .
           MOVE D-9V99   TO P-P9
           IF P-P9     NOT = 0
              DISPLAY "P-P9     3: " P-P9    .
           MOVE D-S99    TO P-P9
           IF P-P9     NOT = 0
              DISPLAY "P-P9     4: " P-P9    .
           MOVE D-99     TO P-P9
           IF P-P9     NOT = 0
              DISPLAY "P-P9     5: " P-P9    .
           MOVE D-P99    TO P-P9
           IF P-P9     NOT = 0.02
              DISPLAY "P-P9     6: " P-P9    .
           MOVE D-9PP    TO P-P9
           IF P-P9     NOT = 0
              DISPLAY "P-P9     7: " P-P9    .

           MOVE D-S99V99 TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     1: " P-9P    .
           MOVE D-N99V99 TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     2: " P-9P    .
           MOVE D-9V99   TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     3: " P-9P    .
           MOVE D-S99    TO P-9P
           IF P-9P     NOT = 10
              DISPLAY "P-9P     4: " P-9P    .
           MOVE D-99     TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     5: " P-9P    .
           MOVE D-P99    TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     6: " P-9P    .
           MOVE D-9PP    TO P-9P
           IF P-9P     NOT = 0
              DISPLAY "P-9P     7: " P-9P    .

           CONTINUE.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL used with INITIALIZE])
AT_KEYWORDS([PACKED-DECIMAL DISPLAY])

# also verifying the zero displays with size and sign

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-99          PIC 99   USAGE PACKED-DECIMAL.
       01 X-S99         PIC S99  USAGE PACKED-DECIMAL.
       01 X-999         PIC 999  USAGE PACKED-DECIMAL.
       01 X-S999        PIC S999 USAGE PACKED-DECIMAL.
       PROCEDURE        DIVISION.
           INITIALIZE X-99
           DISPLAY X-99.
           INITIALIZE X-S99
           DISPLAY X-S99.
           INITIALIZE X-999
           DISPLAY X-999.
           INITIALIZE X-S999
           DISPLAY X-S999.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00
+00
000
+000
])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL arithmetic])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC  99    USAGE PACKED-DECIMAL VALUE 0.
       01 Y             PIC  99    USAGE PACKED-DECIMAL VALUE 9.
       01 Z             PIC s9(20) USAGE PACKED-DECIMAL VALUE -55.
       01 X-9           PIC 9      USAGE PACKED-DECIMAL.
       01 X-99          PIC 99     USAGE PACKED-DECIMAL.
       01 X-920         PIC 9(20)  USAGE PACKED-DECIMAL.
       01 X-921         PIC 9(21)  USAGE PACKED-DECIMAL.
       01 B-99          USAGE BINARY-LONG UNSIGNED VALUE 99.
       01 B-999         USAGE BINARY-LONG UNSIGNED VALUE 123.
       PROCEDURE        DIVISION.
           COMPUTE X = 1
           IF X <>  1 DISPLAY "01 <" X ">".
           COMPUTE X = Y
           IF X <>  9 DISPLAY "09 <" X ">".
           COMPUTE X = X + Y
           IF Z < -56 DISPLAY "-55 >= " Z.
      *>
           MOVE B-999 TO X-99
           IF X-99  <> 23 DISPLAY 'trunk 123 -> 99: 'X-99.
           MOVE B-999 TO X-9
           IF X-9   <> 3  DISPLAY 'trunk 123 -> 9: ' X-9.
           MOVE B-99  TO X-99
           MOVE B-999 TO X-920
           MOVE X-99  TO X-921
           ADD  X-99  X-920 GIVING B-99.
           IF B-99  <> 222 DISPLAY '!222: ' B-99.
           IF X-920  > 124 DISPLAY '> 124 ' X-920.
           IF X-921  < 98  DISPLAY '< 98 '  X-921.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL comparison])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  U1           PIC   99   USAGE PACKED-DECIMAL VALUE 95.
       01  U2           PIC   99   USAGE PACKED-DECIMAL VALUE 95.
       01  U3           PIC  999   USAGE PACKED-DECIMAL VALUE 195.
       01  U4           PIC  999   USAGE PACKED-DECIMAL VALUE 195.
       01  U1-32        PIC  9(32) USAGE PACKED-DECIMAL VALUE 195.
       01  U2-32        PIC  9(32) USAGE PACKED-DECIMAL VALUE 195.
       01  U1-32D       PIC  9(18)V9(12) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388132.
       01  U2-32D       PIC  9(18)V9(12) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388132.
       01  U3-32D       PIC  9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388132.
       01  U4-32D       PIC  9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388131.
       01  S1           PIC  S99   USAGE PACKED-DECIMAL VALUE -95.
       01  S2           PIC  S99   USAGE PACKED-DECIMAL VALUE -95.
       01  S3           PIC S999   USAGE PACKED-DECIMAL VALUE -195.
       01  S4           PIC S999   USAGE PACKED-DECIMAL VALUE -195.
       01  S1-32        PIC S9(32) USAGE PACKED-DECIMAL VALUE -195.
       01  S2-32        PIC S9(32) USAGE PACKED-DECIMAL VALUE -195.
       01  S1-32D       PIC S9(18)V9(12) USAGE PACKED-DECIMAL
           VALUE -48894655646195.551388132.
       01  S2-32D       PIC S9(18)V9(12) USAGE PACKED-DECIMAL
           VALUE -48894655646195.551388132.
       01  S3-32D       PIC S9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE -48894655646195.551388132.
       01  S4-32D       PIC S9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE -48894655646195.551388131.
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.
       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 30000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.
           IF U1 <>  U2 DISPLAY "U1 <> U2".
           IF U3 <>  U4 DISPLAY "U3 <> U4".
           IF U1 >=  U3 DISPLAY "U1 >= U3".
           IF S1 <>  S2 DISPLAY "S1 <> S2".
           IF S3 <>  S4 DISPLAY "S3 <> S4".
           IF S1 <=  S3 DISPLAY "S1 <= S3".
           IF U1-32  <>  U2-32  DISPLAY "U1-32 <> U2-32".
           IF U1-32  >=  U2-32D DISPLAY "U1-32 >= U1-32D".
           IF U1-32D <>  U2-32D DISPLAY "U1-32D <> U2-32D".
           IF U1-32D <=  U3     DISPLAY "U1-32 <= U3".
           IF U2-32D <=  U4-32D DISPLAY "U2-32D <= U4-32D".
           IF U4-32D >=  U2-32D DISPLAY "U4-32D >= U2-32D".
           IF S1-32  <>  S2-32  DISPLAY "S1-32 <> S2-32".
           IF S1-32D <>  S2-32D DISPLAY "S1-32D <> S2-32D".
           IF S2-32D >=  S4-32D DISPLAY "S2-32D >= S4-32D".
           IF S3-32D >=  S4-32D DISPLAY "S3-32D >= S4-32D".
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

# also check "not optimized during codegen",
# which leads to other code-paths
AT_CHECK([$COMPILE -fno-fast-compare -C -o progalt.c prog.cob], [0], [], [])
AT_CHECK([$COMPILE progalt.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./progalt], [0], [], [])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL numeric test (1)])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
         02 X-2         PIC X(2).
         02 N-2         REDEFINES X-2 PIC 999  USAGE PACKED-DECIMAL.
         02 N-S2        REDEFINES X-2 PIC S999 USAGE PACKED-DECIMAL.
       PROCEDURE        DIVISION.
           MOVE X"0000" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 0000 NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S0000 NG".

           MOVE X"000c" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 000c NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S000c NG".

           MOVE X"000d" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 000d NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S000d NG".

           MOVE X"000f" TO X-2.
           IF N-2  IS NOT NUMERIC
              DISPLAY " 000f NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S000f NG".

           MOVE X"1234" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 1234 NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S1234 NG".

           MOVE X"999f" TO X-2.
           IF N-2  IS NOT NUMERIC
              DISPLAY " 999f NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S999f NG".

           MOVE X"ffff" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " ffff NG".
           IF N-S2 IS NUMERIC
              DISPLAY "Sffff NG".

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PACKED-DECIMAL numeric test (2)])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
         02 X-2         PIC X(2).
         02 N-2         REDEFINES X-2 PIC 999  USAGE PACKED-DECIMAL.
         02 N-S2        REDEFINES X-2 PIC S999 USAGE PACKED-DECIMAL.
       PROCEDURE        DIVISION.
           MOVE X"0000" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 0000 NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S0000 NG".

           MOVE X"000c" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 000c NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S000c NG".

           MOVE X"000d" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 000d NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S000d NG".

           MOVE X"000f" TO X-2.
           IF N-2  IS NOT NUMERIC
              DISPLAY " 000f NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S000f NG".

           MOVE X"1234" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " 1234 NG".
           IF N-S2 IS NUMERIC
              DISPLAY "S1234 NG".

           MOVE X"999f" TO X-2.
           IF N-2  IS NOT NUMERIC
              DISPLAY " 999f NG".
           IF N-S2 IS NOT NUMERIC
              DISPLAY "S999f NG".

           MOVE X"ffff" TO X-2.
           IF N-2  IS NUMERIC
              DISPLAY " ffff NG".
           IF N-S2 IS NUMERIC
              DISPLAY "Sffff NG".

           STOP RUN.
])

# TODO: Check what actual option is tested here
#       and directly use it
AT_CHECK([$COMPILE -std=ibm prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([COMP-6 used with DISPLAY])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-99          PIC 99   USAGE COMP-6.
       01 X-999         PIC 999  USAGE COMP-6.
       PROCEDURE        DIVISION.
           MOVE    0 TO X-99
           DISPLAY X-99.
           MOVE   99 TO X-99
           DISPLAY X-99.
           MOVE    0 TO X-999
           DISPLAY X-999.
           MOVE  123 TO X-999
           DISPLAY X-999.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00
99
000
123
], [])

AT_CLEANUP


AT_SETUP([COMP-6 used with MOVE])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-99          PIC 99   USAGE COMP-6.
       01 X-999         PIC 999  USAGE COMP-6.
       01 B-99          USAGE BINARY-LONG.
       01 B-999         USAGE BINARY-LONG.
       PROCEDURE        DIVISION.
           MOVE     0 TO B-99
           MOVE  B-99 TO X-99
           IF  X-99 NOT =   0 DISPLAY  "00 <" X-99  ">".
           MOVE    99 TO B-99
           MOVE  B-99 TO X-99
           IF  X-99 NOT =  99 DISPLAY  "99 <" X-99  ">".
           MOVE    0  TO B-999
           MOVE B-999 TO X-999
           IF X-999 NOT =   0 DISPLAY "000 <" X-999 ">".
           MOVE  123  TO B-999
           MOVE B-999 TO X-999
           IF X-999 NOT = 123 DISPLAY "123 <" X-999 ">".
           MOVE B-999 TO X-99
           IF  X-99 NOT =  23 DISPLAY  "23 <" X-99  ">".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

# also check "not optimized during codegen",
# which leads to other code-paths
AT_CHECK([$COMPILE -fno-fast-compare -C -o progalt.c prog.cob], [0], [], [])
AT_CHECK([$COMPILE progalt.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./progalt], [0], [], [])

AT_CLEANUP


AT_SETUP([COMP-6 arithmetic])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-9           PIC 9     USAGE COMP-6.
       01 X-99          PIC 99    USAGE COMP-6.
       01 X-920         PIC 9(20) USAGE COMP-6.
       01 X-921         PIC 9(21) USAGE COMP-6.
       01 B-99          USAGE BINARY-LONG UNSIGNED VALUE 99.
       01 B-999         USAGE BINARY-LONG UNSIGNED VALUE 123.
       PROCEDURE        DIVISION.
           MOVE B-999 TO X-99
           IF X-99  <> 23 DISPLAY 'trunk 123 -> 99: 'X-99.
           MOVE B-999 TO X-9
           IF X-9   <> 3  DISPLAY 'trunk 123 -> 9: ' X-9.
           MOVE B-99  TO X-99
           MOVE B-999 TO X-920
           MOVE X-99  TO X-921
           ADD  X-99  X-920 GIVING B-99.
           IF B-99  <> 222 DISPLAY '!222: ' B-99.
           IF X-920  > 124 DISPLAY '> 124 ' X-920.
           IF X-921  < 98  DISPLAY '< 98 '  X-921.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([COMP-6 numeric])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
          02 X-2         PIC X(2).
          02 N-3         REDEFINES X-2 PIC 999  USAGE COMP-6.
          02 N-4         REDEFINES X-2 PIC 9999 USAGE COMP-6.
       PROCEDURE        DIVISION.
           MOVE X"0000" TO X-2.
           IF N-3  IS NOT NUMERIC
              DISPLAY "3 0000 NG".
           IF N-4  IS NOT NUMERIC
              DISPLAY "4 0000 NG".

           MOVE X"000c" TO X-2.
           IF N-3  IS NUMERIC
              DISPLAY "3 000c NG".
           IF N-4  IS NUMERIC
              DISPLAY "4 000c NG".

           MOVE X"1234" TO X-2.
           IF N-3  IS NOT NUMERIC
              DISPLAY "3 1234 NG".
           IF N-4  IS NOT NUMERIC
              DISPLAY "4 1234 NG".

           MOVE X"ffff" TO X-2.
           IF N-3  IS NUMERIC
              DISPLAY "3 ffff NG".
           IF N-4  IS NUMERIC
              DISPLAY "4 ffff NG".

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([COMP-6 comparison])
AT_KEYWORDS([PACKED-DECIMAL COMP-3])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  U1           PIC   99   USAGE COMP-6 VALUE 95.
       01  U2           PIC   99   USAGE COMP-6 VALUE 95.
       01  U3           PIC  999   USAGE COMP-6 VALUE 195.
       01  U4           PIC  999   USAGE COMP-6 VALUE 195.
       01  U1-32        PIC  9(32) USAGE COMP-6 VALUE 195.
       01  U2-32        PIC  9(32) USAGE COMP-6 VALUE 195.
       01  U1-32D       PIC  9(18)V9(12) USAGE COMP-6
           VALUE 48894655646195.551388132.
       01  U2-32D       PIC  9(18)V9(12) USAGE COMP-6 
           VALUE 48894655646195.551388132.
       01  U3-32D       PIC  9(14)V9(13) USAGE COMP-6 
           VALUE 48894655646195.551388132.
       01  U4-32D       PIC  9(14)V9(13) USAGE COMP-6 
           VALUE 48894655646195.551388131.
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.
       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 30000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.
           IF U1     <>  U2     DISPLAY "U1 <> U2".
           IF U3     <>  U4     DISPLAY "U3 <> U4".
           IF U1     >=  U3     DISPLAY "U1 >= U3".
           IF U1-32  <>  U2-32  DISPLAY "U1-32 <> U2-32".
           IF U1-32  >=  U2-32D DISPLAY "U1-32 >= U1-32D".
           IF U1-32D <>  U2-32D DISPLAY "U1-32D <> U2-32D".
           IF U1-32D <=  U3     DISPLAY "U1-32 <= U3".
           IF U2-32D <>  U3-32D DISPLAY "U2-32D <> U3-32D".
           IF U2-32D <=  U4-32D DISPLAY "U2-32D <= U4-32D".
           IF U4-32D >=  U2-32D DISPLAY "U4-32D >= U2-32D".
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

# also check "not optimized during codegen",
# which leads to other code-paths
AT_CHECK([$COMPILE -fno-fast-compare -C -o progalt.c prog.cob], [0], [], [])
AT_CHECK([$COMPILE progalt.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./progalt], [0], [], [])

AT_CLEANUP


AT_SETUP([COMP-3 vs. COMP-6 - BCD comparison])
AT_KEYWORDS([PACKED-DECIMAL])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  PD-03       PIC  S9(03)V99 COMP-3   VALUE 737.
       77  PD-04       PIC  S9(04)V99 COMP-3   VALUE 737.
       77  PD-05       PIC  S9(05)V99 COMP-3   VALUE 737.
       77  PD-06       PIC  S9(06)V99 COMP-3   VALUE 737.
       77  PD-07       PIC  S9(07)V99 COMP-3   VALUE 737.
       77  PD-08       PIC  S9(08)V99 COMP-3   VALUE 737.
       77  PD-09       PIC  S9(09)V99 COMP-3   VALUE 737.
       77  PD-10       PIC  S9(10)V99 COMP-3   VALUE 737.
       77  PD-11       PIC  S9(11)V99 COMP-3   VALUE 737.
       77  PD-12       PIC  S9(12)V99 COMP-3   VALUE 737.
       77  PD-13       PIC  S9(13)V99 COMP-3   VALUE 737.
       77  PD-14       PIC  S9(14)V99 COMP-3   VALUE 737.
       77  PD-15       PIC  S9(15)V99 COMP-3   VALUE 737.
       77  PD-16       PIC  S9(16)V99 COMP-3   VALUE 737.
       77  PD-17       PIC  S9(17)V99 COMP-3   VALUE 737.
       77  PD-18       PIC  S9(18)V99 COMP-3   VALUE 737.
       77  PD-19       PIC  S9(19)V99 COMP-3   VALUE 737.
       77  PD-20       PIC  S9(20)V99 COMP-3   VALUE 737.
       77  PD-21       PIC  S9(21)V99 COMP-3   VALUE 737.
       77  PD-22       PIC  S9(22)V99 COMP-3   VALUE 737.
       77  PD-23       PIC  S9(23)V99 COMP-3   VALUE 737.
       77  PD-24       PIC  S9(24)V99 COMP-3   VALUE 737.
       77  PD-25       PIC  S9(25)V99 COMP-3   VALUE 737.
       77  PD-26       PIC  S9(26)V99 COMP-3   VALUE 737.
       77  PD-27       PIC  S9(27)V99 COMP-3   VALUE 737.
       77  PD-28       PIC  S9(28)V99 COMP-3   VALUE 737.
       77  PD-29       PIC  S9(29)V99 COMP-3   VALUE 737.
       77  PD-30       PIC  S9(30)V99 COMP-3   VALUE 737.
       77  PD-31       PIC  S9(31)V99 COMP-3   VALUE 737.
       77  PD-32       PIC  S9(32)V99 COMP-3   VALUE 737.
       77  PD-33       PIC  S9(33)V99 COMP-3   VALUE 737.
       77  PD-34       PIC  S9(34)V99 COMP-3   VALUE 737.
       77  PD-35       PIC  S9(35)V99 COMP-3   VALUE 737.
       77  PD-36       PIC  S9(36)V99 COMP-3   VALUE 737.

       77  CD-03       PIC   9(03)V99 COMP-6   VALUE 737.
       77  CD-04       PIC   9(04)V99 COMP-6   VALUE 737.
       77  CD-05       PIC   9(05)V99 COMP-6   VALUE 737.
       77  CD-06       PIC   9(06)V99 COMP-6   VALUE 737.
       77  CD-07       PIC   9(07)V99 COMP-6   VALUE 737.
       77  CD-08       PIC   9(08)V99 COMP-6   VALUE 737.
       77  CD-09       PIC   9(09)V99 COMP-6   VALUE 737.
       77  CD-10       PIC   9(10)V99 COMP-6   VALUE 737.
       77  CD-11       PIC   9(11)V99 COMP-6   VALUE 737.
       77  CD-12       PIC   9(12)V99 COMP-6   VALUE 737.
       77  CD-13       PIC   9(13)V99 COMP-6   VALUE 737.
       77  CD-14       PIC   9(14)V99 COMP-6   VALUE 737.
       77  CD-15       PIC   9(15)V99 COMP-6   VALUE 737.
       77  CD-16       PIC   9(16)V99 COMP-6   VALUE 737.
       77  CD-17       PIC   9(17)V99 COMP-6   VALUE 737.
       77  CD-18       PIC   9(18)V99 COMP-6   VALUE 737.
       77  CD-19       PIC   9(19)V99 COMP-6   VALUE 737.
       77  CD-20       PIC   9(20)V99 COMP-6   VALUE 737.
       77  CD-21       PIC   9(21)V99 COMP-6   VALUE 737.
       77  CD-22       PIC   9(22)V99 COMP-6   VALUE 737.
       77  CD-23       PIC   9(23)V99 COMP-6   VALUE 737.
       77  CD-24       PIC   9(24)V99 COMP-6   VALUE 737.
       77  CD-25       PIC   9(25)V99 COMP-6   VALUE 737.
       77  CD-26       PIC   9(26)V99 COMP-6   VALUE 737.
       77  CD-27       PIC   9(27)V99 COMP-6   VALUE 737.
       77  CD-28       PIC   9(28)V99 COMP-6   VALUE 737.
       77  CD-29       PIC   9(29)V99 COMP-6   VALUE 737.
       77  CD-30       PIC   9(30)V99 COMP-6   VALUE 737.
       77  CD-31       PIC   9(31)V99 COMP-6   VALUE 737.
       77  CD-32       PIC   9(32)V99 COMP-6   VALUE 737.
       77  CD-33       PIC   9(33)V99 COMP-6   VALUE 737.
       77  CD-34       PIC   9(34)V99 COMP-6   VALUE 737.
       77  CD-35       PIC   9(35)V99 COMP-6   VALUE 737.
       77  CD-36       PIC   9(36)V99 COMP-6   VALUE 737.
      *
       01  U4-32D       PIC  9(14)V9(13) USAGE COMP-6 
           VALUE 48894655646195.551388131.
       01  UP-32D       PIC  9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388131.
       01  SP-32D       PIC S9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE 48894655646195.551388131.
       01  NP-32D       PIC S9(14)V9(13) USAGE PACKED-DECIMAL
           VALUE -48894655646195.551388131.

       01  PACKED-ZEROS.
           05  PZ-01-X.
               10  PZ-01               PIC 9(38)       COMP-6.
           05  PZ-02-X.
               10  PZ-02               PIC S9(38)      COMP-3.
           05  PZ-03-X.
               10  PZ-03               PIC S9(38)      COMP-3.
           05  PZ-04-X.
               10  PZ-04               PIC S9(38)      COMP-3.
           05  PZ-05-X.
               10  PZ-05               PIC S9(38)      COMP-3.
           05  PZ-06-X.
               10  PZ-06               PIC S9(38)      COMP-3.

       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.

       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.
       PROCEDURE        DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 10000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.
           IF PD-03 <> CD-03  DISPLAY "PD-03 <> CD-03".
           IF PD-04 <> CD-04  DISPLAY "PD-04 <> CD-04".
           IF PD-05 <> CD-05  DISPLAY "PD-05 <> CD-05".
           IF PD-06 <> CD-06  DISPLAY "PD-06 <> CD-06".
           IF PD-07 <> CD-07  DISPLAY "PD-07 <> CD-07".
           IF PD-08 <> CD-08  DISPLAY "PD-08 <> CD-08".
           IF PD-09 <> CD-09  DISPLAY "PD-09 <> CD-09".
           IF PD-10 <> CD-10  DISPLAY "PD-10 <> CD-10".
           IF PD-11 <> CD-11  DISPLAY "PD-11 <> CD-11".
           IF PD-12 <> CD-12  DISPLAY "PD-12 <> CD-12".
           IF PD-13 <> CD-13  DISPLAY "PD-13 <> CD-13".
           IF PD-14 <> CD-14  DISPLAY "PD-14 <> CD-14".
           IF PD-15 <> CD-15  DISPLAY "PD-15 <> CD-15".
           IF PD-16 <> CD-16  DISPLAY "PD-16 <> CD-16".
           IF PD-17 <> CD-17  DISPLAY "PD-17 <> CD-17".
           IF PD-18 <> CD-18  DISPLAY "PD-18 <> CD-18".
           IF PD-19 <> CD-19  DISPLAY "PD-19 <> CD-19".
           IF PD-20 <> CD-20  DISPLAY "PD-20 <> CD-20".
           IF PD-21 <> CD-21  DISPLAY "PD-21 <> CD-21".
           IF PD-22 <> CD-22  DISPLAY "PD-22 <> CD-22".
           IF PD-23 <> CD-23  DISPLAY "PD-23 <> CD-23".
           IF PD-24 <> CD-24  DISPLAY "PD-24 <> CD-24".
           IF PD-25 <> CD-25  DISPLAY "PD-25 <> CD-25".
           IF PD-26 <> CD-26  DISPLAY "PD-26 <> CD-26".
           IF PD-27 <> CD-27  DISPLAY "PD-27 <> CD-27".
           IF PD-28 <> CD-28  DISPLAY "PD-28 <> CD-28".
           IF PD-29 <> CD-29  DISPLAY "PD-29 <> CD-29".
           IF PD-30 <> CD-30  DISPLAY "PD-30 <> CD-30".
           IF PD-31 <> CD-31  DISPLAY "PD-31 <> CD-31".
           IF PD-32 <> CD-32  DISPLAY "PD-32 <> CD-32".
           IF PD-33 <> CD-33  DISPLAY "PD-33 <> CD-33".
           IF PD-34 <> CD-34  DISPLAY "PD-34 <> CD-34".
           IF PD-35 <> CD-35  DISPLAY "PD-35 <> CD-35".
           IF PD-36 <> CD-36  DISPLAY "PD-36 <> CD-36".

           IF PD-03 <> CD-36  DISPLAY "PD-03 <> CD-36".
           IF PD-04 <> CD-35  DISPLAY "PD-04 <> CD-35".
           IF PD-05 <> CD-34  DISPLAY "PD-05 <> CD-34".
           IF PD-06 <> CD-33  DISPLAY "PD-06 <> CD-33".
           IF PD-07 <> CD-32  DISPLAY "PD-07 <> CD-32".
           IF PD-08 <> CD-31  DISPLAY "PD-08 <> CD-31".
           IF PD-09 <> CD-30  DISPLAY "PD-09 <> CD-30".
           IF PD-10 <> CD-29  DISPLAY "PD-10 <> CD-29".
           IF PD-11 <> CD-28  DISPLAY "PD-11 <> CD-28".
           IF PD-12 <> CD-27  DISPLAY "PD-12 <> CD-27".
           IF PD-13 <> CD-26  DISPLAY "PD-13 <> CD-26".
           IF PD-14 <> CD-25  DISPLAY "PD-14 <> CD-25".
           IF PD-15 <> CD-24  DISPLAY "PD-15 <> CD-24".
           IF PD-16 <> CD-23  DISPLAY "PD-16 <> CD-23".
           IF PD-17 <> CD-22  DISPLAY "PD-17 <> CD-22".
           IF PD-18 <> CD-21  DISPLAY "PD-18 <> CD-21".
           IF PD-19 <> CD-20  DISPLAY "PD-19 <> CD-20".
           IF PD-20 <> CD-19  DISPLAY "PD-20 <> CD-19".
           IF PD-21 <> CD-18  DISPLAY "PD-21 <> CD-18".
           IF PD-22 <> CD-17  DISPLAY "PD-22 <> CD-17".
           IF PD-23 <> CD-16  DISPLAY "PD-23 <> CD-16".
           IF PD-24 <> CD-15  DISPLAY "PD-24 <> CD-15".
           IF PD-25 <> CD-14  DISPLAY "PD-25 <> CD-14".
           IF PD-26 <> CD-13  DISPLAY "PD-26 <> CD-13".
           IF PD-27 <> CD-12  DISPLAY "PD-27 <> CD-12".
           IF PD-28 <> CD-11  DISPLAY "PD-28 <> CD-11".
           IF PD-29 <> CD-10  DISPLAY "PD-29 <> CD-10".
           IF PD-30 <> CD-09  DISPLAY "PD-30 <> CD-09".
           IF PD-31 <> CD-08  DISPLAY "PD-31 <> CD-08".
           IF PD-32 <> CD-07  DISPLAY "PD-32 <> CD-07".
           IF PD-33 <> CD-06  DISPLAY "PD-33 <> CD-06".
           IF PD-34 <> CD-05  DISPLAY "PD-34 <> CD-05".
           IF PD-35 <> CD-04  DISPLAY "PD-35 <> CD-04".
           IF PD-36 <> CD-03  DISPLAY "PD-36 <> CD-03".

           IF PD-03 <> PD-36  DISPLAY "PD-03 <> PD-36".
           IF PD-04 <> PD-35  DISPLAY "PD-04 <> PD-35".
           IF PD-05 <> PD-34  DISPLAY "PD-05 <> PD-34".
           IF PD-06 <> PD-33  DISPLAY "PD-06 <> PD-33".
           IF PD-07 <> PD-32  DISPLAY "PD-07 <> PD-32".
           IF PD-08 <> PD-31  DISPLAY "PD-08 <> PD-31".
           IF PD-09 <> PD-30  DISPLAY "PD-09 <> PD-30".
           IF PD-10 <> PD-29  DISPLAY "PD-10 <> PD-29".
           IF PD-11 <> PD-28  DISPLAY "PD-11 <> PD-28".
           IF PD-12 <> PD-27  DISPLAY "PD-12 <> PD-27".
           IF PD-13 <> PD-26  DISPLAY "PD-13 <> PD-26".
           IF PD-14 <> PD-25  DISPLAY "PD-14 <> PD-25".
           IF PD-15 <> PD-24  DISPLAY "PD-15 <> PD-24".
           IF PD-16 <> PD-23  DISPLAY "PD-16 <> PD-23".
           IF PD-17 <> PD-22  DISPLAY "PD-17 <> PD-22".
           IF PD-18 <> PD-21  DISPLAY "PD-18 <> PD-21".
           IF PD-19 <> PD-20  DISPLAY "PD-19 <> PD-20".
           IF PD-20 <> PD-19  DISPLAY "PD-20 <> PD-19".
           IF PD-21 <> PD-18  DISPLAY "PD-21 <> PD-18".
           IF PD-22 <> PD-17  DISPLAY "PD-22 <> PD-17".
           IF PD-23 <> PD-16  DISPLAY "PD-23 <> PD-16".
           IF PD-24 <> PD-15  DISPLAY "PD-24 <> PD-15".
           IF PD-25 <> PD-14  DISPLAY "PD-25 <> PD-14".
           IF PD-26 <> PD-13  DISPLAY "PD-26 <> PD-13".
           IF PD-27 <> PD-12  DISPLAY "PD-27 <> PD-12".
           IF PD-28 <> PD-11  DISPLAY "PD-28 <> PD-11".
           IF PD-29 <> PD-10  DISPLAY "PD-29 <> PD-10".
           IF PD-30 <> PD-09  DISPLAY "PD-30 <> PD-09".
           IF PD-31 <> PD-08  DISPLAY "PD-31 <> PD-08".
           IF PD-32 <> PD-07  DISPLAY "PD-32 <> PD-07".
           IF PD-33 <> PD-06  DISPLAY "PD-33 <> PD-06".
           IF PD-34 <> PD-05  DISPLAY "PD-34 <> PD-05".
           IF PD-35 <> PD-04  DISPLAY "PD-35 <> PD-04".
           IF PD-36 <> PD-03  DISPLAY "PD-36 <> PD-03".

           IF CD-03 <> CD-36  DISPLAY "CD-03 <> CD-36".
           IF CD-04 <> CD-35  DISPLAY "CD-04 <> CD-35".
           IF CD-05 <> CD-34  DISPLAY "CD-05 <> CD-34".
           IF CD-06 <> CD-33  DISPLAY "CD-06 <> CD-33".
           IF CD-07 <> CD-32  DISPLAY "CD-07 <> CD-32".
           IF CD-08 <> CD-31  DISPLAY "CD-08 <> CD-31".
           IF CD-09 <> CD-30  DISPLAY "CD-09 <> CD-30".
           IF CD-10 <> CD-29  DISPLAY "CD-10 <> CD-29".
           IF CD-11 <> CD-28  DISPLAY "CD-11 <> CD-28".
           IF CD-12 <> CD-27  DISPLAY "CD-12 <> CD-27".
           IF CD-13 <> CD-26  DISPLAY "CD-13 <> CD-26".
           IF CD-14 <> CD-25  DISPLAY "CD-14 <> CD-25".
           IF CD-15 <> CD-24  DISPLAY "CD-15 <> CD-24".
           IF CD-16 <> CD-23  DISPLAY "CD-16 <> CD-23".
           IF CD-17 <> CD-22  DISPLAY "CD-17 <> CD-22".
           IF CD-18 <> CD-21  DISPLAY "CD-18 <> CD-21".
           IF CD-19 <> CD-20  DISPLAY "CD-19 <> CD-20".
           IF CD-20 <> CD-19  DISPLAY "CD-20 <> CD-19".
           IF CD-21 <> CD-18  DISPLAY "CD-21 <> CD-18".
           IF CD-22 <> CD-17  DISPLAY "CD-22 <> CD-17".
           IF CD-23 <> CD-16  DISPLAY "CD-23 <> CD-16".
           IF CD-24 <> CD-15  DISPLAY "CD-24 <> CD-15".
           IF CD-25 <> CD-14  DISPLAY "CD-25 <> CD-14".
           IF CD-26 <> CD-13  DISPLAY "CD-26 <> CD-13".
           IF CD-27 <> CD-12  DISPLAY "CD-27 <> CD-12".
           IF CD-28 <> CD-11  DISPLAY "CD-28 <> CD-11".
           IF CD-29 <> CD-10  DISPLAY "CD-29 <> CD-10".
           IF CD-30 <> CD-09  DISPLAY "CD-30 <> CD-09".
           IF CD-31 <> CD-08  DISPLAY "CD-31 <> CD-08".
           IF CD-32 <> CD-07  DISPLAY "CD-32 <> CD-07".
           IF CD-33 <> CD-06  DISPLAY "CD-33 <> CD-06".
           IF CD-34 <> CD-05  DISPLAY "CD-34 <> CD-05".
           IF CD-35 <> CD-04  DISPLAY "CD-35 <> CD-04".
           IF CD-36 <> CD-03  DISPLAY "CD-36 <> CD-03".

      *    SETTING UP DATA FOR COMPARE WITH NEGATIVE PACKED ZERO

           MOVE LOW-VALUES             TO PZ-01-X.
           MOVE LOW-VALUES             TO PZ-02-X
           MOVE X'0C'                  TO PZ-02-X(20:1).
           MOVE LOW-VALUES             TO PZ-03-X
           MOVE X'0D'                  TO PZ-03-X(20:1).
           MOVE LOW-VALUES             TO PZ-04-X
           MOVE X'10'                  TO PZ-04-X(1:1).
           MOVE X'0D'                  TO PZ-04-X(20:1).
           MOVE LOW-VALUES             TO PZ-05-X
           MOVE X'010D'                TO PZ-05-X(19:2).
           MOVE LOW-VALUES             TO PZ-06-X
           MOVE X'1D'                  TO PZ-06-X(20:1).

           IF PZ-01 <> PZ-02  DISPLAY "PZ-01 <> PZ-02".
           IF PZ-01 <> PZ-03  DISPLAY "PZ-01 <> PZ-03".
           IF PZ-02 <> PZ-03  DISPLAY "PZ-02 <> PZ-03".
           IF PZ-02 <= PZ-04  DISPLAY "PZ-02 <= PZ-04".
           IF PZ-02 <= PZ-05  DISPLAY "PZ-02 <= PZ-05".
           IF PZ-02 <= PZ-06  DISPLAY "PZ-02 <= PZ-05".
      *
           IF U4-32D <>  UP-32D DISPLAY "U4-32D <> UP-32D".
           IF U4-32D <>  SP-32D DISPLAY "U4-32D <> SP-32D".
           IF U4-32D <=  NP-32D DISPLAY "U4-32D <= NP-32D".
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

# also check "not optimized during codegen",
# which leads to other code-paths
AT_CHECK([$COMPILE -fno-fast-compare -C -o progalt.c prog.cob], [0], [], [])
AT_CHECK([$COMPILE progalt.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./progalt], [0], [], [])

AT_CLEANUP


AT_SETUP([PPP COMP-3])
AT_KEYWORDS([PACKED-DECIMAL fundamental MOVE DISPLAY ADD SUBTRACT MULTIPLY DIVIDE])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 XS.
         05 X-1  PIC 999PPP COMP-3  VALUE 91000.
         05 X-2  PIC 999PPP COMP-3  VALUE 92000.
         05 X-3  PIC X VALUE "$".
         05 X-4  PIC VPPP999 COMP-3 VALUE 0.000128.
       01 D-1    PIC 999PPP  COMP-3 VALUE 95000.
       01 D-2    PIC 9999PP  COMP-3 VALUE 193000.
       01  WRK-DS-LS-1P17-1 PIC S9P(17) SIGN LEADING SEPARATE
           CHARACTER VALUE  -100000000000000000.
       01  WRK-AE-3  PIC XBXXX/XXX/XXX/XXX/XXXBXX.
       01  MOVE72    PICTURE 9(10) VALUE 3344556677.
       01  MOVE73    PICTURE X(5)BA(10)0X.
       01  GRP-AE-0002.
           05  AE-0002             PICTURE XX0XXBXXX.
       PROCEDURE        DIVISION.
           MOVE    3344556677 TO MOVE72.
           MOVE    MOVE72 TO MOVE73.
           IF MOVE73 NOT EQUAL TO "33445 56677     0 "
              DISPLAY "MOVE X-EDIT failed: " MOVE73 ".".
           MOVE 019823 TO AE-0002.
           IF GRP-AE-0002 NOT EQUAL TO "01098 23 "
              DISPLAY "MOVE AE-EDIT failed: " GRP-AE-0002 ".".
           MOVE WRK-DS-LS-1P17-1 TO WRK-AE-3.
           DISPLAY "MOVE 1P17: " WRK-DS-LS-1P17-1 " : "
                      LENGTH OF WRK-DS-LS-1P17-1 ".".
           DISPLAY "MOVE A-E : " WRK-AE-3 ".".
           IF WRK-AE-3 NOT EQUAL TO "1 000/000/000/000/000 00"
             DISPLAY "MOVE 1P17 failed: " WRK-AE-3.
           DISPLAY "INIT X-1 : " X-1 " .".
           DISPLAY "INIT X-2 : " X-2 " .".
           DISPLAY "INIT X-4 : " X-4 " .".
           DISPLAY "INIT D-1 : " D-1 " .".
           MOVE D-1 TO X-2 X-1
           MOVE X-2 TO D-1.
           DISPLAY "MOVE X-1 : " X-1 " .".
           DISPLAY "MOVE X-2 : " X-2 " .".
           MOVE 0.000256 TO X-4
           DISPLAY "MOVE X-4 : " X-4 " .".
           DISPLAY "MOVE D-1 : " D-1 " .".
           MOVE D-2 TO X-2 X-1
           DISPLAY "MOVE X-1 : " X-1 ":" D-2 " .".
           DISPLAY "MOVE X-2 : " X-2 ":" D-2 " .".
           MOVE 98000   TO X-1.
           IF X-1 NOT = 98000
             DISPLAY "MOVE 98000 failed: " X-1.
           MOVE 98000   TO D-1
           IF D-1 NOT = 98000
             DISPLAY "MOVE 98000 failed: " D-1.
           ADD 1000 TO X-1
           IF X-1 NOT = 99000
             DISPLAY "+ 1000 failed: " X-1.
           SUBTRACT 4000 FROM X-1.
           IF X-1 NOT = 95000
             DISPLAY "- 4000 failed: " X-1.
           DIVIDE 3 INTO X-1.
           IF X-1 NOT = 31000
             DISPLAY "/ 3 failed: " X-1.
           MULTIPLY 2 BY X-1 GIVING X-1.
           IF X-1 NOT = 62000
             DISPLAY "* 2 failed: " X-1.
           STOP RUN.
])

# CHECKME: -Wno-strict-typing because of MOVE warning
AT_CHECK([$COMPILE -Wno-strict-typing prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[MOVE 1P17: -100000000000000000 : 2.
MOVE A-E : 1 000/000/000/000/000 00.
INIT X-1 : 091000 .
INIT X-2 : 092000 .
INIT X-4 : .000128 .
INIT D-1 : 095000 .
MOVE X-1 : 095000 .
MOVE X-2 : 095000 .
MOVE X-4 : .000256 .
MOVE D-1 : 095000 .
MOVE X-1 : 193000:193000 .
MOVE X-2 : 193000:193000 .
], [])

AT_CLEANUP


AT_SETUP([PPP COMP-6])
AT_KEYWORDS([PACKED-DECIMAL fundamental MOVE DISPLAY ADD SUBTRACT MULTIPLY DIVIDE])

# note: for changes mind the nearly identical test in data_display.at

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 XS.
         05 X-1  PIC 999PPP COMP-6  VALUE 91000.
         05 X-2  PIC 999PPP COMP-6  VALUE 92000.
         05 X-3  PIC X VALUE "$".
         05 X-4  PIC VPPP999 COMP-6 VALUE 0.000128.
       01 D-1    PIC 999PPP  COMP-6 VALUE 95000.
       01 D-2    PIC 9999PP  COMP-6 VALUE 193000.
       PROCEDURE        DIVISION.
           DISPLAY "INIT X-1 : " X-1 " .".
           DISPLAY "INIT X-2 : " X-2 " .".
           DISPLAY "INIT X-4 : " X-4 " .".
           DISPLAY "INIT D-1 : " D-1 " .".
           MOVE D-1 TO X-2 X-1
           MOVE X-2 TO D-1.
           DISPLAY "MOVE X-1 : " X-1 " .".
           DISPLAY "MOVE X-2 : " X-2 " .".
           MOVE 0.000256 TO X-4
           DISPLAY "MOVE X-4 : " X-4 " .".
           DISPLAY "MOVE D-1 : " D-1 " .".
           MOVE D-2 TO X-2 X-1
           DISPLAY "MOVE X-1 : " X-1 ":" D-2 " .".
           DISPLAY "MOVE X-2 : " X-2 ":" D-2 " .".
           MOVE 98000   TO X-1.
           IF X-1 NOT = 98000
             DISPLAY "MOVE 98000 failed: " X-1.
           MOVE 98000   TO D-1
           IF D-1 NOT = 98000
             DISPLAY "MOVE 98000 failed: " D-1.
           ADD 1000 TO X-1
           IF X-1 NOT = 99000
             DISPLAY "+ 1000 failed: " X-1.
           SUBTRACT 4000 FROM X-1.
           IF X-1 NOT = 95000
             DISPLAY "- 4000 failed: " X-1.
           DIVIDE 3 INTO X-1.
           IF X-1 NOT = 31000
             DISPLAY "/ 3 failed: " X-1.
           MULTIPLY 2 BY X-1 GIVING X-1.
           IF X-1 NOT = 62000
             DISPLAY "* 2 failed: " X-1.             
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[INIT X-1 : 091000 .
INIT X-2 : 092000 .
INIT X-4 : .000128 .
INIT D-1 : 095000 .
MOVE X-1 : 095000 .
MOVE X-2 : 095000 .
MOVE X-4 : .000256 .
MOVE D-1 : 095000 .
MOVE X-1 : 193000:193000 .
MOVE X-2 : 193000:193000 .
], [])

AT_CLEANUP


AT_SETUP([arithmetic truncation with USAGE PACKED-DECIMAL])
AT_KEYWORDS([fundamental COMPUTE])

# note: for changes mind the nearly identical test in data_displayd.at

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 RESULT        PIC 9(03) PACKED-DECIMAL.
       PROCEDURE        DIVISION.
       MAIN.
      * internal arithmetic to DISPLAY
           MOVE 1 TO RESULT
           COMPUTE RESULT = 15 + RESULT - 2 / RESULT
           IF RESULT NOT = 14
              DISPLAY "NOT 14: " RESULT.

      * internal arithmetic to DISPLAY, with sign drop
           MOVE 1 TO RESULT
           COMPUTE RESULT = 15 + RESULT - 20 / RESULT
           IF RESULT NOT = 4
              DISPLAY "NOT [-] 4: " RESULT.

      * internal arithmetic to DISPLAY with truncation of decimal-part
           MOVE 1 TO RESULT
           COMPUTE RESULT = 15 + RESULT / 2
           IF RESULT NOT = 15
              DISPLAY "NOT 15: " RESULT.

      * internal arithmetic to DISPLAY with truncation of integer-part
           MOVE 1 TO RESULT
           COMPUTE RESULT = 15 + RESULT - 2000 / RESULT
           IF RESULT NOT = 984
              DISPLAY "NOT [-1] 984: " RESULT.

      * internal arithmetic to DISPLAY with truncation of integer-part
      * with leading zeros after truncation
           MOVE 1 TO RESULT
           COMPUTE RESULT = 15 + RESULT + 2000 / RESULT
           IF RESULT NOT = 16
              DISPLAY "NOT [+20] 16: " RESULT.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP

