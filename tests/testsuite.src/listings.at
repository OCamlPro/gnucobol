## Copyright (C) 2015-2022 Free Software Foundation, Inc.
## Written by Dave Pitts, Simon Sobisch, Edward Hart
##
## This file is part of GnuCOBOL.
##
## The GnuCOBOL compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
##
## GnuCOBOL is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with GnuCOBOL.  If not, see <https://www.gnu.org/licenses/>.

### GnuCOBOL Test Suite

AT_SETUP([Minimal lines per listing pages])
AT_KEYWORDS([listing symbols options])

# note: 2.2 did not use a minmal length,
# a typo like -tlines=2 loops forever

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
      * some comments go here
                 *> and here
                        *> and finally... here
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 NEWSTUFF PIC X(80).
       PROCEDURE        DIVISION.
           DISPLAY NEWSTUFF " BENEFITS SOME PARTS FROM "
           "MANY" "STUFF" ", " "VERY MUCH" "GOOD" NEWSTUFF
           "AND STUFF !"
                   NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_DATA([expected.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002        * some comments go here
000003                   *> and here
000004                          *> and finally... here
000005         IDENTIFICATION   DIVISION.
000006         PROGRAM-ID.      prog.
000007         DATA             DIVISION.
000008         WORKING-STORAGE  SECTION.
000009         01 NEWSTUFF PIC X(80).
000010         PROCEDURE        DIVISION.
000011             DISPLAY NEWSTUFF " BENEFITS SOME PARTS FROM "
000012             "MANY" "STUFF" ", " "VERY MUCH" "GOOD" NEWSTUFF
000013             "AND STUFF !"
000014                     NO ADVANCING
000015             END-DISPLAY.
000016             STOP RUN.

GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=2 prog.cob], [0], [],
[cobc: warning: 2 lines per listing page specified, using 20
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY within comment])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
      *COPY "copy.inc".
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog1.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006        *COPY "copy.inc".
000007         PROCEDURE        DIVISION.
000008             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog1.lst prog.lis], [0], [], [])

AT_DATA([prog2.cob], [
  IDENTIFICATION   DIVISION.
  PROGRAM-ID.      prog2.
  DATA             DIVISION.
  WORKING-STORAGE  SECTION.
  *> COPY "copy.inc".
  PROCEDURE        DIVISION.
  STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -free prog2.cob], [0], [], [])

AT_DATA([prog2.lst],
[GnuCOBOL V.R.P               prog2.cob                  DDD MMM dd HH:MM:SS YYYY

LINE    .....................SOURCE.............................................

000001
000002    IDENTIFICATION   DIVISION.
000003    PROGRAM-ID.      prog2.
000004    DATA             DIVISION.
000005    WORKING-STORAGE  SECTION.
000006    *> COPY "copy.inc".
000007    PROCEDURE        DIVISION.
000008    STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog2.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Replacement w/o strings])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       REPLACE   =="SOME"== BY =="MANY"==
                 =='SOME'== BY =="VERY MUCH"==
                 ==STUFF==  BY ==NEWSTUFF==.
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 NEWSTUFF PIC X(80).
       PROCEDURE        DIVISION.
           DISPLAY STUFF " BENEFITS SOME PARTS FROM "
                   "SOME" "STUFF" ", " 'SOME' "GOOD" STUFF "AND STUFF !"
                   NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([expected.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         REPLACE   =="SOME"== BY =="MANY"==
000003                   =='SOME'== BY =="VERY MUCH"==
000004                   ==STUFF==  BY ==NEWSTUFF==.
000005         IDENTIFICATION   DIVISION.
000006         PROGRAM-ID.      prog.
000007         DATA             DIVISION.
000008         WORKING-STORAGE  SECTION.
000009         01 NEWSTUFF PIC X(80).
000010         PROCEDURE        DIVISION.
000011             DISPLAY NEWSTUFF " BENEFITS SOME PARTS FROM "
000012             "MANY" "STUFF" ", " "VERY MUCH" "GOOD" NEWSTUFF
000012+       -    "AND STUFF !"
000013                     NO ADVANCING
000014             END-DISPLAY.
000015             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00080 ALPHANUMERIC   01   NEWSTUFF                       X(80)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Partial replacement with literals])
AT_KEYWORDS([listing gcos])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       1 W-DATA.
         3 X            PIC X(1) VALUE "X".
         3 XX           PIC X(2) VALUE "XX".
         3 Z            PIC X(1) VALUE "Z".
         3 ZZ           PIC X(2) VALUE "ZZ".
         3 Y            PIC X(1) VALUE "Y".
       PROCEDURE        DIVISION.
           REPLACE LEADING "X" BY SPACES
                   TRAILING "Z" BY SPACES
                   LEADING "Y" BY "X".
       MAIN.
           DISPLAY "XX: *" XX "*"
           DISPLAY "X: *" X "*"
           DISPLAY "ZZ: *" ZZ "*"
           DISPLAY "Z: *" Z "*"
           DISPLAY "Y: *" Y "*"
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -fpartial-replace-when-literal-src=skip -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([expected.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         1 W-DATA.
000007           3 X            PIC X(1) VALUE "X".
000008           3 XX           PIC X(2) VALUE "XX".
000009           3 Z            PIC X(1) VALUE "Z".
000010           3 ZZ           PIC X(2) VALUE "ZZ".
000011           3 Y            PIC X(1) VALUE "Y".
000012         PROCEDURE        DIVISION.
000013             REPLACE LEADING "X" BY SPACES
000014                     TRAILING "Z" BY SPACES
000015                     LEADING "Y" BY "X".
000016         MAIN.
000017             DISPLAY "XX: *" X "*"
000018             DISPLAY "X: *" X "*"
000019             DISPLAY "ZZ: *" ZZ "*"
000020             DISPLAY "Z: *" Z "*"
000021             DISPLAY "Y: *" X "*"
000022             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])

AT_CLEANUP



AT_SETUP([COPY replacement with partial match])
AT_KEYWORDS([listing copy])
AT_XFAIL_IF([true])

AT_DATA([copy.inc], [
       02 TEST-VAR PIC X(2) VALUE "OK".
       02 TEST-CC PIC X(4) VALUE "OK 2".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION. 
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION. 
       01 GET-VALUE.
       COPY "copy.inc" REPLACING ==TEST-VAR==     BY ==TEST-AVR==
                                 == 02 TEST-EE == BY == 02 TEST-FF ==.
       PROCEDURE DIVISION.
           DISPLAY TEST-AVR.
           STOP RUN.
])
AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])
# TODO: check listing

AT_CLEANUP


AT_SETUP([COPY replacement with multiple partial matches])
AT_KEYWORDS([listing copy])
AT_XFAIL_IF([true])

AT_DATA([copy.inc], [
       02 TEST-VAR PIC X(2) VALUE "OK".
       02 TEST-VAR-BIS PIC X(6) VALUE "OK BIS".
       02 TEST-CC PIC X(4) VALUE "OK 2".
       02 TEST-OK PIC X(4) VALUE "OK 3".
       02 TEST-EE PIC X(4) VALUE "OK 4".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION. 
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION. 
       01 GET-VALUE.
       COPY "copy.inc" REPLACING
          LEADING ==TEST-VAR==     BY ==TEST-AVR==
                  == 02 TEST-OK == BY == 02 TEST-KO ==
                  ==TEST-CC==      BY ==TEST-DD==
                  == 02 TEST-EE == BY == 02 TEST-FF ==
                  == PIC ==        BY == pic ==.
       PROCEDURE DIVISION.
           DISPLAY TEST-AVR.
           DISPLAY TEST-AVR-BIS.
           DISPLAY TEST-KO.
           DISPLAY TEST-DD.
           DISPLAY TEST-FF.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])
# TODO: check listing

AT_DATA([copy2.inc], [
       02 TEST-VAR PIC X(2) VALUE "OK".
       02 TEST-VAR-BIS PIC X(6) VALUE "OK BIS".
       02 TEST-CC PIC X(4) VALUE "OK 2".
       02 TEST-OK PIC X(4) VALUE "OK 3".
       02 TEST-EE PIC X(4) VALUE "OK 4".
])

AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION. 
       PROGRAM-ID. prog2.
       DATA DIVISION.
       WORKING-STORAGE SECTION. 
       01 GET-VALUE.
       COPY "copy2.inc"
           REPLACING LEADING ==TEST-VAR== BY ==TEST-AVR==
            ==     02    TEST-OK       == BY == 02 TEST-KO ==
        ==            TEST-CC          == BY == TEST-DD ==
         == 02 TEST-EE                 == BY == 02 TEST-FF ==
          ==                       PIC == BY == pic ==.
       PROCEDURE DIVISION.
           DISPLAY TEST-AVR.
           DISPLAY TEST-AVR-BIS.
           DISPLAY TEST-KO.
           DISPLAY TEST-DD.
           DISPLAY TEST-FF.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog2.lst -tlines=0 prog2.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog2.lst prog2.lis once], [0], [], [])
AT_CHECK([diff expected2.lst prog2.lis], [0], [], [])
# TODO: check listing

AT_DATA([copy3.inc], [
       02         TEST-VAR      PIC       X(2)     VALUE         "OK".
              02  TEST-VAR-BIS               PIC X(6) VALUE "OK BIS".
       02 TEST-CC PIC X(4)            VALUE "OK 2".
       02 TEST-OK PIC            X(4) VALUE "OK 3".
       02 TEST-EE PIC X(4) VALUE "OK 4".
])

AT_DATA([prog3.cob], [
       IDENTIFICATION DIVISION. 
       PROGRAM-ID. prog3.
       DATA DIVISION.
       WORKING-STORAGE SECTION. 
       01 GET-VALUE.
       COPY "copy3.inc"
           REPLACING LEADING ==TEST-VAR== BY ==TEST-AVR==
                         == 02 TEST-OK == BY == 02 TEST-KO ==
                              ==TEST-CC== BY ==TEST-DD==
                         == 02 TEST-EE == BY == 02 TEST-FF ==
                                == PIC == BY == pic ==.
       PROCEDURE DIVISION.
           DISPLAY TEST-AVR.
           DISPLAY TEST-AVR-BIS.
           DISPLAY TEST-KO.
           DISPLAY TEST-DD.
           DISPLAY TEST-FF.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog3.lst -tlines=0 prog3.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog3.lst prog3.lis once], [0], [], [])
AT_CHECK([diff expected3.lst prog3.lis], [0], [], [])
# TODO: check listing

AT_CLEANUP


AT_SETUP([COPY replacement order])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       01 TEST-VAR PIC X(2) VALUE "OK".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy.inc"
          REPLACING ==TEST-VAR== BY ==FIRST-MATCH==
                    ==TEST-VAR== BY ==SECOND-MATCH==.
       PROCEDURE        DIVISION.
           DISPLAY FIRST-MATCH NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([prog3.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc"
000007            REPLACING ==TEST-VAR== BY ==FIRST-MATCH==
000008                      ==TEST-VAR== BY ==SECOND-MATCH==.
000001C
000002C        01 FIRST-MATCH PIC X(2) VALUE "OK".
000009         PROCEDURE        DIVISION.
000010             DISPLAY FIRST-MATCH NO ADVANCING
000011             END-DISPLAY.
000012             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   FIRST-MATCH                    X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog3.lst prog.lis], [0], [], [])

AT_CHECK([$COBC $FLAGS -E -o prog.i prog.cob], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.i], [0], [], [])

AT_DATA([prog4.lst],
[GnuCOBOL V.R.P               prog.i                     DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001  #line 1 "prog.cob"
000001
000002   IDENTIFICATION   DIVISION.
000003   PROGRAM-ID. prog.
000004   DATA DIVISION.
000005   WORKING-STORAGE SECTION.
000006
000007
000008
000001  #line 1 "copy.inc"
000001
000002   01 FIRST-MATCH PIC X(2) VALUE "OK".
000008  #line 8 "prog.cob"
000008
000009   PROCEDURE DIVISION.
000010   DISPLAY FIRST-MATCH NO ADVANCING
000011   END-DISPLAY.
000012   STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   FIRST-MATCH                    X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog4.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY separators])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       01 TEST-VAR PIC X(2) VALUE "OK".                                  COPY001
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.                                        PROG001
       PROGRAM-ID.      prog.                                            PROG002
       DATA             DIVISION.                                        PROG003
       WORKING-STORAGE  SECTION.                                         PROG004
       COPY "copy.inc"                                                   PROG005
          REPLACING ==TEST-VAR==, BY ==FIRST-MATCH==,                    PROG006
                 ,  ==TEST-VAR==; BY ==SECOND-MATCH==;                   PROG007
                 ;  ==TEST-VAR== , BY ==THIRD-MATCH==                    PROG008
                    ==TEST-VAR== ; BY ==FOURTH-MATCH==.                  PROG009
       PROCEDURE        DIVISION.                                        PROG010
           DISPLAY FIRST-MATCH NO ADVANCING                              PROG011
           END-DISPLAY.                                                  PROG012
           STOP RUN.                                                     PROG013
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([prog4.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc"
000007            REPLACING ==TEST-VAR==, BY ==FIRST-MATCH==,
000008                   ,  ==TEST-VAR==; BY ==SECOND-MATCH==;
000009                   ;  ==TEST-VAR== , BY ==THIRD-MATCH==
000010                      ==TEST-VAR== ; BY ==FOURTH-MATCH==.
000001C
000002C        01 FIRST-MATCH PIC X(2) VALUE "OK".
000011         PROCEDURE        DIVISION.
000012             DISPLAY FIRST-MATCH NO ADVANCING
000013             END-DISPLAY.
000014             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   FIRST-MATCH                    X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog4.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY partial replacement])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       01 :TEST:-VAR PIC X(2) VALUE "OK".
       01 (TEST)-VAR PIC X(2) VALUE "OK".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy.inc"
          REPLACING ==:TEST:== BY ==COLON==
                    ==(TEST)== BY ==PAREN==.
       PROCEDURE        DIVISION.
           DISPLAY COLON-VAR NO ADVANCING
           END-DISPLAY.
           DISPLAY PAREN-VAR NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([prog5.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc"
000007            REPLACING ==:TEST:== BY ==COLON==
000008                      ==(TEST)== BY ==PAREN==.
000001C
000002C        01 COLON PIC X(2) VALUE "OK".
000003C        01 PAREN PIC X(2) VALUE "OK".
000009         PROCEDURE        DIVISION.
000010             DISPLAY COLON-VAR NO ADVANCING
000011             END-DISPLAY.
000012             DISPLAY PAREN-VAR NO ADVANCING
000013             END-DISPLAY.
000014             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   COLON-VAR                      X(2)

00002 ALPHANUMERIC   01   PAREN-VAR                      X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog5.lst prog.lis], [0], [], [])

AT_CAPTURE_FILE([prog1.lst])

AT_DATA([copy1.inc], [
       01 'yyy-'struktur.
          05  'yyy-'hello    pic x(30) value 'yyy copy1.inc'.
          05  'yy1-'hello    pic x(30) value 'yy1 copy1.inc'.
          05  'yy2-'hello    pic x(30) value 'yy2 copy1.inc'.
          05  filler         pic x(20).
])

AT_DATA([prog1.cob], [
       identification division.
       program-id. copytest.

       data division.
       working-storage section.
       01 hello                pic x(20) value 'Copytest'.

       01 xx                   pic x(02).

          copy 'copy1.inc' replacing 'YYY-' by a10-
                                     'yy1-' by a11-
                                     'yy2-' by a12-.

          copy 'copy1.inc' replacing 'YYY-' by a20-
                                     'yy1-' by a21-
                                     'yy2-' by a22-.

          copy 'copy1.inc' replacing 'YYY-' by a30-
                                     'yy1-' by a31-
                                     'yy2-' by a32-.

       procedure division.

       display hello

       display 'a10-struktur'
       display a10-struktur

       display 'a20-struktur'
       display a20-struktur

       display 'a30-struktur'
       display a30-struktur

       goback.
       end program copytest.
])

AT_CHECK([$COMPILE_ONLY -t prog1.lst -tlines=0 -tsymbols prog1.cob], [0], [], [])

AT_DATA([prog6.lst],
[GnuCOBOL V.R.P               prog1.cob                  DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         identification division.
000003         program-id. copytest.
000004
000005         data division.
000006         working-storage section.
000007         01 hello                pic x(20) value 'Copytest'.
000008
000009         01 xx                   pic x(02).
000010
000011            copy 'copy1.inc' replacing 'YYY-' by a10-
000012                                       'yy1-' by a11-
000013                                       'yy2-' by a12-.
000001C
000002C        01 a10-struktur.
000003C        05 a10-hello pic x(30) value 'yyy copy1.inc'.
000004C        05 a11-hello pic x(30) value 'yy1 copy1.inc'.
000005C        05 a12-hello pic x(30) value 'yy2 copy1.inc'.
000006C           05  filler         pic x(20).
000014
000015            copy 'copy1.inc' replacing 'YYY-' by a20-
000016                                       'yy1-' by a21-
000017                                       'yy2-' by a22-.
000001C
000002C        01 a20-struktur.
000003C        05 a20-hello pic x(30) value 'yyy copy1.inc'.
000004C        05 a21-hello pic x(30) value 'yy1 copy1.inc'.
000005C        05 a22-hello pic x(30) value 'yy2 copy1.inc'.
000006C           05  filler         pic x(20).
000018
000019            copy 'copy1.inc' replacing 'YYY-' by a30-
000020                                       'yy1-' by a31-
000021                                       'yy2-' by a32-.
000001C
000002C        01 a30-struktur.
000003C        05 a30-hello pic x(30) value 'yyy copy1.inc'.
000004C        05 a31-hello pic x(30) value 'yy1 copy1.inc'.
000005C        05 a32-hello pic x(30) value 'yy2 copy1.inc'.
000006C           05  filler         pic x(20).
000022
000023         procedure division.
000024
000025         display hello
000026
000027         display 'a10-struktur'
000028         display a10-struktur
000029
000030         display 'a20-struktur'
000031         display a20-struktur
000032
000033         display 'a30-struktur'
000034         display a30-struktur
000035
000036         goback.
000037         end program copytest.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00020 ALPHANUMERIC   01   hello                          X(20)

00002 ALPHANUMERIC   01   xx                             X(02)

00110 GROUP          01   a10-struktur
00030 ALPHANUMERIC   05   a10-hello                      X(30)
00030 ALPHANUMERIC   05   a11-hello                      X(30)
00030 ALPHANUMERIC   05   a12-hello                      X(30)
00020 ALPHANUMERIC   05   FILLER                         X(20)

00110 GROUP          01   a20-struktur
00030 ALPHANUMERIC   05   a20-hello                      X(30)
00030 ALPHANUMERIC   05   a21-hello                      X(30)
00030 ALPHANUMERIC   05   a22-hello                      X(30)
00020 ALPHANUMERIC   05   FILLER                         X(20)

00110 GROUP          01   a30-struktur
00030 ALPHANUMERIC   05   a30-hello                      X(30)
00030 ALPHANUMERIC   05   a31-hello                      X(30)
00030 ALPHANUMERIC   05   a32-hello                      X(30)
00020 ALPHANUMERIC   05   FILLER                         X(20)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog1.lst prog1.lis once], [0], [], [])
AT_CHECK([diff prog6.lst prog1.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY LEADING replacement])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       01  TEST-VAR PIC X(2) VALUE "OK".
       01  NORM-VAR PIC X(2) VALUE "OK".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy.inc"
            REPLACING LEADING ==TEST== BY ==FIRST==
                      LEADING ==NORM== BY ==SECOND==.
       PROCEDURE        DIVISION.
           DISPLAY FIRST-VAR NO ADVANCING
           END-DISPLAY.
           DISPLAY SECOND-VAR NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([progl.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc"
000007              REPLACING LEADING ==TEST== BY ==FIRST==
000008                        LEADING ==NORM== BY ==SECOND==.
000001C
000002C        01 FIRST-VAR PIC X(2) VALUE "OK".
000003C        01 SECOND-VAR PIC X(2) VALUE "OK".
000009         PROCEDURE        DIVISION.
000010             DISPLAY FIRST-VAR NO ADVANCING
000011             END-DISPLAY.
000012             DISPLAY SECOND-VAR NO ADVANCING
000013             END-DISPLAY.
000014             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   FIRST-VAR                      X(2)

00002 ALPHANUMERIC   01   SECOND-VAR                     X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff progl.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY TRAILING replacement])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       01  TEST-FIRST  PIC X(2) VALUE "OK".
       01  TEST-SECOND PIC X(2) VALUE "OK".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy.inc"
            REPLACING TRAILING ==FIRST== BY ==VAR1==
                      TRAILING ==SECOND== BY ==VAR2==.
       PROCEDURE        DIVISION.
           DISPLAY TEST-VAR1 NO ADVANCING
           END-DISPLAY.
           DISPLAY TEST-VAR2 NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])


AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([progr.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc"
000007              REPLACING TRAILING ==FIRST== BY ==VAR1==
000008                        TRAILING ==SECOND== BY ==VAR2==.
000001C
000002C        01 TEST-VAR1 PIC X(2) VALUE "OK".
000003C        01 TEST-VAR2 PIC X(2) VALUE "OK".
000009         PROCEDURE        DIVISION.
000010             DISPLAY TEST-VAR1 NO ADVANCING
000011             END-DISPLAY.
000012             DISPLAY TEST-VAR2 NO ADVANCING
000013             END-DISPLAY.
000014             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   TEST-VAR1                      X(2)

00002 ALPHANUMERIC   01   TEST-VAR2                      X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff progr.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY recursive replacement])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy-2.inc], [
       01 TEST-VAR PIC X(2) VALUE "OK".
])

AT_DATA([copy-1.inc], [
       COPY "copy-2.inc".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy-1.inc"
           REPLACING ==TEST-VAR== BY ==COPY-VAR==.
       PROCEDURE        DIVISION.
           DISPLAY COPY-VAR NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([prog6.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy-1.inc"
000007             REPLACING ==TEST-VAR== BY ==COPY-VAR==.
000001C
000002C        COPY "copy-2.inc".
000001C
000002C        01 COPY-VAR PIC X(2) VALUE "OK".
000008         PROCEDURE        DIVISION.
000009             DISPLAY COPY-VAR NO ADVANCING
000010             END-DISPLAY.
000011             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   COPY-VAR                       X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog6.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([COPY multiple files])
AT_KEYWORDS([listing symbols BASED EXTERNAL GLOBAL])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy-fd-1.inc], [
       FD  TEXTFILE-1        RECORD VARYING 1 TO 999 CHARACTERS
                                 DEPENDING ON TEXTFILE-1-SIZE.
       01  TEXTRECD-1.
           03 FILLER         PIC X(999).
      *
])

AT_DATA([copy-fd-2.inc], [
       FD  TEXTFILE-2        RECORD VARYING 1 TO 999 CHARACTERS
                                 DEPENDING ON TEXTFILE-2-SIZE.
       01  TEXTRECD-2.
           03 FILLER         PIC X(999).
      *
])

AT_DATA([copy-ws-1.inc], [
       01  TEXTFILE-1-NAME          PIC X(080)     VALUE "TEXTFILE.1".
       01  TEXTFILE-1-OCFG          PIC X(001)     VALUE "C".
           88 TEXTFILE-1-NOTOPEN    VALUE "C".
           88 TEXTFILE-1-IS-OPEN    VALUE "I", "O", "U".
       01  TEXTFILE-1-SIZE          PIC 9(004) EXTERNAL.
      *
])

AT_DATA([copy-ws-2.inc], [
       01  TEXTFILE-2-NAME          PIC X(080)     VALUE "TEXTFILE.2".
       01  TEXTFILE-2-OCFG          PIC X(001)     VALUE "C".
           88 TEXTFILE-2-NOTOPEN    VALUE "C".
           88 TEXTFILE-2-IS-OPEN    VALUE "I", "O", "U".
       01  TEXTFILE-2-SIZE          PIC 9(004).
      *
])

AT_DATA([copy-sl-1.inc], [
           SELECT TEXTFILE-1   ASSIGN TO DISK    TEXTFILE-1-NAME
                               ORGANIZATION      LINE SEQUENTIAL
                               ACCESS MODE       SEQUENTIAL.
      *
])

AT_DATA([copy-sl-2.inc], [
           SELECT TEXTFILE-2   ASSIGN TO DISK    TEXTFILE-2-NAME
                               ORGANIZATION      LINE SEQUENTIAL
                               ACCESS MODE       SEQUENTIAL.
      *
])

AT_DATA([tstcpybk.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. tstcpybk.
      *
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
      *
       SOURCE-COMPUTER. LINUX.
       OBJECT-COMPUTER. LINUX.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           COPY "copy-sl-1.inc".
           COPY "copy-sl-2.inc".

       DATA DIVISION.
       FILE SECTION.
           COPY "copy-fd-1.inc".
           COPY "copy-fd-2.inc".

       WORKING-STORAGE SECTION.
       01  HEADER BASED.
           03 FILLER         PIC X(016)     VALUE 'FCSI CodeWerks:'.
           03 FILLER         PIC X(064)     VALUE
              'Name:tstcpybk.cbl  Version:1.7.1  Date:2017-03-15'.
           03 FILLER         PIC X(002)     VALUE LOW-VALUES.
      *
       77  GLOB              PIC 99         GLOBAL.
      *
           COPY "copy-ws-1.inc".
           COPY "copy-ws-2.inc".

       PROCEDURE DIVISION.
       MAIN-PROCEDURE SECTION.
       MAIN-PROCEDURE-0000.
           CONTINUE.
       MAIN-PROCEDURE-EXIT.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols tstcpybk.cob], [0], [], [])

AT_DATA([prog3.lst],
[GnuCOBOL V.R.P               tstcpybk.cob               DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. tstcpybk.
000004        *
000005         ENVIRONMENT DIVISION.
000006         CONFIGURATION SECTION.
000007        *
000008         SOURCE-COMPUTER. LINUX.
000009         OBJECT-COMPUTER. LINUX.
000010
000011         INPUT-OUTPUT SECTION.
000012         FILE-CONTROL.
000013             COPY "copy-sl-1.inc".
000001C
000002C            SELECT TEXTFILE-1   ASSIGN TO DISK    TEXTFILE-1-NAME
000003C                                ORGANIZATION      LINE SEQUENTIAL
000004C                                ACCESS MODE       SEQUENTIAL.
000005C       *
000014             COPY "copy-sl-2.inc".
000001C
000002C            SELECT TEXTFILE-2   ASSIGN TO DISK    TEXTFILE-2-NAME
000003C                                ORGANIZATION      LINE SEQUENTIAL
000004C                                ACCESS MODE       SEQUENTIAL.
000005C       *
000015
000016         DATA DIVISION.
000017         FILE SECTION.
000018             COPY "copy-fd-1.inc".
000001C
000002C        FD  TEXTFILE-1        RECORD VARYING 1 TO 999 CHARACTERS
000003C                                  DEPENDING ON TEXTFILE-1-SIZE.
000004C        01  TEXTRECD-1.
000005C            03 FILLER         PIC X(999).
000006C       *
000019             COPY "copy-fd-2.inc".
000001C
000002C        FD  TEXTFILE-2        RECORD VARYING 1 TO 999 CHARACTERS
000003C                                  DEPENDING ON TEXTFILE-2-SIZE.
000004C        01  TEXTRECD-2.
000005C            03 FILLER         PIC X(999).
000006C       *
000020
000021         WORKING-STORAGE SECTION.
000022         01  HEADER BASED.
000023             03 FILLER         PIC X(016)     VALUE 'FCSI CodeWerks:'.
000024             03 FILLER         PIC X(064)     VALUE
000025                'Name:tstcpybk.cbl  Version:1.7.1  Date:2017-03-15'.
000026             03 FILLER         PIC X(002)     VALUE LOW-VALUES.
000027        *
000028         77  GLOB              PIC 99         GLOBAL.
000029        *
000030             COPY "copy-ws-1.inc".
000001C
000002C        01  TEXTFILE-1-NAME          PIC X(080)     VALUE "TEXTFILE.1".
000003C        01  TEXTFILE-1-OCFG          PIC X(001)     VALUE "C".
000004C            88 TEXTFILE-1-NOTOPEN    VALUE "C".
000005C            88 TEXTFILE-1-IS-OPEN    VALUE "I", "O", "U".
000006C        01  TEXTFILE-1-SIZE          PIC 9(004) EXTERNAL.
000007C       *
000031             COPY "copy-ws-2.inc".
000001C
000002C        01  TEXTFILE-2-NAME          PIC X(080)     VALUE "TEXTFILE.2".
000003C        01  TEXTFILE-2-OCFG          PIC X(001)     VALUE "C".
000004C            88 TEXTFILE-2-NOTOPEN    VALUE "C".
000005C            88 TEXTFILE-2-IS-OPEN    VALUE "I", "O", "U".
000006C        01  TEXTFILE-2-SIZE          PIC 9(004).
000007C       *
000032
000033         PROCEDURE DIVISION.
000034         MAIN-PROCEDURE SECTION.
000035         MAIN-PROCEDURE-0000.
000036             CONTINUE.
000037         MAIN-PROCEDURE-EXIT.
000038             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

00999 FILE                TEXTFILE-1
00999 GROUP          01   TEXTRECD-1
00999 ALPHANUMERIC   03   FILLER                         X(999)

00999 FILE                TEXTFILE-2
00999 GROUP          01   TEXTRECD-2
00999 ALPHANUMERIC   03   FILLER                         X(999)

      WORKING-STORAGE SECTION

00082 GROUP          01   HEADER BASED
00016 ALPHANUMERIC   03   FILLER                         X(016)
00064 ALPHANUMERIC   03   FILLER                         X(064)
00002 ALPHANUMERIC   03   FILLER                         X(002)

00002 NUMERIC        77   GLOB                           99 GLOBAL

00080 ALPHANUMERIC   01   TEXTFILE-1-NAME                X(080)

00001 ALPHANUMERIC   01   TEXTFILE-1-OCFG                X(001)
      CONDITIONAL    88   TEXTFILE-1-NOTOPEN
      CONDITIONAL    88   TEXTFILE-1-IS-OPEN

00004 NUMERIC        01   TEXTFILE-1-SIZE                9(004) EXTERNAL

00080 ALPHANUMERIC   01   TEXTFILE-2-NAME                X(080)

00001 ALPHANUMERIC   01   TEXTFILE-2-OCFG                X(001)
      CONDITIONAL    88   TEXTFILE-2-NOTOPEN
      CONDITIONAL    88   TEXTFILE-2-IS-OPEN

00004 NUMERIC        01   TEXTFILE-2-SIZE                9(004)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog3.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Error/Warning messages])
AT_KEYWORDS([listing error warning warnings symbols])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       ENVIRONMENT    DIVISION.
       INPUT-OUTPUT   SECTION.
       FILE-CONTROL.
           SELECT testfile
               ASSIGN TO filename
               ORGANIZATION RELATIVE
               ACCESS IS sequentia
               STATUS IS stat.
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       COPY "copy.inc".
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY FIRST-MATCH NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -Wimplicit-define -t prog.lst prog.cob], [1], [], [ignore])

AT_DATA([prog12.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         COPY "copy.inc".
000001C
000002C        ENVIRONMENT    DIVISION.
000003C        INPUT-OUTPUT   SECTION.
000004C        FILE-CONTROL.
000005C            SELECT testfile
error: missing file description for FILE testfile
000006C                ASSIGN TO filename
000007C                ORGANIZATION RELATIVE
000008C                ACCESS IS sequentia
error: syntax error, unexpected Identifier, expecting DYNAMIC or RANDOM or
     + SEQUENTIAL
000009C                STATUS IS stat.
000005         DATA             DIVISION.
000006         WORKING-STORAGE  SECTION.
000007         PROCEDURE        DIVISION.
warning: variable 'filename' will be implicitly defined
000008             DISPLAY FIRST-MATCH NO ADVANCING
error: 'FIRST-MATCH' is not defined
000009             END-DISPLAY.
000010             STOP RUN.


GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

Error/Warning summary:

copy.inc:5: error: missing file description for FILE testfile
copy.inc:8: error: syntax error, unexpected Identifier, expecting DYNAMIC or RANDOM or SEQUENTIAL
prog.cob:7: warning: variable 'filename' will be implicitly defined
prog.cob:8: error: 'FIRST-MATCH' is not defined

1 warning in compilation group
3 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog12.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -Wimplicit-define -T prog.lst prog.cob], [1], [], [ignore])

AT_DATA([prog13.lst],
[GnuCOBOL V.R.P          prog.cob                                                      DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................SEQUENCE

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         COPY "copy.inc".
000001C
000002C        ENVIRONMENT    DIVISION.
000003C        INPUT-OUTPUT   SECTION.
000004C        FILE-CONTROL.
000005C            SELECT testfile
error: missing file description for FILE testfile
000006C                ASSIGN TO filename
000007C                ORGANIZATION RELATIVE
000008C                ACCESS IS sequentia
error: syntax error, unexpected Identifier, expecting DYNAMIC or RANDOM or SEQUENTIAL
000009C                STATUS IS stat.
000005         DATA             DIVISION.
000006         WORKING-STORAGE  SECTION.
000007         PROCEDURE        DIVISION.
warning: variable 'filename' will be implicitly defined
000008             DISPLAY FIRST-MATCH NO ADVANCING
error: 'FIRST-MATCH' is not defined
000009             END-DISPLAY.
000010             STOP RUN.


GnuCOBOL V.R.P          prog.cob                                                      DDD MMM dd HH:MM:SS YYYY  Page 0002

Error/Warning summary:

copy.inc:5: error: missing file description for FILE testfile
copy.inc:8: error: syntax error, unexpected Identifier, expecting DYNAMIC or RANDOM or SEQUENTIAL
prog.cob:7: warning: variable 'filename' will be implicitly defined
prog.cob:8: error: 'FIRST-MATCH' is not defined

1 warning in compilation group
3 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog13.lst prog.lis], [0], [], [])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 TEST-VAR PIC 9(2) VALUE 'F1'.
       PROCEDURE        DIVISION.
           DISPLAY TEST-VAR NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tsymbols prog.cob], [0], [], [ignore])

AT_DATA([prog14.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         01 TEST-VAR PIC 9(2) VALUE 'F1'.
warning: numeric value is expected
000007         PROCEDURE        DIVISION.
000008             DISPLAY TEST-VAR NO ADVANCING
000009             END-DISPLAY.
000010             STOP RUN.
GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 NUMERIC        01   TEST-VAR                       9(2)


GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0003

Error/Warning summary:

prog.cob:6: warning: numeric value is expected

1 warning in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog14.lst prog.lis], [0], [], [])


AT_CHECK([$COMPILE_ONLY -t prog.lst crud.cob], [1], [], [ignore])

AT_DATA([prog15.lst],
[GnuCOBOL V.R.P          crud.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

 cobc: crud.cob: No such file or directory


0 warnings in compilation group
1 error in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog15.lst prog.lis], [0], [], [])

AT_DATA([prog.cpy], [
       78  I   VALUE 20.
       78  J   VALUE 5000.
       78  M   VALUE 5.
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 TEST-VAR PIC 9(2) VALUE 12.
       COPY 'prog.cpy'.
       PROCEDURE        DIVISION.
           DISPLAY TEST-VAR NO ADVANCING
           END-DISPLAY
           MOVE 'AA' TO TEST-VAR
           DISPLAY TEST-VAR NO ADVANCING
           END-DISPLAY
           STOP RUN.
])

AT_CHECK([$COBC $FLAGS -E -o prog.i prog.cob], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.i], [0], [], [ignore])

AT_DATA([prog17.lst],
[GnuCOBOL V.R.P               prog.i                     DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001  #line 1 "prog.cob"
000001
000002   IDENTIFICATION   DIVISION.
000003   PROGRAM-ID. prog.
000004   DATA DIVISION.
000005   WORKING-STORAGE SECTION.
000006   01 TEST-VAR PIC 9(2) VALUE 12.
000007
000001  #line 1 "prog.cpy"
000001
000002   78 I VALUE 20.
000003   78 J VALUE 5000.
000004   78 M VALUE 5.
000007  #line 7 "prog.cob"
000007
000008   PROCEDURE DIVISION.
000009   DISPLAY TEST-VAR NO ADVANCING
000010   END-DISPLAY
000011   MOVE 'AA' TO TEST-VAR
warning: numeric value is expected
000012   DISPLAY TEST-VAR NO ADVANCING
000013   END-DISPLAY
000014   STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 NUMERIC        01   TEST-VAR                       9(2)



Error/Warning summary:

prog.cob:11: warning: numeric value is expected

1 warning in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog17.lst prog.lis], [0], [], [])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 TEST-VAR PIC 9(2) VALUE 'A'.
       COPY 'CRUD.CPY'.
       PROCEDURE        DIVISION.
           DISPLAY TEST-VAR NO ADVANCING
           END-DISPLAY
           MOVE 12 TO TEST-VAR
           DISPLAY TEST-VAR NO ADVANCING
           END-DISPLAY
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [1], [], [ignore])

AT_DATA([prog16.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         01 TEST-VAR PIC 9(2) VALUE 'A'.
warning: numeric value is expected
000007         COPY 'CRUD.CPY'.
error: CRUD.CPY: No such file or directory
000008         PROCEDURE        DIVISION.
000009             DISPLAY TEST-VAR NO ADVANCING
000010             END-DISPLAY
000011             MOVE 12 TO TEST-VAR
000012             DISPLAY TEST-VAR NO ADVANCING
000013             END-DISPLAY
000014             STOP RUN.



Error/Warning summary:

prog.cob:7: error: CRUD.CPY: No such file or directory
prog.cob:6: warning: numeric value is expected

1 warning in compilation group
1 error in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog16.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -fmax-errors=0 prog.cob], [97], [], [ignore])

AT_DATA([prog17.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         01 TEST-VAR PIC 9(2) VALUE 'A'.
000007         COPY 'CRUD.CPY'.
error: CRUD.CPY: No such file or directory
000008         PROCEDURE        DIVISION.
000009             DISPLAY TEST-VAR NO ADVANCING
000010             END-DISPLAY
000011             MOVE 12 TO TEST-VAR
000012             DISPLAY TEST-VAR NO ADVANCING
000013             END-DISPLAY
000014             STOP RUN.



Error/Warning summary:

prog.cob:7: error: CRUD.CPY: No such file or directory

0 warnings in compilation group
1 error in compilation group
Too many errors in compilation group: 0 maximum errors
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog17.lst prog.lis], [0], [], [])


AT_CLEANUP


AT_SETUP([Two source files])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
      *COPY "copy.inc".
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_DATA([prog1.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog1.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
      *COPY "copy.inc".
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst prog.cob prog1.cob], [0], [], [])

AT_DATA([prog11.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006        *COPY "copy.inc".
000007         PROCEDURE        DIVISION.
000008             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
GnuCOBOL V.R.P          prog1.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog1.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006        *COPY "copy.inc".
000007         PROCEDURE        DIVISION.
000008             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog11.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Multiple programs in one file])
AT_KEYWORDS([listing symbols])

AT_CAPTURE_FILE([prog.lst])
AT_CAPTURE_FILE([prog2.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-1.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  blah PIC x.

       END PROGRAM prog-1.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-2.
       END PROGRAM prog-2.
])

AT_DATA([prog20.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog-1.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  blah PIC x.
000008
000009         END PROGRAM prog-1.
000010
000011         IDENTIFICATION DIVISION.
000012         PROGRAM-ID. prog-2.
000013         END PROGRAM prog-2.
GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      PROGRAM             prog-1

      WORKING-STORAGE SECTION

00001 ALPHANUMERIC   01   blah                           X

      PROGRAM             prog-2

      No fields defined.


0 warnings in compilation group
0 errors in compilation group
])

# Check once with $COMPILE and once with $COMPILE_ONLY.
# This tests whether codegen affects the listing.
AT_CHECK([$COMPILE -t prog.lst -tsymbols prog.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20.lst prog.lis], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t prog2.lst -tsymbols prog.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog2.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20.lst prog.lis], [0], [], [])

AT_CHECK([rm -f prog.lst prog2.lst], [0], [], [])

AT_DATA([progb.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-1.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  blah PIC x.

       PROCEDURE DIVISION.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-2.
       PROCEDURE DIVISION.
       END PROGRAM prog-2.

       END PROGRAM prog-1.
])

AT_DATA([prog20b.lst],
[GnuCOBOL V.R.P          progb.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog-1.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  blah PIC x.
000008
000009         PROCEDURE DIVISION.
000010
000011         IDENTIFICATION DIVISION.
000012         PROGRAM-ID. prog-2.
000013         PROCEDURE DIVISION.
000014         END PROGRAM prog-2.
000015
000016         END PROGRAM prog-1.
GnuCOBOL V.R.P          progb.cob            DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      PROGRAM             prog-1

      WORKING-STORAGE SECTION

00001 ALPHANUMERIC   01   blah                           X

      PROGRAM             prog-2

      No fields defined.


0 warnings in compilation group
0 errors in compilation group
])

# Check once with $COMPILE and once with $COMPILE_ONLY.
# This tests whether codegen affects the listing.
AT_CHECK([$COMPILE -t prog.lst -tsymbols progb.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20b.lst prog.lis], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t prog2.lst -tsymbols progb.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog2.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20b.lst prog.lis], [0], [], [])

AT_CHECK([rm -f prog.lst prog2.lst], [0], [], [])

AT_DATA([progc.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-1.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  blah PIC x.

       PROCEDURE DIVISION.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-2.
       PROCEDURE.
       END PROGRAM prog-2.

       END PROGRAM prog-1.
])

AT_DATA([prog20c.lst],
[GnuCOBOL V.R.P          progc.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog-1.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  blah PIC x.
000008
000009         PROCEDURE DIVISION.
000010
000011         IDENTIFICATION DIVISION.
000012         PROGRAM-ID. prog-2.
000013         PROCEDURE.
error: syntax error, unexpected ., expecting DIVISION
000014         END PROGRAM prog-2.
000015
000016         END PROGRAM prog-1.
GnuCOBOL V.R.P          progc.cob            DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      PROGRAM             prog-1

      WORKING-STORAGE SECTION

00001 ALPHANUMERIC   01   blah                           X

      PROGRAM             prog-2

      No fields defined.


GnuCOBOL V.R.P          progc.cob            DDD MMM dd HH:MM:SS YYYY  Page 0003

Error/Warning summary:

progc.cob:13: error: syntax error, unexpected ., expecting DIVISION

0 warnings in compilation group
1 error in compilation group
])

# Check once with $COMPILE and once with $COMPILE_ONLY.
# This tests whether codegen affects the listing.
AT_CHECK([$COMPILE -t prog.lst -tsymbols progc.cob], [1], [], [ignore])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20c.lst prog.lis], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t prog2.lst -tsymbols progc.cob], [1], [], [ignore])
AT_CHECK([$UNIFY_LISTING prog2.lst prog.lis], [0], [], [])
AT_CHECK([diff prog20c.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Multiple programs in one compilation group])
AT_KEYWORDS([listing])

# TODO CHECK
# combinations and positions of entries in compilation group,
# the previous test should likely produce a different result, too...

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog-1.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-1.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  blah   PIC x.

       PROCEDURE DIVISION.
           ACCEPT blah END-ACCEPT
           CALL "prog-2" USING blah END-CALL
           GO TO EX

           DISPLAY blah.

       EX. STOP RUN.
])

AT_DATA([prog-2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog-2.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  data-b  PIC 9.
       LINKAGE SECTION.
       01  stuff   PIC x.
       PROCEDURE DIVISION USING stuff.
       MAIN.
           MOVE FUNCTION NUMVAL (stuff) TO data-b
           DISPLAY data-b
           GO TO EX

           ACCEPT stuff.

       EX. STOP RUN.

])

AT_DATA([expected.lst],
[GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog-1.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  blah   PIC x.
000008
000009         PROCEDURE DIVISION.
000010             ACCEPT blah END-ACCEPT
000011             CALL "prog-2" USING blah END-CALL
000012             GO TO EX
000013
000014             DISPLAY blah.
warning: unreachable statement 'DISPLAY'
000015
000016         EX. STOP RUN.
GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00001 ALPHANUMERIC   01   blah                           X

GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0003

NAME                           DEFINED                REFERENCES

blah                           7       *10      11      14             x3

GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0004

LABEL                          DEFINED                REFERENCES

E prog__1                      10
P EX                           16       12                             x1
GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0005

FUNCTION                       TYPE                   REFERENCES

L prog-2                       EXTERN   11                             x1

GnuCOBOL V.R.P          prog-1.cob           DDD MMM dd HH:MM:SS YYYY  Page 0006

Error/Warning summary:

prog-1.cob:14: warning: unreachable statement 'DISPLAY'

1 warning in compilation group
0 errors in compilation group
GnuCOBOL V.R.P          prog-2.cob           DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog-2.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  data-b  PIC 9.
000008         LINKAGE SECTION.
000009         01  stuff   PIC x.
000010         PROCEDURE DIVISION USING stuff.
000011         MAIN.
000012             MOVE FUNCTION NUMVAL (stuff) TO data-b
000013             DISPLAY data-b
000014             GO TO EX
000015
000016             ACCEPT stuff.
warning: unreachable statement 'ACCEPT'
000017
000018         EX. STOP RUN.
000019
GnuCOBOL V.R.P          prog-2.cob           DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00001 NUMERIC        01   data-b                         9

      LINKAGE SECTION

00001 ALPHANUMERIC   01   stuff                          X

GnuCOBOL V.R.P          prog-2.cob           DDD MMM dd HH:MM:SS YYYY  Page 0003

NAME                           DEFINED                REFERENCES

data-b                         7       *12      13                     x2

stuff                          9       *10      12     *16             x3

GnuCOBOL V.R.P          prog-2.cob           DDD MMM dd HH:MM:SS YYYY  Page 0004

LABEL                          DEFINED                REFERENCES

E prog__2                      11
P MAIN                         11     not referenced
P EX                           18       14                             x1

GnuCOBOL V.R.P          prog-2.cob           DDD MMM dd HH:MM:SS YYYY  Page 0005

Error/Warning summary:

prog-2.cob:16: warning: unreachable statement 'ACCEPT'

2 warnings in compilation group
0 errors in compilation group
])

# Check once with $COMPILE and once with $COMPILE_ONLY.
# This tests whether codegen affects the listing.

AT_CHECK([$COMPILE -Wunreachable -t prog.lst -Xref -tsymbols prog-1.cob prog-2.cob], [0], [], [ignore])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -Wunreachable -t prog.lst -Xref -tsymbols prog-1.cob prog-2.cob], [0], [], [ignore])
AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff expected.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Wide listing])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.                                       PROG001
       PROGRAM-ID.      prog.                                           PROG002
       DATA             DIVISION.                                       PROG003
       WORKING-STORAGE  SECTION.                                        PROG004
      /                                                                 PROG005
       PROCEDURE        DIVISION.                                       PROG006
           STOP RUN.                                                    PROG007
])

AT_CHECK([$COMPILE_ONLY -T prog.lst prog.cob], [0], [], [])

AT_DATA([prog9.lst],
[GnuCOBOL V.R.P          prog.cob                                                      DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................SEQUENCE

000001
000002         IDENTIFICATION   DIVISION.                                       PROG001
000003         PROGRAM-ID.      prog.                                           PROG002
000004         DATA             DIVISION.                                       PROG003
000005         WORKING-STORAGE  SECTION.                                        PROG004
GnuCOBOL V.R.P          prog.cob                                                      DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    PG/LN  A...B............................................................SEQUENCE

000006        /                                                                 PROG005
000007         PROCEDURE        DIVISION.                                       PROG006
000008             STOP RUN.                                                    PROG007


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog9.lst prog.lis], [0], [], [])

AT_DATA([prog2.cob], [
  IDENTIFICATION   DIVISION.
  PROGRAM-ID.      prog2.
  DATA             DIVISION.
  WORKING-STORAGE  SECTION.
  >> PAGE  page  feed  comment
  PROCEDURE        DIVISION.
 DISPLAY
 '3456&'.
  STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -T prog.lst -free prog2.cob], [0], [], [])

AT_DATA([prog10.lst],
[GnuCOBOL V.R.P          prog2.cob                                                     DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    .....................................................SOURCE.....................................................

000001
000002    IDENTIFICATION   DIVISION.
000003    PROGRAM-ID.      prog2.
000004    DATA             DIVISION.
000005    WORKING-STORAGE  SECTION.
GnuCOBOL V.R.P          prog2.cob                                                     DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    .....................................................SOURCE.....................................................

000006    >> PAGE  page  feed  comment
000007    PROCEDURE        DIVISION.
000008   DISPLAY
000009   '3456&'.
000010    STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog10.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Symbols: simple])
AT_KEYWORDS([listing COMP])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 WS-ONE    PIC 9(4) VALUE 37.
       01 WS-TWO    PIC A(4) VALUE 'HIGH'.
       01 WS-THREE  PIC X(4) VALUE 'BAR'.
       01 WS-FOUR            COMP-1 VALUE 37.
       01 WS-FIVE            COMP-2 VALUE 37.
       01 WS-SIX    PIC S999 COMP-3 VALUE -37.
       01 WS-SEVEN  PIC $$,$$$,$$9.99 VALUE ZERO.
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -fno-tmessages -tsymbols prog.cob], [0], [], [])

AT_DATA([prog15.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         01 WS-ONE    PIC 9(4) VALUE 37.
000007         01 WS-TWO    PIC A(4) VALUE 'HIGH'.
000008         01 WS-THREE  PIC X(4) VALUE 'BAR'.
000009         01 WS-FOUR            COMP-1 VALUE 37.
000010         01 WS-FIVE            COMP-2 VALUE 37.
000011         01 WS-SIX    PIC S999 COMP-3 VALUE -37.
000012         01 WS-SEVEN  PIC $$,$$$,$$9.99 VALUE ZERO.
000013         PROCEDURE        DIVISION.
000014             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00004 NUMERIC        01   WS-ONE                         9(4)

00004 ALPHABETIC     01   WS-TWO                         A(4)

00004 ALPHANUMERIC   01   WS-THREE                       X(4)

00004 NUMERIC        01   WS-FOUR                        S9(7)V9(8) COMP-1

00008 NUMERIC        01   WS-FIVE                        S9(17)V9(17) COMP-2

00002 NUMERIC        01   WS-SIX                         S999 COMP-3

00013 NUMERIC        01   WS-SEVEN                       $$,$$$,$$9.99


])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog15.lst prog.lis], [0], [], [])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 WS-ONE    PIC 9(4).
       01 WS-TWO    PIC A(4).
       01 WS-THREE  PIC X(4).
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -fno-tmessages -fno-tsource -tsymbols prog2.cob], [0], [], [])

AT_DATA([prog16.lst],
[GnuCOBOL V.R.P               prog2.cob                  DDD MMM dd HH:MM:SS YYYY

SIZE  TYPE           LVL  NAME                           PICTURE

      LINKAGE SECTION

00004 NUMERIC        01   WS-ONE                         9(4)

00004 ALPHABETIC     01   WS-TWO                         A(4)

00004 ALPHANUMERIC   01   WS-THREE                       X(4)


])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog16.lst prog.lis], [0], [], [])

AT_DATA([prog3.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog3.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 WS-ONE    PIC 9(4) VALUE 37.
       01 WS-TWO    PIC A(4) VALUE 'HIGH'.
       01 WS-THREE  PIC X(4) VALUE 'BAR'.
       01 WS-FOUR            COMP-1 VALUE 37.
       01 WS-FIVE            COMP-2 VALUE 37.
       01 WS-SIX    PIC S999 COMP-3 VALUE -37.
       01 WS-SEVEN  PIC $$,$$$,$$9.99 VALUE ZERO.
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -fno-tsource -fno-tmessages -tsymbols prog3.cob], [0], [], [])

AT_DATA([prog15-1.lst],
[GnuCOBOL V.R.P          prog3.cob                  DDD MMM dd HH:MM:SS YYYY

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00004 NUMERIC        01   WS-ONE                         9(4)

00004 ALPHABETIC     01   WS-TWO                         A(4)

00004 ALPHANUMERIC   01   WS-THREE                       X(4)

00004 NUMERIC        01   WS-FOUR                        S9(7)V9(8) COMP-1

00008 NUMERIC        01   WS-FIVE                        S9(17)V9(17) COMP-2

00002 NUMERIC        01   WS-SIX                         S999 COMP-3

00013 NUMERIC        01   WS-SEVEN                       $$,$$$,$$9.99


])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog15-1.lst prog.lis], [0], [], [])

# verify that the symbol listing is identical if full codegen was done
AT_CHECK([$COMPILE -t prog.lst -tlines=0 -fno-tsource -fno-tmessages -tsymbols prog3.cob], [0], [], [])

AT_CHECK([$UNIFY_LISTING prog.lst compiled.lis], [0], [], [])
AT_CHECK([diff prog15-1.lst compiled.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Symbols: pointer])
AT_KEYWORDS([listing 64bit])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  WS-Where           pic x(512).

       01  ws-mysql.
           02  ws-mysql-cid                        usage pointer.
           02  ws-mysql-result                     usage pointer.
           02  ws-mysql-result-2                   usage pointer.
           02  ws-mysql-result-3                   usage pointer.
           02  ws-mysql-count-rows                 pic s9(9) comp.
           02  ws-mysql-error-number               pic x(4).
           02  ws-mysql-error-message              pic x(80).
           02  ws-mysql-host-name                  pic x(64).
           02  ws-mysql-implementation             pic x(64).
           02  ws-mysql-password                   pic x(64).
           02  ws-mysql-base-name                  pic x(64).
           02  ws-mysql-port-number                pic x(4).
           02  ws-mysql-socket                     pic x(64).
           02  ws-mysql-command                    pic x(4096).

       01  ws-No-Paragraph pic 9(4).
       local-storage section.
       01  subscripts usage comp-5.
           12 J                    pic s9(4).
           12 K                    pic s9(4).
           12 L                    pic s9(4).

       SCREEN           SECTION.
       01  Display-Message-1 foreground-color 2.
           03  value "WS-Where=" line 23 col  1.
           03  from WS-Where (1:J) pic x(69) col 10.
       01  Display-Message-2 foreground-color 2.
           03  value "ST004 SQL Err No.=" line 4 col  1.
           03  using ws-mysql-error-number pic x(4) col 19.
           03  value " Para=" col 23.
           03  using WS-No-Paragraph pic 9(3) col 29.
           03  value " SQL Cmd=" col 32.
           03  using ws-mysql-command pic x(199) col 41.
           03  value "SQL Err Msg=" line 7 col  1.
           03  using ws-mysql-error-message pic x(67) col 13.
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])

AT_CHECK([test "$COB_HAS_64_BIT_POINTER" = "yes"], [0], [], [],

# Previous test "failed" --> 32 bit

AT_DATA([prog17-32.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         77  WS-Where           pic x(512).
000007
000008         01  ws-mysql.
000009             02  ws-mysql-cid                        usage pointer.
000010             02  ws-mysql-result                     usage pointer.
000011             02  ws-mysql-result-2                   usage pointer.
000012             02  ws-mysql-result-3                   usage pointer.
000013             02  ws-mysql-count-rows                 pic s9(9) comp.
000014             02  ws-mysql-error-number               pic x(4).
000015             02  ws-mysql-error-message              pic x(80).
000016             02  ws-mysql-host-name                  pic x(64).
000017             02  ws-mysql-implementation             pic x(64).
000018             02  ws-mysql-password                   pic x(64).
000019             02  ws-mysql-base-name                  pic x(64).
000020             02  ws-mysql-port-number                pic x(4).
000021             02  ws-mysql-socket                     pic x(64).
000022             02  ws-mysql-command                    pic x(4096).
000023
000024         01  ws-No-Paragraph pic 9(4).
000025         local-storage section.
000026         01  subscripts usage comp-5.
000027             12 J                    pic s9(4).
000028             12 K                    pic s9(4).
000029             12 L                    pic s9(4).
000030
000031         SCREEN           SECTION.
000032         01  Display-Message-1 foreground-color 2.
000033             03  value "WS-Where=" line 23 col  1.
000034             03  from WS-Where (1:J) pic x(69) col 10.
000035         01  Display-Message-2 foreground-color 2.
000036             03  value "ST004 SQL Err No.=" line 4 col  1.
000037             03  using ws-mysql-error-number pic x(4) col 19.
000038             03  value " Para=" col 23.
000039             03  using WS-No-Paragraph pic 9(3) col 29.
000040             03  value " SQL Cmd=" col 32.
000041             03  using ws-mysql-command pic x(199) col 41.
000042             03  value "SQL Err Msg=" line 7 col  1.
000043             03  using ws-mysql-error-message pic x(67) col 13.
000044         PROCEDURE        DIVISION.
000045             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00512 ALPHANUMERIC   77   WS-Where                       X(512)

04524 GROUP          01   ws-mysql
00004 POINTER        02   ws-mysql-cid
00004 POINTER        02   ws-mysql-result
00004 POINTER        02   ws-mysql-result-2
00004 POINTER        02   ws-mysql-result-3
00004 NUMERIC        02   ws-mysql-count-rows            S9(9) COMP
00004 ALPHANUMERIC   02   ws-mysql-error-number          X(4)
00080 ALPHANUMERIC   02   ws-mysql-error-message         X(80)
00064 ALPHANUMERIC   02   ws-mysql-host-name             X(64)
00064 ALPHANUMERIC   02   ws-mysql-implementation        X(64)
00064 ALPHANUMERIC   02   ws-mysql-password              X(64)
00064 ALPHANUMERIC   02   ws-mysql-base-name             X(64)
00004 ALPHANUMERIC   02   ws-mysql-port-number           X(4)
00064 ALPHANUMERIC   02   ws-mysql-socket                X(64)
04096 ALPHANUMERIC   02   ws-mysql-command               X(4096)

00004 NUMERIC        01   ws-No-Paragraph                9(4)

      LOCAL-STORAGE SECTION

00006 GROUP          01   subscripts
00002 NUMERIC        12   J                              S9(4) COMP-5
00002 NUMERIC        12   K                              S9(4) COMP-5
00002 NUMERIC        12   L                              S9(4) COMP-5

      SCREEN SECTION

00078 GROUP          01   Display-Message-1
00009 ALPHANUMERIC   03   FILLER                         X(9)
00069 ALPHANUMERIC   03   FILLER                         X(69)

00318 GROUP          01   Display-Message-2
00018 ALPHANUMERIC   03   FILLER                         X(18)
00004 ALPHANUMERIC   03   FILLER                         X(4)
00006 ALPHANUMERIC   03   FILLER                         X(6)
00003 NUMERIC        03   FILLER                         9(3)
00009 ALPHANUMERIC   03   FILLER                         X(9)
00199 ALPHANUMERIC   03   FILLER                         X(199)
00012 ALPHANUMERIC   03   FILLER                         X(12)
00067 ALPHANUMERIC   03   FILLER                         X(67)


0 warnings in compilation group
0 errors in compilation group
])

[AT_CHECK([diff prog17-32.lst prog.lis], [0], [], [])]

,

# Previous test "passed" --> 64 bit

AT_DATA([prog17-64.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         77  WS-Where           pic x(512).
000007
000008         01  ws-mysql.
000009             02  ws-mysql-cid                        usage pointer.
000010             02  ws-mysql-result                     usage pointer.
000011             02  ws-mysql-result-2                   usage pointer.
000012             02  ws-mysql-result-3                   usage pointer.
000013             02  ws-mysql-count-rows                 pic s9(9) comp.
000014             02  ws-mysql-error-number               pic x(4).
000015             02  ws-mysql-error-message              pic x(80).
000016             02  ws-mysql-host-name                  pic x(64).
000017             02  ws-mysql-implementation             pic x(64).
000018             02  ws-mysql-password                   pic x(64).
000019             02  ws-mysql-base-name                  pic x(64).
000020             02  ws-mysql-port-number                pic x(4).
000021             02  ws-mysql-socket                     pic x(64).
000022             02  ws-mysql-command                    pic x(4096).
000023
000024         01  ws-No-Paragraph pic 9(4).
000025         local-storage section.
000026         01  subscripts usage comp-5.
000027             12 J                    pic s9(4).
000028             12 K                    pic s9(4).
000029             12 L                    pic s9(4).
000030
000031         SCREEN           SECTION.
000032         01  Display-Message-1 foreground-color 2.
000033             03  value "WS-Where=" line 23 col  1.
000034             03  from WS-Where (1:J) pic x(69) col 10.
000035         01  Display-Message-2 foreground-color 2.
000036             03  value "ST004 SQL Err No.=" line 4 col  1.
000037             03  using ws-mysql-error-number pic x(4) col 19.
000038             03  value " Para=" col 23.
000039             03  using WS-No-Paragraph pic 9(3) col 29.
000040             03  value " SQL Cmd=" col 32.
000041             03  using ws-mysql-command pic x(199) col 41.
000042             03  value "SQL Err Msg=" line 7 col  1.
000043             03  using ws-mysql-error-message pic x(67) col 13.
000044         PROCEDURE        DIVISION.
000045             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00512 ALPHANUMERIC   77   WS-Where                       X(512)

04540 GROUP          01   ws-mysql
00008 POINTER        02   ws-mysql-cid
00008 POINTER        02   ws-mysql-result
00008 POINTER        02   ws-mysql-result-2
00008 POINTER        02   ws-mysql-result-3
00004 NUMERIC        02   ws-mysql-count-rows            S9(9) COMP
00004 ALPHANUMERIC   02   ws-mysql-error-number          X(4)
00080 ALPHANUMERIC   02   ws-mysql-error-message         X(80)
00064 ALPHANUMERIC   02   ws-mysql-host-name             X(64)
00064 ALPHANUMERIC   02   ws-mysql-implementation        X(64)
00064 ALPHANUMERIC   02   ws-mysql-password              X(64)
00064 ALPHANUMERIC   02   ws-mysql-base-name             X(64)
00004 ALPHANUMERIC   02   ws-mysql-port-number           X(4)
00064 ALPHANUMERIC   02   ws-mysql-socket                X(64)
04096 ALPHANUMERIC   02   ws-mysql-command               X(4096)

00004 NUMERIC        01   ws-No-Paragraph                9(4)

      LOCAL-STORAGE SECTION

00006 GROUP          01   subscripts
00002 NUMERIC        12   J                              S9(4) COMP-5
00002 NUMERIC        12   K                              S9(4) COMP-5
00002 NUMERIC        12   L                              S9(4) COMP-5

      SCREEN SECTION

00078 GROUP          01   Display-Message-1
00009 ALPHANUMERIC   03   FILLER                         X(9)
00069 ALPHANUMERIC   03   FILLER                         X(69)

00318 GROUP          01   Display-Message-2
00018 ALPHANUMERIC   03   FILLER                         X(18)
00004 ALPHANUMERIC   03   FILLER                         X(4)
00006 ALPHANUMERIC   03   FILLER                         X(6)
00003 NUMERIC        03   FILLER                         9(3)
00009 ALPHANUMERIC   03   FILLER                         X(9)
00199 ALPHANUMERIC   03   FILLER                         X(199)
00012 ALPHANUMERIC   03   FILLER                         X(12)
00067 ALPHANUMERIC   03   FILLER                         X(67)


0 warnings in compilation group
0 errors in compilation group
])

[AT_CHECK([diff prog17-64.lst prog.lis], [0], [], [])]

)


AT_CLEANUP


AT_SETUP([Symbols: multiple programs/functions])
AT_KEYWORDS([listing program function])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       FUNCTION-ID.     WITHPAR.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 PAR-IN        PIC 9.
       01 PAR-OUT       PIC 9.
       PROCEDURE DIVISION USING PAR-IN RETURNING PAR-OUT.
           ADD 1 TO PAR-IN GIVING PAR-OUT END-ADD.
           GOBACK.
       END FUNCTION WITHPAR.

       IDENTIFICATION   DIVISION.
       FUNCTION-ID.     WITHOUTPAR.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 PAR           PIC 9.
       PROCEDURE DIVISION RETURNING PAR.
           MOVE 1 TO PAR.
           GOBACK.
       END FUNCTION WITHOUTPAR.

       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       REPOSITORY.
           FUNCTION     WITHPAR
           FUNCTION     WITHOUTPAR.
       PROCEDURE        DIVISION.
           IF WITHPAR(1) NOT = 2
              DISPLAY WITHPAR(1)
              END-DISPLAY
           END-IF.
           IF WITHOUTPAR NOT = 1
              DISPLAY WITHOUTPAR
              END-DISPLAY
           END-IF.
           STOP RUN.
       END PROGRAM prog.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tsymbols prog.cob], [0], [], [])

AT_DATA([prog18.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         FUNCTION-ID.     WITHPAR.
000004         DATA             DIVISION.
000005         LINKAGE          SECTION.
000006         01 PAR-IN        PIC 9.
000007         01 PAR-OUT       PIC 9.
000008         PROCEDURE DIVISION USING PAR-IN RETURNING PAR-OUT.
000009             ADD 1 TO PAR-IN GIVING PAR-OUT END-ADD.
000010             GOBACK.
000011         END FUNCTION WITHPAR.
000012
000013         IDENTIFICATION   DIVISION.
000014         FUNCTION-ID.     WITHOUTPAR.
000015         DATA             DIVISION.
000016         LINKAGE          SECTION.
000017         01 PAR           PIC 9.
000018         PROCEDURE DIVISION RETURNING PAR.
000019             MOVE 1 TO PAR.
000020             GOBACK.
000021         END FUNCTION WITHOUTPAR.
000022
000023         IDENTIFICATION   DIVISION.
000024         PROGRAM-ID.      prog.
000025         ENVIRONMENT      DIVISION.
000026         CONFIGURATION    SECTION.
000027         REPOSITORY.
000028             FUNCTION     WITHPAR
000029             FUNCTION     WITHOUTPAR.
000030         PROCEDURE        DIVISION.
000031             IF WITHPAR(1) NOT = 2
000032                DISPLAY WITHPAR(1)
000033                END-DISPLAY
000034             END-IF.
000035             IF WITHOUTPAR NOT = 1
000036                DISPLAY WITHOUTPAR
000037                END-DISPLAY
000038             END-IF.
000039             STOP RUN.
000040         END PROGRAM prog.
GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      FUNCTION            WITHPAR

      LINKAGE SECTION

00001 NUMERIC        01   PAR-IN                         9

00001 NUMERIC        01   PAR-OUT                        9

      FUNCTION            WITHOUTPAR

      LINKAGE SECTION

00001 NUMERIC        01   PAR                            9

      PROGRAM             prog

      No fields defined.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog18.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Symbols: OCCURS/REDEFINES])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       78  I   VALUE 20.
       78  J   VALUE 5000.
       78  M   VALUE 5.
       01  SETUP-REC.
           05  FL1       PIC X(04).
           05  FL2       PIC ZZZZZ.
           05  FL3       PIC 9(04).
           05  FL4       PIC 9(08) COMP.
           05  FL5       PIC 9(04) COMP-4.
           05  FL6       PIC Z,ZZZ.99.
           05  FL7       PIC S9(05) SIGN LEADING SEPARATE.
           05  FL8       PIC X(04).
           05  FL9 REDEFINES FL8 PIC 9(04).
           05  FLA.
               10  FLB OCCURS I TIMES.
                   15  FLC PIC X(02).
               10  FLD   PIC X(20).
           05  FLD1      PIC X(100).
           05  FLD2 OCCURS M TO J TIMES DEPENDING ON FL5.
               10  FILLER PIC X(01).
           05  FLD3      PIC X(3).
           05  FLD4      PIC X(4).
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -fcomplex-odo -t prog.lst -tsymbols prog.cob], [0], [], [])

AT_DATA([prog19.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         ENVIRONMENT DIVISION.
000005         CONFIGURATION SECTION.
000006         DATA             DIVISION.
000007         WORKING-STORAGE  SECTION.
000008         78  I   VALUE 20.
000009         78  J   VALUE 5000.
000010         78  M   VALUE 5.
000011         01  SETUP-REC.
000012             05  FL1       PIC X(04).
000013             05  FL2       PIC ZZZZZ.
000014             05  FL3       PIC 9(04).
000015             05  FL4       PIC 9(08) COMP.
000016             05  FL5       PIC 9(04) COMP-4.
000017             05  FL6       PIC Z,ZZZ.99.
000018             05  FL7       PIC S9(05) SIGN LEADING SEPARATE.
000019             05  FL8       PIC X(04).
000020             05  FL9 REDEFINES FL8 PIC 9(04).
000021             05  FLA.
000022                 10  FLB OCCURS I TIMES.
000023                     15  FLC PIC X(02).
000024                 10  FLD   PIC X(20).
000025             05  FLD1      PIC X(100).
000026             05  FLD2 OCCURS M TO J TIMES DEPENDING ON FL5.
000027                 10  FILLER PIC X(01).
000028             05  FLD3      PIC X(3).
000029             05  FLD4      PIC X(4).
000030         PROCEDURE        DIVISION.
000031             STOP RUN.
GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

05204 GROUP          01   SETUP-REC
00004 ALPHANUMERIC   05   FL1                            X(04)
00005 NUMERIC        05   FL2                            ZZZZZ
00004 NUMERIC        05   FL3                            9(04)
00004 NUMERIC        05   FL4                            9(08) COMP
00002 NUMERIC        05   FL5                            9(04) COMP
00008 NUMERIC        05   FL6                            Z,ZZZ.99
00006 NUMERIC        05   FL7                            S9(05)
00004 ALPHANUMERIC   05   FL8                            X(04)
00004 NUMERIC        05   FL9                            9(04), REDEFINES FL8
00060 GROUP          05   FLA
00040 GROUP          10   FLB                            OCCURS 20
00002 ALPHANUMERIC   15   FLC                            X(02)
00020 ALPHANUMERIC   10   FLD                            X(20)
00100 ALPHANUMERIC   05   FLD1                           X(100)
05000 GROUP          05   FLD2                           OCCURS 5 TO 5000
00001 ALPHANUMERIC   10   FILLER                         X(01)
00003 ALPHANUMERIC   05   FLD3                           X(3)
00004 ALPHANUMERIC   05   FLD4                           X(4)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog19.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Conditional compilation])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
       >>IF ACTIVATE DEFINED
           DISPLAY "NOTOK" NO ADVANCING
           END-DISPLAY
       >>ELIF ACTIVATE2 DEFINED
           DISPLAY "OK" NO ADVANCING
           END-DISPLAY
       >>ELSE
           DISPLAY "NOTOK" NO ADVANCING
           END-DISPLAY
       >>END-IF
           STOP RUN.
])
AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
      $IF ACTIVATE DEFINED
           DISPLAY "NOTOK" NO ADVANCING
           END-DISPLAY
      $ELIF ACTIVATE2 DEFINED
           DISPLAY "OK" NO ADVANCING
           END-DISPLAY
      $ELSE
           DISPLAY "NOTOK" NO ADVANCING
           END-DISPLAY
      $END
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -DACTIVATE2 -t prog.lst prog.cob], [0], [], [])

AT_DATA([prog16.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         PROCEDURE        DIVISION.
000007         >>IF ACTIVATE DEFINED
000008X            DISPLAY "NOTOK" NO ADVANCING
000009X            END-DISPLAY
000010         >>ELIF ACTIVATE2 DEFINED
000011             DISPLAY "OK" NO ADVANCING
000012             END-DISPLAY
000013         >>ELSE
000014X            DISPLAY "NOTOK" NO ADVANCING
000015X            END-DISPLAY
000016         >>END-IF
000017             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog16.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -DACTIVATE2 -t prog.lst prog2.cob], [0], [], [])

AT_DATA([prog16b.lst],
[GnuCOBOL V.R.P          prog2.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog2.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         PROCEDURE        DIVISION.
000007        $IF ACTIVATE DEFINED
000008X            DISPLAY "NOTOK" NO ADVANCING
000009X            END-DISPLAY
000010        $ELIF ACTIVATE2 DEFINED
000011             DISPLAY "OK" NO ADVANCING
000012             END-DISPLAY
000013        $ELSE
000014X            DISPLAY "NOTOK" NO ADVANCING
000015X            END-DISPLAY
000016        $END
000017             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog16b.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([File descriptions])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT OLD-VERSION  ASSIGN TO "SYSUT1"
                               ORGANIZATION LINE SEQUENTIAL.
           SELECT NEW-VERSION  ASSIGN TO "SYSUT2"
                               ORGANIZATION LINE SEQUENTIAL.
           SELECT PRT-VERSION  ASSIGN TO "SYSUT2"
                               ORGANIZATION LINE SEQUENTIAL.
           SELECT MODIFICATION ASSIGN TO "SYSIN1"
                               ORGANIZATION LINE SEQUENTIAL.
           SELECT COMMENTARY   ASSIGN TO "SYSOU1"
                               ORGANIZATION LINE SEQUENTIAL.
       DATA DIVISION.
       FILE SECTION.

       FD  OLD-VERSION
           LABEL RECORDS ARE STANDARD
           BLOCK CONTAINS 80 CHARACTERS
           DATA RECORD IS OLD-RECORD.

       01  OLD-RECORD.
           02 OLD-STATEMENT       PICTURE X(75).
           02 OLD-NUMBER          PICTURE X(5).

       FD  NEW-VERSION
           LABEL RECORDS ARE STANDARD
           BLOCK CONTAINS 80 CHARACTERS
           DATA RECORD IS NEW-RECORD.

       01  NEW-RECORD.
           02 NEW-STATEMENT       PICTURE X(75).
           02 NEW-NUMBER          PICTURE X(5).

       FD  MODIFICATION
           LABEL RECORDS ARE OMITTED
           BLOCK CONTAINS 80 CHARACTERS
           DATA RECORD IS UPDATE-ORDER.

       01  UPDATE-ORDER.
           02 INSERTION.
              03 COMMAND          PICTURE X(6).
                 88 ENDJOB        VALUE "ENDJOB".
                 88 ENDSET        VALUE "ENDSET".
                 88 REMOVE        VALUE "REMOVE".
                 88 ADDNEW        VALUE "INSERT".
                 88 CHANGE        VALUE "CHANGE".
                 88 DISPLY        VALUE "DISPLY".
              03 FILLER           PICTURE X.
              03 A-FIELD          PICTURE 9(5).
              03 A-ALPHA REDEFINES A-FIELD    PICTURE X(5).
                 88 A-BLANK       VALUE SPACES.
              03 FILLER           PICTURE X(4).
              03 B-FIELD          PICTURE 9(5).
              03 B-ALPHA REDEFINES B-FIELD    PICTURE X(5).
                 88 B-BLANK       VALUE SPACES.
              03 FILLER           PICTURE X(54).
           02 FILLER              PICTURE X(5).

       FD  COMMENTARY
           LABEL RECORDS ARE OMITTED
           BLOCK CONTAINS 82 CHARACTERS
           DATA RECORD IS COMMENT-LINE.

       01  COMMENT-LINE.
           02 FILLER              PICTURE X(82).

       WORKING-STORAGE  SECTION.

       01  HEADINGS-LINE.
           02 FILLER              PICTURE X(15) VALUE "EDITOR VERSION".
           02 FILLER              PICTURE X(20) VALUE "1.1 - 206/72".
           02 PHASE               PICTURE X(17) VALUE "UPDATING AS OF".
           02 MONTH-RUN           PICTURE XX.
           02 FILLER              PICTURE X VALUE "/".
           02 DAY-RUN             PICTURE XX.
           02 FILLER              PICTURE X VALUE "/".
           02 YEAR-RUN            PICTURE XX.
           02 FILLER              PICTURE X(8) VALUE SPACES.
           02 FILLER              PICTURE X(8) VALUE "  PAGE: ".
           02 PAGE-NUMBER         PICTURE 9(4) VALUE 0.

       01  COMMAND-LISTING.
           02 FILLER              PICTURE X(2) VALUE SPACES.
           02 COMMAND-IMAGE       PICTURE X(80).

       01  ACTIVITIES-LISTING.
           02 DISPOSITION         PICTURE X(2).
           02 ACTIVE-IMAGE        PICTURE X(80).

       01  UPSI-BYTE.
           02 UPSI-BIT OCCURS 8 TIMES  PICTURE X.

       01  MESSAGE-LOG.
           02 FILLER              PICTURE X(2) VALUE SPACES.
           02 MESSAGE-TEXT        PICTURE X(80).

       01  DISPLAY-MESSAGE.
           02 FILLER              PICTURE X(2) VALUE SPACES.
           02 DISPLAY-TEMP        PICTURE X(6).
           02 FILLER              PICTURE X(2) VALUE SPACES.
           02 DISPLAY-TEXT        PICTURE X(60).

       PROCEDURE DIVISION.
           OPEN INPUT OLD-VERSION, MODIFICATION,
                OUTPUT NEW-VERSION, COMMENTARY.
           CLOSE OLD-VERSION, NEW-VERSION, MODIFICATION, COMMENTARY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [1], [], [ignore])


AT_DATA([prog18.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog.
000004         ENVIRONMENT DIVISION.
000005         INPUT-OUTPUT SECTION.
000006         FILE-CONTROL.
000007             SELECT OLD-VERSION  ASSIGN TO "SYSUT1"
000008                                 ORGANIZATION LINE SEQUENTIAL.
000009             SELECT NEW-VERSION  ASSIGN TO "SYSUT2"
000010                                 ORGANIZATION LINE SEQUENTIAL.
000011             SELECT PRT-VERSION  ASSIGN TO "SYSUT2"
error: missing file description for FILE PRT-VERSION
000012                                 ORGANIZATION LINE SEQUENTIAL.
000013             SELECT MODIFICATION ASSIGN TO "SYSIN1"
000014                                 ORGANIZATION LINE SEQUENTIAL.
000015             SELECT COMMENTARY   ASSIGN TO "SYSOU1"
000016                                 ORGANIZATION LINE SEQUENTIAL.
000017         DATA DIVISION.
000018         FILE SECTION.
000019
000020         FD  OLD-VERSION
000021             LABEL RECORDS ARE STANDARD
warning: LABEL RECORDS is obsolete in GnuCOBOL
000022             BLOCK CONTAINS 80 CHARACTERS
000023             DATA RECORD IS OLD-RECORD.
warning: DATA RECORDS is obsolete in GnuCOBOL
000024
000025         01  OLD-RECORD.
000026             02 OLD-STATEMENT       PICTURE X(75).
000027             02 OLD-NUMBER          PICTURE X(5).
000028
000029         FD  NEW-VERSION
000030             LABEL RECORDS ARE STANDARD
warning: LABEL RECORDS is obsolete in GnuCOBOL
000031             BLOCK CONTAINS 80 CHARACTERS
000032             DATA RECORD IS NEW-RECORD.
warning: DATA RECORDS is obsolete in GnuCOBOL
000033
000034         01  NEW-RECORD.
000035             02 NEW-STATEMENT       PICTURE X(75).
000036             02 NEW-NUMBER          PICTURE X(5).
000037
000038         FD  MODIFICATION
000039             LABEL RECORDS ARE OMITTED
warning: LABEL RECORDS is obsolete in GnuCOBOL
000040             BLOCK CONTAINS 80 CHARACTERS
000041             DATA RECORD IS UPDATE-ORDER.
warning: DATA RECORDS is obsolete in GnuCOBOL
000042
000043         01  UPDATE-ORDER.
000044             02 INSERTION.
000045                03 COMMAND          PICTURE X(6).
000046                   88 ENDJOB        VALUE "ENDJOB".
000047                   88 ENDSET        VALUE "ENDSET".
000048                   88 REMOVE        VALUE "REMOVE".
000049                   88 ADDNEW        VALUE "INSERT".
000050                   88 CHANGE        VALUE "CHANGE".
000051                   88 DISPLY        VALUE "DISPLY".
000052                03 FILLER           PICTURE X.
000053                03 A-FIELD          PICTURE 9(5).
000054                03 A-ALPHA REDEFINES A-FIELD    PICTURE X(5).
000055                   88 A-BLANK       VALUE SPACES.
000056                03 FILLER           PICTURE X(4).
000057                03 B-FIELD          PICTURE 9(5).
000058                03 B-ALPHA REDEFINES B-FIELD    PICTURE X(5).
000059                   88 B-BLANK       VALUE SPACES.
000060                03 FILLER           PICTURE X(54).
000061             02 FILLER              PICTURE X(5).
000062
000063         FD  COMMENTARY
000064             LABEL RECORDS ARE OMITTED
warning: LABEL RECORDS is obsolete in GnuCOBOL
000065             BLOCK CONTAINS 82 CHARACTERS
000066             DATA RECORD IS COMMENT-LINE.
warning: DATA RECORDS is obsolete in GnuCOBOL
000067
000068         01  COMMENT-LINE.
000069             02 FILLER              PICTURE X(82).
000070
000071         WORKING-STORAGE  SECTION.
000072
000073         01  HEADINGS-LINE.
000074             02 FILLER              PICTURE X(15) VALUE "EDITOR VERSION".
000075             02 FILLER              PICTURE X(20) VALUE "1.1 - 206/72".
000076             02 PHASE               PICTURE X(17) VALUE "UPDATING AS OF".
000077             02 MONTH-RUN           PICTURE XX.
000078             02 FILLER              PICTURE X VALUE "/".
000079             02 DAY-RUN             PICTURE XX.
000080             02 FILLER              PICTURE X VALUE "/".
000081             02 YEAR-RUN            PICTURE XX.
000082             02 FILLER              PICTURE X(8) VALUE SPACES.
000083             02 FILLER              PICTURE X(8) VALUE "  PAGE: ".
000084             02 PAGE-NUMBER         PICTURE 9(4) VALUE 0.
000085
000086         01  COMMAND-LISTING.
000087             02 FILLER              PICTURE X(2) VALUE SPACES.
000088             02 COMMAND-IMAGE       PICTURE X(80).
000089
000090         01  ACTIVITIES-LISTING.
000091             02 DISPOSITION         PICTURE X(2).
000092             02 ACTIVE-IMAGE        PICTURE X(80).
000093
000094         01  UPSI-BYTE.
000095             02 UPSI-BIT OCCURS 8 TIMES  PICTURE X.
000096
000097         01  MESSAGE-LOG.
000098             02 FILLER              PICTURE X(2) VALUE SPACES.
000099             02 MESSAGE-TEXT        PICTURE X(80).
000100
000101         01  DISPLAY-MESSAGE.
000102             02 FILLER              PICTURE X(2) VALUE SPACES.
000103             02 DISPLAY-TEMP        PICTURE X(6).
000104             02 FILLER              PICTURE X(2) VALUE SPACES.
000105             02 DISPLAY-TEXT        PICTURE X(60).
000106
000107         PROCEDURE DIVISION.
000108             OPEN INPUT OLD-VERSION, MODIFICATION,
000109                  OUTPUT NEW-VERSION, COMMENTARY.
000110             CLOSE OLD-VERSION, NEW-VERSION, MODIFICATION, COMMENTARY.
000111             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

00080 FILE                OLD-VERSION
00080 GROUP          01   OLD-RECORD
00075 ALPHANUMERIC   02   OLD-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   OLD-NUMBER                     X(5)

00080 FILE                NEW-VERSION
00080 GROUP          01   NEW-RECORD
00075 ALPHANUMERIC   02   NEW-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   NEW-NUMBER                     X(5)

00032 FILE                PRT-VERSION

00080 FILE                MODIFICATION
00080 GROUP          01   UPDATE-ORDER
00075 GROUP          02   INSERTION
00006 ALPHANUMERIC   03   COMMAND                        X(6)
      CONDITIONAL    88   ENDJOB
      CONDITIONAL    88   ENDSET
      CONDITIONAL    88   REMOVE
      CONDITIONAL    88   ADDNEW
      CONDITIONAL    88   CHANGE
      CONDITIONAL    88   DISPLY
00001 ALPHANUMERIC   03   FILLER                         X
00005 NUMERIC        03   A-FIELD                        9(5)
00005 ALPHANUMERIC   03   A-ALPHA                        X(5), REDEFINES A-FIELD
      CONDITIONAL    88   A-BLANK
00004 ALPHANUMERIC   03   FILLER                         X(4)
00005 NUMERIC        03   B-FIELD                        9(5)
00005 ALPHANUMERIC   03   B-ALPHA                        X(5), REDEFINES B-FIELD
      CONDITIONAL    88   B-BLANK
00054 ALPHANUMERIC   03   FILLER                         X(54)
00005 ALPHANUMERIC   02   FILLER                         X(5)

00082 FILE                COMMENTARY
00082 GROUP          01   COMMENT-LINE
00082 ALPHANUMERIC   02   FILLER                         X(82)

      WORKING-STORAGE SECTION

00080 GROUP          01   HEADINGS-LINE
00015 ALPHANUMERIC   02   FILLER                         X(15)
00020 ALPHANUMERIC   02   FILLER                         X(20)
00017 ALPHANUMERIC   02   PHASE                          X(17)
00002 ALPHANUMERIC   02   MONTH-RUN                      XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   DAY-RUN                        XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   YEAR-RUN                       XX
00008 ALPHANUMERIC   02   FILLER                         X(8)
00008 ALPHANUMERIC   02   FILLER                         X(8)
00004 NUMERIC        02   PAGE-NUMBER                    9(4)

00082 GROUP          01   COMMAND-LISTING
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   COMMAND-IMAGE                  X(80)

00082 GROUP          01   ACTIVITIES-LISTING
00002 ALPHANUMERIC   02   DISPOSITION                    X(2)
00080 ALPHANUMERIC   02   ACTIVE-IMAGE                   X(80)

00008 GROUP          01   UPSI-BYTE
00001 ALPHANUMERIC   02   UPSI-BIT                       X, OCCURS 8

00082 GROUP          01   MESSAGE-LOG
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   MESSAGE-TEXT                   X(80)

00070 GROUP          01   DISPLAY-MESSAGE
00002 ALPHANUMERIC   02   FILLER                         X(2)
00006 ALPHANUMERIC   02   DISPLAY-TEMP                   X(6)
00002 ALPHANUMERIC   02   FILLER                         X(2)
00060 ALPHANUMERIC   02   DISPLAY-TEXT                   X(60)



Error/Warning summary:

prog.cob:11: error: missing file description for FILE PRT-VERSION
prog.cob:21: warning: LABEL RECORDS is obsolete in GnuCOBOL
prog.cob:23: warning: DATA RECORDS is obsolete in GnuCOBOL
prog.cob:30: warning: LABEL RECORDS is obsolete in GnuCOBOL
prog.cob:32: warning: DATA RECORDS is obsolete in GnuCOBOL
prog.cob:39: warning: LABEL RECORDS is obsolete in GnuCOBOL
prog.cob:41: warning: DATA RECORDS is obsolete in GnuCOBOL
prog.cob:64: warning: LABEL RECORDS is obsolete in GnuCOBOL
prog.cob:66: warning: DATA RECORDS is obsolete in GnuCOBOL

8 warnings in compilation group
1 error in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog18.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Invalid PICTURE strings])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  empty-pic PIC.
       01  too-long-pic PIC XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.
       01  too-long-pic2 PIC XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.
       01  multiple-symbols.
           03  PIC 9CRCR.
           03  PIC 9DBDB.
           03  PIC SS99S.
           03  PIC 99..9.
           03  PIC 99VV9.
           03  PIC +$99+.
           03  PIC $+99$-.
       01  non-symbols.
           03  PIC 9K.
           03  PIC 999C.
           03  PIC 999D.
       01  too-many-digits PIC 9(50).
       01  too-long-number-in-parens PIC 9(11111111111111).
       01  nested-parens PIC 9((100)).
       01  unbalanced-parens PIC 9(.
       01  multiple-pairs-of-parens PIC 9(5)(3).
       01  no-digit-in-parens PIC 9().
       01  mutually-exclusive-symbols.
           03  PIC P(3)9.9.
           03  PIC 9V.9.
           03  PIC Z*.
           03  PIC +(5)--.
           03  PIC $(4)Z(9).
           03  PIC $$B*(4).
           03  PIC NX.
           03  PIC AN.
           03  PIC AZ(3).
           03  PIC 99.99XXXXX.
           03  PIC SA.
           03  PIC $$$B+++B---.
           03  PIC +++9+.
           03  PIC +9(5)CR.
           03  PIC -9(5)DB.
       01 non-rightmost-leftmost-symbols.
           03  PIC BBB+BB99.
           03  PIC 99-B.
           03  PIC 9CRB.
           03  PIC DB9(5).
           03  PIC 99$$$.
           03  PIC 99$B.
           03  PIC 0$99.
           03  PIC PPPVP9.
       01  missing-symbols.
           03  PIC B(5).
           03  PIC +.
           03  PIC $.

       01  str-constant CONSTANT "hello".
       01  float-constant CONSTANT 1.0.
       01  signed-constant CONSTANT -1.
       01  invalid-constant.
           03  PIC X(str-constant).
           03  PIC X(float-constant).
           03  PIC X(signed-constant).
           03  PIC X(unseen-constant).

       01  integer-constant CONSTANT 5.
       01  valid-pics.
           03  PIC VP9B.
           03  PIC B9P(3).
           03  PIC B$$$.
           03  PIC 0000+B0+++0B,+.
           03  PIC +(5)P(3).
           03  PIC ++.++.
           03  PIC $(integer-constant).
           03  PIC $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
      -(integer-constant).   *> CHECKME: should this be really valid?


       01  PC-COLOR-BACKGROUND-TABLE.
           05  BIT-BACKGROUND-BLACK      PIC 1(8) BIT VALUE B"00000000".
           05  BIT-BACKGROUND-BLUE       PIC 1(8) BIT VALUE B"00010000".
           05  BIT-BACKGROUND-GREEN      PIC 1(8) BIT VALUE B"00100000".
           05  BIT-BACKGROUND-CYAN       PIC 1(8) BIT VALUE B"00110000".
           05  BIT-BACKGROUND-RED        PIC 1(8) BIT VALUE B"01000000".
           05  BIT-BACKGROUND-MAGENTA    PIC 1(8) BIT VALUE B"01010000".
           05  BIT-BACKGROUND-BROWN      PIC 1(8) BIT VALUE B"01100000".
           05  BIT-BACKGROUND-LIGHT-GRAY PIC 1(8) BIT VALUE B"01110000".
       01  FILLER REDEFINES PC-COLOR-BACKGROUND-TABLE.
           05  COLOR-BACKGROUND
               OCCURS 8 TIMES            PIC 1(8) BIT.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols -Wno-pending -Wno-unfinished -fword-continuation=ok prog.cob], [1], [], [ignore])

AT_DATA([prog19.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog.
000004
000005         DATA DIVISION.
000006         WORKING-STORAGE SECTION.
000007         01  empty-pic PIC.
error: missing PICTURE string
000008         01  too-long-pic PIC XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
000009        -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.
000010         01  too-long-pic2 PIC XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
error: PICTURE string may not contain more than 255 characters; contains 301
     + characters
000011        -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
000012        -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
000013        -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
000014        -XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.
000015         01  multiple-symbols.
000016             03  PIC 9CRCR.
error: CR or DB may only occur once in a PICTURE string
000017             03  PIC 9DBDB.
error: CR or DB may only occur once in a PICTURE string
000018             03  PIC SS99S.
error: S may only occur once in a PICTURE string
error: S must be at start of PICTURE string
000019             03  PIC 99..9.
error: . may only occur once in a PICTURE string
000020             03  PIC 99VV9.
error: V may only occur once in a PICTURE string
000021             03  PIC +$99+.
error: a trailing +/- sign cannot follow a leading +/- sign
000022             03  PIC $+99$-.
error: a leading +/- sign cannot follow a leading currency symbol
error: a trailing currency symbol cannot follow a leading currency symbol
error: a trailing +/- sign cannot follow a leading +/- sign
000023         01  non-symbols.
000024             03  PIC 9K.
error: invalid PICTURE character 'K'
000025             03  PIC 999C.
error: C must be followed by R
000026             03  PIC 999D.
error: D must be followed by B
000027         01  too-many-digits PIC 9(50).
error: numeric field cannot be larger than 38 digits
000028         01  too-long-number-in-parens PIC 9(11111111111111).
error: only up to 10 significant digits are permitted within parentheses
000029         01  nested-parens PIC 9((100)).
error: parentheses must be preceded by a picture symbol
000030         01  unbalanced-parens PIC 9(.
error: unbalanced parentheses
000031         01  multiple-pairs-of-parens PIC 9(5)(3).
error: parentheses must be preceded by a picture symbol
000032         01  no-digit-in-parens PIC 9().
error: parentheses must contain an unsigned integer
000033         01  mutually-exclusive-symbols.
000034             03  PIC P(3)9.9.
error: . cannot follow a P which is after the decimal point
000035             03  PIC 9V.9.
error: . cannot follow V
000036             03  PIC Z*.
error: cannot have both Z and * in PICTURE string
000037             03  PIC +(5)--.
error: a trailing +/- sign cannot follow a floating +/- string which is before
     + the decimal point
error: a trailing +/- sign may only occur once in a PICTURE string
000038             03  PIC $(4)Z(9).
error: a Z or * which is before the decimal point cannot follow a floating
     + currency symbol string which is before the decimal point
000039             03  PIC $$B*(4).
error: a Z or * which is before the decimal point cannot follow a floating
     + currency symbol string which is before the decimal point
000040             03  PIC NX.
error: A or X cannot follow N
000041             03  PIC AN.
error: N cannot follow A or X
000042             03  PIC AZ(3).
error: a Z or * which is before the decimal point cannot follow A or X
000043             03  PIC 99.99XXXXX.
error: A or X cannot follow .
000044             03  PIC SA.
error: A or X cannot follow S
000045             03  PIC $$$B+++B---.
error: a leading +/- sign cannot follow B, 0 or /
error: a leading +/- sign cannot follow a floating currency symbol string
     + which is before the decimal point
error: a leading +/- sign may only occur once in a PICTURE string
error: a trailing +/- sign cannot follow a leading +/- sign
error: a trailing +/- sign may only occur once in a PICTURE string
000046             03  PIC +++9+.
error: a trailing +/- sign cannot follow a floating +/- string which is before
     + the decimal point
000047             03  PIC +9(5)CR.
error: CR or DB cannot follow a leading +/- sign
000048             03  PIC -9(5)DB.
error: CR or DB cannot follow a leading +/- sign
000049         01 non-rightmost-leftmost-symbols.
000050             03  PIC BBB+BB99.
error: a leading +/- sign cannot follow B, 0 or /
000051             03  PIC 99-B.
error: a leading +/- sign cannot follow 9
000052             03  PIC 9CRB.
error: B, 0 or / cannot follow CR or DB
000053             03  PIC DB9(5).
error: 9 cannot follow CR or DB
000054             03  PIC 99$$$.
error: a floating currency symbol string which is before the decimal point
     + cannot follow 9
000055             03  PIC 99$B.
error: a leading currency symbol cannot follow 9
000056             03  PIC 0$99.
error: a leading currency symbol cannot follow B, 0 or /
000057             03  PIC PPPVP9.
error: P must be at start or end of PICTURE string
error: V cannot follow a P which is after the decimal point
000058         01  missing-symbols.
000059             03  PIC B(5).
error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9
     + and *; or at least two of the set +, - and the currency symbol
000060             03  PIC +.
error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9
     + and *; or at least two of the set +, - and the currency symbol
000061             03  PIC $.
error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9
     + and *; or at least two of the set +, - and the currency symbol
000062
000063         01  str-constant CONSTANT "hello".
000064         01  float-constant CONSTANT 1.0.
000065         01  signed-constant CONSTANT -1.
000066         01  invalid-constant.
000067             03  PIC X(str-constant).
error: 'STR-CONSTANT' is not a numeric literal
000068             03  PIC X(float-constant).
error: 'FLOAT-CONSTANT' is not an integer
000069             03  PIC X(signed-constant).
error: 'SIGNED-CONSTANT' is not unsigned
000070             03  PIC X(unseen-constant).
error: 'UNSEEN-CONSTANT' is not defined
000071
000072         01  integer-constant CONSTANT 5.
000073         01  valid-pics.
000074             03  PIC VP9B.
000075             03  PIC B9P(3).
000076             03  PIC B$$$.
000077             03  PIC 0000+B0+++0B,+.
000078             03  PIC +(5)P(3).
000079             03  PIC ++.++.
000080             03  PIC $(integer-constant).
000081             03  PIC $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
warning: uncommon parentheses
000082        -(integer-constant).   *> CHECKME: should this be really valid?
000083
000084
000085         01  PC-COLOR-BACKGROUND-TABLE.
000086             05  BIT-BACKGROUND-BLACK      PIC 1(8) BIT VALUE B"00000000".
000087             05  BIT-BACKGROUND-BLUE       PIC 1(8) BIT VALUE B"00010000".
000088             05  BIT-BACKGROUND-GREEN      PIC 1(8) BIT VALUE B"00100000".
000089             05  BIT-BACKGROUND-CYAN       PIC 1(8) BIT VALUE B"00110000".
000090             05  BIT-BACKGROUND-RED        PIC 1(8) BIT VALUE B"01000000".
000091             05  BIT-BACKGROUND-MAGENTA    PIC 1(8) BIT VALUE B"01010000".
000092             05  BIT-BACKGROUND-BROWN      PIC 1(8) BIT VALUE B"01100000".
000093             05  BIT-BACKGROUND-LIGHT-GRAY PIC 1(8) BIT VALUE B"01110000".
000094         01  FILLER REDEFINES PC-COLOR-BACKGROUND-TABLE.
000095             05  COLOR-BACKGROUND
000096                 OCCURS 8 TIMES            PIC 1(8) BIT.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00000 ALPHANUMERIC   01   empty-pic                      INVALID

00077 ALPHANUMERIC   01   too-long-pic                   XXXXXXXXXXXXXXXXXXXXXXX

00000 ALPHANUMERIC   01   too-long-pic2                  INVALID

00000 GROUP          01   multiple-symbols
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00000 GROUP          01   non-symbols
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00050 NUMERIC        01   too-many-digits                9(50)

00000 ALPHANUMERIC   01   too-long-number-in-parens      INVALID

00000 ALPHANUMERIC   01   nested-parens                  INVALID

00000 ALPHANUMERIC   01   unbalanced-parens              INVALID

00000 ALPHANUMERIC   01   multiple-pairs-of-parens       INVALID

00000 ALPHANUMERIC   01   no-digit-in-parens             INVALID

00000 GROUP          01   mutually-exclusive-symbols
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00000 GROUP          01   non-rightmost-leftmost-symbols
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00000 GROUP          01   missing-symbols
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00000 GROUP          01   invalid-constant
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID
00000 ALPHANUMERIC   03   FILLER                         INVALID

00086 GROUP          01   valid-pics
00002 NUMERIC        03   FILLER                         VP9B
00002 NUMERIC        03   FILLER                         B9P(3)
00004 NUMERIC        03   FILLER                         B$$$
00014 NUMERIC        03   FILLER                         0000+B0+++0B,+
00005 NUMERIC        03   FILLER                         +(5)P(3)
00005 NUMERIC        03   FILLER                         ++.++
00005 NUMERIC        03   FILLER                         $(INTEGER-CONSTANT)
00049 NUMERIC        03   FILLER                         $$$$$$$$$$$$$$$$$$$$$$$

00008 GROUP          01   PC-COLOR-BACKGROUND-TABLE
00001 NUMERIC        05   BIT-BACKGROUND-BLACK           1(8)
00001 NUMERIC        05   BIT-BACKGROUND-BLUE            1(8)
00001 NUMERIC        05   BIT-BACKGROUND-GREEN           1(8)
00001 NUMERIC        05   BIT-BACKGROUND-CYAN            1(8)
00001 NUMERIC        05   BIT-BACKGROUND-RED             1(8)
00001 NUMERIC        05   BIT-BACKGROUND-MAGENTA         1(8)
00001 NUMERIC        05   BIT-BACKGROUND-BROWN           1(8)
00001 NUMERIC        05   BIT-BACKGROUND-LIGHT-GRAY      1(8)

00008 GROUP          01   FILLER, REDEFINES PC-COLOR-BACKGROUND-TABLE
00001 BOOLEAN        05   COLOR-BACKGROUND               1(8), OCCURS 8



Error/Warning summary:

prog.cob:7: error: missing PICTURE string
prog.cob:10: error: PICTURE string may not contain more than 255 characters; contains 301 characters
prog.cob:16: error: CR or DB may only occur once in a PICTURE string
prog.cob:17: error: CR or DB may only occur once in a PICTURE string
prog.cob:18: error: S may only occur once in a PICTURE string
prog.cob:18: error: S must be at start of PICTURE string
prog.cob:19: error: . may only occur once in a PICTURE string
prog.cob:20: error: V may only occur once in a PICTURE string
prog.cob:21: error: a trailing +/- sign cannot follow a leading +/- sign
prog.cob:22: error: a leading +/- sign cannot follow a leading currency symbol
prog.cob:22: error: a trailing currency symbol cannot follow a leading currency symbol
prog.cob:22: error: a trailing +/- sign cannot follow a leading +/- sign
prog.cob:24: error: invalid PICTURE character 'K'
prog.cob:25: error: C must be followed by R
prog.cob:26: error: D must be followed by B
prog.cob:27: error: numeric field cannot be larger than 38 digits
prog.cob:28: error: only up to 10 significant digits are permitted within parentheses
prog.cob:29: error: parentheses must be preceded by a picture symbol
prog.cob:30: error: unbalanced parentheses
prog.cob:31: error: parentheses must be preceded by a picture symbol
prog.cob:32: error: parentheses must contain an unsigned integer
prog.cob:34: error: . cannot follow a P which is after the decimal point
prog.cob:35: error: . cannot follow V
prog.cob:36: error: cannot have both Z and * in PICTURE string
prog.cob:37: error: a trailing +/- sign cannot follow a floating +/- string which is before the decimal point
prog.cob:37: error: a trailing +/- sign may only occur once in a PICTURE string
prog.cob:38: error: a Z or * which is before the decimal point cannot follow a floating currency symbol string which is before the decimal point
prog.cob:39: error: a Z or * which is before the decimal point cannot follow a floating currency symbol string which is before the decimal point
prog.cob:40: error: A or X cannot follow N
prog.cob:41: error: N cannot follow A or X
prog.cob:42: error: a Z or * which is before the decimal point cannot follow A or X
prog.cob:43: error: A or X cannot follow .
prog.cob:44: error: A or X cannot follow S
prog.cob:45: error: a leading +/- sign cannot follow B, 0 or /
prog.cob:45: error: a leading +/- sign cannot follow a floating currency symbol string which is before the decimal point
prog.cob:45: error: a leading +/- sign may only occur once in a PICTURE string
prog.cob:45: error: a trailing +/- sign cannot follow a leading +/- sign
prog.cob:45: error: a trailing +/- sign may only occur once in a PICTURE string
prog.cob:46: error: a trailing +/- sign cannot follow a floating +/- string which is before the decimal point
prog.cob:47: error: CR or DB cannot follow a leading +/- sign
prog.cob:48: error: CR or DB cannot follow a leading +/- sign
prog.cob:50: error: a leading +/- sign cannot follow B, 0 or /
prog.cob:51: error: a leading +/- sign cannot follow 9
prog.cob:52: error: B, 0 or / cannot follow CR or DB
prog.cob:53: error: 9 cannot follow CR or DB
prog.cob:54: error: a floating currency symbol string which is before the decimal point cannot follow 9
prog.cob:55: error: a leading currency symbol cannot follow 9
prog.cob:56: error: a leading currency symbol cannot follow B, 0 or /
prog.cob:57: error: P must be at start or end of PICTURE string
prog.cob:57: error: V cannot follow a P which is after the decimal point
prog.cob:59: error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9 and *; or at least two of the set +, - and the currency symbol
prog.cob:60: error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9 and *; or at least two of the set +, - and the currency symbol
prog.cob:61: error: PICTURE string must contain at least one of the set A, N, X, Z, 1, 9 and *; or at least two of the set +, - and the currency symbol
prog.cob:67: error: 'STR-CONSTANT' is not a numeric literal
prog.cob:68: error: 'FLOAT-CONSTANT' is not an integer
prog.cob:69: error: 'SIGNED-CONSTANT' is not unsigned
prog.cob:70: error: 'UNSEEN-CONSTANT' is not defined
prog.cob:81: warning: uncommon parentheses

1 warning in compilation group
57 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog19.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Variable format])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob],
[000001 $SET SOURCEFORMAT "VARIABLE"
000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. prog.
000030* blah blah blah
000040 PROCEDURE DIVISION.
000050                                                                  DISPLAY "Hello!"
000060     .
000070 END PROGRAM prog.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog20.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001  000001 $SET SOURCEFORMAT "VARIABLE"
000002  000010 IDENTIFICATION DIVISION.
000003  000020 PROGRAM-ID. prog.
000004  000030* blah blah blah
000005  000040 PROCEDURE DIVISION.
000006  000050
000006+ DISPLAY "Hello!"
000007  000060     .
000008  000070 END PROGRAM prog.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog20.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([MFCOMMENT])
AT_KEYWORDS([listing])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
      *    DISPLAY 'COMMENTASTERISK'
      /    DISPLAY 'COMMENTSLASH'
*          DISPLAY 'MFCOMMENTASTERISK'
/          DISPLAY 'MFCOMMENTSLASH'
           STOP RUN.
])
AT_DATA([prog-nomfcomment.lst.expected],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         PROCEDURE        DIVISION.
000005        *    DISPLAY 'COMMENTASTERISK'

LINE    PG/LN  A...B............................................................

000006        /    DISPLAY 'COMMENTSLASH'
000007  *          DISPLAY 'MFCOMMENTASTERISK'
000008  /          DISPLAY 'MFCOMMENTSLASH'
000009             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])
AT_DATA([prog-mfcomment.lst.expected],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         PROCEDURE        DIVISION.
000005        *    DISPLAY 'COMMENTASTERISK'

LINE    PG/LN  A...B............................................................

000006        /    DISPLAY 'COMMENTSLASH'
000008  /          DISPLAY 'MFCOMMENTSLASH'
000009             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$COMPILE_ONLY -t prog-nomfcomment.lst -tlines=0             prog.cob], [0], [], [])
AT_CHECK([$COMPILE_ONLY -t   prog-mfcomment.lst -tlines=0 -fmfcomment prog.cob], [0], [], [])
AT_CHECK([$UNIFY_LISTING prog-nomfcomment.lst prog-nomfcomment.lis once], [0], [], [])
AT_CHECK([$UNIFY_LISTING   prog-mfcomment.lst   prog-mfcomment.lis once], [0], [], [])
AT_CHECK([diff prog-nomfcomment.lst.expected prog-nomfcomment.lis], [0], [], [])
AT_CHECK([diff   prog-mfcomment.lst.expected   prog-mfcomment.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([LISTING directive])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([copy.inc], [
       >>LISTING OFF
       01 TEST1-VAR PIC X(2) VALUE "OK".
       01 TEST2-VAR PIC X(2) VALUE "OK".
       01 TEST3-VAR PIC X(2) VALUE "OK".
       01 TEST4-VAR PIC X(2) VALUE "OK".
       >>LISTING ON
       01 TEST5-VAR PIC X(2) VALUE "OK".
       01 TEST6-VAR PIC X(2) VALUE "OK".
       01 TEST7-VAR PIC X(2) VALUE "OK".
       01 TEST8-VAR PIC X(2) VALUE "OK".
])

AT_DATA([copy2.inc], [       >> LISTING OFF
       01 TEST9-VAR PIC X(2) VALUE "OK".
       >>LISTING
       01 TESTA-VAR PIC X(2) VALUE "OK".
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       COPY "copy.inc".
       COPY "copy2.inc".
       PROCEDURE        DIVISION.
           DISPLAY TEST1-VAR NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 -tsymbols prog.cob], [0], [], [])

AT_DATA([prog17.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
000006         COPY "copy.inc".
000001C
000002C        >>LISTING OFF
000007C        >>LISTING ON
000008C        01 TEST5-VAR PIC X(2) VALUE "OK".
000009C        01 TEST6-VAR PIC X(2) VALUE "OK".
000010C        01 TEST7-VAR PIC X(2) VALUE "OK".
000011C        01 TEST8-VAR PIC X(2) VALUE "OK".
000007         COPY "copy2.inc".
000001C        >> LISTING OFF
000003C        >>LISTING
000004C        01 TESTA-VAR PIC X(2) VALUE "OK".
000008         PROCEDURE        DIVISION.
000009             DISPLAY TEST1-VAR NO ADVANCING
000010             END-DISPLAY.
000011             STOP RUN.

SIZE  TYPE           LVL  NAME                           PICTURE

      WORKING-STORAGE SECTION

00002 ALPHANUMERIC   01   TEST1-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST2-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST3-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST4-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST5-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST6-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST7-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST8-VAR                      X(2)

00002 ALPHANUMERIC   01   TEST9-VAR                      X(2)

00002 ALPHANUMERIC   01   TESTA-VAR                      X(2)


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog17.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Listing-directive statements])
AT_KEYWORDS([listing directive EJECT SKIP1 SKIP2 SKIP3 TITLE])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [           TITLE "GnuCOBOL lists IBM"
       IDENTIFICATION   DIVISION.
           SKIP1
       PROGRAM-ID.      prog.
           SKIP2
       DATA             DIVISION.
           SKIP3
       WORKING-STORAGE  SECTION.
       01  TITLE-01          PIC X(2).
       01  TITLE-02          PIC X(2).
           TITLE "here goes the code"
       PROCEDURE        DIVISION.
       EJECT
           MOVE SPACE TO TITLE-01
                         TITLE-02.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -std=ibm prog.cob], [0], [], [])

AT_DATA([expect.lst],
[GnuCOBOL lists IBM      prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000002         IDENTIFICATION   DIVISION.


000004         PROGRAM-ID.      prog.



000006         DATA             DIVISION.




000008         WORKING-STORAGE  SECTION.
000009         01  TITLE-01          PIC X(2).
000010         01  TITLE-02          PIC X(2).
here goes the code      prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    PG/LN  A...B............................................................

000012         PROCEDURE        DIVISION.
here goes the code      prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0003

LINE    PG/LN  A...B............................................................

000014             MOVE SPACE TO TITLE-01
000015                           TITLE-02.
000016             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff expect.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Eject page])
AT_KEYWORDS([listing directive])

AT_CAPTURE_FILE([prog.lis])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
      /
       PROCEDURE        DIVISION.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst prog.cob], [0], [], [])

AT_DATA([prog7.lst],
[GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         DATA             DIVISION.
000005         WORKING-STORAGE  SECTION.
GnuCOBOL V.R.P          prog.cob             DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    PG/LN  A...B............................................................

000006        /
000007         PROCEDURE        DIVISION.
000008             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog7.lst prog.lis], [0], [], [])

AT_DATA([prog2.cob], [
  IDENTIFICATION   DIVISION.
  PROGRAM-ID.      prog2.
  DATA             DIVISION.
  WORKING-STORAGE  SECTION.
>>PAGE
  PROCEDURE        DIVISION.
  STOP RUN.
])


AT_CHECK([$COMPILE_ONLY -t prog.lst -free prog2.cob], [0], [], [])

AT_DATA([prog8.lst],
[GnuCOBOL V.R.P          prog2.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    .....................SOURCE.............................................

000001
000002    IDENTIFICATION   DIVISION.
000003    PROGRAM-ID.      prog2.
000004    DATA             DIVISION.
000005    WORKING-STORAGE  SECTION.
GnuCOBOL V.R.P          prog2.cob            DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    .....................SOURCE.............................................

000006  >>PAGE
000007    PROCEDURE        DIVISION.
000008    STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog8.lst prog.lis], [0], [], [])

AT_DATA([prog3.cob], [
       IDENTIFICATION   DIVISION.

       PROGRAM-ID.      prog3.


       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 WS-VAR PIC X(2).
      /
       77 WS-VA2 PIC X(2).


       LOCAL-STORAGE  SECTION.
       77 LS-VAR PIC 9(2).


       PROCEDURE        DIVISION.

           DISPLAY WS-VAR
           MOVE 99 TO LS-VAR

           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst prog3.cob], [0], [], [])

AT_DATA([prog9.lst],
[GnuCOBOL V.R.P          prog3.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003
000004         PROGRAM-ID.      prog3.
000005
000006
000007         DATA             DIVISION.
000008         WORKING-STORAGE  SECTION.
000009         77 WS-VAR PIC X(2).
GnuCOBOL V.R.P          prog3.cob            DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    PG/LN  A...B............................................................

000010        /
000011         77 WS-VA2 PIC X(2).
000012
000013
000014         LOCAL-STORAGE  SECTION.
000015         77 LS-VAR PIC 9(2).
000016
000017
000018         PROCEDURE        DIVISION.
000019
000020             DISPLAY WS-VAR
000021             MOVE 99 TO LS-VAR
000022
000023             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog9.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=20 prog3.cob], [0], [], [])

AT_DATA([prog10.lst],
[GnuCOBOL V.R.P          prog3.cob            DDD MMM dd HH:MM:SS YYYY  Page 0001

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003
000004         PROGRAM-ID.      prog3.
000005
000006
000007         DATA             DIVISION.
000008         WORKING-STORAGE  SECTION.
000009         77 WS-VAR PIC X(2).
GnuCOBOL V.R.P          prog3.cob            DDD MMM dd HH:MM:SS YYYY  Page 0002

LINE    PG/LN  A...B............................................................

000010        /
000011         77 WS-VA2 PIC X(2).
000012
000013
000014         LOCAL-STORAGE  SECTION.
000015         77 LS-VAR PIC 9(2).
000016
000017
000018         PROCEDURE        DIVISION.
000019
000020             DISPLAY WS-VAR
000021             MOVE 99 TO LS-VAR
000022
000023             STOP RUN.


0 warnings in compilation group
GnuCOBOL V.R.P          prog3.cob            DDD MMM dd HH:MM:SS YYYY  Page 0003

0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis], [0], [], [])
AT_CHECK([diff prog10.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Cross reference])
AT_KEYWORDS([listing xref])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([EDITOR.cob], [
       IDENTIFICATION DIVISION.                                         EDIT0001
       PROGRAM-ID.                                                      EDIT0002
           EDITOR.                                                      EDIT0003
                                                                        EDIT0008
      *NOTE.                                                            EDIT0009
      *    THIS VERSION OF EDITOR 1 COMPRISES AN ENTIRE RE_WRITE        EDIT0010
      *    OF THE BASIC EDITOR WITH ONLY ONE CHANGE IN THE COMMAND      EDIT0011
      *    STRUCTURE, THAT BEING THE ADDITION OF A "CHANGE" COMMAND     EDIT0012
      *    TO SERVE IN PLACE OF THE INSERT-DELETE COMBINATION WHICH     EDIT0013
      *    WAS REQUIRED IN PREVIOUS VERSIONS. RECORD NUMBER FIELDS      EDIT0014
      *    HAVE ALSO BEEN REDUCED FROM 5 DIGITS TO 4.                   EDIT0015
      *    CHANGE 1.                                                    EDIT0016
      *       MODIFY TO RUN ON TI-990.                                  EDIT0017
      *    CHANGE 2.                                                    EDIT0018
      *       MODIFY TO RUN ON GNUCOBOL.                                EDIT0019
                                                                        EDIT0020
       ENVIRONMENT DIVISION.                                            EDIT0021
       CONFIGURATION SECTION.                                           EDIT0022
       SOURCE-COMPUTER.                                                 EDIT0023
           IBM-360.                                                     EDIT0024
       OBJECT-COMPUTER.                                                 EDIT0025
           IBM-360.                                                     EDIT0026
       INPUT-OUTPUT SECTION.                                            EDIT0027
       FILE-CONTROL.                                                    EDIT0028
           SELECT OLD-VERSION  ASSIGN TO "SYSUT1"                       EDIT0029
                               ORGANIZATION LINE SEQUENTIAL.            EDIT0030
           SELECT NEW-VERSION  ASSIGN TO "SYSUT2"                       EDIT0031
                               ORGANIZATION LINE SEQUENTIAL.            EDIT0032
           SELECT PRT-VERSION  ASSIGN TO "SYSUT2"                       EDIT0033
                               ORGANIZATION LINE SEQUENTIAL.            EDIT0034
           SELECT MODIFICATION ASSIGN TO "SYSIN1"                       EDIT0035
                               ORGANIZATION LINE SEQUENTIAL.            EDIT0036
           SELECT COMMENTARY   ASSIGN TO "SYSOU1"                       EDIT0037
                               ORGANIZATION LINE SEQUENTIAL.            EDIT0038
                                                                        EDIT0039
       DATA DIVISION.                                                   EDIT0040
                                                                        EDIT0041
       FILE SECTION.                                                    EDIT0042
                                                                        EDIT0043
       FD  OLD-VERSION                                                  EDIT0044
           LABEL RECORDS ARE STANDARD                                   EDIT0045
           BLOCK CONTAINS 80 CHARACTERS                                 EDIT0046
           DATA RECORD IS OLD-RECORD.                                   EDIT0047
                                                                        EDIT0048
       01  OLD-RECORD.                                                  EDIT0049
           02 OLD-STATEMENT       PICTURE X(75).                        EDIT0050
           02 OLD-NUMBER          PICTURE X(5).                         EDIT0051
                                                                        EDIT0052
       FD  NEW-VERSION                                                  EDIT0053
           LABEL RECORDS ARE STANDARD                                   EDIT0054
           BLOCK CONTAINS 80 CHARACTERS                                 EDIT0055
           DATA RECORD IS NEW-RECORD.                                   EDIT0056
                                                                        EDIT0057
       01  NEW-RECORD.                                                  EDIT0058
           02 NEW-STATEMENT       PICTURE X(75).                        EDIT0059
           02 NEW-NUMBER          PICTURE X(5).                         EDIT0060
                                                                        EDIT0061
       FD  MODIFICATION                                                 EDIT0062
           LABEL RECORDS ARE OMITTED                                    EDIT0063
           BLOCK CONTAINS 80 CHARACTERS                                 EDIT0064
           DATA RECORD IS UPDATE-ORDER.                                 EDIT0065
                                                                        EDIT0066
       01  UPDATE-ORDER.                                                EDIT0067
           02 INSERTION.                                                EDIT0068
              03 COMMAND          PICTURE X(6).                         EDIT0069
                 88 ENDJOB        VALUE "ENDJOB".                       EDIT0070
                 88 ENDSET        VALUE "ENDSET".                       EDIT0071
                 88 REMOVE        VALUE "REMOVE".                       EDIT0072
                 88 ADDNEW        VALUE "INSERT".                       EDIT0073
                 88 CHANGE        VALUE "CHANGE".                       EDIT0074
                 88 DISPLY        VALUE "DISPLY".                       EDIT0075
              03 FILLER           PICTURE X.                            EDIT0076
              03 A-FIELD          PICTURE 9(5).                         EDIT0077
              03 A-ALPHA REDEFINES A-FIELD    PICTURE X(5).             EDIT0078
                 88 A-BLANK       VALUE SPACES.                         EDIT0079
              03 FILLER           PICTURE X(4).                         EDIT0080
              03 B-FIELD          PICTURE 9(5).                         EDIT0081
              03 B-ALPHA REDEFINES B-FIELD    PICTURE X(5).             EDIT0082
                 88 B-BLANK       VALUE SPACES.                         EDIT0083
              03 FILLER           PICTURE X(54).                        EDIT0084
           02 FILLER              PICTURE X(5).                         EDIT0085
                                                                        EDIT0086
       FD  COMMENTARY                                                   EDIT0087
           LABEL RECORDS ARE OMITTED                                    EDIT0088
           BLOCK CONTAINS 82 CHARACTERS                                 EDIT0089
           DATA RECORD IS COMMENT-LINE.                                 EDIT0090
                                                                        EDIT0091
       01  COMMENT-LINE.                                                EDIT0092
           02 FILLER              PICTURE X(82).                        EDIT0093
                                                                        EDIT0094
       WORKING-STORAGE SECTION.                                         EDIT0095
                                                                        EDIT0096
       77  COMMAND-ADDITIONS      PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0097
       77  COMMAND-SUBTRACTIONS   PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0098
       77  TOTAL-INSERTED         PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0099
       77  TOTAL-DELETED          PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0100
       77  OUTPUT-COUNT           PICTURE 9(5) COMPUTATIONAL VALUE 0.   EDIT0101
       77  LINE-COUNT             PICTURE 9(2) COMPUTATIONAL VALUE 0.   EDIT0102
       77  FIELDA                 PICTURE 9(5) VALUE 0.                 EDIT0103
       77  FIELDB                 PICTURE 9(5) VALUE 0.                 EDIT0104
       77  BLANK-LINE             PICTURE X(82) VALUE SPACES.           EDIT0105
                                                                        EDIT0106
       01  DATE-FROM-SYS.                                               EDIT0107
           02 DFSYS OCCURS 3 TIMES PICTURE 99.                          EDIT0108
                                                                        EDIT0109
       01  HEADINGS-LINE.                                               EDIT0110
           02 FILLER              PICTURE X(15) VALUE "EDITOR VERSION". EDIT0111
           02 FILLER              PICTURE X(20) VALUE "1.1 - 206/72".   EDIT0112
           02 PHASE               PICTURE X(17) VALUE "UPDATING AS OF". EDIT0113
           02 MONTH-RUN           PICTURE XX.                           EDIT0114
           02 FILLER              PICTURE X VALUE "/".                  EDIT0115
           02 DAY-RUN             PICTURE XX.                           EDIT0116
           02 FILLER              PICTURE X VALUE "/".                  EDIT0117
           02 YEAR-RUN            PICTURE XX.                           EDIT0118
           02 FILLER              PICTURE X(8) VALUE SPACES.            EDIT0119
           02 FILLER              PICTURE X(8) VALUE "  PAGE: ".        EDIT0120
           02 PAGE-NUMBER         PICTURE 9(4) VALUE 0.                 EDIT0121
                                                                        EDIT0122
       01  COMMAND-LISTING.                                             EDIT0123
           02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0124
           02 COMMAND-IMAGE       PICTURE X(80).                        EDIT0125
                                                                        EDIT0126
       01  ACTIVITIES-LISTING.                                          EDIT0127
           02 DISPOSITION         PICTURE X(2).                         EDIT0128
           02 ACTIVE-IMAGE        PICTURE X(80).                        EDIT0129
                                                                        EDIT0130
       01  UPSI-BYTE.                                                   EDIT0131
           02 UPSI-BIT OCCURS 8 TIMES  PICTURE X.                       EDIT0132
                                                                        EDIT0133
       01  MESSAGE-LOG.                                                 EDIT0134
           02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0135
           02 MESSAGE-TEXT        PICTURE X(80).                        EDIT0136
                                                                        EDIT0137
       01  DISPLAY-MESSAGE.                                             EDIT0138
           02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0139
           02 DISPLAY-TEMP        PICTURE X(6).                         EDIT0140
           02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0141
           02 DISPLAY-TEXT        PICTURE X(60).                        EDIT0142
                                                                        EDIT0143
       77  END-JOB-PROCESS        PICTURE 9 VALUE 0.                    EDIT0144
       77  DELETE-PROCESS         PICTURE 9 VALUE 1.                    EDIT0145
       77  INSERT-PROCESS         PICTURE 9 VALUE 2.                    EDIT0146
       77  WRITE-PROCESS          PICTURE 9 VALUE 3.                    EDIT0147
                                                                        EDIT0148
       01  SELECTORS.                                                   EDIT0149
           02 RETURN-SELECT       PICTURE 9 VALUE 0.                    EDIT0150
           02 NEXT-JOB-SELECT     PICTURE 9 VALUE 0.                    EDIT0151
                                                                        EDIT0152
       PROCEDURE DIVISION.                                              EDIT0153
                                                                        EDIT0154
       START-SECTION.                                                   EDIT0155
           OPEN INPUT OLD-VERSION, MODIFICATION,                        EDIT0156
                OUTPUT NEW-VERSION, COMMENTARY.                         EDIT0157
           MOVE "F" TO UPSI-BIT (1), UPSI-BIT (2).                      EDIT0158
           ACCEPT DATE-FROM-SYS FROM DATE.                              EDIT0159
           MOVE DFSYS (1) TO YEAR-RUN.                                  EDIT0160
           MOVE DFSYS (2) TO MONTH-RUN.                                 EDIT0161
           MOVE DFSYS (3) TO DAY-RUN.                                   EDIT0162
           READ OLD-VERSION AT END                                      EDIT0163
              MOVE "NO OLD VERSION FOUND" TO MESSAGE-TEXT               EDIT0164
              WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0165
              GO TO END-JOB.                                            EDIT0166
           MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0167
           PERFORM OUTPUT-A-RECORD.                                     EDIT0168
                                                                        EDIT0169
       TOP-OF-PAGE-ROUTINE.                                             EDIT0170
           ADD 1 TO PAGE-NUMBER.                                        EDIT0171
           MOVE ZERO TO LINE-COUNT.                                     EDIT0172
           WRITE COMMENT-LINE FROM HEADINGS-LINE AFTER PAGE.            EDIT0173
           WRITE COMMENT-LINE FROM BLANK-LINE.                          EDIT0174
                                                                        EDIT0175
       READ-A-COMMAND.                                                  EDIT0176
           READ MODIFICATION AT END                                     EDIT0177
              MOVE "MODIFICATION FILE ENDED " TO MESSAGE-TEXT           EDIT0178
              WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0179
              GO TO FINISH-JOB.                                         EDIT0180
           MOVE UPDATE-ORDER TO COMMAND-IMAGE.                          EDIT0181
           WRITE COMMENT-LINE FROM COMMAND-LISTING.                     EDIT0182
           ADD 2 TO LINE-COUNT.                                         EDIT0183
           IF A-BLANK MOVE ZEROES TO A-FIELD.                           EDIT0184
           IF B-BLANK MOVE ZEROES TO B-FIELD.                           EDIT0185
           MOVE A-FIELD TO FIELDA.                                      EDIT0186
           MOVE B-FIELD TO FIELDB.                                      EDIT0187
                                                                        EDIT0188
       TEST-COMMAND-TYPE.                                               EDIT0189
           IF CHANGE GO TO CHANGE-A-RECORD.                             EDIT0190
           IF REMOVE GO TO DELETE-A-RECORD.                             EDIT0191
           IF DISPLY MOVE "T" TO UPSI-BIT (2)                           EDIT0192
              GO TO FINISH-JOB.                                         EDIT0193
           IF ENDJOB GO TO FINISH-JOB.                                  EDIT0194
           IF ADDNEW GO TO INSERT-A-RECORD.                             EDIT0195
           MOVE "INVALID COMMAND IGNORED." TO MESSAGE-TEXT.             EDIT0196
           WRITE COMMENT-LINE FROM MESSAGE-LOG.                         EDIT0197
           GO TO READ-A-COMMAND.                                        EDIT0198
                                                                        EDIT0199
       CHANGE-A-RECORD.                                                 EDIT0200
           ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.        EDIT0201
           ALTER NEXT-JOB-STEP TO PROCEED TO DELETION-PROCESS.          EDIT0202
                                                                        EDIT0205
       FIND-FIELDA.                                                     EDIT0206
           IF OLD-NUMBER IS GREATER THAN FIELDA                         EDIT0207
              MOVE "RECORD ALREADY PASSED" TO MESSAGE-TEXT              EDIT0208
              WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0209
              GO TO READ-A-COMMAND.                                     EDIT0210
           READ OLD-VERSION AT END                                      EDIT0211
              MOVE "NOT FOUND IN OLD VERSION" TO DISPLAY-TEXT           EDIT0212
              MOVE FIELDA TO DISPLAY-TEMP                               EDIT0213
              WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0214
              GO TO END-JOB.                                            EDIT0215
           IF OLD-NUMBER IS LESS THAN FIELDA                            EDIT0216
              MOVE OLD-STATEMENT TO NEW-STATEMENT                       EDIT0217
              PERFORM OUTPUT-A-RECORD                                   EDIT0218
              GO TO FIND-FIELDA.                                        EDIT0219
                                                                        EDIT0220
       RETURN-TO-USER.                                                  EDIT0221
           GO TO END-JOB.                                               EDIT0223
                                                                        EDIT0228
       INSERT-A-RECORD.                                                 EDIT0229
           ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.        EDIT0230
           ALTER NEXT-JOB-STEP TO PROCEED TO FORCED-WRITE.              EDIT0231
           GO TO FIND-FIELDA.                                           EDIT0234
                                                                        EDIT0235
       INSERTION-PROCESS.                                               EDIT0236
           READ MODIFICATION AT END                                     EDIT0237
              MOVE "NO ENDSET FOUND" TO MESSAGE-TEXT                    EDIT0238
              WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0239
              GO TO END-JOB.                                            EDIT0240
           IF ENDSET                                                    EDIT0241
              MOVE COMMAND-ADDITIONS TO DISPLAY-TEMP                    EDIT0242
              MOVE "RECORDS INSERTED." TO DISPLAY-TEXT                  EDIT0243
              WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0244
              ADD COMMAND-ADDITIONS TO TOTAL-INSERTED                   EDIT0245
              MOVE ZEROES TO COMMAND-ADDITIONS                          EDIT0246
              GO TO NEXT-JOB-STEP.                                      EDIT0247
           MOVE INSERTION TO NEW-STATEMENT, ACTIVE-IMAGE.               EDIT0248
           MOVE "I " TO DISPOSITION.                                    EDIT0249
           PERFORM OUTPUT-A-RECORD.                                     EDIT0250
           WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0251
           ADD 1 TO COMMAND-ADDITIONS.                                  EDIT0252
           ADD 1 TO LINE-COUNT.                                         EDIT0253
           IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0254
           GO TO INSERTION-PROCESS.                                     EDIT0255
                                                                        EDIT0256
       NEXT-JOB-STEP.                                                   EDIT0257
           GO TO END-JOB.                                               EDIT0259
                                                                        EDIT0264
       FORCED-WRITE.                                                    EDIT0265
           MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0266
           PERFORM OUTPUT-A-RECORD.                                     EDIT0267
           GO TO READ-A-COMMAND.                                        EDIT0268
                                                                        EDIT0269
       DELETE-A-RECORD.                                                 EDIT0270
           ALTER RETURN-TO-USER TO PROCEED TO DELETION-PROCESS.         EDIT0271
           GO TO FIND-FIELDA.                                           EDIT0273
                                                                        EDIT0274
       DELETION-PROCESS.                                                EDIT0275
           MOVE OLD-RECORD TO ACTIVE-IMAGE.                             EDIT0276
           MOVE "D " TO DISPOSITION.                                    EDIT0277
           WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0278
           ADD 1 TO LINE-COUNT.                                         EDIT0279
           IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0280
           ADD 1 TO COMMAND-SUBTRACTIONS.                               EDIT0281
           IF OLD-NUMBER IS NOT LESS THAN FIELDB                        EDIT0282
              MOVE COMMAND-SUBTRACTIONS TO DISPLAY-TEMP                 EDIT0283
              MOVE "RECORDS DELETED." TO DISPLAY-TEXT                   EDIT0284
              WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0285
              ADD COMMAND-SUBTRACTIONS TO TOTAL-DELETED                 EDIT0286
              MOVE OLD-STATEMENT TO NEW-STATEMENT                       EDIT0287
              MOVE ZEROES TO COMMAND-SUBTRACTIONS                       EDIT0288
              GO TO READ-A-COMMAND.                                     EDIT0289
           READ OLD-VERSION AT END                                      EDIT0290
              MOVE "NOT FOUND IN OLD VERSION DOING DELETE"              EDIT0291
                    TO DISPLAY-TEXT                                     EDIT0292
              WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0293
              GO TO END-JOB.                                            EDIT0294
           GO TO DELETION-PROCESS.                                      EDIT0295
                                                                        EDIT0296
       OUTPUT-A-RECORD.                                                 EDIT0297
           ADD 1 TO OUTPUT-COUNT.                                       EDIT0298
           MOVE OUTPUT-COUNT TO NEW-NUMBER.                             EDIT0299
           WRITE NEW-RECORD.                                            EDIT0300
                                                                        EDIT0301
       FINISH-JOB.                                                      EDIT0302
           READ OLD-VERSION AT END GO TO TEST-FOR-LISTING.              EDIT0303
           MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0304
           GO TO OUTPUT-A-RECORD.                                       EDIT0305
                                                                        EDIT0306
       TEST-FOR-LISTING.                                                EDIT0307
           PERFORM TOP-OF-PAGE-ROUTINE.                                 EDIT0308
           MOVE OLD-NUMBER TO DISPLAY-TEMP.                             EDIT0309
           MOVE "RECORDS READ." TO DISPLAY-TEXT.                        EDIT0310
           WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0311
           MOVE TOTAL-INSERTED TO DISPLAY-TEMP.                         EDIT0312
           MOVE "RECORDS ADDED." TO DISPLAY-TEXT.                       EDIT0313
           WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0314
           MOVE TOTAL-DELETED TO DISPLAY-TEMP.                          EDIT0315
           MOVE "RECORDS DROPPED." TO DISPLAY-TEXT.                     EDIT0316
           WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0317
           MOVE OUTPUT-COUNT TO DISPLAY-TEMP.                           EDIT0318
           MOVE "RECORDS IN NEW FILE." TO DISPLAY-TEXT.                 EDIT0319
           WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0320
           IF UPSI-BIT (2) EQUAL "F" GO TO END-JOB.                     EDIT0321
           CLOSE NEW-VERSION.                                           EDIT0322
           OPEN INPUT NEW-VERSION.                                      EDIT0323
           MOVE "UPDATED LISTING" TO PHASE.                             EDIT0324
           MOVE ZEROES TO PAGE-NUMBER.                                  EDIT0325
           PERFORM TOP-OF-PAGE-ROUTINE.                                 EDIT0326
           MOVE SPACES TO DISPOSITION.                                  EDIT0327
                                                                        EDIT0328
       LISTING-LOOP.                                                    EDIT0329
           READ NEW-VERSION AT END GO TO END-JOB.                       EDIT0330
           MOVE NEW-RECORD TO ACTIVE-IMAGE.                             EDIT0331
           WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0332
           ADD 1 TO LINE-COUNT.                                         EDIT0333
           IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0334
           GO TO LISTING-LOOP.                                          EDIT0335
                                                                        EDIT0336
       END-JOB.                                                         EDIT0337
           MOVE "PROGRAM TERMINATION" TO MESSAGE-TEXT.                  EDIT0338
           WRITE COMMENT-LINE FROM MESSAGE-LOG.                         EDIT0339
           CLOSE OLD-VERSION, NEW-VERSION, MODIFICATION, COMMENTARY.    EDIT0340
           STOP RUN.                                                    EDIT0341
                                                                        EDIT0342
       END PROGRAM EDITOR.                                              EDIT0343
])

AT_CHECK([$COMPILE_ONLY -Xref -t prog.lst -tlines=0 -tsymbols EDITOR.cob], [1], [], [ignore])


AT_DATA([prog18.lst],
[GnuCOBOL V.R.P               EDITOR.cob                 DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID.
000004             EDITOR.
000005
000006        *NOTE.
000007        *    THIS VERSION OF EDITOR 1 COMPRISES AN ENTIRE RE_WRITE
000008        *    OF THE BASIC EDITOR WITH ONLY ONE CHANGE IN THE COMMAND
000009        *    STRUCTURE, THAT BEING THE ADDITION OF A "CHANGE" COMMAND
000010        *    TO SERVE IN PLACE OF THE INSERT-DELETE COMBINATION WHICH
000011        *    WAS REQUIRED IN PREVIOUS VERSIONS. RECORD NUMBER FIELDS
000012        *    HAVE ALSO BEEN REDUCED FROM 5 DIGITS TO 4.
000013        *    CHANGE 1.
000014        *       MODIFY TO RUN ON TI-990.
000015        *    CHANGE 2.
000016        *       MODIFY TO RUN ON GNUCOBOL.
000017
000018         ENVIRONMENT DIVISION.
000019         CONFIGURATION SECTION.
000020         SOURCE-COMPUTER.
000021             IBM-360.
000022         OBJECT-COMPUTER.
000023             IBM-360.
000024         INPUT-OUTPUT SECTION.
000025         FILE-CONTROL.
000026             SELECT OLD-VERSION  ASSIGN TO "SYSUT1"
000027                                 ORGANIZATION LINE SEQUENTIAL.
000028             SELECT NEW-VERSION  ASSIGN TO "SYSUT2"
000029                                 ORGANIZATION LINE SEQUENTIAL.
000030             SELECT PRT-VERSION  ASSIGN TO "SYSUT2"
error: missing file description for FILE PRT-VERSION
000031                                 ORGANIZATION LINE SEQUENTIAL.
000032             SELECT MODIFICATION ASSIGN TO "SYSIN1"
000033                                 ORGANIZATION LINE SEQUENTIAL.
000034             SELECT COMMENTARY   ASSIGN TO "SYSOU1"
000035                                 ORGANIZATION LINE SEQUENTIAL.
000036
000037         DATA DIVISION.
000038
000039         FILE SECTION.
000040
000041         FD  OLD-VERSION
000042             LABEL RECORDS ARE STANDARD
warning: LABEL RECORDS is obsolete in GnuCOBOL
000043             BLOCK CONTAINS 80 CHARACTERS
000044             DATA RECORD IS OLD-RECORD.
warning: DATA RECORDS is obsolete in GnuCOBOL
000045
000046         01  OLD-RECORD.
000047             02 OLD-STATEMENT       PICTURE X(75).
000048             02 OLD-NUMBER          PICTURE X(5).
000049
000050         FD  NEW-VERSION
000051             LABEL RECORDS ARE STANDARD
warning: LABEL RECORDS is obsolete in GnuCOBOL
000052             BLOCK CONTAINS 80 CHARACTERS
000053             DATA RECORD IS NEW-RECORD.
warning: DATA RECORDS is obsolete in GnuCOBOL
000054
000055         01  NEW-RECORD.
000056             02 NEW-STATEMENT       PICTURE X(75).
000057             02 NEW-NUMBER          PICTURE X(5).
000058
000059         FD  MODIFICATION
000060             LABEL RECORDS ARE OMITTED
warning: LABEL RECORDS is obsolete in GnuCOBOL
000061             BLOCK CONTAINS 80 CHARACTERS
000062             DATA RECORD IS UPDATE-ORDER.
warning: DATA RECORDS is obsolete in GnuCOBOL
000063
000064         01  UPDATE-ORDER.
000065             02 INSERTION.
000066                03 COMMAND          PICTURE X(6).
000067                   88 ENDJOB        VALUE "ENDJOB".
000068                   88 ENDSET        VALUE "ENDSET".
000069                   88 REMOVE        VALUE "REMOVE".
000070                   88 ADDNEW        VALUE "INSERT".
000071                   88 CHANGE        VALUE "CHANGE".
000072                   88 DISPLY        VALUE "DISPLY".
000073                03 FILLER           PICTURE X.
000074                03 A-FIELD          PICTURE 9(5).
000075                03 A-ALPHA REDEFINES A-FIELD    PICTURE X(5).
000076                   88 A-BLANK       VALUE SPACES.
000077                03 FILLER           PICTURE X(4).
000078                03 B-FIELD          PICTURE 9(5).
000079                03 B-ALPHA REDEFINES B-FIELD    PICTURE X(5).
000080                   88 B-BLANK       VALUE SPACES.
000081                03 FILLER           PICTURE X(54).
000082             02 FILLER              PICTURE X(5).
000083
000084         FD  COMMENTARY
000085             LABEL RECORDS ARE OMITTED
warning: LABEL RECORDS is obsolete in GnuCOBOL
000086             BLOCK CONTAINS 82 CHARACTERS
000087             DATA RECORD IS COMMENT-LINE.
warning: DATA RECORDS is obsolete in GnuCOBOL
000088
000089         01  COMMENT-LINE.
000090             02 FILLER              PICTURE X(82).
000091
000092         WORKING-STORAGE SECTION.
000093
000094         77  COMMAND-ADDITIONS      PICTURE 9(3) COMPUTATIONAL VALUE 0.
000095         77  COMMAND-SUBTRACTIONS   PICTURE 9(3) COMPUTATIONAL VALUE 0.
000096         77  TOTAL-INSERTED         PICTURE 9(3) COMPUTATIONAL VALUE 0.
000097         77  TOTAL-DELETED          PICTURE 9(3) COMPUTATIONAL VALUE 0.
000098         77  OUTPUT-COUNT           PICTURE 9(5) COMPUTATIONAL VALUE 0.
000099         77  LINE-COUNT             PICTURE 9(2) COMPUTATIONAL VALUE 0.
000100         77  FIELDA                 PICTURE 9(5) VALUE 0.
000101         77  FIELDB                 PICTURE 9(5) VALUE 0.
000102         77  BLANK-LINE             PICTURE X(82) VALUE SPACES.
000103
000104         01  DATE-FROM-SYS.
000105             02 DFSYS OCCURS 3 TIMES PICTURE 99.
000106
000107         01  HEADINGS-LINE.
000108             02 FILLER              PICTURE X(15) VALUE "EDITOR VERSION".
000109             02 FILLER              PICTURE X(20) VALUE "1.1 - 206/72".
000110             02 PHASE               PICTURE X(17) VALUE "UPDATING AS OF".
000111             02 MONTH-RUN           PICTURE XX.
000112             02 FILLER              PICTURE X VALUE "/".
000113             02 DAY-RUN             PICTURE XX.
000114             02 FILLER              PICTURE X VALUE "/".
000115             02 YEAR-RUN            PICTURE XX.
000116             02 FILLER              PICTURE X(8) VALUE SPACES.
000117             02 FILLER              PICTURE X(8) VALUE "  PAGE: ".
000118             02 PAGE-NUMBER         PICTURE 9(4) VALUE 0.
000119
000120         01  COMMAND-LISTING.
000121             02 FILLER              PICTURE X(2) VALUE SPACES.
000122             02 COMMAND-IMAGE       PICTURE X(80).
000123
000124         01  ACTIVITIES-LISTING.
000125             02 DISPOSITION         PICTURE X(2).
000126             02 ACTIVE-IMAGE        PICTURE X(80).
000127
000128         01  UPSI-BYTE.
000129             02 UPSI-BIT OCCURS 8 TIMES  PICTURE X.
000130
000131         01  MESSAGE-LOG.
000132             02 FILLER              PICTURE X(2) VALUE SPACES.
000133             02 MESSAGE-TEXT        PICTURE X(80).
000134
000135         01  DISPLAY-MESSAGE.
000136             02 FILLER              PICTURE X(2) VALUE SPACES.
000137             02 DISPLAY-TEMP        PICTURE X(6).
000138             02 FILLER              PICTURE X(2) VALUE SPACES.
000139             02 DISPLAY-TEXT        PICTURE X(60).
000140
000141         77  END-JOB-PROCESS        PICTURE 9 VALUE 0.
000142         77  DELETE-PROCESS         PICTURE 9 VALUE 1.
000143         77  INSERT-PROCESS         PICTURE 9 VALUE 2.
000144         77  WRITE-PROCESS          PICTURE 9 VALUE 3.
000145
000146         01  SELECTORS.
000147             02 RETURN-SELECT       PICTURE 9 VALUE 0.
000148             02 NEXT-JOB-SELECT     PICTURE 9 VALUE 0.
000149
000150         PROCEDURE DIVISION.
000151
000152         START-SECTION.
000153             OPEN INPUT OLD-VERSION, MODIFICATION,
000154                  OUTPUT NEW-VERSION, COMMENTARY.
000155             MOVE "F" TO UPSI-BIT (1), UPSI-BIT (2).
000156             ACCEPT DATE-FROM-SYS FROM DATE.
000157             MOVE DFSYS (1) TO YEAR-RUN.
000158             MOVE DFSYS (2) TO MONTH-RUN.
000159             MOVE DFSYS (3) TO DAY-RUN.
000160             READ OLD-VERSION AT END
000161                MOVE "NO OLD VERSION FOUND" TO MESSAGE-TEXT
000162                WRITE COMMENT-LINE FROM MESSAGE-LOG
000163                GO TO END-JOB.
000164             MOVE OLD-STATEMENT TO NEW-STATEMENT.
000165             PERFORM OUTPUT-A-RECORD.
000166
000167         TOP-OF-PAGE-ROUTINE.
000168             ADD 1 TO PAGE-NUMBER.
000169             MOVE ZERO TO LINE-COUNT.
000170             WRITE COMMENT-LINE FROM HEADINGS-LINE AFTER PAGE.
000171             WRITE COMMENT-LINE FROM BLANK-LINE.
000172
000173         READ-A-COMMAND.
000174             READ MODIFICATION AT END
000175                MOVE "MODIFICATION FILE ENDED " TO MESSAGE-TEXT
000176                WRITE COMMENT-LINE FROM MESSAGE-LOG
000177                GO TO FINISH-JOB.
000178             MOVE UPDATE-ORDER TO COMMAND-IMAGE.
000179             WRITE COMMENT-LINE FROM COMMAND-LISTING.
000180             ADD 2 TO LINE-COUNT.
000181             IF A-BLANK MOVE ZEROES TO A-FIELD.
000182             IF B-BLANK MOVE ZEROES TO B-FIELD.
000183             MOVE A-FIELD TO FIELDA.
000184             MOVE B-FIELD TO FIELDB.
000185
000186         TEST-COMMAND-TYPE.
000187             IF CHANGE GO TO CHANGE-A-RECORD.
000188             IF REMOVE GO TO DELETE-A-RECORD.
000189             IF DISPLY MOVE "T" TO UPSI-BIT (2)
000190                GO TO FINISH-JOB.
000191             IF ENDJOB GO TO FINISH-JOB.
000192             IF ADDNEW GO TO INSERT-A-RECORD.
000193             MOVE "INVALID COMMAND IGNORED." TO MESSAGE-TEXT.
000194             WRITE COMMENT-LINE FROM MESSAGE-LOG.
000195             GO TO READ-A-COMMAND.
000196
000197         CHANGE-A-RECORD.
000198             ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.
warning: ALTER is obsolete in GnuCOBOL
000199             ALTER NEXT-JOB-STEP TO PROCEED TO DELETION-PROCESS.
warning: ALTER is obsolete in GnuCOBOL
000200
000201         FIND-FIELDA.
000202             IF OLD-NUMBER IS GREATER THAN FIELDA
000203                MOVE "RECORD ALREADY PASSED" TO MESSAGE-TEXT
000204                WRITE COMMENT-LINE FROM MESSAGE-LOG
000205                GO TO READ-A-COMMAND.
000206             READ OLD-VERSION AT END
000207                MOVE "NOT FOUND IN OLD VERSION" TO DISPLAY-TEXT
000208                MOVE FIELDA TO DISPLAY-TEMP
000209                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE
000210                GO TO END-JOB.
000211             IF OLD-NUMBER IS LESS THAN FIELDA
000212                MOVE OLD-STATEMENT TO NEW-STATEMENT
000213                PERFORM OUTPUT-A-RECORD
000214                GO TO FIND-FIELDA.
000215
000216         RETURN-TO-USER.
000217             GO TO END-JOB.
000218
000219         INSERT-A-RECORD.
000220             ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.
warning: ALTER is obsolete in GnuCOBOL
000221             ALTER NEXT-JOB-STEP TO PROCEED TO FORCED-WRITE.
warning: ALTER is obsolete in GnuCOBOL
000222             GO TO FIND-FIELDA.
000223
000224         INSERTION-PROCESS.
000225             READ MODIFICATION AT END
000226                MOVE "NO ENDSET FOUND" TO MESSAGE-TEXT
000227                WRITE COMMENT-LINE FROM MESSAGE-LOG
000228                GO TO END-JOB.
000229             IF ENDSET
000230                MOVE COMMAND-ADDITIONS TO DISPLAY-TEMP
000231                MOVE "RECORDS INSERTED." TO DISPLAY-TEXT
000232                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE
000233                ADD COMMAND-ADDITIONS TO TOTAL-INSERTED
000234                MOVE ZEROES TO COMMAND-ADDITIONS
000235                GO TO NEXT-JOB-STEP.
000236             MOVE INSERTION TO NEW-STATEMENT, ACTIVE-IMAGE.
000237             MOVE "I " TO DISPOSITION.
000238             PERFORM OUTPUT-A-RECORD.
000239             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.
000240             ADD 1 TO COMMAND-ADDITIONS.
000241             ADD 1 TO LINE-COUNT.
000242             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.
000243             GO TO INSERTION-PROCESS.
000244
000245         NEXT-JOB-STEP.
000246             GO TO END-JOB.
000247
000248         FORCED-WRITE.
000249             MOVE OLD-STATEMENT TO NEW-STATEMENT.
000250             PERFORM OUTPUT-A-RECORD.
000251             GO TO READ-A-COMMAND.
000252
000253         DELETE-A-RECORD.
000254             ALTER RETURN-TO-USER TO PROCEED TO DELETION-PROCESS.
warning: ALTER is obsolete in GnuCOBOL
000255             GO TO FIND-FIELDA.
000256
000257         DELETION-PROCESS.
000258             MOVE OLD-RECORD TO ACTIVE-IMAGE.
000259             MOVE "D " TO DISPOSITION.
000260             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.
000261             ADD 1 TO LINE-COUNT.
000262             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.
000263             ADD 1 TO COMMAND-SUBTRACTIONS.
000264             IF OLD-NUMBER IS NOT LESS THAN FIELDB
000265                MOVE COMMAND-SUBTRACTIONS TO DISPLAY-TEMP
000266                MOVE "RECORDS DELETED." TO DISPLAY-TEXT
000267                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE
000268                ADD COMMAND-SUBTRACTIONS TO TOTAL-DELETED
000269                MOVE OLD-STATEMENT TO NEW-STATEMENT
000270                MOVE ZEROES TO COMMAND-SUBTRACTIONS
000271                GO TO READ-A-COMMAND.
000272             READ OLD-VERSION AT END
000273                MOVE "NOT FOUND IN OLD VERSION DOING DELETE"
000274                      TO DISPLAY-TEXT
000275                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE
000276                GO TO END-JOB.
000277             GO TO DELETION-PROCESS.
000278
000279         OUTPUT-A-RECORD.
000280             ADD 1 TO OUTPUT-COUNT.
000281             MOVE OUTPUT-COUNT TO NEW-NUMBER.
000282             WRITE NEW-RECORD.
000283
000284         FINISH-JOB.
000285             READ OLD-VERSION AT END GO TO TEST-FOR-LISTING.
000286             MOVE OLD-STATEMENT TO NEW-STATEMENT.
000287             GO TO OUTPUT-A-RECORD.
000288
000289         TEST-FOR-LISTING.
000290             PERFORM TOP-OF-PAGE-ROUTINE.
000291             MOVE OLD-NUMBER TO DISPLAY-TEMP.
000292             MOVE "RECORDS READ." TO DISPLAY-TEXT.
000293             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.
000294             MOVE TOTAL-INSERTED TO DISPLAY-TEMP.
000295             MOVE "RECORDS ADDED." TO DISPLAY-TEXT.
000296             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.
000297             MOVE TOTAL-DELETED TO DISPLAY-TEMP.
000298             MOVE "RECORDS DROPPED." TO DISPLAY-TEXT.
000299             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.
000300             MOVE OUTPUT-COUNT TO DISPLAY-TEMP.
000301             MOVE "RECORDS IN NEW FILE." TO DISPLAY-TEXT.
000302             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.
000303             IF UPSI-BIT (2) EQUAL "F" GO TO END-JOB.
000304             CLOSE NEW-VERSION.
000305             OPEN INPUT NEW-VERSION.
000306             MOVE "UPDATED LISTING" TO PHASE.
000307             MOVE ZEROES TO PAGE-NUMBER.
000308             PERFORM TOP-OF-PAGE-ROUTINE.
000309             MOVE SPACES TO DISPOSITION.
000310
000311         LISTING-LOOP.
000312             READ NEW-VERSION AT END GO TO END-JOB.
000313             MOVE NEW-RECORD TO ACTIVE-IMAGE.
000314             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.
000315             ADD 1 TO LINE-COUNT.
000316             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.
000317             GO TO LISTING-LOOP.
000318
000319         END-JOB.
000320             MOVE "PROGRAM TERMINATION" TO MESSAGE-TEXT.
000321             WRITE COMMENT-LINE FROM MESSAGE-LOG.
000322             CLOSE OLD-VERSION, NEW-VERSION, MODIFICATION, COMMENTARY.
000323             STOP RUN.
000324
000325         END PROGRAM EDITOR.

SIZE  TYPE           LVL  NAME                           PICTURE

00080 FILE                OLD-VERSION
00080 GROUP          01   OLD-RECORD
00075 ALPHANUMERIC   02   OLD-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   OLD-NUMBER                     X(5)

00080 FILE                NEW-VERSION
00080 GROUP          01   NEW-RECORD
00075 ALPHANUMERIC   02   NEW-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   NEW-NUMBER                     X(5)

00032 FILE                PRT-VERSION

00080 FILE                MODIFICATION
00080 GROUP          01   UPDATE-ORDER
00075 GROUP          02   INSERTION
00006 ALPHANUMERIC   03   COMMAND                        X(6)
      CONDITIONAL    88   ENDJOB
      CONDITIONAL    88   ENDSET
      CONDITIONAL    88   REMOVE
      CONDITIONAL    88   ADDNEW
      CONDITIONAL    88   CHANGE
      CONDITIONAL    88   DISPLY
00001 ALPHANUMERIC   03   FILLER                         X
00005 NUMERIC        03   A-FIELD                        9(5)
00005 ALPHANUMERIC   03   A-ALPHA                        X(5), REDEFINES A-FIELD
      CONDITIONAL    88   A-BLANK
00004 ALPHANUMERIC   03   FILLER                         X(4)
00005 NUMERIC        03   B-FIELD                        9(5)
00005 ALPHANUMERIC   03   B-ALPHA                        X(5), REDEFINES B-FIELD
      CONDITIONAL    88   B-BLANK
00054 ALPHANUMERIC   03   FILLER                         X(54)
00005 ALPHANUMERIC   02   FILLER                         X(5)

00082 FILE                COMMENTARY
00082 GROUP          01   COMMENT-LINE
00082 ALPHANUMERIC   02   FILLER                         X(82)

      WORKING-STORAGE SECTION

00002 NUMERIC        77   COMMAND-ADDITIONS              9(3) COMP
00002 NUMERIC        77   COMMAND-SUBTRACTIONS           9(3) COMP
00002 NUMERIC        77   TOTAL-INSERTED                 9(3) COMP
00002 NUMERIC        77   TOTAL-DELETED                  9(3) COMP
00004 NUMERIC        77   OUTPUT-COUNT                   9(5) COMP
00001 NUMERIC        77   LINE-COUNT                     9(2) COMP
00005 NUMERIC        77   FIELDA                         9(5)
00005 NUMERIC        77   FIELDB                         9(5)
00082 ALPHANUMERIC   77   BLANK-LINE                     X(82)

00006 GROUP          01   DATE-FROM-SYS
00002 NUMERIC        02   DFSYS                          99, OCCURS 3

00080 GROUP          01   HEADINGS-LINE
00015 ALPHANUMERIC   02   FILLER                         X(15)
00020 ALPHANUMERIC   02   FILLER                         X(20)
00017 ALPHANUMERIC   02   PHASE                          X(17)
00002 ALPHANUMERIC   02   MONTH-RUN                      XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   DAY-RUN                        XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   YEAR-RUN                       XX
00008 ALPHANUMERIC   02   FILLER                         X(8)
00008 ALPHANUMERIC   02   FILLER                         X(8)
00004 NUMERIC        02   PAGE-NUMBER                    9(4)

00082 GROUP          01   COMMAND-LISTING
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   COMMAND-IMAGE                  X(80)

00082 GROUP          01   ACTIVITIES-LISTING
00002 ALPHANUMERIC   02   DISPOSITION                    X(2)
00080 ALPHANUMERIC   02   ACTIVE-IMAGE                   X(80)

00008 GROUP          01   UPSI-BYTE
00001 ALPHANUMERIC   02   UPSI-BIT                       X, OCCURS 8

00082 GROUP          01   MESSAGE-LOG
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   MESSAGE-TEXT                   X(80)

00070 GROUP          01   DISPLAY-MESSAGE
00002 ALPHANUMERIC   02   FILLER                         X(2)
00006 ALPHANUMERIC   02   DISPLAY-TEMP                   X(6)
00002 ALPHANUMERIC   02   FILLER                         X(2)
00060 ALPHANUMERIC   02   DISPLAY-TEXT                   X(60)

00001 NUMERIC        77   END-JOB-PROCESS                9
00001 NUMERIC        77   DELETE-PROCESS                 9
00001 NUMERIC        77   INSERT-PROCESS                 9
00001 NUMERIC        77   WRITE-PROCESS                  9

00002 GROUP          01   SELECTORS
00001 NUMERIC        02   RETURN-SELECT                  9
00001 NUMERIC        02   NEXT-JOB-SELECT                9


NAME                           DEFINED                REFERENCES

OLD-VERSION                    26       41      153     160     206     272
                                        285     322                    x7
OLD-RECORD                     46       44      258                    x2
OLD-STATEMENT                  47       164     212     249     269     286
                                                                       x5
OLD-NUMBER                     48       202     211     264     291    x4

NEW-VERSION                    28       50     *154    *282     304     305
                                        312     322                    x7
NEW-RECORD                     55       53      282     313            x3
NEW-STATEMENT                  56      *164    *212    *236    *249    *269
                                       *286                            x6
NEW-NUMBER                     57      *281                            x1

PRT-VERSION                    30     not referenced

MODIFICATION                   32       59      153     174     225     322
                                                                       x5
UPDATE-ORDER                   64       62      178                    x2
INSERTION                      65       236                            x1
COMMAND                        66     referenced by parent/child
ENDJOB                         67       191                            x1
ENDSET                         68       229                            x1
REMOVE                         69       188                            x1
ADDNEW                         70       192                            x1
CHANGE                         71       187                            x1
DISPLY                         72       189                            x1
A-FIELD                        74      *181     183                    x2
A-ALPHA                        75     referenced by parent/child
A-BLANK                        76       181                            x1
B-FIELD                        78      *182     184                    x2
B-ALPHA                        79     referenced by parent/child
B-BLANK                        80       182                            x1

COMMENTARY                     34       84     *154    *162    *170    *171
                                       *176    *179    *194    *204    *209
                                       *227    *232    *239    *260    *267
                                       *275    *293    *296    *299    *302
                                       *314    *321     322            x23
COMMENT-LINE                   89       87     *162    *170    *171    *176
                                       *179    *194    *204    *209    *227
                                       *232    *239    *260    *267    *275
                                       *293    *296    *299    *302    *314
                                       *321                            x21

COMMAND-ADDITIONS              94       230     233    *234    *240    x4
COMMAND-SUBTRACTIONS           95      *263     265     268    *270    x4
TOTAL-INSERTED                 96      *233     294                    x2
TOTAL-DELETED                  97      *268     297                    x2
OUTPUT-COUNT                   98      *280     281     300            x3
LINE-COUNT                     99      *169    *180    *241     242    *261
                                        262    *315     316            x8
FIELDA                         100     *183     202     208     211    x4
FIELDB                         101     *184     264                    x2
BLANK-LINE                     102      171                            x1
DATE-FROM-SYS                  104     *156                            x1
DFSYS                          105      157     158     159            x3
HEADINGS-LINE                  107      170                            x1
PHASE                          110     *306                            x1
MONTH-RUN                      111     *158                            x1
DAY-RUN                        113     *159                            x1
YEAR-RUN                       115     *157                            x1
PAGE-NUMBER                    118     *168    *307                    x2
COMMAND-LISTING                120      179                            x1
COMMAND-IMAGE                  122     *178                            x1
ACTIVITIES-LISTING             124      239     260     314            x3
DISPOSITION                    125     *237    *259    *309            x3
ACTIVE-IMAGE                   126     *236    *258    *313            x3
UPSI-BYTE                      128    referenced by child
UPSI-BIT                       129     *155    *189     303            x3
MESSAGE-LOG                    131      162     176     194     204     227
                                        321                            x6
MESSAGE-TEXT                   133     *161    *175    *193    *203    *226
                                       *320                            x6
DISPLAY-MESSAGE                135      209     232     267     275     293
                                        296     299     302            x8
DISPLAY-TEMP                   137     *208    *230    *265    *291    *294
                                       *297    *300                    x7
DISPLAY-TEXT                   139     *207    *231    *266    *274    *292
                                       *295    *298    *301            x8
END-JOB-PROCESS                141    not referenced
DELETE-PROCESS                 142    not referenced
INSERT-PROCESS                 143    not referenced
WRITE-PROCESS                  144    not referenced
SELECTORS                      146    not referenced
RETURN-SELECT                  147    not referenced
NEXT-JOB-SELECT                148    not referenced


LABEL                          DEFINED                REFERENCES

E EDITOR                       152
P START-SECTION                152    not referenced
P TOP-OF-PAGE-ROUTINE          167      242     262     290     308     316
                                                                       x5
P READ-A-COMMAND               173      195     205     251     271    x4
P TEST-COMMAND-TYPE            186    not referenced
P CHANGE-A-RECORD              197      187                            x1
P FIND-FIELDA                  201      214     222     255            x3
P RETURN-TO-USER               216      198     220     254            x3
P INSERT-A-RECORD              219      192                            x1
P INSERTION-PROCESS            224      198     220     243            x3
P NEXT-JOB-STEP                245      199     221     235            x3
P FORCED-WRITE                 248      221                            x1
P DELETE-A-RECORD              253      188                            x1
P DELETION-PROCESS             257      199     254     277            x3
P OUTPUT-A-RECORD              279      165     213     238     250     287
                                                                       x5
P FINISH-JOB                   284      177     190     191            x3
P TEST-FOR-LISTING             289      285                            x1
P LISTING-LOOP                 311      317                            x1
P END-JOB                      319      163     210     217     228     246
                                        276     303     312            x8


Error/Warning summary:

EDITOR.cob:30: error: missing file description for FILE PRT-VERSION
EDITOR.cob:42: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:44: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:51: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:53: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:60: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:62: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:85: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:87: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:198: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:199: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:220: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:221: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:254: warning: ALTER is obsolete in GnuCOBOL

13 warnings in compilation group
1 error in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog18.lst prog.lis], [0], [], [])

AT_CHECK([$COMPILE_ONLY -Xref -T prog.lst -tlines=0 -tsymbols EDITOR.cob], [1], [],
[EDITOR.cob:42: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:44: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:51: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:53: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:60: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:62: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:85: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:87: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:30: error: missing file description for FILE PRT-VERSION
EDITOR.cob: in paragraph 'CHANGE-A-RECORD':
EDITOR.cob:198: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:199: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob: in paragraph 'INSERT-A-RECORD':
EDITOR.cob:220: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:221: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob: in paragraph 'DELETE-A-RECORD':
EDITOR.cob:254: warning: ALTER is obsolete in GnuCOBOL
])


AT_DATA([prog19.lst],
[GnuCOBOL V.R.P               EDITOR.cob                                                         DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................SEQUENCE

000001
000002         IDENTIFICATION DIVISION.                                         EDIT0001
000003         PROGRAM-ID.                                                      EDIT0002
000004             EDITOR.                                                      EDIT0003
000005                                                                          EDIT0008
000006        *NOTE.                                                            EDIT0009
000007        *    THIS VERSION OF EDITOR 1 COMPRISES AN ENTIRE RE_WRITE        EDIT0010
000008        *    OF THE BASIC EDITOR WITH ONLY ONE CHANGE IN THE COMMAND      EDIT0011
000009        *    STRUCTURE, THAT BEING THE ADDITION OF A "CHANGE" COMMAND     EDIT0012
000010        *    TO SERVE IN PLACE OF THE INSERT-DELETE COMBINATION WHICH     EDIT0013
000011        *    WAS REQUIRED IN PREVIOUS VERSIONS. RECORD NUMBER FIELDS      EDIT0014
000012        *    HAVE ALSO BEEN REDUCED FROM 5 DIGITS TO 4.                   EDIT0015
000013        *    CHANGE 1.                                                    EDIT0016
000014        *       MODIFY TO RUN ON TI-990.                                  EDIT0017
000015        *    CHANGE 2.                                                    EDIT0018
000016        *       MODIFY TO RUN ON GNUCOBOL.                                EDIT0019
000017                                                                          EDIT0020
000018         ENVIRONMENT DIVISION.                                            EDIT0021
000019         CONFIGURATION SECTION.                                           EDIT0022
000020         SOURCE-COMPUTER.                                                 EDIT0023
000021             IBM-360.                                                     EDIT0024
000022         OBJECT-COMPUTER.                                                 EDIT0025
000023             IBM-360.                                                     EDIT0026
000024         INPUT-OUTPUT SECTION.                                            EDIT0027
000025         FILE-CONTROL.                                                    EDIT0028
000026             SELECT OLD-VERSION  ASSIGN TO "SYSUT1"                       EDIT0029
000027                                 ORGANIZATION LINE SEQUENTIAL.            EDIT0030
000028             SELECT NEW-VERSION  ASSIGN TO "SYSUT2"                       EDIT0031
000029                                 ORGANIZATION LINE SEQUENTIAL.            EDIT0032
000030             SELECT PRT-VERSION  ASSIGN TO "SYSUT2"                       EDIT0033
error: missing file description for FILE PRT-VERSION
000031                                 ORGANIZATION LINE SEQUENTIAL.            EDIT0034
000032             SELECT MODIFICATION ASSIGN TO "SYSIN1"                       EDIT0035
000033                                 ORGANIZATION LINE SEQUENTIAL.            EDIT0036
000034             SELECT COMMENTARY   ASSIGN TO "SYSOU1"                       EDIT0037
000035                                 ORGANIZATION LINE SEQUENTIAL.            EDIT0038
000036                                                                          EDIT0039
000037         DATA DIVISION.                                                   EDIT0040
000038                                                                          EDIT0041
000039         FILE SECTION.                                                    EDIT0042
000040                                                                          EDIT0043
000041         FD  OLD-VERSION                                                  EDIT0044
000042             LABEL RECORDS ARE STANDARD                                   EDIT0045
warning: LABEL RECORDS is obsolete in GnuCOBOL
000043             BLOCK CONTAINS 80 CHARACTERS                                 EDIT0046
000044             DATA RECORD IS OLD-RECORD.                                   EDIT0047
warning: DATA RECORDS is obsolete in GnuCOBOL
000045                                                                          EDIT0048
000046         01  OLD-RECORD.                                                  EDIT0049
000047             02 OLD-STATEMENT       PICTURE X(75).                        EDIT0050
000048             02 OLD-NUMBER          PICTURE X(5).                         EDIT0051
000049                                                                          EDIT0052
000050         FD  NEW-VERSION                                                  EDIT0053
000051             LABEL RECORDS ARE STANDARD                                   EDIT0054
warning: LABEL RECORDS is obsolete in GnuCOBOL
000052             BLOCK CONTAINS 80 CHARACTERS                                 EDIT0055
000053             DATA RECORD IS NEW-RECORD.                                   EDIT0056
warning: DATA RECORDS is obsolete in GnuCOBOL
000054                                                                          EDIT0057
000055         01  NEW-RECORD.                                                  EDIT0058
000056             02 NEW-STATEMENT       PICTURE X(75).                        EDIT0059
000057             02 NEW-NUMBER          PICTURE X(5).                         EDIT0060
000058                                                                          EDIT0061
000059         FD  MODIFICATION                                                 EDIT0062
000060             LABEL RECORDS ARE OMITTED                                    EDIT0063
warning: LABEL RECORDS is obsolete in GnuCOBOL
000061             BLOCK CONTAINS 80 CHARACTERS                                 EDIT0064
000062             DATA RECORD IS UPDATE-ORDER.                                 EDIT0065
warning: DATA RECORDS is obsolete in GnuCOBOL
000063                                                                          EDIT0066
000064         01  UPDATE-ORDER.                                                EDIT0067
000065             02 INSERTION.                                                EDIT0068
000066                03 COMMAND          PICTURE X(6).                         EDIT0069
000067                   88 ENDJOB        VALUE "ENDJOB".                       EDIT0070
000068                   88 ENDSET        VALUE "ENDSET".                       EDIT0071
000069                   88 REMOVE        VALUE "REMOVE".                       EDIT0072
000070                   88 ADDNEW        VALUE "INSERT".                       EDIT0073
000071                   88 CHANGE        VALUE "CHANGE".                       EDIT0074
000072                   88 DISPLY        VALUE "DISPLY".                       EDIT0075
000073                03 FILLER           PICTURE X.                            EDIT0076
000074                03 A-FIELD          PICTURE 9(5).                         EDIT0077
000075                03 A-ALPHA REDEFINES A-FIELD    PICTURE X(5).             EDIT0078
000076                   88 A-BLANK       VALUE SPACES.                         EDIT0079
000077                03 FILLER           PICTURE X(4).                         EDIT0080
000078                03 B-FIELD          PICTURE 9(5).                         EDIT0081
000079                03 B-ALPHA REDEFINES B-FIELD    PICTURE X(5).             EDIT0082
000080                   88 B-BLANK       VALUE SPACES.                         EDIT0083
000081                03 FILLER           PICTURE X(54).                        EDIT0084
000082             02 FILLER              PICTURE X(5).                         EDIT0085
000083                                                                          EDIT0086
000084         FD  COMMENTARY                                                   EDIT0087
000085             LABEL RECORDS ARE OMITTED                                    EDIT0088
warning: LABEL RECORDS is obsolete in GnuCOBOL
000086             BLOCK CONTAINS 82 CHARACTERS                                 EDIT0089
000087             DATA RECORD IS COMMENT-LINE.                                 EDIT0090
warning: DATA RECORDS is obsolete in GnuCOBOL
000088                                                                          EDIT0091
000089         01  COMMENT-LINE.                                                EDIT0092
000090             02 FILLER              PICTURE X(82).                        EDIT0093
000091                                                                          EDIT0094
000092         WORKING-STORAGE SECTION.                                         EDIT0095
000093                                                                          EDIT0096
000094         77  COMMAND-ADDITIONS      PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0097
000095         77  COMMAND-SUBTRACTIONS   PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0098
000096         77  TOTAL-INSERTED         PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0099
000097         77  TOTAL-DELETED          PICTURE 9(3) COMPUTATIONAL VALUE 0.   EDIT0100
000098         77  OUTPUT-COUNT           PICTURE 9(5) COMPUTATIONAL VALUE 0.   EDIT0101
000099         77  LINE-COUNT             PICTURE 9(2) COMPUTATIONAL VALUE 0.   EDIT0102
000100         77  FIELDA                 PICTURE 9(5) VALUE 0.                 EDIT0103
000101         77  FIELDB                 PICTURE 9(5) VALUE 0.                 EDIT0104
000102         77  BLANK-LINE             PICTURE X(82) VALUE SPACES.           EDIT0105
000103                                                                          EDIT0106
000104         01  DATE-FROM-SYS.                                               EDIT0107
000105             02 DFSYS OCCURS 3 TIMES PICTURE 99.                          EDIT0108
000106                                                                          EDIT0109
000107         01  HEADINGS-LINE.                                               EDIT0110
000108             02 FILLER              PICTURE X(15) VALUE "EDITOR VERSION". EDIT0111
000109             02 FILLER              PICTURE X(20) VALUE "1.1 - 206/72".   EDIT0112
000110             02 PHASE               PICTURE X(17) VALUE "UPDATING AS OF". EDIT0113
000111             02 MONTH-RUN           PICTURE XX.                           EDIT0114
000112             02 FILLER              PICTURE X VALUE "/".                  EDIT0115
000113             02 DAY-RUN             PICTURE XX.                           EDIT0116
000114             02 FILLER              PICTURE X VALUE "/".                  EDIT0117
000115             02 YEAR-RUN            PICTURE XX.                           EDIT0118
000116             02 FILLER              PICTURE X(8) VALUE SPACES.            EDIT0119
000117             02 FILLER              PICTURE X(8) VALUE "  PAGE: ".        EDIT0120
000118             02 PAGE-NUMBER         PICTURE 9(4) VALUE 0.                 EDIT0121
000119                                                                          EDIT0122
000120         01  COMMAND-LISTING.                                             EDIT0123
000121             02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0124
000122             02 COMMAND-IMAGE       PICTURE X(80).                        EDIT0125
000123                                                                          EDIT0126
000124         01  ACTIVITIES-LISTING.                                          EDIT0127
000125             02 DISPOSITION         PICTURE X(2).                         EDIT0128
000126             02 ACTIVE-IMAGE        PICTURE X(80).                        EDIT0129
000127                                                                          EDIT0130
000128         01  UPSI-BYTE.                                                   EDIT0131
000129             02 UPSI-BIT OCCURS 8 TIMES  PICTURE X.                       EDIT0132
000130                                                                          EDIT0133
000131         01  MESSAGE-LOG.                                                 EDIT0134
000132             02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0135
000133             02 MESSAGE-TEXT        PICTURE X(80).                        EDIT0136
000134                                                                          EDIT0137
000135         01  DISPLAY-MESSAGE.                                             EDIT0138
000136             02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0139
000137             02 DISPLAY-TEMP        PICTURE X(6).                         EDIT0140
000138             02 FILLER              PICTURE X(2) VALUE SPACES.            EDIT0141
000139             02 DISPLAY-TEXT        PICTURE X(60).                        EDIT0142
000140                                                                          EDIT0143
000141         77  END-JOB-PROCESS        PICTURE 9 VALUE 0.                    EDIT0144
000142         77  DELETE-PROCESS         PICTURE 9 VALUE 1.                    EDIT0145
000143         77  INSERT-PROCESS         PICTURE 9 VALUE 2.                    EDIT0146
000144         77  WRITE-PROCESS          PICTURE 9 VALUE 3.                    EDIT0147
000145                                                                          EDIT0148
000146         01  SELECTORS.                                                   EDIT0149
000147             02 RETURN-SELECT       PICTURE 9 VALUE 0.                    EDIT0150
000148             02 NEXT-JOB-SELECT     PICTURE 9 VALUE 0.                    EDIT0151
000149                                                                          EDIT0152
000150         PROCEDURE DIVISION.                                              EDIT0153
000151                                                                          EDIT0154
000152         START-SECTION.                                                   EDIT0155
000153             OPEN INPUT OLD-VERSION, MODIFICATION,                        EDIT0156
000154                  OUTPUT NEW-VERSION, COMMENTARY.                         EDIT0157
000155             MOVE "F" TO UPSI-BIT (1), UPSI-BIT (2).                      EDIT0158
000156             ACCEPT DATE-FROM-SYS FROM DATE.                              EDIT0159
000157             MOVE DFSYS (1) TO YEAR-RUN.                                  EDIT0160
000158             MOVE DFSYS (2) TO MONTH-RUN.                                 EDIT0161
000159             MOVE DFSYS (3) TO DAY-RUN.                                   EDIT0162
000160             READ OLD-VERSION AT END                                      EDIT0163
000161                MOVE "NO OLD VERSION FOUND" TO MESSAGE-TEXT               EDIT0164
000162                WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0165
000163                GO TO END-JOB.                                            EDIT0166
000164             MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0167
000165             PERFORM OUTPUT-A-RECORD.                                     EDIT0168
000166                                                                          EDIT0169
000167         TOP-OF-PAGE-ROUTINE.                                             EDIT0170
000168             ADD 1 TO PAGE-NUMBER.                                        EDIT0171
000169             MOVE ZERO TO LINE-COUNT.                                     EDIT0172
000170             WRITE COMMENT-LINE FROM HEADINGS-LINE AFTER PAGE.            EDIT0173
000171             WRITE COMMENT-LINE FROM BLANK-LINE.                          EDIT0174
000172                                                                          EDIT0175
000173         READ-A-COMMAND.                                                  EDIT0176
000174             READ MODIFICATION AT END                                     EDIT0177
000175                MOVE "MODIFICATION FILE ENDED " TO MESSAGE-TEXT           EDIT0178
000176                WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0179
000177                GO TO FINISH-JOB.                                         EDIT0180
000178             MOVE UPDATE-ORDER TO COMMAND-IMAGE.                          EDIT0181
000179             WRITE COMMENT-LINE FROM COMMAND-LISTING.                     EDIT0182
000180             ADD 2 TO LINE-COUNT.                                         EDIT0183
000181             IF A-BLANK MOVE ZEROES TO A-FIELD.                           EDIT0184
000182             IF B-BLANK MOVE ZEROES TO B-FIELD.                           EDIT0185
000183             MOVE A-FIELD TO FIELDA.                                      EDIT0186
000184             MOVE B-FIELD TO FIELDB.                                      EDIT0187
000185                                                                          EDIT0188
000186         TEST-COMMAND-TYPE.                                               EDIT0189
000187             IF CHANGE GO TO CHANGE-A-RECORD.                             EDIT0190
000188             IF REMOVE GO TO DELETE-A-RECORD.                             EDIT0191
000189             IF DISPLY MOVE "T" TO UPSI-BIT (2)                           EDIT0192
000190                GO TO FINISH-JOB.                                         EDIT0193
000191             IF ENDJOB GO TO FINISH-JOB.                                  EDIT0194
000192             IF ADDNEW GO TO INSERT-A-RECORD.                             EDIT0195
000193             MOVE "INVALID COMMAND IGNORED." TO MESSAGE-TEXT.             EDIT0196
000194             WRITE COMMENT-LINE FROM MESSAGE-LOG.                         EDIT0197
000195             GO TO READ-A-COMMAND.                                        EDIT0198
000196                                                                          EDIT0199
000197         CHANGE-A-RECORD.                                                 EDIT0200
000198             ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.        EDIT0201
warning: ALTER is obsolete in GnuCOBOL
000199             ALTER NEXT-JOB-STEP TO PROCEED TO DELETION-PROCESS.          EDIT0202
warning: ALTER is obsolete in GnuCOBOL
000200                                                                          EDIT0205
000201         FIND-FIELDA.                                                     EDIT0206
000202             IF OLD-NUMBER IS GREATER THAN FIELDA                         EDIT0207
000203                MOVE "RECORD ALREADY PASSED" TO MESSAGE-TEXT              EDIT0208
000204                WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0209
000205                GO TO READ-A-COMMAND.                                     EDIT0210
000206             READ OLD-VERSION AT END                                      EDIT0211
000207                MOVE "NOT FOUND IN OLD VERSION" TO DISPLAY-TEXT           EDIT0212
000208                MOVE FIELDA TO DISPLAY-TEMP                               EDIT0213
000209                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0214
000210                GO TO END-JOB.                                            EDIT0215
000211             IF OLD-NUMBER IS LESS THAN FIELDA                            EDIT0216
000212                MOVE OLD-STATEMENT TO NEW-STATEMENT                       EDIT0217
000213                PERFORM OUTPUT-A-RECORD                                   EDIT0218
000214                GO TO FIND-FIELDA.                                        EDIT0219
000215                                                                          EDIT0220
000216         RETURN-TO-USER.                                                  EDIT0221
000217             GO TO END-JOB.                                               EDIT0223
000218                                                                          EDIT0228
000219         INSERT-A-RECORD.                                                 EDIT0229
000220             ALTER RETURN-TO-USER TO PROCEED TO INSERTION-PROCESS.        EDIT0230
warning: ALTER is obsolete in GnuCOBOL
000221             ALTER NEXT-JOB-STEP TO PROCEED TO FORCED-WRITE.              EDIT0231
warning: ALTER is obsolete in GnuCOBOL
000222             GO TO FIND-FIELDA.                                           EDIT0234
000223                                                                          EDIT0235
000224         INSERTION-PROCESS.                                               EDIT0236
000225             READ MODIFICATION AT END                                     EDIT0237
000226                MOVE "NO ENDSET FOUND" TO MESSAGE-TEXT                    EDIT0238
000227                WRITE COMMENT-LINE FROM MESSAGE-LOG                       EDIT0239
000228                GO TO END-JOB.                                            EDIT0240
000229             IF ENDSET                                                    EDIT0241
000230                MOVE COMMAND-ADDITIONS TO DISPLAY-TEMP                    EDIT0242
000231                MOVE "RECORDS INSERTED." TO DISPLAY-TEXT                  EDIT0243
000232                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0244
000233                ADD COMMAND-ADDITIONS TO TOTAL-INSERTED                   EDIT0245
000234                MOVE ZEROES TO COMMAND-ADDITIONS                          EDIT0246
000235                GO TO NEXT-JOB-STEP.                                      EDIT0247
000236             MOVE INSERTION TO NEW-STATEMENT, ACTIVE-IMAGE.               EDIT0248
000237             MOVE "I " TO DISPOSITION.                                    EDIT0249
000238             PERFORM OUTPUT-A-RECORD.                                     EDIT0250
000239             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0251
000240             ADD 1 TO COMMAND-ADDITIONS.                                  EDIT0252
000241             ADD 1 TO LINE-COUNT.                                         EDIT0253
000242             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0254
000243             GO TO INSERTION-PROCESS.                                     EDIT0255
000244                                                                          EDIT0256
000245         NEXT-JOB-STEP.                                                   EDIT0257
000246             GO TO END-JOB.                                               EDIT0259
000247                                                                          EDIT0264
000248         FORCED-WRITE.                                                    EDIT0265
000249             MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0266
000250             PERFORM OUTPUT-A-RECORD.                                     EDIT0267
000251             GO TO READ-A-COMMAND.                                        EDIT0268
000252                                                                          EDIT0269
000253         DELETE-A-RECORD.                                                 EDIT0270
000254             ALTER RETURN-TO-USER TO PROCEED TO DELETION-PROCESS.         EDIT0271
warning: ALTER is obsolete in GnuCOBOL
000255             GO TO FIND-FIELDA.                                           EDIT0273
000256                                                                          EDIT0274
000257         DELETION-PROCESS.                                                EDIT0275
000258             MOVE OLD-RECORD TO ACTIVE-IMAGE.                             EDIT0276
000259             MOVE "D " TO DISPOSITION.                                    EDIT0277
000260             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0278
000261             ADD 1 TO LINE-COUNT.                                         EDIT0279
000262             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0280
000263             ADD 1 TO COMMAND-SUBTRACTIONS.                               EDIT0281
000264             IF OLD-NUMBER IS NOT LESS THAN FIELDB                        EDIT0282
000265                MOVE COMMAND-SUBTRACTIONS TO DISPLAY-TEMP                 EDIT0283
000266                MOVE "RECORDS DELETED." TO DISPLAY-TEXT                   EDIT0284
000267                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0285
000268                ADD COMMAND-SUBTRACTIONS TO TOTAL-DELETED                 EDIT0286
000269                MOVE OLD-STATEMENT TO NEW-STATEMENT                       EDIT0287
000270                MOVE ZEROES TO COMMAND-SUBTRACTIONS                       EDIT0288
000271                GO TO READ-A-COMMAND.                                     EDIT0289
000272             READ OLD-VERSION AT END                                      EDIT0290
000273                MOVE "NOT FOUND IN OLD VERSION DOING DELETE"              EDIT0291
000274                      TO DISPLAY-TEXT                                     EDIT0292
000275                WRITE COMMENT-LINE FROM DISPLAY-MESSAGE                   EDIT0293
000276                GO TO END-JOB.                                            EDIT0294
000277             GO TO DELETION-PROCESS.                                      EDIT0295
000278                                                                          EDIT0296
000279         OUTPUT-A-RECORD.                                                 EDIT0297
000280             ADD 1 TO OUTPUT-COUNT.                                       EDIT0298
000281             MOVE OUTPUT-COUNT TO NEW-NUMBER.                             EDIT0299
000282             WRITE NEW-RECORD.                                            EDIT0300
000283                                                                          EDIT0301
000284         FINISH-JOB.                                                      EDIT0302
000285             READ OLD-VERSION AT END GO TO TEST-FOR-LISTING.              EDIT0303
000286             MOVE OLD-STATEMENT TO NEW-STATEMENT.                         EDIT0304
000287             GO TO OUTPUT-A-RECORD.                                       EDIT0305
000288                                                                          EDIT0306
000289         TEST-FOR-LISTING.                                                EDIT0307
000290             PERFORM TOP-OF-PAGE-ROUTINE.                                 EDIT0308
000291             MOVE OLD-NUMBER TO DISPLAY-TEMP.                             EDIT0309
000292             MOVE "RECORDS READ." TO DISPLAY-TEXT.                        EDIT0310
000293             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0311
000294             MOVE TOTAL-INSERTED TO DISPLAY-TEMP.                         EDIT0312
000295             MOVE "RECORDS ADDED." TO DISPLAY-TEXT.                       EDIT0313
000296             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0314
000297             MOVE TOTAL-DELETED TO DISPLAY-TEMP.                          EDIT0315
000298             MOVE "RECORDS DROPPED." TO DISPLAY-TEXT.                     EDIT0316
000299             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0317
000300             MOVE OUTPUT-COUNT TO DISPLAY-TEMP.                           EDIT0318
000301             MOVE "RECORDS IN NEW FILE." TO DISPLAY-TEXT.                 EDIT0319
000302             WRITE COMMENT-LINE FROM DISPLAY-MESSAGE.                     EDIT0320
000303             IF UPSI-BIT (2) EQUAL "F" GO TO END-JOB.                     EDIT0321
000304             CLOSE NEW-VERSION.                                           EDIT0322
000305             OPEN INPUT NEW-VERSION.                                      EDIT0323
000306             MOVE "UPDATED LISTING" TO PHASE.                             EDIT0324
000307             MOVE ZEROES TO PAGE-NUMBER.                                  EDIT0325
000308             PERFORM TOP-OF-PAGE-ROUTINE.                                 EDIT0326
000309             MOVE SPACES TO DISPOSITION.                                  EDIT0327
000310                                                                          EDIT0328
000311         LISTING-LOOP.                                                    EDIT0329
000312             READ NEW-VERSION AT END GO TO END-JOB.                       EDIT0330
000313             MOVE NEW-RECORD TO ACTIVE-IMAGE.                             EDIT0331
000314             WRITE COMMENT-LINE FROM ACTIVITIES-LISTING.                  EDIT0332
000315             ADD 1 TO LINE-COUNT.                                         EDIT0333
000316             IF LINE-COUNT EQUAL 56 PERFORM TOP-OF-PAGE-ROUTINE.          EDIT0334
000317             GO TO LISTING-LOOP.                                          EDIT0335
000318                                                                          EDIT0336
000319         END-JOB.                                                         EDIT0337
000320             MOVE "PROGRAM TERMINATION" TO MESSAGE-TEXT.                  EDIT0338
000321             WRITE COMMENT-LINE FROM MESSAGE-LOG.                         EDIT0339
000322             CLOSE OLD-VERSION, NEW-VERSION, MODIFICATION, COMMENTARY.    EDIT0340
000323             STOP RUN.                                                    EDIT0341
000324                                                                          EDIT0342
000325         END PROGRAM EDITOR.                                              EDIT0343

SIZE  TYPE           LVL  NAME                           PICTURE

00080 FILE                OLD-VERSION
00080 GROUP          01   OLD-RECORD
00075 ALPHANUMERIC   02   OLD-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   OLD-NUMBER                     X(5)

00080 FILE                NEW-VERSION
00080 GROUP          01   NEW-RECORD
00075 ALPHANUMERIC   02   NEW-STATEMENT                  X(75)
00005 ALPHANUMERIC   02   NEW-NUMBER                     X(5)

00032 FILE                PRT-VERSION

00080 FILE                MODIFICATION
00080 GROUP          01   UPDATE-ORDER
00075 GROUP          02   INSERTION
00006 ALPHANUMERIC   03   COMMAND                        X(6)
      CONDITIONAL    88   ENDJOB
      CONDITIONAL    88   ENDSET
      CONDITIONAL    88   REMOVE
      CONDITIONAL    88   ADDNEW
      CONDITIONAL    88   CHANGE
      CONDITIONAL    88   DISPLY
00001 ALPHANUMERIC   03   FILLER                         X
00005 NUMERIC        03   A-FIELD                        9(5)
00005 ALPHANUMERIC   03   A-ALPHA                        X(5), REDEFINES A-FIELD
      CONDITIONAL    88   A-BLANK
00004 ALPHANUMERIC   03   FILLER                         X(4)
00005 NUMERIC        03   B-FIELD                        9(5)
00005 ALPHANUMERIC   03   B-ALPHA                        X(5), REDEFINES B-FIELD
      CONDITIONAL    88   B-BLANK
00054 ALPHANUMERIC   03   FILLER                         X(54)
00005 ALPHANUMERIC   02   FILLER                         X(5)

00082 FILE                COMMENTARY
00082 GROUP          01   COMMENT-LINE
00082 ALPHANUMERIC   02   FILLER                         X(82)

      WORKING-STORAGE SECTION

00002 NUMERIC        77   COMMAND-ADDITIONS              9(3) COMP
00002 NUMERIC        77   COMMAND-SUBTRACTIONS           9(3) COMP
00002 NUMERIC        77   TOTAL-INSERTED                 9(3) COMP
00002 NUMERIC        77   TOTAL-DELETED                  9(3) COMP
00004 NUMERIC        77   OUTPUT-COUNT                   9(5) COMP
00001 NUMERIC        77   LINE-COUNT                     9(2) COMP
00005 NUMERIC        77   FIELDA                         9(5)
00005 NUMERIC        77   FIELDB                         9(5)
00082 ALPHANUMERIC   77   BLANK-LINE                     X(82)

00006 GROUP          01   DATE-FROM-SYS
00002 NUMERIC        02   DFSYS                          99, OCCURS 3

00080 GROUP          01   HEADINGS-LINE
00015 ALPHANUMERIC   02   FILLER                         X(15)
00020 ALPHANUMERIC   02   FILLER                         X(20)
00017 ALPHANUMERIC   02   PHASE                          X(17)
00002 ALPHANUMERIC   02   MONTH-RUN                      XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   DAY-RUN                        XX
00001 ALPHANUMERIC   02   FILLER                         X
00002 ALPHANUMERIC   02   YEAR-RUN                       XX
00008 ALPHANUMERIC   02   FILLER                         X(8)
00008 ALPHANUMERIC   02   FILLER                         X(8)
00004 NUMERIC        02   PAGE-NUMBER                    9(4)

00082 GROUP          01   COMMAND-LISTING
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   COMMAND-IMAGE                  X(80)

00082 GROUP          01   ACTIVITIES-LISTING
00002 ALPHANUMERIC   02   DISPOSITION                    X(2)
00080 ALPHANUMERIC   02   ACTIVE-IMAGE                   X(80)

00008 GROUP          01   UPSI-BYTE
00001 ALPHANUMERIC   02   UPSI-BIT                       X, OCCURS 8

00082 GROUP          01   MESSAGE-LOG
00002 ALPHANUMERIC   02   FILLER                         X(2)
00080 ALPHANUMERIC   02   MESSAGE-TEXT                   X(80)

00070 GROUP          01   DISPLAY-MESSAGE
00002 ALPHANUMERIC   02   FILLER                         X(2)
00006 ALPHANUMERIC   02   DISPLAY-TEMP                   X(6)
00002 ALPHANUMERIC   02   FILLER                         X(2)
00060 ALPHANUMERIC   02   DISPLAY-TEXT                   X(60)

00001 NUMERIC        77   END-JOB-PROCESS                9
00001 NUMERIC        77   DELETE-PROCESS                 9
00001 NUMERIC        77   INSERT-PROCESS                 9
00001 NUMERIC        77   WRITE-PROCESS                  9

00002 GROUP          01   SELECTORS
00001 NUMERIC        02   RETURN-SELECT                  9
00001 NUMERIC        02   NEXT-JOB-SELECT                9


NAME                           DEFINED                                    REFERENCES

OLD-VERSION                    26       41      153     160     206     272     285     322                    x7
OLD-RECORD                     46       44      258                                                            x2
OLD-STATEMENT                  47       164     212     249     269     286                                    x5
OLD-NUMBER                     48       202     211     264     291                                            x4

NEW-VERSION                    28       50     *154    *282     304     305     312     322                    x7
NEW-RECORD                     55       53      282     313                                                    x3
NEW-STATEMENT                  56      *164    *212    *236    *249    *269    *286                            x6
NEW-NUMBER                     57      *281                                                                    x1

PRT-VERSION                    30     not referenced

MODIFICATION                   32       59      153     174     225     322                                    x5
UPDATE-ORDER                   64       62      178                                                            x2
INSERTION                      65       236                                                                    x1
COMMAND                        66     referenced by parent/child
ENDJOB                         67       191                                                                    x1
ENDSET                         68       229                                                                    x1
REMOVE                         69       188                                                                    x1
ADDNEW                         70       192                                                                    x1
CHANGE                         71       187                                                                    x1
DISPLY                         72       189                                                                    x1
A-FIELD                        74      *181     183                                                            x2
A-ALPHA                        75     referenced by parent/child
A-BLANK                        76       181                                                                    x1
B-FIELD                        78      *182     184                                                            x2
B-ALPHA                        79     referenced by parent/child
B-BLANK                        80       182                                                                    x1

COMMENTARY                     34       84     *154    *162    *170    *171    *176    *179    *194    *204    *209
                                       *227    *232    *239    *260    *267    *275    *293    *296    *299    *302
                                       *314    *321     322                                                    x23
COMMENT-LINE                   89       87     *162    *170    *171    *176    *179    *194    *204    *209    *227
                                       *232    *239    *260    *267    *275    *293    *296    *299    *302    *314
                                       *321                                                                    x21

COMMAND-ADDITIONS              94       230     233    *234    *240                                            x4
COMMAND-SUBTRACTIONS           95      *263     265     268    *270                                            x4
TOTAL-INSERTED                 96      *233     294                                                            x2
TOTAL-DELETED                  97      *268     297                                                            x2
OUTPUT-COUNT                   98      *280     281     300                                                    x3
LINE-COUNT                     99      *169    *180    *241     242    *261     262    *315     316            x8
FIELDA                         100     *183     202     208     211                                            x4
FIELDB                         101     *184     264                                                            x2
BLANK-LINE                     102      171                                                                    x1
DATE-FROM-SYS                  104     *156                                                                    x1
DFSYS                          105      157     158     159                                                    x3
HEADINGS-LINE                  107      170                                                                    x1
PHASE                          110     *306                                                                    x1
MONTH-RUN                      111     *158                                                                    x1
DAY-RUN                        113     *159                                                                    x1
YEAR-RUN                       115     *157                                                                    x1
PAGE-NUMBER                    118     *168    *307                                                            x2
COMMAND-LISTING                120      179                                                                    x1
COMMAND-IMAGE                  122     *178                                                                    x1
ACTIVITIES-LISTING             124      239     260     314                                                    x3
DISPOSITION                    125     *237    *259    *309                                                    x3
ACTIVE-IMAGE                   126     *236    *258    *313                                                    x3
UPSI-BYTE                      128    referenced by child
UPSI-BIT                       129     *155    *189     303                                                    x3
MESSAGE-LOG                    131      162     176     194     204     227     321                            x6
MESSAGE-TEXT                   133     *161    *175    *193    *203    *226    *320                            x6
DISPLAY-MESSAGE                135      209     232     267     275     293     296     299     302            x8
DISPLAY-TEMP                   137     *208    *230    *265    *291    *294    *297    *300                    x7
DISPLAY-TEXT                   139     *207    *231    *266    *274    *292    *295    *298    *301            x8
END-JOB-PROCESS                141    not referenced
DELETE-PROCESS                 142    not referenced
INSERT-PROCESS                 143    not referenced
WRITE-PROCESS                  144    not referenced
SELECTORS                      146    not referenced
RETURN-SELECT                  147    not referenced
NEXT-JOB-SELECT                148    not referenced


LABEL                          DEFINED                                    REFERENCES

E EDITOR                       152
P START-SECTION                152    not referenced
P TOP-OF-PAGE-ROUTINE          167      242     262     290     308     316                                    x5
P READ-A-COMMAND               173      195     205     251     271                                            x4
P TEST-COMMAND-TYPE            186    not referenced
P CHANGE-A-RECORD              197      187                                                                    x1
P FIND-FIELDA                  201      214     222     255                                                    x3
P RETURN-TO-USER               216      198     220     254                                                    x3
P INSERT-A-RECORD              219      192                                                                    x1
P INSERTION-PROCESS            224      198     220     243                                                    x3
P NEXT-JOB-STEP                245      199     221     235                                                    x3
P FORCED-WRITE                 248      221                                                                    x1
P DELETE-A-RECORD              253      188                                                                    x1
P DELETION-PROCESS             257      199     254     277                                                    x3
P OUTPUT-A-RECORD              279      165     213     238     250     287                                    x5
P FINISH-JOB                   284      177     190     191                                                    x3
P TEST-FOR-LISTING             289      285                                                                    x1
P LISTING-LOOP                 311      317                                                                    x1
P END-JOB                      319      163     210     217     228     246     276     303     312            x8


Error/Warning summary:

EDITOR.cob:30: error: missing file description for FILE PRT-VERSION
EDITOR.cob:42: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:44: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:51: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:53: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:60: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:62: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:85: warning: LABEL RECORDS is obsolete in GnuCOBOL
EDITOR.cob:87: warning: DATA RECORDS is obsolete in GnuCOBOL
EDITOR.cob:198: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:199: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:220: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:221: warning: ALTER is obsolete in GnuCOBOL
EDITOR.cob:254: warning: ALTER is obsolete in GnuCOBOL

13 warnings in compilation group
1 error in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog19.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Report Writer])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

      * ************************************************************* *
      * REPORT WRITER EXAMPLE #1.                                     *
      * ************************************************************* *

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.

           SELECT TRANSACTION-DATA
               ASSIGN TO EXTERNAL DATAIN
                         ORGANIZATION IS LINE SEQUENTIAL.

           SELECT REPORT-FILE
               ASSIGN TO EXTERNAL LINE ADVANCING SYSPRINT.

       DATA DIVISION.
       FILE SECTION.

       FD  TRANSACTION-DATA.

       01  TRANSACTION-RECORD.
           03  TR-CUSTOMER-NUMBER      PIC 9(04).
           03  FILLER                  PIC X(01).
           03  TR-CUSTOMER-NAME        PIC X(16).
           03  FILLER                  PIC X(01).
           03  TR-ITEM-NUMBER          PIC 9(05).
           03  FILLER                  REDEFINES TR-ITEM-NUMBER.
               05  TR-ITEM-DEPARTMENT  PIC 9(01).
               05  FILLER              PIC 9(04).
           03  FILLER                  PIC X(01).
           03  TR-ITEM-COST            PIC 9(03)V99.
           03  FILLER                  PIC X(47).

       FD  REPORT-FILE
           REPORT IS CUSTOMER-REPORT.

       WORKING-STORAGE SECTION.
       77  END-OF-FILE-SWITCH          PIC X(1)    VALUE 'N'.
           88  END-OF-FILE                         VALUE 'Y'.

       REPORT SECTION.
       RD  CUSTOMER-REPORT
           PAGE LIMIT IS 66 LINES
           HEADING 1
           FIRST DETAIL 5
           LAST DETAIL 58.

       01  PAGE-HEAD-GROUP TYPE PAGE HEADING.
           02  LINE 1.
               03  COLUMN 27   PIC X(41) VALUE
                   'C U S T O M E R  C H A R G E  R E P O R T'.
           02  LINE PLUS 2.
               03  COLUMN 01   PIC X(09) VALUE 'CUST. NO.'.
               03  COLUMN 15   PIC X(10) VALUE 'CUST. NAME'.
               03  COLUMN 30   PIC X(05) VALUE 'DEPT.'.
               03  COLUMN 39   PIC X(08) VALUE 'ITEM NO.'.
               03  COLUMN 51   PIC X(09) VALUE 'ITEM COST'.

       01  CHARGE-DETAIL TYPE DETAIL.
           02  LINE PLUS 1.
               03  COLUMN 03   PIC Z(04) SOURCE TR-CUSTOMER-NUMBER.
               03  COLUMN 10   PIC X(16) SOURCE TR-CUSTOMER-NAME.
               03  COLUMN 32   PIC 9(01) SOURCE TR-ITEM-DEPARTMENT.
               03  COLUMN 40   PIC 9(05) SOURCE TR-ITEM-NUMBER.
               03  COLUMN 51   PIC $$$$.99 SOURCE TR-ITEM-COST.

       PROCEDURE DIVISION.

       000-INITIATE.

           OPEN INPUT TRANSACTION-DATA,
                OUTPUT REPORT-FILE.

           INITIATE CUSTOMER-REPORT.

           READ TRANSACTION-DATA
               AT END
                   MOVE 'Y' TO END-OF-FILE-SWITCH.
      *    END-READ.

           PERFORM 100-PROCESS-TRANSACTION-DATA THRU 199-EXIT
               UNTIL END-OF-FILE.

       000-TERMINATE.
           TERMINATE CUSTOMER-REPORT.

           CLOSE TRANSACTION-DATA,
                 REPORT-FILE.

           STOP RUN.

       100-PROCESS-TRANSACTION-DATA.
           GENERATE CHARGE-DETAIL.
           READ TRANSACTION-DATA
               AT END
                   MOVE 'Y' TO END-OF-FILE-SWITCH.
      *    END-READ.

       199-EXIT.
           EXIT.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tsymbols -Xref -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog1.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION DIVISION.
000003         PROGRAM-ID. prog.
000004
000005        * ************************************************************* *
000006        * REPORT WRITER EXAMPLE #1.                                     *
000007        * ************************************************************* *
000008
000009         ENVIRONMENT DIVISION.
000010         CONFIGURATION SECTION.
000011
000012         INPUT-OUTPUT SECTION.
000013         FILE-CONTROL.
000014
000015             SELECT TRANSACTION-DATA
000016                 ASSIGN TO EXTERNAL DATAIN
000017                           ORGANIZATION IS LINE SEQUENTIAL.
000018
000019             SELECT REPORT-FILE
000020                 ASSIGN TO EXTERNAL LINE ADVANCING SYSPRINT.
000021
000022         DATA DIVISION.
000023         FILE SECTION.
000024
000025         FD  TRANSACTION-DATA.
000026
000027         01  TRANSACTION-RECORD.
000028             03  TR-CUSTOMER-NUMBER      PIC 9(04).
000029             03  FILLER                  PIC X(01).
000030             03  TR-CUSTOMER-NAME        PIC X(16).
000031             03  FILLER                  PIC X(01).
000032             03  TR-ITEM-NUMBER          PIC 9(05).
000033             03  FILLER                  REDEFINES TR-ITEM-NUMBER.
000034                 05  TR-ITEM-DEPARTMENT  PIC 9(01).
000035                 05  FILLER              PIC 9(04).
000036             03  FILLER                  PIC X(01).
000037             03  TR-ITEM-COST            PIC 9(03)V99.
000038             03  FILLER                  PIC X(47).
000039
000040         FD  REPORT-FILE
000041             REPORT IS CUSTOMER-REPORT.
000042
000043         WORKING-STORAGE SECTION.
000044         77  END-OF-FILE-SWITCH          PIC X(1)    VALUE 'N'.
000045             88  END-OF-FILE                         VALUE 'Y'.
000046
000047         REPORT SECTION.
000048         RD  CUSTOMER-REPORT
000049             PAGE LIMIT IS 66 LINES
000050             HEADING 1
000051             FIRST DETAIL 5
000052             LAST DETAIL 58.
000053
000054         01  PAGE-HEAD-GROUP TYPE PAGE HEADING.
000055             02  LINE 1.
000056                 03  COLUMN 27   PIC X(41) VALUE
000057                     'C U S T O M E R  C H A R G E  R E P O R T'.
000058             02  LINE PLUS 2.
000059                 03  COLUMN 01   PIC X(09) VALUE 'CUST. NO.'.
000060                 03  COLUMN 15   PIC X(10) VALUE 'CUST. NAME'.
000061                 03  COLUMN 30   PIC X(05) VALUE 'DEPT.'.
000062                 03  COLUMN 39   PIC X(08) VALUE 'ITEM NO.'.
000063                 03  COLUMN 51   PIC X(09) VALUE 'ITEM COST'.
000064
000065         01  CHARGE-DETAIL TYPE DETAIL.
000066             02  LINE PLUS 1.
000067                 03  COLUMN 03   PIC Z(04) SOURCE TR-CUSTOMER-NUMBER.
000068                 03  COLUMN 10   PIC X(16) SOURCE TR-CUSTOMER-NAME.
000069                 03  COLUMN 32   PIC 9(01) SOURCE TR-ITEM-DEPARTMENT.
000070                 03  COLUMN 40   PIC 9(05) SOURCE TR-ITEM-NUMBER.
000071                 03  COLUMN 51   PIC $$$$.99 SOURCE TR-ITEM-COST.
000072
000073         PROCEDURE DIVISION.
000074
000075         000-INITIATE.
000076
000077             OPEN INPUT TRANSACTION-DATA,
000078                  OUTPUT REPORT-FILE.
000079
000080             INITIATE CUSTOMER-REPORT.
000081
000082             READ TRANSACTION-DATA
000083                 AT END
000084                     MOVE 'Y' TO END-OF-FILE-SWITCH.
000085        *    END-READ.
000086
000087             PERFORM 100-PROCESS-TRANSACTION-DATA THRU 199-EXIT
000088                 UNTIL END-OF-FILE.
000089
000090         000-TERMINATE.
000091             TERMINATE CUSTOMER-REPORT.
000092
000093             CLOSE TRANSACTION-DATA,
000094                   REPORT-FILE.
000095
000096             STOP RUN.
000097
000098         100-PROCESS-TRANSACTION-DATA.
000099             GENERATE CHARGE-DETAIL.
000100             READ TRANSACTION-DATA
000101                 AT END
000102                     MOVE 'Y' TO END-OF-FILE-SWITCH.
000103        *    END-READ.
000104
000105         199-EXIT.
000106             EXIT.

SIZE  TYPE           LVL  NAME                           PICTURE

00080 FILE                TRANSACTION-DATA
00080 GROUP          01   TRANSACTION-RECORD
00004 NUMERIC        03   TR-CUSTOMER-NUMBER             9(04)
00001 ALPHANUMERIC   03   FILLER                         X(01)
00016 ALPHANUMERIC   03   TR-CUSTOMER-NAME               X(16)
00001 ALPHANUMERIC   03   FILLER                         X(01)
00005 NUMERIC        03   TR-ITEM-NUMBER                 9(05)
00005 GROUP          03   FILLER, REDEFINES TR-ITEM-NUMBER
00001 NUMERIC        05   TR-ITEM-DEPARTMENT             9(01)
00004 NUMERIC        05   FILLER                         9(04)
00001 ALPHANUMERIC   03   FILLER                         X(01)
00005 NUMERIC        03   TR-ITEM-COST                   9(03)V99
00047 ALPHANUMERIC   03   FILLER                         X(47)

00126 FILE                REPORT-FILE

      WORKING-STORAGE SECTION

00001 ALPHANUMERIC   77   END-OF-FILE-SWITCH             X(1)
      CONDITIONAL    88   END-OF-FILE

      REPORT SECTION

00126 GROUP          01   PAGE-HEAD-GROUP
00067 GROUP          02   FILLER
00041 ALPHANUMERIC   03   FILLER                         X(41)
00059 GROUP          02   FILLER
00009 ALPHANUMERIC   03   FILLER                         X(09)
00010 ALPHANUMERIC   03   FILLER                         X(10)
00005 ALPHANUMERIC   03   FILLER                         X(05)
00008 ALPHANUMERIC   03   FILLER                         X(08)
00009 ALPHANUMERIC   03   FILLER                         X(09)

00126 GROUP          01   CHARGE-DETAIL
00057 GROUP          02   FILLER
00004 NUMERIC        03   FILLER                         Z(04)
00016 ALPHANUMERIC   03   FILLER                         X(16)
00001 NUMERIC        03   FILLER                         9(01)
00005 NUMERIC        03   FILLER                         9(05)
00007 NUMERIC        03   FILLER                         $$$$.99


NAME                           DEFINED                REFERENCES

TRANSACTION-DATA               15       25      77      82      93      100
                                                                       x5
TRANSACTION-RECORD             27     referenced by child
TR-CUSTOMER-NUMBER             28       67                             x1
TR-CUSTOMER-NAME               30       68                             x1
TR-ITEM-NUMBER                 32       70                             x1
TR-ITEM-DEPARTMENT             34       69                             x1
TR-ITEM-COST                   37       71                             x1

REPORT-FILE                    19       40     *78      94             x3

END-OF-FILE-SWITCH             44      *84     *102                    x2
END-OF-FILE                    45       88                             x1

PAGE-HEAD-GROUP                54     not referenced
CHARGE-DETAIL                  65       99                             x1


LABEL                          DEFINED                REFERENCES

E prog                         75
P 000-INITIATE                 75     not referenced
P 000-TERMINATE                90     not referenced
P 100-PROCESS-TRANSACTION-DATA 98       87                             x1
P 199-EXIT                     105      87                             x1

0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog1.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([huge REPLACE])
AT_KEYWORDS([listing])

AT_CAPTURE_FILE([prog.lst])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.

           REPLACE ==111111111111111111111111111111111111111==
              BY =='
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    ' '==.


           DISPLAY 111111111111111111111111111111111111111
           DISPLAY 111111111111111111111111111111111111111
           DISPLAY 111111111111111111111111111111111111111

           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog1.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY 

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         ENVIRONMENT DIVISION.
000005         CONFIGURATION SECTION.
000006         DATA             DIVISION.
000007         WORKING-STORAGE  SECTION.
000008         PROCEDURE        DIVISION.
000009
000010             REPLACE ==111111111111111111111111111111111111111==
000011                BY =='
000012        -    '
000013        -    '
000014        -    '
000015        -    '
000016        -    '
000017        -    '
000018        -    '
000019        -    '
000020        -    '
000021        -    '
000022        -    '
000023        -    '
000024        -    '
000025        -    '
000026        -    '
000027        -    '
000028        -    '
000029        -    '
000030        -    '
000031        -    '
000032        -    '
000033        -    '
000034        -    '
000035        -    '
000036        -    '
000037        -    '
000038        -    '
000039        -    '
000040        -    '
000041        -    '
000042        -    '
000043        -    '
000044        -    '
000045        -    '
000046        -    '
000047        -    '
000048        -    '
000049        -    '
000050        -    '
000051        -    '
000052        -    '
000053        -    '
000054        -    '
000055        -    '
000056        -    '
000057        -    '
000058        -    '
000059        -    '
000060        -    '
000061        -    '
000062        -    '
000063        -    '
000064        -    '
000065        -    '
000066        -    '
000067        -    '
000068        -    '
000069        -    '
000070        -    '
000071        -    '
000072        -    '
000073        -    '
000074        -    '
000075        -    '
000076        -    '
000077        -    '
000078        -    '
000079        -    '
000080        -    '
000081        -    '
000082        -    '
000083        -    '
000084        -    '
000085        -    '
000086        -    '
000087        -    '
000088        -    '
000089        -    '
000090        -    '
000091        -    '
000092        -    '
000093        -    '
000094        -    '
000095        -    '
000096        -    '
000097        -    '
000098        -    '
000099        -    '
000100        -    '
000101        -    '
000102        -    '
000103        -    '
000104        -    '
000105        -    '
000106        -    '
000107        -    '
000108        -    '
000109        -    '
000110        -    '
000111        -    '
000112        -    '
000113        -    ' '==.
000114
000115
000116             DISPLAY '
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -
000116+       -                          '
000117             DISPLAY '
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -
000117+       -                          '
000118             DISPLAY '
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -
000118+       -                          '
000119
000120             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog1.lst prog.lis], [0], [], [])

AT_DATA([display.inc], [
           DISPLAY 111111111111111111111111111111111111111
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.

       COPY "display.inc"
           REPLACING ==111111111111111111111111111111111111111==
              BY =='
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    '
      -    ' '==.

           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog2.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         IDENTIFICATION   DIVISION.
000003         PROGRAM-ID.      prog.
000004         ENVIRONMENT DIVISION.
000005         CONFIGURATION SECTION.
000006         DATA             DIVISION.
000007         WORKING-STORAGE  SECTION.
000008         PROCEDURE        DIVISION.
000009
000010         COPY "display.inc"
000011             REPLACING ==111111111111111111111111111111111111111==
000012                BY =='
000013        -    '
000014        -    '
000015        -    '
000016        -    '
000017        -    '
000018        -    '
000019        -    '
000020        -    '
000021        -    '
000022        -    '
000023        -    '
000024        -    '
000025        -    '
000026        -    '
000027        -    '
000028        -    '
000029        -    '
000030        -    '
000031        -    '
000032        -    '
000033        -    '
000034        -    '
000035        -    '
000036        -    '
000037        -    '
000038        -    '
000039        -    '
000040        -    '
000041        -    '
000042        -    '
000043        -    '
000044        -    '
000045        -    '
000046        -    '
000047        -    '
000048        -    '
000049        -    '
000050        -    '
000051        -    '
000052        -    '
000053        -    '
000054        -    '
000055        -    '
000056        -    '
000057        -    '
000058        -    '
000059        -    '
000060        -    '
000061        -    '
000062        -    '
000063        -    '
000064        -    '
000065        -    '
000066        -    '
000067        -    '
000068        -    '
000069        -    '
000070        -    '
000071        -    '
000072        -    '
000073        -    '
000074        -    '
000075        -    '
000076        -    '
000077        -    '
000078        -    '
000079        -    '
000080        -    '
000081        -    '
000082        -    '
000083        -    '
000084        -    '
000085        -    '
000086        -    '
000087        -    '
000088        -    '
000089        -    '
000090        -    '
000091        -    '
000092        -    '
000093        -    '
000094        -    '
000095        -    '
000096        -    '
000097        -    '
000098        -    '
000099        -    '
000100        -    '
000101        -    '
000102        -    '
000103        -    '
000104        -    '
000105        -    '
000106        -    '
000107        -    '
000108        -    '
000109        -    '
000110        -    '
000111        -    '
000112        -    '
000113        -    '
000114        -    ' '==.
000001C
000002C            DISPLAY '
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -
000002+       -                          '
000115
000116             STOP RUN.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog2.lst prog.lis], [0], [], [])

AT_CLEANUP


AT_SETUP([Long concatenated literal])
AT_KEYWORDS([])

AT_DATA([prog.cob], [
       >>SOURCE FORMAT IS FREE
ID DIVISION.
PROGRAM-ID. ED000MAIN IS INITIAL.
DATA DIVISION.
WORKING-STORAGE SECTION.
01 WCOVER PIC X(1280) VALUE
      "          _________             ____________________________________            " &
      "          __  ____/__________  ___  ____/_  __ \__  __ )_  __ \__  /            " &
      "          _  / __ __  __ \  / / /  /    _  / / /_  __  |  / / /_  /             " &
      "          / /_/ / _  / / / /_/ // /___  / /_/ /_  /_/ // /_/ /_  /___           " &
      "          \____/  /_/ /_/\__,_/ \____/  \____/ /_____/ \____/ /_____/           " &
      "                           _________________________                            " &
      "                           ___  ____/__  __ \__  __ \                           " &
      "                           __  __/  __  /_/ /_  /_/ /                           " &
      "                           _  /___  _  _, _/_  ____/                            " &
      "                           /_____/  /_/ |_| /_/                                 " &
      "     /_/  |_|  .___/_  .___//_/  /_/  \___/ \__,_/ \__/ /_/  \____//_/ /_/      " &
      "    /_/     /_/                                                                 " &
      "1234567890123456789012".
PROCEDURE DIVISION.
    EXIT.
])

AT_CHECK([$COMPILE_ONLY -t prog.lst -tlines=0 prog.cob], [0], [], [])

AT_DATA([prog2.lst],
[GnuCOBOL V.R.P               prog.cob                   DDD MMM dd HH:MM:SS YYYY

LINE    PG/LN  A...B............................................................

000001
000002         >>SOURCE FORMAT IS FREE
000003  ID DIVISION.
000004  PROGRAM-ID. ED000MAIN IS INITIAL.
000005  DATA DIVISION.
000006  WORKING-STORAGE SECTION.
000007  01 WCOVER PIC X(1280) VALUE
000008        "          _________             _________________________________
000008+ ___            " &
000009        "          __  ____/__________  ___  ____/_  __ \__  __ )_  __ \__
000009+   /            " &
000010        "          _  / __ __  __ \  / / /  /    _  / / /_  __  |  / / /_
000010+  /             " &
000011        "          / /_/ / _  / / / /_/ // /___  / /_/ /_  /_/ // /_/ /_
000011+ /___           " &
000012        "          \____/  /_/ /_/\__,_/ \____/  \____/ /_____/ \____/ /__
000012+ ___/           " &
000013        "                           _________________________
000013+                " &
000014        "                           ___  ____/__  __ \__  __ \
000014+                " &
000015        "                           __  __/  __  /_/ /_  /_/ /
000015+                " &
000016        "                           _  /___  _  _, _/_  ____/
000016+                " &
000017        "                           /_____/  /_/ |_| /_/
000017+                " &
000018        "     /_/  |_|  .___/_  .___//_/  /_/  \___/ \__,_/ \__/ /_/  \___
000018+ _//_/ /_/      " &
000019        "    /_/     /_/
000019+                " &
000020        "1234567890123456789012".
000021  PROCEDURE DIVISION.
000022      EXIT.


0 warnings in compilation group
0 errors in compilation group
])

AT_CHECK([$UNIFY_LISTING prog.lst prog.lis once], [0], [], [])
AT_CHECK([diff prog2.lst prog.lis], [0], [], [])

AT_CLEANUP
