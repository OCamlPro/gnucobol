## Copyright (C) 2003-2012, 2014-2024 Free Software Foundation, Inc.
## Written by Keisuke Nishida, Roger While, Simon Sobisch, Edward Hart,
## Ron Norman
##
## This file is part of GnuCOBOL.
##
## The GnuCOBOL compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
##
## GnuCOBOL is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with GnuCOBOL.  If not, see <https://www.gnu.org/licenses/>.

### GnuCOBOL Test Suite


AT_SETUP([Comma separator without space])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           DISPLAY 1,1,1 NO ADVANCING
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [111])

AT_CLEANUP


## TODO: Check if the following DECIMAL-POINT tests are really all extensions.


AT_SETUP([DECIMAL-POINT is COMMA (1)])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT    IS COMMA.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 99V99.
       PROCEDURE        DIVISION.
           MOVE FUNCTION MIN (3,,,,,,5) TO X.
           DISPLAY X
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00,50
])

AT_CLEANUP


AT_SETUP([DECIMAL-POINT is COMMA (2)])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT    IS COMMA.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 99V99.
       PROCEDURE        DIVISION.
           MOVE FUNCTION MIN (3,,,,,, 5) TO X.
           DISPLAY X
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[03,00
])

AT_CLEANUP


AT_SETUP([DECIMAL-POINT is COMMA (3)])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT    IS COMMA.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 99V99.
       PROCEDURE        DIVISION.
           MOVE FUNCTION MIN (3,,,,,, 1,5) TO X.
           DISPLAY X
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[01,50
])

AT_CLEANUP


AT_SETUP([DECIMAL-POINT is COMMA (4)])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT    IS COMMA.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 99V99.
       PROCEDURE        DIVISION.
           MOVE FUNCTION MIN (3,,,,,,1,5) TO X.
           DISPLAY X
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00,10
])

AT_CLEANUP


AT_SETUP([DECIMAL-POINT is COMMA (5)])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT    IS COMMA.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 99V99.
       PROCEDURE        DIVISION.
           COMPUTE X=1 + ,1
           END-COMPUTE
           DISPLAY X
           END-DISPLAY.
           COMPUTE X=1*,1
           END-COMPUTE
           DISPLAY X
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[01,10
00,10
])

AT_CLEANUP


AT_SETUP([CURRENCY SIGN])
AT_KEYWORDS([misc fundamental])

AT_DATA([prog.cob], [
       PROGRAM-ID.   prog.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CURRENCY SIGN IS "Y".

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77  amount    pic Y(6)9.99.

       PROCEDURE DIVISION.
           Move 1512.34 to Amount
           Display "Amount is #" Amount '#' with no advancing.

           GOBACK
           .
       END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Amount is #  Y1512.34#])

AT_CLEANUP


AT_SETUP([CURRENCY SIGN WITH PICTURE SYMBOL])
AT_KEYWORDS([misc fundamental])

# FIXME - see FR #246
AT_XFAIL_IF([true])

AT_DATA([prog.cob], [
       PROGRAM-ID.   prog.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           *> note the space after EUR / before ct.
           CURRENCY SIGN IS "EUR "      WITH PICTURE SYMBOL "U",
           CURRENCY SIGN IS " ct (EUR)" WITH PICTURE SYMBOL "c",
           Currency Sign is "$US" with Picture Symbol "$".

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77  EUROS    PIC U99v99.
       77  cents    PIC c9,999.
       77  DOLLARS  Pic $$,$$9.99.

       PROCEDURE DIVISION.
           MOVE 12.34 TO EUROS
           MULTIPLY euros BY 1000 GIVING cents.
           DISPLAY "#" EUROS "# equal #" cents '#'.
           Move 1500 to Invoice-Amount
           Display "Invoice amount #1 is " Invoice-Amount '.'.
           Move 12.34 to Invoice-Amount
           Display "Invoice amount #2 is " Invoice-Amount '.'.

           GOBACK
           .
       END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[#EUR 12.34# equal #1,234 ct (EUR)#
Invoice amount #1 is  $US1,500.00.
Invoice amount #2 is     $US12.34.
])

AT_CLEANUP


AT_SETUP([LOCAL-STORAGE (1)])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 WRK-X         PIC XXX VALUE "abc".
       LOCAL-STORAGE    SECTION.
       01 LCL-X         PIC XXX VALUE "abc".
       PROCEDURE        DIVISION.
           DISPLAY WRK-X LCL-X NO ADVANCING
           END-DISPLAY.
           MOVE ZERO TO WRK-X LCL-X.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee"
           END-CALL.
           CALL "callee"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [abcabc000abc], [])

AT_CLEANUP


AT_SETUP([LOCAL-STORAGE (2)])
AT_KEYWORDS([runmisc])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 LNK-X         PIC XXX.
       PROCEDURE        DIVISION USING LNK-X.
           DISPLAY LNK-X NO ADVANCING.
           EXIT PROGRAM.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LOCAL-STORAGE    SECTION.
       01 LCL-X.
          05 FILLER     PIC XXX VALUE "abc".
       PROCEDURE        DIVISION.
           CALL "callee2" USING LCL-X.
           MOVE ZERO TO LCL-X.
           CALL "callee2" USING LCL-X.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee".
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee2.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [abc000], [])

AT_CLEANUP


AT_SETUP([LOCAL-STORAGE (3)])
AT_KEYWORDS([runmisc OCCURS INDEX INDEXED])

# Note: this tests undefined behaviour, because the initial value
#       of index-names are undefined per standard; where they are
#       explicit defined to be "... treated as a static item [for WS]
#       and as an automatic item [for LS]"; see bug #794
#       for GnuCOBOL that is defined depending on dialect options
#       init-indexed-by and defaultbyte

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 DISP-VALS.
          05 DISP-VAL   PIC 9 VALUE 0.
          05 DISP-IDX   PIC 9 VALUE 0.
       01 WRK-X.
          05 WRK-VAR    PIC 9 VALUE 0 OCCURS 1 INDEXED BY WRK-IDX.
       LOCAL-STORAGE    SECTION.
       01 LCL-X.
          05 LCL-VAR    PIC 9 VALUE 0 OCCURS 1 INDEXED BY LCL-IDX.
       PROCEDURE        DIVISION.
           DISPLAY SPACE WITH NO ADVANCING UPON SYSOUT.
           ADD  1 TO WRK-VAR(1) LCL-VAR(1)
           SET  WRK-IDX, LCL-IDX UP BY 1
           SET  DISP-IDX TO WRK-IDX.
           MOVE WRK-VAR(1) TO DISP-VAL.
           DISPLAY DISP-VALS WITH NO ADVANCING UPON SYSOUT.
           SET  DISP-IDX TO LCL-IDX.
           MOVE LCL-VAR(1) TO DISP-VAL.
           DISPLAY DISP-VALS WITH NO ADVANCING UPON SYSOUT.
           GOBACK.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee".
           CALL "callee".
           CALL "callee".
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ 1212 2312 3412], [])

# same name sometimes leads to locks - especially on Win32
AT_CHECK([mv callee.$COB_MODULE_EXT callee.def.$COB_MODULE_EXT])
AT_CHECK([$COMPILE_MODULE -fdefaultbyte=0 callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ 1111 2211 3311], [])

# note: this is the tested MF result (INDEXED BY are USAGE COMP 9(08), 0-based !):
#AT_CHECK([mv callee.$COB_MODULE_EXT callee.zero.$COB_MODULE_EXT])
#AT_CHECK([$COMPILE_MODULE -std=mf-strict callee.cob], [0], [], [])
#AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ 1018 2117 3216], [])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 DISP-VALS.
          05 DISP-VAL   PIC 9 VALUE 0.
          05 DISP-IDX   PIC 9 VALUE 0.
       01 WRK-X.
          05 WRK-VAR    PIC 9 VALUE 0 OCCURS 1 INDEXED BY WRK-IDX.
       PROCEDURE        DIVISION.
           DISPLAY SPACE WITH NO ADVANCING UPON SYSOUT.
           ADD  1 TO WRK-VAR(1)
           SET  WRK-IDX UP BY 1
           SET  DISP-IDX TO WRK-IDX.
           MOVE WRK-VAR(1) TO DISP-VAL.
           DISPLAY DISP-VALS WITH NO ADVANCING UPON SYSOUT.
           GOBACK.
])


AT_CHECK([mv callee.$COB_MODULE_EXT callee.old.$COB_MODULE_EXT])
AT_CHECK([$COMPILE_MODULE -std=acu-strict callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ 19 20 31], [])
# note: tested result with 2 byte: AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ 15 26 37], [])

AT_CLEANUP


AT_SETUP([EXTERNAL data item])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 EXT-VAR       PIC X(5) EXTERNAL.
       PROCEDURE        DIVISION.
           IF EXT-VAR NOT = "Hello"
              DISPLAY EXT-VAR.
           MOVE "World" TO EXT-VAR.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 EXT-VAR       PIC X(5) EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE "Hello" TO EXT-VAR.
           CALL "callee"
           END-CALL.
           IF EXT-VAR NOT = "World"
              DISPLAY EXT-VAR.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([EXTERNAL AS data item])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 PRG-VAR       PIC X(5) EXTERNAL AS "WRK-VAR".
       01 EXT-VAR       PIC X(5) EXTERNAL.
       PROCEDURE        DIVISION.
           IF PRG-VAR NOT = "Extrn"
              DISPLAY PRG-VAR.
           IF EXT-VAR NOT = "Hello"
              DISPLAY EXT-VAR.
           MOVE "World" TO EXT-VAR.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 MYVAR         PIC X(5) EXTERNAL AS "EXT-VAR".
       01 WRK-VAR       PIC X(5) EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE "Extrn" TO WRK-VAR.
           MOVE "Hello" TO MYVAR.
           CALL "callee"
           END-CALL.
           IF MYVAR NOT = "World"
              DISPLAY MYVAR.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([EXTERNAL data item size mismatch])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 PRG-VAR       PIC X(8) EXTERNAL AS "WRK-VAR".
       01 COB-VAR       PIC X(8) EXTERNAL.
       01 EXT-VAR       PIC X(8) EXTERNAL.
       PROCEDURE        DIVISION.
           IF PRG-VAR NOT = "Extrn"
              DISPLAY 'local named external is not correct: ' PRG-VAR.
           IF COB-VAR NOT = "Hello"
              DISPLAY 'remote named external is not correct: ' COB-VAR.
           MOVE "World" TO EXT-VAR.
           EXIT PROGRAM.
])

AT_DATA([bigger.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      error.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 WRK-VAR       PIC X(10) EXTERNAL.
       01 MYVAR         PIC X(10) EXTERNAL AS "COB-VAR".
       01 EXT-VAR       PIC X(10) EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE "Extrn" TO WRK-VAR
           MOVE "Hello" TO MYVAR
           MOVE SPACES  TO EXT-VAR
           CALL "callee"
           IF EXT-VAR NOT = "World"
              DISPLAY 'simple external back not correct: ' EXT-VAR.
           STOP RUN.
])

AT_DATA([smaller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      error.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 WRK-VAR       PIC X(5) EXTERNAL.
       01 MYVAR         PIC X(5) EXTERNAL AS "COB-VAR".
       01 EXT-VAR       PIC X(5) EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE "Extrn" TO WRK-VAR
           MOVE "Hello" TO MYVAR
           MOVE SPACES  TO EXT-VAR
           CALL "callee"
           IF EXT-VAR NOT = "World"
              DISPLAY 'simple external back not correct: ' EXT-VAR.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE bigger.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./bigger], [0], [], ignore)

AT_CHECK([$COMPILE smaller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./smaller], [1], [], ignore)

# FIXME - messages should be adjusted, see Bug #445
AT_XFAIL_IF([true])

AT_CHECK([$COBCRUN_DIRECT ./bigger], [0], [],
[libcob: callee.cob:6: warning: EXTERNAL item 'WRK-VAR' previously allocated with size 10, requested size is 8
libcob: callee.cob:7: warning: EXTERNAL item 'EXT-VAR' previously allocated with size 10, requested size is 8
libcob: callee.cob:8: warning: EXTERNAL item 'EXT-VAR' previously allocated with size 10, requested size is 8
])

AT_CHECK([$COBCRUN_DIRECT ./smaller], [1], [],
[libcob: callee.cob:6: error: EXTERNAL item 'WRK-VAR' previously allocated with size 5, requested size is 8
])

AT_CLEANUP


## MOVE statement

AT_SETUP([MOVE to itself])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC 99 VALUE 12.
       PROCEDURE        DIVISION.
           MOVE X TO X.
           IF X NOT = 12
              DISPLAY X.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob:8: warning: overlapping MOVE may produce unpredictable results
])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([MOVE with refmod])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC 9(4) VALUE 0.
       PROCEDURE        DIVISION.
           MOVE "1" TO X(1:1).
           IF X NOT = 1000
              DISPLAY X.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([MOVE with refmod (variable)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE "1234".
       01 Y             PIC X(4) VALUE "abcd".
       01 I             PIC 9 VALUE 1.
       PROCEDURE        DIVISION.
           MOVE X(1:I) TO Y.
           IF Y NOT = "1   "
              DISPLAY Y.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([MOVE with group refmod])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
         02 X           PIC 9999 VALUE 1234.
       PROCEDURE        DIVISION.
           MOVE "99" TO G(3:2).
           IF G NOT = "1299"
              DISPLAY G.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([MOVE indexes])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
         02 X           PIC X OCCURS 10 INDEXED I.
       PROCEDURE        DIVISION.
           SET I TO ZERO.
           MOVE I TO X(1).
           IF X(1) NOT = "0"
              DISPLAY X(1).
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], 
[prog.cob:9: warning: SET I TO 0 is out of bounds
])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([MOVE X'00'])
AT_KEYWORDS([runmisc])

AT_DATA([dump.c], [
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
dump (unsigned char *data)
{
  printf ("%02x%02x%02x", data[[0]], data[[1]], data[[2]]);
  return 0;
}
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC XXX.
       PROCEDURE        DIVISION.
           MOVE X"000102" TO X.
           CALL "dump" USING X
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE dump.c], [0], [], [])
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [000102])

AT_CLEANUP


AT_SETUP([MOVE Z'literal'])
AT_KEYWORDS([runmisc literal])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC XXXX.
       01  XRED REDEFINES X.
           03  XBYTE1   PIC X.
           03  XBYTE2   PIC X.
           03  XBYTE3   PIC X.
           03  XBYTE4   PIC X.
       PROCEDURE        DIVISION.
           MOVE Z"012" TO X.
           IF XBYTE1 = "0" AND
              XBYTE2 = "1" AND
              XBYTE3 = "2" AND
              XBYTE4 = LOW-VALUE
              DISPLAY "OK" NO ADVANCING
              END-DISPLAY
           ELSE
              DISPLAY "X = " X (1:3) NO ADVANCING
              END-DISPLAY
              IF XBYTE4 = LOW-VALUE
                 DISPLAY " WITH LOW-VALUE"
                 END-DISPLAY
              ELSE
                 DISPLAY " WITHOUT LOW-VALUE BUT '" XBYTE4 "'"
                 END-DISPLAY
              END-IF
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OK], [])

AT_CLEANUP


AT_SETUP([Floating continuation indicator])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY "OK"-
            "OK"
             NO ADVANCING
           END-DISPLAY
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OKOK])

AT_CLEANUP


AT_SETUP([Fixed continuation indicator])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(333) VALUE
           '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWX
      -    'YZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUV
      -    'WXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRST
      -    'UVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQR
      -    'STUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP
      -             'QRSTUVWXYZ'.
       PROCEDURE        DIVISION.
           DISPLAY X NO ADVANCING
           END-DISPLAY.
           DISPLAY '_'
           END-DISPLAY.
           MOVE
           "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567
      -    "89abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345
      -    "6789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123
      -    "456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01
      -     "23456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXY
      -                                                               "Z
      -             "0123456789" TO X.
           DISPLAY X NO ADVANCING
           END-DISPLAY.
           DISPLAY '_'
           END-DISPLAY.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ                       _
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789                       _
])

AT_CLEANUP


AT_SETUP([Concatenation operator])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 STR           PIC X(05).
       PROCEDURE        DIVISION.
           MOVE "OK" & " "
            & "OK"
             TO STR
           DISPLAY STR NO ADVANCING
           END-DISPLAY
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OK OK])

AT_CLEANUP


AT_SETUP([SOURCE FIXED/FREE directives])
AT_KEYWORDS([runmisc SOURCEFORMAT FIXED FREE])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       >>SOURCE FREE
   DATA             DIVISION.
   WORKING-STORAGE  SECTION.
   >>SOURCE FIXED
       PROCEDURE        DIVISION.                                       FIXED
             DISPLAY "OK" NO ADVANCING
             END-DISPLAY.
       >>SOURCE FREE
                                                                        DISPLAY
   "OK"
 NO ADVANCING
   END-DISPLAY.
   >>SET SOURCEFORMAT "FIXED"
             DISPLAY "OK" NO ADVANCING                                  FIXED
             END-DISPLAY.
       >>SET SOURCEFORMAT "FREE"
                                                                        DISPLAY
   "OK"
 NO ADVANCING
   END-DISPLAY.
             STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[OKOKOKOK])

AT_CLEANUP


AT_SETUP([TURN directive])
AT_KEYWORDS([runmisc BOUND NOBOUND directives])

# note: we only check here that the TURN directive applies
#       for more general tests, including command line options
#       and extension directives, see run_subscript.at, run_refmod.at

AT_DATA([prog.cob], [
       >>TURN EC-BOUND-SUBSCRIPT CHECKING ON
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  x VALUE "12345!".
           03  y PIC X OCCURS 5 TIMES.
           03  z PIC X.
       01  idx PIC 99 VALUE 6.

       PROCEDURE DIVISION.
       >>TURN EC-BOUND-SUBSCRIPT CHECKING OFF
           DISPLAY y (idx) WITH NO ADVANCING
       >>TURN EC-BOUND-SUBSCRIPT CHECKING ON WITH LOCATION
       >>TURN EC-BOUND, EC-PROGRAM CHECKING OFF
           DISPLAY y (idx) WITH NO ADVANCING
       >>TURN EC-BOUND-SUBSCRIPT CHECKING ON
           DISPLAY y (idx) WITH NO ADVANCING
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [!!],
[libcob: prog.cob:20: error: subscript of 'y' out of bounds: 6
note: maximum subscript for 'y': 5
])

AT_CLEANUP


## OCCURS clause

AT_SETUP([OCCURS on level 01])
AT_KEYWORDS([runmisc toplevel
VALUE SET ADDRESS BOUND DEPENDING ODO])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X OCCURS 10 VALUE "A".
       LINKAGE SECTION.
       01 X-ALL         PIC X(10).
       PROCEDURE        DIVISION.
           INITIALIZE   X(1) X(3) X(5) X(7)
           MOVE ZERO TO X(2) X(4) X(6) X(8)
           SET ADDRESS OF X-ALL TO ADDRESS OF X(1)
           IF X-ALL NOT = " 0 0 0 0AA"
              DISPLAY X-ALL UPON SYSERR.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 XX PIC 99 VALUE 5.
       01 X             PIC X OCCURS 0 TO 10
                        DEPENDING ON XX VALUE "A".
       LINKAGE SECTION.
       01 X-ALL         PIC X(10).
       PROCEDURE        DIVISION.
           MOVE ZERO TO X(2) X(4) X(6) X(8)
           INITIALIZE   X(1) X(3) X(5) X(7)
           SET ADDRESS OF X-ALL TO ADDRESS OF X(1)
           IF X-ALL NOT = " 0 0 0 0AA"
              DISPLAY X-ALL UPON SYSERR.
           STOP RUN.
])

AT_CHECK([$COMPILE -fno-ec=bound -o baddy2 prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./baddy2], [0], [], [])

AT_CHECK([$COMPILE prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [1], [],
[libcob: prog2.cob:12: error: subscript of 'X' out of bounds: 6
note: current maximum subscript for 'X': 5
])

AT_DATA([prog3.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog3.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 XX PIC 99 VALUE 5.
       01 X             PIC X OCCURS 0 TO 10
                        DEPENDING ON XX VALUE "A".
       LINKAGE SECTION.
       01 X-ALL         PIC X(10).
       PROCEDURE        DIVISION.
           INITIALIZE   X(1) X(3) X(5) X(7)
           MOVE ZERO TO X(2) X(4) X(6) X(8)
           SET ADDRESS OF X-ALL TO ADDRESS OF X(1)
           IF X-ALL NOT = " 0 0 0 0AA"
              DISPLAY X-ALL UPON SYSERR.
           STOP RUN.
])

AT_CHECK([$COMPILE -fno-ec=bound -o baddy3 prog3.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./baddy3], [0], [], [])

AT_CHECK([$COMPILE prog3.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog3], [1], [],
[libcob: prog3.cob:12: error: subscript of 'X' out of bounds: 7
note: current maximum subscript for 'X': 5
])

AT_CLEANUP


## Expressions

AT_SETUP([Class check with reference-modification])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(6) VALUE "123   ".
       PROCEDURE        DIVISION.
           IF X(1:3) NUMERIC
              STOP RUN.
           DISPLAY "NG" NO ADVANCING.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Index and parenthesized expression])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G.
         02 X           PIC X OCCURS 1 INDEXED BY I.
       PROCEDURE        DIVISION.
         IF I < (I + 2)
           DISPLAY "OK" NO ADVANCING.
         STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OK], [])

AT_CLEANUP


AT_SETUP([Alphanumeric and binary numeric])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X-X           PIC XXXX VALUE "0001".
       01 X-9           PIC 9999 COMP VALUE 1.
       PROCEDURE        DIVISION.
         IF X-X NOT = X-9
            DISPLAY "NG X-X <> X-9".
         IF X-9 NOT = X-X
            DISPLAY "NG X-9 <> X-X".
         STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Non-numeric data in numeric items])

AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X.
          03 X-NUM      PIC 9(06) VALUE 123.
       77 NUM           PIC 9(06).
       PROCEDURE        DIVISION.
           MOVE x"0000" TO X (2:2)
           IF X-NUM NUMERIC
              DISPLAY "low-value is numeric" UPON SYSERR.
           MOVE x"01" TO X (3:1)
           IF X-NUM NUMERIC
              DISPLAY "SOH is numeric" UPON SYSERR.
           MOVE X-NUM TO NUM
           DISPLAY "test over"
      *
           GOBACK.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X.
          03 X-NUM      PIC 9(06) PACKED-DECIMAL VALUE 123.
       77 NUM           PIC 9(06).
       PROCEDURE        DIVISION.
           MOVE x"0A" TO X (2:1)
           IF X-NUM NUMERIC
              DISPLAY "bad prog".
           MOVE X-NUM TO NUM
           DISPLAY "test over"
      *
           GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBC -x -o unchecked_prog prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./unchecked_prog], [0],
[test over
], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:16: error: 'X-NUM' (Type: NUMERIC DISPLAY) not numeric: '0\000\001123'
])

AT_CHECK([$COMPILE prog2.cob], [0], [], [])
AT_CHECK([$COBC -x -o unchecked_prog2 prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./unchecked_prog2], [0],
[test over
], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [1], [],
[[libcob: prog2.cob:13: error: 'X-NUM' (Type: PACKED-DECIMAL (unsigned)) not numeric: '0x000a123f'
]])

AT_CLEANUP


AT_SETUP([MOVE of invalid data from numeric to alphanumeric item])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77 X-NUM                 PIC 9.
       77 X-ALN REDEFINES X-NUM PIC X.
       77 Y-ALN                 PIC X.
       77 Z-NUM                 PIC +9,9.
       77 Z-ALN REDEFINES Z-NUM PIC XX.
       77 T-ALN                 PIC XX.
       PROCEDURE DIVISION.
       MAIN.
           MOVE SPACES TO X-ALN
           MOVE X-NUM  TO Y-ALN
	   IF Y-ALN NOT EQUAL " " THEN
	      DISPLAY "Y-ALN: '" Y-ALN "' (' ' EXPECTED)"
	   END-IF
           MOVE SPACES TO Z-ALN
           MOVE Z-NUM  TO T-ALN
	   IF T-ALN NOT EQUAL "  " THEN
	      DISPLAY "T-ALN: '" T-ALN "' ('  ' EXPECTED)"
	   END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


## CALL statement

AT_SETUP([Dynamic call with static linking])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       PROCEDURE        DIVISION.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE -c callee.cob], [0], [], [])
AT_CHECK([$COMPILE -c caller.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.$COB_OBJECT_EXT callee.$COB_OBJECT_EXT], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE -o prog2 caller.cob callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0], [], [])

AT_CLEANUP


AT_SETUP([Static call with static linking])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       PROCEDURE        DIVISION.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL STATIC "callee"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE -c callee.cob], [0], [], [])
AT_CHECK([$COMPILE -c caller.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.$COB_OBJECT_EXT callee.$COB_OBJECT_EXT], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE -o prog2 -fstatic-call caller.cob callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0], [], [])
AT_CHECK([$COMPILE -o prog3 caller.cob callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog3], [0], [], [])

AT_CLEANUP


AT_SETUP([Dynamic CALL with ON EXCEPTION])

AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee1" ON EXCEPTION
              CALL "callee2" ON EXCEPTION
                  DISPLAY "neither calee1 nor callee2 found"
              END-CALL
           END-CALL
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           DISPLAY "this is callee2" NO ADVANCING
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0],
[this is callee2], [])

AT_CLEANUP


AT_SETUP([Static CALL with ON EXCEPTION])

AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee1" ON EXCEPTION
              CALL "callee2" ON EXCEPTION
                  DISPLAY "neither calee1 nor callee2 found"
              END-CALL
           END-CALL
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           DISPLAY "this is callee2" NO ADVANCING
           GOBACK.
])


AT_CHECK([$COMPILE_MODULE -c callee2.cob], [0], [], [])
AT_CHECK([$COMPILE -c caller.cob], [0], [], [])
AT_CHECK([$COMPILE -o prog caller.$COB_OBJECT_EXT callee2.$COB_OBJECT_EXT], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[this is callee2], [])
AT_CHECK([$COMPILE -o prog2 -fstatic-call caller.cob callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0],
[this is callee2], [])
AT_CHECK([$COMPILE -o prog3 caller.cob callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog3], [0],
[this is callee2], [])

AT_CLEANUP


AT_SETUP([CALL m1. CALL m2. CALL m1.])
AT_KEYWORDS([runmisc])

AT_DATA([m1.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      m1.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC 9(4).
       PROCEDURE        DIVISION.
           COMPUTE X = 1 + 2
           END-COMPUTE.
           IF X NOT = 3
              DISPLAY X.
])

AT_DATA([m2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      m2.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC 9(4).
       PROCEDURE        DIVISION.
           COMPUTE X = 3 + 4
           END-COMPUTE.
           IF X NOT = 7
              DISPLAY X.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "m1"
           END-CALL.
           CALL "m2"
           END-CALL.
           CALL "m1"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE m1.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE m2.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([Recursive CALL of RECURSIVE program])
AT_KEYWORDS([runmisc CANCEL EXTERNAL])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller IS RECURSIVE.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC S9 EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE 0 TO STOPPER
           CALL "callee"
           DISPLAY 'OK' NO ADVANCING END-DISPLAY
      *> FIXME: CANCEL broken on special environments
      *>   CANCEL "callee" , "callee2"
           DISPLAY ' + FINE' NO ADVANCING END-DISPLAY
           STOP RUN.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee IS RECURSIVE.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC S9 EXTERNAL.
       PROCEDURE        DIVISION.
           IF STOPPER = 9
              MOVE -1 TO STOPPER
           ELSE
              ADD   1 TO STOPPER
              CALL "callee2"
           END-IF
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2 IS RECURSIVE.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC S9 EXTERNAL.
       PROCEDURE        DIVISION.
           IF STOPPER NOT EQUAL -1
             CALL "callee"
           END-IF
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [OK + FINE], [])

AT_CLEANUP


AT_SETUP([Recursive CALL of INITIAL program])
AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE 0 TO STOPPER
           CALL "callee" END-CALL.
           GOBACK.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee IS INITIAL.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           IF STOPPER = 1
              DISPLAY 'INITIAL prog was called RECURSIVE'
              END-DISPLAY
              STOP RUN RETURNING 1
           ELSE
              MOVE 1 TO STOPPER
              CALL "callee2" END-CALL
           END-IF.
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           CALL "callee" END-CALL.
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: callee2.cob:5: error: invalid recursive COBOL CALL to 'callee2'
])
# TODO: check merge state from 3.1 later, seems fine
#[libcob: callee2.cob:5: error: recursive CALL from 'callee2' to 'callee' which is NOT RECURSIVE
#])

AT_CLEANUP


AT_SETUP([Recursive CALL with RECURSIVE assumed])
AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE 0 TO STOPPER
           CALL "callee" END-CALL.
           GOBACK.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee IS INITIAL.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           IF STOPPER = 8
              DISPLAY 'OK' NO ADVANCING END-DISPLAY.
           IF STOPPER NOT = 9
              ADD  1 TO STOPPER END-ADD
              CALL "callee2" END-CALL.
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           CALL "callee" END-CALL.
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE -fno-recursive-check callee.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE -fno-recursive-check callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [OK], [])

AT_CLEANUP


AT_SETUP([Recursive CALL with ON EXCEPTION])
AT_KEYWORDS([runmisc EXCEPTION-STATUS])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           MOVE 0 TO STOPPER
           CALL "callee" END-CALL.
           GOBACK.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee IS INITIAL.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77  STOPPER      PIC 9 EXTERNAL.
       PROCEDURE        DIVISION.
           IF STOPPER = 1
              DISPLAY 'INITIAL prog was called RECURSIVE'
              END-DISPLAY
              STOP RUN RETURNING 1
           ELSE
              MOVE 1 TO STOPPER
              CALL "callee2" END-CALL
           END-IF.
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           CALL "callee"
           ON EXCEPTION
              DISPLAY "Exception " FUNCTION EXCEPTION-STATUS ";"
                 UPON SYSERR
              STOP RUN RETURNING 1
           END-CALL.
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[Exception EC-PROGRAM-RECURSIVE-CALL      ;
])

AT_CLEANUP


AT_SETUP([Multiple calls of INITIAL program])
AT_KEYWORDS([runmisc CALL])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  PARAM1       PIC X(08).
       01  PARAM2       PIC 9999 COMP VALUE 08.
       PROCEDURE        DIVISION.
           MOVE ' PARAM 1' TO PARAM1
           PERFORM 10 TIMES
              CALL "callee" USING PARAM1 PARAM2 END-CALL
           END-PERFORM
           DISPLAY 'PARAM1 = ' PARAM1
           END-DISPLAY
           STOP RUN.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee IS INITIAL.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  COUNTER      PIC 999 VALUE ZERO.
       01  LPARAM       PIC 9(8) COMP.
       01  WS-TEMP      PIC 9(8)V99.
       01  PRICE-LOW    PIC 9(3)V99 VALUE 10.50.
       LINKAGE SECTION.
       01  PARAM1       PIC X(08).
       01  PARAM2       PIC 9999 COMP.
       PROCEDURE        DIVISION USING PARAM1 PARAM2.
           ADD 1 TO COUNTER END-ADD
           MOVE 1.10 TO WS-TEMP.
           MULTIPLY PRICE-LOW BY WS-TEMP GIVING WS-TEMP.
           CALL 'C$PARAMSIZE' USING 1 GIVING LPARAM END-CALL
           DISPLAY 'COUNTER = ' COUNTER ' LPARAM1 = ' LPARAM
                   ' PARAM1 = ' PARAM1
           END-DISPLAY
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
COUNTER = 001 LPARAM1 = 00000008 PARAM1 =  PARAM 1
PARAM1 =  PARAM 1
])

AT_CLEANUP


AT_SETUP([CALL binary literal parameter/LENGTH OF])
AT_KEYWORDS([runmisc])

AT_DATA([dump.c], [
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
dump (unsigned char *p)
{
  if ( *p == 0 ) p++;
  if ( *p == 0 ) p++;	/* Skip leading bytes for BIG Endian value */
  if ( *p == 0 ) p++;
  printf ("%8.8d\n", *p);
  return 0;
}
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  MYOCC        PIC 9(8) COMP.
       01  MYTAB.
           03  MYBYTE   PIC X OCCURS 1 TO 20
                        DEPENDING ON MYOCC.
       PROCEDURE        DIVISION.
           MOVE 9 TO MYOCC.
           CALL "dump" USING BY CONTENT 1
           END-CALL.
           CALL "dump" USING BY CONTENT LENGTH OF MYTAB
           END-CALL.
           CALL "dump" USING BY CONTENT LENGTH OF MYOCC
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE dump.c], [0], [], [])
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[00000001
00000009
00000004
])
AT_CHECK([$COMPILE -fbinary-byteorder=native prog.cob -o prog2], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0],
[00000001
00000009
00000004
])

AT_CLEANUP


AT_SETUP([CALL binary literal])
AT_KEYWORDS([CALL])

AT_DATA([prog.cob], [       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       PROCEDURE DIVISION.
           CALL "SUB" USING 1280 BY VALUE 15.
           CALL "SUB" USING 2560 BY VALUE 16.
           STOP RUN.
        END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. "SUB".

       DATA DIVISION.
       LINKAGE SECTION.
       01  x  PIC 9(9) COMP.
       01  y  PIC 9(9) COMP-5.

       PROCEDURE DIVISION USING x, VALUE y.
            DISPLAY "COBOL: X is " x " and Y is " y.
       END PROGRAM "SUB".
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[COBOL: X is 000001280 and Y is 0000000015
COBOL: X is 000002560 and Y is 0000000016
], [])

AT_CLEANUP


## INSPECT

AT_SETUP([INSPECT REPLACING LEADING ZEROS BY SPACES])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE "0001".
       PROCEDURE        DIVISION.
           INSPECT X REPLACING LEADING ZEROS BY SPACES.
           IF X NOT = "   1"
              DISPLAY "Should be '   1' but is '" X "'".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT: no repeat conversion])
AT_KEYWORDS([runmisc INSPECT])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE "BCA".
       01 Y             PIC X(6) VALUE "   BCA".
       PROCEDURE        DIVISION.
           INSPECT X CONVERTING "ABC" TO "BCD".
           IF X NOT = "CDB"
              DISPLAY "X: " X.
           INSPECT Y CONVERTING "ABC" TO "BCD".
           IF Y NOT = "   CDB"
              DISPLAY "Y: " Y.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([TRANSFORM statement])
AT_KEYWORDS([runmisc CONVERTING ALPHABET])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           ALPHABET MY-ASCII  IS STANDARD-1.
           ALPHABET MY-EBCDIC IS EBCDIC.

       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE "BCA".
       PROCEDURE        DIVISION.
      *> internally: "alias" to INSPECT CONVERTING
           TRANSFORM X FROM "ABC" TO "BCD".
           IF X NOT = "CDB"
              DISPLAY "X: " X.
      *> optional CHARACTERS and ALPHABETs (value test is separate)
           TRANSFORM X CHARACTERS FROM MY-ASCII TO MY-EBCDIC.
      *>
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT CONVERTING alphabet])
AT_KEYWORDS([runmisc ASCII EBCDIC])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. charset.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           ALPHABET ALPHA IS ASCII.
           ALPHABET BETA  IS EBCDIC.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 TESTHEX PIC X(10) VALUE X'C17BD6F2F0F1F8406A5A'.

       procedure division.
       sample-main.

           INSPECT testhex CONVERTING BETA TO ALPHA
           DISPLAY 'Converted: "' TESTHEX '"' WITH NO ADVANCING

           GOBACK.
       END PROGRAM charset.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Converted: "A#O2018 |!"], [])

# For characters above IBM (with irregularities) and GCOS should match:
AT_CHECK([$COMPILE prog.cob -febcdic-table=ebcdic500_ascii7bit -o prog-ibm], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog-ibm], [0],
[Converted: "A#O2018 |@:>@"], []) # prefix is actually "|]" (escaped for m4 preproc)

AT_CHECK([$COMPILE prog.cob -febcdic-table=ebcdic500_ascii8bit -o prog-gcos], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog-gcos], [0],
[Converted: "A#O2018 |@:>@"], []) # prefix is actually "|]" (escaped for m4 preproc)

# FIXME: This really does not convert to anything close to ASCII;
# what's this table supposed to encode?
# AT_CHECK([$COMPILE prog.cob -febcdic-table=RESTRICTED-GC -o prog-rgc], [0], [], [])
# AT_CHECK([$COBCRUN_DIRECT ./prog-rgc], [0], [])

AT_CLEANUP


AT_SETUP([INSPECT CONVERTING TO figurative constant])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE "BCA".
       PROCEDURE        DIVISION.
           INSPECT X CONVERTING "ABC" TO SPACES.
           IF X NOT = SPACES
              DISPLAY X.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT CONVERTING NULL])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE LOW-VALUES.
       PROCEDURE        DIVISION.
           INSPECT X CONVERTING NULL TO "A".
           IF X NOT = "AAA"
              DISPLAY X.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT CONVERTING TO NULL])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE "AAA".
       PROCEDURE        DIVISION.
           INSPECT X CONVERTING "A" TO NULL
           IF X NOT = LOW-VALUES
              DISPLAY "NG".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT CONVERTING complex])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(12) VALUE "AZABBCDCCECC".
       PROCEDURE        DIVISION.
           INSPECT X CONVERTING "ABZC" TO "ZY0X"
           IF X NOT = "Z0ZYYXDXXEXX"
              DISPLAY "1 - " X
              MOVE "Z0ZYYXDXXEXX" TO X.

           INSPECT X CONVERTING "XD" TO SPACES
              BEFORE  "E" AFTER "D"
           IF X NOT = "Z0ZYYXD  EXX"
              DISPLAY "2 - " X
              MOVE "Z0ZYYXD  EXX" TO X.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([INSPECT numeric signed])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 SEPARATE1     PIC S99 VALUE -11 SIGN LEADING  SEPARATE.
       01 SEPARATE2     PIC S99 VALUE +11 SIGN LEADING  SEPARATE.
       01 TSEPARATE1    PIC S99 VALUE -11 SIGN TRAILING SEPARATE.
       01 TSEPARATE2    PIC S99 VALUE +11 SIGN TRAILING SEPARATE.
       01 NSEPARATE1    PIC S99 VALUE -11.
       01 NSEPARATE2    PIC S99 VALUE +11.
       01 TRAILING1     PIC S99 VALUE -11 SIGN TRAILING.
       01 TRAILING2     PIC S99 VALUE +11 SIGN TRAILING.
       77 CNT           USAGE BINARY-INT.
       PROCEDURE        DIVISION.
           MOVE 0 TO CNT
           INSPECT SEPARATE1  TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T1 - " CNT.
           MOVE 0 TO CNT
           INSPECT SEPARATE2  TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T2 - " CNT.
           MOVE 0 TO CNT
           INSPECT TSEPARATE1 TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T3 - " CNT.
           MOVE 0 TO CNT
           INSPECT TSEPARATE2 TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T4 - " CNT.
           MOVE 0 TO CNT
           INSPECT NSEPARATE1 TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T5 - " CNT.
           MOVE 0 TO CNT
           INSPECT NSEPARATE2 TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T6 - " CNT.
           MOVE 0 TO CNT
           INSPECT TRAILING1  TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T7 - " CNT.
           MOVE 0 TO CNT
           INSPECT TRAILING2  TALLYING CNT FOR ALL "1"
           IF CNT NOT = 2
              DISPLAY "T8 - " CNT.

           INSPECT SEPARATE1  CONVERTING "123" TO "234"
           IF SEPARATE1 NOT = -22
              DISPLAY "C1 - " SEPARATE1
              MOVE -22 TO SEPARATE1.
           INSPECT SEPARATE2  CONVERTING "123" TO "234"
           IF SEPARATE2 NOT = +22
              DISPLAY "C2 - " SEPARATE2
              MOVE +22 TO SEPARATE2.
           INSPECT TSEPARATE1 CONVERTING "123" TO "234"
           IF TSEPARATE1 NOT = -22
              DISPLAY "C3 - " TSEPARATE1
              MOVE -22 TO TSEPARATE1.
           INSPECT TSEPARATE2 CONVERTING "123" TO "234"
           IF TSEPARATE2 NOT = +22
              DISPLAY "C4 - " TSEPARATE2
              MOVE +22 TO TSEPARATE2.
           INSPECT NSEPARATE1 CONVERTING "123" TO "234"
           IF NSEPARATE1 NOT = -22
              DISPLAY "C5 - " NSEPARATE1
              MOVE -22 TO NSEPARATE1.
           INSPECT NSEPARATE2 CONVERTING "123" TO "234"
           IF NSEPARATE2 NOT = +22
              DISPLAY "C6 - " NSEPARATE2
              MOVE +22 TO NSEPARATE2.
           INSPECT TRAILING1  CONVERTING "123" TO "234"
           IF TRAILING1 NOT = -22
              DISPLAY "C7 - " TRAILING1
              MOVE -22 TO TRAILING1.
           INSPECT TRAILING2  CONVERTING "123" TO "234"
           IF TRAILING2 NOT = +22
              DISPLAY "C8 - " TRAILING2
              MOVE +22 TO TRAILING2.

           INSPECT SEPARATE1  REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF SEPARATE1 NOT = -33
              DISPLAY "R1 - " SEPARATE1
              MOVE -33 TO SEPARATE1.
           INSPECT SEPARATE2  REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF SEPARATE2 NOT = +33
              DISPLAY "R2 - " SEPARATE2
              MOVE +33 TO SEPARATE2.
           INSPECT TSEPARATE1 REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF TSEPARATE1 NOT = -33
              DISPLAY "R3 - " TSEPARATE1
              MOVE -33 TO TSEPARATE1.
           INSPECT TSEPARATE2 REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF TSEPARATE2 NOT = +33
              DISPLAY "R4 - " TSEPARATE2
              MOVE +33 TO TSEPARATE2.
           INSPECT NSEPARATE1 REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF NSEPARATE1 NOT = -33
              DISPLAY "R5 - " NSEPARATE1
              MOVE -33 TO NSEPARATE1.
           INSPECT NSEPARATE2 REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF NSEPARATE2 NOT = +33
              DISPLAY "R6 - " NSEPARATE2
              MOVE +33 TO NSEPARATE2.
           INSPECT TRAILING1  REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF TRAILING1 NOT = -33
              DISPLAY "R7 - " TRAILING1
              MOVE -33 TO TRAILING1.
           INSPECT TRAILING2  REPLACING ALL "1" BY "2"
                                            "2" BY "3"
                                            "3" BY "4"
           IF TRAILING2 NOT = +33
              DISPLAY "R8 - " TRAILING2
              MOVE +33 TO TRAILING2.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([INSPECT TALLYING BEFORE])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE "ABC ".
       01 TAL           PIC 999 VALUE 0.
       PROCEDURE        DIVISION.
           MOVE 0 TO TAL.
           INSPECT X TALLYING TAL FOR CHARACTERS
                     BEFORE INITIAL " ".
           IF TAL NOT = 3
              DISPLAY "1: should be 3 but is " TAL.

           MOVE 0 TO TAL.
           MOVE " ABC" TO X.
           INSPECT X TALLYING TAL FOR CHARACTERS
                     BEFORE INITIAL " ".
           IF TAL NOT = 0
              DISPLAY "2: should be 0 but is " TAL.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT TALLYING AFTER])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE "ABC ".
       01 TAL           PIC 999 VALUE 0.
       PROCEDURE        DIVISION.
           MOVE 0 TO TAL.
           INSPECT X TALLYING TAL FOR CHARACTERS
                     AFTER INITIAL " ".
           IF TAL NOT = 0
              DISPLAY TAL.

           MOVE 0 TO TAL.
           MOVE " ABC" TO X.
           INSPECT X TALLYING TAL FOR CHARACTERS
                     AFTER INITIAL " ".
           IF TAL NOT = 3
              DISPLAY TAL.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT TALLYING BEFORE and AFTER])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE "ABC ".
       01 TAL           PIC 999 VALUE 0.
       01 MSG           PIC X(256) VALUE SPACES.
       PROCEDURE        DIVISION.
           MOVE 0 TO TAL.
           INSPECT X TALLYING TAL FOR CHARACTERS
                     BEFORE INITIAL " "
                     AFTER   " ".
           IF TAL NOT = 0
              DISPLAY "1: should be 0 but is " TAL.

      *> checking for no match, includes bug #865
           MOVE 0 TO TAL.
           INSPECT MSG TALLYING TAL FOR CHARACTERS
               AFTER INITIAL "<"
               BEFORE INITIAL "</".
           IF TAL NOT = 0
              DISPLAY "2: should be 0 but is " TAL.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT TALLYING REPLACING BEFORE and AFTER])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  INSP-STRING   PIC X(26) VALUE 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.
       01  EXPTD-RESULT  CONSTANT AS     'A22222111111111122222222YZ'.
       01  RES-IDX       PIC 9(04) BINARY VALUE 100.
       01  RES-IDX-1     PIC 9(04) BINARY VALUE 0.
       PROCEDURE DIVISION.
      *>
           INSPECT INSP-STRING
                   TALLYING RES-IDX   FOR CHARACTERS BEFORE 'H'
                            RES-IDX-1 FOR CHARACTERS AFTER  'B'
             REPLACING
                   CHARACTERS BY '1' AFTER 'F' BEFORE 'Q'
                   CHARACTERS BY '2' AFTER 'A' BEFORE 'Y'.
      *>
           IF INSP-STRING NOT = EXPTD-RESULT
               DISPLAY 'Failed <' INSP-STRING '> != <' EXPTD-RESULT '>'.
           IF RES-IDX NOT = 107
               DISPLAY 'Failed <' RES-IDX   '> != <107>'.
           IF RES-IDX-1 NOT = 19
               DISPLAY 'Failed <' RES-IDX-1 '> != <19>'.
      *>
           GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([INSPECT REPLACING figurative constant])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(3) VALUE "BCA".
       PROCEDURE        DIVISION.
           INSPECT X REPLACING ALL "BC" BY SPACE.
           IF X NOT = "  A"
              DISPLAY X.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP

# Note: more INSPECT for "TRAILING" and EXAMINE in run_extensions.at


AT_SETUP([SWITCHES (environment COB_SWITCH_n and SET)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           SWITCH-1 IS SWIT1
             ON  IS SWIT1-ON
             OFF IS SWIT1-OFF
           SWITCH-2 IS SWIT2
             ON  IS SWIT2-ON
             OFF IS SWIT2-OFF
           SWITCH-3
             ON  IS SWIT3-ON
             OFF IS SWIT3-OFF
           SWITCH-4 IS SWIT4
             OFF IS SWIT4-OFF
           SWITCH-31
             ON  IS SWIT31-ON
           SWITCH-36 IS SWIT36
             OFF IS SWIT36-OFF.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           IF SWIT1-ON
              DISPLAY "ON" NO ADVANCING
           ELSE
              DISPLAY "OFF" NO ADVANCING.

           IF SWIT2-ON
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           IF SWIT3-ON
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           IF NOT SWIT4-OFF
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           SET SWIT1 TO OFF.
           SET SWIT2 TO ON.
           IF SWIT1-ON
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           IF SWIT2-ON
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           IF SWIT31-ON
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           IF NOT SWIT36-OFF
              DISPLAY " ON" NO ADVANCING
           ELSE
              DISPLAY " OFF" NO ADVANCING.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([COB_SWITCH_1=1 COB_SWITCH_2=0 COB_SWITCH_3=OFF COB_SWITCH_4=ON COB_SWITCH_36=ON ./prog], [0],
[ON OFF OFF ON OFF ON OFF ON])

AT_CLEANUP


## PERFORM

AT_SETUP([Nested PERFORM])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           PERFORM 2 TIMES
             DISPLAY "X" NO ADVANCING
             END-DISPLAY
             PERFORM 2 TIMES
               DISPLAY "Y" NO ADVANCING
             END-PERFORM
           END-PERFORM.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [XYYXYY])

AT_CLEANUP


AT_SETUP([PERFORM VARYING BY -0.2 decimal])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 X             PIC 9v9.
       PROCEDURE        DIVISION.
           PERFORM VARYING X FROM 0.8 BY -0.2
                   UNTIL   X < 0.4
             DISPLAY "X" NO ADVANCING
           END-PERFORM.
           IF X NOT = 0.2
             DISPLAY "WRONG X: " X END-DISPLAY
           END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [XXX])

AT_CLEANUP


AT_SETUP([PERFORM VARYING Float])
AT_KEYWORDS([perform])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  i USAGE FLOAT-LONG.

       PROCEDURE DIVISION.
           PERFORM VARYING i FROM 1.0 BY 1.0 UNTIL i > 5.0
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 1 Completed".
           PERFORM VARYING i FROM 1 BY 1 UNTIL i > 5
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 2 Completed".
           PERFORM VARYING i FROM 5 BY -1 UNTIL i < 1
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 3 Completed".
           STOP RUN.
           END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[1 2 3 4 5 Test Part 1 Completed
1 2 3 4 5 Test Part 2 Completed
5 4 3 2 1 Test Part 3 Completed
], [])

AT_CLEANUP


AT_SETUP([PERFORM VARYING BY phrase omitted])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 X             PIC 9.
       PROCEDURE        DIVISION.
           PERFORM VARYING X FROM 4
                   UNTIL   X > 6
             DISPLAY "X" NO ADVANCING
           END-PERFORM.
           IF X NOT = 7
             DISPLAY "WRONG X: " X
           END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -std=cobol85 prog.cob], [1], [],
[prog.cob:9: error: PERFORM VARYING without BY phrase does not conform to COBOL 85
])
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [XXX])

AT_CLEANUP


## EXIT PERFORM  see ISO/IEC 1989:2002(E) 14.8.13 Format 5

AT_SETUP([EXIT PERFORM])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           PERFORM 2 TIMES
             DISPLAY "OK" NO ADVANCING
             EXIT PERFORM
             DISPLAY "NOT OK"
           END-PERFORM
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OK], [])

AT_CLEANUP


## EXIT PERFORM  see ISO/IEC 1989:2002(E) 14.8.13 Format 5

AT_SETUP([EXIT PERFORM CYCLE])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           PERFORM 2 TIMES
             DISPLAY "OK" NO ADVANCING
             EXIT PERFORM CYCLE
             DISPLAY "NOT OK"
           END-PERFORM
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [OKOK])

AT_CLEANUP


## EXIT PARAGRAPH  see ISO/IEC 1989:2002(E) 14.8.13 Format 6

AT_SETUP([EXIT PARAGRAPH])
AT_KEYWORDS([runmisc])

# Note: testing EXIT PARAGRPAPH without being PERFORMed
#       implicit GO TO only

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 INDVAL        PIC 9(4).
       PROCEDURE        DIVISION.
       A01.
           PERFORM VARYING INDVAL FROM 1 BY 1 UNTIL INDVAL > 10
            IF INDVAL > 2
               EXIT PARAGRAPH
            END-IF
           END-PERFORM.
       A02.
           IF INDVAL NOT = 3
              DISPLAY INDVAL
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


## EXIT SECTION  see ISO/IEC 1989:2002(E) 14.8.13 Format 6

AT_SETUP([EXIT SECTION])
AT_KEYWORDS([runmisc])

# Note: testing EXIT SECTION without being PERFORMed
#       implicit GO TO only

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 INDVAL        PIC 9(4).
       PROCEDURE        DIVISION.
       A01 SECTION.
       A011.
           PERFORM VARYING INDVAL FROM 1 BY 1 UNTIL INDVAL > 10
            IF INDVAL > 2
               EXIT SECTION
            END-IF
           END-PERFORM.
       A012.
           DISPLAY INDVAL.
       A02 SECTION.
           IF INDVAL NOT = 3
              DISPLAY INDVAL.
           STOP RUN.
])

# disabling the check for "something leaves the section" - as this is
# guaranteed to happen with this EXIT SECTION as GO TO
AT_CHECK([$COMPILE -fno-section-exit-check prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fsection-exit-check prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:12: error: code execution leaving A01
])

AT_CLEANUP


AT_SETUP([implicit GOBACK at end of PROCEDURE DIVISION])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
       A01 SECTION.
       A011.
          CONTINUE.
])

AT_CHECK([$COMPILE -fno-implicit-goback-check prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fimplicit-goback-check prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:8: error: code execution leaving PROCEDURE DIVISION
])

AT_CLEANUP


AT_SETUP([PERFORM FOREVER / PERFORM UNTIL EXIT])
AT_KEYWORDS([runmisc extension])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  INDVAL       PIC 9(4).
       PROCEDURE        DIVISION.
       A01.
           MOVE 0 TO INDVAL
           PERFORM UNTIL EXIT
            ADD 1 TO INDVAL
            IF INDVAL > 2
               EXIT PERFORM
            END-IF
           END-PERFORM
           IF INDVAL NOT = 3
              DISPLAY "1: " INDVAL
              END-DISPLAY
           END-IF
           PERFORM FOREVER
            ADD 1 TO INDVAL
            IF INDVAL > 4
               EXIT PERFORM
            END-IF
           END-PERFORM
           IF INDVAL NOT = 5
              DISPLAY "2: " INDVAL
              END-DISPLAY
           END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PERFORM inline (1)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  INDVAL       PIC 9(4).
       PROCEDURE        DIVISION.
           PERFORM VARYING INDVAL FROM 1
            BY 1 UNTIL INDVAL > 2
           END-PERFORM
           IF INDVAL NOT = 3
              DISPLAY INDVAL
           END-IF
           STOP RUN
           .
])

AT_CHECK([$COMPILE -fmissing-statement=ok prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PERFORM inline (2)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  INDVAL       PIC 9(4).
       PROCEDURE        DIVISION.
           PERFORM VARYING INDVAL FROM 1
            BY 1 UNTIL INDVAL > 2.
           IF INDVAL NOT = 3
              DISPLAY INDVAL
           END-IF
           .
])

AT_CHECK([$COMPILE -frelax-syntax-checks -w prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Non-overflow after overflow])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X            PIC 9(2) VALUE 0.
       01  Y            PIC 9(2) VALUE 0.
       PROCEDURE        DIVISION.
           COMPUTE X = 100. *> this overflows which does not store a result
           COMPUTE Y = 99.  *> and once in a time this result was not stored
           IF X NOT = 0 AND
              Y NOT = 99
              DISPLAY Y.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


## PERFORM statement

AT_SETUP([PERFORM ... CONTINUE])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           PERFORM 2 TIMES
             CONTINUE
           END-PERFORM.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([STRING with subscript reference])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  G.
           02 X         PIC X(3) OCCURS 3.
       PROCEDURE        DIVISION.
           MOVE   SPACES TO G.
           STRING "abc" INTO X(2)
           END-STRING.
           IF G NOT = "   abc   "
              DISPLAY X(1)
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([STRING WITH POINTER ON OVERFLOW with DELIMITER])
AT_KEYWORDS([runmisc exceptions])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. StringTest.
      *>----------------------------------------------------------------
      *>           Additional test cases for STRING statement
      *> Testing string  with POINTER clause and with OVERFLOW
      *> managment associated to POINTER clause
      *> Testing also String with delimiter
      *>----------------------------------------------------------------
       DATA DIVISION.
       WORKING-STORAGE SECTION.
      *>-----------------------
       01  TRGT-STRING   PIC X(03) VALUE SPACES.
       01  STR-POINTER   PIC 9(02).
       01  SRC-DELIM     PIC X(01).

       PROCEDURE DIVISION.
      *>-------------------
      *>
      *> case A: Pointer is between 1 and less than TRGT-STRING LENGTH
      *>         Should not overflow
            MOVE 1 to STR-POINTER.
            STRING 'A' 'B' 'C' DELIMITED BY SIZE
                   INTO TRGT-STRING
                   WITH POINTER STR-POINTER
                   ON OVERFLOW
                      DISPLAY 'Case A: Should not overflow' END-DISPLAY
            END-STRING.
            IF TRGT-STRING NOT = 'ABC'
                DISPLAY 'A: TRTG-STRING <' TRGT-STRING '> != <ABC>'.
            IF STR-POINTER NOT = 4
                DISPLAY 'A: STR-POINTER <' STR-POINTER '> != <04>'.
      *>
      *>  case B: Pointer is 0 --> Should  overflow
            MOVE 0                        TO STR-POINTER.
            MOVE SPACES                   TO TRGT-STRING.
            STRING 'A' 'B' 'C'  DELIMITED BY SIZE
                   INTO TRGT-STRING
                   WITH POINTER STR-POINTER
                   NOT ON OVERFLOW
                      DISPLAY 'Case B: Should overflow' END-DISPLAY
            END-STRING.
            IF TRGT-STRING NOT = SPACES
                DISPLAY 'B: TRTG-STRING <' TRGT-STRING '> != SPACES'.
            IF STR-POINTER NOT = 0
                DISPLAY 'B: STR-POINTER <' STR-POINTER '> != <00>'.
      *>
      *>  case C: Pointer is 4 --> Should  overflow
            MOVE 4                        TO STR-POINTER.
            MOVE SPACES                   TO TRGT-STRING.
            STRING 'A' 'B' 'C' DELIMITED BY SIZE
                   INTO TRGT-STRING
                   WITH POINTER STR-POINTER
                   NOT ON OVERFLOW
                      DISPLAY 'Case C: Should overflow' END-DISPLAY
            END-STRING.
            IF TRGT-STRING NOT = SPACES
                DISPLAY 'C: TRTG-STRING <' TRGT-STRING '> != SPACES'.
            IF STR-POINTER NOT = 4
                DISPLAY 'C: STR-POINTER <' STR-POINTER '> != <04>'.
      *>
      *>  case D: Test with delimiter
            MOVE 1      TO STR-POINTER.
            MOVE '|'    TO SRC-DELIM.
            MOVE SPACES TO TRGT-STRING.
            STRING '1|2' 'A|B' 'C|D'   DELIMITED BY SRC-DELIM
                    INTO TRGT-STRING
                    WITH POINTER STR-POINTER
            END-STRING.
            IF TRGT-STRING NOT = '1AC'
                DISPLAY 'D: TRGT-STRING <' TRGT-STRING '> != <1AC>'.
      *>
            GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([STRING / UNSTRING [[NOT]] ON OVERFLOW])
AT_KEYWORDS([runmisc exceptions])

AT_DATA([prog.cob], [
       identification division.
       program-id. prog.
       data division.
       working-storage section.
       77 simple-str     pic x(20).
       77 err-str        pic x(50).
      *-----------------------------------------------------------------
       procedure division.
      *    STRING test
           move spaces to simple-str
           string 'data'
             delimited by size
             into simple-str
             on overflow
               move spaces to err-str
               string 'STRING OVERFLOW'
                  delimited by size
                  into err-str
               end-string
               display err-str upon syserr
               end-display
               display '1 failed'
               end-display
             not on overflow
               display '1 passed'
               end-display
           end-string
           if simple-str not = 'data'
             display 'STRING ERROR (1): "' simple-str '"'
             end-display
           end-if
      *
           move spaces to simple-str
           string 'data is too big here...'
             delimited by size
             into simple-str
             on overflow
               display '2 passed'
               end-display
             not on overflow
               display '2 failed'
               end-display
               move spaces to err-str
               string 'missing OVERFLOW'
                  delimited by size
                  into err-str
               end-string
               display err-str upon syserr
               end-display
           end-string
           if simple-str not = 'data is too big here'
             display 'STRING ERROR (2): "' simple-str '"'
             end-display
           end-if
      *
      *    UNSTRING test
           move spaces to simple-str
           unstring 'data'
             into simple-str
             on overflow
               move spaces to err-str
               unstring 'UNSTRING OVERFLOW'
                  into err-str
               end-unstring
               display err-str upon syserr
               end-display
               display '3 failed'
               end-display
             not on overflow
               display '3 passed'
               end-display
           end-unstring
           if simple-str not = 'data'
             display 'UNSTRING ERROR (1): "' simple-str '"'
             end-display
           end-if
      *
           move spaces to simple-str
           unstring 'data is too big here...'
             into simple-str
             on overflow
               display '4 passed'
               end-display
             not on overflow
               display '4 failed'
               end-display
               move spaces to err-str
               string 'missing OVERFLOW'
                  delimited by size
                  into err-str
               end-string
               display err-str upon syserr
               end-display
           end-unstring
           if simple-str not = 'data is too big here'
             display 'UNSTRING ERROR (2): "' simple-str '"'
             end-display
           end-if
      *
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[1 passed
2 passed
3 passed
4 passed
], [])

AT_CLEANUP


AT_SETUP([STRING preserve source])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 SRC.
         10 SRC-X PIC X(3) VALUE "123".
         10 SRC-Y PIC X(8) VALUE SPACES.
       01 DST OCCURS 1.
         10 DST-X PIC X(8) VALUE SPACES.
       PROCEDURE DIVISION.
           DISPLAY "SRC-Y BEFORE: '" SRC-Y "'".
           STRING "DATA " SRC-X(1:3) INTO DST (1).
           DISPLAY "SRC-Y AFTER:  '" SRC-Y "'".
           DISPLAY "DST-X AFTER:  '" DST-X (1) "'".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[SRC-Y BEFORE: '        '
SRC-Y AFTER:  '        '
DST-X AFTER:  'DATA 123'
], [])

AT_CLEANUP


AT_SETUP([INSPECT preserve source])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 SRC OCCURS 1.
         10 SRC-X PIC S9(3) VALUE 123.
         10 SRC-Y PIC S9(3) VALUE 456.
       01 DST OCCURS 1.
         10 DST-X PIC S9(7) VALUE -6540321.
       PROCEDURE DIVISION.
           DISPLAY "SRC-X BEFORE: '" SRC-X (1) "'".
           DISPLAY "SRC-Y BEFORE: '" SRC-Y (1) "'".
           DISPLAY "DST-X BEFORE: '" DST-X (1) "'".
           INSPECT DST-X (1) REPLACING
             LEADING "654" BY SRC-X (1)
             ALL "321" BY SRC-Y (1).
           DISPLAY "SRC-X AFTER: '" SRC-X (1) "'".
           DISPLAY "SRC-Y AFTER: '" SRC-Y (1) "'".
           DISPLAY "DST-X AFTER: '" DST-X (1) "'".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[SRC-X BEFORE: '+123'
SRC-Y BEFORE: '+456'
DST-X BEFORE: '-6540321'
SRC-X AFTER: '+123'
SRC-Y AFTER: '+456'
DST-X AFTER: '-1230456'
], [])

AT_CLEANUP


AT_SETUP([UNSTRING DELIMITED ALL LOW-VALUE])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  G.
           03 FILLER    PIC XXX VALUE "ABC".
           03 FILLER    PIC XX  VALUE LOW-VALUES.
           03 FILLER    PIC XXX VALUE "DEF".
       01  A            PIC XXX.
       01  B            PIC XXX.
       PROCEDURE        DIVISION.
           UNSTRING G DELIMITED BY ALL LOW-VALUES
                      INTO A B
           END-UNSTRING.
           IF A NOT = "ABC"
              DISPLAY A.
           IF B NOT = "DEF"
              DISPLAY B.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([UNSTRING DELIMITED ALL SPACE-2])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION  DIVISION.
       PROGRAM-ID.     prog.
       ENVIRONMENT     DIVISION.
       DATA            DIVISION.
       WORKING-STORAGE SECTION.
       01  WS-RECORD.
           02 VALUE SPACE           PIC X(04).
           02 VALUE "ABC AND DE"    PIC X(10).
           02 VALUE SPACE           PIC X(07).
           02 VALUE "FG AND HIJ"    PIC X(10).
           02 VALUE SPACE           PIC X(08).
       01  SPACE-2                  PIC X(02) VALUE SPACE.
       01  WS-DUMMY                 PIC X(15).
       01  WS-POINTER               PIC 99.
       PROCEDURE       DIVISION.
           MOVE 1 TO WS-POINTER.
      *
           PERFORM 0001-SUB.
           IF WS-DUMMY NOT = SPACE
              DISPLAY "Expected space - Got " WS-DUMMY.
           IF WS-POINTER NOT = 5
              DISPLAY "Expected 5 - Got " WS-POINTER.
      *
           PERFORM 0001-SUB.
           IF WS-DUMMY NOT = "ABC AND DE"
              DISPLAY "Expected ABC AND DE - Got " WS-DUMMY.
           IF WS-POINTER NOT = 21
              DISPLAY "Expected 21 - Got " WS-POINTER.
      *
           PERFORM 0001-SUB.
           IF WS-DUMMY NOT = " FG AND HIJ"
              DISPLAY "Expected  FG AND HIJ - Got " WS-DUMMY.
           IF WS-POINTER NOT = 40
              DISPLAY "Expected 40 - Got " WS-POINTER.
           STOP RUN.
       0001-SUB.
           UNSTRING WS-RECORD
                    DELIMITED BY ALL SPACE-2
              INTO WS-DUMMY
              POINTER WS-POINTER
           END-UNSTRING.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([UNSTRING DELIMITED POINTER])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION  DIVISION.
       PROGRAM-ID.     prog.
       ENVIRONMENT     DIVISION.
       DATA            DIVISION.
       WORKING-STORAGE SECTION.
       01  WS-LAY-RECORD            PIC X(66).
       01  WS-DUMMY                 PIC X(50).
       01  WS-KEYWORD               PIC X(32).
       01  WS-POINTER               PIC 99.
       PROCEDURE       DIVISION.
           MOVE
       '        10  AF-RECORD-TYPE-SEQUENCE-04     PIC   9(05) COMP-3.'
                  TO WS-LAY-RECORD.
           MOVE 1 TO WS-POINTER.
           PERFORM 0001-SUB.
           IF WS-POINTER NOT = 48
              DISPLAY "Expected 48 - Got " WS-POINTER.
           ADD 7  TO WS-POINTER
          .
           PERFORM 0001-SUB.
           IF WS-POINTER NOT = 62
              DISPLAY "Expected 62 - Got " WS-POINTER.
           PERFORM 0001-SUB.
           IF WS-POINTER NOT = 63
              DISPLAY "Expected 63 - Got " WS-POINTER.
           STOP RUN.
       0001-SUB.
           UNSTRING WS-LAY-RECORD
                    DELIMITED
                    BY ' PIC '
                    OR ' COMP-3'
                    OR '.'
              INTO WS-DUMMY
              DELIMITER WS-KEYWORD
              POINTER WS-POINTER
           END-UNSTRING.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([UNSTRING DELIMITER IN])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE SECTION.
       01  WK-CMD       PIC X(8) VALUE "WWADDBCC".
       01  FILLER.
        02 WK-SIGNS     PIC XX   VALUE "AB".
        02 WKS REDEFINES WK-SIGNS.
           03 WK-SIGN   PIC X OCCURS 2.
        02 WK-DELIM     PIC X OCCURS 2.
        02 WK-DATA      PIC X(2) OCCURS 3.
       PROCEDURE        DIVISION.
           UNSTRING WK-CMD DELIMITED BY WK-SIGN(1) OR WK-SIGN(2)
           INTO WK-DATA(1) DELIMITER IN WK-DELIM(1)
                WK-DATA(2) DELIMITER IN WK-DELIM(2)
                WK-DATA(3)
           END-UNSTRING
           IF  WK-DATA(1)   NOT = "WW"
            OR WK-DATA(2)   NOT = "DD"
            OR WK-DATA(3)   NOT = "CC"
            OR WK-DELIM(1)  NOT = "A"
            OR WK-DELIM(2)  NOT = "B"
               DISPLAY WK-DATA(1)
                       WK-DATA(2)
                       WK-DATA(3)
                       WK-DELIM(1)
                       WK-DELIM(2)
               END-DISPLAY
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -ftop-level-occurs-clause=ok prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([UNSTRING combined])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. UnstringTest.
      *>----------------------------------------------------------------
      *>           Additional test case for UNSTRING
      *> testing unstring tallying with and without OVERFLOW and with
      *> ALL clause for delimiters
      *>----------------------------------------------------------------
       DATA DIVISION.
       WORKING-STORAGE SECTION.
      *>-----------------------
       01 INP-STRING           PIC X(13) VALUE 'ABC1|DEF--GHI'.
       01 STR-POINTER          PIC 9(02).
       01 RES-DATA.
          05 RES-TRGT-1        PIC X(20).
          05 RES-DELIM-1       PIC X(01).
          05 RES-COUNT-1       PIC 9(02).
          05 RES-TRGT-2        PIC X(20).
          05 RES-DELIM-2       PIC X(01).
          05 RES-COUNT-2       PIC 9(02).
          05 RES-TALLY         PIC 9(02).
      *>
       PROCEDURE DIVISION.
      *>------------------
      *>
      *>   case A : should not  OVERFLOW; use of one delimiter
           INITIALIZE RES-DATA
           MOVE 1  TO STR-POINTER
      *>
           UNSTRING INP-STRING
                    DELIMITED BY '|'
               INTO RES-TRGT-1
                    DELIMITER IN RES-DELIM-1 COUNT IN RES-COUNT-1
                    RES-TRGT-2
                    DELIMITER IN RES-DELIM-2 COUNT IN RES-COUNT-2
               WITH POINTER STR-POINTER
               TALLYING RES-TALLY
               ON OVERFLOW
                   DISPLAY
                      'Unstring tallying case 1 should not OVERFLOW'
                   END-DISPLAY
           END-UNSTRING.
           PERFORM TEST-CASE-1-RESULT
      *>
      *>   case B : should  OVERFLOW; use of two delimiters
           INITIALIZE RES-DATA
           MOVE 1  TO STR-POINTER

           UNSTRING INP-STRING
                    DELIMITED BY '|' OR  ALL '-'
               INTO RES-TRGT-1
                    DELIMITER IN RES-DELIM-1 COUNT IN RES-COUNT-1
                    RES-TRGT-2
                    DELIMITER IN RES-DELIM-2 COUNT IN RES-COUNT-2
               WITH POINTER STR-POINTER
               TALLYING RES-TALLY
               NOT ON OVERFLOW
                   DISPLAY
                      'Unstring tallying case 2 should  OVERFLOW'
                   END-DISPLAY
           END-UNSTRING.
           PERFORM TEST-CASE-2-RESULT
      *>
           GOBACK.

      *>
       TEST-CASE-1-RESULT.
      *>------------------
           IF RES-TRGT-1 NOT = 'ABC1'
              DISPLAY 'A: RES-TRGT-1 <'   RES-TRGT-1  '> != <ABC1>'.
           IF RES-DELIM-1 NOT = '|'                   
              DISPLAY 'A: RES-DELIM-1 <'  RES-DELIM-1 '> != <|>'.
           IF RES-COUNT-1 NOT = 4                     
              DISPLAY 'A: RES-COUNT-1 <'  RES-COUNT-1 '> != <4>'.
           IF RES-TRGT-2 NOT = 'DEF--GHI'             
              DISPLAY 'A: RES-TRGT-2 <'   RES-TRGT-2  '> != <DEF--GHI>'.
           IF RES-DELIM-2  NOT = SPACES               
              DISPLAY 'A: RES-DELIM2 <'   RES-DELIM-2 '> != SPACE'.
           IF RES-COUNT-2 NOT = 8                     
              DISPLAY 'A: RES-COUNT-1 <'  RES-COUNT-2 '> != <8>'.
           IF STR-POINTER NOT = 14                    
              DISPLAY 'A: STR-POINTER <'  STR-POINTER '> != <14>'.
           IF RES-TALLY NOT = 2                       
              DISPLAY 'A: RES-TALLY <'    RES-TALLY   '> != <2>'.
      *>                                              
       TEST-CASE-2-RESULT.                            
      *>------------------                            
           IF RES-TRGT-1 NOT = 'ABC1'                 
              DISPLAY 'B: RES-TRGT-1 <'   RES-TRGT-1  '> != <ABC1>'.
           IF RES-DELIM-1 NOT = '|'                   
              DISPLAY 'B: RES-DELIM-1 <'  RES-DELIM-1 '> != <|>'.
           IF RES-COUNT-1 NOT = 4                     
              DISPLAY 'B: RES-COUNT-1 <'  RES-COUNT-1 '> != <4>'.
           IF RES-TRGT-2 NOT = 'DEF'                  
              DISPLAY 'B: RES-TRGT-2 <'   RES-TRGT-2  '> != <DEF>'.
           IF RES-DELIM-2  NOT = '-'                  
              DISPLAY 'B: RES-DELIM2 <'   RES-DELIM-2 '> != <->'.
           IF RES-COUNT-2 NOT = 3                     
              DISPLAY 'B: RES-COUNT-1 <'  RES-COUNT-2 '> != <3>'.
           IF STR-POINTER NOT = 11
              DISPLAY 'B: STR-POINTER <'  STR-POINTER '> != <11>'.
           IF RES-TALLY NOT = 2                       
              DISPLAY 'B: RES-TALLY <'    RES-TALLY   '> != <2>'.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([UNSTRING with FUNCTION / literal])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  FILLER.
         05  TSTUNS PIC X(479).
         05  PRM    PIC X(16) OCCURS 4 TIMES.
       PROCEDURE DIVISION.
           MOVE "The,Quick,Brown,Fox" TO TSTUNS.
           UNSTRING TSTUNS DELIMITED BY ','
              INTO  PRM(1), PRM(2), PRM(3), PRM(4).
           DISPLAY "PRM(1) is " PRM(1) ":".
           DISPLAY "PRM(2) is " PRM(2) ":".
           DISPLAY "PRM(3) is " PRM(3) ":".
           DISPLAY "PRM(4) is " PRM(4) ":".
           UNSTRING FUNCTION UPPER-CASE(TSTUNS) DELIMITED BY ','
              INTO  PRM(1), PRM(2), PRM(3), PRM(4).
           DISPLAY "Now using UPPER-CASE"
           DISPLAY "PRM(1) is " PRM(1) ":".
           DISPLAY "PRM(2) is " PRM(2) ":".
           DISPLAY "PRM(3) is " PRM(3) ":".
           DISPLAY "PRM(4) is " PRM(4) ":".
           UNSTRING "Daddy,was,a,Rolling stone" DELIMITED BY ','
              INTO  PRM(1), PRM(2), PRM(3), PRM(4).
           DISPLAY "Now using Literal"
           DISPLAY "PRM(1) is " PRM(1) ":".
           DISPLAY "PRM(2) is " PRM(2) ":".
           DISPLAY "PRM(3) is " PRM(3) ":".
           DISPLAY "PRM(4) is " PRM(4) ":".
           UNSTRING FUNCTION LOWER-CASE("Daddy,was,a,Rolling stone")
                DELIMITED BY ','
              INTO  PRM(1), PRM(2), PRM(3), PRM(4).
           DISPLAY "Now using Literal + LOWER-CASE"
           DISPLAY "PRM(1) is " PRM(1) ":".
           DISPLAY "PRM(2) is " PRM(2) ":".
           DISPLAY "PRM(3) is " PRM(3) ":".
           DISPLAY "PRM(4) is " PRM(4) ":".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[PRM(1) is The             :
PRM(2) is Quick           :
PRM(3) is Brown           :
PRM(4) is Fox             :
Now using UPPER-CASE
PRM(1) is THE             :
PRM(2) is QUICK           :
PRM(3) is BROWN           :
PRM(4) is FOX             :
Now using Literal
PRM(1) is Daddy           :
PRM(2) is was             :
PRM(3) is a               :
PRM(4) is Rolling stone   :
Now using Literal + LOWER-CASE
PRM(1) is daddy           :
PRM(2) is was             :
PRM(3) is a               :
PRM(4) is rolling stone   :
], [])

AT_CLEANUP


AT_SETUP([PICTURE COMP-X])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TST.
           05 BVAL  PIC 9999 BINARY VALUE 512.
           05 XVAL  PIC XX COMP-X VALUE 512.
              88 XLOW  VALUE   0 THRU 256.
              88 XHIGH VALUE 257 THRU 65536.
           05 VAL9  PIC 99999 COMP-X VALUE 1024.
              88 LOW9  VALUE   0 THRU 256.
              88 HIGH9 VALUE 257 THRU 65536.
           05 XVAL2 PIC XX COMP-X VALUE 16706.
           05 XVALX REDEFINES XVAL2 PIC XX.
           05 YVALX PIC XX VALUE 'A '.
           05 YVAL2 REDEFINES YVALX PIC XX COMP-X.

       PROCEDURE DIVISION.
           DISPLAY " XVAL is " XVAL ";  Length is " LENGTH OF XVAL.
           DISPLAY " VAL9 is " VAL9 ";  Length is " LENGTH OF VAL9.
           MOVE 10240 TO XVAL.
           DISPLAY " XVAL is " XVAL ";  Length is " LENGTH OF XVAL.
           DISPLAY "XVAL2 is " XVAL2 "; Length is " LENGTH OF XVAL2.
           DISPLAY "XVALX is " XVALX "; Length is " LENGTH OF XVALX.
           ADD 1 TO XVAL2.
           DISPLAY "XVALX is " XVALX " after +1;".
           COMPUTE XVAL2 = XVAL2 / 256 + 8192.
           DISPLAY "XVALX is " XVALX " after / 256 + 8192;".
           MOVE 'DE'       TO XVALX.
           DISPLAY "Numeric: " XVAL2 " is char " XVALX.
           MOVE ZERO       TO YVAL2.
           MOVE 'D'        TO YVALX (1:1)
           MOVE LOW-VALUES TO YVALX (2:1)
           SUBTRACT YVAL2 FROM XVAL2.
           MOVE ' '        TO YVALX (1:1)
           MOVE LOW-VALUES TO YVALX (2:1)
           ADD YVAL2 TO XVAL2.
           DISPLAY "Numeric: " XVAL2 " is char " XVALX.
           MOVE 0 TO XVAL.
           ADD 10240 TO XVAL.
           IF XVAL = 10240
               DISPLAY "XVAL is " XVAL
           ELSE
               DISPLAY "XVAL is not 10240 but " XVAL
           END-IF.
           MOVE 0 TO BVAL.
           ADD 10240 TO BVAL.
           IF BVAL = 0240
               DISPLAY "BVAL is " BVAL
           ELSE
               DISPLAY "BVAL is not 0240 but " BVAL
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [ XVAL is 00512;  Length is 2
 VAL9 is 01024;  Length is 3
 XVAL is 10240;  Length is 2
XVAL2 is 16706; Length is 2
XVALX is AB; Length is 2
XVALX is AC after +1;
XVALX is  A after / 256 + 8192;
Numeric: 17477 is char DE
Numeric: 08261 is char  E
XVAL is 10240
BVAL is 0240
], [])

AT_CLEANUP


AT_SETUP([PICTURE COMP-X (2)])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TSTN-4   PIC X(4)  COMP-N.
       01  TSTN-8   PIC X(8)  COMP-N.
       01  TSTX-4   PIC X(4)  COMP-5.
       01  TSTX-8   PIC X(8)  COMP-X.
       01  TST9-12  PIC 9(12) COMP-X.
       01  TST9-19  PIC 9(19) COMP-X.
       01  TSTB-34  PIC 9(34).
       01  TST5-2   PIC 9(2)  COMP-5.
       01  TST5-3   PIC 9(3)  COMP-5.
       01  TST5-6   PIC 9(6)  COMP-5.
       01  TST5-8   PIC 9(8)  COMP-5.

       PROCEDURE DIVISION.
           MOVE 96 TO TST5-2.
           DISPLAY "TST5-2 :" TST5-2 ", Length: " LENGTH OF TST5-2.
           MOVE 4096 TO TST5-3.
           DISPLAY "TST5-3 :" TST5-3 ", Length: " LENGTH OF TST5-3.
           MOVE 4096 TO TST5-6.
           DISPLAY "TST5-6 :" TST5-6 ", Length: " LENGTH OF TST5-6.
           MOVE 4096 TO TST5-8.
           DISPLAY "TST5-8 :" TST5-8 ", Length: " LENGTH OF TST5-8.
           MOVE 4294967295 TO TSTX-4.
           DISPLAY "TSTX-4 :" TSTX-4 ", Length: " LENGTH OF TSTX-4.
           MOVE 9223372036854775807 TO TSTX-8.
           DISPLAY "TSTX-8 :" TSTX-8 ", Length: " LENGTH OF TSTX-8.
           MOVE 4294967295 TO TSTN-4.
           DISPLAY "TSTN-4 :" TSTN-4 ", Length: " LENGTH OF TSTN-4.
           MOVE 9223372036854775807 TO TSTN-8.
           DISPLAY "TSTN-8 :" TSTN-8 ", Length: " LENGTH OF TSTN-8.
           MOVE 999999999999        TO TST9-12.
           DISPLAY "TST9-12:" TST9-12 ", Length: " LENGTH OF TST9-12.
           MOVE 9223372036854775807 TO TST9-19.
           DISPLAY "TST9-19:" TST9-19 ", Length: " LENGTH OF TST9-19.
           MOVE 999999999999999999999999999999999 TO TSTB-34.
           DISPLAY "TSTB-34:" TSTB-34 ", Length: " LENGTH OF TSTB-34.
           COMPUTE TSTB-34 = TSTB-34 * 10000000000.
           DISPLAY "TSTB-34:" TSTB-34 ", Length: " LENGTH OF TSTB-34.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=default -Wno-truncate prog.cob ], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [TST5-2 :096, Length: 1
TST5-3 :04096, Length: 2
TST5-6 :0000004096, Length: 4
TST5-8 :0000004096, Length: 4
TSTX-4 :4294967295, Length: 4
TSTX-8 :9223372036854775807, Length: 8
TSTN-4 :4294967295, Length: 4
TSTN-8 :09223372036854775807, Length: 8
TST9-12:999999999999, Length: 5
TST9-19:9223372036854775807, Length: 8
TSTB-34:0999999999999999999999999999999999, Length: 34
TSTB-34:9999999999999999999999990000000000, Length: 34
], [])

AT_CLEANUP


AT_SETUP([Large BINARY, COMP-X])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TST3-38  PIC S9(38) COMP-3.
       01  TST4-18  PIC  9(18) COMP-4.
       01  TST4-22  PIC  9(22) COMP-4.
       01  TST4-38  PIC S9(38) COMP-4.
       01  TST5-2   PIC 9(2)   COMP-5.
       01  TST5-38  PIC S9(38) COMP-5.
       01  TST5-3   PIC S9(3)  COMP-5.
       01  TST5-6   PIC S9(6)  COMP-5.
       01  TST5-8   PIC 9(8)   COMP-5.
       01  TSTN-34  PIC S9(34) COMP-N.
       01  TSTX-12  PIC X(12)  COMP-X.
       01  TSTX-14  PIC X(14)  COMP-X.
       01  TSTX-38  PIC 9(38)  COMP-X.
       01  TSTX-4   PIC X(4)   COMP-X.
       01  TSTX-8   PIC X(8)   COMP-X.
       01  TSTX-9   PIC X(9)   COMP-X.

       PROCEDURE DIVISION.
           MOVE 4096 TO TST5-2.
           DISPLAY "TST5-2 :" TST5-2 ", Length: " LENGTH OF TST5-2.
           MOVE -4096 TO TST5-3.
           DISPLAY "TST5-3 :" TST5-3 ", Length: " LENGTH OF TST5-3.
           MOVE -4096 TO TST5-6.
           DISPLAY "TST5-6 :" TST5-6 ", Length: " LENGTH OF TST5-6.
           MOVE 4096 TO TST5-8.
           DISPLAY "TST5-8 :" TST5-8 ", Length: " LENGTH OF TST5-8.
           MOVE 4294967295 TO TSTX-4.
           DISPLAY "TSTX-4 :" TSTX-4 ", Length: " LENGTH OF TSTX-4.
           MOVE 8192       TO TSTX-4.
           DISPLAY "TSTX-4 :" TSTX-4 ", Length: " LENGTH OF TSTX-4.
           CALL "dumpln" USING TSTX-4 BY VALUE LENGTH OF TSTX-4.
           MOVE 987654321001234567 TO TSTX-8.
           DISPLAY "TSTX-8 :" TSTX-8 ", Length: " LENGTH OF TSTX-8.
           MOVE 8193 TO TSTX-9.
           DISPLAY "TSTX-9:8193 check"
           DISPLAY "TSTX-9:" TSTX-9 ", Length: " LENGTH OF TSTX-9.
           CALL "dumpln" USING TSTX-9 BY VALUE LENGTH OF TSTX-9.
           DISPLAY "***************+++*****".
           MOVE 12345678900987654321001234567 TO TSTX-12.
           DISPLAY "TSTX-12:12345678900987654321001234567 check"
           DISPLAY "TSTX-12:" TSTX-12 ", Length: " LENGTH OF TSTX-12.
           CALL "dumpln" USING TSTX-12 BY VALUE LENGTH OF TSTX-12.
           DISPLAY "***************+++*****".
           MOVE 987654321001234567899876543210012 TO TSTX-14.
           DISPLAY "TSTX-14:987654321001234567899876543210012 check"
           DISPLAY "TSTX-14:" TSTX-14 ", Length: " LENGTH OF TSTX-14.
           CALL "dumpln" USING TSTX-14 BY VALUE LENGTH OF TSTX-14.
           DISPLAY "***************+++*****".
           MOVE 8193 TO TSTX-38.
           DISPLAY "TSTX-38:8193 check"
           DISPLAY "TSTX-38:" TSTX-38 ", Length: " LENGTH OF TSTX-38.
           CALL "dumpln" USING TSTX-38 BY VALUE LENGTH OF TSTX-38.
           DISPLAY "***************+++*****".
           COMPUTE TSTX-38 = TSTX-38 * 256.
           DISPLAY "TSTX-38:" TSTX-38 ", Length: " LENGTH OF TSTX-38.
           CALL "dumpln" USING TSTX-38 BY VALUE LENGTH OF TSTX-38.
           DISPLAY "***************+++*****".
           MOVE 8193 TO TSTN-34.
           DISPLAY "TSTN-34:8193 check"
           DISPLAY "TSTN-34:" TSTN-34 ", Length: " LENGTH OF TSTN-34.
      *    CALL "dumpln" USING TSTN-34 BY VALUE LENGTH OF TSTN-34.
           DISPLAY "***************+++*****".
           COMPUTE TSTN-34 = TSTN-34 * 256.
           DISPLAY "TSTN-34:" TSTN-34 ", Length: " LENGTH OF TSTN-34.
      *    CALL "dumpln" USING TSTN-34 BY VALUE LENGTH OF TSTN-34.
           DISPLAY "***************+++*****".
           MOVE -8193 TO TSTN-34.
           DISPLAY "TSTN-34:-8193 check"
           DISPLAY "TSTN-34:" TSTN-34 ", Length: " LENGTH OF TSTN-34.
      *    CALL "dumpln" USING TSTN-34 BY VALUE LENGTH OF TSTN-34.
           DISPLAY "***************+++*****".
           MOVE 98765432100123456789987654321001234567 TO TSTX-38.
           DISPLAY "TSTX-38:" TSTX-38 ", Length: " LENGTH OF TSTX-38.
           CALL "dumpln" USING TSTX-38 BY VALUE LENGTH OF TSTX-38.
           DISPLAY "***************+++*****".
           MOVE -98765432100123456789987654321001234567 TO TSTX-38.
           DISPLAY "TSTX-38:" TSTX-38 ", Length: " LENGTH OF TSTX-38.
           CALL "dumpln" USING TSTX-38 BY VALUE LENGTH OF TSTX-38.
           DISPLAY "***************+++*****".
           MOVE -98765432100123456789987654321001234567 TO TST5-38.
           DISPLAY "TST5-38:" TST5-38 ", Length: " LENGTH OF TST5-38.
      *    CALL "dumpln" USING TST5-38 BY VALUE LENGTH OF TST5-38.
           DISPLAY "***************".

           MOVE -98765432100123456789987654321001234567 TO TST3-38.
           DISPLAY "TST3-38:" TST3-38 ", Length: " LENGTH OF TST3-38.
           CALL "dumpln" USING TST3-38 BY VALUE LENGTH OF TST3-38.
           DISPLAY "***************".
           MOVE 9876543210012345678998765432100123456 TO TST3-38.
           DISPLAY "TST3-38:" TST3-38 ", Length: " LENGTH OF TST3-38.
           CALL "dumpln" USING TST3-38 BY VALUE LENGTH OF TST3-38.
           DISPLAY "***************".
           COMPUTE TST3-38 = TST3-38 * 10.
           DISPLAY "TST3-38:" TST3-38 ", Length: " LENGTH OF TST3-38.
           CALL "dumpln" USING TST3-38 BY VALUE LENGTH OF TST3-38.
           DISPLAY "***************".
           MOVE -98765432100123456789987654321001234563 TO TST4-38.
           DISPLAY "TST4-38:" TST4-38 ", Length: " LENGTH OF TST4-38.
           CALL "dumpln" USING TST4-38 BY VALUE LENGTH OF TST4-38.
           DISPLAY "***************".
           MOVE 12345678909876543 TO TST4-18.
           DISPLAY "TST4-18:" TST4-18 ", Length: " LENGTH OF TST4-18.
           CALL "dumpln" USING TST4-18 BY VALUE LENGTH OF TST4-18.
           DISPLAY "***************".
           MOVE 12345678909876543210 TO TST4-22.
           DISPLAY "TST4-22:" TST4-22 ", Length: " LENGTH OF TST4-22.
           CALL "dumpln" USING TST4-22 BY VALUE LENGTH OF TST4-22.
           DISPLAY "***************".
           MOVE -8765432 TO TST4-38.
           DISPLAY "TST4-38:" TST4-38 ", Length: " LENGTH OF TST4-38.
           CALL "dumpln" USING TST4-38 BY VALUE LENGTH OF TST4-38.
           DISPLAY "***************".
           MOVE -8765432 TO TST5-38.
           DISPLAY "TST5-38:" TST5-38 ", Length: " LENGTH OF TST5-38.
      *    CALL "dumpln" USING TST5-38 BY VALUE LENGTH OF TST5-38.
           DISPLAY "***************".
           STOP RUN.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
int dump (unsigned char *data)
{
  int i;
  for (i = 0; i < 4; i++)
    printf ("%02X", data[i]);
  puts (" ");
  return 0;
}

int dumpln (unsigned char *data, int len)
{
  int i;
  printf ("%2d: ",len);
  for (i = 0; i < 32 && i < len; i++)
    printf ("%02X", data[i]);
  puts (":");
  return 0;
}
]])

AT_CHECK([$COMPILE -x -std=mf -debug -Wall -fibmcomp prog.cob cmod.c ], [0], [], [prog.cob:81: warning: ignoring sign
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [TST5-2 :04096, Length: 2
TST5-3 :-04096, Length: 2
TST5-6 :-0000004096, Length: 4
TST5-8 :0000004096, Length: 4
TSTX-4 :4294967295, Length: 4
TSTX-4 :0000008192, Length: 4
 4: 00002000:
TSTX-8 :0987654321001234567, Length: 8
TSTX-9:8193 check
TSTX-9:0000000000000000008193, Length: 9
 9: 000000000000002001:
***************+++*****
TSTX-12:12345678900987654321001234567 check
TSTX-12:12345678900987654321001234567, Length: 12
12: 27E41B324351931C34788087:
***************+++*****
TSTX-14:987654321001234567899876543210012 check
TSTX-14:0987654321001234567899876543210012, Length: 14
14: 30B1F33A3C87B6DA1B9EFA60A21C:
***************+++*****
TSTX-38:8193 check
TSTX-38:00000000000000000000000000000000008193, Length: 16
16: 00000000000000000000000000002001:
***************+++*****
TSTX-38:00000000000000000000000000000002097408, Length: 16
16: 00000000000000000000000000200100:
***************+++*****
TSTN-34:8193 check
TSTN-34:8193, Length: 15
***************+++*****
TSTN-34:2097408, Length: 15
***************+++*****
TSTN-34:-8193 check
TSTN-34:-8193, Length: 15
***************+++*****
TSTX-38:98765432100123456789987654321001234567, Length: 16
16: 4A4D87C2BC9C95628E6574CBB35C8087:
***************+++*****
TSTX-38:98765432100123456789987654321001234567, Length: 16
16: 4A4D87C2BC9C95628E6574CBB35C8087:
***************+++*****
TST5-38:-98765432100123456789987654321001234567, Length: 16
***************
TST3-38:-98765432100123456789987654321001234567, Length: 20
20: 098765432100123456789987654321001234567D:
***************
TST3-38:+09876543210012345678998765432100123456, Length: 20
20: 009876543210012345678998765432100123456C:
***************
TST3-38:+98765432100123456789987654321001234560, Length: 20
20: 098765432100123456789987654321001234560C:
***************
TST4-38:-98765432100123456789987654321001234563, Length: 16
16: B5B2783D43636A9D719A8B344CA37F7C:
***************
TST4-18:012345678909876543, Length: 8
 8: 002BDC545DEF293F:
***************
TST4-22:0012345678909876543210, Length: 16
16: 0000000000000000AB54A98EEE391EEA:
***************
TST4-38:-00000000000000000000000000000008765432, Length: 16
16: FFFFFFFFFFFFFFFFFFFFFFFFFF7A4007:
***************
TST5-38:-8765432, Length: 16
***************
], [])

AT_CLEANUP


AT_SETUP([SORT: table])
AT_KEYWORDS([runmisc SORT])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 G             VALUE "d4b2e1a3c5".
         02 TBL         OCCURS 5.
           03 X         PIC X.
           03 Y         PIC 9.
       PROCEDURE        DIVISION.
           SORT TBL ASCENDING KEY X.
           IF G NOT = "a3b2c5d4e1"
              DISPLAY G.
           SORT TBL DESCENDING KEY Y.
           IF G NOT = "c5d4a3b2e1"
              DISPLAY G.
           SORT TBL ASCENDING KEY TBL.
           IF G NOT = "a3b2c5d4e1"
              DISPLAY G.
           SORT TBL DESCENDING KEY.
           IF G NOT = "e1d4c5b2a3"
              DISPLAY G.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([SORT: table (2)])
AT_KEYWORDS([runmisc SORT])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 K                 PIC 9(2).

       01 CNT1              PIC 9(9) COMP-5 VALUE 4.
       01 TAB1.
          05 ROW1 OCCURS 1 TO 4 DEPENDING CNT1
                                 DESCENDING TAB1-NR.
             10 TAB1-NR     PIC 99.

       01 TAB2.
          05 CNT2           PIC 9(9) COMP-5 VALUE 4.
          05 ROW2 OCCURS 1 TO 4 DEPENDING CNT2
                                 DESCENDING TAB2-NR.
             10 TAB2-NR PIC 99.

       01 TAB3.
          05 CNT3           PIC 9(9) COMP-5 VALUE 10.
          05 ROW3 OCCURS 1 TO 10 DEPENDING CNT3
                                  DESCENDING TAB3-NR
                                  ASCENDING TAB3-DATA.
             10 TAB3-NR     PIC 99.
             10 FILLER      PIC X(2).
             10 TAB3-DATA   PIC X(5).
             10 FILLER      PIC X(2).
             10 TAB3-DATA2  PIC X(5).


       PROCEDURE DIVISION.
       A.
           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             MOVE K TO TAB1-NR(K), TAB2-NR(K)
           END-PERFORM

           MOVE 1 TO TAB3-NR(1).
           MOVE 1 TO TAB3-NR(8).
           MOVE 1 TO TAB3-NR(4).
           MOVE 6 TO TAB3-NR(2).
           MOVE 5 TO TAB3-NR(3).
           MOVE 5 TO TAB3-NR(9).
           MOVE 2 TO TAB3-NR(5).
           MOVE 2 TO TAB3-NR(10).
           MOVE 4 TO TAB3-NR(6).
           MOVE 3 TO TAB3-NR(7).

           MOVE "abcde" TO TAB3-DATA(1).
           MOVE "AbCde" TO TAB3-DATA(2).
           MOVE "abcde" TO TAB3-DATA(3).
           MOVE "zyx" TO TAB3-DATA(4).
           MOVE "12345" TO TAB3-DATA(5).
           MOVE "zyx" TO TAB3-DATA(6).
           MOVE "abcde" TO TAB3-DATA(7).
           MOVE "AbCde" TO TAB3-DATA(8).
           MOVE "abc" TO TAB3-DATA(9).
           MOVE "12346" TO TAB3-DATA(10).

           MOVE "day" TO TAB3-DATA2(1).
           MOVE "The" TO TAB3-DATA2(2).
           MOVE "eats" TO TAB3-DATA2(3).
           MOVE "." TO TAB3-DATA2(4).
           MOVE "mooos" TO TAB3-DATA2(5).
           MOVE "grass" TO TAB3-DATA2(6).
           MOVE "and" TO TAB3-DATA2(7).
           MOVE "whole" TO TAB3-DATA2(8).
           MOVE "cow" TO TAB3-DATA2(9).
           MOVE "the" TO TAB3-DATA2(10).

           SORT ROW1 DESCENDING TAB1-NR
           SORT ROW2 DESCENDING TAB2-NR

           DISPLAY "SINGLE TABLE" END-DISPLAY
           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             DISPLAY  FUNCTION TRIM(TAB1-NR(K)) END-DISPLAY
           END-PERFORM

           DISPLAY "LOWER LEVEL TABLE" END-DISPLAY
           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             DISPLAY  FUNCTION TRIM(TAB2-NR(K)) END-DISPLAY
           END-PERFORM

           SORT ROW3 DESCENDING TAB3-NR ASCENDING TAB3-DATA

           DISPLAY "MULTY KEY SORT" END-DISPLAY
           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 10
             DISPLAY  FUNCTION TRIM(ROW3(K))
             END-DISPLAY
           END-PERFORM

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [SINGLE TABLE
04
03
02
01
LOWER LEVEL TABLE
04
03
02
01
MULTY KEY SORT
06  AbCde  The
05  abc    cow
05  abcde  eats
04  zyx    grass
03  abcde  and
02  12345  mooos
02  12346  the
01  AbCde  whole
01  abcde  day
01  zyx    .
], [])

AT_CLEANUP


AT_SETUP([SORT: table (3)])
AT_KEYWORDS([runmisc SORT])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 K                 PIC 9(2).

       01 CNT1              PIC 9(9) COMP-5 VALUE 4.
       01 TAB1.
          05 ROW1 OCCURS 1 TO 4 DEPENDING CNT1
                                  DESCENDING TAB1-NR.
             10 TAB1-NR     PIC 99.
             10 TAB-DATA    PIC X(5).
       01 TAB2.
          05 ROW2 OCCURS 1 TO 4 DEPENDING CNT1
                                  ASCENDING ROW2.
             10 TAB2-NR     PIC 99.
             10 TAB2-DATA   PIC X(5).

       PROCEDURE DIVISION.
       A.
           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             MOVE K     TO TAB1-NR (K)
             MOVE 'BLA' TO TAB-DATA(K)
           END-PERFORM

           SORT ROW1

           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             DISPLAY TAB1-NR(K) NO ADVANCING END-DISPLAY
           END-PERFORM

           MOVE TAB1 TO TAB2
           SORT ROW2

           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             DISPLAY TAB2-NR(K) NO ADVANCING END-DISPLAY
           END-PERFORM

           STOP RUN.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog2.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 K                 PIC 9(2).

       01 CNT1              PIC 9(9) COMP-5 VALUE 4.
       01 TAB1.
          05 ROW1 OCCURS 5        DESCENDING TAB1-NR.
             10 TAB1-NR     PIC 99 VALUE ZERO.
             10 TAB-DATA    PIC X(5).
       01 TAB2.
          05 ROW1 OCCURS 1 TO 4 DEPENDING CNT1
                                  DESCENDING TAB1-NR.
             10 TAB1-NR     PIC 99.
             10 TAB-DATA    PIC X(5).

       PROCEDURE DIVISION.
       A.
           DISPLAY TAB1-NR OF TAB1 (2) NO ADVANCING END-DISPLAY

           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             MOVE K     TO TAB1-NR  OF TAB2(K)
             MOVE 'BLA' TO TAB-DATA OF TAB2(K)
           END-PERFORM

           SORT ROW1 OF TAB2.

           PERFORM VARYING K FROM 1 BY 1 UNTIL K > 4
             DISPLAY TAB1-NR OF TAB2(K) NO ADVANCING END-DISPLAY
           END-PERFORM

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [0403020101020304], [])

AT_CHECK([$COMPILE prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0], [0004030201], [])

AT_CLEANUP


AT_SETUP([SORT: table (toplevel)])
AT_KEYWORDS([runmisc SORT])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 VAL           PIC X(5) VALUE "43512".
       01 TBL           REDEFINES VAL PIC X OCCURS 5.
       PROCEDURE        DIVISION.
           SORT TBL ASCENDING
           IF VAL NOT = "12345" DISPLAY VAL.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([SORT: EBCDIC table])
AT_KEYWORDS([runmisc SORT ALPHABET OBJECT-COMPUTER])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           ALPHABET ALPHA IS EBCDIC.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 Z  PIC X(10)  VALUE "d4b2e1a3c5".
       01 G.
         02 TBL         OCCURS 10.
           03 X         PIC X.
       PROCEDURE        DIVISION.
           MOVE Z TO G.
      *    alphabet-name as collation:
           SORT TBL ASCENDING KEY X SEQUENCE ALPHA.
           IF G NOT = "abcde12345"
              DISPLAY G.
           MOVE Z TO G.
      *    code-name as collation:
           SORT TBL DESCENDING KEY X SEQUENCE EBCDIC.
           IF G NOT = "54321edcba"
              DISPLAY G.
           STOP RUN.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
           OBJECT-COMPUTER.
             x86 PROGRAM COLLATING SEQUENCE IS EBCDIC-CODE.
       SPECIAL-NAMES.
           ALPHABET EBCDIC-CODE IS EBCDIC.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 Z  PIC X(10)  VALUE "d4b2e1a3c5".
       01 G.
         02 TBL         OCCURS 10.
           03 X         PIC X.
       PROCEDURE        DIVISION.
           MOVE Z TO G.
           SORT TBL ASCENDING KEY X.
           IF G NOT = "abcde12345"
              DISPLAY G.
           MOVE Z TO G.
           SORT TBL DESCENDING KEY X.
           IF G NOT = "54321edcba"
              DISPLAY G.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0], [], [])

AT_CLEANUP


AT_SETUP([Alphanum comparison with default COLLATING SEQUENCE])
AT_KEYWORDS([runmisc EBCDIC ASCII default-colseq])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
      >>IF   EXPECT-ORDER  =  'ASCII'
           IF "1" NOT < "a"
      >>ELIF EXPECT-ORDER  =  'EBCDIC'
           IF "a" NOT < "1"
      >>END-IF
              DISPLAY "ERROR" END-DISPLAY
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=ascii -DEXPECT-ORDER=ASCII -o ascii prog.cob], [0], [],
[prog.cob:6: warning: expression '1' GREATER OR EQUAL 'a' is always FALSE
])
AT_CHECK([$COBCRUN_DIRECT ./ascii], [0], [], [])

AT_CHECK([$COMPILE -fdefault-colseq=ebcdic -DEXPECT-ORDER=EBCDIC -o ebcdic prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./ebcdic], [0], [], [])

AT_CLEANUP


AT_SETUP([SORT: table with default COLLATING SEQUENCE])
AT_KEYWORDS([runmisc SORT EBCDIC ASCII default-colseq])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 Z  PIC X(10)  VALUE "d4b2e1a3c5".
       01 G             REDEFINES Z.
         02 TBL         OCCURS 10.
           03 X         PIC X.
       PROCEDURE        DIVISION.
           SORT TBL ASCENDING KEY X.
      >>IF   EXPECT-ORDER  =  'ASCII'
           IF G NOT = "12345abcde"
      >>ELIF EXPECT-ORDER  =  'EBCDIC'
           IF G NOT = "abcde12345"
      >>ELSE           *>  =  'NATIVE'
           IF NOT G = "12345abcde" OR "abcde12345"
      >>END-IF
              DISPLAY G END-DISPLAY
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=ascii -DEXPECT-ORDER=ASCII -o ascii prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./ascii], [0], [], [])
AT_CHECK([$COMPILE -fdefault-colseq=ebcdic -DEXPECT-ORDER=EBCDIC -o ebcdic prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./ebcdic], [0], [], [])
AT_CHECK([$COMPILE -fdefault-colseq=native -DEXPECT-ORDER=NATIVE -o native prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./native], [0], [], [])

AT_CLEANUP


AT_SETUP([JUSTIFIED and VALUE clauses])
AT_KEYWORDS([runmisc JUST RIGHT INITIALIZE ibm])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. PROG.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  ARR-ARRAY.
           03  ARR-ENTRY       OCCURS 6 TIMES.
               05 ARR-FLD1             PIC X(10)
                   VALUE 'RIGHT' JUSTIFIED RIGHT.
               05 ARR-FLD2             PIC X(10)
                   VALUE 'LEFT'.
               05  ARR-FLD3        OCCURS 6 TIMES.
                   10 ARR-FLD4             PIC X(10)
                       VALUE 'RIGHT' JUSTIFIED RIGHT.
                   10 ARR-FLD5             PIC X(10)
                       VALUE 'LEFT'.

       01  CNTR                        PIC S9(4)  COMP.
       01  CNTR2                       PIC S9(4)  COMP.

       77  ELE                         PIC X(10)
                   VALUE 'RIGHT' JUSTIFIED RIGHT.
       77  ELE2                        PIC X(10)
                   VALUE 'R' JUSTIFIED RIGHT.
       77  ELE3                        PIC X(10)
                   VALUE 'RRRRRRRRR' JUSTIFIED RIGHT.
       77  ELE4                        PIC X(10)
                   VALUE 'RRRRRRRRRR' JUSTIFIED RIGHT.
       77  ELE5                        PIC X(1003)
                   VALUE 'RRR' JUSTIFIED RIGHT.

       PROCEDURE DIVISION.

           >>IF JUSTIFY EQUAL 'JUSTIFY'
               PERFORM 1000-JUSTIFY-IS-RIGHT THRU 1000-EXIT.
           >>ELSE
               PERFORM 2000-JUSTIFY-IS-OFF   THRU 2000-EXIT.
           >>END-IF

           IF ELE4 NOT EQUAL 'RRRRRRRRRR'
               DISPLAY 'ELE4 NOT INITIALIZED CORRECTLY' ELE4
           END-IF.

           STOP RUN.


       1000-JUSTIFY-IS-RIGHT.

           IF ELE NOT EQUAL '     RIGHT'
               DISPLAY 'ELE NOT INITIALIZED CORRECTLY ' ELE
           END-IF.

           IF ELE2 NOT EQUAL '         R'
               DISPLAY 'ELE2 NOT INITIALIZED CORRECTLY ' ELE2
           END-IF.

           IF ELE3 NOT EQUAL ' RRRRRRRRR'
               DISPLAY 'ELE3 NOT INITIALIZED CORRECTLY ' ELE3
           END-IF.

           IF ELE5 (1:1000) NOT EQUAL SPACES
           OR ELE5 (1001:)  NOT EQUAL "RRR"
               DISPLAY 'ELE5 NOT INITIALIZED CORRECTLY ' ELE5
           END-IF.

           IF ARR-FLD1 (2) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD1 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (2) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (6) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD1 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (2,3) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD4 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (2,3) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (6,6) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD4 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (6,6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           MOVE ALL 'X'                TO ARR-ARRAY.
           MOVE ALL 'X'                TO ELE.

           INITIALIZE ELE       WITH FILLER ALL TO VALUE.
           INITIALIZE ARR-ARRAY WITH FILLER ALL TO VALUE.

           IF ELE NOT EQUAL '     RIGHT'
               DISPLAY 'ELE NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (2) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD1 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (2) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (6) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD1 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (2,3) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD4 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (2,3) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (6,6) NOT EQUAL '     RIGHT'
               DISPLAY 'ARR-FLD4 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (6,6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

       1000-EXIT.  EXIT.


       2000-JUSTIFY-IS-OFF.

           IF ELE NOT EQUAL 'RIGHT     '
               DISPLAY 'ELE NOT INITIALIZED CORRECTLY ' ELE
           END-IF.

           IF ELE2 NOT EQUAL 'R         '
               DISPLAY 'ELE2 NOT INITIALIZED CORRECTLY ' ELE2
           END-IF.

           IF ELE3 NOT EQUAL 'RRRRRRRRR '
               DISPLAY 'ELE3 NOT INITIALIZED CORRECTLY ' ELE3
           END-IF.

           IF ELE5 (1:3) NOT EQUAL "RRR"
           OR ELE5 (4:)  NOT EQUAL SPACES
               DISPLAY 'ELE5 NOT INITIALIZED CORRECTLY ' ELE5
           END-IF.

           IF ARR-FLD1 (2) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD1 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (2) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (6) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD1 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (2,3) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD4 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (2,3) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (6,6) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD4 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (6,6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           MOVE ALL 'X'                TO ARR-ARRAY.
           MOVE ALL 'X'                TO ELE.

           INITIALIZE ELE       WITH FILLER ALL TO VALUE.
           INITIALIZE ARR-ARRAY WITH FILLER ALL TO VALUE.

           IF ELE NOT EQUAL 'RIGHT     '
               DISPLAY 'ELE NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (2) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD1 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (2) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (2) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD1 (6) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD1 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD2 (6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD2 (6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (2,3) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD4 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (2,3) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (2,3) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD4 (6,6) NOT EQUAL 'RIGHT     '
               DISPLAY 'ARR-FLD4 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

           IF ARR-FLD5 (6,6) NOT EQUAL 'LEFT      '
               DISPLAY 'ARR-FLD5 (6,6) NOT INITIALIZED CORRECTLY'
           END-IF.

       2000-EXIT.  EXIT.


       END PROGRAM PROG.

])

AT_CHECK([$COMPILE -std=ibm -DJUSTIFY=JUSTIFY -o prog  prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE -std=cobol2014 -DJUSTIFY=OFF -o prog  prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([SEARCH ALL: table with default COLLATING SEQUENCE])
AT_KEYWORDS([runmisc EBCDIC ASCII default-colseq])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 Z  PIC X(10)  VALUE "d4b2e1a3c5".
       01 G             REDEFINES Z.
         02 TBL         OCCURS 10 ASCENDING KEY K INDEXED BY I.
           03 K         PIC X.
       01 KK            PIC X.
       PROCEDURE        DIVISION.
           SORT TBL ASCENDING KEY K.
           MOVE "3" TO KK
           SEARCH ALL TBL
              AT END
                 DISPLAY KK " NOT FOUND"
              WHEN K (I) = KK
                 CONTINUE
           END-SEARCH
      >>IF   EXPECT-ORDER  =  'ASCII'
           IF I NOT = 3
      >>ELIF EXPECT-ORDER  =  'EBCDIC'
           IF I NOT = 8
      >>END-IF
              DISPLAY "ERROR" END-DISPLAY
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=ascii -DEXPECT-ORDER=ASCII -o ascii prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./ascii], [0], [], [])

AT_CHECK([$COMPILE -fdefault-colseq=ebcdic -DEXPECT-ORDER=EBCDIC -o ebcdic prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./ebcdic], [0], [], [])

AT_CLEANUP


AT_SETUP([SEARCH ALL with non-0xff HIGH-VALUE])
AT_KEYWORDS([runmisc default-colseq])

# This originates from a coding pattern we've witnessed in a code base.
# When using a collating sequence that loads to HIGH-VALUE not being 0xff
# (typically EBCDIC-500 / Latin-1), this used to fail.

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  TAB.
         02 TAB-ELT   OCCURS 3
                      ASCENDING KEY TAB-KEY
                      INDEXED BY TI.
           05 TAB-KEY PIC X.
       PROCEDURE DIVISION.
           MOVE ALL HIGH-VALUE TO TAB
           MOVE "1" TO TAB-ELT (1)
      *    DISPLAY "|" TAB "|"
           SEARCH ALL TAB-ELT
              AT END
                 DISPLAY '"1" NOT FOUND'
              WHEN TAB-KEY (TI) = "1"
                 CONTINUE
           END-SEARCH
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=EBCDIC -febcdic-table=ebcdic500_latin1 prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fdefault-colseq=ASCII -febcdic-table=ebcdic500_latin1 prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PIC ZZZ-, ZZZ+])
AT_KEYWORDS([runmisc editing])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  X-ZZZN                    PIC ZZZ-.
       01  XZN-RED REDEFINES X-ZZZN  PIC X(4).
       01  X-ZZZP                    PIC ZZZ+.
       01  XZP-RED REDEFINES X-ZZZP  PIC X(4).
       PROCEDURE        DIVISION.
           MOVE -1 TO X-ZZZN.
           IF XZN-RED NOT = "  1-"
              DISPLAY "(" X-ZZZN ")".
           MOVE  0 TO X-ZZZN.
           IF XZN-RED NOT = "    "
              DISPLAY "(" X-ZZZN ")".
           MOVE +1 TO X-ZZZN.
           IF XZN-RED NOT = "  1 "
              DISPLAY "(" X-ZZZN ")".

           MOVE -1 TO X-ZZZP.
           IF XZP-RED NOT = "  1-"
              DISPLAY "(" X-ZZZP ")".
           MOVE  0 TO X-ZZZP.
           IF XZP-RED NOT = "    "
              DISPLAY "(" X-ZZZP ")".
           MOVE +1 TO X-ZZZP.
           IF XZP-RED NOT = "  1+"
              DISPLAY "(" X-ZZZP ")".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PERFORM type OSVS])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  MYOCC        PIC 9(8) VALUE 0.
       PROCEDURE        DIVISION.
       ASTART SECTION.
       A01.
           PERFORM BTEST.
           IF MYOCC NOT = 2
              DISPLAY MYOCC.
           STOP RUN.
       BTEST SECTION.
       B01.
           PERFORM B02 VARYING MYOCC FROM 1 BY 1
                   UNTIL MYOCC > 5.
           GO TO B99.
       B02.
           IF MYOCC > 1
              GO TO B99
           END-IF.
       B99.
           EXIT.
      *> expected without -fperform-osvs: fall through here _SHOULD_ abort with -fsection-exit-check
])

AT_CHECK([$COMPILE -fperform-osvs prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Sticky LINKAGE])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       01 P3            PIC X(6).
       PROCEDURE        DIVISION USING P1 P2.
           IF P1 = "A"
              SET ADDRESS OF P3 TO ADDRESS OF P2
           ELSE
              IF P3 NOT = "OKOKOK"
                 DISPLAY P3
                 END-DISPLAY
              END-IF
           END-IF.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P1            PIC X    VALUE "A".
       01 P2            PIC X(6) VALUE "NOT OK".
       PROCEDURE        DIVISION.
           CALL "callee" USING P1 P2
           END-CALL.
           MOVE "B"      TO P1.
           MOVE "OKOKOK" TO P2.
           CALL "callee" USING P1
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE -fsticky-linkage callee.cob], [0], [], [])
AT_CHECK([$COMPILE -fsticky-linkage caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([COB_PRE_LOAD])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee2"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([COB_PRE_LOAD=callee $COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([COB_PRE_LOAD with entry points])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID. prog.

        DATA DIVISION.
        WORKING-STORAGE SECTION.

        01 VAR1 PIC X(5) VALUE '12abc'.
        01 VAR2 PIC X(2) VALUE '11'.

        PROCEDURE DIVISION.

        ENTRY 'ent1'.
        DISPLAY VAR1 END-DISPLAY
        GOBACK.

        ENTRY 'ent2'.
        DISPLAY VAR2 END-DISPLAY
        GOBACK.
])

AT_DATA([prog1.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID. prog1.

        DATA DIVISION.
        WORKING-STORAGE SECTION.

        01 VAR2 PIC X(2) VALUE '55'.
        01 VAR3 PIC X(5) VALUE 'xxxxx'.

        PROCEDURE DIVISION.

        ENTRY 'ent2'.
        DISPLAY VAR2 END-DISPLAY
        GOBACK.

        ENTRY 'ent3'.
        DISPLAY VAR3 END-DISPLAY
        GOBACK.
])

AT_DATA([main-prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID. main-prog.
        DATA DIVISION.
        WORKING-STORAGE SECTION.
        PROCEDURE DIVISION.

        CALL 'ent1' END-CALL
        CALL 'ent2' END-CALL
        CALL 'ent3' END-CALL

        STOP RUN.
])

AT_CHECK([$COMPILE_MODULE prog.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE prog1.cob], [0], [], [])
AT_CHECK([$COMPILE main-prog.cob], [0], [], [])
AT_CHECK([COB_PRE_LOAD="prog"$PATHSEP"prog1" $COBCRUN_DIRECT ./main-prog], [0],
[12abc
11
xxxxx
], [])

AT_CLEANUP


AT_SETUP([Lookup ENTRY from main executable])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 PROGRAM-LINK         USAGE PROGRAM-POINTER.

       PROCEDURE DIVISION.
       SET PROGRAM-LINK TO ENTRY "subprogram"
       IF PROGRAM-LINK EQUAL NULL THEN
           DISPLAY "error: no subprogram linkage" UPON SYSERR
           END-DISPLAY
       ELSE
           CALL PROGRAM-LINK
               ON EXCEPTION
                   DISPLAY "hard error: unable to invoke subprogram"
                      UPON SYSERR
                   END-DISPLAY
           END-CALL
           DISPLAY RETURN-CODE WITH NO ADVANCING
           END-DISPLAY
       END-IF
       GOBACK.

       ENTRY "subprogram".
           DISPLAY "subprogram" WITH NO ADVANCING
           END-DISPLAY
           SET RETURN-CODE TO 42
       .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [42], [subprogram+000000042], [])

AT_CLEANUP


AT_SETUP([COB_LOAD_CASE=UPPER])
AT_KEYWORDS([runmisc CALL COB_LOAD_CASE])

AT_DATA([CALLEE.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       PROCEDURE        DIVISION.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee"
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE CALLEE.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([COB_LOAD_CASE=UPPER ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([ALLOCATE / FREE with BASED item (1)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01  MYFLD        PIC X(6) BASED VALUE "ABCDEF".
       PROCEDURE        DIVISION.
       ASTART SECTION.
       A01.
           ALLOCATE MYFLD INITIALIZED
           IF MYFLD NOT = "ABCDEF"
              DISPLAY MYFLD
           END-IF
           FREE ADDRESS OF MYFLD
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([ALLOCATE / FREE with BASED item (2)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 MYFLD         BASED.
             03 MYFLDX  PIC X.
             03 MYFLD9  PIC 9.
       PROCEDURE        DIVISION.
           IF ADDRESS OF MYFLD NOT = NULL
              DISPLAY "BASED ITEM WITH ADDRESS ON START"
           END-IF
           FREE MYFLD
           ALLOCATE MYFLD
           IF ADDRESS OF MYFLD = NULL
              DISPLAY "BASED ITEM WITHOUT ADDRESS AFTER ALLOCATE"
           END-IF
           INITIALIZE MYFLD
           IF MYFLD NOT = " 0"
              DISPLAY "BASED ITEM INITIALIZED WRONG: "
                 WITH NO ADVANCING
              END-DISPLAY
              DISPLAY MYFLD
           END-IF

           FREE ADDRESS OF MYFLD
           IF ADDRESS OF MYFLD NOT = NULL
              DISPLAY "BASED ITEM WITH ADDRESS AFTER FREE"
           END-IF
           GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
# Run both executable and module as we have a different code generation here
AT_CHECK([$COMPILE_MODULE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN prog], [0], [], [])

AT_CLEANUP


AT_SETUP([ALLOCATE CHARACTERS INITIALIZED (TO)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  MYPTR        USAGE POINTER.
       LINKAGE          SECTION.
       01  MYFLD        PIC X(4).
       PROCEDURE        DIVISION.
       ASTART SECTION.
       A01.
           ALLOCATE 4 CHARACTERS
                    INITIALIZED TO "ABCD"
                    RETURNING MYPTR
           SET ADDRESS OF MYFLD TO MYPTR
           IF MYFLD NOT = "ABCD"
              DISPLAY MYFLD
           END-IF
           FREE MYPTR
           ALLOCATE 4 CHARACTERS
                    INITIALIZED TO ALL "Z"
                    RETURNING MYPTR
           SET ADDRESS OF MYFLD TO MYPTR
           IF MYFLD NOT = "ZZZZ"
              DISPLAY MYFLD
           END-IF
           FREE MYPTR
           ALLOCATE 4 CHARACTERS
                    INITIALIZED
                    RETURNING MYPTR
           SET ADDRESS OF MYFLD TO MYPTR
           IF MYFLD NOT = LOW-VALUES
              DISPLAY MYFLD
           END-IF
           FREE MYPTR
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Initialized value with defaultbyte])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  MYFLD        PIC X(6).
       PROCEDURE        DIVISION.
       ASTART SECTION.
       A01.
           IF MYFLD NOT = "AAAAAA"
              DISPLAY MYFLD
           END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefaultbyte=A prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([CALL with OMITTED parameter])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 OPTIONAL P2.
           IF P2 NOT OMITTED
              DISPLAY P2
           END-IF
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P1            PIC X    VALUE "A".
       PROCEDURE        DIVISION.
           CALL "callee" USING P1
           CALL "callee" USING P1 OMITTED
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([direct CALL in from C w/wo error])
AT_KEYWORDS([runmisc cobcall cob_call cob_init cob_runtime_hint])

# tests and showcases direct C calls, including:
# as long as the module comes back the caller has control
# and its return code; but not in the case for errors or STOP RUN

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 OPTIONAL P2.
           IF P2 NOT OMITTED
              DISPLAY 'UNEXPECTED P2: ' P2
              END-DISPLAY
           END-IF
           DISPLAY 'P1: ' P1 WITH NO ADVANCING.
           GOBACK.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P             PIC 99.
       PROCEDURE        DIVISION USING P.
           DISPLAY 'P: ' P WITH NO ADVANCING.
           STOP RUN RETURNING P.
])

AT_DATA([caller.c], [[
#include <stdio.h>
#include <libcob.h>

#ifndef NULL
#define NULL (void*)0
#endif

int
main (int argc, char **argv)
{
   /* for storing COBOL return code */
   int cob_ret;

   /* initialize parameters */
   void *cob_argv[2];

   cob_argv[0] = argv[2];
   cob_argv[1] = NULL;

   /* initialize the COBOL run-time library */
   cob_init(argc, argv);

   /* call COBOL program */
   cob_ret = cob_call (argv[1], 2, cob_argv);

   cob_runtime_hint("program exited normally, "
       "without STOP RUN with status %d", cob_ret);

   /* Clean up and terminate - This does not return */
   cob_stop_run (cob_ret);
}
]])

AT_CHECK([$COMPILE caller.c], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob callee2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller callee A], [0], [P1: A],
[note: program exited normally, without STOP RUN with status 0
])
AT_CHECK([$COBCRUN_DIRECT ./caller callee2 42], [42], [P: 42], [])
AT_CHECK([$COBCRUN_DIRECT ./caller notthere], [1], [],
[libcob: error: module 'notthere' not found
])

AT_CLEANUP


AT_SETUP([direct CALL in from C w/wo error; no exit])
AT_KEYWORDS([runmisc cobcall cob_call cob_call_with_exception_check cob_runtime_hint])

# tests and showcases the "functional call" of GnuCOBOL modules;
# in every case (plain goback, STOP RUN, error) the caller gets control,
# but the actual return / error code has to be queried with an extra call

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 RC            PIC 99.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 RC OPTIONAL P2.
           IF P2 NOT OMITTED
              DISPLAY 'UNEXPECTED P2: ' P2.
           DISPLAY 'P1: ' P1 WITH NO ADVANCING
           GOBACK RETURNING RC.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           DISPLAY 'STOP WITH 2' WITH NO ADVANCING
           STOP RUN RETURNING 2.
])

AT_DATA([buggy.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      buggy.
       DATA             DIVISION.
       LOCAL-STORAGE    SECTION.
       77 VAR           PIC X.
       77 VPOS          PIC 9 VALUE 2.
       PROCEDURE        DIVISION.
           DISPLAY 'out of bounds - refmod following' WITH NO ADVANCING
           DISPLAY VAR (VPOS:)
           DISPLAY 'AFTER ERROR'
           GOBACK.
])

AT_DATA([caller.c], [[
#include <stdio.h>
#include <libcob.h>

#ifndef NULL
#define NULL (void*)0
#endif

int
main (int argc, char **argv)
{
   /* for storing libcob return state */
   int cob_ret;

   /* initialize parameters */
   void *cob_argv[3];

   char *p1 = "A";
   cob_argv[0] = p1;
   cob_argv[1] = argv[2];
   cob_argv[2] = NULL;

   /* initialize the COBOL run-time library */
   cob_init (argc, argv);

   /* call COBOL program */
   cob_ret = cob_call_with_exception_check (argv[1], 2, cob_argv);

   switch (cob_ret) {
   case 0:  /* program coming back */

      /* Clean up and terminate runtime */
      cob_runtime_hint ("program exited with return code %d",
         cob_last_exit_code ());
      cob_tidy ();
      break;

   case 1:  /* normal exit */
      cob_runtime_hint ("STOP RUN with return code %d",
         cob_last_exit_code ());
      break;

   case -1:  /* error exit */
      cob_runtime_hint ("error exit with return code %d and error \"%s\"",
         cob_last_exit_code (), cob_last_runtime_error ());
      break;

   case -2:  /* hard error exit */
      cob_runtime_hint ("hard error exit with return code %d and error \"%s\"",
         cob_last_exit_code (), cob_last_runtime_error ());
      break;

   case -3:  /* signal handler  exit */
      cob_runtime_hint ("signal handler exit with signal %d and error \"%s\"",
         cob_last_exit_code (), cob_last_runtime_error ());
      break;

   default:
      cob_runtime_hint ("unexpected return from cob_call_with_exception_check, "
         "last exit code %d, last error \"%s\"",
         cob_last_exit_code (), cob_last_runtime_error ());
      break;
   }
   return 0;
}
]])

AT_CHECK([$COMPILE caller.c], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob callee2.cob buggy.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller callee 00], [0], [P1: A],
[note: program exited with return code 0
])
AT_CHECK([$COBCRUN_DIRECT ./caller callee 42], [0], [P1: A],
[note: program exited with return code 42
])
AT_CHECK([$COBCRUN_DIRECT ./caller callee2], [0], [STOP WITH 2],
[note: STOP RUN with return code 2
])
AT_CHECK([$COBCRUN_DIRECT ./caller notthere], [0], [],
[libcob: error: module 'notthere' not found
note: error exit with return code -1 and error "module 'notthere' not found"
])
AT_CHECK([$COBCRUN_DIRECT ./caller buggy], [0], [out of bounds - refmod following],
[libcob: buggy.cob:10: error: offset of 'VAR' out of bounds: 2, maximum: 1
note: error exit with return code -1 and error "buggy.cob:10: offset of 'VAR' out of bounds: 2, maximum: 1"
])

AT_CLEANUP


AT_SETUP([CALL in from C, cob_call_params explicitly set])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 OPTIONAL P2.
           IF P2 NOT OMITTED
              DISPLAY 'UNEXPECTED P2: ' P2
           END-IF
           DISPLAY 'P1: ' P1 WITH NO ADVANCING
           EXIT PROGRAM.
])

AT_DATA([caller.c], [[
#include <stdio.h>
#include <libcob.h>

int callee (char *, char *);

#ifndef NULL
#define NULL (void*)0
#endif

int
main (int argc, char **argv)
{
   /* for storing COBOL return code */
   int cob_ret;

   /* initialize parameters */
   char *p1 = "A";

   /* initialize the COBOL run-time library */
   cob_init(argc, argv);

   /* call COBOL program via 'entry point' */
   cob_ret = cob_call_entry ((void*)callee, 1, p1);

   /* Clean up and terminate - This does not return */
   cob_stop_run (cob_ret);
}
]])

AT_CHECK([$COMPILE -o caller caller.c callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [P1: A], [])

AT_CLEANUP


AT_SETUP([CALL in from C, number of parameters unknown])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 P2.
           IF P1 NOT EQUAL "A"
              DISPLAY P1.
           IF P2 NOT EQUAL "FROM C"
              DISPLAY P2
              END-DISPLAY
           ELSE
              DISPLAY "OK" WITH NO ADVANCING.
           EXIT PROGRAM.
])

AT_DATA([caller.c], [[
#include <stdio.h>
#include <libcob.h>

int callee (char *, char *);

int
main (int argc, char **argv)
{
   /* for storing COBOL return code */
   int cob_ret;

   /* initialize parameters */
   char *p1 = "A";
   char *p2 = "FROM C";

   /* initialize the COBOL run-time library */
   cob_init (argc, argv);

   /* call COBOL program directly */
   cob_ret = callee (p1, p2);

   /* call COBOL program by name */
   cob_ret = cob_call_cobol ("callee", 2, p1, p2);

   /* Clean up and terminate - This does not return */
   cob_stop_run (cob_ret);
}
]])

AT_CHECK([$COMPILE -o caller caller.c callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [OKOK], [])

AT_CLEANUP


AT_SETUP([CALL C with callback, PROCEDURE DIVISION EXTERN])
AT_KEYWORDS([runmisc extensions call-convention])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 CB            USAGE PROGRAM-POINTER.
       PROCEDURE        DIVISION.
           SET CB TO ENTRY "callback"
           CALL STATIC "cprog" USING BY VALUE CB
           END-CALL
           EXIT PROGRAM.
       END PROGRAM prog.

       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callback.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CALL-CONVENTION 0 IS EXTERN.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            USAGE POINTER.
       01 P2            USAGE BINARY-LONG.
       01 P3            PIC X(8).
       PROCEDURE        DIVISION EXTERN USING
                        BY VALUE P1 P2 BY REFERENCE P3.
           IF P1 NOT EQUAL ADDRESS OF P3
              DISPLAY P1
              END-DISPLAY
           END-IF
           IF P2 NOT EQUAL 42
              DISPLAY P2
              END-DISPLAY
           END-IF
           IF P3 NOT EQUAL "CALLBACK"
              DISPLAY P3
              END-DISPLAY
           END-IF
           EXIT PROGRAM.
])

AT_DATA([cprog.c], [[
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
cprog (void *cb)
{
   char *p1;
   int  p2 = 42;
   char *p3 = "CALLBACK";

   p1 = p3;
   /* call COBOL program via 'entry point' */
   cob_call_entry (cb, 3, p1, p2, p3);
   return 0;
}
]])

AT_CHECK([$COMPILE -Wno-unfinished -o prog prog.cob cprog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([CALL C with callback, ENTRY-CONVENTION EXTERN])
AT_KEYWORDS([runmisc CALL-CONVENTION LINKAGE OPTIONS])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       OPTIONS.
           ENTRY-CONVENTION COBOL.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 CB            USAGE PROGRAM-POINTER.
       PROCEDURE        DIVISION.
           SET CB TO ENTRY "callback"
           CALL STATIC "cprog" USING BY VALUE CB
           END-CALL
           EXIT PROGRAM.
       END PROGRAM prog.

       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callback.
       OPTIONS.
           ENTRY-CONVENTION EXTERN.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            USAGE POINTER.
       01 P2            USAGE BINARY-LONG.
       01 P3            PIC X(8).
       PROCEDURE        DIVISION USING
                        BY VALUE P1 P2 BY REFERENCE P3.
           IF P1 NOT EQUAL ADDRESS OF P3
              DISPLAY P1
              END-DISPLAY
           END-IF
           IF P2 NOT EQUAL 42
              DISPLAY P2
              END-DISPLAY
           END-IF
           IF P3 NOT EQUAL "CALLBACK"
              DISPLAY P3
              END-DISPLAY
           END-IF
           EXIT PROGRAM.
])

AT_DATA([cprog.c], [[
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
cprog (void *cb)
{
   char *p1;
   int  p2 = 42;
   char *p3 = "CALLBACK";

   p1 = p3;
   cob_call_entry (cb, 3, p1, p2, p3);
   return 0;
}
]])

AT_CHECK([$COMPILE -Wno-unfinished -o prog prog.cob cprog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 CB            USAGE PROGRAM-POINTER.
       PROCEDURE        DIVISION.
           SET CB TO ENTRY "callback"
           CALL STATIC "cprog" USING BY VALUE CB
           END-CALL
           EXIT PROGRAM.
       END PROGRAM prog.

       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callback.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            USAGE POINTER.
       01 P2            USAGE BINARY-LONG.
       01 P3            PIC X(8).
       PROCEDURE        DIVISION WITH C LINKAGE
                        USING BY VALUE P1 P2 BY REFERENCE P3.
           IF P1 NOT EQUAL ADDRESS OF P3
              DISPLAY P1
              END-DISPLAY
           END-IF
           IF P2 NOT EQUAL 42
              DISPLAY P2
              END-DISPLAY
           END-IF
           IF P3 NOT EQUAL "CALLBACK"
              DISPLAY P3
              END-DISPLAY
           END-IF
           EXIT PROGRAM.
])

AT_DATA([prog3.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 CB            USAGE PROGRAM-POINTER.
       PROCEDURE        DIVISION.
           SET CB TO ENTRY "callback"
           CALL STATIC "cprog" USING BY VALUE CB
           END-CALL
           EXIT PROGRAM.
       END PROGRAM prog.

       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callback.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CALL-CONVENTION 0 IS EXTERN.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            USAGE POINTER.
       01 P2            USAGE BINARY-LONG.
       01 P3            PIC X(8).
       PROCEDURE        DIVISION EXTERN
                        USING BY VALUE P1 P2 BY REFERENCE P3.
           IF P1 NOT EQUAL ADDRESS OF P3
              DISPLAY P1
              END-DISPLAY
           END-IF
           IF P2 NOT EQUAL 42
              DISPLAY P2
              END-DISPLAY
           END-IF
           IF P3 NOT EQUAL "CALLBACK"
              DISPLAY P3
              END-DISPLAY
           END-IF
           EXIT PROGRAM.
])

AT_CHECK([$COMPILE -Wno-unfinished -o prog prog2.cob cprog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -Wno-unfinished -o prog prog3.cob cprog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([CALL in from C with init missing / implicit])
AT_KEYWORDS([runmisc implicit-init])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 P1            PIC X.
       01 P2            PIC X(6).
       PROCEDURE        DIVISION USING P1 P2.
           IF P1 NOT EQUAL "A"
              DISPLAY P1.
           IF P2 NOT EQUAL "FROM C"
              DISPLAY P2
              END-DISPLAY
           ELSE
              DISPLAY "OK" WITH NO ADVANCING.
           STOP RUN.
])

AT_DATA([caller.c], [[
int callee (char *, char *);

int
main (int argc, char **argv)
{
   /* initialize parameters */
   char *p1 = "A";
   char *p2 = "FROM C";

   /* call COBOL program (initialization missing)
      note: COBOL program terminates the program by STOP RUN */
   (void)callee (p1, p2);
   return 0;
}
]])

AT_CHECK([$COMPILE -o caller caller.c callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: error: cob_init() has not been called
])

AT_CHECK([$COMPILE -fimplicit-init -o caller caller.c callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [OK], [])

AT_CLEANUP


AT_SETUP([CALL STATIC C from COBOL])
AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P1            PIC X VALUE "A".
       01 P2            PIC X(7).
       77 P2-COB        PIC X(7).
       PROCEDURE        DIVISION.
           CALL STATIC 'callee' USING P1 P2
           IF P1 NOT EQUAL "B"
              DISPLAY 'NOT A: ' P1
              END-DISPLAY
           END-IF
           UNSTRING P2 DELIMITED BY LOW-VALUE
              INTO P2-COB
           END-UNSTRING
           EVALUATE TRUE
              WHEN P2-COB NOT EQUAL "FROM C"
                 DISPLAY P2-COB '-' P2
                 END-DISPLAY
              WHEN RETURN-CODE NOT = 3
                 DISPLAY RETURN-CODE
                 END-DISPLAY
              WHEN OTHER
                 DISPLAY 'OK'  WITH NO ADVANCING
                 END-DISPLAY
                 MOVE 0  TO RETURN-CODE
           END-EVALUATE
           EXIT PROGRAM.
])

AT_DATA([callee.c], [[
#include <string.h>

int
callee (char *p1, char *p2)
{
   if (p1[0] == 'A') {
      p1[0] = 'B';
   }
   memcpy (p2, "FROM C", 6);

   return 3;
}
]])

AT_CHECK([$COMPILE -o caller caller.cob callee.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [OK], [])

AT_CLEANUP


AT_SETUP([ANY LENGTH (1)])
AT_KEYWORDS([runmisc CALL])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P2            PIC 99.
       LINKAGE          SECTION.
       01 P1            PIC X ANY LENGTH.
       PROCEDURE        DIVISION USING P1.
           MOVE LENGTH OF P1 TO P2.
           IF P2 NOT = 6
              DISPLAY P2.
           IF P1 NOT = "OKOKOK"
              DISPLAY P1.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P1            PIC X(6) VALUE "OKOKOK".
       PROCEDURE        DIVISION.
           CALL "callee" USING P1
           END-CALL.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([ANY LENGTH (2)])
AT_KEYWORDS([runmisc CALL])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P2            PIC XXX.
       LINKAGE          SECTION.
       01 P1            PIC X ANY LENGTH.
       PROCEDURE        DIVISION USING P1.
           MOVE P1 TO P2.
           IF P2 NOT = "OK "
              DISPLAY P2.
           MOVE SPACE TO P1.
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 P1            PIC X(2) VALUE "OK".
       PROCEDURE        DIVISION.
           CALL "callee" USING P1
           END-CALL.
           IF P1 NOT = SPACE
              DISPLAY P1.
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


AT_SETUP([ANY LENGTH (3)])
AT_KEYWORDS([runmisc CALL])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 str PIC X(20) VALUE ALL "X".

       PROCEDURE DIVISION.
           CALL "subprog" USING str
           .
       END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. subprog.

       DATA DIVISION.
       LINKAGE SECTION.
       01 str PIC X ANY LENGTH.

       PROCEDURE DIVISION USING str.
           MOVE "abcd" TO str
           DISPLAY FUNCTION TRIM (str)
           MOVE "abcd" TO str (5:)
           DISPLAY FUNCTION TRIM (str)
           MOVE ALL "a" TO str
           DISPLAY FUNCTION TRIM (str)
           .
       END PROGRAM subprog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[abcd
abcdabcd
aaaaaaaaaaaaaaaaaaaa
])
AT_CLEANUP


AT_SETUP([ANY LENGTH (4)])
AT_KEYWORDS([runmisc IF CALL])

# comparison of any length was done only for first character - see bug 511

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 str PIC X(20) VALUE ALL "X".

       PROCEDURE DIVISION.
           CALL "subprog" USING str
           move '   45'   to str
           CALL "subprog" USING str
           .
       END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. subprog.

       DATA DIVISION.
       LINKAGE SECTION.
       01 str PIC X ANY LENGTH.

       PROCEDURE DIVISION USING str.
           IF str = 'X'
             DISPLAY 'X is X'
           END-IF
           IF str = space
             DISPLAY 'X is space'
           END-IF
           .
       END PROGRAM subprog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([ANY LENGTH (5)])
AT_KEYWORDS([runmisc])

# any length variables resulted in SIGSEGV when module was first program called

AT_DATA([subprog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. subprog.

       DATA DIVISION.
       LINKAGE SECTION.
       01 str1 PIC X ANY LENGTH.
       01 str2 PIC X ANY LENGTH.

       PROCEDURE DIVISION USING str1 str2.
           DISPLAY 'IN' WITH NO ADVANCING
           .
       END PROGRAM subprog.
])

AT_CHECK([$COMPILE_MODULE subprog.cob], [0], [], [])
AT_CHECK([$COBCRUN subprog some test stuff], [0], [IN], [])
AT_CLEANUP


AT_SETUP([access to BASED item without allocation])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) BASED.
       PROCEDURE        DIVISION.
           DISPLAY X NO ADVANCING
           STOP RUN.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             BASED.
          05 Y          PIC X(4).
       PROCEDURE        DIVISION.
           DISPLAY Y NO ADVANCING
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COMPILE prog2.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:8: error: BASED/LINKAGE item 'X' has NULL address
])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [1], [],
[libcob: prog2.cob:9: error: BASED/LINKAGE item 'X' (accessed by 'Y') has NULL address
])

AT_CLEANUP


AT_SETUP([access to OPTIONAL LINKAGE item not passed])
AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(4) VALUE '9876'.
       PROCEDURE        DIVISION.
           CALL 'callee' USING X
           END-CALL
           CALL 'callee' USING OMITTED
           END-CALL
           STOP RUN.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE          SECTION.
       01 X.
          05 Y          PIC X(4).
       PROCEDURE        DIVISION USING OPTIONAL X.
           IF Y NOT = '9876'
              DISPLAY Y.
           GOBACK.
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: callee.cob:9: error: LINKAGE item 'X' (accessed by 'Y') not passed by caller
])

AT_CLEANUP


AT_SETUP([STOP RUN WITH NORMAL STATUS])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           STOP RUN WITH NORMAL STATUS.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([STOP RUN WITH ERROR STATUS])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           STOP RUN WITH ERROR STATUS.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1])

AT_CLEANUP


AT_SETUP([STOP ERROR])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           CALL "prog2".
           DISPLAY "Whatever".
           STOP RUN.
       END PROGRAM      prog.
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       PROCEDURE        DIVISION.
           STOP ERROR.
])

AT_CHECK([$COMPILE prog.cob -fstop-error-statement=ok], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:12: error: STOP ERROR
])

AT_CLEANUP


AT_SETUP([SYMBOLIC clause])
AT_KEYWORDS([runmisc ALPHABET])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           ALPHABET A-EBC IS EBCDIC
           ALPHABET A-ASC IS ASCII
           SYMBOLIC Z-EBC IS 241 IN A-EBC
           SYMBOLIC Z-ASC IS  49 IN A-ASC
           .
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  Z            PIC X.
       PROCEDURE        DIVISION.
           MOVE Z-ASC   TO Z.
           IF Z NOT = "0"
              DISPLAY Z.
           MOVE Z-EBC   TO Z.
           IF Z NOT = "0"
              DISPLAY Z.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([OCCURS clause with 1 entry])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  D1.
           03  FILLER   OCCURS 1.
               05 D1-ENTRY   PIC X(03) value '123'.
       01  D2.
           03  D2-ENTRY   PIC X(03)  value 'ABC'  OCCURS 1.
       01  D1TOR.
           03  FILLER   PIC X(03) value '456'.
       01  D1-R         REDEFINES D1TOR.
           03  FILLER   OCCURS 1.
               05 D1-R-ENTRY   PIC X(03).
       01  D2TOR.
           03  FILLER   PIC X(03) value 'DEF'.
       01  D2-R         REDEFINES D2TOR.
           03  D2-R-ENTRY   PIC X(03)   OCCURS 1.

       PROCEDURE        DIVISION.
           IF D1-ENTRY (1) NOT = "123"
              DISPLAY D1-ENTRY (1).
           IF D2-ENTRY (1) NOT = "ABC"
              DISPLAY D2-ENTRY (1).
           IF D1-R-ENTRY (1) NOT = "456"
              DISPLAY D1-R-ENTRY (1).
           IF D2-R-ENTRY (1) NOT = "DEF"
              DISPLAY D2-R-ENTRY (1).
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Computing of different USAGEs w/o decimal point])
AT_KEYWORDS([runmisc
BINARY-C-LONG BINARY-CHAR BINARY-DOUBLE BINARY-LONG
COMP COMP-1 COMP-2 COMP-3 PACKED-DECIMAL COMP-5 COMP-6 COMP-X COMP-N
FLOAT-DECIMAL-16 FLOAT-DECIMAL-34 FLOAT-LONG FLOAT-SHORT])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. 'prog'.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
      *
       77  BCL-A           BINARY-C-LONG    VALUE 1.
       77  BCL-B           BINARY-C-LONG    VALUE 10.
       77  BCL-RES         BINARY-C-LONG.
      *
       77  BC-A            BINARY-CHAR      VALUE 1.
       77  BC-B            BINARY-CHAR      VALUE 10.
       77  BC-RES          BINARY-CHAR.
      *
       77  BD-A            BINARY-DOUBLE    VALUE 1.
       77  BD-B            BINARY-DOUBLE    VALUE 10.
       77  BD-RES          BINARY-DOUBLE.
      *
       77  BL-A            BINARY-LONG      VALUE 1.
       77  BL-B            BINARY-LONG      VALUE 10.
       77  BL-RES          BINARY-LONG.
      *
       77  C-A     PIC S99 COMP             VALUE 1.
       77  C-B     PIC S99 COMP             VALUE 10.
       77  C-RES   PIC S99 COMP.
      *
       77  C1-A            COMP-1           VALUE 1.
       77  C1-B            COMP-1           VALUE 10.
       77  C1-RES          COMP-1.
      *
       77  C2-A            COMP-2           VALUE 1.
       77  C2-B            COMP-2           VALUE 10.
       77  C2-RES          COMP-2.
      *
       77  C3-A    PIC S99 COMP-3           VALUE 1.
       77  C3-B    PIC S99 COMP-3           VALUE 10.
       77  C3-RES  PIC S99 COMP-3.
      *
       77  C5-A    PIC S99 COMP-5           VALUE 1.
       77  C5-B    PIC S99 COMP-5           VALUE 10.
       77  C5-RES  PIC S99 COMP-5.
      *
       77  C6-A    PIC  99 COMP-6           VALUE 1.
       77  C6-B    PIC  99 COMP-6           VALUE 10.
       77  C6-RES  PIC  99 COMP-6.
      *
       77  CN9-A   PIC  99 COMP-N           VALUE 1.
       77  CN9-B   PIC  99 COMP-N           VALUE 10.
       77  CN9-RES PIC  99 COMP-N.
      *
       77  CNX-A   PIC  X  COMP-N           VALUE 1.
       77  CNX-B   PIC  X  COMP-N           VALUE 10.
       77  CNX-RES PIC  X  COMP-N.
      *
       77  CX9-A   PIC  99 COMP-X           VALUE 1.
       77  CX9-B   PIC  99 COMP-X           VALUE 10.
       77  CX9-RES PIC  99 COMP-X.
      *
       77  CXX-A   PIC  X  COMP-X           VALUE 1.
       77  CXX-B   PIC  X  COMP-X           VALUE 10.
       77  CXX-RES PIC  X  COMP-X.
      *
       77  D-A     PIC  S99                 VALUE 1.
       77  D-B     PIC  S99                 VALUE 10.
       77  D-RES   PIC  S99.
      *
       77  FD16-A          FLOAT-DECIMAL-16 VALUE 1.
       77  FD16-B          FLOAT-DECIMAL-16 VALUE 10.
       77  FD16-RES        FLOAT-DECIMAL-16.
      *
       77  FD34-A          FLOAT-DECIMAL-34 VALUE 1.
       77  FD34-B          FLOAT-DECIMAL-34 VALUE 10.
       77  FD34-RES        FLOAT-DECIMAL-34.
      *
       77  FL-A            FLOAT-LONG       VALUE 1.
       77  FL-B            FLOAT-LONG       VALUE 10.
       77  FL-RES          FLOAT-LONG.
      *
       77  FS-A            FLOAT-SHORT      VALUE 1.
       77  FS-B            FLOAT-SHORT      VALUE 10.
       77  FS-RES          FLOAT-SHORT.
      *
       01  FILLER       USAGE BINARY-INT VALUE 0.
           88 DO-DISP   VALUE 0.
           88 NO-DISP   VALUE 1.
       REPLACE ==DISPLAY== BY ==IF DO-DISP  DISPLAY==.
      *
       PROCEDURE DIVISION.
       MAIN.
      *    Test with DISPLAY on error
           PERFORM DO-CHECK.
       >> IF CHECK-PERF IS DEFINED
           SET  NO-DISP    TO TRUE
      *    some performance checks on the way...
           PERFORM DO-CHECK 20000 TIMES.
       >> END-IF
           GOBACK.

       DO-CHECK.
      *
           INITIALIZE
               BCL-A BCL-B
               BC-A BC-B
               BD-A BD-B
               BL-A BL-B
               C-A C-B
               C1-A C1-B
               C2-A C2-B
               C3-A C3-B
               C5-A C5-B
               C6-A C6-B
               CN9-A CN9-B
               CNX-A CNX-B
               CX9-A CX9-B
               CXX-A CXX-B
               D-A D-B
               FD16-A FD16-B
               FD34-A FD34-B
               FL-A FL-B
               FS-A FS-B
              ALL TO VALUE.
      *
           ADD  BCL-B  TO BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 11
              DISPLAY 'ERROR BINARY-C-LONG + BINARY-C-LONG'.
           MOVE 1     TO BCL-A.
           ADD  10    TO BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 11
              DISPLAY 'ERROR BINARY-C-LONG + NUM'.
           MOVE 11    TO BCL-A.
           SUBTRACT BCL-B FROM BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 1
              DISPLAY 'ERROR BINARY-C-LONG - BINARY-C-LONG'.
           MOVE 11    TO BCL-A.
           SUBTRACT 10   FROM BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 1
              DISPLAY 'ERROR BINARY-C-LONG - NUM'.
      *
           ADD  BC-B  TO BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 11
              DISPLAY 'ERROR BINARY-CHAR + BINARY-CHAR'.
           MOVE 1     TO BC-A.
           ADD  10    TO BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 11
              DISPLAY 'ERROR BINARY-CHAR + NUM'.
           MOVE 11    TO BC-A.
           SUBTRACT BC-B FROM BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 1
              DISPLAY 'ERROR BINARY-CHAR - BINARY-CHAR'.
           MOVE 11    TO BC-A.
           SUBTRACT 10   FROM BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 1
              DISPLAY 'ERROR BINARY-CHAR - NUM'.
      *
           ADD  BD-B  TO BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 11
              DISPLAY 'ERROR BINARY-DOUBLE + BINARY-DOUBLE'.
           MOVE 1     TO BD-A.
           ADD  10    TO BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 11
              DISPLAY 'ERROR BINARY-DOUBLE + NUM'.
           MOVE 11    TO BD-A.
           SUBTRACT BD-B FROM BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 1
              DISPLAY 'ERROR BINARY-DOUBLE - BINARY-DOUBLE'.
           MOVE 11    TO BD-A.
           SUBTRACT 10   FROM BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 1
              DISPLAY 'ERROR BINARY-DOUBLE - NUM'.
      *
           ADD  BL-B  TO BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 11
              DISPLAY 'ERROR BINARY-LONG + BINARY-LONG'.
           MOVE 1     TO BL-A.
           ADD  10    TO BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 11
              DISPLAY 'ERROR BINARY-LONG + NUM'.
           MOVE 11    TO BL-A.
           SUBTRACT BL-B FROM BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 1
              DISPLAY 'ERROR BINARY-LONG - BINARY-LONG'.
           MOVE 11    TO BL-A.
           SUBTRACT 10   FROM BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 1
              DISPLAY 'ERROR BINARY-LONG - NUM'.
      *
           ADD  C-B  TO C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 11
              DISPLAY 'ERROR COMP + COMP'.
           MOVE 1     TO C-A.
           ADD  10    TO C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 11
              DISPLAY 'ERROR COMP + NUM'.
           MOVE 11    TO C-A.
           SUBTRACT C-B FROM C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 1
              DISPLAY 'ERROR COMP - COMP'.
           MOVE 11    TO C-A.
           SUBTRACT 10   FROM C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 1
              DISPLAY 'ERROR COMP - NUM'.
      *
           ADD  C1-B  TO C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 11
              DISPLAY 'ERROR COMP-1 + COMP-1'.
           MOVE 1     TO C1-A.
           ADD  10    TO C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 11
              DISPLAY 'ERROR COMP-1 + NUM'.
           MOVE 11    TO C1-A.
           SUBTRACT C1-B FROM C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 1
              DISPLAY 'ERROR COMP-1 - COMP-1'.
           MOVE 11    TO C1-A.
           SUBTRACT 10   FROM C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 1
              DISPLAY 'ERROR COMP-1 - NUM'.
      *
           ADD  C2-B  TO C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 11
              DISPLAY 'ERROR COMP-2 + COMP-2'.
           MOVE 1     TO C2-A.
           ADD  10    TO C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 11
              DISPLAY 'ERROR COMP-2 + NUM'.
           MOVE 11    TO C2-A.
           SUBTRACT C2-B FROM C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 1
              DISPLAY 'ERROR COMP-2 - COMP-2'.
           MOVE 11    TO C2-A.
           SUBTRACT 10   FROM C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 1
              DISPLAY 'ERROR COMP-2 - NUM'.
      *
           ADD  C3-B  TO C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 11
              DISPLAY 'ERROR COMP-3 + COMP-3'.
           MOVE 1     TO C3-A.
           ADD  10    TO C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 11
              DISPLAY 'ERROR COMP-3 + NUM'.
           MOVE 11    TO C3-A.
           SUBTRACT C3-B FROM C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 1
              DISPLAY 'ERROR COMP-3 - COMP-3'.
           MOVE 11    TO C3-A.
           SUBTRACT 10   FROM C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 1
              DISPLAY 'ERROR COMP-3 - NUM'.
      *
           ADD  C5-B  TO C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 11
              DISPLAY 'ERROR COMP-5 + COMP-5'.
           MOVE 1     TO C5-A.
           ADD  10    TO C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 11
              DISPLAY 'ERROR COMP-5 + NUM'.
           MOVE 11    TO C5-A.
           SUBTRACT C5-B FROM C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 1
              DISPLAY 'ERROR COMP-5 - COMP-5'.
           MOVE 11    TO C5-A.
           SUBTRACT 10   FROM C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 1
              DISPLAY 'ERROR COMP-5 - NUM'.
      *
           ADD  C6-B  TO C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 11
              DISPLAY 'ERROR COMP-6 + COMP-6'.
           MOVE 1     TO C6-A.
           ADD  10    TO C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 11
              DISPLAY 'ERROR COMP-6 + NUM'.
           MOVE 11    TO C6-A.
           SUBTRACT C6-B FROM C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 1
              DISPLAY 'ERROR COMP-6 - COMP-6'.
           MOVE 11    TO C6-A.
           SUBTRACT 10   FROM C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 1
              DISPLAY 'ERROR COMP-6 - NUM'.
      *
           ADD  CN9-B  TO CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 11
              DISPLAY 'ERROR COMP-N + COMP-N'.
           MOVE 1     TO CN9-A.
           ADD  10    TO CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 11
              DISPLAY 'ERROR COMP-N + NUM'.
           MOVE 11    TO CN9-A.
           SUBTRACT CN9-B FROM CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 1
              DISPLAY 'ERROR COMP-N - COMP-N'.
           MOVE 11    TO CN9-A.
           SUBTRACT 10   FROM CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 1
              DISPLAY 'ERROR COMP-N - NUM'.
      *
           ADD  CNX-B  TO CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 11
              DISPLAY 'ERROR COMP-N + COMP-N'.
           MOVE 1     TO CNX-A.
           ADD  10    TO CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 11
              DISPLAY 'ERROR COMP-N + NUM'.
           MOVE 11    TO CNX-A.
           SUBTRACT CNX-B FROM CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 1
              DISPLAY 'ERROR COMP-N - COMP-N'.
           MOVE 11    TO CNX-A.
           SUBTRACT 10   FROM CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 1
              DISPLAY 'ERROR COMP-N - NUM'.
      *
           ADD  CX9-B  TO CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 11
              DISPLAY 'ERROR COMP-X + COMP-X'.
           MOVE 1     TO CX9-A.
           ADD  10    TO CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 11
              DISPLAY 'ERROR COMP-X + NUM'.
           MOVE 11    TO CX9-A.
           SUBTRACT CX9-B FROM CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 1
              DISPLAY 'ERROR COMP-X - COMP-X'.
           MOVE 11    TO CX9-A.
           SUBTRACT 10   FROM CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 1
              DISPLAY 'ERROR COMP-X - NUM'.
      *
           ADD  CXX-B  TO CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 11
              DISPLAY 'ERROR COMP-X + COMP-X'.
           MOVE 1     TO CXX-A.
           ADD  10    TO CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 11
              DISPLAY 'ERROR COMP-X + NUM'.
           MOVE 11    TO CXX-A.
           SUBTRACT CXX-B FROM CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 1
              DISPLAY 'ERROR COMP-X - COMP-X'.
           MOVE 11    TO CXX-A.
           SUBTRACT 10   FROM CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 1
              DISPLAY 'ERROR COMP-X - NUM'.
      *
           ADD  D-B  TO D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 11
              DISPLAY 'ERROR DISPLAY + DISPLAY'.
           MOVE 1     TO D-A.
           ADD  10    TO D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 11
              DISPLAY 'ERROR DISPLAY + NUM'.
           MOVE 11    TO D-A.
           SUBTRACT D-B FROM D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 1
              DISPLAY 'ERROR DISPLAY - DISPLAY'.
           MOVE 11    TO D-A.
           SUBTRACT 10   FROM D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 1
              DISPLAY 'ERROR DISPLAY - NUM'.
      *
           ADD  FD16-B  TO FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 11
              DISPLAY 'ERROR FLOAT-DECIMAL-16 + FLOAT-DECIMAL-16'.
           MOVE 1     TO FD16-A.
           ADD  10    TO FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 11
              DISPLAY 'ERROR FLOAT-DECIMAL-16 + NUM'.
           MOVE 11    TO FD16-A.
           SUBTRACT FD16-B FROM FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 1
              DISPLAY 'ERROR FLOAT-DECIMAL-16 - FLOAT-DECIMAL-16'.
           MOVE 11    TO FD16-A.
           SUBTRACT 10   FROM FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 1
              DISPLAY 'ERROR FLOAT-DECIMAL-16 - NUM'.
      *
           ADD  FD34-B  TO FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 11
              DISPLAY 'ERROR FLOAT-DECIMAL-34 + FLOAT-DECIMAL-34'.
           MOVE 1     TO FD34-A.
           ADD  10    TO FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 11
              DISPLAY 'ERROR FLOAT-DECIMAL-34 + NUM'.
           MOVE 11    TO FD34-A.
           SUBTRACT FD34-B FROM FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 1
              DISPLAY 'ERROR FLOAT-DECIMAL-34 - FLOAT-DECIMAL-34'.
           MOVE 11    TO FD34-A.
           SUBTRACT 10   FROM FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 1
              DISPLAY 'ERROR FLOAT-DECIMAL-34 - NUM'.
      *
           ADD  FL-B  TO FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 11
              DISPLAY 'ERROR FLOAT-LONG + FLOAT-LONG'.
           MOVE 1     TO FL-A.
           ADD  10    TO FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 11
              DISPLAY 'ERROR FLOAT-LONG + NUM'.
           MOVE 11    TO FL-A.
           SUBTRACT FL-B FROM FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 1
              DISPLAY 'ERROR FLOAT-LONG - FLOAT-LONG'.
           MOVE 11    TO FL-A.
           SUBTRACT 10   FROM FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 1
              DISPLAY 'ERROR FLOAT-LONG - NUM'.
      *
           ADD  FS-B  TO FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 11
              DISPLAY 'ERROR FLOAT-SHORT + FLOAT-SHORT'.
           MOVE 1     TO FS-A.
           ADD  10    TO FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 11
              DISPLAY 'ERROR FLOAT-SHORT + NUM'.
           MOVE 11    TO FS-A.
           SUBTRACT FS-B FROM FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 1
              DISPLAY 'ERROR FLOAT-SHORT - FLOAT-SHORT'.
           MOVE 11    TO FS-A.
           SUBTRACT 10   FROM FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 1
              DISPLAY 'ERROR FLOAT-SHORT - NUM'.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fno-fast-compare prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

#AT_CHECK([$COMPILE -fno-fast-math prog.cob], [0], [], [])
#AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fnotrunc prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([Computing of different USAGEs w/- decimal point])
AT_KEYWORDS([runmisc
BINARY-C-LONG BINARY-CHAR BINARY-DOUBLE BINARY-LONG
COMP COMP-1 COMP-2 COMP-3 PACKED-DECIMAL COMP-5 COMP-6 COMP-N COMP-X
FLOAT-DECIMAL-16 FLOAT-DECIMAL-34 FLOAT-LONG FLOAT-SHORT])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. 'prog'.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
      *
       77  BCL-A           BINARY-C-LONG    VALUE 1.0.
       77  BCL-B           BINARY-C-LONG    VALUE 10.0.
       77  BCL-RES         BINARY-C-LONG.
      *
       77  BC-A            BINARY-CHAR      VALUE 1.0.
       77  BC-B            BINARY-CHAR      VALUE 10.0.
       77  BC-RES          BINARY-CHAR.
      *
       77  BD-A            BINARY-DOUBLE    VALUE 1.0.
       77  BD-B            BINARY-DOUBLE    VALUE 10.0.
       77  BD-RES          BINARY-DOUBLE.
      *
       77  BL-A            BINARY-LONG      VALUE 1.0.
       77  BL-B            BINARY-LONG      VALUE 10.0.
       77  BL-RES          BINARY-LONG.
      *
       77  C-A     PIC S99 COMP             VALUE 1.0.
       77  C-B     PIC S99 COMP             VALUE 10.0.
       77  C-RES   PIC S99 COMP.
      *
       77  C1-A            COMP-1           VALUE 1.0.
       77  C1-B            COMP-1           VALUE 10.0.
       77  C1-RES          COMP-1.
      *
       77  C2-A            COMP-2           VALUE 1.0.
       77  C2-B            COMP-2           VALUE 10.0.
       77  C2-RES          COMP-2.
      *
       77  C3-A    PIC S99 COMP-3           VALUE 1.0.
       77  C3-B    PIC S99 COMP-3           VALUE 10.0.
       77  C3-RES  PIC S99 COMP-3.
      *
       77  C5-A    PIC S99 COMP-5           VALUE 1.0.
       77  C5-B    PIC S99 COMP-5           VALUE 10.0.
       77  C5-RES  PIC S99 COMP-5.
      *
       77  C6-A    PIC  99 COMP-6           VALUE 1.0.
       77  C6-B    PIC  99 COMP-6           VALUE 10.0.
       77  C6-RES  PIC  99 COMP-6.
      *
       77  CN9-A   PIC  99 COMP-N           VALUE 1.
       77  CN9-B   PIC  99 COMP-N           VALUE 10.
       77  CN9-RES PIC  99 COMP-N.
      *
       77  CNX-A   PIC  X  COMP-N           VALUE 1.
       77  CNX-B   PIC  X  COMP-N           VALUE 10.
       77  CNX-RES PIC  X  COMP-N.
      *
       77  CX9-A   PIC  99 COMP-X           VALUE 1.
       77  CX9-B   PIC  99 COMP-X           VALUE 10.
       77  CX9-RES PIC  99 COMP-X.
      *
       77  CXX-A   PIC  X  COMP-X           VALUE 1.
       77  CXX-B   PIC  X  COMP-X           VALUE 10.
       77  CXX-RES PIC  X  COMP-X.
      *
       77  D-A     PIC  S99                 VALUE 1.0.
       77  D-B     PIC  S99                 VALUE 10.0.
       77  D-RES   PIC  S99.
      *
       77  FD16-A          FLOAT-DECIMAL-16 VALUE 1.0.
       77  FD16-B          FLOAT-DECIMAL-16 VALUE 10.0.
       77  FD16-RES        FLOAT-DECIMAL-16.
      *
       77  FD34-A          FLOAT-DECIMAL-34 VALUE 1.0.
       77  FD34-B          FLOAT-DECIMAL-34 VALUE 10.0.
       77  FD34-RES        FLOAT-DECIMAL-34.
      *
       77  FL-A            FLOAT-LONG       VALUE 1.0.
       77  FL-B            FLOAT-LONG       VALUE 10.0.
       77  FL-RES          FLOAT-LONG.
      *
       77  FS-A            FLOAT-SHORT      VALUE 1.0.
       77  FS-B            FLOAT-SHORT      VALUE 10.0.
       77  FS-RES          FLOAT-SHORT.
      *
       PROCEDURE DIVISION.
      *
           ADD  BCL-B  TO BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-C-LONG + BINARY-C-LONG'.
           MOVE 1.0   TO BCL-A.
           ADD  10.0  TO BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-C-LONG + NUM'.
           MOVE 11.0  TO BCL-A.
           SUBTRACT BCL-B FROM BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-C-LONG - BINARY-C-LONG'.
           MOVE 11.0  TO BCL-A.
           SUBTRACT 10.0 FROM BCL-A.
           MOVE BCL-A  TO BCL-RES.
           IF BCL-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-C-LONG - NUM'.
      *
           ADD  BC-B  TO BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-CHAR + BINARY-CHAR'.
           MOVE 1.0   TO BC-A.
           ADD  10.0  TO BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-CHAR + NUM'.
           MOVE 11.0  TO BC-A.
           SUBTRACT BC-B FROM BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-CHAR - BINARY-CHAR'.
           MOVE 11.0  TO BC-A.
           SUBTRACT 10.0 FROM BC-A.
           MOVE BC-A  TO BC-RES.
           IF BC-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-CHAR - NUM'.
      *
           ADD  BD-B  TO BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-DOUBLE + BINARY-DOUBLE'.
           MOVE 1.0   TO BD-A.
           ADD  10.0  TO BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-DOUBLE + NUM'.
           MOVE 11.0  TO BD-A.
           SUBTRACT BD-B FROM BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-DOUBLE - BINARY-DOUBLE'.
           MOVE 11.0  TO BD-A.
           SUBTRACT 10.0 FROM BD-A.
           MOVE BD-A  TO BD-RES.
           IF BD-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-DOUBLE - NUM'.
      *
           ADD  BL-B  TO BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-LONG + BINARY-LONG'.
           MOVE 1.0   TO BL-A.
           ADD  10.0  TO BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 11.0
              DISPLAY 'ERROR BINARY-LONG + NUM'.
           MOVE 11.0  TO BL-A.
           SUBTRACT BL-B FROM BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-LONG - BINARY-LONG'.
           MOVE 11.0  TO BL-A.
           SUBTRACT 10.0 FROM BL-A.
           MOVE BL-A  TO BL-RES.
           IF BL-RES NOT = 1.0
              DISPLAY 'ERROR BINARY-LONG - NUM'.
      *
           ADD  C-B  TO C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 11.0
              DISPLAY 'ERROR COMP + COMP'.
           MOVE 1.0   TO C-A.
           ADD  10.0  TO C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 11.0
              DISPLAY 'ERROR COMP + NUM'.
           MOVE 11.0  TO C-A.
           SUBTRACT C-B FROM C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 1.0
              DISPLAY 'ERROR COMP - COMP'.
           MOVE 11.0  TO C-A.
           SUBTRACT 10.0 FROM C-A.
           MOVE C-A  TO C-RES.
           IF C-RES NOT = 1.0
              DISPLAY 'ERROR COMP - NUM'.
      *
           ADD  C1-B  TO C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 11.0
              DISPLAY 'ERROR COMP-1 + COMP-1'.
           MOVE 1.0   TO C1-A.
           ADD  10.0  TO C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 11.0
              DISPLAY 'ERROR COMP-1 + NUM'.
           MOVE 11.0  TO C1-A.
           SUBTRACT C1-B FROM C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 1.0
              DISPLAY 'ERROR COMP-1 - COMP-1'.
           MOVE 11.0  TO C1-A.
           SUBTRACT 10.0 FROM C1-A.
           MOVE C1-A  TO C1-RES.
           IF C1-RES NOT = 1.0
              DISPLAY 'ERROR COMP-1 - NUM'.
      *
           ADD  C2-B  TO C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 11.0
              DISPLAY 'ERROR COMP-2 + COMP-2'.
           MOVE 1.0   TO C2-A.
           ADD  10.0  TO C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 11.0
              DISPLAY 'ERROR COMP-2 + NUM'.
           MOVE 11.0  TO C2-A.
           SUBTRACT C2-B FROM C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 1.0
              DISPLAY 'ERROR COMP-2 - COMP-2'.
           MOVE 11.0  TO C2-A.
           SUBTRACT 10.0 FROM C2-A.
           MOVE C2-A  TO C2-RES.
           IF C2-RES NOT = 1.0
              DISPLAY 'ERROR COMP-2 - NUM'.
      *
           ADD  C3-B  TO C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 11.0
              DISPLAY 'ERROR COMP-3 + COMP-3'.
           MOVE 1.0   TO C3-A.
           ADD  10.0  TO C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 11.0
              DISPLAY 'ERROR COMP-3 + NUM'.
           MOVE 11.0  TO C3-A.
           SUBTRACT C3-B FROM C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 1.0
              DISPLAY 'ERROR COMP-3 - COMP-3'.
           MOVE 11.0  TO C3-A.
           SUBTRACT 10.0 FROM C3-A.
           MOVE C3-A  TO C3-RES.
           IF C3-RES NOT = 1.0
              DISPLAY 'ERROR COMP-3 - NUM'.
      *
           ADD  C5-B  TO C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 11.0
              DISPLAY 'ERROR COMP-5 + COMP-5'.
           MOVE 1.0   TO C5-A.
           ADD  10.0  TO C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 11.0
              DISPLAY 'ERROR COMP-5 + NUM'.
           MOVE 11.0  TO C5-A.
           SUBTRACT C5-B FROM C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 1.0
              DISPLAY 'ERROR COMP-5 - COMP-5'.
           MOVE 11.0  TO C5-A.
           SUBTRACT 10.0 FROM C5-A.
           MOVE C5-A  TO C5-RES.
           IF C5-RES NOT = 1.0
              DISPLAY 'ERROR COMP-5 - NUM'.
      *
           ADD  C6-B  TO C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 11.0
              DISPLAY 'ERROR COMP-6 + COMP-6'.
           MOVE 1.0   TO C6-A.
           ADD  10.0  TO C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 11.0
              DISPLAY 'ERROR COMP-6 + NUM'.
           MOVE 11.0  TO C6-A.
           SUBTRACT C6-B FROM C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 1.0
              DISPLAY 'ERROR COMP-6 - COMP-6'.
           MOVE 11.0  TO C6-A.
           SUBTRACT 10.0 FROM C6-A.
           MOVE C6-A  TO C6-RES.
           IF C6-RES NOT = 1.0
              DISPLAY 'ERROR COMP-6 - NUM'.
      *
           ADD  CN9-B  TO CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 11.0
              DISPLAY 'ERROR COMP-N + COMP-N'.
           MOVE 1.0    TO CN9-A.
           ADD  10.0   TO CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 11.0
              DISPLAY 'ERROR COMP-N + NUM'.
           MOVE 11.0   TO CN9-A.
           SUBTRACT CN9-B FROM CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 1.0
              DISPLAY 'ERROR COMP-N - COMP-N'.
           MOVE 11.0   TO CN9-A.
           SUBTRACT 10.0  FROM CN9-A.
           MOVE CN9-A  TO CN9-RES.
           IF CN9-RES NOT = 1.0
              DISPLAY 'ERROR COMP-N - NUM'.
      *
           ADD  CNX-B  TO CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 11.0
              DISPLAY 'ERROR COMP-N + COMP-N'.
           MOVE 1.0    TO CNX-A.
           ADD  10.0   TO CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 11.0
              DISPLAY 'ERROR COMP-N + NUM'.
           MOVE 11.0   TO CNX-A.
           SUBTRACT CNX-B FROM CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 1.0
              DISPLAY 'ERROR COMP-N - COMP-N'.
           MOVE 11.0   TO CNX-A.
           SUBTRACT 10.0 FROM CNX-A.
           MOVE CNX-A  TO CNX-RES.
           IF CNX-RES NOT = 1.0
              DISPLAY 'ERROR COMP-N - NUM'.
      *
           ADD  CX9-B  TO CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 11.0
              DISPLAY 'ERROR COMP-X + COMP-X'.
           MOVE 1.0    TO CX9-A.
           ADD  10.0   TO CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 11.0
              DISPLAY 'ERROR COMP-X + NUM'.
           MOVE 11.0   TO CX9-A.
           SUBTRACT CX9-B FROM CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 1.0
              DISPLAY 'ERROR COMP-X - COMP-X'.
           MOVE 11.0   TO CX9-A.
           SUBTRACT 10.0 FROM CX9-A.
           MOVE CX9-A  TO CX9-RES.
           IF CX9-RES NOT = 1.0
              DISPLAY 'ERROR COMP-X - NUM'.
      *
           ADD  CXX-B  TO CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 11.0
              DISPLAY 'ERROR COMP-X + COMP-X'.
           MOVE 1.0    TO CXX-A.
           ADD  10.0   TO CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 11.0
              DISPLAY 'ERROR COMP-X + NUM'.
           MOVE 11.0    TO CXX-A.
           SUBTRACT CXX-B FROM CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 1.0
              DISPLAY 'ERROR COMP-X - COMP-X'.
           MOVE 11.0   TO CXX-A.
           SUBTRACT 10.0 FROM CXX-A.
           MOVE CXX-A  TO CXX-RES.
           IF CXX-RES NOT = 1.0
              DISPLAY 'ERROR COMP-X - NUM'.
      *
           ADD  D-B  TO D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 11.0
              DISPLAY 'ERROR DISPLAY + DISPLAY'.
           MOVE 1.0  TO D-A.
           ADD  10.0 TO D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 11.0
              DISPLAY 'ERROR DISPLAY + NUM'.
           MOVE 11.0 TO D-A.
           SUBTRACT D-B FROM D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 1.0
              DISPLAY 'ERROR DISPLAY - DISPLAY'.
           MOVE 11.0 TO D-A.
           SUBTRACT 10.0 FROM D-A.
           MOVE D-A  TO D-RES.
           IF D-RES NOT = 1.0
              DISPLAY 'ERROR DISPLAY - NUM'.
      *
           ADD  FD16-B  TO FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-DECIMAL-16 + FLOAT-DECIMAL-16'.
           MOVE 1.0   TO FD16-A.
           ADD  10.0  TO FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-DECIMAL-16 + NUM'.
           MOVE 11.0  TO FD16-A.
           SUBTRACT FD16-B FROM FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-DECIMAL-16 - FLOAT-DECIMAL-16'.
           MOVE 11.0  TO FD16-A.
           SUBTRACT 10.0 FROM FD16-A.
           MOVE FD16-A  TO FD16-RES.
           IF FD16-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-DECIMAL-16 - NUM'.
      *
           ADD  FD34-B  TO FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-DECIMAL-34 + FLOAT-DECIMAL-34'.
           MOVE 1.0   TO FD34-A.
           ADD  10.0  TO FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-DECIMAL-34 + NUM'.
           MOVE 11.0  TO FD34-A.
           SUBTRACT FD34-B FROM FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-DECIMAL-34 - FLOAT-DECIMAL-34'.
           MOVE 11.0  TO FD34-A.
           SUBTRACT 10.0 FROM FD34-A.
           MOVE FD34-A  TO FD34-RES.
           IF FD34-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-DECIMAL-34 - NUM'.
      *
           ADD  FL-B  TO FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-LONG + FLOAT-LONG'.
           MOVE 1.0   TO FL-A.
           ADD  10.0  TO FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-LONG + NUM'.
           MOVE 11.0  TO FL-A.
           SUBTRACT FL-B FROM FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-LONG - FLOAT-LONG'.
           MOVE 11.0  TO FL-A.
           SUBTRACT 10.0 FROM FL-A.
           MOVE FL-A  TO FL-RES.
           IF FL-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-LONG - NUM'.
      *
           ADD  FS-B  TO FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-SHORT + FLOAT-SHORT'.
           MOVE 1.0   TO FS-A.
           ADD  10.0  TO FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 11.0
              DISPLAY 'ERROR FLOAT-SHORT + NUM'.
           MOVE 11.0  TO FS-A.
           SUBTRACT FS-B FROM FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-SHORT - FLOAT-SHORT'.
           MOVE 11.0  TO FS-A.
           SUBTRACT 10.0 FROM FS-A.
           MOVE FS-A  TO FS-RES.
           IF FS-RES NOT = 1.0
              DISPLAY 'ERROR FLOAT-SHORT - NUM'.
      *
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fno-fast-compare prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

#AT_CHECK([$COMPILE -fno-fast-math prog.cob], [0], [], [])
#AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fnotrunc prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([compilation-group with decimal])
AT_KEYWORDS([runmisc function numval])

# bug 708 - decimal codegen in generated header when only
# a later program (nested/contained) has decimals

AT_DATA([prog.cob], [
       identification division.
         program-id. cbug.
       procedure division.
         mainline.
           call 'bug'
           goback
           .
       end program cbug.
      *
       identification division.
         program-id. bug.
       data division.
         working-storage section.
           01  pw   pic 9(02).
           01  px   pic x value '3'.
       procedure division.
         mainline.
           compute pw = function numval(px).
           if pw <> 3
              display 'bad calc: ' pw.
           goback
           .
       end program bug.
])

# we're mostly interested in the codegen, but as we have compiled
# that we can execute it, too
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([C/C++ reserved words/predefined identifiers])
AT_KEYWORDS([runmisc])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
      *
      * Reserved Words in C (that aren't reserved in COBOL)
      * var names MUST BE IN LOWER CASE (!)
      *
       77  const                       PIC X VALUE "A".
       77  double                      PIC X VALUE "B".
       77  float                       PIC X VALUE "C".
       77  int                         PIC X VALUE "D".
       77  short                       PIC X VALUE "E".
       77  struct                      PIC X VALUE "F".
       77  break                       PIC X VALUE "G".
       77  long                        PIC X VALUE "H".
       77  switch                      PIC X VALUE "I".
       77  void                        PIC X VALUE "J".
       77  case                        PIC X VALUE "K".
       77  enum                        PIC X VALUE "L".
       77  goto                        PIC X VALUE "M".
       77  register                    PIC X VALUE "N".
       77  sizeof                      PIC X VALUE "O".
       77  volatile                    PIC X VALUE "P".
       77  char                        PIC X VALUE "Q".
       77  do                          PIC X VALUE "R".
       77  extern                      PIC X VALUE "S".
       77  static                      PIC X VALUE "T".
       77  union                       PIC X VALUE "U".
       77  while                       PIC X VALUE "V".
      *
      * More Reserved Words in C++
      * var names MUST BE IN LOWER CASE (!)
      *
       77  asm                         PIC X VALUE "W".
       77  dynamic_cast                PIC X VALUE "X".
       77  namespace                   PIC X VALUE "Y".
       77  reinterpret_cast            PIC X VALUE "Z".
       77  try                         PIC X VALUE "a".
       77  bool                        PIC X VALUE "b".
       77  explicit                    PIC X VALUE "c".
      *77  new                         PIC X VALUE "d".
       77  static_cast                 PIC X VALUE "e".
       77  typeid                      PIC X VALUE "f".
       77  catch                       PIC X VALUE "g".
       77  operator                    PIC X VALUE "h".
       77  template                    PIC X VALUE "i".
       77  typename                    PIC X VALUE "j".
       77  friend                      PIC X VALUE "k".
       77  private                     PIC X VALUE "l".
       77  this                        PIC X VALUE "m".
       77  const_cast                  PIC X VALUE "n".
       77  inline                      PIC X VALUE "o".
       77  public                      PIC X VALUE "p".
       77  throw                       PIC X VALUE "q".
       77  virtual                     PIC X VALUE "r".
       77  mutable                     PIC X VALUE "s".
       77  protected                   PIC X VALUE "t".
       77  wchar_t                     PIC X VALUE "u".
      *
      * More Reserved Words in C++ (not essential)
      * var names MUST BE IN LOWER CASE (!)
      *
       77  bitand                      PIC X VALUE "v".
       77  compl                       PIC X VALUE "w".
       77  not_eq                      PIC X VALUE "x".
       77  or_eq                       PIC X VALUE "y".
       77  xor_eq                      PIC X VALUE "z".
       77  and_eq                      PIC X VALUE "0".
       77  bitor                       PIC X VALUE "1".
       77  xor                         PIC X VALUE "2".
      *
       PROCEDURE        DIVISION.
           CALL "callee" USING   const
                                 double
                                 float
                                 int
                                 short
                                 struct
                                 break
                                 long
                                 switch
                                 void
                                 case
                                 enum
                                 goto
                                 register
                                 sizeof
                                 volatile
                                 char
                                 do
                                 *>extern
                                 *>static
                                 union
                                 while
           END-CALL.
           CALL "callee2" USING  asm
                                 dynamic_cast
                                 namespace
                                 reinterpret_cast
                                 try
                                 bool
                                 explicit
      *                          new
                                 static_cast
                                 typeid
                                 catch
                                 operator
                                 template
                                 typename
                                 friend
                                 private
                                 this
                                 const_cast
                                 inline
                                 public
                                 throw
                                 virtual
                                 mutable
                                 protected
                                 wchar_t
                                 bitand
                                 compl
                                 not_eq
                                 or_eq
                                 xor_eq
                                 and_eq
                                 bitor
                                 xor
           END-CALL.
           MOVE x'00' TO         const
                                 double
                                 float
                                 int
                                 short
                                 struct
                                 break
                                 long
                                 switch
                                 void
                                 case
                                 enum
                                 goto
                                 register
                                 sizeof
                                 volatile
                                 char
                                 do
                                 extern
                                 static
                                 union
                                 while
                                 asm
                                 dynamic_cast
                                 namespace
                                 reinterpret_cast
                                 try
                                 bool
                                 explicit
      *                          new
                                 static_cast
                                 typeid
                                 catch
                                 operator
                                 template
                                 typename
                                 friend
                                 private
                                 this
                                 const_cast
                                 inline
                                 public
                                 throw
                                 virtual
                                 mutable
                                 protected
                                 wchar_t
                                 bitand
                                 compl
                                 not_eq
                                 or_eq
                                 xor_eq
                                 and_eq
                                 bitor
                                 xor
                                 .
           STOP RUN.
])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       LINKAGE SECTION.
      *
      * Reserved Words in C (that aren't reserved in COBOL)
      * var names MUST BE IN LOWER CASE (!)
      *
       77  const                       PIC X.
       77  double                      PIC X.
       77  float                       PIC X.
       77  int                         PIC X.
       77  short                       PIC X.
       77  struct                      PIC X.
       77  break                       PIC X.
       77  long                        PIC X.
       77  switch                      PIC X.
       77  void                        PIC X.
       77  case                        PIC X.
       77  enum                        PIC X.
       77  goto                        PIC X.
       77  register                    PIC X.
       77  sizeof                      PIC X.
       77  volatile                    PIC X.
       77  char                        PIC X.
       77  do                          PIC X.
      *77  extern                      PIC X.
      *77  static                      PIC X.
       77  union                       PIC X.
       77  while                       PIC X.
       PROCEDURE        DIVISION USING
                                 const
                                 double
                                 float
                                 int
                                 short
                                 struct
                                 break
                                 long
                                 switch
                                 void
                                 case
                                 enum
                                 goto
                                 register
                                 sizeof
                                 volatile
                                 char
                                 do
                                *>extern
                                *>static
                                 union
                                 while
                                 .
           IF (const                       NOT = "A") OR
              (double                      NOT = "B") OR
              (float                       NOT = "C") OR
              (int                         NOT = "D") OR
              (short                       NOT = "E") OR
              (struct                      NOT = "F") OR
              (break                       NOT = "G") OR
              (long                        NOT = "H") OR
              (switch                      NOT = "I") OR
              (void                        NOT = "J") OR
              (case                        NOT = "K") OR
              (enum                        NOT = "L") OR
              (goto                        NOT = "M") OR
              (register                    NOT = "N") OR
              (sizeof                      NOT = "O") OR
              (volatile                    NOT = "P") OR
              (char                        NOT = "Q") OR
              (do                          NOT = "R") OR
            *>(extern                      NOT = "S") OR
            *>(static                      NOT = "T") OR
              (union                       NOT = "U") OR
              (while                       NOT = "V")
              DISPLAY "At least one var has wrong content!".
           MOVE x'FF' TO         const
                                 double
                                 float
                                 int
                                 short
                                 struct
                                 break
                                 long
                                 switch
                                 void
                                 case
                                 enum
                                 goto
                                 register
                                 sizeof
                                 volatile
                                 char
                                 do
                               *>extern
                               *>static
                                 union
                                 while
                                 .
           EXIT PROGRAM.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       DATA             DIVISION.
       LINKAGE SECTION.
      *
      * More Reserved Words in C++
      * var names MUST BE IN LOWER CASE (!)
      *
       77  asm                         PIC X.
       77  dynamic_cast                PIC X.
       77  namespace                   PIC X.
       77  reinterpret_cast            PIC X.
       77  try                         PIC X.
       77  bool                        PIC X.
       77  explicit                    PIC X.
      *77  new                         PIC X.
       77  static_cast                 PIC X.
       77  typeid                      PIC X.
       77  catch                       PIC X.
       77  operator                    PIC X.
       77  template                    PIC X.
       77  typename                    PIC X.
       77  friend                      PIC X.
       77  private                     PIC X.
       77  this                        PIC X.
       77  const_cast                  PIC X.
       77  inline                      PIC X.
       77  public                      PIC X.
       77  throw                       PIC X.
       77  virtual                     PIC X.
       77  mutable                     PIC X.
       77  protected                   PIC X.
       77  wchar_t                     PIC X.
      *
      * More Reserved Words in C++ (not essential)
      *
       77  bitand                      PIC X.
       77  compl                       PIC X.
       77  not_eq                      PIC X.
       77  or_eq                       PIC X.
       77  xor_eq                      PIC X.
       77  and_eq                      PIC X.
       77  bitor                       PIC X.
       77  xor                         PIC X.
       PROCEDURE        DIVISION USING
                                 asm
                                 dynamic_cast
                                 namespace
                                 reinterpret_cast
                                 try
                                 bool
                                 explicit
      *                          new
                                 static_cast
                                 typeid
                                 catch
                                 operator
                                 template
                                 typename
                                 friend
                                 private
                                 this
                                 const_cast
                                 inline
                                 public
                                 throw
                                 virtual
                                 mutable
                                 protected
                                 wchar_t
                                 bitand
                                 compl
                                 not_eq
                                 or_eq
                                 xor_eq
                                 and_eq
                                 bitor
                                 xor
                                 .
           IF (asm                         NOT = "W") OR
              (dynamic_cast                NOT = "X") OR
              (namespace                   NOT = "Y") OR
              (reinterpret_cast            NOT = "Z") OR
              (try                         NOT = "a") OR
              (bool                        NOT = "b") OR
              (explicit                    NOT = "c") OR
      *       (new                         NOT = "d") OR
              (static_cast                 NOT = "e") OR
              (typeid                      NOT = "f") OR
              (catch                       NOT = "g") OR
              (operator                    NOT = "h") OR
              (template                    NOT = "i") OR
              (typename                    NOT = "j") OR
              (friend                      NOT = "k") OR
              (private                     NOT = "l") OR
              (this                        NOT = "m") OR
              (const_cast                  NOT = "n") OR
              (inline                      NOT = "o") OR
              (public                      NOT = "p") OR
              (throw                       NOT = "q") OR
              (virtual                     NOT = "r") OR
              (mutable                     NOT = "s") OR
              (protected                   NOT = "t") OR
              (wchar_t                     NOT = "u") OR
              (bitand                      NOT = "v") OR
              (compl                       NOT = "w") OR
              (not_eq                      NOT = "x") OR
              (or_eq                       NOT = "y") OR
              (xor_eq                      NOT = "z") OR
              (and_eq                      NOT = "0") OR
              (bitor                       NOT = "1") OR
              (xor                         NOT = "2")
              DISPLAY "At least one var has wrong content!".
           MOVE x'FF' TO         asm
                                 dynamic_cast
                                 namespace
                                 reinterpret_cast
                                 try
                                 bool
                                 explicit
      *                          new
                                 static_cast
                                 typeid
                                 catch
                                 operator
                                 template
                                 typename
                                 friend
                                 private
                                 this
                                 const_cast
                                 inline
                                 public
                                 throw
                                 virtual
                                 mutable
                                 protected
                                 wchar_t
                                 bitand
                                 compl
                                 not_eq
                                 or_eq
                                 xor_eq
                                 and_eq
                                 bitor
                                 xor
                                 .
           EXIT PROGRAM.
])

AT_CHECK([$COMPILE_MODULE -fnot-reserved=double,float,new,volatile,xor callee.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE -fnot-reserved=double,float,new,volatile,xor callee2.cob], [0], [], [])
AT_CHECK([$COMPILE -fnot-reserved=double,float,new,volatile,xor -o prog caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([PICTURE with Edit mask])
AT_KEYWORDS([numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TST.
           05 DEPT-SUB        PIC 9(7)V999 VALUE 18536.232.
           05 DEPT-COST-YTD   PIC 9(5)V999 VALUE 18536.232.
           05 DL-PROD-COST    PIC $$$,$$9.99.
       77  WFLT  PIC $$$,$$9.99.

       PROCEDURE DIVISION.
           MOVE 18536.23 TO WFLT.
           DISPLAY "WFLT IS " WFLT.
           MULTIPLY DEPT-COST-YTD BY 1 GIVING DL-PROD-COST ROUNDED.
           DISPLAY "COST IS " DL-PROD-COST.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[WFLT IS $18,536.23
COST IS $18,536.23
], [])

AT_CLEANUP


# Simon added the test with r4592 as "COMP-3 Index", but
# the revision and the ones before had no relation to this at all
# and as the tests seem to be done in other places... disabled
# the test
#AT_SETUP([PACKED-DECIMAL in PERFORM VARYING])
#AT_KEYWORDS([numeric COMP-3])
#
#AT_DATA([prog.cob], [
#       IDENTIFICATION DIVISION.
#       PROGRAM-ID. prog.
#       DATA DIVISION.
#       WORKING-STORAGE SECTION.
#       01 WS-PAGE-NUMBER PIC 9(4) COMP-3 VALUE ZERO.
#       01 WS-LINE-NUMBER PIC 9(3) VALUE ZERO.
#       PROCEDURE DIVISION.
#       PERFORM VARYING WS-LINE-NUMBER FROM 1 BY 1
#                 UNTIL WS-LINE-NUMBER > 10
#         ADD 1 TO WS-PAGE-NUMBER
#         DISPLAY WS-PAGE-NUMBER
#       END-PERFORM.
#       STOP RUN RETURNING 0.
#])
#
#AT_CHECK([$COMPILE prog.cob], [0], [], [])
#
#AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
#[0001
#0002
#0003
#0004
#0005
#0006
#0007
#0008
#0009
#0010
#], [])
#
#AT_CLEANUP


AT_SETUP([POINTER])
AT_KEYWORDS([numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 XX.
         02 XX-1           PIC X(4) VALUE "1234".
         02 XX-2           PIC X(4) VALUE "5678".
       01 P-XX-1        POINTER.
       01 P-XX-2        POINTER.
       LINKAGE          SECTION.
       01 Y2            PIC X(4).
       PROCEDURE        DIVISION.
         SET P-XX-1 TO ADDRESS OF XX-1
         SET P-XX-2 TO ADDRESS OF XX-2
         SET ADDRESS OF Y2 TO ADDRESS OF XX-1
         SET ADDRESS OF Y2 UP BY 4
         IF Y2 NOT = XX-2
            DISPLAY "Test 2 '" Y2 "'"
            END-DISPLAY
         END-IF
         IF ADDRESS OF Y2 NOT = P-XX-2
            DISPLAY "NOK"
         END-IF
         STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_CLEANUP


AT_SETUP([CALL RETURNING POINTER])
AT_KEYWORDS([run_extensions])

AT_DATA([prog.cob], [
       identification division.
       program-id. prog.

       data division.
       working-storage section.

       01  c-text-pointer usage pointer.

       procedure division.

           call static "cob_getenv"
                       using "COB_UNIX_LF"
                       returning c-text-pointer
           end-call

           IF function content-of(c-text-pointer) <> "1"
              DISPLAY "unexpected value: "
                      function content-of(c-text-pointer).

          GOBACK.
])

AT_DATA([calldyn.c], [
#include <libcob.h>

/* wrapper function as C functions are not
   accessible without explicit loading on all systems */
COB_EXT_EXPORT char *
calldyn (unsigned char *env_name)
{
  return cob_getenv (env_name);
}
])

AT_DATA([progdyn.cob], [
       identification division.
       program-id. progdyn.

       data division.
       working-storage section.

       01  c-text-pointer usage pointer.

       procedure division.

           call        "calldyn"
                       using "COB_UNIX_LF"
                       returning c-text-pointer
           end-call

           IF function content-of(c-text-pointer) <> "1"
              DISPLAY "unexpected value: "
                      function content-of(c-text-pointer).

          GOBACK.
])

AT_CHECK([$COMPILE -fno-gen-c-decl-static-call prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE_MODULE calldyn.c], [0], [], [])
AT_CHECK([$COMPILE progdyn.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./progdyn], [0], [], [])

AT_CLEANUP


AT_SETUP([ON EXCEPTION clause of DISPLAY])
AT_KEYWORDS([runmisc exceptions screen])

AT_CHECK([test "$COB_HAS_CURSES" = "yes" || exit 77])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.

       PROCEDURE DIVISION.
           DISPLAY "hello" AT COLUMN 500
               ON EXCEPTION
                   GOBACK RETURNING 0
               NOT ON EXCEPTION
                   GOBACK RETURNING 1
           END-DISPLAY
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([COB_EXIT_WAIT=0 $COBCRUN_DIRECT ./prog], [0], ignore, [])

AT_CLEANUP


AT_SETUP([EC-SCREEN-LINE-NUMBER and -STARTING-COLUMN])
AT_KEYWORDS([runmisc exceptions screen])

AT_CHECK([test "$COB_HAS_CURSES" = "yes" || exit 77])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog.

       DATA           DIVISION.
       SCREEN         SECTION.
       01  invalid-line.
           03  a      VALUE "a" LINE 99999999.
       01  invalid-col.
           03  c      VALUE "c" COLUMN 99999999.

       PROCEDURE      DIVISION.
           DISPLAY invalid-line END-DISPLAY
           IF FUNCTION EXCEPTION-STATUS = "EC-SCREEN-LINE-NUMBER"
               CONTINUE
           ELSE
               GOBACK RETURNING 1
           END-IF

           DISPLAY invalid-col END-DISPLAY
           IF FUNCTION EXCEPTION-STATUS = "EC-SCREEN-STARTING-COLUMN"
               CONTINUE
           ELSE
               GOBACK RETURNING 2
           END-IF

           GOBACK RETURNING 0
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([COB_EXIT_WAIT=0 $COBCRUN_DIRECT ./prog], [0], ignore, [])

AT_CLEANUP


AT_SETUP([LINE/COLUMN 0 exceptions])
AT_KEYWORDS([LINE COLUMN runmisc exceptions extensions screen])

AT_CHECK([test "$COB_HAS_CURSES" = "yes" || exit 77])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  zero-var PIC 9 VALUE 0.

       SCREEN SECTION.
       01  scr.
           03  VALUE "a".

       PROCEDURE DIVISION.
           DISPLAY scr AT LINE zero-var
           IF FUNCTION EXCEPTION-STATUS <> "EC-SCREEN-LINE-NUMBER"
               GOBACK RETURNING 1
           END-IF

           DISPLAY scr AT COLUMN zero-var
           IF FUNCTION EXCEPTION-STATUS <> "EC-SCREEN-STARTING-COLUMN"
               GOBACK RETURNING 2
           END-IF

           GOBACK RETURNING 0
           .
])

AT_CHECK([$COMPILE  -faccept-display-extensions=error prog.cob], [0], [], [])
AT_CHECK([COB_EXIT_WAIT=0 $COBCRUN_DIRECT ./prog], [0], ignore, [])

AT_CLEANUP


AT_SETUP([SET LAST EXCEPTION TO OFF])
AT_KEYWORDS([runmisc exceptions EXCEPTION-STATUS EXCEPTION-LOCATION])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  x PIC 9.

       PROCEDURE DIVISION.
           COMPUTE x = 10
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-LOCATION)
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-LOCATION)
           SET LAST EXCEPTION TO OFF
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           DISPLAY FUNCTION TRIM(FUNCTION EXCEPTION-LOCATION)
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[EC-SIZE-OVERFLOW
prog; ; 10
EC-SIZE-OVERFLOW
prog; ; 10


])
AT_CLEANUP


# PROCEDURE DIVISION RETURNING OMITTED
AT_SETUP([void PROCEDURE])
AT_KEYWORDS([runmisc])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       PROCEDURE        DIVISION RETURNING OMITTED.
           MOVE 42 TO RETURN-CODE
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           CALL "callee" RETURNING OMITTED
           END-CALL.
           DISPLAY RETURN-CODE WITH NO ADVANCING
           STOP RUN.
])

AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [+000000000], [])

AT_CLEANUP


AT_SETUP([Figurative constants to numeric field])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  NUM9    PIC 9(6).
       PROCEDURE DIVISION.
           MOVE SPACES TO NUM9
           DISPLAY "NUM9 value SPACES is " NUM9 "." UPON SYSOUT
           MOVE LOW-VALUES TO NUM9
           IF NUM9 = LOW-VALUES
              DISPLAY "9(6) tests OK for LOW-VALUES" UPON SYSOUT
           ELSE
              DISPLAY "9(6) Does NOT test OK for LOW-VALUES"
                 UPON SYSOUT
              IF NUM9 = ZERO
                 DISPLAY "9(6) tests as ZERO instead of LOW-VALUES"
                    UPON SYSOUT
              END-IF
           END-IF.
           MOVE HIGH-VALUES TO NUM9
           IF NUM9 = HIGH-VALUES
              DISPLAY "9(6) tests OK for HIGH-VALUES" UPON SYSOUT
           ELSE
              DISPLAY "9(6) Does NOT test OK for HIGH-VALUES"
                 UPON SYSOUT
              IF NUM9 = ZERO
                 DISPLAY "9(6) tests as ZERO instead of HIGH-VALUES"
                    UPON SYSOUT
              END-IF
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=mf prog.cob], [0], [],
[prog.cob:8: warning: source is non-numeric - substituting zero
prog.cob:10: warning: source is non-numeric - substituting zero
prog.cob:21: warning: source is non-numeric - substituting zero
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[NUM9 value SPACES is 000000.
9(6) Does NOT test OK for LOW-VALUES
9(6) tests as ZERO instead of LOW-VALUES
9(6) Does NOT test OK for HIGH-VALUES
9(6) tests as ZERO instead of HIGH-VALUES
], [])

AT_CHECK([$COMPILE -std=acu prog.cob -o aprog], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./aprog], [0],
[NUM9 value SPACES is       .
9(6) tests OK for LOW-VALUES
9(6) tests OK for HIGH-VALUES
], [])

AT_CLEANUP


AT_SETUP([MF FIGURATIVE to NUMERIC])
AT_KEYWORDS([MOVE])

# FIXME: This test will NOT work on EBCDIC machines,
#        either add it explicit here and split into two or add
#        a pre-test and check the expected "native" result

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  MYFLD        PIC 9(4) VALUE 96.
       01  BIGFLT       COMP-1 VALUE 543.12345E10.
       PROCEDURE        DIVISION.
       MAIN-1.
           DISPLAY "Initial value"
           PERFORM SHOW-IT.
           DISPLAY "MOVE BIGFLT"
           MOVE BIGFLT TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE SPACES"
           MOVE SPACES TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE LOW-VALUES"
           MOVE LOW-VALUES TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE HIGH-VALUES"
           MOVE HIGH-VALUES TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE QUOTE"
           MOVE QUOTE TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE ALL *"
           MOVE ALL '*' TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE ALL 0"
           MOVE ALL '0' TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE ALL 'A1'"
           MOVE ALL 'A1' TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE ALL '21'"
           MOVE ALL '21' TO MYFLD.
           PERFORM SHOW-IT.
           DISPLAY "MOVE HIGH-VALUES TO (1:)"
           MOVE HIGH-VALUES TO MYFLD (1:).
           PERFORM SHOW-IT.

           DISPLAY "MOVE HIGH-VALUES TO BIGFLT"
           MOVE HIGH-VALUES TO BIGFLT.
           PERFORM SHOW-BIG.
           CALL "dump" USING BIGFLT.
           DISPLAY "MOVE QUOTE TO BIGFLT"
           MOVE QUOTE TO BIGFLT.
           PERFORM SHOW-BIG.
           CALL "dump" USING BIGFLT.
           DISPLAY "MOVE ALL * TO BIGFLT"
           MOVE ALL '*' TO BIGFLT.
           PERFORM SHOW-BIG.
      *>   Note: the next results are dependant on endianess
      *>         therefore no dump here
           DISPLAY "MOVE ALL '21' TO BIGFLT"
           MOVE ALL '21' TO BIGFLT.
           PERFORM SHOW-BIG.
           STOP RUN.
       SHOW-IT.
           CALL "dump" USING MYFLD.
       SHOW-BIG.
           DISPLAY "BIGFLT is " BIGFLT.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <libcob.h>

COB_EXT_EXPORT int
dump (unsigned char *data)
{
  int i;
  for (i = 0; i < 4; i++)
    printf ("%02X", data[i]);
  puts (" .");
  fflush (stdout);
  return 0;
}
]])

AT_CHECK([$COMPILE -std=mf -fno-move-non-numeric-lit-to-numeric-is-zero prog.cob cmod.c], [0], [],
[prog.cob: in paragraph 'MAIN-1':
prog.cob:28: warning: numeric value is expected
prog.cob:6: note: 'MYFLD' defined here as PIC 9(4)
prog.cob:34: warning: numeric value is expected
prog.cob:52: warning: numeric value is expected
prog.cob:7: note: 'BIGFLT' defined here as USAGE FLOAT
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Initial value
30303936 .
MOVE BIGFLT
38333034 .
MOVE SPACES
20202020 .
MOVE LOW-VALUES
00000000 .
MOVE HIGH-VALUES
FFFFFFFF .
MOVE QUOTE
22222222 .
MOVE ALL *
2A2A2A2A .
MOVE ALL 0
30303030 .
MOVE ALL 'A1'
41314131 .
MOVE ALL '21'
32313231 .
MOVE HIGH-VALUES TO (1:)
FFFFFFFF .
MOVE HIGH-VALUES TO BIGFLT
BIGFLT is NaN
FFFFFFFF .
MOVE QUOTE TO BIGFLT
BIGFLT is 2.1973164E-18
22222222 .
MOVE ALL * TO BIGFLT
BIGFLT is 5.4312347E+12
MOVE ALL '21' TO BIGFLT
BIGFLT is 2.1212121E+37
], [])

AT_CLEANUP


AT_SETUP([CALL RETURNING])
AT_KEYWORDS([runmisc GIVING RETURN-CODE])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       PROCEDURE        DIVISION.
           MOVE 43 TO RETURN-CODE
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       77 my-display-return   PIC 99.
       77 my-binary-return    USAGE BINARY-LONG.
       PROCEDURE        DIVISION.
           CALL "callee" RETURNING my-display-return
           END-CALL
           IF RETURN-CODE NOT = 0
              DISPLAY '1 - unexpected RETURN-CODE: ' RETURN-CODE.
           IF my-display-return NOT = 43
              DISPLAY '1- unexpected RETURNING: ' my-display-return.
      *>
           STOP RUN.
])

AT_CHECK([$COMPILE -static caller.cob callee.cob -o prog], [0], [], [])
#AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], [], [])

AT_CLEANUP


# PROCEDURE DIVISION RETURNING OMITTED, CALL RETURNING NOTHING
AT_SETUP([void PROCEDURE, NOTHING return])
AT_KEYWORDS([runmisc PROCEDURE USING RETURNING OMITTED CALL GIVING])

AT_DATA([callee.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee.
       DATA             DIVISION.
       PROCEDURE        DIVISION RETURNING OMITTED.
           MOVE 43 TO RETURN-CODE
           EXIT PROGRAM.
])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       PROCEDURE        DIVISION.
           MOVE 42 TO RETURN-CODE
           CALL "callee" RETURNING NOTHING
           END-CALL.
           IF RETURN-CODE NOT = 42
              DISPLAY 'unexpected RETURN-CODE: ' RETURN-CODE.
           STOP RUN.
])

AT_CHECK([$COMPILE -static caller.cob callee.cob -o prog], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [42], [], [])
AT_CHECK([$COMPILE_MODULE callee.cob], [0], [], [])
AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [42], [], [])

AT_CLEANUP


# Checks both -ftrace(all), which needs to be manually set
# and    -fsource-location, which is implied by -debug/g
AT_SETUP([READY TRACE / RESET TRACE])
AT_KEYWORDS([runmisc -ftrace -ftraceall -fsource-location
CALL RECURSIVE RETURN-CODE SEARCH
COB_PHYSICAL_CANCEL COB_PRE_LOAD])

AT_DATA([caller.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      caller.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 ttab.
          03 tentries   PIC 9 VALUE 0.
          03 tentry     OCCURS 0 TO 5    DEPENDING ON tentries
                        ASCENDING KEY tkey INDEXED BY tidx.
             05 tkey    pic x(3).
       78 ZER  VALUE ZERO.
      *>
       PROCEDURE        DIVISION.
           READY TRACE
           MOVE 1 TO RETURN-CODE
           RESET TRACE
           CALL "callee1"
           END-CALL
           READY TRACE
           MOVE 2 TO RETURN-CODE
           CALL "callee1"
           END-CALL
           CALL "callee1"
           CANCEL "callee1"
           CALL "callrec"
           MOVE 0 TO RETURN-CODE
      *>
           SEARCH ALL tentry
              AT END
                 ADD  1    TO tentries
                 SET  tidx TO tentries
                 MOVE 'A'  TO tkey(tidx)
              WHEN tkey(tidx) = 'A'
                 DISPLAY '*Magic*'
           END-SEARCH
      *> tidx is still one, expect a direct find
           SEARCH tentry
              AT END
                 DISPLAY '*Dark Magic*'
              WHEN tkey(tidx) = 'A'
                 ADD  1    TO tentries
                 SET  tidx TO tentries
                 MOVE 'B'  TO tkey(tidx)
           END-SEARCH
      *> tidx is still two, expect end
           SEARCH tentry
              VARYING tidx
              AT END
                 ADD  1    TO tentries
                 SET  tidx TO tentries
                 MOVE 'C'  TO tkey(tidx)
              WHEN tkey(tidx) = ZER
                 DISPLAY '* Darker Magic *'
           END-SEARCH
           SEARCH ALL tentry
              AT END
                 DISPLAY 'NO COMMENT'
              WHEN tkey(tidx) = 'C'
                 CONTINUE
           END-SEARCH
           SEARCH ALL tentry
              WHEN tkey(tidx) = 'X'
                 CONTINUE
           END-SEARCH
      *>
           STOP RUN.
])

AT_DATA([callee1.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee1.
       PROCEDURE        DIVISION.
           ADD 1 TO RETURN-CODE
             NOT ON SIZE ERROR
               IF RETURN-CODE = 1
                 CONTINUE
               ELSE IF RETURN-CODE = 2
                 CONTINUE
               ELSE
                 CONTINUE
           .
           EVALUATE RETURN-CODE
           WHEN 1
             CONTINUE
           WHEN 2
           WHEN 3
             CONTINUE
           WHEN OTHER
             CONTINUE
           END-EVALUATE
           EVALUATE TRUE
           WHEN RETURN-CODE = 1
             CONTINUE
           WHEN RETURN-CODE = 2
           WHEN RETURN-CODE = 3
             CONTINUE
           WHEN OTHER
             CONTINUE
           END-EVALUATE
           CALL "callee2"  END-CALL
           CANCEL "callee2"  CALL "callee2b" END-CALL  CANCEL "callee2b"
           SUBTRACT 1 FROM RETURN-CODE
           EXIT PROGRAM.
])

AT_DATA([callee2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2.
       PROCEDURE        DIVISION.
           COMPUTE RETURN-CODE
                 = 1 + 1
              ON SIZE ERROR
                 MOVE -1 TO RETURN-CODE
              NOT ON SIZE ERROR
                 COMPUTE RETURN-CODE
                       = 1 + 1
                 END-COMPUTE
           END-COMPUTE.
           CALL "callee2c" END-CALL
           CANCEL "callee2c"
           MOVE 0 TO RETURN-CODE.
           EXIT PROGRAM.
])

AT_DATA([preload.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2b.
       PROCEDURE        DIVISION.
       DECLARATIVES.
       DEC SECTION. USE EXCEPTION CONDITION EC-BOUNDS.
           DISPLAY "BADDY".
       END DECLARATIVES.
       SOME-SEC SECTION.
       SOME-PAR.
           PERFORM OTHER-SEC
           MOVE 0 TO RETURN-CODE.
       ENTRY "LEAVE-ME".
       END-PAR.
           EXIT PROGRAM.
       OTHER-SEC SECTION.
           COMPUTE RETURN-CODE = 1 + 2 END-COMPUTE.
       EX. EXIT.
])

AT_DATA([preload2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callrec IS RECURSIVE.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 called-var    PIC 9 VALUE 0.
          88 first-call VALUE 0.
          88 called     VALUE 1.
       PROCEDURE        DIVISION.
       SOME-SEC SECTION.
           IF first-call
              SET called TO TRUE
              CALL 'callrec'
      *>      abbreviated 2 stmts
              MOVE 0 TO RETURN-CODE, called-var
      *>      both PERFORM and UNTIL on the same line
              PERFORM UNTIL RETURN-CODE = 3
      *>         now PERFORM and UNTIL on different line and
      *>         constant TRUE condition after compile-time optimization
                 PERFORM WITH TEST AFTER
                         UNTIL 1 = 3 - 2
      *>            no UNTIL - only PERFORM
                    PERFORM 2 TIMES
                       COMPUTE RETURN-CODE = 1 + 2
                    END-PERFORM
                 END-PERFORM
              END-PERFORM
      *>      2 different stmts, same line
              INITIALIZE RETURN-CODE  SET first-call TO TRUE
      *>      2 identical stmts, same line
              MOVE RETURN-CODE TO called-var  MOVE 0 TO RETURN-CODE
              SET called TO TRUE
           END-IF
      *>
           GOBACK.
])

AT_DATA([callee2c.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      callee2c.
       PROCEDURE        DIVISION.
       SOME-SEC SECTION.
       SOME-PAR.
           PERFORM OTHER-SEC
           MOVE 0 TO RETURN-CODE.
       END-PAR.
           EXIT PROGRAM.
       OTHER-SEC SECTION.
           COMPUTE RETURN-CODE = 1 + 2.
       EX. EXIT.
])

AT_CHECK([$COBC -ftraceall callee1.cob], [0], [], [])
AT_CHECK([$COBC callee2.cob], [0], [], [])
AT_CHECK([$COBC -ftrace -w preload.cob], [0], [], [])
AT_CHECK([$COBC -ftraceall preload2.cob], [0], [], [])
AT_CHECK([$COBC -fsource-location -w callee2c.cob], [0], [], [])
AT_CHECK([$COBC -x -o prognew -ftraceall caller.cob], [0], [], [])
AT_CHECK([COB_PHYSICAL_CANCEL=1 COB_PRE_LOAD="preload"$PATHSEP"preload2" $COBCRUN_DIRECT ./prognew], [0], [],
[Source: 'caller.cob'
Program-Id:  caller
Program-Id:  caller                      MOVE                            Line:     15
Program-Id:  caller                      RESET TRACE                     Line:     16
Program-Id:  caller                      MOVE                            Line:     20
Program-Id:  caller                      CALL                            Line:     21
Source: 'callee1.cob'
Program-Id:  callee1
Program-Id:  callee1              Entry: callee1                         Line:      5
Program-Id:  callee1                     ADD                             Line:      5
Program-Id:  callee1                     IF                              Line:      7
Program-Id:  callee1                     IF                              Line:      9
Program-Id:  callee1                     CONTINUE                        Line:     12
Program-Id:  callee1                     EVALUATE                        Line:     14
Program-Id:  callee1                     WHEN                            Line:     15
Program-Id:  callee1                     WHEN                            Line:     18
Program-Id:  callee1                     CONTINUE                        Line:     21
Program-Id:  callee1                     EVALUATE                        Line:     23
Program-Id:  callee1                     WHEN                            Line:     24
Program-Id:  callee1                     WHEN                            Line:     27
Program-Id:  callee1                     CONTINUE                        Line:     30
Program-Id:  callee1                     CALL                            Line:     32
Program-Id:  callee1                     CANCEL                          Line:     33
Program-Id:  callee1                     CALL                            Line:     33
Source: 'preload.cob'
Program-Id:  callee2b
Program-Id:  callee2b             Entry: callee2b                        Line:      8
Program-Id:  callee2b           Section: SOME-SEC                        Line:      9
Program-Id:  callee2b         Paragraph: SOME-PAR                        Line:     10
Program-Id:  callee2b           Section: OTHER-SEC                       Line:     16
Program-Id:  callee2b         Paragraph: EX                              Line:     18
Program-Id:  callee2b             Entry: LEAVE-ME                        Line:     18
Program-Id:  callee2b         Paragraph: END-PAR                         Line:     14
Program-Id:  callee2b              Exit: callee2b                        Line:     14
Source: 'callee1.cob'
Program-Id:  callee1
Program-Id:  callee1                     CANCEL                          Line:     33
Program-Id:  callee1                     SUBTRACT                        Line:     34
Program-Id:  callee1                     EXIT PROGRAM                    Line:     35
Program-Id:  callee1               Exit: callee1                         Line:     35
Source: 'caller.cob'
Program-Id:  caller
Program-Id:  caller                      CALL                            Line:     23
Source: 'callee1.cob'
Program-Id:  callee1
Program-Id:  callee1              Entry: callee1                         Line:      5
Program-Id:  callee1                     ADD                             Line:      5
Program-Id:  callee1                     IF                              Line:      7
Program-Id:  callee1                     IF                              Line:      9
Program-Id:  callee1                     CONTINUE                        Line:     12
Program-Id:  callee1                     EVALUATE                        Line:     14
Program-Id:  callee1                     WHEN                            Line:     15
Program-Id:  callee1                     WHEN                            Line:     18
Program-Id:  callee1                     CONTINUE                        Line:     21
Program-Id:  callee1                     EVALUATE                        Line:     23
Program-Id:  callee1                     WHEN                            Line:     24
Program-Id:  callee1                     WHEN                            Line:     27
Program-Id:  callee1                     CONTINUE                        Line:     30
Program-Id:  callee1                     CALL                            Line:     32
Program-Id:  callee1                     CANCEL                          Line:     33
Program-Id:  callee1                     CALL                            Line:     33
Source: 'preload.cob'
Program-Id:  callee2b
Program-Id:  callee2b             Entry: callee2b                        Line:      8
Program-Id:  callee2b           Section: SOME-SEC                        Line:      9
Program-Id:  callee2b         Paragraph: SOME-PAR                        Line:     10
Program-Id:  callee2b           Section: OTHER-SEC                       Line:     16
Program-Id:  callee2b         Paragraph: EX                              Line:     18
Program-Id:  callee2b             Entry: LEAVE-ME                        Line:     18
Program-Id:  callee2b         Paragraph: END-PAR                         Line:     14
Program-Id:  callee2b              Exit: callee2b                        Line:     14
Source: 'callee1.cob'
Program-Id:  callee1
Program-Id:  callee1                     CANCEL                          Line:     33
Program-Id:  callee1                     SUBTRACT                        Line:     34
Program-Id:  callee1                     EXIT PROGRAM                    Line:     35
Program-Id:  callee1               Exit: callee1                         Line:     35
Source: 'caller.cob'
Program-Id:  caller
Program-Id:  caller                      CANCEL                          Line:     24
Program-Id:  caller                      CALL                            Line:     25
Source: 'preload2.cob'
Program-Id:  callrec
Program-Id:  callrec              Entry: callrec                         Line:     10
Program-Id:  callrec            Section: SOME-SEC                        Line:     10
Program-Id:  callrec                     IF                              Line:     11
Program-Id:  callrec                     SET                             Line:     12
Program-Id:  callrec                     CALL                            Line:     13
Program-Id:  callrec              Entry: callrec                         Line:     10
Program-Id:  callrec            Section: SOME-SEC                        Line:     10
Program-Id:  callrec                     IF                              Line:     11
Program-Id:  callrec                     GOBACK                          Line:     35
Program-Id:  callrec               Exit: callrec                         Line:     35
Program-Id:  callrec                     MOVE                            Line:     15
Program-Id:  callrec                     PERFORM                         Line:     17
Program-Id:  callrec                     UNTIL                           Line:     17
Program-Id:  callrec                     PERFORM                         Line:     20
Program-Id:  callrec                     PERFORM                         Line:     23
Program-Id:  callrec                     COMPUTE                         Line:     24
Program-Id:  callrec                     COMPUTE                         Line:     24
Program-Id:  callrec                     UNTIL                           Line:     21
Program-Id:  callrec                     UNTIL                           Line:     17
Program-Id:  callrec                     INITIALIZE                      Line:     29
Program-Id:  callrec                     SET                             Line:     29
Program-Id:  callrec                     MOVE                            Line:     31
Program-Id:  callrec                     SET                             Line:     32
Program-Id:  callrec                     GOBACK                          Line:     35
Program-Id:  callrec               Exit: callrec                         Line:     35
Source: 'caller.cob'
Program-Id:  caller
Program-Id:  caller                      MOVE                            Line:     26
Program-Id:  caller                      SEARCH ALL                      Line:     28
Program-Id:  caller                      AT END                          Line:     29
Program-Id:  caller                      ADD                             Line:     30
Program-Id:  caller                      SET                             Line:     31
Program-Id:  caller                      MOVE                            Line:     32
Program-Id:  caller                      SEARCH                          Line:     37
Program-Id:  caller                      WHEN                            Line:     40
Program-Id:  caller                      ADD                             Line:     41
Program-Id:  caller                      SET                             Line:     42
Program-Id:  caller                      MOVE                            Line:     43
Program-Id:  caller                      SEARCH                          Line:     46
Program-Id:  caller                      WHEN                            Line:     52
Program-Id:  caller                      SEARCH VARYING                  Line:     47
Program-Id:  caller                      AT END                          Line:     48
Program-Id:  caller                      ADD                             Line:     49
Program-Id:  caller                      SET                             Line:     50
Program-Id:  caller                      MOVE                            Line:     51
Program-Id:  caller                      SEARCH ALL                      Line:     55
Program-Id:  caller                      WHEN                            Line:     58
Program-Id:  caller                      WHEN                            Line:     58
Program-Id:  caller                      CONTINUE                        Line:     59
Program-Id:  caller                      SEARCH ALL                      Line:     61
Program-Id:  caller                      WHEN                            Line:     62
Program-Id:  caller                      WHEN                            Line:     62
Program-Id:  caller                      AT END                          Line:     64
Program-Id:  caller                      STOP RUN                        Line:     66
])

AT_CLEANUP


AT_SETUP([stack and dump feature])
AT_KEYWORDS([stacktrace configuration COB_STACKTRACE COB_DUMP_FILE SOURCE_DATE_EPOCH])

# Note: we use SOURCE_DATE_EPOCH to have a predictable output in dumps;
# this also allows to test this feature at the same time

AT_DATA([cpyabrt], [
            MOVE "Quick brown fox jumped over the dog"
              TO TSTTAILX (1:40).
            MOVE CM-COMPANY TO TSTTAILX (42:20).
      *     DISPLAY ':' X ':'.
      *     DISPLAY CM-COMPANY.
      *     DISPLAY '>' CM-COMPANY '<'.
])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT FLATFILE ASSIGN EXTERNAL RELFIX
           ORGANIZATION RELATIVE
           ACCESS IS SEQUENTIAL RELATIVE KEY IS REC-NUM
           FILE STATUS IS CUST-STAT.

       DATA  DIVISION.
       FILE SECTION.
       FD  FLATFILE
           BLOCK CONTAINS 5 RECORDS.

       01  TSPFL-RECORD.
           10  CM-CUST-NUM                     PICTURE X(8).
           10  CM-COMPANY                      PICTURE X(25).
           10  CM-DISK                         PICTURE X(8).
           10  CM-NO-TERMINALS                 PICTURE 9(4).

       WORKING-STORAGE SECTION.
       77  MAX-SUB           VALUE  6          PICTURE 9(4) COMP SYNC.
       77  CUST-STAT                           PICTURE X(2).
       77  REC-NUM           VALUE  1          PICTURE 9(4).
       01  BIN                      PIC 9(9) BINARY VALUE 0.

       01  TEST-DATA.
         02  DATA-CUST-NUM-TBL.
           05  FILLER PIC X(8) VALUE "ALP00000".
           05  FILLER PIC X(8) VALUE "BET00000".
           05  FILLER PIC X(8) VALUE "DEL00000".
           05  FILLER PIC X(8) VALUE "EPS00000".
           05  FILLER PIC X(8) VALUE "FOR00000".
           05  FILLER PIC X(8) VALUE "GAM00000".

         02  DATA-CUST-NUM REDEFINES DATA-CUST-NUM-TBL
                                       PIC X(8) OCCURS 6.
         02  DATA-COMPANY-TBL.
           05  FILLER PIC X(25) VALUE "ALPHA ELECTRICAL CO. LTD.".
           05  FILLER PIC X(25) VALUE "BETA SHOE MFG. INC.      ".
           05  FILLER PIC X(25) VALUE "DELTA LUGGAGE REPAIRS    ".
           05  FILLER PIC X(25) VALUE "EPSILON EQUIPMENT SUPPLY ".
           05  FILLER PIC X(25) VALUE "FORTUNE COOKIE COMPANY   ".
           05  FILLER PIC X(25) VALUE "GAMMA X-RAY TECHNOLOGY   ".
         02  DATA-COMPANY  REDEFINES DATA-COMPANY-TBL
                                       PIC X(25) OCCURS 6.
         02  DATA-ADDRESS-2-TBL.
           05  FILLER PIC X(10) VALUE "ATLANTA   ".
           05  FILLER PIC X(10) VALUE "CALGARY   ".
           05  FILLER PIC X(10) VALUE "NEW YORK  ".
           05  FILLER PIC X(10) VALUE "TORONTO   ".
           05  FILLER PIC X(10) VALUE "WASHINGTON".
           05  FILLER PIC X(10) VALUE "WHITEPLAIN".
         02  DATA-ADDRESS   REDEFINES DATA-ADDRESS-2-TBL
                                       PIC X(10) OCCURS 6.

         02  DATA-NO-TERMINALS-TBL.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 13.
           05  FILLER PIC 9(3) COMP-3 VALUE 75.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 90.
           05  FILLER PIC 9(3) COMP-3 VALUE 254.
         02  DATA-NO-TERMINALS REDEFINES DATA-NO-TERMINALS-TBL
                                       PIC 9(3) COMP-3 OCCURS 6.
       01  WORK-AREA IS EXTERNAL.
           05  SUB                             PICTURE 9(4) COMP SYNC.
               88  ODD-RECORD                  VALUE 1 3 5.
       01  SUMS-NON-STD-OCCURS PIC S9(15)V9(03) OCCURS 8 VALUE -42.345.

       PROCEDURE DIVISION.

           PERFORM LOADFILE.

           OPEN INPUT FLATFILE.
           READ FLATFILE.

       MAIN-100.
           PERFORM CALL-SUB-1.
           PERFORM CALL-SUB-2.
           PERFORM CALL-IT-OMIT.
           STOP RUN.

       LOADFILE.
           OPEN OUTPUT FLATFILE.

           PERFORM LOAD-RECORD
                        VARYING SUB FROM 1 BY 1
                          UNTIL SUB > MAX-SUB.

           CLOSE FLATFILE.

       LOAD-RECORD.

           MOVE SPACES                       TO TSPFL-RECORD.
           MOVE DATA-CUST-NUM      (SUB)     TO CM-CUST-NUM.
           MOVE DATA-COMPANY       (SUB)     TO CM-COMPANY.
           MOVE DATA-NO-TERMINALS  (SUB)     TO CM-NO-TERMINALS.
           IF  ODD-RECORD
               MOVE "8417"                   TO CM-DISK
           ELSE
               MOVE "8470"                   TO CM-DISK.
           WRITE TSPFL-RECORD.

       CALL-SUB-1 SECTION.
           CALL "sub1" USING bin, TSPFL-RECORD.

       CALL-SUB-2 SECTION.
           MOVE 4096 TO bin, SUMS-NON-STD-OCCURS (2)
           CALL "sub2" USING bin, TSPFL-RECORD.

       CALL-IT-OMIT SECTION.
           MOVE 5440 TO bin, SUMS-NON-STD-OCCURS (3)
           CALL "sub2" USING bin, TSPFL-RECORD.

           END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. sub1.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  ZRO  PIC 9(9) BINARY VALUE 0.
       01  HEXV PIC X  COMP-X.
       01  HEXC REDEFINES HEXV PIC X.

       01 TEST-BASED BASED.
          05 TEST-BASED-SUB PIC X(00000100000).

       01 TEST-ALLOCED BASED.
          05 TEST-ALLOCED-SUB1 PIC X(010).
          05 TEST-ALLOCED-SUB2 PIC 9(006).

       01  IDX PIC 9(9) BINARY VALUE 0.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.
         05  TSTTAIL1  PIC 99.
         05  TSTCOMP3  PIC 9(5) COMP-3.
         05  TSTLONG   PIC X(100).
         05  TSTHEX    PIC X(100).
         05  TSTHEX2   PIC X(60).
         05  TSTTAILX  PIC X(80).

       LINKAGE SECTION.
       01  X  PIC 9(9) BINARY.
       01  TSPFL-RECORD.
           10  CM-CUST-NUM                     PICTURE X(8).
           10  CM-COMPANY                      PICTURE X(25).
           10  CM-DISK                         PICTURE X(8).
           10  CM-NO-TERMINALS                 PICTURE 9(4).

       PROCEDURE DIVISION USING X, TSPFL-RECORD.
       MAIN-1 SECTION.
            MOVE ALL "X" TO TSTREC.
            MOVE 1 TO TSTG-1 (1).
            MOVE 2 TO TSTG-1 (2).
            MOVE 3 TO TSTG-1 (3).
            MOVE 'A' TO TSTX-2 (1,1).
            MOVE 'B' TO TSTX-2 (2,1).
            MOVE 'C' TO TSTX-2 (3,1).
            MOVE 'xx' TO TSTX-2 (1,4).
            MOVE 'yy' TO TSTX-2 (2,4).
            MOVE 'zz' TO TSTX-2 (3,4).
            MOVE SPACES TO TSTX-2 (1,3).
            MOVE HIGH-VALUES TO TSTX (4).
            MOVE LOW-VALUES TO TSTX-2 (2,3).
            MOVE HIGH-VALUES TO TSTX-2 (3,3).
            MOVE "Quick brown fox jumped over the dog"
              TO TSTLONG, TSTLONG (50:36).
            MOVE "Quicker grey fox jumped the cougar"
              TO TSTHEX (1:35). PERFORM MAIN-2.
       MAIN-2.
            MOVE 17 TO HEXV.
            MOVE HEXC TO TSTHEX (39:1).
            MOVE HEXC TO TSTTAIL1 (2:1).
            MOVE 7 TO HEXV.
            MOVE HEXC TO TSTHEX (47:1).
            MOVE 13 TO HEXV.
            MOVE HEXC TO TSTHEX (59:1).
            MOVE 0 TO HEXV.
            MOVE HEXC TO TSTHEX2 (39:1), TSTHEX2 (10:1).
            MOVE 9 TO HEXV.
            MOVE HEXC TO TSTHEX2 (47:1).
            MOVE '\' TO TSTHEX2 (32:1).
            MOVE 13 TO HEXV.
            MOVE HEXC TO TSTHEX2 (59:1).
            MOVE 'A' TO TSTHEX2 (54:1).
            MOVE LOW-VALUES TO TSTTAILX
            ADD 1 TO X.
            DISPLAY "X is " X.
            ALLOCATE TEST-ALLOCED INITIALIZED.
            COPY cpyabrt.
            IF ADDRESS OF TEST-BASED NOT = NULL
              DISPLAY TEST-BASED-SUB
            END-IF.
            GOBACK.
       END PROGRAM sub1.
])

AT_DATA([sub2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. sub2.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  ZRO PIC 9(9) BINARY VALUE 0.
       01  HEXV PIC X  COMP-X.
       01  HEXC REDEFINES HEXV PIC X.

       01  IDX PIC 9(9) BINARY VALUE 0.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.
         05  TSTTAIL1  PIC 99.
         05  TSTCOMP3  PIC 9(5) COMP-3.
         05  TSTLONG   PIC X(100).
         05  TSTHEX    PIC X(100).
         05  TSTHEX2   PIC X(60).
         05  TSTTAILX  PIC X(80).

       01  BASED-RECORD BASED.
           10  B-NUM              PICTURE 9(4) VALUE 123.
           10  B-DISK             PICTURE X(8) VALUE "marvdisc".
           10  B-NO-TERMINALS     PICTURE 9(4).
       77  BASED-NEVER-SET        PIC     X    BASED.

       LINKAGE SECTION.
       01  X  PIC 9(9) BINARY.
       01  TSPFL-RECORD.
           10  CM-CUST-NUM        PICTURE X(8).
           10  CM-COMPANY         PICTURE X(25).
           10  CM-DISK            PICTURE X(8).
           10  CM-NO-TERMINALS    PICTURE 9(4).
       77  DYNAMIC-NUM            PICTURE 9(4).

       PROCEDURE DIVISION USING X, TSPFL-RECORD.
       SubwaY SECTION.
           IF ADDRESS OF BASED-RECORD = NULL
              ALLOCATE BASED-RECORD INITIALIZED
           ELSE
              SET ADDRESS OF DYNAMIC-NUM TO ADDRESS OF BASED-RECORD
              ADD 1 TO B-NUM
           END-IF.
       DO-CALL.
           IF X = 5440
               CALL "sub1" USING X, OMITTED.
           MOVE ALL "X" TO TSTREC.
           MOVE 1 TO TSTG-1 (1).
           MOVE 2 TO TSTG-1 (2).
           MOVE 3 TO TSTG-1 (3).
           MOVE 'A' TO TSTX-2 (1,1).
           MOVE 'B' TO TSTX-2 (2,1).
           MOVE 'C' TO TSTX-2 (3,1).
           MOVE 'xx' TO TSTX-2 (1,4).
           MOVE 'yy' TO TSTX-2 (2,4).
           MOVE 'zz' TO TSTX-2 (3,4).
           MOVE SPACES TO TSTX-2 (1,3).
           MOVE HIGH-VALUES TO TSTX (4).
           MOVE LOW-VALUES TO TSTX-2 (2,3).
           MOVE HIGH-VALUES TO TSTX-2 (3,3).
           MOVE "Quick brown fox jumped over the dog"
             TO TSTLONG, TSTLONG (50:36).
           MOVE "Quicker grey fox jumped the cougar"
             TO TSTHEX (1:35).
           MOVE 17 TO HEXV.
           MOVE HEXC TO TSTHEX (39:1).
           MOVE HEXC TO TSTTAIL1 (2:1).
           MOVE 7 TO HEXV.
           MOVE HEXC TO TSTHEX (47:1).
           MOVE 13 TO HEXV.
           MOVE HEXC TO TSTHEX (59:1).
           MOVE 0 TO HEXV.
           MOVE HEXC TO TSTHEX2 (39:1), TSTHEX2 (10:1).
           MOVE 9 TO HEXV.
           MOVE HEXC TO TSTHEX2 (47:1).
           MOVE '\' TO TSTHEX2 (32:1).
           MOVE 13 TO HEXV.
           MOVE HEXC TO TSTHEX2 (59:1).
           MOVE 'A' TO TSTHEX2 (54:1).
           MOVE LOW-VALUES TO TSTTAILX.
      *
           COPY cpyabrt.
       END PROGRAM sub2.
])

AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE_MODULE -fdump=ALL prog.cob sub2.cob], [0], [], [])

AT_CHECK([COB_DUMP_FILE=NONE \
$COBCRUN prog], [1],
[X is 000000001
X is 000005441
],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')
])

AT_CAPTURE_FILE([tstdump.dump])

AT_CHECK([COB_DUMP_FILE=tstdump.dump \
$COBCRUN prog], [1],
[X is 000000001
X is 000005441
],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

dump written to tstdump.dump
])

# TODO: the first item of each WORKING-STORAGE section
# in the dump below should be:
# 77        RETURN-CODE                     +000000000
AT_DATA([reference], [
Module dump due to LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller

 Last statement of "sub1" was MOVE
	MAIN-2 OF MAIN-1 at cpyabrt:4
	MAIN-1 at prog.cob:177
	ENTRY sub1 at prog.cob:159
 Last statement of "sub2" was CALL
	DO-CALL OF SubwaY at sub2.cob:48
	ENTRY sub2 at sub2.cob:39
 Last statement of "prog" was CALL
	CALL-IT-OMIT at prog.cob:118
	MAIN-100 at prog.cob:85
	ENTRY prog at prog.cob:77
 Started by prog

Dump Program-Id sub1 from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
01        ZRO                             000000000
01        HEXV                            013
01        TEST-BASED.                    <NULL> address
01        TEST-ALLOCED.
  05      TEST-ALLOCED-SUB1              ALL SPACES
  05      TEST-ALLOCED-SUB2               000000
01        IDX                             000000000
01        TSTREC.
  05      TSTDEP                         'XXX'
  05      TSTX (1).
       15 TSTG-1 (1)                      01
       15 TSTX-2 (1,1)                   'A'
       15 TSTX-2 (1,2)                   'XX'
       15 TSTX-2 (1,3)                   ALL SPACES
       15 TSTX-2 (1,4)                   'xx'
  05      TSTX (2).
       15 TSTG-1 (2)                      02
       15 TSTX-2 (2,1)                   'B'
       15 TSTX-2 (2,2)                   'XX'
       15 TSTX-2 (2,3)                   ALL LOW-VALUES
       15 TSTX-2 (2,4)                   'yy'
  05      TSTX (3).
       15 TSTG-1 (3)                      03
       15 TSTX-2 (3,1)                   'C'
       15 TSTX-2 (3,2)                   'XX'
       15 TSTX-2 (3,3)                   ALL HIGH-VALUES
       15 TSTX-2 (3,4)                   'zz'
  05      TSTX (4).
       15 TSTG-1 (4)                     ALL HIGH-VALUES
       15 TSTX-2 (4,1)                   ALL HIGH-VALUES
       15 TSTX-2 (4,2..4) same as (1)
  05      TSTTAIL1                        X  @&t@
                                     1 x 5811
  05      TSTCOMP3                        58585
  05      TSTLONG                        'Quick brown fox jumped over the dog              Quick br'
                                      57:'own fox jumped over the dog'
  05      TSTHEX                          Q u i c  k e r    g r e y    f o x    j u m  p e d  @&t@
                                     1 x 51756963 6B657220 67726579 20666F78 206A756D 70656420
                                          t h e    c o u g  a r   X  X X   X  X X X X  X X   X
                                    25 x 74686520 636F7567 61722058 58581158 58585858 58580758
                                          X X X X  X X X X  X X   X  X X X X  X X X X  X X X X
                                    49 x 58585858 58585858 58580D58 58585858 58585858 58585858
                                          X X X X  X X X X  X X X X  X X X X  X X X X  X X X X
                                    73 x 58585858 58585858 58585858 58585858 58585858 58585858
                                          X X X X
                                    97 x 58585858
  05      TSTHEX2                        XXXXXXXXX\0XXXXXXXXXXXXXXXXXXXXX\\XXXXXX\0XXXXXXX\tXXXXXX
                                    54 : AXXXX\rX
  05      TSTTAILX                       'Quick brown fox jumped over the dog     '
                                  trailing LOW-VALUES

LINKAGE
**********************
01        X                               000005441
01        TSPFL-RECORD.                  <NULL> address

END OF DUMP - sub1
**********************

Dump Program-Id sub2 from sub2.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
01        ZRO                             000000000
01        HEXV                            013
01        IDX                             000000000
01        TSTREC.
  05      TSTDEP                         'XXX'
  05      TSTX (1).
       15 TSTG-1 (1)                      01
       15 TSTX-2 (1,1)                   'A'
       15 TSTX-2 (1,2)                   'XX'
       15 TSTX-2 (1,3)                   ALL SPACES
       15 TSTX-2 (1,4)                   'xx'
  05      TSTX (2).
       15 TSTG-1 (2)                      02
       15 TSTX-2 (2,1)                   'B'
       15 TSTX-2 (2,2)                   'XX'
       15 TSTX-2 (2,3)                   ALL LOW-VALUES
       15 TSTX-2 (2,4)                   'yy'
  05      TSTX (3).
       15 TSTG-1 (3)                      03
       15 TSTX-2 (3,1)                   'C'
       15 TSTX-2 (3,2)                   'XX'
       15 TSTX-2 (3,3)                   ALL HIGH-VALUES
       15 TSTX-2 (3,4)                   'zz'
  05      TSTX (4).
       15 TSTG-1 (4)                     ALL HIGH-VALUES
       15 TSTX-2 (4,1)                   ALL HIGH-VALUES
       15 TSTX-2 (4,2..4) same as (1)
  05      TSTTAIL1                        X  @&t@
                                     1 x 5811
  05      TSTCOMP3                        58585
  05      TSTLONG                        'Quick brown fox jumped over the dog              Quick br'
                                      57:'own fox jumped over the dog'
  05      TSTHEX                          Q u i c  k e r    g r e y    f o x    j u m  p e d  @&t@
                                     1 x 51756963 6B657220 67726579 20666F78 206A756D 70656420
                                          t h e    c o u g  a r   X  X X   X  X X X X  X X   X
                                    25 x 74686520 636F7567 61722058 58581158 58585858 58580758
                                          X X X X  X X X X  X X   X  X X X X  X X X X  X X X X
                                    49 x 58585858 58585858 58580D58 58585858 58585858 58585858
                                          X X X X  X X X X  X X X X  X X X X  X X X X  X X X X
                                    73 x 58585858 58585858 58585858 58585858 58585858 58585858
                                          X X X X
                                    97 x 58585858
  05      TSTHEX2                        XXXXXXXXX\0XXXXXXXXXXXXXXXXXXXXX\\XXXXXX\0XXXXXXX\tXXXXXX
                                    54 : AXXXX\rX
  05      TSTTAILX                       Quick brown fox jumped over the dog     \0ALPHA ELECTRICA
                                    57 : L CO.\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
01        BASED-RECORD.
     10   B-NUM                           0124
     10   B-DISK                         'marvdisc'
     10   B-NO-TERMINALS                  0000
77        BASED-NEVER-SET                <NULL> address

LINKAGE
**********************
01        X                               000005441
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'ALP00000'
     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   CM-DISK                        '8417'
     10   CM-NO-TERMINALS                 0010
77        DYNAMIC-NUM                     0124

END OF DUMP - sub2
**********************

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

FD FLATFILE
**********************
   File is OPEN
   FILE STATUS  '00'
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'ALP00000'
     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   CM-DISK                        '8417'
     10   CM-NO-TERMINALS                 0010

WORKING-STORAGE
**********************
77        MAX-SUB                         0006
77        CUST-STAT                      ALL ZEROES
77        REC-NUM                         0001
01        BIN                             000005441
01        TEST-DATA.
 02       DATA-CUST-NUM-TBL.
  05      FILLER                         'ALP00000'
  05      FILLER                         'BET00000'
  05      FILLER                         'DEL00000'
  05      FILLER                         'EPS00000'
  05      FILLER                         'FOR00000'
  05      FILLER                         'GAM00000'
 02       DATA-COMPANY-TBL.
  05      FILLER                         'ALPHA ELECTRICAL CO. LTD.'
  05      FILLER                         'BETA SHOE MFG. INC.'
  05      FILLER                         'DELTA LUGGAGE REPAIRS'
  05      FILLER                         'EPSILON EQUIPMENT SUPPLY'
  05      FILLER                         'FORTUNE COOKIE COMPANY'
  05      FILLER                         'GAMMA X-RAY TECHNOLOGY'
 02       DATA-ADDRESS-2-TBL.
  05      FILLER                         'ATLANTA'
  05      FILLER                         'CALGARY'
  05      FILLER                         'NEW YORK'
  05      FILLER                         'TORONTO'
  05      FILLER                         'WASHINGTON'
  05      FILLER                         'WHITEPLAIN'
 02       DATA-NO-TERMINALS-TBL.
  05      FILLER                          010
  05      FILLER                          013
  05      FILLER                          075
  05      FILLER                          010
  05      FILLER                          090
  05      FILLER                          254
01        WORK-AREA.
  05      SUB                             0007
01        SUMS-NON-STD-OCCURS (1)         -000000000000042.345
01        SUMS-NON-STD-OCCURS (2)         +000000000004096.000
01        SUMS-NON-STD-OCCURS (3)         +000000000005440.000
01        SUMS-NON-STD-OCCURS (4)         -000000000000042.345
01        SUMS-NON-STD-OCCURS (5..8) same as (4)

END OF DUMP - prog
**********************

])

AT_CHECK([$DIFF reference tstdump.dump], [0], [], [])

# using both
AT_CHECK([COB_STACKTRACE=1 COB_DUMP_FILE=tstdump.dump \
$COBCRUN prog], [1],
[X is 000000001
X is 000005441
],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

 Last statement of "sub1" was MOVE
	MAIN-2 OF MAIN-1 at cpyabrt:4
	MAIN-1 at prog.cob:177
	ENTRY sub1 at prog.cob:159
 Last statement of "sub2" was CALL
	DO-CALL OF SubwaY at sub2.cob:48
	ENTRY sub2 at sub2.cob:39
 Last statement of "prog" was CALL
	CALL-IT-OMIT at prog.cob:118
	MAIN-100 at prog.cob:85
	ENTRY prog at prog.cob:77
 Started by prog

dump written to tstdump.dump
])

AT_CHECK([$DIFF reference tstdump.dump], [0], [], [])


AT_DATA([reference_stderr],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

 Last statement of "sub1" was MOVE
	MAIN-2 OF MAIN-1 at cpyabrt:4
	MAIN-1 at prog.cob:177
	ENTRY sub1 at prog.cob:159
 Last statement of "sub2" was CALL
	DO-CALL OF SubwaY at sub2.cob:48
	ENTRY sub2 at sub2.cob:39
 Last statement of "prog" was CALL
	CALL-IT-OMIT at prog.cob:118
	MAIN-100 at prog.cob:85
	ENTRY prog at prog.cob:77
 Started by ./prog
])

AT_CAPTURE_FILE([stderr.txt])

AT_CHECK([$COMPILE prog.cob sub2.cob], [0], [], [])

# also checking that a dump file without anything to dump does not do anything
AT_CHECK([COB_STACKTRACE=1 COB_DUMP_FILE=tstdump.dump \
$COBCRUN_DIRECT ./prog 2>stderr.txt], [1],
[X is 000000001
X is 000005441
], [])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
stderr.txt > stderr.sed], [0], [], [])
AT_CHECK([$DIFF reference_stderr stderr.sed], [0], [], [])


AT_CHECK([$COMPILE -fdump=ALL -fno-dump prog.cob sub2.cob], [0], [], [])

# also checking that a dump file without anything to dump does not do anything
AT_CHECK([COB_STACKTRACE=1 COB_DUMP_FILE=tstdump.dump \
$COBCRUN_DIRECT ./prog 2>stderr.txt], [1],
[X is 000000001
X is 000005441
], [])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
stderr.txt > stderr.sed], [0], [], [])
AT_CHECK([$DIFF reference_stderr stderr.sed], [0], [], [])


AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -fdump=FD,LS prog.cob sub2.cob -o prog_fdls], [0], [], [])

AT_CHECK([COB_DUMP_FILE=tstdump_fdls.dump \
$COBCRUN_DIRECT ./prog_fdls], [1],
[X is 000000001
X is 000005441
],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

dump written to tstdump_fdls.dump
])

AT_CAPTURE_FILE([tstdump_fdls.dump])

AT_DATA([reference_fdls], [
Module dump due to LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller

 Last statement of "sub1" was MOVE
	MAIN-2 OF MAIN-1 at cpyabrt:4
	MAIN-1 at prog.cob:177
	ENTRY sub1 at prog.cob:159
 Last statement of "sub2" was CALL
	DO-CALL OF SubwaY at sub2.cob:48
	ENTRY sub2 at sub2.cob:39
 Last statement of "prog" was CALL
	CALL-IT-OMIT at prog.cob:118
	MAIN-100 at prog.cob:85
	ENTRY prog at prog.cob:77
 Started by ./prog_fdls

Dump Program-Id sub1 from prog.cob compiled Jan 25 2002 12:00:00

LINKAGE
**********************
01        X                               000005441
01        TSPFL-RECORD.                  <NULL> address

END OF DUMP - sub1
**********************

Dump Program-Id sub2 from sub2.cob compiled Jan 25 2002 12:00:00

LINKAGE
**********************
01        X                               000005441
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'ALP00000'
     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   CM-DISK                        '8417'
     10   CM-NO-TERMINALS                 0010
77        DYNAMIC-NUM                     0124

END OF DUMP - sub2
**********************

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

FD FLATFILE
**********************
   File is OPEN
   FILE STATUS  '00'
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'ALP00000'
     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   CM-DISK                        '8417'
     10   CM-NO-TERMINALS                 0010

END OF DUMP - prog
**********************

])

AT_CHECK([$SED -e 's/Started by .*prog_fdls.exe/Started by .\/prog_fdls/g' \
tstdump_fdls.dump > tstdump.sed], [0], [], [])
AT_CHECK([$DIFF reference_fdls tstdump.sed], [0], [], [])


AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -fdump=ALL -fno-dump=LO,WS,SC prog.cob sub2.cob -o prog_allfdls], [0], [], [])

AT_CHECK([COB_DUMP_FILE=tstdump_allfdls.dump \
$COBCRUN_DIRECT ./prog_allfdls], [1],
[X is 000000001
X is 000005441
],
[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

dump written to tstdump_allfdls.dump
])

AT_CHECK([$SED -e 's/Started by .*prog_allfdls.exe/Started by .\/prog_allfdls/g' \
tstdump_allfdls.dump > tstdump.sed], [0], [], [])
AT_CHECK([$SED -e 's/prog_fdls/prog_allfdls/' \
reference_fdls > reference_all], [0], [], [])
AT_CHECK([$DIFF reference_all tstdump.sed], [0], [], [])


# CHECKME @ Ron: The result is likely wrong, please verify later
#AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
#$COMPILE -fdump=LS prog.cob sub2.cob -fsticky-linkage -o prog_ls_sticky], [0], [], [])
#
#AT_CHECK([COB_DUMP_FILE=tstdump_ls_sticky.dump \
#$COBCRUN_DIRECT ./prog_ls_sticky], [1],
#[X is 000000001
#X is 000005441
#],
#[libcob: cpyabrt:4: error: LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
#libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')
#
#dump written to tstdump_ls_sticky.dump
#])
#
#AT_CAPTURE_FILE([tstdump_ls_sticky.dump])
#
#AT_DATA([reference_ls_sticky], [
#Module dump due to LINKAGE item 'TSPFL-RECORD' (accessed by 'CM-COMPANY') not passed by caller
#
# Last statement of "sub1" was MOVE
#	MAIN-2 OF MAIN-1 at cpyabrt:4
#	MAIN-1 at prog.cob:177
#	ENTRY sub1 at prog.cob:159
# Last statement of "sub2" was CALL
#	DO-CALL OF SubwaY at sub2.cob:48
#	ENTRY sub2 at sub2.cob:39
# Last statement of "prog" was CALL
#	CALL-IT-OMIT at prog.cob:118
#	MAIN-100 at prog.cob:85
#	ENTRY prog at prog.cob:77
# Started by ./prog_ls_sticky
#
#Dump Program-Id sub1 from prog.cob compiled Jan 25 2002 12:00:00
#
#LINKAGE
#**********************
#01        X                               000005441
#01        TSPFL-RECORD.                  <NULL> address
#
#Dump Program-Id sub2 from sub2.cob compiled Jan 25 2002 12:00:00
#
#LINKAGE
#**********************
#01        X                               000005441
#01        TSPFL-RECORD.
#     10   CM-CUST-NUM                    'ALP00000'
#     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
#     10   CM-DISK                        '8417'
#     10   CM-NO-TERMINALS                 0010
#77        DYNAMIC-NUM                     0124
#
#Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00
#
#])
#
#AT_CHECK([$DIFF reference tstdump_ls_sticky.dump], [0], [], [])

AT_CLEANUP


AT_SETUP([dump feature with NULL address])
AT_KEYWORDS([stack stacktrace SOURCE_DATE_EPOCH])

# Note: we use SOURCE_DATE_EPOCH to have a predictable output in dumps;
# this also allows to test this feature at the same time

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  P2           USAGE POINTER.

       01 TAB-ADR-COUNT            PIC S9(4)      VALUE 8.

       01 TAB-ADR OCCURS 0 TO 1000 TIMES
            DEPENDING ON TAB-ADR-COUNT
            INDEXED BY TAB-ADR-IND.
          05 TAB-ADR-ELEMENT.
              10 TAB-ADR-PRGM         PIC X(8).
              10 TAB-ADR-ID           PIC X(2).
              10 TAB-ADR-ADR-64       PIC S9(16) COMP-5.
              10 TAB-ADR-LAST-ADR-64  PIC S9(16) COMP-5.

       01  GRP-X BASED.
           05   FILLER  PIC X(3).
           05   FLD-X   OCCURS 10 TIMES.
             10 FLD-X-Y   PIC 9999 VALUE 2020.
             10 FLD-X-M   PIC 99 VALUE 11.
             10 FLD-X-X   PIC X(128) VALUE "This is something ".
           05   FILLER  PIC X(3).

       01  GRP-1.
           05   FILLER  PIC X(3).
           05   FLD-1   OCCURS 10 TIMES.
             10 FLD-1-Y   PIC 9999 VALUE 2020.
             10 FLD-1-M   PIC 99 VALUE 11.
             10 FLD-1-X   PIC X(128) VALUE "This is something ".
           05   FILLER  PIC X(3).

       01  GRP-2.
           05   FILLER  PIC X(3).
           05   FLD-2   PIC X(42) VALUE ALL "ABCD ".
           05   FILLER  PIC X(3).
       01  GRP-2A.
           05   FILLER  PIC X(2).
           05   FLD-2A  PIC X(8) VALUE ALL "ABC".
           05   FILLER  PIC X(1200) VALUE "X".
       01  GRP-3.
           05   FILLER  PIC X(3).
           05   FLD-3   OCCURS 3 TIMES.
                15   FLD-3-2 PIC XXX VALUE "ABC".
                15   FLD-3-3 PIC 99  VALUE ZERO.
                15           OCCURS 4 VALUE ALL "D99".
                     25   FLD-3O-1 PIC X.
                     25   FLD-3O-2 PIC 99.
                15   FLD-3-4 PIC XX  VALUE ALL "X".
           05   FILLER  PIC X(3).

       77  C5    PIC 9(03)  VALUE 6.
       01  GRP-5.
           05   FILLER  PIC X(3).
           05   FLD-5.
              10   FLD-5-1 OCCURS 0 TO 9 TIMES
                        DEPENDING ON C5.
                15   FLD-5-2 PIC XXX VALUE "Mon".
                15   FLD-5-3 PIC 99  VALUE 49.
                15   FLD-5-4 PIC XX  VALUE "ey".

       LINKAGE SECTION.
       01  A-TABLE.
           03  prefix.
               05  n    PIC 9(03)  VALUE 123.
           03  table-data value all "ABCDE".
            04  rows    OCCURS 0 TO UNBOUNDED TIMES
                        DEPENDING ON n.
               05 col1  PIC X.
               05 col2  PIC X(02).

       PROCEDURE DIVISION.
           MOVE ALL "*" TO GRP-2
           INITIALIZE FLD-2 ALL TO VALUE
           DISPLAY "GRP-2:" GRP-2.
      *
           MOVE ALL "*" TO GRP-3
           INITIALIZE GRP-3 NUMERIC TO VALUE
           INITIALIZE FLD-3 (1) ALL TO VALUE
           INITIALIZE FLD-3 (2) ALL TO VALUE
           INITIALIZE FLD-3 (3) ALL TO VALUE
           INITIALIZE FLD-3O-1 (3,2), FLD-3O-2 (3,2)
           DISPLAY "GRP-3:" GRP-3.
      *
           MOVE 7       TO c5
           MOVE ALL "*" TO GRP-5
           INITIALIZE FLD-5 ALL TO VALUE
           DISPLAY "GRP-5:" GRP-5.
      *
           MOVE SPACES  TO GRP-2A
           MOVE "Peek"  TO GRP-2A (510:4)
           MOVE "Boo"   TO GRP-2A (910:3)
           MOVE X"FE99" TO GRP-2A (910:2)
           MOVE "You"   TO GRP-2A (1010:3)
           MOVE "$$"    TO FLD-5-4 (5)
           MOVE "Something else!" TO FLD-1-X (5).
      *
      *    "the initial value of an index-name at runtime is undefined"
      *    Old OpenCOBOL/GnuCOBOL did that as "1"
           SET TAB-ADR-IND           TO 1.
      *
           SET P2 TO NULL
           SET ADDRESS OF A-TABLE TO NULL
           MOVE ALL ZEROES TO A-TABLE (1: (LENGTH OF A-TABLE)).
      *
           STOP RUN.
])

AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -fdump=ALL prog.cob], [0], [], [])

AT_CHECK([COB_DUMP_FILE=dumpall.txt \
$COBCRUN_DIRECT ./prog "param 1" param 'param 3'], [1],
[GRP-2:***ABCD ABCD ABCD ABCD ABCD ABCD ABCD ABCD AB***
GRP-3:***ABC00D99D99D99D99XXABC00D99D99D99D99XXABC00D99 00D99D99XX***
GRP-5:***Mon49eyMon49eyMon49eyMon49eyMon49eyMon49eyMon49ey
],
[libcob: prog.cob:106: error: BASED/LINKAGE item 'A-TABLE' has NULL address

dump written to dumpall.txt
])

AT_CAPTURE_FILE([dumpall.txt])

# TODO: the first item the WORKING-STORAGE section
# in the dump below should be:
# 77        RETURN-CODE                     +000000000
AT_DATA([reference_tmpl], [
Module dump due to BASED/LINKAGE item 'A-TABLE' has NULL address

 Last statement of "prog" was MOVE at line 106 of prog.cob
	ENTRY prog at prog.cob:75
 Started by ./prog
	param 1
	param
	param 3

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
01        P2                              0x0000000000000000
01        TAB-ADR-COUNT                   +0008
   INDEX  TAB-ADR-IND                     +000000001
01        TAB-ADR (1).
  05      TAB-ADR-ELEMENT (1).
     10   TAB-ADR-PRGM (1)               ALL SPACES
     10   TAB-ADR-ID (1)                 ALL SPACES
     10   TAB-ADR-ADR-64 (1)              +00000000000000000000
     10   TAB-ADR-LAST-ADR-64 (1)         +00000000000000000000
01        TAB-ADR (2..8) same as (1)
01        GRP-X.                         <NULL> address
01        GRP-1.
  05      FILLER                         ALL SPACES
  05      FLD-1 (1).
     10   FLD-1-Y (1)                     2020
     10   FLD-1-M (1)                     11
     10   FLD-1-X (1)                    'This is something'
  05      FLD-1 (2..4) same as (1)
  05      FLD-1 (5).
     10   FLD-1-Y (5)                     2020
     10   FLD-1-M (5)                     11
     10   FLD-1-X (5)                    'Something else!'
  05      FLD-1 (6).
     10   FLD-1-Y (6)                     2020
     10   FLD-1-M (6)                     11
     10   FLD-1-X (6)                    'This is something'
  05      FLD-1 (7..10) same as (6)
  05      FILLER                         ALL SPACES
01        GRP-2.
  05      FILLER                         '***'
  05      FLD-2                          'ABCD ABCD ABCD ABCD ABCD ABCD ABCD ABCD AB'
  05      FILLER                         '***'
01        GRP-2A.
  05      FILLER                         ALL SPACES
  05      FLD-2A                         ALL SPACES
  05      FILLER                                                                              @&t@
                                     1 x 20202020 20202020 20202020 20202020 20202020 20202020
                                         --- 25 thru 492 same as above ---
                                                         P  e e k                             @&t@
                                   493 x 20202020 20202050 65656B20 20202020 20202020 20202020
                                                                                              @&t@
                                   517 x 20202020 20202020 20202020 20202020 20202020 20202020
                                         --- 541 thru 878 same as above ---
                                                                                             @&t@
                                   879 x 2020 20202020 20202020 20202020 20202020 202020FE 99
                                          o                                                  @&t@
                                   902 x 6F2020 20202020 20202020 20202020 20202020 20202020 @&t@
                                                                                              @&t@
                                   925 x 20202020 20202020 20202020 20202020 20202020 20202020
                                         --- 949 thru 974 same as above ---
                                                                                             @&t@
                                   975 x 2020 20202020 20202020 20202020 20202020 20202020 20
                                              Y  o u                                         @&t@
                                   998 x 202059 6F752020 20202020 20202020 20202020 20202020 @&t@
                                                                                              @&t@
                                  1021 x 20202020 20202020 20202020 20202020 20202020 20202020
                                         --- 1045 thru 1174 same as above ---
                                                                                             @&t@
                                  1175 x 2020 20202020 20202020 20202020 20202020 20202020 20
                                               @&t@
                                  1198 x 202020
01        GRP-3.
  05      FILLER                         '***'
  05      FLD-3 (1).
       15 FLD-3-2 (1)                    'ABC'
       15 FLD-3-3 (1)                     00
       15 FILLER (1,1).
       25 FLD-3O-1 (1,1)                 'D'
       25 FLD-3O-2 (1,1)                  99
       15 FILLER (1,2..4) same as (1)
       15 FLD-3-4 (1)                    'XX'
  05      FLD-3 (2) same as (1)
  05      FLD-3 (3).
       15 FLD-3-2 (3)                    'ABC'
       15 FLD-3-3 (3)                     00
       15 FILLER (3,1).
       25 FLD-3O-1 (3,1)                 'D'
       25 FLD-3O-2 (3,1)                  99
       15 FILLER (3,2).
       25 FLD-3O-1 (3,2)                 ALL SPACES
       25 FLD-3O-2 (3,2)                  00
       15 FILLER (3,3).
       25 FLD-3O-1 (3,3)                 'D'
       25 FLD-3O-2 (3,3)                  99
       15 FILLER (3,4) same as (3)
       15 FLD-3-4 (3)                    'XX'
  05      FILLER                         '***'
77        C5                              007
01        GRP-5.
  05      FILLER                         '***'
  05      FLD-5.
     10   FLD-5-1 (1).
       15 FLD-5-2 (1)                    'Mon'
       15 FLD-5-3 (1)                     49
       15 FLD-5-4 (1)                    'ey'
     10   FLD-5-1 (2..4) same as (1)
     10   FLD-5-1 (5).
       15 FLD-5-2 (5)                    'Mon'
       15 FLD-5-3 (5)                     49
       15 FLD-5-4 (5)                    '$$'
     10   FLD-5-1 (6).
       15 FLD-5-2 (6)                    'Mon'
       15 FLD-5-3 (6)                     49
       15 FLD-5-4 (6)                    'ey'
     10   FLD-5-1 (7) same as (6)

LINKAGE
**********************
01        A-TABLE.                       <NULL> address

END OF DUMP - prog
**********************

])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
dumpall.txt > dumpall.sed], [0], [], [])
AT_CHECK([test "$COB_HAS_64_BIT_POINTER" = "yes"], [0], [], [],
# Previous test "failed" --> 32 bit
  AT_CHECK([$SED -e 's/0x0000000000000000/0x00000000/' reference_tmpl > reference], [0], [], [])
,
# Previous test "passed" --> 64 bit
  AT_CHECK([cp reference_tmpl reference], [0], [], [])
)
AT_CHECK([$DIFF reference dumpall.sed], [0], [], [])

AT_CLEANUP


AT_SETUP([Test dump feature (3)])
AT_SKIP_IF(true)  # not reproducible everywhere
AT_KEYWORDS([Dump SOURCE_DATE_EPOCH])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE  SECTION.
       01  GOODY.
           05 GOOD-ALLOC      PIC XXX VALUE "088".
           05 GOOD-OCC OCCURS 3 TIMES INDEXED BY GIDX.
             10 GOOD-BUG1   PIC X(10).
             10 GOOD-BUG2   PIC X(6) OCCURS 5 TIMES
                                     INDEXED BY GIDX2, GIDX3.
       01  V-BEFORE              PIC 99 VALUE 4.
       01  BUGGY BASED.
           05 BUGGY-ALLOCATED    PIC XXX VALUE "040".
           05 BUGGY-BUG1         PIC X(16000).
           05 BUGGY-BUG2         PIC X(16000).
       77  V-MID                 PIC X  VALUE '!'.
       77  BUGGY-POINTER         USAGE POINTER.
       01  BADBASE BASED.
           05 BADBASE-ALLOC      PIC XXX VALUE "099".
           05 BADBASE-OCC OCCURS 5 TIMES INDEXED BY BIDX.
             10 BADBASE-BUG1     PIC X(100).
             10 BADBASE-BUG2     PIC X(160).
       77  V-AFTER               PIC X  VALUE '$'.
       PROCEDURE DIVISION.
           DISPLAY "Ready".
           SET GIDX     TO 2.
           MOVE "Where" TO GOOD-BUG1 (GIDX).
           SET GIDX2    TO 3.
           MOVE "is"    TO GOOD-BUG2 (GIDX, GIDX2).
           MOVE "Waldo" TO GOOD-BUG2 (GIDX, GIDX2 + 1).
           SET BUGGY-POINTER TO NULL
           SET BUGGY-POINTER DOWN BY 538976289
           SET BUGGY-POINTER DOWN BY 538976290
           SET ADDRESS OF BUGGY TO BUGGY-POINTER
           SET ADDRESS OF BADBASE TO BUGGY-POINTER
           MOVE V-BEFORE (2:1) TO BUGGY (3:).
           STOP RUN.
])

AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -fdump=ALL prog.cob], [0], [], [])

AT_CHECK([COB_DUMP_FILE=dumpall.txt \
$COBCRUN_DIRECT ./prog], [11], [Ready
], [
prog.cob:37: attempt to reference invalid memory address (signal SIGSEGV)


dump written to dumpall.txt
])

AT_CAPTURE_FILE(./dumpall.txt)

AT_DATA([reference], [
Module dump due to signal SIGSEGV

 Last statement of "prog" was at line 37 of prog.cob
 Started by ./prog

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
   INDEX  GIDX                            +000000002
   INDEX  GIDX2                           +000000003
   INDEX  GIDX3                           +000000001
01        GOODY.
  05      GOOD-ALLOC                     '088'
  05      GOOD-OCC (1).
     10   GOOD-BUG1 (1)                  ALL SPACES
     10   GOOD-BUG2 (1,1)                ALL SPACES
     10   GOOD-BUG2 (1,2..5) same as (1)
  05      GOOD-OCC (2).
     10   GOOD-BUG1 (2)                  'Where'
     10   GOOD-BUG2 (2,1)                ALL SPACES
     10   GOOD-BUG2 (2,2) same as (1)
     10   GOOD-BUG2 (2,3)                'is'
     10   GOOD-BUG2 (2,4)                'Waldo'
     10   GOOD-BUG2 (2,5)                ALL SPACES
  05      GOOD-OCC (3).
     10   GOOD-BUG1 (3)                  ALL SPACES
     10   GOOD-BUG2 (3,1)                ALL SPACES
     10   GOOD-BUG2 (3,2..5) same as (1)
01        V-BEFORE                        04
01        BUGGY.
  05      BUGGY-ALLOCATED
 >>>> Dump of BUGGY aborted! <<<<
**********************
77        V-MID                          '!'
77        BUGGY-POINTER                   0xffffffffbfbfbfbd
   INDEX  BIDX                            +000000001
01        BADBASE.
  05      BADBASE-ALLOC
 >>>> Dump of BADBASE aborted! <<<<
**********************
77        V-AFTER                        '$'

END OF DUMP - prog
**********************

])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
dumpall.txt > dumpall.sed], [0], [], [])
AT_CHECK([$DIFF reference dumpall.sed], [0], [], [])

AT_CLEANUP


AT_SETUP([Test dump feature (4)])
AT_KEYWORDS([Dump SOURCE_DATE_EPOCH])

AT_DATA([cpyabrt], [
            MOVE "Quick brown fox jumped over the dog"
              TO TSTTAILX (1:40).
            MOVE TSP-RECORD TO TSTTAILX (42:20).
      *     DISPLAY ':' X ':'.
      *     DISPLAY CM-COMPANY.
      *     DISPLAY '>' CM-COMPANY '<'.
])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT FLATFILE ASSIGN EXTERNAL RELFIX
           ORGANIZATION RELATIVE
           ACCESS IS SEQUENTIAL RELATIVE KEY IS REC-NUM
           FILE STATUS IS CUST-STAT.

       DATA  DIVISION.
       FILE SECTION.
       FD  FLATFILE
           BLOCK CONTAINS 5 RECORDS.

       01  TSPFL-RECORD.
           10  CM-CUST-NUM                     PICTURE X(8).
           10  CM-COMPANY                      PICTURE X(25).
           10  CM-DISK                         PICTURE X(8).
           10  CM-NO-TERMINALS                 PICTURE 9(4).

       01  XX-RECORD.
           10  XX-CUST-NUM                     PICTURE X(8).
           10  XX-COMPANY                      PICTURE X(25).
           10  XX-DISK                         PICTURE X(8).
           10  XX-NO-TERMINALS                 PICTURE 9(4).

       WORKING-STORAGE SECTION.
       77  MAX-SUB           VALUE  6          PICTURE 9(4) COMP SYNC.
       77  CUST-STAT                           PICTURE X(2).
       77  REC-NUM           VALUE  1          PICTURE 9(4).
       77  UNUSED-VAR        VALUE  1          PICTURE 9(4).
       01  BIN                      PIC 9(9) BINARY VALUE 0.
       01  PACKD                    PIC 9(4)V99 COMP-3 VALUE 757.99.

       01  TEST-DATA.
         02  DATA-CUST-NUM-TBL.
           05  FILLER PIC X(8) VALUE "ALP00000".
           05  FILLER PIC X(8) VALUE "BET00000".
           05  FILLER PIC X(8) VALUE "DEL00000".
           05  FILLER PIC X(8) VALUE "EPS00000".
           05  FILLER PIC X(8) VALUE "FOR00000".
           05  FILLER PIC X(8) VALUE "GAM00000".

         02  DATA-CUST-NUM REDEFINES DATA-CUST-NUM-TBL
                                       PIC X(8) OCCURS 6.
         02  DATA-COMPANY-TBL.
           05  FILLER PIC X(25) VALUE "ALPHA ELECTRICAL CO. LTD.".
           05  FILLER PIC X(25) VALUE "BETA SHOE MFG. INC.      ".
           05  FILLER PIC X(25) VALUE "DELTA LUGGAGE REPAIRS    ".
           05  FILLER PIC X(25) VALUE "EPSILON EQUIPMENT SUPPLY ".
           05  FILLER PIC X(25) VALUE "FORTUNE COOKIE COMPANY   ".
           05  FILLER PIC X(25) VALUE "GAMMA X-RAY TECHNOLOGY   ".
         02  DATA-COMPANY  REDEFINES DATA-COMPANY-TBL
                                       PIC X(25) OCCURS 6.
         02  DATA-ADDRESS-2-TBL.
           05  FILLER PIC X(10) VALUE "ATLANTA   ".
           05  FILLER PIC X(10) VALUE "CALGARY   ".
           05  FILLER PIC X(10) VALUE "NEW YORK  ".
           05  FILLER PIC X(10) VALUE "TORONTO   ".
           05  FILLER PIC X(10) VALUE "WASHINGTON".
           05  FILLER PIC X(10) VALUE "WHITEPLAIN".
         02  DATA-ADDRESS   REDEFINES DATA-ADDRESS-2-TBL
                                       PIC X(10) OCCURS 6
                                       INDEXED BY I-ADDR.

         02  DATA-NO-TERMINALS-TBL.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 13.
           05  FILLER PIC 9(3) COMP-3 VALUE 75.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 90.
           05  FILLER PIC 9(3) COMP-3 VALUE 254.
         02  DATA-NO-TERMINALS REDEFINES DATA-NO-TERMINALS-TBL
                                       PIC 9(3) COMP-3 OCCURS 6.
       01  TSTREC BASED.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.

       01  WORK-AREA IS EXTERNAL.
           05  SUB                             PICTURE 9(4) COMP SYNC.
               88  ODD-RECORD                  VALUE 1 3 5.

       PROCEDURE DIVISION.

           PERFORM LOADFILE.

           OPEN INPUT FLATFILE.
           READ FLATFILE.

       MAIN-100.
           PERFORM CALL-SUB-1.
           PERFORM CALL-SUB-2.
           PERFORM CALL-IT-OMIT.
           STOP RUN.

       LOADFILE.
           OPEN OUTPUT FLATFILE.

           PERFORM LOAD-RECORD
                        VARYING SUB FROM 1 BY 1
                          UNTIL SUB > MAX-SUB.

           CLOSE FLATFILE.

       LISTFILE.
           OPEN INPUT FLATFILE.
           READ FLATFILE.
           CLOSE FLATFILE.

       LOAD-RECORD.

           MOVE SPACES                       TO TSPFL-RECORD.
           MOVE DATA-CUST-NUM      (SUB)     TO CM-CUST-NUM.
           MOVE DATA-COMPANY       (SUB)     TO CM-COMPANY.
           MOVE DATA-NO-TERMINALS  (SUB)     TO CM-NO-TERMINALS.
           IF  ODD-RECORD
               MOVE "8417"                   TO CM-DISK
           ELSE
               MOVE "8470"                   TO CM-DISK.
           WRITE TSPFL-RECORD.

       CALL-SUB-1 SECTION.
           CALL "sub1" USING bin, "Peek a boo!".

       CALL-SUB-2 SECTION.
           CALL "sub2" USING 4096, TSPFL-RECORD.

       CALL-IT-OMIT SECTION.
           CALL "sub2" USING PACKD, OMITTED.

           END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. sub1.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  ZRO PIC 9(9) BINARY VALUE 0.
       01  HEXV PIC X  COMP-X.
       01  HEXC REDEFINES HEXV PIC X.

       01  IDX PIC 9(9) BINARY VALUE 0.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.
         05  TSTTAIL1  PIC 99.
         05  TSTCOMP3  PIC 9(5) COMP-3.
         05  TSTLONG   PIC X(100).
         05  TSTHEX    PIC X(100).
         05  TSTHEX2   PIC X(60).
         05  TSTTAILX  PIC X(80).

       LINKAGE SECTION.
       01  X          PIC 9 ANY NUMERIC.
       01  TSP-RECORD PIC X ANY LENGTH.

       PROCEDURE DIVISION USING X, TSP-RECORD.
       MAIN-1 SECTION.
            MOVE ALL "X" TO TSTREC.
            MOVE 1 TO TSTG-1 (1).
            MOVE 2 TO TSTG-1 (2).
            MOVE 3 TO TSTG-1 (3).
            MOVE 'A' TO TSTX-2 (1,1).
            MOVE 'B' TO TSTX-2 (2,1).
            MOVE 'C' TO TSTX-2 (3,1).
            MOVE 'xx' TO TSTX-2 (1,4).
            MOVE 'yy' TO TSTX-2 (2,4).
            MOVE 'zz' TO TSTX-2 (3,4).
            MOVE SPACES TO TSTX-2 (1,3).
            MOVE HIGH-VALUES TO TSTX (4).
            MOVE LOW-VALUES TO TSTX-2 (2,3).
            MOVE HIGH-VALUES TO TSTX-2 (3,3).
            MOVE "Quick brown fox jumped over the dog"
              TO TSTLONG, TSTLONG (50:36).
            MOVE "Quicker grey fox jumped the cougar"
              TO TSTHEX (1:35).
       MAIN-2.
            MOVE 17 TO HEXV.
            MOVE HEXC TO TSTHEX (39:1).
            MOVE HEXC TO TSTTAIL1 (2:1).
            MOVE 7 TO HEXV.
            MOVE HEXC TO TSTHEX (47:1).
            MOVE 13 TO HEXV.
            MOVE HEXC TO TSTHEX (59:1).
            MOVE 0 TO HEXV.
            MOVE HEXC TO TSTHEX2 (39:1), TSTHEX2 (10:1).
            MOVE 9 TO HEXV.
            MOVE HEXC TO TSTHEX2 (47:1).
            MOVE '\' TO TSTHEX2 (32:1).
            MOVE 13 TO HEXV.
            MOVE HEXC TO TSTHEX2 (59:1).
            MOVE 'A' TO TSTHEX2 (54:1).
            MOVE LOW-VALUES TO TSTTAILX
            ADD 1 TO X.
            IF TSP-RECORD OMITTED
               DISPLAY "sub1: X is " X " RECORD: Omitted."
            ELSE
               DISPLAY "sub1: X is " X " RECORD:" TSP-RECORD "."
            END-IF.
            COPY cpyabrt.
        GOBACK.
       END PROGRAM sub1.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. sub2.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  ZRO PIC 9(9) BINARY VALUE 0.
       01  PTR USAGE POINTER.
       01  HEXV PIC X  COMP-X.
       01  HEXC REDEFINES HEXV PIC X.

       01  IDX PIC 9(9) BINARY VALUE 0.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.
         05  TSTTAIL1  PIC 99.
         05  TSTCOMP3  PIC 9(5) COMP-3.
         05  TSTLONG   PIC X(100).
         05  TSTHEX    PIC X(100).
         05  TSTHEX2   PIC X(60).
         05  TSTTAILX  PIC X(80).

       LINKAGE SECTION.
       01  X          PIC 9 ANY NUMERIC.
       01  TSP-RECORD PIC X ANY LENGTH.

       PROCEDURE DIVISION USING X, TSP-RECORD.
            MOVE ALL "X" TO TSTREC.
            MOVE 1 TO TSTG-1 (1).
            MOVE 2 TO TSTG-1 (2).
            MOVE 3 TO TSTG-1 (3).
            MOVE 'A' TO TSTX-2 (1,1).
            MOVE 'B' TO TSTX-2 (2,1).
            MOVE 'C' TO TSTX-2 (3,1).
            MOVE 'xx' TO TSTX-2 (1,4).
            MOVE 'yy' TO TSTX-2 (2,4).
            MOVE 'zz' TO TSTX-2 (3,4).
            MOVE SPACES TO TSTX-2 (1,3).
            MOVE HIGH-VALUES TO TSTX (4).
            MOVE LOW-VALUES TO TSTX-2 (2,3).
            MOVE HIGH-VALUES TO TSTX-2 (3,3).
            MOVE "Quick brown fox jumped over the dog"
              TO TSTLONG, TSTLONG (50:36).
            MOVE "Quicker grey fox jumped the cougar"
              TO TSTHEX (1:35).
            MOVE 17 TO HEXV.
            MOVE HEXC TO TSTHEX (39:1).
            MOVE HEXC TO TSTTAIL1 (2:1).
            MOVE 7 TO HEXV.
            MOVE HEXC TO TSTHEX (47:1).
            MOVE 13 TO HEXV.
            MOVE HEXC TO TSTHEX (59:1).
            MOVE 0 TO HEXV.
            MOVE HEXC TO TSTHEX2 (39:1), TSTHEX2 (10:1).
            MOVE 9 TO HEXV.  MOVE HEXC TO TSTHEX2 (47:1).
            MOVE '\' TO TSTHEX2 (32:1).
            MOVE 13 TO HEXV.  MOVE HEXC TO TSTHEX2 (59:1).
            MOVE 'A' TO TSTHEX2 (54:1).
            MOVE LOW-VALUES TO TSTTAILX.
            IF TSP-RECORD OMITTED
               DISPLAY "sub2: X is " X " RECORD: Omitted."
               SET PTR TO NULL
               SET PTR UP BY 54545777
               SET ADDRESS OF TSP-RECORD TO PTR
            ELSE
               DISPLAY "sub2: X is " X " RECORD:" TSP-RECORD "."
            END-IF.
            COPY cpyabrt.
       END PROGRAM sub2.
])

AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -debug -fdump=ALL prog.cob], [0], [], [])

AT_CHECK([COB_DUMP_FILE=dumpall.txt \
$COBCRUN_DIRECT ./prog], [11], [sub1: X is 000000001 RECORD:Peek a boo!.
sub2: X is +000004096 RECORD:ALP00000ALPHA ELECTRICAL CO. LTD.8417    0010.
sub2: X is 0757.99 RECORD: Omitted.
], [
cpyabrt:4: attempt to reference invalid memory address (signal SIGSEGV)

libcob: cpyabrt:4: warning: implicit CLOSE of FLATFILE ('RELFIX')

dump written to dumpall.txt
])

AT_CAPTURE_FILE(./dumpall.txt)

AT_DATA([reference], [
Module dump due to signal SIGSEGV

 Last statement of "sub2" was MOVE at line 4 of cpyabrt
	ENTRY sub2 at prog.cob:238
 Last statement of "prog" was CALL
	CALL-IT-OMIT at prog.cob:135
	MAIN-100 at prog.cob:99
	ENTRY prog at prog.cob:91
 Started by ./prog

Dump Program-Id sub2 from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
01        ZRO                             000000000
01        PTR                             0x0000000003404d71
01        HEXV                            013
01        IDX                             000000000
01        TSTREC.
  05      TSTDEP                         'XXX'
  05      TSTX (1).
       15 TSTG-1 (1)                      01
       15 TSTX-2 (1,1)                   'A'
       15 TSTX-2 (1,2)                   'XX'
       15 TSTX-2 (1,3)                   ALL SPACES
       15 TSTX-2 (1,4)                   'xx'
  05      TSTX (2).
       15 TSTG-1 (2)                      02
       15 TSTX-2 (2,1)                   'B'
       15 TSTX-2 (2,2)                   'XX'
       15 TSTX-2 (2,3)                   ALL LOW-VALUES
       15 TSTX-2 (2,4)                   'yy'
  05      TSTX (3).
       15 TSTG-1 (3)                      03
       15 TSTX-2 (3,1)                   'C'
       15 TSTX-2 (3,2)                   'XX'
       15 TSTX-2 (3,3)                   ALL HIGH-VALUES
       15 TSTX-2 (3,4)                   'zz'
  05      TSTX (4).
       15 TSTG-1 (4)                     ALL HIGH-VALUES
       15 TSTX-2 (4,1)                   ALL HIGH-VALUES
       15 TSTX-2 (4,2..4) same as (1)
  05      TSTTAIL1                        X  @&t@
                                     1 x 5811
  05      TSTCOMP3                        58585
  05      TSTLONG                        'Quick brown fox jumped over the dog              Quick br'
                                      57:'own fox jumped over the dog'
  05      TSTHEX                          Q u i c  k e r    g r e y    f o x    j u m  p e d  @&t@
                                     1 x 51756963 6B657220 67726579 20666F78 206A756D 70656420
                                          t h e    c o u g  a r   X  X X   X  X X X X  X X   X
                                    25 x 74686520 636F7567 61722058 58581158 58585858 58580758
                                          X X X X  X X X X  X X   X  X X X X  X X X X  X X X X
                                    49 x 58585858 58585858 58580D58 58585858 58585858 58585858
                                          X X X X  X X X X  X X X X  X X X X  X X X X  X X X X
                                    73 x 58585858 58585858 58585858 58585858 58585858 58585858
                                          X X X X
                                    97 x 58585858
  05      TSTHEX2                        XXXXXXXXX\0XXXXXXXXXXXXXXXXXXXXX\\XXXXXX\0XXXXXXX\tXXXXXX
                                    54 : AXXXX\rX
  05      TSTTAILX                       'Quick brown fox jumped over the dog     '
                                  trailing LOW-VALUES

LINKAGE
**********************
01        X                               0757.99
01        TSP-RECORD                     @&t@
 >>>> Dump of TSP-RECORD aborted! <<<< !!
**********************

END OF DUMP - sub2
**********************

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

FD FLATFILE
**********************
   File is OPEN
   FILE STATUS  '00'
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'ALP00000'
     10   CM-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   CM-DISK                        '8417'
     10   CM-NO-TERMINALS                 0010
     10   XX-CUST-NUM                    'ALP00000'
     10   XX-COMPANY                     'ALPHA ELECTRICAL CO. LTD.'
     10   XX-DISK                        '8417'
     10   XX-NO-TERMINALS                 0010

WORKING-STORAGE
**********************
77        MAX-SUB                         0006
77        CUST-STAT                      ALL ZEROES
77        REC-NUM                         0001
77        UNUSED-VAR                      0001
01        BIN                             000000001
01        PACKD                           0757.99
   INDEX  I-ADDR                          +000000001
01        TEST-DATA.
 02       DATA-CUST-NUM-TBL.
  05      FILLER                         'ALP00000'
  05      FILLER                         'BET00000'
  05      FILLER                         'DEL00000'
  05      FILLER                         'EPS00000'
  05      FILLER                         'FOR00000'
  05      FILLER                         'GAM00000'
 02       DATA-COMPANY-TBL.
  05      FILLER                         'ALPHA ELECTRICAL CO. LTD.'
  05      FILLER                         'BETA SHOE MFG. INC.'
  05      FILLER                         'DELTA LUGGAGE REPAIRS'
  05      FILLER                         'EPSILON EQUIPMENT SUPPLY'
  05      FILLER                         'FORTUNE COOKIE COMPANY'
  05      FILLER                         'GAMMA X-RAY TECHNOLOGY'
 02       DATA-ADDRESS-2-TBL.
  05      FILLER                         'ATLANTA'
  05      FILLER                         'CALGARY'
  05      FILLER                         'NEW YORK'
  05      FILLER                         'TORONTO'
  05      FILLER                         'WASHINGTON'
  05      FILLER                         'WHITEPLAIN'
 02       DATA-NO-TERMINALS-TBL.
  05      FILLER                          010
  05      FILLER                          013
  05      FILLER                          075
  05      FILLER                          010
  05      FILLER                          090
  05      FILLER                          254
01        TSTREC.                        <NULL> address
01        WORK-AREA.
  05      SUB                             0007

END OF DUMP - prog
**********************

])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
dumpall.txt > dumpall.sed], [0], [], [])
AT_CHECK([$DIFF reference dumpall.sed], [0], [], [])

AT_CLEANUP


AT_SETUP([Test dump feature (5)])
AT_KEYWORDS([Dump SOURCE_DATE_EPOCH])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
       DATA  DIVISION.
       FILE SECTION.
       WORKING-STORAGE SECTION.
       77  UNUSED-VAR        VALUE  1          PICTURE 9(4).
       01  BIN                      PIC 9(9) BINARY VALUE 0.
       01  PACKD                    PIC 9(4)V99 COMP-3 VALUE 757.99.

       01  TSPFL-RECORD.
           10  CM-CUST-NUM      PICTURE X(8)  VALUE "RON00001".
           10  CM-COMPANY       PICTURE X(25) VALUE "IBS Canada".
           10  CM-DISK          PICTURE X(8)  VALUE "4TB".
           10  CM-NO-TERMINALS  USAGE FLOAT.

       PROCEDURE DIVISION.

       MAIN-100.
           MOVE 64.7 TO CM-NO-TERMINALS.
            IF CM-NO-TERMINALS = 66
                DISPLAY "What happened!"
            END-IF.
           PERFORM CALL-SUB-1.
           STOP RUN.

       CALL-SUB-1 SECTION.
           CALL "sub1" USING bin, TSPFL-RECORD.

           END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. sub1.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  BAD-PTR      USAGE POINTER.

       LINKAGE SECTION.
       01  X          PIC 9 ANY NUMERIC.
       01  TSP-RECORD.
           10  CM-CUST-NUM                     PICTURE X(8).
           10  CM-COMPANY                      PICTURE X(25).
           10  CM-DISK                         PICTURE X(8).
           10  CM-NO-TERMINALS                 USAGE FLOAT.

       PROCEDURE DIVISION USING X, TSP-RECORD.
       MAIN-1 SECTION.
            PERFORM DMP-TIME.
            IF CM-NO-TERMINALS = 66
                DISPLAY X "Miller time!"
            END-IF.
            GOBACK.
       DMP-TIME1.
            CALL BAD-PTR.
       DMP-TIME.
            PERFORM DMP-TIME1.
       END PROGRAM sub1.
])

AT_CHECK([SOURCE_DATE_EPOCH=1011960000 \
$COMPILE -fdump=ALL prog.cob], [0], [], [])

AT_CHECK([export COB_DUMP_FILE=dumpall.txt
$COBCRUN_DIRECT ./prog], [1], [], [libcob: prog.cob:59: error: module '' not found

dump written to dumpall.txt
])

AT_CAPTURE_FILE(./dumpall.txt)

AT_DATA([reference], [
Module dump due to module '' not found

 Last statement of "sub1" was CALL
	DMP-TIME1 OF MAIN-1 at prog.cob:59
	DMP-TIME OF MAIN-1 at prog.cob:61
	MAIN-1 at prog.cob:53
	ENTRY sub1 at prog.cob:52
 Last statement of "prog" was CALL
	CALL-SUB-1 at prog.cob:33
	MAIN-100 at prog.cob:29
	ENTRY prog at prog.cob:24
 Started by ./prog

Dump Program-Id sub1 from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
01        BAD-PTR                         0x0000000000000000

LINKAGE
**********************
01        X                               000000000
01        TSP-RECORD.
     10   CM-CUST-NUM                    'RON00001'
     10   CM-COMPANY                     'IBS Canada'
     10   CM-DISK                        '4TB'
     10   CM-NO-TERMINALS                 64.699997

END OF DUMP - sub1
**********************

Dump Program-Id prog from prog.cob compiled Jan 25 2002 12:00:00

WORKING-STORAGE
**********************
77        UNUSED-VAR                      0001
01        BIN                             000000000
01        PACKD                           0757.99
01        TSPFL-RECORD.
     10   CM-CUST-NUM                    'RON00001'
     10   CM-COMPANY                     'IBS Canada'
     10   CM-DISK                        '4TB'
     10   CM-NO-TERMINALS                 64.699997

END OF DUMP - prog
**********************

])

AT_CHECK([$SED -e 's/Started by .*prog.exe/Started by .\/prog/g' \
dumpall.txt > dumpall.sed], [0], [], [])
AT_CHECK([$DIFF reference dumpall.sed], [0], [], [])

AT_CLEANUP


AT_SETUP([PROGRAM-ID / CALL with hyphen and underscore])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       PROCEDURE DIVISION.
       MAIN.
           CALL "_SUB-PROG_NOW" USING 'X'.
           STOP RUN.
])

AT_DATA([sub.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. "_SUB-PROG_NOW".

       DATA DIVISION.
       LINKAGE SECTION.
       01  x  PIC X.

       PROCEDURE DIVISION USING x.
       MAIN.
            DISPLAY "SUB GOT " X.
            GOBACK.
])

AT_CHECK([$COMPILE_MODULE sub.cob], [0], [], [])
AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([COB_PRE_LOAD=sub $COBCRUN_DIRECT ./prog], [0],
[SUB GOT X
], [])

AT_CLEANUP


AT_SETUP([CALL with directory])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  MYRTN  PIC X(9) VALUE "DIR/SUB".

       PROCEDURE DIVISION.
      *> doesn't exist there...
           CALL "SUB" USING '0'
              ON EXCEPTION CONTINUE.
      *> go by variable
           CALL MYRTN     USING 'X'.
           CALL "DIR/SUB" USING 'Y'.
      *> as it is already loaded - should work as-is
           CALL "SUB" USING 'Z'.
           CANCEL "SUB"
      *> the following will only show if physical cancel is not off...
           CALL "SUB" USING '0'
              ON EXCEPTION CONTINUE.
           STOP RUN.
])

AT_DATA([sub.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. "SUB".

       DATA DIVISION.
       LINKAGE SECTION.
       01  x  PIC X.

       PROCEDURE DIVISION USING x.
           DISPLAY "SUB GOT " X.
           GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([mkdir DIR], [0], [], [])
AT_CHECK([$COMPILE_MODULE sub.cob -o DIR/SUB.$COB_MODULE_EXT], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[SUB GOT X
SUB GOT Y
SUB GOT Z
SUB GOT 0
], [])
AT_CHECK([COB_PHYSICAL_CANCEL=Y $COBCRUN_DIRECT ./prog], [0],
[SUB GOT X
SUB GOT Y
SUB GOT Z
], [])

AT_CLEANUP


AT_SETUP([C-API (param based)])
AT_KEYWORDS([runmisc CALL api])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  BIN5FLD     PIC  9(5) COMP-5  VALUE  5555.
       01  BINFLD5S    PIC S9(5) BINARY  VALUE  4444.
       01  BINFLD9     PIC  9(9) BINARY  VALUE  6666.
       01  COMP3       PIC  9(8) COMP-3  VALUE  3333.
       01  COMP3V99    PIC S9(7)V99 COMP-3  VALUE  12.50.
       01  PIC9        PIC S9(8) DISPLAY VALUE  8888.
       01  NE          PIC Z(4)9.99-.
       01  CHRX        PIC  X(9)         VALUE 'Hello'.
      *01  CHRN        PIC  N(9)         VALUE N'Hello'.
       01  GRPX.
           05  FILLER  PIC  X(9)         VALUE 'Hello'.
           05  FILLER  PIC  X(9)         VALUE 'World'.
       01  MYOCC        PIC 9(8) COMP.
       01  MYTAB.
           03  MYBYTE   PIC XX OCCURS 1 TO 20
                        DEPENDING ON MYOCC.
       PROCEDURE DIVISION.
           MOVE -512.77 TO NE.
           CALL "CAPI" USING BY CONTENT
                             FUNCTION CONCATENATE("ABC" "DEF").
           CALL "CAPI" USING 2560 BY VALUE 16.
           CALL "CAPI" USING BIN5FLD, NE.
           CALL "CAPI" USING BINFLD5S.
           CALL "CAPI" USING BINFLD9.
           CALL "CAPI" USING BY CONTENT BIN5FLD, NE.
           CALL "CAPI" USING BY CONTENT BIN5FLD, NE.
           CALL "CAPI" USING BY CONTENT BINFLD5S.
           CALL "CAPI" USING BY CONTENT BINFLD5S.
           CALL "CAPI" USING BY CONTENT BINFLD9.
           CALL "CAPI" USING BY CONTENT BINFLD9.
           CALL "CAPI" USING BY VALUE BIN5FLD, NE.
           CALL "CAPI" USING BY VALUE BIN5FLD, NE.
           CALL "CAPI" USING BY VALUE BINFLD5S.
           CALL "CAPI" USING BY VALUE BINFLD5S.
           CALL "CAPI" USING BY VALUE BINFLD9.
           CALL "CAPI" USING BY VALUE BINFLD9.
           MOVE  512.77 TO NE.
           CALL "CAPI" USING COMP3, NE.
           DISPLAY "GRPX     was    " GRPX ";".
           CALL "CAPI" USING PIC9 BINFLD5S CHRX GRPX.
           DISPLAY "GRPX     is now " GRPX ";".
           CALL "CAPI" USING COMP3, NE, CHRX.
           CALL "CAPI" USING BIN5FLD, NE.
           MOVE "Hello!" TO CHRX.
           DISPLAY "BIN5FLD BY VALUE & " CHRX ";".
           CALL "CAPI" USING BY VALUE BIN5FLD, CHRX.
           CALL "CAPI" USING BY VALUE BIN5FLD, CHRX.
           CALL "CAPI" USING LENGTH OF GRPX.
           MOVE "Anyone out there?" TO GRPX.
           DISPLAY "GRPX     was    " GRPX ";".
           CALL "CAPI" USING BY VALUE GRPX LENGTH OF GRPX.
           DISPLAY "GRPX     is now " GRPX ";".
           CALL "CAPI" USING "Fred Fish", COMP3.
           CALL "CAPI" USING COMP3V99.
           CALL "CAPI" .
           DISPLAY "COMP3    is now " COMP3 ";".
           DISPLAY "COMP4    is now " BIN5FLD ";".
           DISPLAY "BINFLD5S is now " BINFLD5S ";".
           DISPLAY "CHRX     is now " CHRX ";".
           DISPLAY "NE       is now " NE ";".
           MOVE 9 TO MYOCC.
           CALL "CAPI" USING BY CONTENT 1.
           CALL "CAPI" USING BY VALUE 1.
           CALL "CAPI" USING BY REFERENCE 1.
           DISPLAY "Now BY CONTENT LENGTH OF MYTAB;".
           CALL "CAPI" USING BY CONTENT LENGTH OF MYTAB.
           DISPLAY "Now BY CONTENT LENGTH OF MYOCC;".
           CALL "CAPI" USING BY CONTENT LENGTH OF MYOCC.
           MOVE 7 TO MYOCC.
           DISPLAY "Now LENGTH OF MYTAB;".
           CALL "CAPI" USING LENGTH OF MYTAB.
           DISPLAY "Now LENGTH OF MYOCC;".
           CALL "CAPI" USING LENGTH OF MYOCC.
           MOVE 5 TO MYOCC.
           DISPLAY "Now BY VALUE LENGTH OF MYTAB;".
           CALL "CAPI" USING BY VALUE LENGTH OF MYTAB.
           DISPLAY "Now BY VALUE LENGTH OF MYOCC;".
           CALL "CAPI" USING BY VALUE LENGTH OF MYOCC.
           STOP RUN.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <string.h>
#include <libcob.h>

static char *
getType (int type, int byvalue)
{
   switch (type) {
#if 0
   case COB_TYPE_GROUP:           return "Group";
   case COB_TYPE_NUMERIC_COMP5:
       /* fall through as the test will have different results
          on big endian systems otherwise
        return "COMP-5"; */
        COB_UNUSED (byvalue);
   case COB_TYPE_NUMERIC_BINARY:  return "BINARY";
   case COB_TYPE_NUMERIC_PACKED:  return "COMP-3";
   case COB_TYPE_NUMERIC_FLOAT:   return "COMP-1";
   case COB_TYPE_NUMERIC_DOUBLE:  return "COMP-2";
   case COB_TYPE_NUMERIC_DISPLAY: return "DISPLAY";
   case COB_TYPE_ALPHANUMERIC:    return "X";
   case COB_TYPE_NUMERIC_EDITED:  return "EDITED";
   case COB_TYPE_NATIONAL:        return "N";
#else
   case COB_TYPE_GROUP:           return "Group";
   case COB_TYPE_NUMERIC_COMP5:
        return byvalue == 2 ? "COMP-4" : "COMP-5";
   case COB_TYPE_NUMERIC_BINARY:  return "COMP-4";
   case COB_TYPE_NUMERIC_PACKED:  return "COMP-3";
   case COB_TYPE_NUMERIC_FLOAT:   return "COMP-1";
   case COB_TYPE_NUMERIC_DOUBLE:  return "COMP-2";
   case COB_TYPE_NUMERIC_DISPLAY: return "DISPLAY";
   case COB_TYPE_ALPHANUMERIC:    return "X";
   case COB_TYPE_NUMERIC_EDITED:  return "EDITED";
   case COB_TYPE_NATIONAL:        return "N";
#endif
   }
   {
      static char wrk[20];
      snprintf (wrk, sizeof(wrk), "Type 0x%04X", type);
      return wrk;
   }
}

COB_EXT_EXPORT int
CAPI (void *p1, ...)
{
   char      wrk[80], pic[30];	/* note: maximum _theoretical_ size */
   const int nargs = cob_get_num_params();
   int       k;
   cob_s64_t val = 0;

   if ((k = cob_get_name_line (wrk, NULL)) > 0) {
      printf("Line%3d: ",k);
   }
   printf ("CALL with %d parameters\n",nargs);
   fflush (stdout);
   for (k=1; k <= nargs; k++) {
      int  type    = cob_get_param_type (k);
      int  digits  = cob_get_param_digits (k);
      int  scale   = cob_get_param_scale (k);
      int  size    = cob_get_param_size (k);
      int  sign    = cob_get_param_sign (k);
      int  byvalue = cob_get_param_constant(k);
      printf ("     P%d: %-8s ", k, getType (type, byvalue));
      if (byvalue == 3) {
         printf("BY CONTENT   ");
      } else if (byvalue == 2) {
         printf ("BY VALUE     ");
      } else if (byvalue == 1) {
         printf ("LITERAL      ");
      } else {
         printf ("BY REFERENCE ");
      }
      if (type == COB_TYPE_ALPHANUMERIC) {
         char     *str = cob_get_picx_param (k, NULL, 0);
         snprintf (pic, sizeof(pic), "X(%d)", size);
         printf ("%-11s '%s'", pic, str);
         cob_free ((void*)str);
         cob_put_picx_param (k, "Bye!");
      } else if (type == COB_TYPE_NATIONAL) {
         snprintf (pic, sizeof(pic), "N(%d)", size); /* FIXME */
         printf ("exchange of national data is not supported yet");
      } else if (type == COB_TYPE_GROUP) {
         char     *str = cob_get_grp_param (k, NULL, 0);
         snprintf (pic, sizeof(pic), "(%d)", size);
         printf ("%-11s '%.*s'", pic, size, str);
         cob_free ((void*)str);
         memset (wrk, ' ',sizeof(wrk));
         memcpy (wrk, "Bye-Bye Birdie!", 15);
         cob_put_grp_param (k, wrk, sizeof(wrk));
         str = cob_get_grp_param (k, NULL, 0);
         printf (" --> '%.*s'",size,str);
         cob_free ((void*)str);
      } else if (type == COB_TYPE_NUMERIC_EDITED) {
         if (scale > 0) {
            snprintf (pic, sizeof(pic), "%s9(%d)V9(%d)",
               sign ? "S":"",
               digits - scale, scale);
         } else {
            snprintf (pic, sizeof(pic), "%s9(%d)",
               sign ? "S":"",
               digits - scale);
         }
         val = cob_get_s64_param (k);
         printf ("%-11s %lld ",pic,val);
         val = val + 130;
         val = -val;
         cob_put_s64_param (k, val);
         cob_get_grp_param (k, wrk, sizeof(wrk));
         printf (" to %.*s",size,wrk);
      } else {
         if(scale > 0) {
            snprintf (pic, sizeof(pic), "%s9(%d)V9(%d)",
               sign ? "S":"",
               digits - scale, scale);
         } else {
            snprintf (pic, sizeof(pic), "%s9(%d)",
               sign ? "S":"",
               digits - scale);
         }
         val = cob_get_s64_param (k);
         printf ("%-11s %lld", pic, val);
         cob_put_s64_param (k, val + 3);
      }
      printf (";\n");
      fflush (stdout);
   }
   if (nargs > 2) {
      cob_put_s64_param (7, val + 3);
   }
   return 0;
}
]])

# externalized instead of static call...
# -fstatic-call is required on Centos 6.8
AT_CHECK([$COMPILE prog.cob -fstatic-call cmod.c], [0], [],
[prog.cob:37: warning: BY CONTENT assumed for alphanumeric item 'NE'
prog.cob:38: warning: BY CONTENT assumed for alphanumeric item 'NE'
prog.cob:52: warning: BY CONTENT assumed for alphanumeric item 'CHRX'
prog.cob:53: warning: BY CONTENT assumed for alphanumeric item 'CHRX'
prog.cob:57: warning: BY CONTENT assumed for alphanumeric item 'GRPX'
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],

[Line 25: CALL with 1 parameters
     P1: X        BY REFERENCE X(6)        'ABCDEF';
Line 27: CALL with 2 parameters
     P1: COMP-4   LITERAL      S9(9)       2560;
     P2: DISPLAY  BY VALUE     9(2)        16;
Line 28: CALL with 2 parameters
     P1: COMP-5   BY REFERENCE 9(5)        5555;
     P2: EDITED   BY REFERENCE S9(5)V9(2)  -51277  to   511.47 ;
Line 29: CALL with 1 parameters
     P1: COMP-4   BY REFERENCE S9(5)       4444;
Line 30: CALL with 1 parameters
     P1: COMP-4   BY REFERENCE 9(9)        6666;
Line 31: CALL with 2 parameters
     P1: COMP-5   BY CONTENT   9(5)        5558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)  51147  to   512.77-;
Line 32: CALL with 2 parameters
     P1: COMP-5   BY CONTENT   9(5)        5558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)  51147  to   512.77-;
Line 33: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   S9(5)       4447;
Line 34: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   S9(5)       4447;
Line 35: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   9(9)        6669;
Line 36: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   9(9)        6669;
Line 37: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        5558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)  51147  to   512.77-;
Line 38: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        5558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)  51147  to   512.77-;
Line 39: CALL with 1 parameters
     P1: COMP-4   BY VALUE     S9(5)       4447;
Line 40: CALL with 1 parameters
     P1: COMP-4   BY VALUE     S9(5)       4447;
Line 41: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        6669;
Line 42: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        6669;
Line 44: CALL with 2 parameters
     P1: COMP-3   BY REFERENCE 9(8)        3333;
     P2: EDITED   BY REFERENCE S9(5)V9(2)  51277  to   514.07-;
GRPX     was    Hello    World    ;
Line 46: CALL with 4 parameters
     P1: DISPLAY  BY REFERENCE S9(8)       8888;
     P2: COMP-4   BY REFERENCE S9(5)       4447;
     P3: X        BY REFERENCE X(9)        'Hello';
     P4: Group    BY REFERENCE (18)        'Hello    World    ' --> 'Bye-Bye Birdie!   ';
GRPX     is now Bye-Bye Birdie!   ;
Line 48: CALL with 3 parameters
     P1: COMP-3   BY REFERENCE 9(8)        3336;
     P2: EDITED   BY REFERENCE S9(5)V9(2)  -51407  to   512.77 ;
     P3: X        BY REFERENCE X(9)        'Bye!';
Line 49: CALL with 2 parameters
     P1: COMP-5   BY REFERENCE 9(5)        5558;
     P2: EDITED   BY REFERENCE S9(5)V9(2)  51277  to   514.07-;
BIN5FLD BY VALUE & Hello!   ;
Line 52: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        5561;
     P2: X        BY CONTENT   X(9)        'Hello!';
Line 53: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        5561;
     P2: X        BY CONTENT   X(9)        'Hello!';
Line 54: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       18;
GRPX     was    Anyone out there? ;
Line 57: CALL with 2 parameters
     P1: Group    BY CONTENT   (18)        'Anyone out there? ' --> 'Bye-Bye Birdie!   ';
     P2: DISPLAY  BY VALUE     9(2)        18;
GRPX     is now Anyone out there? ;
Line 59: CALL with 2 parameters
     P1: X        BY CONTENT   X(9)        'Fred Fish';
     P2: COMP-3   BY REFERENCE 9(8)        3339;
Line 60: CALL with 1 parameters
     P1: COMP-3   BY REFERENCE S9(7)V9(2)  1250;
Line 61: CALL with 0 parameters
COMP3    is now 00003342;
COMP4    is now 0000005561;
BINFLD5S is now +04450;
CHRX     is now Hello!   ;
NE       is now   514.07-;
Line 68: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       1;
Line 69: CALL with 1 parameters
     P1: DISPLAY  BY VALUE     9(1)        1;
Line 70: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       1;
Now BY CONTENT LENGTH OF MYTAB;
Line 72: CALL with 1 parameters
     P1: COMP-4   LITERAL      9(9)        18;
Now BY CONTENT LENGTH OF MYOCC;
Line 74: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       4;
Now LENGTH OF MYTAB;
Line 77: CALL with 1 parameters
     P1: COMP-4   LITERAL      9(9)        14;
Now LENGTH OF MYOCC;
Line 79: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       4;
Now BY VALUE LENGTH OF MYTAB;
Line 82: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        10;
Now BY VALUE LENGTH OF MYOCC;
Line 84: CALL with 1 parameters
     P1: DISPLAY  BY VALUE     9(1)        4;
],
[libcob: prog.cob:27: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '2563'
libcob: prog.cob:27: warning: cob_put_s64_param: attempt to over-write constant parameter 2 with '19'
libcob: prog.cob:46: warning: cob_put_s64_param: parameter 7 is not within range of 4
libcob: prog.cob:48: warning: cob_put_s64_param: parameter 7 is not within range of 3
libcob: prog.cob:54: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '21'
libcob: prog.cob:57: warning: cob_put_s64_param: attempt to over-write constant parameter 2 with '21'
libcob: prog.cob:59: warning: cob_put_picx_param: attempt to over-write constant parameter 1 with 'Bye!'
libcob: prog.cob:68: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '4'
libcob: prog.cob:69: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '4'
libcob: prog.cob:70: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '4'
libcob: prog.cob:72: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '21'
libcob: prog.cob:74: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '7'
libcob: prog.cob:77: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '17'
libcob: prog.cob:79: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '7'
libcob: prog.cob:84: warning: cob_put_s64_param: attempt to over-write constant parameter 1 with '7'
])

AT_CLEANUP


AT_SETUP([C-API (field based)])
AT_KEYWORDS([runmisc CALL api field])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  BIN5FLD     PIC  9(5) COMP-5  VALUE  5555.
       01  BINFLD5S    PIC S9(5) BINARY  VALUE  4444.
       01  BINFLD9     PIC  9(9) BINARY  VALUE  6666.
       01  COMP3       PIC  9(8) COMP-3  VALUE  3333.
       01  COMP3V99    PIC S9(7)V99 COMP-3  VALUE  12.50.
       01  PIC9        PIC S9(8) DISPLAY VALUE  8888.
       01  NE          PIC Z(4)9.99-.
       01  CHRX        PIC  X(9)         VALUE 'Hello'.
      *01  CHRN        PIC  N(9)         VALUE N'Hello'.
       01  GRPX.
           05  FILLER  PIC  X(9)         VALUE 'Hello'.
           05  FILLER  PIC  X(9)         VALUE 'World'.
       01  MYOCC        PIC 9(8) COMP.
       01  MYTAB.
           03  MYBYTE   PIC XX OCCURS 1 TO 20
                        DEPENDING ON MYOCC.
       PROCEDURE DIVISION.
           MOVE -512.77 TO NE.
           CALL "CAPI" USING BY CONTENT
                             FUNCTION CONCATENATE("ABC" "DEF").
           CALL "CAPI" USING 2560 BY VALUE 16.
           CALL "CAPI" USING BIN5FLD, NE.
           CALL "CAPI" USING BINFLD5S.
           CALL "CAPI" USING BINFLD9.
           CALL "CAPI" USING BY CONTENT BIN5FLD, NE.
           CALL "CAPI" USING BY CONTENT BIN5FLD, NE.
           CALL "CAPI" USING BY CONTENT BINFLD5S.
           CALL "CAPI" USING BY CONTENT BINFLD5S.
           CALL "CAPI" USING BY CONTENT BINFLD9.
           CALL "CAPI" USING BY CONTENT BINFLD9.
           CALL "CAPI" USING BY VALUE BIN5FLD, NE.
           CALL "CAPI" USING BY VALUE BIN5FLD, NE.
           CALL "CAPI" USING BY VALUE BINFLD5S.
           CALL "CAPI" USING BY VALUE BINFLD5S.
           CALL "CAPI" USING BY VALUE BINFLD9.
           CALL "CAPI" USING BY VALUE BINFLD9.
           MOVE  512.77 TO NE.
           CALL "CAPI" USING COMP3, NE.
           DISPLAY "GRPX     was    " GRPX ";".
           CALL "CAPI" USING PIC9 BINFLD5S CHRX GRPX.
           DISPLAY "GRPX     is now " GRPX ";".
           CALL "CAPI" USING COMP3, NE, CHRX.
           CALL "CAPI" USING BIN5FLD, NE.
           MOVE "Hello!" TO CHRX.
           DISPLAY "BIN5FLD BY VALUE & " CHRX ";".
           CALL "CAPI" USING BY VALUE BIN5FLD, CHRX.
           CALL "CAPI" USING BY VALUE BIN5FLD, CHRX.
           CALL "CAPI" USING LENGTH OF GRPX.
           MOVE "Anyone out there?" TO GRPX.
           DISPLAY "GRPX     was    " GRPX ";".
           CALL "CAPI" USING BY VALUE GRPX LENGTH OF GRPX.
           DISPLAY "GRPX     is now " GRPX ";".
           CALL "CAPI" USING "Fred Fish", COMP3.
           CALL "CAPI" USING COMP3V99.
           CALL "CAPI" .
           DISPLAY "COMP3    is now " COMP3 ";".
           DISPLAY "COMP4    is now " BIN5FLD ";".
           DISPLAY "BINFLD5S is now " BINFLD5S ";".
           DISPLAY "CHRX     is now " CHRX ";".
           DISPLAY "NE       is now " NE ";".
           MOVE 9 TO MYOCC.
           CALL "CAPI" USING BY CONTENT 1.
           CALL "CAPI" USING BY VALUE 1.
           CALL "CAPI" USING BY REFERENCE 1.
           DISPLAY "Now BY CONTENT LENGTH OF MYTAB;".
           CALL "CAPI" USING BY CONTENT LENGTH OF MYTAB.
           DISPLAY "Now BY CONTENT LENGTH OF MYOCC;".
           CALL "CAPI" USING BY CONTENT LENGTH OF MYOCC.
           MOVE 7 TO MYOCC.
           DISPLAY "Now LENGTH OF MYTAB;".
           CALL "CAPI" USING LENGTH OF MYTAB.
           DISPLAY "Now LENGTH OF MYOCC;".
           CALL "CAPI" USING LENGTH OF MYOCC.
           MOVE 5 TO MYOCC.
           DISPLAY "Now BY VALUE LENGTH OF MYTAB;".
           CALL "CAPI" USING BY VALUE LENGTH OF MYTAB.
           DISPLAY "Now BY VALUE LENGTH OF MYOCC;".
           CALL "CAPI" USING BY VALUE LENGTH OF MYOCC.
           STOP RUN.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <string.h>
#include <libcob.h>

static char *
getType (int type, int byvalue)
{
   switch (type) {
#if 0
   case COB_TYPE_GROUP:           return "Group";
   case COB_TYPE_NUMERIC_COMP5:
       /* fall through as the test will have different results
          on big endian systems otherwise
        return "COMP-5"; */
   case COB_TYPE_NUMERIC_BINARY:  return "BINARY";
   case COB_TYPE_NUMERIC_PACKED:  return "COMP-3";
   case COB_TYPE_NUMERIC_FLOAT:   return "COMP-1";
   case COB_TYPE_NUMERIC_DOUBLE:  return "COMP-2";
   case COB_TYPE_NUMERIC_DISPLAY: return "DISPLAY";
   case COB_TYPE_ALPHANUMERIC:    return "X";
   case COB_TYPE_NUMERIC_EDITED:  return "EDITED";
   case COB_TYPE_NATIONAL:        return "N";
#else
   case COB_TYPE_GROUP:           return "Group";
   case COB_TYPE_NUMERIC_COMP5:
        return byvalue == 2 ? "COMP-4" : "COMP-5";
   case COB_TYPE_NUMERIC_BINARY:  return "COMP-4";
   case COB_TYPE_NUMERIC_PACKED:  return "COMP-3";
   case COB_TYPE_NUMERIC_FLOAT:   return "COMP-1";
   case COB_TYPE_NUMERIC_DOUBLE:  return "COMP-2";
   case COB_TYPE_NUMERIC_DISPLAY: return "DISPLAY";
   case COB_TYPE_ALPHANUMERIC:    return "X";
   case COB_TYPE_NUMERIC_EDITED:  return "EDITED";
   case COB_TYPE_NATIONAL:        return "N";
#endif
   }
   {
      static char wrk[20];
      snprintf (wrk, sizeof(wrk), "Type 0x%04X", type);
      return wrk;
   }
}

COB_EXT_EXPORT int
CAPI (void *p1, ...)
{
   char      wrk[80],pic[30];	/* note: maximum _theoretical_ size */
   const int nargs = cob_get_num_params();
   int       k;

   if ((k = cob_get_name_line (wrk, NULL)) > 0) {
      printf("Line%3d: ",k);
   }
   printf ("CALL with %d parameters\n",nargs);
   fflush (stdout);
   for (k=1; k <= nargs; k++) {
      cob_field *fld = cob_get_param_field (k, "CAPI");
      char *str    = (char *) cob_get_field_str_buffered (fld);
      int  type    = cob_get_field_type (fld);
      int  digits  = cob_get_field_digits (fld);
      int  scale   = cob_get_field_scale (fld);
      int  size    = cob_get_field_size (fld);
      int  sign    = cob_get_field_sign (fld);
      int  byvalue = cob_get_field_constant (fld);
      printf ("     P%d: %-8s ",k,getType (type, byvalue));
      if (byvalue == 3) {
         printf("BY CONTENT   ");
      } else if (byvalue == 2) {
         printf ("BY VALUE     ");
      } else if (byvalue == 1) {
         printf ("LITERAL      ");
      } else {
         printf ("BY REFERENCE ");
      }
      if (type == COB_TYPE_ALPHANUMERIC) {
         snprintf (pic, sizeof(pic),  "X(%d)", size);
         printf ("%-11s '%s'", pic, str);
         cob_put_field_str (fld, "Bye!");
      } else if (type == COB_TYPE_NATIONAL) {
         snprintf (pic, sizeof(pic), "N(%d)", size); /* FIXME */
         printf ("exchange of national data is not supported yet");
      } else if (type == COB_TYPE_GROUP) {
         snprintf (pic, sizeof(pic), "(%d)",size);
         printf ("%-11s '%.*s'",pic,size,str);
         cob_put_field_str (fld, "Bye-Bye Birdie!");
         str = (char *) cob_get_field_str_buffered (fld);
         printf (" --> '%.*s'",size,str);
      } else if (type == COB_TYPE_NUMERIC_EDITED) {
         cob_s64_t   val = cob_get_s64_param (k);
         if (scale > 0) {
            snprintf (pic, sizeof(pic), "%s9(%d)V9(%d)",
               sign ? "S":"",
               digits - scale, scale);
         } else {
            snprintf (pic, sizeof(pic), "%s9(%d)",
               sign ? "S":"",
               digits - scale);
         }
         printf ("%-11s %s ",pic,str);
         val = val + 130;
         val = -val;
         cob_put_s64_param (k, val);
         str = (char *) cob_get_field_str (fld, wrk, 78);
         printf (" to %.*s",size,wrk);
      } else {
         cob_s64_t   val = cob_get_s64_param (k);
         if (scale > 0) {
            snprintf (pic, sizeof(pic), "%s9(%d)V9(%d)",
               sign ? "S":"",
               digits - scale, scale);
         } else {
            snprintf (pic, sizeof(pic), "%s9(%d)",
               sign ? "S":"",
               digits - scale);
         }
#if 1
         printf ("%-11s %s", pic, str);
#else
         /* note: the test as is needs leading zero suppression to work... */
         printf ("%-11s %lld", pic, val);
#endif
         snprintf (wrk, sizeof(wrk),  "%lld", val + 3);
         cob_put_field_str (fld, wrk);
      }
      printf (";\n");
      fflush (stdout);
   }
   return 0;
}
]])

# externalized instead of static call...
# -fstatic-call is required on Centos 6.8
AT_CHECK([$COMPILE prog.cob -fstatic-call cmod.c], [0], [],
[prog.cob:37: warning: BY CONTENT assumed for alphanumeric item 'NE'
prog.cob:38: warning: BY CONTENT assumed for alphanumeric item 'NE'
prog.cob:52: warning: BY CONTENT assumed for alphanumeric item 'CHRX'
prog.cob:53: warning: BY CONTENT assumed for alphanumeric item 'CHRX'
prog.cob:57: warning: BY CONTENT assumed for alphanumeric item 'GRPX'
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],

[Line 25: CALL with 1 parameters
     P1: X        BY REFERENCE X(6)        'ABCDEF';
Line 27: CALL with 2 parameters
     P1: COMP-4   LITERAL      S9(9)       +000002560;
     P2: DISPLAY  BY VALUE     9(2)        16;
Line 28: CALL with 2 parameters
     P1: COMP-5   BY REFERENCE 9(5)        0000005555;
     P2: EDITED   BY REFERENCE S9(5)V9(2)    512.77-  to   511.47 ;
Line 29: CALL with 1 parameters
     P1: COMP-4   BY REFERENCE S9(5)       +04444;
Line 30: CALL with 1 parameters
     P1: COMP-4   BY REFERENCE 9(9)        000006666;
Line 31: CALL with 2 parameters
     P1: COMP-5   BY CONTENT   9(5)        0000005558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)    511.47   to   512.77-;
Line 32: CALL with 2 parameters
     P1: COMP-5   BY CONTENT   9(5)        0000005558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)    511.47   to   512.77-;
Line 33: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   S9(5)       +04447;
Line 34: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   S9(5)       +04447;
Line 35: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   9(9)        000006669;
Line 36: CALL with 1 parameters
     P1: COMP-4   BY CONTENT   9(9)        000006669;
Line 37: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        0000005558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)    511.47   to   512.77-;
Line 38: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        0000005558;
     P2: EDITED   BY CONTENT   S9(5)V9(2)    511.47   to   512.77-;
Line 39: CALL with 1 parameters
     P1: COMP-4   BY VALUE     S9(5)       +04447;
Line 40: CALL with 1 parameters
     P1: COMP-4   BY VALUE     S9(5)       +04447;
Line 41: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        000006669;
Line 42: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        000006669;
Line 44: CALL with 2 parameters
     P1: COMP-3   BY REFERENCE 9(8)        00003333;
     P2: EDITED   BY REFERENCE S9(5)V9(2)    512.77   to   514.07-;
GRPX     was    Hello    World    ;
Line 46: CALL with 4 parameters
     P1: DISPLAY  BY REFERENCE S9(8)       +00008888;
     P2: COMP-4   BY REFERENCE S9(5)       +04447;
     P3: X        BY REFERENCE X(9)        'Hello    ';
     P4: Group    BY REFERENCE (18)        'Hello    World    ' --> 'Bye-Bye Birdie!   ';
GRPX     is now Bye-Bye Birdie!   ;
Line 48: CALL with 3 parameters
     P1: COMP-3   BY REFERENCE 9(8)        00003336;
     P2: EDITED   BY REFERENCE S9(5)V9(2)    514.07-  to   512.77 ;
     P3: X        BY REFERENCE X(9)        'Bye!     ';
Line 49: CALL with 2 parameters
     P1: COMP-5   BY REFERENCE 9(5)        0000005558;
     P2: EDITED   BY REFERENCE S9(5)V9(2)    512.77   to   514.07-;
BIN5FLD BY VALUE & Hello!   ;
Line 52: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        0000005561;
     P2: X        BY CONTENT   X(9)        'Hello!   ';
Line 53: CALL with 2 parameters
     P1: COMP-4   BY VALUE     9(5)        0000005561;
     P2: X        BY CONTENT   X(9)        'Hello!   ';
Line 54: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       +000000018;
GRPX     was    Anyone out there? ;
Line 57: CALL with 2 parameters
     P1: Group    BY CONTENT   (18)        'Anyone out there? ' --> 'Bye-Bye Birdie!   ';
     P2: DISPLAY  BY VALUE     9(2)        18;
GRPX     is now Anyone out there? ;
Line 59: CALL with 2 parameters
     P1: X        BY CONTENT   X(9)        'Fred Fish';
     P2: COMP-3   BY REFERENCE 9(8)        00003339;
Line 60: CALL with 1 parameters
     P1: COMP-3   BY REFERENCE S9(7)V9(2)  +0000012.50;
Line 61: CALL with 0 parameters
COMP3    is now 00003342;
COMP4    is now 0000005561;
BINFLD5S is now +04450;
CHRX     is now Hello!   ;
NE       is now   514.07-;
Line 68: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       +000000001;
Line 69: CALL with 1 parameters
     P1: DISPLAY  BY VALUE     9(1)        1;
Line 70: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       +000000001;
Now BY CONTENT LENGTH OF MYTAB;
Line 72: CALL with 1 parameters
     P1: COMP-4   LITERAL      9(9)        000000018;
Now BY CONTENT LENGTH OF MYOCC;
Line 74: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       +000000004;
Now LENGTH OF MYTAB;
Line 77: CALL with 1 parameters
     P1: COMP-4   LITERAL      9(9)        000000014;
Now LENGTH OF MYOCC;
Line 79: CALL with 1 parameters
     P1: COMP-4   LITERAL      S9(9)       +000000004;
Now BY VALUE LENGTH OF MYTAB;
Line 82: CALL with 1 parameters
     P1: COMP-4   BY VALUE     9(9)        000000010;
Now BY VALUE LENGTH OF MYOCC;
Line 84: CALL with 1 parameters
     P1: DISPLAY  BY VALUE     9(1)        4;
],
[libcob: prog.cob:27: warning: cob_put_field_str: attempt to over-write constant field with '2563'
libcob: prog.cob:27: warning: cob_put_field_str: attempt to over-write constant field with '19'
libcob: prog.cob:54: warning: cob_put_field_str: attempt to over-write constant field with '21'
libcob: prog.cob:57: warning: cob_put_field_str: attempt to over-write constant field with '21'
libcob: prog.cob:59: warning: cob_put_field_str: attempt to over-write constant field with 'Bye!'
libcob: prog.cob:68: warning: cob_put_field_str: attempt to over-write constant field with '4'
libcob: prog.cob:69: warning: cob_put_field_str: attempt to over-write constant field with '4'
libcob: prog.cob:70: warning: cob_put_field_str: attempt to over-write constant field with '4'
libcob: prog.cob:72: warning: cob_put_field_str: attempt to over-write constant field with '21'
libcob: prog.cob:74: warning: cob_put_field_str: attempt to over-write constant field with '7'
libcob: prog.cob:77: warning: cob_put_field_str: attempt to over-write constant field with '17'
libcob: prog.cob:79: warning: cob_put_field_str: attempt to over-write constant field with '7'
libcob: prog.cob:84: warning: cob_put_field_str: attempt to over-write constant field with '7'
])

AT_CLEANUP


# FIXME: better name
AT_SETUP([C-API (3)])
AT_KEYWORDS([CALL api])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT FLATFILE ASSIGN EXTERNAL RELFIX
           ORGANIZATION RELATIVE
           ACCESS IS SEQUENTIAL RELATIVE KEY IS REC-NUM
           FILE STATUS IS CUST-STAT.

       DATA  DIVISION.
       FILE SECTION.
       FD  FLATFILE
           BLOCK CONTAINS 5 RECORDS.

       01  TSPFL-RECORD.
           10  CM-CUST-NUM                     PICTURE X(8).
           10  CM-COMPANY                      PICTURE X(25).
           10  CM-DISK                         PICTURE X(8).
           10  CM-NO-TERMINALS                 PICTURE 9(4).

       01  XX-RECORD.
           10  XX-CUST-NUM                     PICTURE X(8).
           10  XX-COMPANY                      PICTURE X(25).
           10  XX-DISK                         PICTURE X(8).
           10  XX-NO-TERMINALS                 PICTURE 9(4).

       WORKING-STORAGE SECTION.
       77  MAX-SUB           VALUE  6  PICTURE 9(4) COMP.
       77  CUST-STAT                   PICTURE X(2).
       77  REC-NUM                     PICTURE 9(4) VALUE 1.
       77  UNUSED-VAR                  PICTURE 9(4) COMP-3 VALUE 7.
       01  BIN-FLD                     PIC 9(9) BINARY VALUE 0.

       01  TEST-DATA.
         02  DATA-CUST-NUM-TBL.
           05  FILLER PIC X(8) VALUE "ALP00000".
           05  FILLER PIC X(8) VALUE "BET00000".
           05  FILLER PIC X(8) VALUE "DEL00000".
           05  FILLER PIC X(8) VALUE "EPS00000".
           05  FILLER PIC X(8) VALUE "FOR00000".
           05  FILLER PIC X(8) VALUE "GAM00000".

         02  DATA-CUST-NUM REDEFINES DATA-CUST-NUM-TBL
                                       PIC X(8) OCCURS 6.
         02  DATA-COMPANY-TBL.
           05  FILLER PIC X(25) VALUE "ALPHA ELECTRICAL CO. LTD.".
           05  FILLER PIC X(25) VALUE "BETA SHOE MFG. INC.      ".
           05  FILLER PIC X(25) VALUE "DELTA LUGGAGE REPAIRS    ".
           05  FILLER PIC X(25) VALUE "EPSILON EQUIPMENT SUPPLY ".
           05  FILLER PIC X(25) VALUE "FORTUNE COOKIE COMPANY   ".
           05  FILLER PIC X(25) VALUE "GAMMA X-RAY TECHNOLOGY   ".
         02  DATA-COMPANY  REDEFINES DATA-COMPANY-TBL
                                       PIC X(25) OCCURS 6.
         02  DATA-ADDRESS-2-TBL.
           05  FILLER PIC X(15) VALUE "ATLANTA   ".
           05  FILLER PIC X(15) VALUE "CALGARY   ".
           05  FILLER PIC X(15) VALUE "NEW YORK  ".
           05  FILLER PIC X(15) VALUE "TORONTO   ".
           05  FILLER PIC X(15) VALUE "WASHINGTON".
           05  FILLER PIC X(15) VALUE "WHITEPLAIN".
         02  DATA-ADDRESS   REDEFINES DATA-ADDRESS-2-TBL
                                       PIC X(15) OCCURS 6
                                       INDEXED BY I-ADDR.

         02  DATA-NO-TERMINALS-TBL.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 13.
           05  FILLER PIC 9(3) COMP-3 VALUE 75.
           05  FILLER PIC 9(3) COMP-3 VALUE 10.
           05  FILLER PIC 9(3) COMP-3 VALUE 90.
           05  FILLER PIC 9(3) COMP-3 VALUE 254.
         02  DATA-NO-TERMINALS REDEFINES DATA-NO-TERMINALS-TBL
                                       PIC 9(3) COMP-3 OCCURS 6.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTWHO REDEFINES TSTDEP PIC XXX.
         05  TSTDEP2.
           10  TSTHOW   PIC XX.
         05  TSTDEP3.
           10  TSTHOW   PIC XX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.

       01  WORK-AREA IS EXTERNAL.
           05  SUB                             PICTURE 9(4) COMP.
               88  ODD-RECORD                  VALUE 1 3 5.

       PROCEDURE DIVISION.

           MOVE ALL "X" TO TSTREC.
           MOVE 1 TO TSTG-1 (1).
           MOVE 2 TO TSTG-1 (2).
           MOVE 3 TO TSTG-1 (3).
           MOVE 'YY' TO TSTHOW OF TSTDEP3.
           MOVE 'ZZ' TO TSTHOW OF TSTDEP3.
           PERFORM LOADFILE.

           OPEN INPUT FLATFILE.
           READ FLATFILE.

       MAIN-100.
           MOVE 5 TO SUB.
           CALL  "CSYMDMP".
           CALL  "tstsub" USING UNUSED-VAR TSPFL-RECORD.
           DISPLAY "Try again".
           MOVE 3 TO SUB.
           CALL  "tstsub" USING REC-NUM "How did I get here?".
           ADD  5 TO BIN-FLD.
           CALL  "CSYMDMP".
           DISPLAY "Ending now".
           CLOSE FLATFILE.
           STOP RUN.

       LOADFILE.
           OPEN OUTPUT FLATFILE.

           PERFORM LOAD-RECORD
                        VARYING SUB FROM 1 BY 1
                          UNTIL SUB > MAX-SUB.

           CLOSE FLATFILE.

       LISTFILE.
           OPEN INPUT FLATFILE.
           READ FLATFILE.
           CLOSE FLATFILE.

       LOAD-RECORD.

           MOVE SPACES                       TO TSPFL-RECORD.
           MOVE DATA-CUST-NUM      (SUB)     TO CM-CUST-NUM.
           MOVE DATA-COMPANY       (SUB)     TO CM-COMPANY.
           MOVE DATA-NO-TERMINALS  (SUB)     TO CM-NO-TERMINALS.
           IF  ODD-RECORD
               MOVE "8417"                   TO CM-DISK
           ELSE
               MOVE "8470"                   TO CM-DISK.
           WRITE TSPFL-RECORD.

           END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. tstsub.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77  UNUSED-VAR            PICTURE 9(4)V99 COMP-4 VALUE 7.59.
       01  TSTREC.
         05  TSTDEP  PIC XXX.
         05  TSTX OCCURS 4 TIMES.
           15  TSTG-1 PIC 99.
           15  TSTX-2 PIC XX OCCURS 4 TIMES.
         05  TSTTAILX  PIC X(8).

       01  WORK-AREA IS EXTERNAL.
           05  SUB                             PICTURE 9(4) COMP.
               88  ODD-RECORD                  VALUE 1 3 5.
       LINKAGE SECTION.
       01  X          PIC 9 ANY NUMERIC.
       01  THE-RECORD PIC X ANY LENGTH.

       PROCEDURE DIVISION USING X, THE-RECORD.
           MOVE ALL "Z" TO TSTREC.
           MOVE 7 TO TSTG-1 (1).
           MOVE 8 TO TSTG-1 (2).
           MOVE 9 TO TSTG-1 (3).
           MOVE 'A' TO TSTX-2 (1,1).
           MOVE 'B' TO TSTX-2 (2,1).
           MOVE 'C' TO TSTX-2 (3,1).
           MOVE 'xx' TO TSTX-2 (1,4).
           MOVE 'yy' TO TSTX-2 (2,4).
           MOVE 'zz' TO TSTX-2 (3,4).
           DISPLAY "In the subroutine now".
           DISPLAY "THE-RECORD: '" THE-RECORD "'".
           CALL  "CSYMDMP" USING THE-RECORD.
           DISPLAY "THE-RECORD: '" THE-RECORD "'".
           DISPLAY TSTREC.
           DISPLAY X.
           DISPLAY "Back to main".
           EXIT PROGRAM.
       END PROGRAM tstsub.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <string.h>
#include <libcob.h>

static int doWatch = 1;
int
CSYMDMP ()
{
   int      nargs,sts;
   char     modname[32],fld[128],buf[2048],*exp, *mod;

   nargs = cob_get_num_params();
   if (nargs < 1)
      mod = "prog";
   else
      mod = NULL;
   printf("CSYMDMP with %d parameters\n",nargs);
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="MAX-SUB", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="SUB", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="UNUSED-VAR", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   if (memcmp(buf,"0099",4) != 0) {
      strcpy(buf,"0099");
      sts = cob_put_field_value (mod, exp, sizeof(buf), buf);
   }
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="DATA-COMPANY (SUB)", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   memset(buf,0,sizeof(buf));
   if (sts == 0) {
      sts = cob_get_field_value (mod, exp="DATA-ADDRESS (SUB) (5:)", sizeof(buf), buf);
      printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
      memset(buf,0,sizeof(buf));
      sts = cob_get_field_value (mod, exp="DATA-ADDRESS (4)", sizeof(buf), buf);
      printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
      if (memcmp(buf,"Frankfurt",9) != 0) {
        strcpy(buf,"Frankfurt");
        sts = cob_put_field_value (mod, exp, sizeof(buf), buf);
      }
      memset(buf,0,sizeof(buf));
      sts = cob_get_field_value (mod, exp="TSTHOW OF TSTDEP2", sizeof(buf), buf);
      printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
      memset(buf,0,sizeof(buf));
      sts = cob_get_field_value (mod, exp="TSTHOW OF TSTDEP3 (2:5)", sizeof(buf), buf);
      printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
      memset(buf,0,sizeof(buf));
   }
   sts = cob_get_field_value (mod, exp="TSTG-1 (2)", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="TSTX-2 (2,3)", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   if (memcmp(buf,"ME",2) != 0) {
      strcpy(buf,"ME");
      sts = cob_put_field_value (mod, exp, sizeof(buf), buf);
   }
   memset(buf,0,sizeof(buf));
   sts = cob_get_field_value (mod, exp="THE-RECORD", sizeof(buf), buf);
   printf(" %30s is %s%s.\n",exp,sts?"Error: ":"",buf);
   memset(buf,0,sizeof(buf));
   if (doWatch) {
      cob_watch_field_value (mod, exp="BIN-FLD");
      doWatch = 0;
      sts = cob_get_field_value (mod, exp, sizeof(buf), buf);
      printf(" %30s is %s%s. Being watched\n",exp,sts?"Error: ":"",buf);
   }
   if (cob_watch_check (modname, fld)) {
      sts = cob_get_field_value (modname, fld, sizeof(buf), buf);
      printf(" %30s is %s%s. Was changed\n",fld,sts?"Error: ":"",buf);
   }
   return 0;
}
]])

AT_CHECK([$COMPILE -x -std=mf -debug -Wall -debug prog.cob cmod.c], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [CSYMDMP with 0 parameters
                        MAX-SUB is 0006.
                            SUB is 0005.
                     UNUSED-VAR is 0007.
             DATA-COMPANY (SUB) is FORTUNE COOKIE COMPANY   .
        DATA-ADDRESS (SUB) (5:) is INGTON     .
               DATA-ADDRESS (4) is TORONTO        .
              TSTHOW OF TSTDEP2 is XX.
        TSTHOW OF TSTDEP3 (2:5) is Z01XX.
                     TSTG-1 (2) is 02.
                   TSTX-2 (2,3) is XX.
                     THE-RECORD is Error: THE-RECORD is undefined.
                        BIN-FLD is 000000000. Being watched
In the subroutine now
THE-RECORD: 'ALP00000ALPHA ELECTRICAL CO. LTD.8417    0010'
CSYMDMP with 1 parameters
                        MAX-SUB is Error: MAX-SUB is undefined.
                            SUB is 0005.
                     UNUSED-VAR is 0007.59.
             DATA-COMPANY (SUB) is Error: DATA-COMPANY (SUB) is undefined.
                     TSTG-1 (2) is 08.
                   TSTX-2 (2,3) is ZZ.
                     THE-RECORD is ALP00000ALPHA ELECTRICAL CO. LTD.8417    0010.
THE-RECORD: 'ALP00000ALPHA ELECTRICAL CO. LTD.8417    0010'
ZZZ07A ZZZZxx08B ZZMEyy09C ZZZZzzZZZZZZZZZZZZZZZZZZ
0099
Back to main
Try again
In the subroutine now
THE-RECORD: 'How did I get here?'
CSYMDMP with 1 parameters
                        MAX-SUB is Error: MAX-SUB is undefined.
                            SUB is 0003.
                     UNUSED-VAR is 0099.00.
             DATA-COMPANY (SUB) is Error: DATA-COMPANY (SUB) is undefined.
                     TSTG-1 (2) is 08.
                   TSTX-2 (2,3) is ZZ.
                     THE-RECORD is How did I get here?.
THE-RECORD: 'How did I get here?'
ZZZ07A ZZZZxx08B ZZMEyy09C ZZZZzzZZZZZZZZZZZZZZZZZZ
0001
Back to main
CSYMDMP with 0 parameters
                        MAX-SUB is 0006.
                            SUB is 0003.
                     UNUSED-VAR is 0099.
             DATA-COMPANY (SUB) is DELTA LUGGAGE REPAIRS    .
        DATA-ADDRESS (SUB) (5:) is YORK       .
               DATA-ADDRESS (4) is Frankfurt      .
              TSTHOW OF TSTDEP2 is XX.
        TSTHOW OF TSTDEP3 (2:5) is Z01XX.
                     TSTG-1 (2) is 02.
                   TSTX-2 (2,3) is ME.
                     THE-RECORD is Error: THE-RECORD is undefined.
                        BIN-FLD is 000000005. Was changed
Ending now
], [])

AT_CLEANUP


AT_SETUP([C API Test JUST])
AT_KEYWORDS([CALL])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  CHRX        PIC  X(10) JUST RIGHT VALUE 'Hello'.

       PROCEDURE DIVISION.
           DISPLAY "Initial: '" CHRX "'".
           CALL "CAPI" USING CHRX.
           DISPLAY "  After: '" CHRX "'".
           STOP RUN.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <string.h>
#include <libcob.h>

static char *
getType(int type, int byvalue)
{
   static char wrk[24];
   switch (type) {
   case COB_TYPE_GROUP:    return "Group";
   case COB_TYPE_NUMERIC_COMP5:  return byvalue==2?"COMP-4":"COMP-5";
   case COB_TYPE_NUMERIC_BINARY: return "COMP-4";
   case COB_TYPE_NUMERIC_PACKED: return "COMP-3";
   case COB_TYPE_NUMERIC_FLOAT:  return "COMP-1";
   case COB_TYPE_NUMERIC_DOUBLE: return "COMP-2";
   case COB_TYPE_NUMERIC_DISPLAY:   return "DISPLAY";
   case COB_TYPE_ALPHANUMERIC:   return "X";
   case COB_TYPE_NUMERIC_EDITED: return "EDITED";
   }
   sprintf(wrk,"Type %04X",type);
   return wrk;
}

int
CAPI(void *p1, ...)
{
   int      k,nargs,type,digits,scale,size,sign,byvalue,isright;
   cob_s64_t   val;
   char     *str, wrk[80],pic[30];

   nargs = cob_get_num_params();
   if ((k = cob_get_name_line (wrk, NULL)) > 0) {
      printf("Line%3d: ",k);
   }
   printf("CALL with %d parameters\n",nargs);
   for(k=1; k <= nargs; k++) {
      type   = cob_get_param_type (k);
      digits = cob_get_param_digits (k);
      scale  = cob_get_param_scale (k);
      size   = cob_get_param_size (k);
      sign   = cob_get_param_sign (k);
      byvalue = cob_get_param_constant(k);
      isright = cob_get_param_right(k);
      printf("     P%d: %-8s ",k,getType(type,byvalue));
      if (byvalue == 3)
         printf("BY CONTENT   ");
      else if (byvalue == 2)
         printf("BY VALUE     ");
      else if (byvalue == 1)
         printf("LITERAL      ");
      else
         printf("BY REFERENCE ");
      if (type == COB_TYPE_ALPHANUMERIC) {
         sprintf(pic,"X(%d)",size);
         str = cob_get_picx_param (k, NULL, 0);
         printf("%-11s '%.*s'%s",pic,size,str,isright?" RIGHT":"");
         cob_free ((void*)str);
         cob_put_picx_param (k, "Bye!");
      } else if (type == COB_TYPE_GROUP) {
         sprintf(pic,"(%d)",size);
         str = cob_get_grp_param (k, NULL, 0);
         printf("%-11s '%s'",pic,str);
         cob_free ((void*)str);
         memset(wrk,' ',sizeof(wrk));
         memcpy(wrk,"Bye-Bye Birdie!",15);
         cob_put_grp_param (k, wrk, sizeof(wrk));
         str = cob_get_grp_param (k, NULL, 0);
         printf(" --> '%.*s'",size,str);
         cob_free ((void*)str);
      } else if (type == COB_TYPE_NUMERIC_EDITED) {
         if(scale > 0) {
            sprintf(pic,"%s9(%d)V9(%d)",sign?"S":"",digits-scale,scale);
         } else {
            sprintf(pic,"%s9(%d)",sign?"S":"",digits-scale);
         }
         val = cob_get_s64_param (k);
         printf("%-11s %lld ",pic,val);
         val = val + 130;
         val = -val;
         cob_put_s64_param (k, val);
         cob_get_grp_param (k, wrk, sizeof(wrk));
         printf(" to %.*s",size,wrk);
      } else {
         if(scale > 0) {
            sprintf(pic,"%s9(%d)V9(%d)",sign?"S":"",digits-scale,scale);
         } else {
            sprintf(pic,"%s9(%d)",sign?"S":"",digits-scale);
         }
         val = cob_get_s64_param (k);
         printf("%-11s %lld",pic,val);
         cob_put_s64_param (k, val + 3);
      }
      printf(";\n");
      fflush(stdout);
   }
   if (nargs > 2)
      cob_put_s64_param (7, val + 3);
   return 0;
}
]])

AT_CHECK([$COMPILE -x -std=mf -debug -Wall -debug prog.cob cmod.c ], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [Initial: 'Hello     '
Line 11: CALL with 1 parameters
     P1: X        BY REFERENCE X(10)       'Hello' RIGHT;
  After: '      Bye!'
], [])

AT_CLEANUP


AT_SETUP([CALL with program prototypes])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       PROCEDURE DIVISION.
           CALL "c"
           .
       END PROGRAM prog.


       IDENTIFICATION DIVISION.
       PROGRAM-ID. a AS "blah?Sdk".

       PROCEDURE DIVISION.
           DISPLAY "Hello!"
           .
       END PROGRAM a.


       IDENTIFICATION DIVISION.
       PROGRAM-ID. b.

       PROCEDURE DIVISION.
           DISPLAY "Hello again!"
           .
       END PROGRAM b.


       IDENTIFICATION DIVISION.
       PROGRAM-ID. c.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       REPOSITORY.
           PROGRAM d AS "blah?Sdk"
           PROGRAM b
           .

       PROCEDURE DIVISION.
           CALL d
           CALL b
           .
       END PROGRAM c.
])

AT_CHECK([$COMPILE_MODULE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN prog], [0],
[Hello!
Hello again!
], [])

AT_DATA([caller.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. caller.

       PROCEDURE DIVISION.
       MAIN-LINE.

           PERFORM DO-CHECK
       >> IF CHECK-PERF IS DEFINED
      *>   minimal side-test for performance comparisons
           PERFORM DO-CHECK 10000 TIMES
       >> END-IF
           DISPLAY 'DONE' UPON SYSERR WITH NO ADVANCING
           GOBACK.

       DO-CHECK.
           CALL "prog"
           .
])

AT_CHECK([$COMPILE caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [0], ignore, [DONE])
AT_CLEANUP


AT_SETUP([REDEFINES values on FILLER and INITIALIZE])
AT_KEYWORDS([runmisc INITIALIZE])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TSRDF.
           05  WS-ASK-ID-DATE                PIC X(10) VALUE ALL '*'.
           05  WS-ASK-ID-DATE-R              REDEFINES WS-ASK-ID-DATE.
               10  WS-ASK-ID-DATE-YYYY       PIC 9(4) VALUE 2017.
               10  FILLER                    PIC X VALUE '-'.
               10  WS-ASK-ID-DATE-MM         PIC 9(2).
               10  FILLER                    PIC X VALUE '-'.
               10  WS-ASK-ID-DATE-DD         PIC 9(2).
       PROCEDURE DIVISION.
           MOVE 2015 TO WS-ASK-ID-DATE-YYYY
           MOVE 08 TO WS-ASK-ID-DATE-MM
           MOVE 21 TO WS-ASK-ID-DATE-DD
           DISPLAY "The date is " WS-ASK-ID-DATE " Compiled".

           INITIALIZE WS-ASK-ID-DATE-R.
           MOVE 08 TO WS-ASK-ID-DATE-MM
           MOVE 21 TO WS-ASK-ID-DATE-DD
           DISPLAY "The date is " WS-ASK-ID-DATE " INITIALIZE".

           INITIALIZE WS-ASK-ID-DATE-R WITH FILLER.
           MOVE 08 TO WS-ASK-ID-DATE-MM
           MOVE 21 TO WS-ASK-ID-DATE-DD
           DISPLAY "The date is " WS-ASK-ID-DATE " WITH FILLER".

           INITIALIZE WS-ASK-ID-DATE-R WITH FILLER ALL TO VALUE.
           MOVE 08 TO WS-ASK-ID-DATE-MM
           MOVE 21 TO WS-ASK-ID-DATE-DD
           DISPLAY "The date is " WS-ASK-ID-DATE " ALL TO VALUE".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob:9: warning: initial VALUE clause ignored for REDEFINES item 'WS-ASK-ID-DATE-YYYY'
prog.cob:10: warning: initial VALUE clause ignored for REDEFINES item 'FILLER'
prog.cob:12: warning: initial VALUE clause ignored for REDEFINES item 'FILLER'
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[The date is 2015*08*21 Compiled
The date is 0000*08*21 INITIALIZE
The date is 0000 08 21 WITH FILLER
The date is 2017-08-21 ALL TO VALUE
], [])

AT_CLEANUP


AT_SETUP([PICTURE with constant-name])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION  DIVISION.
       PROGRAM-ID.     prog.

       DATA            DIVISION.
       WORKING-STORAGE SECTION.
       01  foo-bar     CONSTANT 8.
       01  x           PIC 9(foo-bar)9(foo-bar).

       PROCEDURE DIVISION.
           IF FUNCTION LENGTH (x) <> 16
               DISPLAY FUNCTION LENGTH (x)
           END-IF
           .
       END PROGRAM prog.
])
# " <-- comment for fixing syntax highlighting

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [],
[prog.cob:11: warning: expression '16' NOT EQUAL '16' is always FALSE
])
AT_CHECK([$COMPILE -fno-constant-folding prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([Quote marks in comment paragraphs])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog.
       DATE-written.  hello'".
      *> Written is intentionally lowercase.
      *> extra " to fix syntax highlighting
       PROCEDURE      DIVISION.
           DISPLAY "Hello, world!"
           .
])

AT_CHECK([$COMPILE -o prog prog.cob], [0], [],
[prog.cob:4: warning: DATE-WRITTEN is obsolete in GnuCOBOL
])
AT_CHECK([$COMPILE -free -o prog prog.cob], [0], [],
[prog.cob:3: warning: DATE-WRITTEN is obsolete in GnuCOBOL
])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Hello, world!
])
AT_CLEANUP


AT_SETUP([Numeric MOVE with/without -fbinary-truncate])
AT_KEYWORDS([runmisc size binary-truncate])

AT_DATA([prog.cob], [
       IDENTIFICATION  DIVISION.
       PROGRAM-ID.     prog.

       DATA            DIVISION.
       WORKING-STORAGE SECTION.
       01  x PIC 9(4)  COMP.

       PROCEDURE       DIVISION.
           MOVE 30000 TO x
           PERFORM check-x-val

           COMPUTE x = 30000
           PERFORM check-x-val

           MOVE ZERO TO x
           ADD 30000 TO x
           PERFORM check-x-val

           GOBACK
           .
       check-x-val     SECTION.
           EVALUATE x
               WHEN 30000
                   DISPLAY "x IS 30000"

               WHEN >= 10000
                   DISPLAY "x >= 10000"

               WHEN ZERO
                   DISPLAY "x IS ZERO"

               WHEN OTHER
                   CONTINUE
           END-EVALUATE
           .
       END PROGRAM prog.
])


AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob:10: warning: value size exceeds data size
prog.cob:10: note: value is 30000
prog.cob:7: note: 'x' defined here as PIC 9(4)
])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[x IS ZERO
x IS ZERO
x IS ZERO
])

AT_CHECK([$COMPILE -fno-binary-truncate prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[x IS 30000
x IS 30000
x IS 30000
])

AT_CHECK([$COMPILE -fno-binary-truncate -fno-fast-compare prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[x IS 30000
x IS 30000
x IS 30000
])


AT_CLEANUP


AT_SETUP([Alphanumeric MOVE with truncation])
AT_KEYWORDS([misc fundamental size])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  x-left  PIC X(03).
       01  x-right PIC X(03) JUSTIFIED RIGHT.

       PROCEDURE DIVISION.
           MOVE '1234' TO x-left, x-right
           IF x-left  not = '123'
           OR x-right not = '234'
              DISPLAY 'error with "1234":'
              END-DISPLAY
              DISPLAY x-left
              END-DISPLAY
              DISPLAY x-right
              END-DISPLAY
           END-IF
           MOVE '   3' TO x-left, x-right
           IF x-left  not = spaces
           OR x-right not = '  3'
              DISPLAY 'error with "   3":'
              END-DISPLAY
              DISPLAY x-left
              END-DISPLAY
              DISPLAY x-right
              END-DISPLAY
           END-IF
           MOVE '3   ' TO x-left, x-right
           IF x-left  not = '3'
           OR x-right not = spaces
              DISPLAY 'error with "3   ":'
              END-DISPLAY
              DISPLAY x-left
              END-DISPLAY
              DISPLAY x-right
              END-DISPLAY
           END-IF
           .
])

AT_CHECK([$COMPILE -Wno-truncate prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([PROGRAM-ID / CALL literal/variable with spaces])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  MYRTN  PIC X(9) VALUE " SUB  ".

       PROCEDURE DIVISION.
           CALL " SUB " USING 'X'.
           MOVE x'00' TO MYRTN (6:1).
           CALL MYRTN   USING 'Y'.
           CALL "SUB"   USING 'Z'.
           CALL "S U B" USING 'A'.
           MOVE " S U B" TO MYRTN.
           CALL MYRTN   USING 'B'.
           STOP RUN.
       END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. "SUB ".

       DATA DIVISION.
       LINKAGE SECTION.
       01  x  PIC X.

       PROCEDURE DIVISION USING x.
            DISPLAY "SUB GOT " X
            END-DISPLAY.
       END PROGRAM " SUB".

       IDENTIFICATION DIVISION.
       PROGRAM-ID. "S U B".

       DATA DIVISION.
       LINKAGE SECTION.
       01  x  PIC X.

       PROCEDURE DIVISION USING x.
            DISPLAY "S U B  GOT " X
            END-DISPLAY.
       END PROGRAM "S U B".
])

AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob:10: warning: ' SUB ' literal includes leading spaces which are omitted
prog.cob:10: warning: ' SUB ' literal includes trailing spaces which are omitted
prog.cob:21: warning: 'SUB ' literal includes trailing spaces which are omitted
prog.cob:30: warning: ' SUB' literal includes leading spaces which are omitted
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[SUB GOT X
SUB GOT Y
SUB GOT Z
S U B  GOT A
S U B  GOT B
],
[libcob: prog.cob:12: warning: ' SUB' literal includes leading spaces which are omitted
libcob: prog.cob:16: warning: ' S U B' literal includes leading spaces which are omitted
])

AT_CLEANUP


AT_SETUP([OPTIONS paragraph, DEFAULT ROUNDED MODE])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION  DIVISION.
       PROGRAM-ID.     prog.
       OPTIONS.
           DEFAULT ROUNDED NEAREST-EVEN.

       DATA            DIVISION.
       WORKING-STORAGE SECTION.
       01  x           PIC 9.

       PROCEDURE       DIVISION.
           COMPUTE x ROUNDED = 1.5
           DISPLAY x
           COMPUTE x ROUNDED = 2.5
           DISPLAY x
           .
])

AT_CHECK([$COMPILE -o prog prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[2
2
])

AT_CLEANUP


AT_SETUP([OCCURS INDEXED ASCENDING])
AT_KEYWORDS([occurs extension])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  DBI-RECORD-NAMEST.
           05  FILLER.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ACM            0315 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-MGL            0303 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZBL            0304 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZCC            0308 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZGL            0305 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZOO            0306 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZTR            0307 '.
       01  DBI-RECORD-NAMESR REDEFINES DBI-RECORD-NAMEST.
           05  DBI-RECORD-NAMES
                  OCCURS 7 TIMES
                  INDEXED BY REC-NAME-IDX
                  ASCENDING KEY IS DBI-RECORD-NAME
                  .
             10  DBI-RECORD-NAME PIC X(30).
             10  DBI-RECORD-CODE PIC 9(4).
             10  DBI-RECORD-DIR  PIC X.
       01  REC-NAME   PIC X(30).
       01  DBX-RECORD-NAMEST.
           05  FILLER.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ACM            0315 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-MGL            0303 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZBL            0304 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZCC            0308 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZGL            0305 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZOO            0306 '.
             10 FILLER PIC X(35)
                VALUE 'A-F-GEN-LEDGER-ZTR            0307 '.
       01  DBX-RECORD-NAMESR REDEFINES DBX-RECORD-NAMEST.
           05  DBX-RECORD-NAMES
                  OCCURS 7 TIMES
                  ASCENDING KEY IS DBX-RECORD-NAME
                  INDEXED BY REC-NAME-DBX
                  .
             10  DBX-RECORD-NAME PIC X(30).
             10  DBX-RECORD-CODE PIC 9(4).
             10  DBX-RECORD-DIR  PIC X.

       PROCEDURE DIVISION.
       MAIN.
      *>   "the initial value of an index-name at runtime is undefined"
      *>   Old OpenCOBOL/GnuCOBOL did that as "1"
           SET REC-NAME-IDX          TO 1.
           MOVE 'A-F-GEN-LEDGER-ZGL' TO REC-NAME.
           PERFORM FINDIT.
           MOVE 'JUNK' TO REC-NAME.
           PERFORM FINDIT.
           STOP RUN.

       FINDIT.
           SEARCH DBI-RECORD-NAMES
           AT END
               DISPLAY 'A ' REC-NAME ' is invalid.'
           WHEN REC-NAME = DBI-RECORD-NAME (REC-NAME-IDX)
               DISPLAY 'A ' REC-NAME ' is code '
                         DBI-RECORD-CODE (REC-NAME-IDX) '.'.

           SEARCH DBX-RECORD-NAMES
           AT END
               DISPLAY 'B ' REC-NAME ' is invalid.'
           WHEN REC-NAME = DBX-RECORD-NAME (REC-NAME-DBX)
               DISPLAY 'B ' REC-NAME ' is code '
                         DBX-RECORD-CODE (REC-NAME-DBX) '.'.
])

AT_CHECK([$COMPILE -frelax-syntax-checks prog.cob], [0], [],
[prog.cob:26: warning: INDEXED should follow ASCENDING/DESCENDING
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[A A-F-GEN-LEDGER-ZGL             is code 0305.
B A-F-GEN-LEDGER-ZGL             is code 0305.
A JUNK                           is invalid.
B JUNK                           is invalid.
], [])

AT_CLEANUP


AT_SETUP([ZERO unsigned and negative binary subscript])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       77  UBIN        PIC  9(8) BINARY.
       77  SBIN        PIC S9(8) BINARY.
       77  UNUP        PIC  9(8).
       77  SNUP        PIC S9(8).
       77  UCHR        BINARY-CHAR UNSIGNED.
       77  SCHR        BINARY-CHAR SIGNED.

       01  TSTREC.
           05       PIC X(4) OCCURS 300 TIMES VALUE ZERO.
           05  TSTX PIC X(4) OCCURS   3 TIMES.
           05  TSTY PIC X(4) OCCURS 300 TIMES.

       PROCEDURE DIVISION.
           MOVE ALL 'A' TO TSTX(1).
           MOVE ALL 'B' TO TSTX(2).
           MOVE ALL 'C' TO TSTX(3).
           MOVE ALL '1' TO TSTY(1).
           MOVE ALL '2' TO TSTY(2).
           MOVE ALL '3' TO TSTY(3).
           MOVE 0  TO UNUP.
           DISPLAY "UNUP: " UNUP " is :" TSTY(UNUP) ":" UPON CONSOLE.
           MOVE 0  TO SNUP.
           DISPLAY "SNUP: " SNUP " is :" TSTY(SNUP) ":" UPON CONSOLE.
           MOVE 0  TO SBIN.
           DISPLAY "SBIN: " SBIN " is :" TSTY(SBIN) ":" UPON CONSOLE.
           MOVE -1 TO SBIN.
           DISPLAY "SBIN: " SBIN " is :" TSTY(SBIN) ":" UPON CONSOLE.
           MOVE 'xxx'   TO TSTY(SBIN).
           DISPLAY "SBIN: " SBIN " is :" TSTY(SBIN) ":" UPON CONSOLE.
      * The following would often core dump
           MOVE 0 TO UBIN.
           DISPLAY "UBIN: " UBIN " is :" TSTY(UBIN) ":" UPON CONSOLE.
           MOVE 'yyy'   TO TSTY(UBIN).
           MOVE 1 TO UBIN.
           DISPLAY "UBIN: " UBIN " is :" TSTY(UBIN) ":" UPON CONSOLE.
           MOVE 0 TO UCHR.
           DISPLAY "UCHR: " UCHR " is :" TSTY(UCHR) ":" UPON CONSOLE.
           MOVE -1 TO SCHR.
           DISPLAY "SCHR: " SCHR " is :" TSTY(SCHR) ":" UPON CONSOLE.
           MOVE 'zzz' TO TSTY (129).
           MOVE 129 TO UCHR.
           DISPLAY "UCHR: " UCHR " is :" TSTY(UCHR) ":" UPON CONSOLE.
           STOP RUN.
])

# Safe run with runtime checks
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:26: error: subscript of 'TSTY' out of bounds: 0
])

# Runtime checks disable, subscript may be zero or even negative
AT_CHECK([$COBC -x -g -fsource-location prog.cob -o prog_unsafe], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog_unsafe], [0],
[UNUP: 00000000 is :CCCC:
SNUP: +00000000 is :CCCC:
SBIN: +00000000 is :CCCC:
SBIN: -00000001 is :BBBB:
SBIN: -00000001 is :xxx :
UBIN: 00000000 is :CCCC:
UBIN: 00000001 is :1111:
UCHR: 000 is :yyy :
SCHR: -001 is :xxx :
UCHR: 129 is :zzz :
], [])

AT_CLEANUP


AT_SETUP([Default Arithmetic (1)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 NUM-A   PIC 9(3) VALUE 399.
       01 NUM-B   PIC 9(3) VALUE 211.
       01 NUM-C   PIC 9(3)V99 VALUE 212.34.
       01 NUMV1   PIC 9(3)V9.
       01 PICX    PIC X VALUE 'A'.
       01 RSLT    PIC 9(3).
       01 RSLTV1  PIC 9(3).9.
       01 RSLTV2  PIC 9(3).99.
       01  SGN-INT USAGE SIGNED-INT VALUE 0.
           88 A-ONE VALUE 1.
	       88 A-TWO VALUE 2.
      *
       PROCEDURE DIVISION.
       MAIN.
           COMPUTE RSLT = NUM-A + 1.1.
           DISPLAY 'Simple Compute  RSLT IS ' RSLT
           COMPUTE RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Single Variable RSLT IS ' RSLT
           COMPUTE RSLTV2, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Compute  RSLT    IS ' RSLT
           DISPLAY 'Compute  RSLTv99 IS ' RSLTV2
           COMPUTE RSLTV1, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Compute  RSLT    IS ' RSLT
           DISPLAY 'Compute  RSLTv9  IS ' RSLTV1
           MOVE 0 TO RSLT
           ADD NUM-C TO RSLT.
           DISPLAY 'Add      RSLT    IS ' RSLT.
           MOVE 0 TO RSLT
           ADD NUM-A NUM-C 10 TO RSLT.
           DISPLAY 'Add      RSLT    IS ' RSLT.
           SUBTRACT NUM-C FROM RSLT.
           DISPLAY 'Subtract RSLT    IS ' RSLT.
           SUBTRACT NUM-A -10 FROM RSLT.
           DISPLAY 'Subtract RSLT    IS ' RSLT.
           MOVE 0 TO RSLT
           ADD NUM-A NUM-C TO RSLT GIVING RSLTV1.
           DISPLAY 'Add      RSLTv9  IS ' RSLTV1
           MULTIPLY NUM-A BY NUM-C GIVING RSLT.
           DISPLAY 'Multiply RSLT    IS ' RSLT.
           MULTIPLY RSLT BY NUM-C.
           DISPLAY 'Multiply RSLT    IS ' RSLT.
           DIVIDE NUM-A BY 10 GIVING RSLT.
           DISPLAY 'Divide   RSLT    IS ' RSLT.
           DIVIDE RSLT BY 4 GIVING RSLTV1.
           DISPLAY 'Divide   RSLTv9  IS ' RSLTV1.
           DIVIDE RSLT BY 4 GIVING RSLT.
           DISPLAY 'Divide   RSLT    IS ' RSLT.

           COMPUTE RSLTV1, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Simple   RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           COMPUTE RSLTV1, RSLT = ((NUM-A / (100.55 + -0.550))
                                -  (NUM-B / (10.11 * 10 - 1.1)))
                                  * (220 / 2.2)
           DISPLAY 'Complex  RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           COMPUTE RSLTV1, RSLT = ((NUM-A / (101 - 1))
                                -  (NUM-B / (10 * 10))) * (200 / 2)
           DISPLAY 'Reduced  RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.
           MOVE NUM-A TO NUMV1.
           IF ((NUMV1 / (101 - 1))
              -  (NUM-B / (10 * 10))) * (200 / 2) EQUAL 188
              DISPLAY "Not Using ARITHMETIC-OSVS"
           ELSE
              DISPLAY "Using ARITHMETIC-OSVS"
           END-IF.
           IF NOT A-ONE AND NOT A-TWO
                DISPLAY '88 test SUCCESS'
           ELSE
                DISPLAY '88 test FAILED'
           END-IF.
           STOP RUN.
])
AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Simple Compute  RSLT IS 400
Single Variable RSLT IS 188
Compute  RSLT    IS 188
Compute  RSLTv99 IS 188.00
Compute  RSLT    IS 188
Compute  RSLTv9  IS 188.0
Add      RSLT    IS 212
Add      RSLT    IS 621
Subtract RSLT    IS 408
Subtract RSLT    IS 019
Add      RSLTv9  IS 611.3
Multiply RSLT    IS 723
Multiply RSLT    IS 723
Divide   RSLT    IS 039
Divide   RSLTv9  IS 009.7
Divide   RSLT    IS 009
Simple   RSLT    IS 188 RSLTv9  IS 188.0
Complex  RSLT    IS 188 RSLTv9  IS 188.0
Reduced  RSLT    IS 188 RSLTv9  IS 188.0
Not Using ARITHMETIC-OSVS
88 test SUCCESS
], [])

AT_CLEANUP


AT_SETUP([Default Arithmetic Test (2)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT      DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE SECTION.
       01  VAL                 PIC S9(7)V99 COMP-3 VALUE 20500.
       01  DIV1                PIC S9(7)V99 COMP-3 VALUE 0.9.
       01  DIV2                PIC S9(7)V99 COMP-3 VALUE 33.45.
       01  DIV3                PIC S9(7)V99 COMP-3 VALUE 9.
       01  MUL1                PIC S9(7)V99 COMP-3 VALUE 10.
       01  MUL2                PIC S9(7)V99 COMP-3 VALUE 5.
       01  MUL3                PIC S9(7)V99 COMP-3 VALUE 2.
       01  RES                 PIC S9(7)V99 COMP-3.
       PROCEDURE        DIVISION.
           COMPUTE RES = VAL / DIV1 / DIV2.
           DISPLAY 'RES = ' RES.
           COMPUTE RES ROUNDED = VAL / DIV1 / DIV2.
           DISPLAY 'RES ROUNDED = ' RES.
           COMPUTE RES = VAL * MUL1 / DIV3 / DIV2.
           DISPLAY 'RES MULT1 = ' RES.
           COMPUTE RES = VAL * MUL2 * MUL3 / DIV3 / DIV2.
           DISPLAY 'RES MULT2 = ' RES.
           COMPUTE RES = VAL / DIV1.
           DISPLAY 'RES 1 = ' RES.
           COMPUTE RES = RES / DIV2.
           DISPLAY 'RES F = ' RES.
           COMPUTE RES ROUNDED MODE AWAY-FROM-ZERO =
                VAL / DIV1 / DIV2.
           DISPLAY 'RES ROUNDED AWAY = ' RES.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[RES = +0000680.95
RES ROUNDED = +0000680.95
RES MULT1 = +0000680.95
RES MULT2 = +0000680.95
RES 1 = +0022777.77
RES F = +0000680.94
RES ROUNDED AWAY = +0000680.96
], [])

AT_CLEANUP


AT_SETUP([OSVS Arithmetic (1)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 NUM-A   PIC 9(3) VALUE 399.
       01 NUM-B   PIC 9(3) VALUE 211.
       01 NUM-C   PIC 9(3)V99 VALUE 212.34.
       01 NUMV1   PIC 9(3)V9.
       01 PICX    PIC X VALUE 'A'.
       01 RSLT    PIC 9(3).
       01 RSLTV1  PIC 9(3).9.
       01 RSLTV2  PIC 9(3).99.
      *
       PROCEDURE DIVISION.
       MAIN.
           COMPUTE RSLT = NUM-A + 1.1.
           DISPLAY 'Simple Compute  RSLT IS ' RSLT
           COMPUTE RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Single Variable RSLT IS ' RSLT
           COMPUTE RSLTV2, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Compute  RSLT    IS ' RSLT
           DISPLAY 'Compute  RSLTv99 IS ' RSLTV2
           COMPUTE RSLTV1, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Compute  RSLT    IS ' RSLT
           DISPLAY 'Compute  RSLTv9  IS ' RSLTV1
           MOVE 0 TO RSLT
           ADD NUM-C TO RSLT.
           DISPLAY 'Add      RSLT    IS ' RSLT.
           MOVE 0 TO RSLT
           ADD NUM-A NUM-C 10 TO RSLT.
           DISPLAY 'Add      RSLT    IS ' RSLT.
           SUBTRACT NUM-C FROM RSLT.
           DISPLAY 'Subtract RSLT    IS ' RSLT.
           SUBTRACT NUM-A -10 FROM RSLT.
           DISPLAY 'Subtract RSLT    IS ' RSLT.
           MOVE 0 TO RSLT
           ADD NUM-A NUM-C TO RSLT GIVING RSLTV1.
           DISPLAY 'Add      RSLTv9  IS ' RSLTV1
           MULTIPLY NUM-A BY NUM-C GIVING RSLT.
           DISPLAY 'Multiply RSLT    IS ' RSLT.
           MULTIPLY RSLT BY NUM-C.
           DISPLAY 'Multiply RSLT    IS ' RSLT.
           DIVIDE NUM-A BY 10 GIVING RSLT.
           DISPLAY 'Divide   RSLT    IS ' RSLT.
           DIVIDE RSLT BY 4 GIVING RSLTV1.
           DISPLAY 'Divide   RSLTv9  IS ' RSLTV1.
           DIVIDE RSLT BY 4 GIVING RSLT.
           DISPLAY 'Divide   RSLT    IS ' RSLT.

           COMPUTE RSLTV1, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Simple   RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           COMPUTE RSLTV1, RSLT = ((NUM-A / (100.55 + -0.550))
                                -  (NUM-B / (10.11 * 10 - 1.1)))
                                  * (220 / 2.2)
           DISPLAY 'Complex  RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           COMPUTE RSLTV1, RSLT = ((NUM-A / (101 - 1))
                                -  (NUM-B / (10 * 10))) * (200 / 2)
           DISPLAY 'Reduced  RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.
           MOVE NUM-A TO NUMV1.
           IF ((NUMV1 / (101 - 1))
              -  (NUM-B / (10 * 10))) * (200 / 2) EQUAL 188
              DISPLAY "Not Using ARITHMETIC-OSVS"
           ELSE
              DISPLAY "Using ARITHMETIC-OSVS"
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -farithmetic-osvs prog.cob], [0], [],
[prog.cob: in paragraph 'MAIN':
prog.cob:19: warning: precision of result may change with arithmetic-osvs
prog.cob:21: warning: precision of result may change with arithmetic-osvs
prog.cob:24: warning: precision of result may change with arithmetic-osvs
prog.cob:31: warning: precision of result may change with arithmetic-osvs
prog.cob:35: warning: precision of result may change with arithmetic-osvs
prog.cob:38: warning: precision of result may change with arithmetic-osvs
prog.cob:51: warning: precision of result may change with arithmetic-osvs
prog.cob:55: warning: precision of result may change with arithmetic-osvs
prog.cob:61: warning: precision of result may change with arithmetic-osvs
prog.cob:66: warning: precision of result may change with arithmetic-osvs
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Simple Compute  RSLT IS 400
Single Variable RSLT IS 100
Compute  RSLT    IS 188
Compute  RSLTv99 IS 188.00
Compute  RSLT    IS 180
Compute  RSLTv9  IS 180.0
Add      RSLT    IS 212
Add      RSLT    IS 621
Subtract RSLT    IS 408
Subtract RSLT    IS 019
Add      RSLTv9  IS 611.3
Multiply RSLT    IS 723
Multiply RSLT    IS 723
Divide   RSLT    IS 039
Divide   RSLTv9  IS 009.7
Divide   RSLT    IS 009
Simple   RSLT    IS 180 RSLTv9  IS 180.0
Complex  RSLT    IS 188 RSLTv9  IS 188.0
Reduced  RSLT    IS 180 RSLTv9  IS 180.0
Using ARITHMETIC-OSVS
], [])

AT_CLEANUP


AT_SETUP([OSVS Arithmetic Test (2)])
AT_KEYWORDS([runmisc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT      DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE SECTION.
       01  VAL                 PIC S9(7)V99 COMP-3 VALUE 20500.
       01  DIV1                PIC S9(7)V99 COMP-3 VALUE 0.9.
       01  DIV2                PIC S9(7)V99 COMP-3 VALUE 33.45.
       01  DIV3                PIC S9(7)V99 COMP-3 VALUE 9.
       01  MUL1                PIC S9(7)V99 COMP-3 VALUE 10.
       01  MUL2                PIC S9(7)V99 COMP-3 VALUE 5.
       01  MUL3                PIC S9(7)V99 COMP-3 VALUE 2.
       01  RES                 PIC S9(7)V99 COMP-3.
       PROCEDURE        DIVISION.
           COMPUTE RES = VAL / DIV1 / DIV2.
           DISPLAY 'RES = ' RES.
           COMPUTE RES ROUNDED = VAL / DIV1 / DIV2.
           DISPLAY 'RES ROUNDED = ' RES.
           COMPUTE RES = VAL * MUL1 / DIV3 / DIV2.
           DISPLAY 'RES MULT1 = ' RES.
           COMPUTE RES = VAL * MUL2 * MUL3 / DIV3 / DIV2.
           DISPLAY 'RES MULT2 = ' RES.
           COMPUTE RES = VAL / DIV1.
           DISPLAY 'RES 1 = ' RES.
           COMPUTE RES = RES / DIV2.
           DISPLAY 'RES F = ' RES.
           COMPUTE RES ROUNDED MODE AWAY-FROM-ZERO =
                VAL / DIV1 / DIV2.
           DISPLAY 'RES ROUNDED AWAY = ' RES.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=ibm prog.cob], [0], [],
[prog.cob:16: warning: precision of result may change with arithmetic-osvs
prog.cob:18: warning: precision of result may change with arithmetic-osvs
prog.cob:20: warning: precision of result may change with arithmetic-osvs
prog.cob:22: warning: precision of result may change with arithmetic-osvs
prog.cob:28: warning: precision of result may change with arithmetic-osvs
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[RES = +000068094
RES ROUNDED = +000068095
RES MULT1 = +000068094
RES MULT2 = +000068095
RES 1 = +002277777
RES F = +000068094
RES ROUNDED AWAY = +000068095
], [])

AT_CLEANUP


AT_SETUP([OSVS Arithmetic Test (3)])
AT_KEYWORDS([OSVS])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 PERCENT    PIC S9(03)V99.
       01 AMOUNT     PIC S9(11)V99.
       01 RESULT     PIC S9(11)V99.
       01 D-RESULT   PIC -9(5).99.
       01 D-MSG      PIC X(37) VALUE " ".
       01 D-RND      PIC X(4)  VALUE " ".
       01 X-RSLT     PIC S9(5).
       01 NUM-A      PIC 9(3) VALUE 399.
       01 NUM-B      PIC 9(3) VALUE 211.
       01 NUMV1      PIC 9(3)V9.
       01 RSLT       PIC 9(3).
       01 RSLTV1     PIC 9(3).9.

       LOCAL-STORAGE SECTION.
       PROCEDURE DIVISION.

           DISPLAY '-- TEST COMPUTE WITH ROUNDING --'

           MOVE 24 TO PERCENT
           MOVE 123.45 TO AMOUNT
           DISPLAY ' AMOUNT:  123.45 '
                   ' PERCENT: 24'

           DISPLAY "  ALL TESTS HAVE COMPUTE ROUNDED EXCEPT 'NR:'"

           MOVE 'AMOUNT + (AMOUNT * PERCENT / 100)' TO D-MSG
           COMPUTE RESULT ROUNDED = AMOUNT + (AMOUNT * PERCENT / 100)
           PERFORM SHOW-IT.

           MOVE 'PERCENT / 100 * AMOUNT + AMOUNT' TO D-MSG
           COMPUTE RESULT ROUNDED = PERCENT / 100 * AMOUNT + AMOUNT
           PERFORM SHOW-IT.

           MOVE 'NR:' TO D-RND
           MOVE 'PERCENT / 100 * AMOUNT + AMOUNT' TO D-MSG
           COMPUTE RESULT = PERCENT / 100 * AMOUNT + AMOUNT
           PERFORM SHOW-IT.

           MOVE '(AMOUNT * PERCENT / 100) + AMOUNT' TO D-MSG
           COMPUTE RESULT ROUNDED = (AMOUNT * PERCENT / 100) + AMOUNT
           PERFORM SHOW-IT.

           MOVE '(123.45 * 24 / 100) + 123.45' TO D-MSG
           COMPUTE RESULT ROUNDED = (123.45 * 24 / 100) + 123.45
           PERFORM SHOW-IT.

           MOVE '123.45 + (123.45 * 24 / 100)' TO D-MSG
           COMPUTE RESULT ROUNDED = 123.45 + (123.45 * 24 / 100)
           PERFORM SHOW-IT.

           MOVE 'NR:' TO D-RND
           MOVE '123.45 + (123.45 * 24 / 100)' TO D-MSG
           COMPUTE RESULT = 123.45 + (123.45 * 24 / 100)
           PERFORM SHOW-IT.

           MOVE '(AMOUNT * PERCENT / 100) ' TO D-MSG
           COMPUTE RESULT = (AMOUNT * PERCENT / 100)
           PERFORM SHOW-IT.

           MOVE '(AMOUNT * PERCENT / 100) ROUNDED' TO D-MSG
           COMPUTE RESULT ROUNDED = (AMOUNT * PERCENT / 100)
           PERFORM SHOW-IT.

           MOVE 399 TO NUMV1.
           MOVE 211 TO NUM-B.
           COMPUTE X-RSLT = ((NUMV1 / (101 - 1))
                          -  (NUM-B / (10 * 10))) * (200 / 2)
           IF ((NUMV1 / (101 - 1))
                -  (NUM-B / (10 * 10))) * (200 / 2) EQUAL 188
               DISPLAY "Not Using ARITHMETIC-OSVS: " X-RSLT
           ELSE
               DISPLAY "Using ARITHMETIC-OSVS: " X-RSLT
           END-IF.

           COMPUTE X-RSLT ROUNDED = ((NUMV1 / (101 - 1))
                          -  (NUM-B / (10 * 10))) * (200 / 2)
           IF ((NUMV1 / (101 - 1))
                -  (NUM-B / (10 * 10))) * (200 / 2) EQUAL 188
               DISPLAY "Not Using ARITHMETIC-OSVS: " X-RSLT
           ELSE
               DISPLAY "Using ARITHMETIC-OSVS: " X-RSLT
           END-IF.

           COMPUTE RSLTV1, RSLT = ((NUM-A / 100) - (NUM-B / 100)) * 100
           DISPLAY 'Simple   RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           COMPUTE RSLTV1, RSLT = ((NUM-A / (100.55 + -0.550))
                                -  (NUM-B / (10.11 * 10 - 1.1)))
                                  * (220 / 2.2)
           DISPLAY 'Complex  RSLT    IS ' RSLT
                           ' RSLTv9  IS ' RSLTV1.

           DISPLAY '-- TEST FINISHED --'.

           STOP RUN.

       SHOW-IT.
           MOVE RESULT TO D-RESULT
           DISPLAY D-RND D-MSG ' = ' D-RESULT.
           MOVE SPACES TO D-RND.
])

AT_CHECK([$COMPILE -std=ibm -farithmetic-osvs -w prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [-- TEST COMPUTE WITH ROUNDING --
 AMOUNT:  123.45  PERCENT: 24
  ALL TESTS HAVE COMPUTE ROUNDED EXCEPT 'NR:'
    AMOUNT + (AMOUNT * PERCENT / 100)     =  00153.08
    PERCENT / 100 * AMOUNT + AMOUNT       =  00153.08
NR: PERCENT / 100 * AMOUNT + AMOUNT       =  00153.07
    (AMOUNT * PERCENT / 100) + AMOUNT     =  00153.08
    (123.45 * 24 / 100) + 123.45          =  00153.08
    123.45 + (123.45 * 24 / 100)          =  00153.08
NR: 123.45 + (123.45 * 24 / 100)          =  00153.07
    (AMOUNT * PERCENT / 100)              =  00029.62
    (AMOUNT * PERCENT / 100) ROUNDED      =  00029.63
Using ARITHMETIC-OSVS: 00180+
Using ARITHMETIC-OSVS: 00180+
Simple   RSLT    IS 180 RSLTv9  IS 180.0
Complex  RSLT    IS 188 RSLTv9  IS 188.0
-- TEST FINISHED --
], [])

AT_CHECK([$COMPILE -std=ibm -w -fno-arithmetic-osvs prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [-- TEST COMPUTE WITH ROUNDING --
 AMOUNT:  123.45  PERCENT: 24
  ALL TESTS HAVE COMPUTE ROUNDED EXCEPT 'NR:'
    AMOUNT + (AMOUNT * PERCENT / 100)     =  00153.08
    PERCENT / 100 * AMOUNT + AMOUNT       =  00153.08
NR: PERCENT / 100 * AMOUNT + AMOUNT       =  00153.07
    (AMOUNT * PERCENT / 100) + AMOUNT     =  00153.08
    (123.45 * 24 / 100) + 123.45          =  00153.08
    123.45 + (123.45 * 24 / 100)          =  00153.08
NR: 123.45 + (123.45 * 24 / 100)          =  00153.07
    (AMOUNT * PERCENT / 100)              =  00029.62
    (AMOUNT * PERCENT / 100) ROUNDED      =  00029.63
Not Using ARITHMETIC-OSVS: 00188+
Not Using ARITHMETIC-OSVS: 00188+
Simple   RSLT    IS 188 RSLTv9  IS 188.0
Complex  RSLT    IS 188 RSLTv9  IS 188.0
-- TEST FINISHED --
], [])

AT_CLEANUP


AT_SETUP([SET CONSTANT directive])
AT_KEYWORDS([misc directives extensions])

# The SET CONSTANT directive defines a level78 variable
# for the current compilation unit

# original MF extension: $SET CONSTANT
AT_DATA([prog.cob], [
       $SET CONSTANT DOGGY "Barky"
       $SET CONSTANT PONY "Blacky"
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  THEDOG    PIC X(6) VALUE DOGGY.
       77  MYHORSE   PIC X(7) VALUE PONY.
       $SET CONSTANT PONY "White"
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "Your Dog's name is " DOGGY ";".
           DISPLAY "The Dog's name is " THEDOG ";".
           DISPLAY "My Horse is " MYHORSE ";".
           DISPLAY "My little pony is " PONY ".".
           STOP RUN.
])

# OpenCOBOL/GnuCOBOL extension: >>SET CONSTANT
AT_DATA([prog2.cob], [
       >>SET CONSTANT DOGGY "Barky"
       >>SET CONSTANT PONY "Blacky"
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog2.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  THEDOG    PIC X(6) VALUE DOGGY.
       77  MYHORSE   PIC X(7) VALUE PONY.
       >>SET CONSTANT PONY "White"
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "Your Dog's name is " DOGGY ";".
           DISPLAY "The Dog's name is " THEDOG ";".
           DISPLAY "My Horse is " MYHORSE ";".
           DISPLAY "My little pony is " PONY ".".
           STOP RUN.
])

# OpenCOBOL/GnuCOBOL extension: >>DEFINE CONSTANT
AT_DATA([prog3.cob], [
       >>DEFINE CONSTANT DOGGY "Barky"
       >>DEFINE CONSTANT PONY "Blacky"
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog3.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  THEDOG    PIC X(6) VALUE DOGGY.
       77  MYHORSE   PIC X(7) VALUE PONY.
       >>DEFINE CONSTANT PONY "White" OVERRIDE
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "Your Dog's name is " DOGGY ";".
           DISPLAY "The Dog's name is " THEDOG ";".
           DISPLAY "My Horse is " MYHORSE ";".
           DISPLAY "My little pony is " PONY ".".
           STOP RUN.
])

AT_CHECK([$COMPILE -std=mf prog.cob], [0], [], [])

# Note: MF does not redefine a value via SET CONSTANT
# the first definitions wins (warning check: syn_misc.at)
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[Your Dog's name is Barky;
The Dog's name is Barky ;
My Horse is Blacky ;
My little pony is Blacky.
], [])

AT_CHECK([$COMPILE prog2.cob], [0], [], [])

# Note: MF does not redefine a value via SET CONSTANT
# the first definitions wins (warning check: syn_misc.at)
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0],
[Your Dog's name is Barky;
The Dog's name is Barky ;
My Horse is Blacky ;
My little pony is Blacky.
], [])

AT_CHECK([$COMPILE -fdefine-constant-directive=ok prog3.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog3], [0],
[Your Dog's name is Barky;
The Dog's name is Barky ;
My Horse is Blacky ;
My little pony is White.
], [])

AT_CLEANUP


AT_SETUP([DEFINE OVERRIDE])
AT_KEYWORDS([CDF directive])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       >>SET CONSTANT DOGGY "Pluto"
       >>SET CONSTANT PONY "Piper"
       WORKING-STORAGE SECTION.
       01  THEDOG    PIC X(6) VALUE DOGGY.

       >>DEFINE DPONY  AS PARAMETER OVERRIDE
       >>IF DPONY IS NOT DEFINED
       >>DEFINE DPONY AS "No Dpony"
       >>END-IF
       01  CNSPONY     CONSTANT FROM DPONY.

       >>DEFINE ENVPONY AS PARAMETER OVERRIDE
       >>IF ENVPONY IS NOT DEFINED
       >>DEFINE ENVPONY AS "No EnvPony"
       >>END-IF
       01  HORSE       CONSTANT FROM ENVPONY.
       77  MYHORSE    PIC X(12) VALUE HORSE  .
       77  MYPONYENV  PIC X(12).
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "ENVPONY" UPON ENVIRONMENT-NAME
           ACCEPT  MYPONYENV FROM ENVIRONMENT-VALUE.
           DISPLAY "ENVPONY env var set to " MYPONYENV ";".
           DISPLAY "1st Dog's name is " DOGGY ";".
           DISPLAY "2nd Dog's name is " PONY ";".
       >>IF ENVPONY IS DEFINED
           DISPLAY "ENVPONY is DEFINED as " HORSE ";".
       >>ELSE
           DISPLAY "ENVPONY was NOT DEFINED;".
       >>END-IF
           DISPLAY "DPONY set to " CNSPONY ";".
       >>IF ENVPONY = "WHITE"
       >>DEFINE CONSTANT PONY AS "White Horse" OVERRIDE
       >>ELSE
       >>DEFINE CONSTANT PONY AS "default Dirty" OVERRIDE
       >>END-IF
           DISPLAY "My pony is " PONY ";".
       >>IF DPONY IS DEFINED
           DISPLAY "DPONY is DEFINED as " CNSPONY ";".
       >>END-IF
           STOP RUN.
])

AT_CHECK([ENVPONY=WHITE $COMPILE prog.cob -fdefine-constant-directive=ok -DDPONY=Stallone], [0], [], [])

AT_CHECK([ENVPONY=WHITE ./prog], [0],
[ENVPONY env var set to WHITE       ;
1st Dog's name is Pluto;
2nd Dog's name is Piper;
ENVPONY is DEFINED as WHITE;
DPONY set to Stallone;
My pony is White Horse;
DPONY is DEFINED as Stallone;
], [])

AT_CLEANUP


AT_SETUP([DEFINE Defaults])
AT_KEYWORDS([CDF directive])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       >>SET CONSTANT DOGGY "Pluto"
       >>SET CONSTANT PONY "Piper"
       WORKING-STORAGE SECTION.
       01  THEDOG    PIC X(6) VALUE DOGGY.

       >>DEFINE DPONY  AS PARAMETER OVERRIDE
       >>IF DPONY IS NOT DEFINED
       >>DEFINE DPONY AS "No Dpony"
       >>END-IF
       01  CNSPONY     CONSTANT FROM DPONY.

       >>DEFINE ENVPONY AS PARAMETER OVERRIDE
       >>IF ENVPONY IS NOT DEFINED
       >>DEFINE ENVPONY AS "No EnvPony"
       >>END-IF
       01  HORSE       CONSTANT FROM ENVPONY.
       77  MYHORSE    PIC X(12) VALUE HORSE  .
       77  MYPONYENV  PIC X(12).
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "ENVPONY" UPON ENVIRONMENT-NAME
           ACCEPT  MYPONYENV FROM ENVIRONMENT-VALUE.
           DISPLAY "ENVPONY env var set to " MYPONYENV ";".
           DISPLAY "1st Dog's name is " DOGGY ";".
           DISPLAY "2nd Dog's name is " PONY ";".
       >>IF ENVPONY IS DEFINED
           DISPLAY "ENVPONY is DEFINED as " HORSE ";".
       >>ELSE
           DISPLAY "ENVPONY was NOT DEFINED;".
       >>END-IF
           DISPLAY "DPONY set to " CNSPONY ";".
       >>IF ENVPONY = "WHITE"
       >>DEFINE CONSTANT PONY AS "White Horse" OVERRIDE
       >>ELSE
       >>DEFINE CONSTANT PONY AS "default Dirty" OVERRIDE
       >>END-IF
           DISPLAY "My pony is " PONY ";".
       >>IF DPONY IS DEFINED
           DISPLAY "DPONY is DEFINED as " CNSPONY ";".
       >>END-IF
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob -fdefine-constant-directive=ok], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[ENVPONY env var set to             ;
1st Dog's name is Pluto;
2nd Dog's name is Piper;
ENVPONY is DEFINED as No EnvPony;
DPONY set to No Dpony;
My pony is default Dirty;
DPONY is DEFINED as No Dpony;
], [])

AT_CLEANUP


AT_SETUP([78 VALUE])
AT_KEYWORDS([CONSTANT misc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       78  DOGGY     VALUE "Barky".
       01  MYREC.
          05  FLD1   PIC 9(2).
          05  FLD2   PIC X(7).
          05  FLD3   PIC X(2) OCCURS 5 TIMES.
          05  FLD4   PIC X(4).
          05  FLD5   PIC X(4).
       01  PICX      PIC XXX VALUE 'Abc'.
       78  HUN       VALUE 10 * (10 + LENGTH OF PICX) + 12.35-2+3.
       78  HUN2      VALUE HUN * (10 + LENGTH OF PICX) -4.
       01  THEDOG    PIC X(6) VALUE DOGGY.
       78  DIV1      VALUE 100 / 3.
       78  NUM2      VALUE 1 + 2 * 3.
       LINKAGE SECTION.
       01  XMYREC.
          05  XFLD1   PIC 9(2).
          05  XFLD2   PIC X(7).
             78  XPOS3    VALUE NEXT.
          05  XFLD3   PIC X(2) OCCURS 5 TIMES.
             78  XPOS4    VALUE NEXT.
          05  XFLD4   PIC X(4).
          05  XFLD5   PIC X(4).
       78  XSTRT4     VALUE START OF XFLD4.
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "DIV1 is " DIV1.
           DISPLAY "HUN  is " HUN.
           DISPLAY "HUN2 is " HUN2.
           MOVE NUM2 TO FLD1
           IF FLD1 = 9
             DISPLAY "NUM2 is " NUM2 " left to right precedence."
           ELSE
             DISPLAY "NUM2 is " NUM2 " normal precedence."
           END-IF.
           DISPLAY "XFLD3 starts at " XPOS3.
           DISPLAY "XFLD4 starts at " XSTRT4.
           DISPLAY "XFLD4 starts at " XPOS4.
           DISPLAY "Your Dog's name is " DOGGY ";".
           DISPLAY "The Dog's name is " THEDOG ";".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[DIV1 is 33
HUN  is 143
HUN2 is 1855
NUM2 is 9 left to right precedence.
XFLD3 starts at 9
XFLD4 starts at 19
XFLD4 starts at 11
Your Dog's name is Barky;
The Dog's name is Barky ;
], [])

AT_CLEANUP


AT_SETUP([01 CONSTANT])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       >>DEFINE MYDOG AS "Piper"
       >>DEFINE MYNUM1 AS 11
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  MYREC.
          05  FLD1   PIC 9(2).
          05  FLD2   PIC X(7).
          05  FLD3   PIC X(2) OCCURS 5 TIMES.
          05  FLD4   PIC X(4).
          05  FLD5   PIC X(4).
       01  PICX      PIC XXX VALUE 'Abc'.
       01  CAT       CONSTANT  'Cat '.
       01  DOG       CONSTANT  'Dog '.
       01  YARD      CONSTANT  CAT & "& " & DOG.
       78  HUN       VALUE 10 * (10 + LENGTH OF PICX) + 12.35-2+3.
       78  HUN2      VALUE HUN * (10 + LENGTH OF PICX) -4.
       78  DIV1      VALUE 100 / 3.
       78  NUM2      VALUE 1 + 2 * 3.
       01  CON3      CONSTANT (((1 + 2) * NUM2) - 4).
       01  CON4      CONSTANT AS 3.1416 + CON3.
       01  CON5      CONSTANT 1 + 2 * 3.
       01  DOGNAME   CONSTANT FROM MYDOG.
       01  NUM1      CONSTANT FROM MYNUM1.
       01  CON6      CONSTANT AS CON5 + NUM1.
       >> IF NUM2 DEFINED  *> optional passed from command line
       01  NUM2      CONSTANT FROM MYNUM2.
       >> END-IF
      *
       PROCEDURE DIVISION.
       MAIN.
           DISPLAY "CAT  is '" CAT "'".
           DISPLAY "Yard is '" YARD "'".
           DISPLAY "DIV1 is " DIV1.
           DISPLAY "HUN  is " HUN.
           DISPLAY "HUN2 is " HUN2.
           MOVE NUM2 TO FLD1
           IF FLD1 = 9
             DISPLAY "78 VALUE has simple left to right precedence."
           ELSE
             DISPLAY "78 VALUE is " NUM2 " normal precedence."
           END-IF.
           MOVE CON5 TO FLD1
           IF FLD1 = 7
             DISPLAY "01 CONSTANT has normal operator precedence."
           ELSE
             DISPLAY "01 CONSTANT is " CON5 " left to right precedence."
           END-IF.
           DISPLAY "CON3 is " CON3.
           DISPLAY "CON4 is " CON4 " vs " 3.141596
                   " & " -2.189 " & " +12.
           DISPLAY "CON6 is " CON6 "."
           DISPLAY "My Dog's name is " DOGNAME ";".
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[CAT  is 'Cat '
Yard is 'Cat & Dog '
DIV1 is 33
HUN  is 143
HUN2 is 1855
78 VALUE has simple left to right precedence.
01 CONSTANT has normal operator precedence.
CON3 is 23
CON4 is 26 vs 3.141596 & -2.189 & +12
CON6 is 18.
My Dog's name is Piper;
], [])

AT_CLEANUP


AT_SETUP([DISPLAY UPON])
AT_SKIP_IF(true)
AT_KEYWORDS([CHAINING PRINTER PIPE CONSOLE SYSERR SYSPCH SYSPUNCH
COB_DISPLAY_PRINT_PIPE COB_DISPLAY_PRINT_FILE COB_DISPLAY_PUNCH_FILE])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           PRINTER IS PRINTER.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77 note PIC X(05).
       PROCEDURE DIVISION CHAINING note.
       DISPLAY "This is sent to CONSOLE " note UPON CONSOLE.
       DISPLAY "This is sent to SYSERR  " note UPON SYSERR.
       DISPLAY "This is sent to PRINTER " note UPON PRINTER.
       DISPLAY "This is also sent to CONSOLE " note UPON CONSOLE.
       DISPLAY "This is also sent to SYSERR  " note UPON SYSERR.
       DISPLAY "This is also sent to PRINTER " note UPON PRINTER.
       DISPLAY "This is sent to SYSPUNCH " note UPON SYSPUNCH
            ON EXCEPTION DISPLAY 'NO ...'        UPON SYSERR.
       DISPLAY "This is also sent to SYSPUNCH " note UPON SYSPCH
            ON EXCEPTION DISPLAY ' ... SYSPUNCH' UPON SYSERR.
       STOP RUN RETURNING 0.
])

AT_CHECK([$COMPILE -std=ibm prog.cob], [0], [],
[prog.cob:12: warning: start of statement in Area A
prog.cob:13: warning: start of statement in Area A
prog.cob:14: warning: start of statement in Area A
prog.cob:15: warning: start of statement in Area A
prog.cob:16: warning: start of statement in Area A
prog.cob:17: warning: start of statement in Area A
prog.cob:18: warning: start of statement in Area A
prog.cob:20: warning: start of statement in Area A
prog.cob:22: warning: start of statement in Area A
])

AT_CHECK([$COBCRUN_DIRECT ./prog PLAIN], [0],
[This is sent to CONSOLE PLAIN
This is sent to PRINTER PLAIN
This is also sent to CONSOLE PLAIN
This is also sent to PRINTER PLAIN
],
[This is sent to SYSERR  PLAIN
This is also sent to SYSERR  PLAIN
libcob: prog.cob:18: warning: COB_DISPLAY_PUNCH_FILE is invalid, output to SYSPUNCH skipped
NO ...
 ... SYSPUNCH
])

AT_CHECK([COB_DISPLAY_PRINT_PIPE='cat >>prt.log' \
COB_DISPLAY_PUNCH_FILE='punch.out' \
$COBCRUN_DIRECT ./prog PIPE.], [0],
[This is sent to CONSOLE PIPE.
This is also sent to CONSOLE PIPE.
],
[This is sent to SYSERR  PIPE.
This is also sent to SYSERR  PIPE.
])

AT_CHECK([COB_DISPLAY_PRINT_FILE='prt.log' \
COB_DISPLAY_PUNCH_FILE='punch.out' \
$COBCRUN_DIRECT ./prog PRINT], [0],
[This is sent to CONSOLE PRINT
This is also sent to CONSOLE PRINT
],
[This is sent to SYSERR  PRINT
This is also sent to SYSERR  PRINT
])

AT_CAPTURE_FILE([prt.log])

AT_DATA([reference],
[This is sent to PRINTER PIPE.
This is also sent to PRINTER PIPE.
This is sent to PRINTER PRINT
This is also sent to PRINTER PRINT
])

AT_CHECK([$DIFF reference prt.log], [0], [], [],

# Previous test "failed" --> check if EOL of PIPE is the issue

AT_CHECK([$SED -e 's/PIPE.\r/PIPE./g' prt.log > prt2.log], [0], [], [])
AT_CHECK([$DIFF reference prt2.log], [0], [], [])
)

AT_CAPTURE_FILE([punch.out])

AT_DATA([reference],
[This is sent to SYSPUNCH PRINT
This is also sent to SYSPUNCH PRINT
])

AT_CHECK([$DIFF reference punch.out], [0], [], [])

AT_CLEANUP


AT_SETUP([FLOAT-DECIMAL w/o SIZE ERROR])
AT_KEYWORDS([Numeric runmisc overflow
FLOAT-DECIMAL-16 FLOAT-DECIMAL-34
DISPLAY COMPUTE])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  FD16                        USAGE FLOAT-DECIMAL-16.
       01  SV16                        USAGE FLOAT-DECIMAL-16.
       01  FD34                        USAGE FLOAT-DECIMAL-34.
       01  SV34                        USAGE FLOAT-DECIMAL-34.

       PROCEDURE DIVISION.
       CND-000.
           DISPLAY "--- FLOAT-DECIMAL-34 ---"
           COMPUTE FD34 = (((1.0E7 / 2.1E0) / 3.1E0) - 5.0E-1) * 6.0E0
           DISPLAY "A: " FD34

           COMPUTE FD34 = (((1.0E7 / 2.9E0) / 3.9E0) - 5.0E-1) * 6.0E0
           DISPLAY "B: " FD34
           MOVE ZERO TO FD34.
           COMPUTE FD34 = 1.0E3 / 2.1E0
                   ON SIZE ERROR DISPLAY "Z: " FD34 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "Z: " FD34 " IS OK"
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- FLOAT-DECIMAL-16 ---"
           COMPUTE FD16 = (((1.0E7 / 2.1E0) / 3.1E0) - 5.0E-1) * 6.0E0
           DISPLAY "A: " FD16

           COMPUTE FD16 = (((1.0E7 / 2.9E0) / 3.9E0) - 5.0E-1) * 6.0E0
           DISPLAY "B: " FD16
           MOVE ZERO TO FD16.
           COMPUTE FD16 = 1.0E3 / 2.1E0
                   ON SIZE ERROR DISPLAY "Z: " FD16 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "Z: " FD16 " IS OK"
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- 99 + 1 / 3 ---"
           MOVE -1 TO FD16, FD34.
           COMPUTE FD34 = 99 + 1 / 3
                   ON SIZE ERROR DISPLAY "FD34: " FD34 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "FD34: " FD34 " IS OK"
           END-COMPUTE.
           COMPUTE FD16 = 99 + 1 / 3
                   ON SIZE ERROR DISPLAY "FD16: " FD16 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "FD16: " FD16 " IS OK"
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- 99 ---"
           MOVE -1 TO FD16, FD34.
           COMPUTE FD34 = 99
                   ON SIZE ERROR DISPLAY "FD34: " FD34 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "FD34: " FD34 " IS OK"
           END-COMPUTE.
           COMPUTE FD16 = 99
                   ON SIZE ERROR DISPLAY "FD16: " FD16 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "FD16: " FD16 " IS OK"
           END-COMPUTE.

       CND-100-OK.
           DISPLAY "    ..."
           DISPLAY "--- Test overflow ---"
           MOVE 9900000000000 TO FD16, FD34.
           PERFORM 390 TIMES
             MOVE FD16 TO SV16
             COMPUTE FD16 = FD16 * 10
                    ON SIZE ERROR GO TO CND-100-ERR
             END-COMPUTE
             IF FD16 < 9.0
               DISPLAY "FD16: " FD16 " IS Wrong"
               GO TO CND-100-ERR
             END-IF
           END-PERFORM.
           DISPLAY "FD16: " FD16 " IS OK".
           GO TO CND-200-OK.
       CND-100-ERR.
           DISPLAY "FD16: after " SV16 " SIZE ERROR".

       CND-200-OK.
           MOVE 9900000000000 TO FD16, FD34.
           PERFORM 6500 TIMES
             MOVE FD34 TO SV34
             COMPUTE FD34 = FD34 * 10
                    ON SIZE ERROR GO TO CND-200-ERR
             END-COMPUTE
             IF FD34 < 9.0
               GO TO CND-200-ERR
             END-IF
           END-PERFORM.
           DISPLAY "FD34: " FD34 " IS OK".
           GO TO CND-380-OK.
       CND-200-ERR.
           DISPLAY "FD34: after " SV34 " SIZE ERROR".

       CND-380-OK.
           DISPLAY "    ..."
           DISPLAY "--- Test underflow ---"
           MOVE 0.000000099 TO FD16, FD34.
           PERFORM 400 TIMES
             MOVE FD16 TO SV16
             COMPUTE FD16 = FD16 / 10
                    ON SIZE ERROR GO TO CND-300-ERR
             END-COMPUTE
             IF FD16 = 0.0
               GO TO CND-300-ERR
             END-IF
           END-PERFORM.
           DISPLAY "FD16: " FD16 " IS OK".
           GO TO CND-400-OK.
       CND-300-ERR.
           DISPLAY "FD16: after " SV16 " SIZE ERROR".

       CND-400-OK.
           MOVE 0.000000099 TO FD16, FD34.
           PERFORM 6600 TIMES
             MOVE FD34 TO SV34
             COMPUTE FD34 = FD34 / 10.0
                    ON SIZE ERROR GO TO CND-400-ERR
             END-COMPUTE
             IF FD34 = 0.0
               GO TO CND-400-ERR
             END-IF
           END-PERFORM.
           DISPLAY "FD34: " FD34 " IS OK".
           GO TO CND-999.
       CND-400-ERR.
           DISPLAY "FD34: after " SV34 " SIZE ERROR".

       CND-999.
           STOP RUN.
           END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[--- FLOAT-DECIMAL-34 ---
A: 9216586.861751152073732718894009216
B: 5305036.78779840848806366047745358
Z: 476.1904761904761904761904761904761 IS OK
    ...
--- FLOAT-DECIMAL-16 ---
A: 9216586.861751152
B: 5305036.787798408
Z: 476.1904761904761 IS OK
    ...
--- 99 + 1 / 3 ---
FD34: 99.33333333333333333333333333333333 IS OK
FD16: 99.33333333333333 IS OK
    ...
--- 99 ---
FD34: 99 IS OK
FD16: 99 IS OK
    ...
--- Test overflow ---
FD16: after 99E369 SIZE ERROR
FD34: after 99E6111 SIZE ERROR
    ...
--- Test underflow ---
FD16: after 99E-398 SIZE ERROR
FD34: after 99E-6176 SIZE ERROR
], [])

AT_CLEANUP


AT_SETUP([FLOAT-SHORT / FLOAT-LONG w/o SIZE ERROR])
AT_KEYWORDS([Numeric runmisc overflow
COMP-1 COMP-2
DISPLAY COMPUTE])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  CMP1                        COMP-1.
       01  SV1                         COMP-1.
       01  CMP2                        COMP-2.
       01  SV2                         COMP-2.

       PROCEDURE DIVISION.
       CND-000.

           DISPLAY "--- COMP-1 ---"
           COMPUTE CMP1 = (((1.0E7 / 2.1E0) / 3.1E0) - 5.0E-1) * 6.0E0
           DISPLAY "A: " CMP1
           COMPUTE CMP1 = (((1.0E7 / 2.9E0) / 3.9E0) - 5.0E-1) * 6.0E0
           DISPLAY "B: " CMP1
           MOVE ZERO TO CMP1.
           COMPUTE CMP1 = 1.0E3 / 2.1E0
                   ON SIZE ERROR DISPLAY "Z: " CMP1 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "Z: " CMP1 " IS OK"
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- COMP-2 ---"
           COMPUTE CMP2 = (((1.0E7 / 2.1E0) / 3.1E0) - 5.0E-1) * 6.0E0
      *>   because of possible rounding of intermediates and different
      *>   precision depending on math library / version: plain DISPLAY
           IF CMP2 >= 9216586.86175114 AND <= 9216586.86175116
             DISPLAY "A ~ 9216586.86175115"
           ELSE
             DISPLAY "A: " CMP2
           END-IF
           COMPUTE CMP2 = (((1.0E7 / 2.9E0) / 3.9E0) - 5.0E-1) * 6.0E0
           IF CMP2 >= 5305036.7877983 AND <= 5305036.7877985
             DISPLAY "B ~ 5305036.787798408"
           ELSE
           DISPLAY "B: " CMP2
           END-IF
           MOVE ZERO TO CMP2.
           COMPUTE CMP2 = 1.0E3 / 2.1E0
                   ON SIZE ERROR DISPLAY "Z: " CMP2 " SIZE ERROR"
               NOT ON SIZE ERROR
      *>        see note above
                IF CMP2 >= 476.1904761904760 AND <= 476.1904761904763
                  DISPLAY "Z ~ 476.1904761904761 IS OK"
                ELSE
                  DISPLAY "Z: " CMP2 " IS OK"
                END-IF
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- 99 + 1 / 3 ---"
           MOVE -1 TO CMP1, CMP2.
           COMPUTE CMP1 = 99 + 1 / 3
                   ON SIZE ERROR DISPLAY "CMP1: " CMP1 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "CMP1: " CMP1 " IS OK"
           END-COMPUTE.
           COMPUTE CMP2 = 99 + 1 / 3
                   ON SIZE ERROR DISPLAY "CMP2: " CMP2 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "CMP2: " CMP2 " IS OK"
           END-COMPUTE.

           DISPLAY "    ..."
           DISPLAY "--- 99 ---"
           MOVE -1 TO CMP1, CMP2.
           COMPUTE CMP1 = 99
                   ON SIZE ERROR DISPLAY "CMP1: " CMP1 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "CMP1: " CMP1 " IS OK"
           END-COMPUTE.
           COMPUTE CMP2 = 99
                   ON SIZE ERROR DISPLAY "CMP2: " CMP2 " SIZE ERROR"
               NOT ON SIZE ERROR DISPLAY "CMP2: " CMP2 " IS OK"
           END-COMPUTE.

       CND-100-OK.
           DISPLAY "    ..."
           DISPLAY "--- Test overflow ---"

           MOVE 990000 TO CMP1.
           PERFORM 6500 TIMES
             MOVE CMP1 TO SV1
             COMPUTE CMP1 = CMP1 * 10
                    ON SIZE ERROR GO TO CND-350-ERR
             END-COMPUTE
             IF CMP1 < 9.0
               GO TO CND-350-ERR
             END-IF
           END-PERFORM.
           DISPLAY "CMP1: " CMP1 " IS OK".
           GO TO CND-350-OK.
       CND-350-ERR.
           DISPLAY "CMP1: after " SV1 " SIZE ERROR".

       CND-350-OK.
           MOVE 9900000000 TO CMP2.
           PERFORM 6500 TIMES
             MOVE CMP2 TO SV2
             COMPUTE CMP2 = CMP2 * 10
                    ON SIZE ERROR GO TO CND-380-ERR
             END-COMPUTE
             IF CMP2 < 9.0
               GO TO CND-380-ERR
             END-IF
           END-PERFORM.
           DISPLAY "CMP2: " CMP2 " IS OK".
           GO TO CND-500-OK.
       CND-380-ERR.
      *>   because of possible rounding of intermediates and different
      *>   precision depending on math library / version: plain DISPLAY
           IF SV2 >= 9.899999999999E+307 AND
                  <= 9.900000000001E+307
             DISPLAY "CMP2: after ~ 9.899999999999781E+307 SIZE ERROR"
           ELSE
             DISPLAY "CMP2: after " SV2 " SIZE ERROR"
           END-IF
           .

       CND-500-OK.
           MOVE 0.000000099 TO CMP1.
           PERFORM 350 TIMES
             MOVE CMP1 TO SV1
             COMPUTE CMP1 = CMP1 / 10.0
                    ON SIZE ERROR GO TO CND-500-ERR
             END-COMPUTE
             IF CMP1 = 0.0
               GO TO CND-500-ERR
             END-IF
           END-PERFORM.
           DISPLAY "CMP1: " CMP1 " IS OK".
           GO TO CND-600-OK.
       CND-500-ERR.
           DISPLAY "CMP1: after " SV1 " SIZE ERROR".

       CND-600-OK.
           MOVE 0.000000099 TO CMP2.
           PERFORM 350 TIMES
             MOVE CMP2 TO SV2
             COMPUTE CMP2 = CMP2 / 10.0
                    ON SIZE ERROR GO TO CND-600-ERR
             END-COMPUTE
             IF CMP2 = 0.0
               GO TO CND-600-ERR
             END-IF
           END-PERFORM.
           DISPLAY "CMP2: " CMP2 " IS OK".
           GO TO CND-600-XIT.
       CND-600-ERR.
           IF SV2 >= 9.8813129168249E-324 AND <= 9.881312916825E-324
             DISPLAY "CMP2: after ~ 9.881312916824931E-324 SIZE ERROR"
           ELSE
             DISPLAY "CMP2: after " SV2 " SIZE ERROR"
           END-IF
           .
       CND-600-XIT.

       CND-999.
           STOP RUN.
           END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[--- COMP-1 ---
A: 9216587
B: 5305037
Z: 476.19049 IS OK
    ...
--- COMP-2 ---
A ~ 9216586.86175115
B ~ 5305036.787798408
Z ~ 476.1904761904761 IS OK
    ...
--- 99 + 1 / 3 ---
CMP1: 99.333336 IS OK
CMP2: 99.33333333333333 IS OK
    ...
--- 99 ---
CMP1: 99 IS OK
CMP2: 99 IS OK
    ...
--- Test overflow ---
CMP1: after 9.8999983E+37 SIZE ERROR
CMP2: after ~ 9.899999999999781E+307 SIZE ERROR
CMP1: after 1.4012985E-45 SIZE ERROR
CMP2: after ~ 9.881312916824931E-324 SIZE ERROR
], [])

AT_CLEANUP


AT_SETUP([FLOAT-SHORT with SIZE ERROR])
AT_KEYWORDS([COMP-1 overflow])

AT_DATA([prog.cob], [
       identification division.
       program-id. prog.

       data division.
       working-storage section.
      *------------------------
       77 counter             pic s9(4) binary value zero.
      * FLOAT-SHORT (if binary-comp-1 is not active)
       77 floatValue          COMP-1  value 2.
       77 lastFloatValue      COMP-1.

      ******************************************************************
       procedure division.
       main section.
           perform varying counter from 1 by 1 until
                           counter > 130
      *>      display 'counter: ' counter ', value: ' floatValue
              compute floatValue = floatValue * 2
                   ON SIZE ERROR
                      display 'SIZE ERROR, last value = ' floatValue
                      exit perform
               not ON SIZE ERROR
                      if floatValue > lastFloatValue
                         move floatValue to lastFloatValue
                      else
                         display 'math ERROR, last value > current: '
                                 lastFloatValue ' > ' floatValue
                         exit perform
                      end-if
              end-compute
           end-perform
           if counter not = 127
              display 'counter is ' counter
           end-if

           goback.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[SIZE ERROR, last value = 1.7014118E+38
], [])

AT_CLEANUP


AT_SETUP([FLOAT-LONG with SIZE ERROR])
AT_KEYWORDS([COMP-2 overflow])

AT_DATA([prog.cob], [
       identification division.
       program-id. prog.

       data division.
       working-storage section.
      *------------------------
       77 counter             pic s9(4) binary value zero.
      * FLOAT-LONG
       77 doubleValue         COMP-2 value 2.
       77 lastDoubleValue     COMP-2.

      ******************************************************************
       procedure division.
       main section.
           perform varying counter from 1 by 1 until
                           counter > 1060
      *>      display 'counter: ' counter ', value: ' doubleValue
              compute doubleValue = doubleValue * 2
                   ON SIZE ERROR
                      display 'SIZE ERROR raised'
                              with no advancing upon syserr
                      end-display
                      display 'SIZE ERROR, last value = ' doubleValue
                              upon sysout
                      end-display
                      exit perform
               not ON SIZE ERROR
                      if doubleValue > lastdoubleValue
                         move doubleValue to lastdoubleValue
                      else
                         display 'math ERROR, last value > current: '
                                 lastdoubleValue ' > ' doubleValue
                                 upon syserr
                         end-display
                         exit perform
                      end-if
              end-compute
           end-perform
           if not (counter >= 1023 and <=1025)
              display ' '                   upon syserr
              display 'counter is ' counter upon syserr
           end-if

           goback.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
# note: the actual value is not checked as it depends on non-portable
#       intermediate rounding
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], ignore, [SIZE ERROR raised])

AT_CLEANUP


AT_SETUP([EC-SIZE-ZERO-DIVIDE])
AT_KEYWORDS([misc fundamental exceptions
DIVIDE COMPUTE EXCEPTION-STATUS])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  x PIC 9 VALUE 0.
       01  y PIC 9 VALUE 0.

       PROCEDURE DIVISION.
           DIVIDE x BY y GIVING y
           ON SIZE ERROR CONTINUE END-DIVIDE
           IF FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           NOT = 'EC-SIZE-ZERO-DIVIDE'
              DISPLAY 'Wrong/missing exception: '
                      FUNCTION EXCEPTION-STATUS
              END-DISPLAY
           END-IF
           SET LAST EXCEPTION TO OFF
           IF FUNCTION EXCEPTION-STATUS NOT = SPACES
              DISPLAY 'Exception is not empty after reset: '
                      FUNCTION EXCEPTION-STATUS
              END-DISPLAY
           END-IF
           MOVE 0 TO y
           COMPUTE y = x - 1 / y + 6.5
           ON SIZE ERROR CONTINUE END-COMPUTE
           IF FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           NOT = 'EC-SIZE-ZERO-DIVIDE'
              DISPLAY 'Wrong/missing exception: '
                      FUNCTION EXCEPTION-STATUS
              END-DISPLAY
           END-IF
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([EC-SIZE-OVERFLOW])
AT_KEYWORDS([misc fundamental exceptions])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  x PIC 9 VALUE 1.
       01  y PIC 9.

       PROCEDURE DIVISION.
      *    raise exception checked in previous test
      *    as it may interfere with the expected exception
           DIVIDE x BY y GIVING y
           ON SIZE ERROR CONTINUE END-DIVIDE
           DIVIDE x BY 0.1 GIVING y
           ON SIZE ERROR CONTINUE END-DIVIDE
           IF FUNCTION TRIM(FUNCTION EXCEPTION-STATUS)
           NOT = 'EC-SIZE-OVERFLOW'
              DISPLAY 'Wrong/missing exception: '
                      FUNCTION EXCEPTION-STATUS
              END-DISPLAY
           END-IF
           .
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CLEANUP


AT_SETUP([Constant Expressions])
AT_KEYWORDS([runmisc condition expression])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  VAR       PIC X(200).
       01  OTHERVAR  PIC X(115).
       78  VAR-LEN   VALUE 115.

       PROCEDURE DIVISION.
       MAIN-10.
           MOVE "Peek a boo" TO VAR.
           EVALUATE TRUE
               ALSO FALSE
               ALSO TRUE
            WHEN    TRUE
               ALSO VAR-LEN > 16 AND VAR-LEN < 200
               ALSO TRUE
                  MOVE OTHERVAR (1 : VAR-LEN - 9)
                    TO VAR (16 - VAR-LEN : VAR-LEN - 9)
                  DISPLAY "A: Should NOT be executed"
            WHEN  TRUE
               ALSO VAR-LEN < 16
               ALSO TRUE
                  MOVE OTHERVAR TO VAR
                  DISPLAY "A: OK VAR-LEN > 16 AND VAR-LEN < 200"
            WHEN  TRUE
               ALSO VAR = SPACES
               ALSO TRUE
                  MOVE OTHERVAR TO VAR
                  DISPLAY "A: OK VAR IS SPACES"
           END-EVALUATE.

           MOVE "Peek a boo" TO VAR.
           EVALUATE 3 EQUALS 7
           WHEN  VAR = SPACES
               DISPLAY "B: OK VAR IS NOT SPACES"
           WHEN  VAR NOT = SPACES
               DISPLAY "B: FALSE VAR IS SPACES"
           END-EVALUATE.

           MOVE SPACES       TO VAR.
           EVALUATE FALSE
           WHEN  VAR = SPACES
               DISPLAY "C: FALSE VAR IS SPACES"
           WHEN  VAR NOT = SPACES
               DISPLAY "C: OK VAR IS SPACES"
           END-EVALUATE.

           MOVE "Peek a boo" TO VAR.
           EVALUATE TRUE
           WHEN  VAR = SPACES
               DISPLAY "D: BAD VAR IS SPACES"
           WHEN  VAR NOT = SPACES
               DISPLAY "D: OK VAR IS NOT SPACES"
           END-EVALUATE.

           MOVE SPACES       TO VAR.
           EVALUATE VAR-LEN ALSO VAR
           WHEN  < 32 ALSO SPACES
               DISPLAY "E: OK VAR IS SPACES"
           WHEN  > 16 ALSO NOT SPACES
               DISPLAY "E: BAD VAR IS NOT SPACES"
           WHEN OTHER
               DISPLAY "E: OK OTHER option taken"
           END-EVALUATE.

           STOP RUN.
])

# Note: this program errors without constant folding, but that is
#       checked in syn_misc.at already; we explicit specify the remove
#       of folded constants option allowing to run with COBOL_FLAGS=-g
AT_CHECK([$COMPILE prog.cob -fconstant-folding -fremove-unreachable -w], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[A: OK VAR-LEN > 16 AND VAR-LEN < 200
B: OK VAR IS NOT SPACES
C: OK VAR IS SPACES
D: OK VAR IS NOT SPACES
E: OK OTHER option taken
], [])

AT_CLEANUP


AT_SETUP([ENTRY FOR GO TO / GO TO ENTRY])
AT_KEYWORDS([runmisc condition expression])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 JUMP-ENTRY    PIC 9  VALUE 6.
          88 EXT-MODUS  VALUES 3, 4.
       LINKAGE SECTION.
       PROCEDURE DIVISION.
           GO TO ENTRY 'STMT05'.
       MAIN.
           GO TO ENTRY 'STMT01'
                       'STMT02'
                       'STMT03'
                       'STMT04'
                       'STMT05'
           DEPENDING ON JUMP-ENTRY
           DISPLAY 'NOT JUMPED'
           GOBACK.
       ENTRY FOR GO TO 'STMT01'
           DISPLAY 'STMT01'
       ENTRY FOR GO TO 'STMT02'
           PERFORM 3 TIMES
       ENTRY FOR GO TO 'STMT03'
              DISPLAY 'STMT03'
       ENTRY FOR GO TO 'STMT04'  DISPLAY 'STMT04'
              IF EXT-MODUS EXIT PERFORM END-IF
           END-PERFORM
       ENTRY FOR GO TO 'STMT05'
           DISPLAY 'STMT05'
           SUBTRACT 1 FROM JUMP-ENTRY
           GO TO MAIN.

])

# TODO: move to syntax checks, together with all expected error messages
AT_CHECK([$COMPILE -std=mf-strict prog.cob], [1], [],
[prog.cob:10: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob: in paragraph 'MAIN':
prog.cob:18: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob:20: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob:22: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob:24: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob:26: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
prog.cob:29: error: ENTRY FOR GO TO does not conform to Micro Focus COBOL
])

AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob:10: warning: ENTRY FOR GO TO used
prog.cob: in paragraph 'MAIN':
prog.cob:18: warning: ENTRY FOR GO TO used
prog.cob:20: warning: ENTRY FOR GO TO used
prog.cob:22: warning: ENTRY FOR GO TO used
prog.cob:24: warning: ENTRY FOR GO TO used
prog.cob:26: warning: ENTRY FOR GO TO used
prog.cob:29: warning: ENTRY FOR GO TO used
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[STMT05
STMT05
STMT04
STMT05
STMT03
STMT04
STMT05
STMT03
STMT04
STMT03
STMT04
STMT03
STMT04
STMT05
STMT01
STMT03
STMT04
STMT03
STMT04
STMT03
STMT04
STMT05
NOT JUMPED
], [])

AT_CLEANUP


AT_SETUP([PERFORM VARYING Float])
AT_KEYWORDS([Perform])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  i USAGE FLOAT-LONG.

       PROCEDURE DIVISION.
           PERFORM VARYING i FROM 1.0 BY 1.0 UNTIL i > 5.0
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 1 Completed".
           PERFORM VARYING i FROM 1 BY 1 UNTIL i > 5
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 2 Completed".
           PERFORM VARYING i FROM 5 BY -1 UNTIL i < 1
                 DISPLAY i " " NO ADVANCING
           END-PERFORM .
           DISPLAY "Test Part 3 Completed".
           STOP RUN.
           END PROGRAM prog.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [1 2 3 4 5 Test Part 1 Completed
1 2 3 4 5 Test Part 2 Completed
5 4 3 2 1 Test Part 3 Completed
], [])

AT_CLEANUP


AT_SETUP([Test PICTURE with Edit mask])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TST.
           05 DEPT-SUB        PIC 9(7)V999 VALUE 18536.232.
           05 DEPT-COST-YTD   PIC 9(5)V999 VALUE 18536.232.
           05 DL-PROD-COST    PIC $$$,$$9.99.
       77  WFLT  PIC $$$,$$9.99.

       PROCEDURE DIVISION.
           MOVE 18536.23 TO WFLT.
           DISPLAY "WFLT IS " WFLT.
           MULTIPLY DEPT-COST-YTD BY 1 GIVING DL-PROD-COST ROUNDED.
           DISPLAY "COST IS " DL-PROD-COST.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [WFLT IS $18,536.23
COST IS $18,536.23
], [])

AT_CLEANUP


AT_SETUP([Test PICTURE Edit mask (2)])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       77  BINVAL  PIC S99999V99 COMP VALUE -18536.23.
       01  TST.
           05  DEPOSIT-AMT     PIC -,---,--Z.ZZ.
           05  DEPOSIT-AMT9    PIC -,---,--9.99.
           05  DYYZR           PIC $$,$$$,$$$.$$-.
           05  WFLT            PIC $$$,$$9.99.

       PROCEDURE DIVISION.
           DISPLAY "  DEPOSIT-AMT9 PIC -,---,--9.99 *".
           MOVE 08536.23 TO DEPOSIT-AMT9.
           DISPLAY "+ DEPOSIT-AMT9 IS  " DEPOSIT-AMT9 " *".
           MOVE 0 TO DEPOSIT-AMT9.
           DISPLAY "0 DEPOSIT-AMT9 IS  " DEPOSIT-AMT9 " *".
           DISPLAY "+ DEPOSIT-AMT  PIC -,---,--Z.ZZ *".
           MOVE 18536.20 TO DEPOSIT-AMT.
           DISPLAY "+ DEPOSIT-AMT  IS  " DEPOSIT-AMT " *".
           MOVE -18536.23 TO DEPOSIT-AMT.
           DISPLAY "- DEPOSIT-AMT  IS  " DEPOSIT-AMT " *".
           MOVE 0 TO DEPOSIT-AMT.
           DISPLAY "0 DEPOSIT-AMT  IS  " DEPOSIT-AMT " *".
           DISPLAY "  DYYZR        PIC $$,$$$,$$$.$$- *".
           MOVE 18536 TO DYYZR.
           DISPLAY "+ DYYZR        IS  " DYYZR " *".
           MOVE 18536.23 TO DYYZR.
           DISPLAY "+ DYYZR        IS  " DYYZR " *".
           MOVE BINVAL    TO DYYZR.
           DISPLAY "- DYYZR        IS  " DYYZR " *".
           MOVE -0.05 TO DYYZR.
           DISPLAY "- DYYZR        IS  " DYYZR " *".
           MOVE 0 TO DYYZR.
           DISPLAY "0 DYYZR        IS  " DYYZR " *".
           DISPLAY "  WFLT         PIC $$$,$$9.99 *".
           MOVE  8536.23 TO WFLT.
           DISPLAY "  WFLT         IS  " WFLT " *".
           STOP RUN.
])

AT_CHECK([$COMPILE -std=default prog.cob ], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [  DEPOSIT-AMT9 PIC -,---,--9.99 *
+ DEPOSIT-AMT9 IS      8,536.23 *
0 DEPOSIT-AMT9 IS          0.00 *
+ DEPOSIT-AMT  PIC -,---,--Z.ZZ *
+ DEPOSIT-AMT  IS     18,536.20 *
- DEPOSIT-AMT  IS    -18,536.23 *
0 DEPOSIT-AMT  IS               *
  DYYZR        PIC $$,$$$,$$$.$$- *
+ DYYZR        IS     $18,536.00  *
+ DYYZR        IS     $18,536.23  *
- DYYZR        IS     $18,536.23- *
- DYYZR        IS           $.05- *
0 DYYZR        IS                 *
  WFLT         PIC $$$,$$9.99 *
  WFLT         IS   $8,536.23 *
], [])

AT_CLEANUP


AT_SETUP([COMP-3 Index])
AT_KEYWORDS([numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 WS-PAGE-NUMBER PIC 9(4) COMP-3 VALUE ZERO.
       01 WS-LINE-NUMBER PIC 9(3) VALUE ZERO.
       PROCEDURE DIVISION.
       PERFORM VARYING WS-LINE-NUMBER FROM 1 BY 1
                 UNTIL WS-LINE-NUMBER > 10
       ADD 1 TO WS-PAGE-NUMBER
       DISPLAY WS-PAGE-NUMBER
       END-PERFORM.
       STOP RUN RETURNING 0.
])

AT_CHECK([$COMPILE -std=mf -w prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [0001
0002
0003
0004
0005
0006
0007
0008
0009
0010
], [])

AT_CLEANUP


AT_SETUP([POINTER])
AT_KEYWORDS([numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 XX.
         02 XX-1           PIC X(4) VALUE "1234".
         02 XX-2           PIC X(4) VALUE "5678".
       01 P-XX-1        POINTER.
       01 P-XX-2        POINTER.
       LINKAGE          SECTION.
       01 Y2            PIC X(4).
       PROCEDURE        DIVISION.
         SET P-XX-1 TO ADDRESS OF XX-1
         SET P-XX-2 TO ADDRESS OF XX-2
         SET ADDRESS OF Y2 TO ADDRESS OF XX-1
         SET ADDRESS OF Y2 UP BY 4
         IF Y2 NOT = XX-2
            DISPLAY "Test 2 '" Y2 "'"
            END-DISPLAY
         END-IF
         IF ADDRESS OF Y2 NOT= P-XX-2
            DISPLAY "Pointer test failed"
         ELSE
            DISPLAY "Pointer test was good"
         END-IF
         STOP RUN.
])

AT_CHECK([$COMPILE -std=mf -w prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [Pointer test was good
], [])

AT_CLEANUP


AT_SETUP([Figurative constants to numeric field])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  NUM9    PIC 9(6).
       PROCEDURE DIVISION.
           MOVE SPACES TO NUM9
           DISPLAY "NUM9 value SPACES is " NUM9 "." UPON SYSOUT
           MOVE LOW-VALUES TO NUM9
           IF NUM9 = LOW-VALUES
              DISPLAY "9(6) tests OK for LOW-VALUES" UPON SYSOUT
           ELSE
              DISPLAY "9(6) Does NOT test OK for LOW-VALUES"
                 UPON SYSOUT
              IF NUM9 = ZERO
                 DISPLAY "9(6) tests as ZERO instead of LOW-VALUES"
                    UPON SYSOUT
              END-IF
           END-IF.
           MOVE HIGH-VALUES TO NUM9
           IF NUM9 = HIGH-VALUES
              DISPLAY "9(6) tests OK for HIGH-VALUES" UPON SYSOUT
           ELSE
              DISPLAY "9(6) Does NOT test OK for HIGH-VALUES"
                 UPON SYSOUT
              IF NUM9 = ZERO
                 DISPLAY "9(6) tests as ZERO instead of HIGH-VALUES"
                    UPON SYSOUT
              END-IF
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=mf prog.cob], [0], [],
[prog.cob:8: warning: source is non-numeric - substituting zero
prog.cob:10: warning: source is non-numeric - substituting zero
prog.cob:21: warning: source is non-numeric - substituting zero
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[NUM9 value SPACES is 000000.
9(6) Does NOT test OK for LOW-VALUES
9(6) tests as ZERO instead of LOW-VALUES
9(6) Does NOT test OK for HIGH-VALUES
9(6) tests as ZERO instead of HIGH-VALUES
], [])

AT_CHECK([$COMPILE -std=acu prog.cob -o aprog], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./aprog], [0],
[NUM9 value SPACES is       .
9(6) tests OK for LOW-VALUES
9(6) tests OK for HIGH-VALUES
], [])

AT_CLEANUP


AT_SETUP([Test COBOL-C interface])
AT_KEYWORDS([CALL])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  SUB-NAME PIC X(10) VALUE "SUB2".
       01  FLT9  USAGE COMP-1 VALUE 9.0.
       01  NUMPI PIC 9(6) VALUE 314.
       01  NUM5  PIC 9(5) VALUE 12345.
       01  NUM9  PIC 9(7)V99 VALUE 1234567.88.
       01  NUMED PIC Z(5)9.99CR.
       PROCEDURE DIVISION.
           CALL "SUB" USING BY VALUE 1,
                            BY REFERENCE "Fun and games for you".
           CALL "SUB" USING BY VALUE 2,
                            BY REFERENCE "More Fun and games for all".
           CALL "SUB2"   USING "Fun and games", BY VALUE 3.
           CALL SUB-NAME USING "More Fun and games ....", BY VALUE 4.
           CALL "SUB3" .
           CALL "COBCSUB" USING BY VALUE 6,
                            BY REFERENCE "Hi to C Code...".
           CALL "COBCSUB" USING BY VALUE NUMPI,
                            BY REFERENCE "Pass PI to C...".
           CALL "COBCSUB" USING BY VALUE NUM9,
                            BY REFERENCE "Pass V99 to C...".
           CALL "CSUB4" USING FLT9, "Hi from COBOL!.".
           ADD 1.4 TO FLT9.
           CALL "CSUB5" USING FLT9, "Called from COBOL instead of C!.".
           CALL "SUB6" USING NUM5.
           CALL "SUB6" USING NUM9.
           CALL "SUB6" USING NUMPI.
           CALL "SUB6" USING FLT9.
           CALL "SUB6" USING "31415926".
           MOVE 10.50 TO NUMED.
           CALL "SUB6" USING NUMED.
           MOVE -4510.66 TO NUMED.
           CALL "SUB6" USING NUMED.
           STOP RUN.
           END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID. SUB.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  xn PIC 9(8) BINARY VALUE 99.
       01  xx PIC X(13) VALUE '"x" was NULL!'.
       01  yy PIC X(8)  VALUE "Garbage!".
       LINKAGE SECTION.
       01  n PIC 9(8).
       01  x PIC X ANY LENGTH.
       01  y PIC X ANY LENGTH.
       01  z PIC X ANY LENGTH.
       01  num PIC 9 ANY NUMERIC.
       01  cn PIC 9(9) COMP-5.
       01  flt1 USAGE COMP-1.
       01  cx PIC X(15).
       PROCEDURE DIVISION USING BY VALUE n, x, BY REFERENCE y.
           DISPLAY n " '" x "'".
           EXIT PROGRAM.
       ENTRY "SUB2" USING z, BY VALUE n.
           DISPLAY n " '" z "' via SUB2".
           EXIT PROGRAM.
       ENTRY "SUB3".
           IF ADDRESS OF n = NULL
              SET ADDRESS OF n TO ADDRESS OF xn.
           IF ADDRESS OF x = NULL
              SET ADDRESS OF x TO ADDRESS OF xx.
           DISPLAY n " '" x "' via SUB3".
           EXIT PROGRAM.
       ENTRY "CSUB4" USING BY VALUE cn, BY REFERENCE cx.
           DISPLAY cn " '" cx "' via CSUB4".
           EXIT PROGRAM.
       ENTRY "CSUB5" USING BY VALUE cn, BY REFERENCE z.
           DISPLAY cn " '" z "' via CSUB5".
           EXIT PROGRAM.
       ENTRY "SUB6" USING num.
           DISPLAY 'ANY NUMERIC is ' num ' Length ' LENGTH OF num.
           EXIT PROGRAM.
       ENTRY "CSUB7" USING VALUE flt1.
           DISPLAY 'Float value is ' flt1 ' via CSUB7'.
           EXIT PROGRAM.
       ENTRY "CSUB8" USING flt1.
           DISPLAY 'Float reference is ' flt1 ' via CSUB8'.
           EXIT PROGRAM.
       END PROGRAM SUB.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <stdio.h>
extern int CSUB4();
extern int CSUB5();
extern int SUB6();
extern int CSUB7(float f);
extern int CSUB8(float *f);
int
COBCSUB(int y, unsigned char x[15])
{
   float flt1;
   printf("C routine passed: Y is %d; X is '%.15s'\n",y,x);
   CSUB4(y, x);
   CSUB4(y+1, "A C-String is being passed");
   CSUB5(y+2, "A much longer C-String is being passed");
   SUB6("314159265358");
   SUB6("31415926");
   SUB6("000314");
   flt1 = 3.1415926;
   CSUB7(flt1);
   flt1 = 2.71828;
   CSUB8(&flt1);
   return 0;
}

]])

AT_CHECK([$COMPILE -fno-areacheck -std=ibm -debug -Wall prog.cob cmod.c], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [00000001 'Fun and games for you'
00000002 'More Fun and games for all'
00000003 'Fun and games' via SUB2
00000004 'More Fun and games ....' via SUB2
00000004 'More Fun and games for all' via SUB3
C routine passed: Y is 6; X is 'Hi to C Code...'
0000000006 'Hi to C Code...' via CSUB4
0000000007 'A C-String is b' via CSUB4
0000000008 'A much longer C-String is being passed' via CSUB5
ANY NUMERIC is 314159265358 Length 0000000012
ANY NUMERIC is 31415926 Length 0000000008
ANY NUMERIC is 000314 Length 0000000006
Float value is 3.1415925 via CSUB7
Float reference is 2.7182801 via CSUB8
C routine passed: Y is 314; X is 'Pass PI to C...'
0000000314 'Pass PI to C...' via CSUB4
0000000315 'A C-String is b' via CSUB4
0000000316 'A much longer C-String is being passed' via CSUB5
ANY NUMERIC is 314159265358 Length 0000000012
ANY NUMERIC is 31415926 Length 0000000008
ANY NUMERIC is 000314 Length 0000000006
Float value is 3.1415925 via CSUB7
Float reference is 2.7182801 via CSUB8
C routine passed: Y is 1234567; X is 'Pass V99 to C..'
0001234567 'Pass V99 to C..' via CSUB4
0001234568 'A C-String is b' via CSUB4
0001234569 'A much longer C-String is being passed' via CSUB5
ANY NUMERIC is 314159265358 Length 0000000012
ANY NUMERIC is 31415926 Length 0000000008
ANY NUMERIC is 000314 Length 0000000006
Float value is 3.1415925 via CSUB7
Float reference is 2.7182801 via CSUB8
0000000009 'Hi from COBOL!.' via CSUB4
0000000010 'Called from COBOL instead of C!.' via CSUB5
ANY NUMERIC is 12345 Length 0000000005
ANY NUMERIC is 123456788 Length 0000000009
ANY NUMERIC is 000314 Length 0000000006
ANY NUMERIC is 10.4 Length 0000000004
ANY NUMERIC is 31415926 Length 0000000008
ANY NUMERIC is     10.50   Length 0000000011
ANY NUMERIC is   4510.66CR Length 0000000011
], [])

AT_CLEANUP


AT_SETUP([Test COBOL-C interface (2)])
AT_KEYWORDS([CALL])

AT_DATA([prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID. routine1.
        DATA DIVISION.
        WORKING-STORAGE SECTION.
        01 PDUMP POINTER.
        01 PNUM REDEFINES PDUMP BINARY-C-LONG.
        01 DUMMY PICTURE X(1).
        01 PN    PICTURE 9(1).
        LINKAGE SECTION.
        01 P1    PICTURE X(1).
        01 P2    PICTURE X(1).
        PROCEDURE DIVISION USING P1 P2.
            MOVE NUMBER-OF-CALL-PARAMETERS TO PN.
            DISPLAY "Now in routine1 with " PN " params"
            SET PDUMP TO ADDRESS OF P1.
            MOVE PNUM TO PN.
            DISPLAY "Expect '1' and got " PN.
            SET PDUMP TO ADDRESS OF P2.
            MOVE PNUM TO PN.
            DISPLAY "Expect '2' and got " PN.
            call "one_parameter" USING DUMMY.
            GOBACK.

            DISPLAY "Call routine2 with P2"
            call "routine2" USING P2.
            DISPLAY "Call routine2 with nothing"
            call "routine2".
            DISPLAY "Call routine2 with P2, P1"
            call "routine2" USING P2, P1.
            DISPLAY "Leaving routine1".
            GOBACK.
           END PROGRAM routine1.

        IDENTIFICATION DIVISION.
        PROGRAM-ID. routine2.
        DATA DIVISION.
        WORKING-STORAGE SECTION.
        01 PDUMP POINTER.
        01 PNUM REDEFINES PDUMP BINARY-C-LONG.
        01 DUMMY PICTURE X(1).
        01 PN    PICTURE 9(1).
        LINKAGE SECTION.
        01 P1    PICTURE X(1).
        01 P2    PICTURE X(1).
        PROCEDURE DIVISION USING P1 P2.
            MOVE NUMBER-OF-CALL-PARAMETERS TO PN.
            DISPLAY "Now in routine2 with " PN " params"
            SET PDUMP TO ADDRESS OF P1.
            MOVE PNUM TO PN.
            DISPLAY "Expect '3' and got " PN.
            SET PDUMP TO ADDRESS OF P2.
            MOVE PNUM TO PN.
            DISPLAY "Expect '4' and got " PN.
            DISPLAY "Leaving routine2".
            GOBACK.
        END PROGRAM routine2.
])

AT_DATA([cmod.c], [[
#include <stdio.h>
#include <libcob.h>

extern int routine1(void *, void *);
extern int routine2(void *, void *);

int main()
{
    cob_init(0,NULL);
    routine1((void *)(0x1),(void *)(0x2));
    return 0;
}

void one_parameter(void *dummy)
{
   printf("Now in one_parameter\n");
    routine2((void *)(0x3),(void *)(0x4));
}
]])

AT_CHECK([$COMPILE -fno-areacheck -std=ibm -o prog cmod.c prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [Now in routine1 with 2 params
Expect '1' and got 1
Expect '2' and got 2
Now in one_parameter
Now in routine2 with 2 params
Expect '3' and got 3
Expect '4' and got 4
Leaving routine2
], [])

AT_CLEANUP


AT_SETUP([COBOL2002 SYNC])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       FILE SECTION.

       WORKING-STORAGE SECTION.

       77  VLEN                   PIC 99 VALUE 1.
       77  TESTMODE               PIC 99 VALUE 1.
       77  TESTIDX                PIC 99 VALUE 1.
       77  BIT-MODE               PIC 99 VALUE 32.
       77  TESTNUM                PIC 99 VALUE 0.
       77  TESTMAX                PIC 99 VALUE 23.
       77  TESTCASE               PIC 99 VALUE 0.
       77  TESTFAIL               PIC 99 VALUE 0.
       77  TESTEND                PIC X(15) VALUE " ".
       77  TESTNAME               PIC X(10) VALUE " ".
       77  TESTRESULT             PIC X(40) VALUE " ".
       77  TESTPTR                USAGE POINTER.

       01  TEST-MODES.
           05  FILLER PIC X(10) VALUE "MF".
           05  FILLER PIC X(10) VALUE "IBMCOMP".
           05  FILLER PIC X(10) VALUE "C2002".

       01  FILLER REDEFINES TEST-MODES.
           05  FILLER             OCCURS 3 TIMES.
              10  TEST-MODE       PIC X(10).

       01  TEST-CASES.
        05 FILLER PIC X(10) VALUE "COMP-FLD1".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxx11".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD2".
        05 FILLER PIC X(40) VALUE "xxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDO".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDS".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD3".
        05 FILLER PIC X(40) VALUE "xxxxx123".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDL".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDR".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM1-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12xxx123xxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".

        05 FILLER PIC X(10) VALUE "COM2-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12345xxx1234567xxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM3-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx123xxx1234xxx1234567".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM4-FLD".
        05 FILLER PIC X(40) VALUE "x123456x1234x123456x123".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40)
           VALUE "xxxxxxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".

        05 FILLER PIC X(10) VALUE "NOSYNC".
        05 FILLER PIC X(40) VALUE "x123456x123".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SYNC".
        05 FILLER PIC X(40) VALUE "x123456x1234".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".

        05 FILLER PIC X(10) VALUE "COMP-3".
        05 FILLER PIC X(40) VALUE "x1234567x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-1".
        05 FILLER PIC X(40) VALUE "12341234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-2".
        05 FILLER PIC X(40) VALUE "1234567812345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SIGN L/T".
        05 FILLER PIC X(40) VALUE "x-01x02-x-03x04-".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-X".
        05 FILLER PIC X(40) VALUE "x123x1234567x1234x12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-SHORT".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-DBL".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".

        05 FILLER PIC X(10) VALUE "COMP-5".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x1234x1234".

        05 FILLER PIC X(10) VALUE "CMP-1".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "CMP-2".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

       01  FILLER REDEFINES TEST-CASES.
           05  FILLER             OCCURS 23 TIMES.
              10  TEST-NAME       PIC X(10).
              10  TEST-RESULTS.
                15  MF-64RESULT     PIC X(40).
                15  IBM-64RESULT    PIC X(40).
                15  C2002-64RESULT  PIC X(40).
                15  MF-32RESULT     PIC X(40).
                15  IBM-32RESULT    PIC X(40).
                15  C2002-32RESULT  PIC X(40).
              10  FILLER REDEFINES TEST-RESULTS.
                15  TEST-RESULT   PIC X(40) OCCURS 6 TIMES.

       01  TESTRECORD             PIC X(40).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC1.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD1          PICTURE S9(2) COMP.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC2.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD2          PICTURE S9(4) COMP SYNC .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC3.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD3          PICTURE S9(6) COMP SYNC.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECL.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDL          PICTURE S9(2) COMP SYNC LEFT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECR.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDR          PICTURE S9(2) COMP SYNC RIGHT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECS.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDS      PICTURE S9(4) COMP SYNC .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECO.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDO      PICTURE S9(4) COMP.
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP SYNC COMP.
         05  GRP1.
           10  FILLER             PICTURE X(5).
           10  COM1-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM1-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE X(3).
           10  COM1-FLD3          PICTURE S9(18).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP2 SIGN LEADING SEPARATE.
         05  GRP2-1.
           10  FILLER             PICTURE X(5).
           10  COM2-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM2-FLD2          PICTURE S9(6) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(3).
           10  COM2-FLD3          PICTURE S9(7).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP3 PACKED-DECIMAL.
         05  GRP3-1.
           10  FILLER             PICTURE X(5).
           10  COM3-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM3-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE X(3).
         05  GRP3-2.
           10  COM3-FLD3          PICTURE S9(13).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP4 COMP.
         05  GRP4-1 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE X(1).
           10  COM4-FLD2          PICTURE S9(7).
           10  FILLER             PICTURE X(1).
         05  GRP4-2.
           10  COM4-FLD3          PICTURE S9(13).
           10  FILLER             PICTURE X(1).
           10  COM4-FLD4          PICTURE S9(6).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5 COMP.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE X(1).
           10  COM5-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5S COMP SYNC.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD1         PICTURE S9(13).
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD2         PICTURE S9(7).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP6 PACKED-DECIMAL.
           10  FILLER             PICTURE X(1).
           10  COM6-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE X(1).
           10  COM6-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP7 FLOAT-SHORT.
           10  COM7-FLD1          .
           10  COM7-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP8 FLOAT-LONG.
           10  COM8-FLD1          .
           10  COM8-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP9.
         05  GRP9-1 SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD1          PICTURE S9(2).
           10  FILLER             PICTURE X(1).
           10  COM9-FLD2          PICTURE S9(2) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(1).
         05  GRP9-2 SIGN TRAILING SEPARATE.
           10  COM9-FLD3          PICTURE S9(2) SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD4          PICTURE S9(2).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRPX.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD1          PICTURE X(3).
           10  FILLER             PICTURE X(1).
           10  COMX-FLD2          PICTURE X(7).
           10  FILLER             PICTURE X(1).
           10  COMX-FLT           FLOAT-SHORT SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-DBL           FLOAT-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BSHORT.
           10  FILLER             PICTURE X(1).
           10  COMS-FLD1          BINARY-SHORT.
           10  FILLER             PICTURE X(2).
           10  COMS-FLD2          BINARY-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BDBL.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD1          BINARY-DOUBLE.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD2          BINARY-DOUBLE UNSIGNED SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD1          FLOAT-SHORT.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD2          FLOAT-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD1          FLOAT-LONG.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD2          FLOAT-LONG SYNC.
           10  FILLER             PICTURE X(1).

       PROCEDURE DIVISION.

           MOVE LENGTH OF TESTPTR TO VLEN.
           IF VLEN = 8
               MOVE 64     TO BIT-MODE
           ELSE
               MOVE 32     TO BIT-MODE.
           MOVE ALL "x"    TO TESTRECORD.
           MOVE 1 TO TESTMODE.
           MOVE ALL "x"    TO TSTREC2.
           MOVE "22"       TO COMP-FLD2 (1:).
           IF TSTREC2 = 'xxxxxx22'
               MOVE 3 TO TESTMODE.
           MOVE "12345678" TO COML-FLD2 (1:).
           IF COML-FLD2 = 875770417
             MOVE "Little-Endian" TO TESTEND
           ELSE
             MOVE "Big-Endian" TO TESTEND
           END-IF.
           MOVE LENGTH OF COMP-FLD1 TO VLEN.
           IF VLEN = 2
               MOVE 2 TO TESTMODE.
           MOVE ALL "x"    TO TESTRECORD.

           MOVE "COMP-FLD1" TO TESTNAME.
           MOVE "11"        TO COMP-FLD1 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLD2" TO TESTNAME.
           MOVE "22"       TO COMP-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDO" TO TESTNAME.
           MOVE "11"       TO COMP-FLDO (1) (1:2)
           MOVE "22"       TO COMP-FLDO (2) (1:2)
           MOVE "33"       TO COMP-FLDO (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLDS" TO TESTNAME.
           MOVE "11"       TO COMP-FLDS (1) (1:2)
           MOVE "22"       TO COMP-FLDS (2) (1:2)
           MOVE "33"       TO COMP-FLDS (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLD3" TO TESTNAME.
           MOVE "1234678"  TO COMP-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDL" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDL (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDR" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDR (1:).
           PERFORM CHECK-IT.

           MOVE "COM1-FLD" TO TESTNAME.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM2-FLD" TO TESTNAME.
           MOVE "12345678" TO COM2-FLD1 (1:).
           MOVE "12345678" TO COM2-FLD2 (1:).
           MOVE "12345678" TO COM2-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM3-FLD" TO TESTNAME.
           MOVE "12345678" TO COM3-FLD1 (1:).
           MOVE "12345678" TO COM3-FLD2 (1:).
           MOVE "12345678" TO COM3-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM4-FLD" TO TESTNAME.
           MOVE "12345678" TO COM4-FLD1 (1:).
           MOVE "12345678" TO COM4-FLD2 (1:).
           MOVE "12345678" TO COM4-FLD3 (1:).
           MOVE "12345678" TO COM4-FLD4 (1:).
           PERFORM CHECK-IT.

           MOVE "NOSYNC" TO TESTNAME.
           MOVE "12345678" TO COM5-FLD1 (1:).
           MOVE "12345678" TO COM5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SYNC" TO TESTNAME.
           MOVE "12345678" TO COM5S-FLD1 (1:).
           MOVE "12345678" TO COM5S-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-3" TO TESTNAME.
           MOVE "12345678" TO COM6-FLD1 (1:).
           MOVE "12345678" TO COM6-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-1" TO TESTNAME.
           MOVE "12345678" TO COM7-FLD1 (1:).
           MOVE "12345678" TO COM7-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-2" TO TESTNAME.
           MOVE "12345678" TO COM8-FLD1 (1:).
           MOVE "12345678" TO COM8-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SIGN L/T" TO TESTNAME.
           MOVE -1 TO COM9-FLD1 .
           MOVE -2 TO COM9-FLD2 .
           MOVE -3 TO COM9-FLD3 .
           MOVE -4 TO COM9-FLD4 .
           PERFORM CHECK-IT.

           MOVE "COMP-X" TO TESTNAME.
           MOVE "12345678" TO COMX-FLD1 (1:).
           MOVE "12345678" TO COMX-FLD2 (1:).
           MOVE "12345678" TO COMX-FLT (1:).
           MOVE "12345678" TO COMX-DBL (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-SHORT" TO TESTNAME.
           MOVE "12345678" TO COMS-FLD1 (1:).
           MOVE "12345678" TO COMS-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-DBL" TO TESTNAME.
           MOVE "12345678" TO COMD-FLD1 (1:).
           MOVE "12345678" TO COMD-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-5" TO TESTNAME.
           MOVE "12345678" TO CMP5-FLD1 (1:).
           MOVE "12345678" TO CMP5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-1" TO TESTNAME.
           MOVE "12345678" TO CMP1-FLD1 (1:).
           MOVE "12345678" TO CMP1-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-2" TO TESTNAME.
           MOVE "12345678" TO CMP2-FLD1 (1:).
           MOVE "12345678" TO CMP2-FLD2 (1:).
           PERFORM CHECK-IT.

           DISPLAY TESTCASE " tests & " TESTFAIL " failed".
           STOP RUN RETURNING 0.

       CHECK-IT SECTION.
       CHECK-01.
           INSPECT TESTRECORD REPLACING TRAILING 'x' BY ' '.
           ADD 1 TO TESTCASE.
           PERFORM VARYING TESTNUM FROM 1 BY 1
                     UNTIL TEST-NAME (TESTNUM) = TESTNAME
                        OR TESTNUM > TESTMAX
               CONTINUE
           END-PERFORM.
           IF TESTNUM > TESTMAX
               DISPLAY TESTNAME " :NOT FOUND"
               DISPLAY "           :   GOT: " TESTRECORD ":"
               ADD 1 TO TESTFAIL
               MOVE ALL "x"    TO TESTRECORD
               GO TO CHECK-EXIT
           END-IF.
           MOVE TEST-RESULT (TESTNUM, TESTMODE) TO TESTRESULT.
           COMPUTE TESTIDX = TESTMODE + 3.
           IF BIT-MODE = 32
           AND TEST-RESULT (TESTNUM, TESTIDX) NOT = SPACES
               MOVE TEST-RESULT (TESTNUM, TESTIDX) TO TESTRESULT.
           IF TESTRESULT = SPACES
               MOVE TEST-RESULT (TESTNUM, 1) TO TESTRESULT.
           IF TESTRESULT NOT = TESTRECORD
               DISPLAY TESTNAME
                       " :FAILED:  Mode " BIT-MODE
                       " " TEST-MODE (TESTMODE)
                       ", Case " TESTCASE ", " TESTEND
               DISPLAY "           :   GOT: " TESTRECORD ":"
               DISPLAY "           :EXPECT: " TESTRESULT ":"
               ADD 1 TO TESTFAIL
           END-IF.
           MOVE ALL "x"    TO TESTRECORD.
       CHECK-EXIT.
           EXIT.

])

AT_CHECK([$COMPILE -std=cobol2002 -w prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[23 tests & 00 failed
], [])

AT_CLEANUP


AT_SETUP([NO Subscript])
AT_KEYWORDS([LENGTH])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.

       01 DATA-SIZE  PIC 999.
       01 MY-DATA.
          03 MY-TABLE OCCURS 20 TIMES.
             05 MY-ELEMENT-1  PIC X(10).
             05 MY-ELEMENT-2  PIC 99.
       78 MY-LEN VALUE LENGTH OF MY-DATA.

       01 TBLX       PIC 99 VALUE 5.
       01 ODO-DATA.
          03 ODO-TABLE OCCURS 1 TO 15 TIMES DEPENDING ON TBLX.
             05 ODO-ELEMENT-1 PIC X(10).
             05 ODO-ELEMENT-2 PIC 99.

       PROCEDURE DIVISION.
           DISPLAY "MY-LEN       is " MY-LEN.
           MOVE LENGTH OF MY-DATA TO DATA-SIZE.
           DISPLAY "MY-DATA      is " FUNCTION LENGTH (MY-DATA)
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-ELEMENT-1 TO DATA-SIZE.
           DISPLAY "MY-ELEMENT-1 is " FUNCTION LENGTH (MY-ELEMENT-1)
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-TABLE TO DATA-SIZE.
           DISPLAY "MY-TABLE     is " LENGTH OF MY-TABLE
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-TABLE(1) TO DATA-SIZE.
           DISPLAY "MY-TABLE(1)  is " FUNCTION LENGTH (MY-TABLE(1))
                   " and " DATA-SIZE.

           MOVE LENGTH OF ODO-DATA TO DATA-SIZE.
           DISPLAY "ODO-DATA a   is " FUNCTION LENGTH (ODO-DATA)
                   " and " DATA-SIZE.
           MOVE FUNCTION LENGTH (ODO-DATA) TO DATA-SIZE.
           DISPLAY "ODO-DATA b   is " LENGTH OF ODO-DATA
                   " and " DATA-SIZE.
           MOVE LENGTH OF ODO-TABLE TO DATA-SIZE.
           DISPLAY "ODO-TABLE    is " LENGTH OF ODO-TABLE
                   " and " DATA-SIZE.
           MOVE LENGTH OF ODO-TABLE(1) TO DATA-SIZE.
           DISPLAY "ODO-TABLE(1) is " FUNCTION LENGTH (ODO-TABLE(1))
                   " and " DATA-SIZE.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=mf prog.cob], [0], [],
[prog.cob:28: warning: subscript missing for 'MY-ELEMENT-1' - defaulting to 1
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[MY-LEN       is 240
MY-DATA      is 240 and 240
MY-ELEMENT-1 is 10 and 010
MY-TABLE     is 12 and 012
MY-TABLE(1)  is 12 and 012
ODO-DATA a   is 60 and 060
ODO-DATA b   is 60 and 060
ODO-TABLE    is 12 and 012
ODO-TABLE(1) is 12 and 012
], [])

AT_CLEANUP


AT_SETUP([NO Subscript ACU])
AT_KEYWORDS([ACU LENGTH])
AT_SKIP_IF(true)

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.

       01 DATA-SIZE  PIC 999.
       01 MY-DATA.
          03 MY-TABLE OCCURS 20 TIMES.
             05 MY-ELEMENT-1  PIC X(10).
             05 MY-ELEMENT-2  PIC 99.
       78 MY-LEN VALUE LENGTH OF MY-DATA.

       01 TBLX       PIC 99 VALUE 5.
       01 ODO-DATA.
          03 ODO-TABLE OCCURS 1 TO 15 TIMES DEPENDING ON TBLX.
             05 ODO-ELEMENT-1 PIC X(10).
             05 ODO-ELEMENT-2 PIC 99.

       PROCEDURE DIVISION.
           DISPLAY "MY-LEN       is " MY-LEN.
           MOVE LENGTH OF MY-DATA TO DATA-SIZE.
           DISPLAY "MY-DATA      is " FUNCTION LENGTH (MY-DATA)
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-ELEMENT-1 TO DATA-SIZE.
           DISPLAY "MY-ELEMENT-1 is " FUNCTION LENGTH (MY-ELEMENT-1)
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-TABLE TO DATA-SIZE.
           DISPLAY "MY-TABLE     is " LENGTH OF MY-TABLE
                   " and " DATA-SIZE.
           MOVE LENGTH OF MY-TABLE(1) TO DATA-SIZE.
           DISPLAY "MY-TABLE(1)  is " FUNCTION LENGTH (MY-TABLE(1))
                   " and " DATA-SIZE.

           MOVE LENGTH OF ODO-DATA TO DATA-SIZE.
           DISPLAY "ODO-DATA a   is " FUNCTION LENGTH (ODO-DATA)
                   " and " DATA-SIZE.
           MOVE FUNCTION LENGTH (ODO-DATA) TO DATA-SIZE.
           DISPLAY "ODO-DATA b   is " LENGTH OF ODO-DATA
                   " and " DATA-SIZE.
           MOVE LENGTH OF ODO-TABLE TO DATA-SIZE.
           DISPLAY "ODO-TABLE    is " LENGTH OF ODO-TABLE
                   " and " DATA-SIZE.
           MOVE LENGTH OF ODO-TABLE(1) TO DATA-SIZE.
           DISPLAY "ODO-TABLE(1) is " FUNCTION LENGTH (ODO-TABLE(1))
                   " and " DATA-SIZE.
           STOP RUN.
])

AT_CHECK([$COMPILE -std=acu prog.cob], [0], [],
[prog.cob:28: warning: subscript missing for 'MY-ELEMENT-1' - defaulting to 1
])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[MY-LEN       is 0000000240
MY-DATA      is 0000000240 and 240
MY-ELEMENT-1 is 0000000010 and 010
MY-TABLE     is 0000000240 and 240
MY-TABLE(1)  is 0000000012 and 012
ODO-DATA a   is 0000000060 and 180
ODO-DATA b   is 0000000180 and 060
ODO-TABLE    is 0000000180 and 180
ODO-TABLE(1) is 0000000012 and 012
], [])

AT_CLEANUP


AT_SETUP([IBM SYNC])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       FILE SECTION.

       WORKING-STORAGE SECTION.

       77  VLEN                   PIC 99 VALUE 1.
       77  TESTMODE               PIC 99 VALUE 1.
       77  TESTIDX                PIC 99 VALUE 1.
       77  BIT-MODE               PIC 99 VALUE 32.
       77  TESTNUM                PIC 99 VALUE 0.
       77  TESTMAX                PIC 99 VALUE 24.
       77  TESTCASE               PIC 99 VALUE 0.
       77  TESTFAIL               PIC 99 VALUE 0.
       77  TESTEND                PIC X(15) VALUE " ".
       77  TESTNAME               PIC X(10) VALUE " ".
       77  TESTRESULT             PIC X(40) VALUE " ".
       77  TESTPTR                USAGE POINTER.

       01  TEST-MODES.
           05  FILLER PIC X(10) VALUE "MF".
           05  FILLER PIC X(10) VALUE "IBMCOMP".
           05  FILLER PIC X(10) VALUE "DEFAULT".

       01  FILLER REDEFINES TEST-MODES.
           05  FILLER             OCCURS 3 TIMES.
              10  TEST-MODE       PIC X(10).

       01  TEST-CASES.
        05 FILLER PIC X(10) VALUE "COMP-FLD1".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxx11".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD2".
        05 FILLER PIC X(40) VALUE "xxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDO".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDS".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD3".
        05 FILLER PIC X(40) VALUE "xxxxx123".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDL".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDR".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM1-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12xxx123xxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".

        05 FILLER PIC X(10) VALUE "COM2-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12345xxx1234567xxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM3-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx123xxx1234xxx1234567".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM4-FLD".
        05 FILLER PIC X(40) VALUE "x123456x1234x123456x123".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40)
           VALUE "xxxxxxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".

        05 FILLER PIC X(10) VALUE "NOSYNC".
        05 FILLER PIC X(40) VALUE "x123456x123".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SYNC".
        05 FILLER PIC X(40) VALUE "x123456x1234".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".

        05 FILLER PIC X(10) VALUE "COMP-3".
        05 FILLER PIC X(40) VALUE "x1234567x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-1".
        05 FILLER PIC X(40) VALUE "12341234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-2".
        05 FILLER PIC X(40) VALUE "1234567812345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SIGN L/T".
        05 FILLER PIC X(40) VALUE "x-01x02-x-03x04-".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-X".
        05 FILLER PIC X(40) VALUE "x123x1234567x1234x12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-SHORT".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-DBL".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "BIN-LNG".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".

        05 FILLER PIC X(10) VALUE "COMP-5".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "CMP-1".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "CMP-2".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

       01  FILLER REDEFINES TEST-CASES.
           05  FILLER             OCCURS 24 TIMES.
              10  TEST-NAME       PIC X(10).
              10  TEST-RESULTS.
                15  MF-64RESULT     PIC X(40).
                15  IBM-64RESULT    PIC X(40).
                15  C2002-64RESULT  PIC X(40).
                15  MF-32RESULT     PIC X(40).
                15  IBM-32RESULT    PIC X(40).
                15  C2002-32RESULT  PIC X(40).
              10  FILLER REDEFINES TEST-RESULTS.
                15  TEST-RESULT   PIC X(40) OCCURS 6 TIMES.

       01  TESTRECORD             PIC X(40).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC1.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD1          PICTURE S9(2) COMP-4.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC2.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD2          PICTURE S9(4) COMP-4 SYNC .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC3.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD3          PICTURE S9(6) COMP-4 SYNC.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECL.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDL          PICTURE S9(2) COMP-4 SYNC LEFT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECR.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDR          PICTURE S9(2) COMP-4 SYNC RIGHT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECS.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDS      PICTURE S9(4) COMP-4 SYNC .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECO.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDO      PICTURE S9(4) COMP-4 .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP.
         05  GRP1.
           10  FILLER             PICTURE X(5).
           10  COM1-FLD1          PICTURE S9(4) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD2          PICTURE S9(6) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD3          PICTURE S9(18) SYNC COMP-4.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP2 SIGN LEADING SEPARATE.
         05  GRP2-1.
           10  FILLER             PICTURE X(5).
           10  COM2-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM2-FLD2          PICTURE S9(6) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(3).
           10  COM2-FLD3          PICTURE S9(7).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP3.
         05  GRP3-1.
           10  FILLER             PICTURE X(5).
           10  COM3-FLD1          PICTURE S9(4) COMP-3.
           10  FILLER             PICTURE X(3).
           10  COM3-FLD2          PICTURE S9(6) COMP-3.
           10  FILLER             PICTURE X(3).
         05  GRP3-2.
           10  COM3-FLD3          PICTURE S9(13) COMP-3.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP4.
         05  GRP4-1.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD1          PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD2          PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
         05  GRP4-2.
           10  COM4-FLD3          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD4          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD1          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD2          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5S.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD1         PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD2         PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP6 COMP-3.
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE 9(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP7 COMP-1.
           10  COM7-FLD1          .
           10  COM7-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP8 COMP-2.
           10  COM8-FLD1          .
           10  COM8-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP9.
         05  GRP9-1 SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD1          PICTURE S9(2).
           10  FILLER             PICTURE X(1).
           10  COM9-FLD2          PICTURE S9(2) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(1).
         05  GRP9-2 SIGN TRAILING SEPARATE.
           10  COM9-FLD3          PICTURE S9(2) SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD4          PICTURE S9(2).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRPX.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD1          PICTURE X(3) COMP-X SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD2          PICTURE X(7) COMP-X.
           10  FILLER             PICTURE X(1).
           10  COMX-FLT           COMP-1 SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-DBL           COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BSHORT.
           10  FILLER             PICTURE X(1).
           10  COMS-FLD1          BINARY-SHORT.
           10  FILLER             PICTURE X(2).
           10  COMS-FLD2          BINARY-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BDBL.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD1          BINARY-DOUBLE.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD2          BINARY-DOUBLE SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLNG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD1         BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD2         BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD1          PIC 9(18) COMP-5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD2          PIC 9(18) COMP-5 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD1          COMP-1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD2          COMP-1 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD1          COMP-2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD2          COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       PROCEDURE DIVISION.

           MOVE LENGTH OF TESTPTR TO VLEN.
           IF VLEN EQUAL 8
               MOVE 64     TO BIT-MODE
           ELSE
               MOVE 32     TO BIT-MODE.
           MOVE ALL "x"    TO TESTRECORD.
           MOVE 1 TO TESTMODE.
           MOVE ALL "x"    TO TSTREC2.
           MOVE "22"       TO COMP-FLD2 (1:).
           IF TSTREC2 = 'xxxxxx22'
               MOVE 3 TO TESTMODE.
           MOVE "12345678" TO COML-FLD2 (1:).
           IF COML-FLD2 = 875770417
             MOVE "Little-Endian" TO TESTEND
           ELSE
             MOVE "Big-Endian" TO TESTEND
           END-IF.
           MOVE LENGTH OF COMP-FLD1 TO VLEN.
           IF VLEN = 2
               MOVE 2 TO TESTMODE.
           MOVE ALL "x"    TO TESTRECORD.

           MOVE "COMP-FLD1" TO TESTNAME.
           MOVE "11"        TO COMP-FLD1 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLD2" TO TESTNAME.
           MOVE "22"       TO COMP-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDO" TO TESTNAME.
           MOVE "11"       TO COMP-FLDO (1) (1:2)
           MOVE "22"       TO COMP-FLDO (2) (1:2)
           MOVE "33"       TO COMP-FLDO (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLDS" TO TESTNAME.
           MOVE "11"       TO COMP-FLDS (1) (1:2)
           MOVE "22"       TO COMP-FLDS (2) (1:2)
           MOVE "33"       TO COMP-FLDS (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLD3" TO TESTNAME.
           MOVE "1234678"  TO COMP-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDL" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDL (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDR" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDR (1:).
           PERFORM CHECK-IT.

           MOVE "COM1-FLD" TO TESTNAME.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM2-FLD" TO TESTNAME.
           MOVE "12345678" TO COM2-FLD1 (1:).
           MOVE "12345678" TO COM2-FLD2 (1:).
           MOVE "12345678" TO COM2-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM3-FLD" TO TESTNAME.
           MOVE "12345678" TO COM3-FLD1 (1:).
           MOVE "12345678" TO COM3-FLD2 (1:).
           MOVE "12345678" TO COM3-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM4-FLD" TO TESTNAME.
           MOVE "12345678" TO COM4-FLD1 (1:).
           MOVE "12345678" TO COM4-FLD2 (1:).
           MOVE "12345678" TO COM4-FLD3 (1:).
           MOVE "12345678" TO COM4-FLD4 (1:).
           PERFORM CHECK-IT.

           MOVE "NOSYNC" TO TESTNAME.
           MOVE "12345678" TO COM5-FLD1 (1:).
           MOVE "12345678" TO COM5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SYNC" TO TESTNAME.
           MOVE "12345678" TO COM5S-FLD1 (1:).
           MOVE "12345678" TO COM5S-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-3" TO TESTNAME.
           MOVE "12345678" TO COM6-FLD1 (1:).
           MOVE "12345678" TO COM6-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-1" TO TESTNAME.
           MOVE "12345678" TO COM7-FLD1 (1:).
           MOVE "12345678" TO COM7-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-2" TO TESTNAME.
           MOVE "12345678" TO COM8-FLD1 (1:).
           MOVE "12345678" TO COM8-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SIGN L/T" TO TESTNAME.
           MOVE -1 TO COM9-FLD1 .
           MOVE -2 TO COM9-FLD2 .
           MOVE -3 TO COM9-FLD3 .
           MOVE -4 TO COM9-FLD4 .
           PERFORM CHECK-IT.

           MOVE "COMP-X" TO TESTNAME.
           MOVE "12345678" TO COMX-FLD1 (1:).
           MOVE "12345678" TO COMX-FLD2 (1:).
           MOVE "12345678" TO COMX-FLT (1:).
           MOVE "12345678" TO COMX-DBL (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-SHORT" TO TESTNAME.
           MOVE "12345678" TO COMS-FLD1 (1:).
           MOVE "12345678" TO COMS-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-DBL" TO TESTNAME.
           MOVE "12345678" TO COMD-FLD1 (1:).
           MOVE "12345678" TO COMD-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-LNG" TO TESTNAME.
           MOVE "12345678" TO COMBL-FLD1 (1:).
           MOVE "12345678" TO COMBL-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-5" TO TESTNAME.
           MOVE "12345678" TO CMP5-FLD1 (1:).
           MOVE "12345678" TO CMP5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-1" TO TESTNAME.
           MOVE "12345678" TO CMP1-FLD1 (1:).
           MOVE "12345678" TO CMP1-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-2" TO TESTNAME.
           MOVE "12345678" TO CMP2-FLD1 (1:).
           MOVE "12345678" TO CMP2-FLD2 (1:).
           PERFORM CHECK-IT.

           DISPLAY TEST-MODE (TESTMODE)
                   TESTCASE " tests with " TESTFAIL " failed"
                   WITH NO ADVANCING.
           STOP RUN RETURNING 0.

       CHECK-IT SECTION.
       CHECK-01.
           INSPECT TESTRECORD REPLACING TRAILING 'x' BY ' '.
           ADD 1 TO TESTCASE.
           PERFORM VARYING TESTNUM FROM 1 BY 1
                     UNTIL TEST-NAME (TESTNUM) = TESTNAME
                        OR TESTNUM > TESTMAX
              CONTINUE
           END-PERFORM.
           IF TESTNUM > TESTMAX
               DISPLAY TESTNAME " :NOT FOUND"
               DISPLAY "           :   GOT: " TESTRECORD ":"
               ADD 1 TO TESTFAIL
               MOVE ALL "x"    TO TESTRECORD
               GO TO CHECK-EXIT
           END-IF.
           MOVE TEST-RESULT (TESTNUM, TESTMODE) TO TESTRESULT.
           COMPUTE TESTIDX = TESTMODE + 3.
           IF BIT-MODE = 32
           AND TEST-RESULT (TESTNUM, TESTIDX) NOT = SPACES
               MOVE TEST-RESULT (TESTNUM, TESTIDX) TO TESTRESULT.
           IF TESTRESULT = SPACES
               MOVE TEST-RESULT (TESTNUM, 1) TO TESTRESULT.
           IF TESTRESULT NOT = TESTRECORD
               DISPLAY TESTNAME
                       " :FAILED:  Mode " BIT-MODE
                       " " TEST-MODE (TESTMODE)
                       ", Case " TESTCASE ", " TESTEND
               DISPLAY "           :   GOT: " TESTRECORD ":"
               DISPLAY "           :EXPECT: " TESTRESULT ":"
               ADD 1 TO TESTFAIL
           END-IF.
           MOVE ALL "x"    TO TESTRECORD.
       CHECK-EXIT.
           EXIT.

])

AT_CHECK([$COMPILE -w -std=ibm prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[IBMCOMP   24 tests with 00 failed], [])

AT_CLEANUP


AT_SETUP([MF IBMCOMP SYNC])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       FILE SECTION.

       WORKING-STORAGE SECTION.

       77  VLEN                   PIC 99 VALUE 1.
       77  TESTMODE               PIC 99 VALUE 1.
       77  TESTIDX                PIC 99 VALUE 1.
       77  BIT-MODE               PIC 99 VALUE 32.
       77  TESTNUM                PIC 99 VALUE 0.
       77  TESTMAX                PIC 99 VALUE 24.
       77  TESTCASE               PIC 99 VALUE 0.
       77  TESTFAIL               PIC 99 VALUE 0.
       77  TESTEND                PIC X(15) VALUE " ".
       77  TESTNAME               PIC X(10) VALUE " ".
       77  TESTRESULT             PIC X(40) VALUE " ".
       77  TESTPTR                USAGE POINTER.

       01  TEST-MODES.
           05  FILLER PIC X(10) VALUE "MF".
           05  FILLER PIC X(10) VALUE "IBMCOMP".
           05  FILLER PIC X(10) VALUE "DEFAULT".

       01  FILLER REDEFINES TEST-MODES.
           05  FILLER             OCCURS 3 TIMES.
              10  TEST-MODE       PIC X(10).

       01  TEST-CASES.
        05 FILLER PIC X(10) VALUE "COMP-FLD1".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxx11".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD2".
        05 FILLER PIC X(40) VALUE "xxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDO".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDS".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD3".
        05 FILLER PIC X(40) VALUE "xxxxx123".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDL".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDR".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM1-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12xxx123xxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".

        05 FILLER PIC X(10) VALUE "COM2-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12345xxx1234567xxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM3-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx123xxx1234xxx1234567".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM4-FLD".
        05 FILLER PIC X(40) VALUE "x123456x1234x123456x123".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40)
           VALUE "xxxxxxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".

        05 FILLER PIC X(10) VALUE "NOSYNC".
        05 FILLER PIC X(40) VALUE "x123456x123".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SYNC".
        05 FILLER PIC X(40) VALUE "x123456x1234".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".

        05 FILLER PIC X(10) VALUE "COMP-3".
        05 FILLER PIC X(40) VALUE "x1234567x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-1".
        05 FILLER PIC X(40) VALUE "12341234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-2".
        05 FILLER PIC X(40) VALUE "1234567812345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SIGN L/T".
        05 FILLER PIC X(40) VALUE "x-01x02-x-03x04-".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-X".
        05 FILLER PIC X(40) VALUE "x123x1234567x1234x12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-SHORT".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-DBL".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "BIN-LNG".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".

        05 FILLER PIC X(10) VALUE "COMP-5".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "CMP-1".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "CMP-2".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

       01  FILLER REDEFINES TEST-CASES.
           05  FILLER             OCCURS 24 TIMES.
              10  TEST-NAME       PIC X(10).
              10  TEST-RESULTS.
                15  MF-64RESULT     PIC X(40).
                15  IBM-64RESULT    PIC X(40).
                15  C2002-64RESULT  PIC X(40).
                15  MF-32RESULT     PIC X(40).
                15  IBM-32RESULT    PIC X(40).
                15  C2002-32RESULT  PIC X(40).
              10  FILLER REDEFINES TEST-RESULTS.
                15  TEST-RESULT   PIC X(40) OCCURS 6 TIMES.

       01  TESTRECORD             PIC X(40).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC1.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD1          PICTURE S9(2) COMP-4.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC2.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD2          PICTURE S9(4) COMP-4 SYNC .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC3.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD3          PICTURE S9(6) COMP-4 SYNC.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECL.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDL          PICTURE S9(2) COMP-4 SYNC LEFT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECR.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDR          PICTURE S9(2) COMP-4 SYNC RIGHT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECS.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDS      PICTURE S9(4) COMP-4 SYNC .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECO.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDO      PICTURE S9(4) COMP-4 .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP.
         05  GRP1.
           10  FILLER             PICTURE X(5).
           10  COM1-FLD1          PICTURE S9(4) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD2          PICTURE S9(6) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD3          PICTURE S9(18) SYNC COMP-4.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP2 SIGN LEADING SEPARATE.
         05  GRP2-1.
           10  FILLER             PICTURE X(5).
           10  COM2-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM2-FLD2          PICTURE S9(6) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(3).
           10  COM2-FLD3          PICTURE S9(7).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP3.
         05  GRP3-1.
           10  FILLER             PICTURE X(5).
           10  COM3-FLD1          PICTURE S9(4) COMP-3.
           10  FILLER             PICTURE X(3).
           10  COM3-FLD2          PICTURE S9(6) COMP-3.
           10  FILLER             PICTURE X(3).
         05  GRP3-2.
           10  COM3-FLD3          PICTURE S9(13) COMP-3.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP4.
         05  GRP4-1.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD1          PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD2          PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
         05  GRP4-2.
           10  COM4-FLD3          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD4          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD1          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD2          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5S.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD1         PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD2         PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP6 COMP-3.
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE 9(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP7 COMP-1.
           10  COM7-FLD1          .
           10  COM7-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP8 COMP-2.
           10  COM8-FLD1          .
           10  COM8-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP9.
         05  GRP9-1 SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD1          PICTURE S9(2).
           10  FILLER             PICTURE X(1).
           10  COM9-FLD2          PICTURE S9(2) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(1).
         05  GRP9-2 SIGN TRAILING SEPARATE.
           10  COM9-FLD3          PICTURE S9(2) SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD4          PICTURE S9(2).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRPX.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD1          PICTURE X(3) COMP-X SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD2          PICTURE X(7) COMP-X.
           10  FILLER             PICTURE X(1).
           10  COMX-FLT           COMP-1 SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-DBL           COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BSHORT.
           10  FILLER             PICTURE X(1).
           10  COMS-FLD1          BINARY-SHORT.
           10  FILLER             PICTURE X(2).
           10  COMS-FLD2          BINARY-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BDBL.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD1          BINARY-DOUBLE.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD2          BINARY-DOUBLE SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLNG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD1         BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD2         BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD1          PIC 9(18) COMP-5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD2          PIC 9(18) COMP-5 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD1          COMP-1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD2          COMP-1 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD1          COMP-2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD2          COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       PROCEDURE DIVISION.

           MOVE LENGTH OF TESTPTR TO VLEN.
           IF VLEN EQUAL 8
               MOVE 64     TO BIT-MODE
           ELSE
               MOVE 32     TO BIT-MODE.
           MOVE ALL "x"    TO TESTRECORD.
           MOVE 1 TO TESTMODE.
           MOVE ALL "x"    TO TSTREC2.
           MOVE "22"       TO COMP-FLD2 (1:).
           IF TSTREC2 = 'xxxxxx22'
               MOVE 3 TO TESTMODE.
           MOVE "12345678" TO COML-FLD2 (1:).
           IF COML-FLD2 = 875770417
             MOVE "Little-Endian" TO TESTEND
           ELSE
             MOVE "Big-Endian" TO TESTEND
           END-IF.
           MOVE LENGTH OF COMP-FLD1 TO VLEN.
           IF VLEN = 2
               MOVE 2 TO TESTMODE.
           MOVE ALL "x"    TO TESTRECORD.

           MOVE "COMP-FLD1" TO TESTNAME.
           MOVE "11"        TO COMP-FLD1 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLD2" TO TESTNAME.
           MOVE "22"       TO COMP-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDO" TO TESTNAME.
           MOVE "11"       TO COMP-FLDO (1) (1:2)
           MOVE "22"       TO COMP-FLDO (2) (1:2)
           MOVE "33"       TO COMP-FLDO (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLDS" TO TESTNAME.
           MOVE "11"       TO COMP-FLDS (1) (1:2)
           MOVE "22"       TO COMP-FLDS (2) (1:2)
           MOVE "33"       TO COMP-FLDS (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLD3" TO TESTNAME.
           MOVE "1234678"  TO COMP-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDL" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDL (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDR" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDR (1:).
           PERFORM CHECK-IT.

           MOVE "COM1-FLD" TO TESTNAME.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM2-FLD" TO TESTNAME.
           MOVE "12345678" TO COM2-FLD1 (1:).
           MOVE "12345678" TO COM2-FLD2 (1:).
           MOVE "12345678" TO COM2-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM3-FLD" TO TESTNAME.
           MOVE "12345678" TO COM3-FLD1 (1:).
           MOVE "12345678" TO COM3-FLD2 (1:).
           MOVE "12345678" TO COM3-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM4-FLD" TO TESTNAME.
           MOVE "12345678" TO COM4-FLD1 (1:).
           MOVE "12345678" TO COM4-FLD2 (1:).
           MOVE "12345678" TO COM4-FLD3 (1:).
           MOVE "12345678" TO COM4-FLD4 (1:).
           PERFORM CHECK-IT.

           MOVE "NOSYNC" TO TESTNAME.
           MOVE "12345678" TO COM5-FLD1 (1:).
           MOVE "12345678" TO COM5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SYNC" TO TESTNAME.
           MOVE "12345678" TO COM5S-FLD1 (1:).
           MOVE "12345678" TO COM5S-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-3" TO TESTNAME.
           MOVE "12345678" TO COM6-FLD1 (1:).
           MOVE "12345678" TO COM6-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-1" TO TESTNAME.
           MOVE "12345678" TO COM7-FLD1 (1:).
           MOVE "12345678" TO COM7-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-2" TO TESTNAME.
           MOVE "12345678" TO COM8-FLD1 (1:).
           MOVE "12345678" TO COM8-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SIGN L/T" TO TESTNAME.
           MOVE -1 TO COM9-FLD1 .
           MOVE -2 TO COM9-FLD2 .
           MOVE -3 TO COM9-FLD3 .
           MOVE -4 TO COM9-FLD4 .
           PERFORM CHECK-IT.

           MOVE "COMP-X" TO TESTNAME.
           MOVE "12345678" TO COMX-FLD1 (1:).
           MOVE "12345678" TO COMX-FLD2 (1:).
           MOVE "12345678" TO COMX-FLT (1:).
           MOVE "12345678" TO COMX-DBL (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-SHORT" TO TESTNAME.
           MOVE "12345678" TO COMS-FLD1 (1:).
           MOVE "12345678" TO COMS-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-DBL" TO TESTNAME.
           MOVE "12345678" TO COMD-FLD1 (1:).
           MOVE "12345678" TO COMD-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-LNG" TO TESTNAME.
           MOVE "12345678" TO COMBL-FLD1 (1:).
           MOVE "12345678" TO COMBL-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-5" TO TESTNAME.
           MOVE "12345678" TO CMP5-FLD1 (1:).
           MOVE "12345678" TO CMP5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-1" TO TESTNAME.
           MOVE "12345678" TO CMP1-FLD1 (1:).
           MOVE "12345678" TO CMP1-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-2" TO TESTNAME.
           MOVE "12345678" TO CMP2-FLD1 (1:).
           MOVE "12345678" TO CMP2-FLD2 (1:).
           PERFORM CHECK-IT.

           DISPLAY TEST-MODE (TESTMODE)
                   TESTCASE " tests with " TESTFAIL " failed"
                   WITH NO ADVANCING.
           STOP RUN RETURNING 0.

       CHECK-IT SECTION.
       CHECK-01.
           INSPECT TESTRECORD REPLACING TRAILING 'x' BY ' '.
           ADD 1 TO TESTCASE.
           PERFORM VARYING TESTNUM FROM 1 BY 1
                     UNTIL TEST-NAME (TESTNUM) = TESTNAME
                        OR TESTNUM > TESTMAX
              CONTINUE
           END-PERFORM.
           IF TESTNUM > TESTMAX
               DISPLAY TESTNAME " :NOT FOUND"
               DISPLAY "           :   GOT: " TESTRECORD ":"
               ADD 1 TO TESTFAIL
               MOVE ALL "x"    TO TESTRECORD
               GO TO CHECK-EXIT
           END-IF.
           MOVE TEST-RESULT (TESTNUM, TESTMODE) TO TESTRESULT.
           COMPUTE TESTIDX = TESTMODE + 3.
           IF BIT-MODE = 32
           AND TEST-RESULT (TESTNUM, TESTIDX) NOT = SPACES
               MOVE TEST-RESULT (TESTNUM, TESTIDX) TO TESTRESULT.
           IF TESTRESULT = SPACES
               MOVE TEST-RESULT (TESTNUM, 1) TO TESTRESULT.
           IF TESTRESULT NOT = TESTRECORD
               DISPLAY TESTNAME
                       " :FAILED:  Mode " BIT-MODE
                       " " TEST-MODE (TESTMODE)
                       ", Case " TESTCASE ", " TESTEND
               DISPLAY "           :   GOT: " TESTRECORD ":"
               DISPLAY "           :EXPECT: " TESTRESULT ":"
               ADD 1 TO TESTFAIL
           END-IF.
           MOVE ALL "x"    TO TESTRECORD.
       CHECK-EXIT.
           EXIT.

])

AT_CHECK([$COMPILE -w -fibmcomp prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[IBMCOMP   24 tests with 00 failed], [])

AT_CLEANUP


AT_SETUP([MF SYNC])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       FILE SECTION.

       WORKING-STORAGE SECTION.

       77  VLEN                   PIC 99 VALUE 1.
       77  TESTMODE               PIC 99 VALUE 1.
       77  TESTIDX                PIC 99 VALUE 1.
       77  BIT-MODE               PIC 99 VALUE 32.
       77  TESTNUM                PIC 99 VALUE 0.
       77  TESTMAX                PIC 99 VALUE 24.
       77  TESTCASE               PIC 99 VALUE 0.
       77  TESTFAIL               PIC 99 VALUE 0.
       77  TESTEND                PIC X(15) VALUE " ".
       77  TESTNAME               PIC X(10) VALUE " ".
       77  TESTRESULT             PIC X(40) VALUE " ".
       77  TESTPTR                USAGE POINTER.

       01  TEST-MODES.
           05  FILLER PIC X(10) VALUE "MF".
           05  FILLER PIC X(10) VALUE "IBMCOMP".
           05  FILLER PIC X(10) VALUE "DEFAULT".

       01  FILLER REDEFINES TEST-MODES.
           05  FILLER             OCCURS 3 TIMES.
              10  TEST-MODE       PIC X(10).

       01  TEST-CASES.
        05 FILLER PIC X(10) VALUE "COMP-FLD1".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxx11".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD2".
        05 FILLER PIC X(40) VALUE "xxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDO".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDS".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD3".
        05 FILLER PIC X(40) VALUE "xxxxx123".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDL".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDR".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM1-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12xxx123xxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".

        05 FILLER PIC X(10) VALUE "COM2-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12345xxx1234567xxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM3-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx123xxx1234xxx1234567".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM4-FLD".
        05 FILLER PIC X(40) VALUE "x123456x1234x123456x123".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40)
           VALUE "xxxxxxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".

        05 FILLER PIC X(10) VALUE "NOSYNC".
        05 FILLER PIC X(40) VALUE "x123456x123".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SYNC".
        05 FILLER PIC X(40) VALUE "x123456x1234".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".

        05 FILLER PIC X(10) VALUE "COMP-3".
        05 FILLER PIC X(40) VALUE "x1234567x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-1".
        05 FILLER PIC X(40) VALUE "12341234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-2".
        05 FILLER PIC X(40) VALUE "1234567812345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SIGN L/T".
        05 FILLER PIC X(40) VALUE "x-01x02-x-03x04-".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-X".
        05 FILLER PIC X(40) VALUE "x123x1234567x1234x12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-SHORT".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-DBL".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "BIN-LNG".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".

        05 FILLER PIC X(10) VALUE "COMP-5".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "CMP-1".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "CMP-2".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

       01  FILLER REDEFINES TEST-CASES.
           05  FILLER             OCCURS 24 TIMES.
              10  TEST-NAME       PIC X(10).
              10  TEST-RESULTS.
                15  MF-64RESULT     PIC X(40).
                15  IBM-64RESULT    PIC X(40).
                15  C2002-64RESULT  PIC X(40).
                15  MF-32RESULT     PIC X(40).
                15  IBM-32RESULT    PIC X(40).
                15  C2002-32RESULT  PIC X(40).
              10  FILLER REDEFINES TEST-RESULTS.
                15  TEST-RESULT   PIC X(40) OCCURS 6 TIMES.

       01  TESTRECORD             PIC X(40).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC1.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD1          PICTURE S9(2) COMP-4.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC2.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD2          PICTURE S9(4) COMP-4 SYNC .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC3.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD3          PICTURE S9(6) COMP-4 SYNC.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECL.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDL          PICTURE S9(2) COMP-4 SYNC LEFT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECR.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDR          PICTURE S9(2) COMP-4 SYNC RIGHT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECS.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDS      PICTURE S9(4) COMP-4 SYNC .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECO.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDO      PICTURE S9(4) COMP-4 .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP.
         05  GRP1.
           10  FILLER             PICTURE X(5).
           10  COM1-FLD1          PICTURE S9(4) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD2          PICTURE S9(6) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD3          PICTURE S9(18) SYNC COMP-4.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP2 SIGN LEADING SEPARATE.
         05  GRP2-1.
           10  FILLER             PICTURE X(5).
           10  COM2-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM2-FLD2          PICTURE S9(6) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(3).
           10  COM2-FLD3          PICTURE S9(7).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP3.
         05  GRP3-1.
           10  FILLER             PICTURE X(5).
           10  COM3-FLD1          PICTURE S9(4) COMP-3.
           10  FILLER             PICTURE X(3).
           10  COM3-FLD2          PICTURE S9(6) COMP-3.
           10  FILLER             PICTURE X(3).
         05  GRP3-2.
           10  COM3-FLD3          PICTURE S9(13) COMP-3.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP4.
         05  GRP4-1.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD1          PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD2          PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
         05  GRP4-2.
           10  COM4-FLD3          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD4          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD1          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD2          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5S.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD1         PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD2         PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP6 COMP-3.
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE 9(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP7 COMP-1.
           10  COM7-FLD1          .
           10  COM7-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP8 COMP-2.
           10  COM8-FLD1          .
           10  COM8-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP9.
         05  GRP9-1 SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD1          PICTURE S9(2).
           10  FILLER             PICTURE X(1).
           10  COM9-FLD2          PICTURE S9(2) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(1).
         05  GRP9-2 SIGN TRAILING SEPARATE.
           10  COM9-FLD3          PICTURE S9(2) SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD4          PICTURE S9(2).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRPX.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD1          PICTURE X(3) COMP-X SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD2          PICTURE X(7) COMP-X.
           10  FILLER             PICTURE X(1).
           10  COMX-FLT           COMP-1 SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-DBL           COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BSHORT.
           10  FILLER             PICTURE X(1).
           10  COMS-FLD1          BINARY-SHORT.
           10  FILLER             PICTURE X(2).
           10  COMS-FLD2          BINARY-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BDBL.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD1          BINARY-DOUBLE.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD2          BINARY-DOUBLE SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLNG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD1         BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD2         BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD1          PIC 9(18) COMP-5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD2          PIC 9(18) COMP-5 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD1          COMP-1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD2          COMP-1 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD1          COMP-2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD2          COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       PROCEDURE DIVISION.

           MOVE LENGTH OF TESTPTR TO VLEN.
           IF VLEN EQUAL 8
               MOVE 64     TO BIT-MODE
           ELSE
               MOVE 32     TO BIT-MODE.
           MOVE ALL "x"    TO TESTRECORD.
           MOVE 1 TO TESTMODE.
           MOVE ALL "x"    TO TSTREC2.
           MOVE "22"       TO COMP-FLD2 (1:).
           IF TSTREC2 = 'xxxxxx22'
               MOVE 3 TO TESTMODE.
           MOVE "12345678" TO COML-FLD2 (1:).
           IF COML-FLD2 = 875770417
             MOVE "Little-Endian" TO TESTEND
           ELSE
             MOVE "Big-Endian" TO TESTEND
           END-IF.
           MOVE LENGTH OF COMP-FLD1 TO VLEN.
           IF VLEN = 2
               MOVE 2 TO TESTMODE.
           MOVE ALL "x"    TO TESTRECORD.

           MOVE "COMP-FLD1" TO TESTNAME.
           MOVE "11"        TO COMP-FLD1 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLD2" TO TESTNAME.
           MOVE "22"       TO COMP-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDO" TO TESTNAME.
           MOVE "11"       TO COMP-FLDO (1) (1:2)
           MOVE "22"       TO COMP-FLDO (2) (1:2)
           MOVE "33"       TO COMP-FLDO (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLDS" TO TESTNAME.
           MOVE "11"       TO COMP-FLDS (1) (1:2)
           MOVE "22"       TO COMP-FLDS (2) (1:2)
           MOVE "33"       TO COMP-FLDS (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLD3" TO TESTNAME.
           MOVE "1234678"  TO COMP-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDL" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDL (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDR" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDR (1:).
           PERFORM CHECK-IT.

           MOVE "COM1-FLD" TO TESTNAME.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM2-FLD" TO TESTNAME.
           MOVE "12345678" TO COM2-FLD1 (1:).
           MOVE "12345678" TO COM2-FLD2 (1:).
           MOVE "12345678" TO COM2-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM3-FLD" TO TESTNAME.
           MOVE "12345678" TO COM3-FLD1 (1:).
           MOVE "12345678" TO COM3-FLD2 (1:).
           MOVE "12345678" TO COM3-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM4-FLD" TO TESTNAME.
           MOVE "12345678" TO COM4-FLD1 (1:).
           MOVE "12345678" TO COM4-FLD2 (1:).
           MOVE "12345678" TO COM4-FLD3 (1:).
           MOVE "12345678" TO COM4-FLD4 (1:).
           PERFORM CHECK-IT.

           MOVE "NOSYNC" TO TESTNAME.
           MOVE "12345678" TO COM5-FLD1 (1:).
           MOVE "12345678" TO COM5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SYNC" TO TESTNAME.
           MOVE "12345678" TO COM5S-FLD1 (1:).
           MOVE "12345678" TO COM5S-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-3" TO TESTNAME.
           MOVE "12345678" TO COM6-FLD1 (1:).
           MOVE "12345678" TO COM6-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-1" TO TESTNAME.
           MOVE "12345678" TO COM7-FLD1 (1:).
           MOVE "12345678" TO COM7-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-2" TO TESTNAME.
           MOVE "12345678" TO COM8-FLD1 (1:).
           MOVE "12345678" TO COM8-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SIGN L/T" TO TESTNAME.
           MOVE -1 TO COM9-FLD1 .
           MOVE -2 TO COM9-FLD2 .
           MOVE -3 TO COM9-FLD3 .
           MOVE -4 TO COM9-FLD4 .
           PERFORM CHECK-IT.

           MOVE "COMP-X" TO TESTNAME.
           MOVE "12345678" TO COMX-FLD1 (1:).
           MOVE "12345678" TO COMX-FLD2 (1:).
           MOVE "12345678" TO COMX-FLT (1:).
           MOVE "12345678" TO COMX-DBL (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-SHORT" TO TESTNAME.
           MOVE "12345678" TO COMS-FLD1 (1:).
           MOVE "12345678" TO COMS-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-DBL" TO TESTNAME.
           MOVE "12345678" TO COMD-FLD1 (1:).
           MOVE "12345678" TO COMD-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-LNG" TO TESTNAME.
           MOVE "12345678" TO COMBL-FLD1 (1:).
           MOVE "12345678" TO COMBL-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-5" TO TESTNAME.
           MOVE "12345678" TO CMP5-FLD1 (1:).
           MOVE "12345678" TO CMP5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-1" TO TESTNAME.
           MOVE "12345678" TO CMP1-FLD1 (1:).
           MOVE "12345678" TO CMP1-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-2" TO TESTNAME.
           MOVE "12345678" TO CMP2-FLD1 (1:).
           MOVE "12345678" TO CMP2-FLD2 (1:).
           PERFORM CHECK-IT.

           DISPLAY TEST-MODE (TESTMODE)
                   TESTCASE " tests with " TESTFAIL " failed"
                   WITH NO ADVANCING.
           STOP RUN RETURNING 0.

       CHECK-IT SECTION.
       CHECK-01.
           INSPECT TESTRECORD REPLACING TRAILING 'x' BY ' '.
           ADD 1 TO TESTCASE.
           PERFORM VARYING TESTNUM FROM 1 BY 1
                     UNTIL TEST-NAME (TESTNUM) = TESTNAME
                        OR TESTNUM > TESTMAX
              CONTINUE
           END-PERFORM.
           IF TESTNUM > TESTMAX
               DISPLAY TESTNAME " :NOT FOUND"
               DISPLAY "           :   GOT: " TESTRECORD ":"
               ADD 1 TO TESTFAIL
               MOVE ALL "x"    TO TESTRECORD
               GO TO CHECK-EXIT
           END-IF.
           MOVE TEST-RESULT (TESTNUM, TESTMODE) TO TESTRESULT.
           COMPUTE TESTIDX = TESTMODE + 3.
           IF BIT-MODE = 32
           AND TEST-RESULT (TESTNUM, TESTIDX) NOT = SPACES
               MOVE TEST-RESULT (TESTNUM, TESTIDX) TO TESTRESULT.
           IF TESTRESULT = SPACES
               MOVE TEST-RESULT (TESTNUM, 1) TO TESTRESULT.
           IF TESTRESULT NOT = TESTRECORD
               DISPLAY TESTNAME
                       " :FAILED:  Mode " BIT-MODE
                       " " TEST-MODE (TESTMODE)
                       ", Case " TESTCASE ", " TESTEND
               DISPLAY "           :   GOT: " TESTRECORD ":"
               DISPLAY "           :EXPECT: " TESTRESULT ":"
               ADD 1 TO TESTFAIL
           END-IF.
           MOVE ALL "x"    TO TESTRECORD.
       CHECK-EXIT.
           EXIT.

])

AT_CHECK([$COMPILE -w -std=mf prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[MF        24 tests with 00 failed], [])

AT_CLEANUP


AT_SETUP([default SYNC])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       FILE SECTION.

       WORKING-STORAGE SECTION.

       77  VLEN                   PIC 99 VALUE 1.
       77  TESTMODE               PIC 99 VALUE 1.
       77  TESTIDX                PIC 99 VALUE 1.
       77  BIT-MODE               PIC 99 VALUE 32.
       77  TESTNUM                PIC 99 VALUE 0.
       77  TESTMAX                PIC 99 VALUE 24.
       77  TESTCASE               PIC 99 VALUE 0.
       77  TESTFAIL               PIC 99 VALUE 0.
       77  TESTEND                PIC X(15) VALUE " ".
       77  TESTNAME               PIC X(10) VALUE " ".
       77  TESTRESULT             PIC X(40) VALUE " ".
       77  TESTPTR                USAGE POINTER.

       01  TEST-MODES.
           05  FILLER PIC X(10) VALUE "MF".
           05  FILLER PIC X(10) VALUE "IBMCOMP".
           05  FILLER PIC X(10) VALUE "DEFAULT".

       01  FILLER REDEFINES TEST-MODES.
           05  FILLER             OCCURS 3 TIMES.
              10  TEST-MODE       PIC X(10).

       01  TEST-CASES.
        05 FILLER PIC X(10) VALUE "COMP-FLD1".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxx11".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD2".
        05 FILLER PIC X(40) VALUE "xxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE "xxxxxx22".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDO".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDS".
        05 FILLER PIC X(40) VALUE "xxxxxxx11xxx22xxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE "xxxxxxxx11xxxx22xxxx33".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLD3".
        05 FILLER PIC X(40) VALUE "xxxxx123".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDL".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-FLDR".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE "xxxxxx12".
        05 FILLER PIC X(40) VALUE "xxxxx1".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM1-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12xxx123xxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxxxx12xxxx1234xxxx12345678".

        05 FILLER PIC X(10) VALUE "COM2-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx12345xxx1234567xxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM3-FLD".
        05 FILLER PIC X(40) VALUE "xxxxx123xxx1234xxx1234567".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COM4-FLD".
        05 FILLER PIC X(40) VALUE "x123456x1234x123456x123".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40)
           VALUE "xxxxxxxx12345678xxxx1234x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234x12345678x1234".

        05 FILLER PIC X(10) VALUE "NOSYNC".
        05 FILLER PIC X(40) VALUE "x123456x123".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE "x12345678x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SYNC".
        05 FILLER PIC X(40) VALUE "x123456x1234".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE "xxxxxxxx12345678xxxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "xxxx12345678xxxx1234".

        05 FILLER PIC X(10) VALUE "COMP-3".
        05 FILLER PIC X(40) VALUE "x1234567x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-1".
        05 FILLER PIC X(40) VALUE "12341234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-2".
        05 FILLER PIC X(40) VALUE "1234567812345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "SIGN L/T".
        05 FILLER PIC X(40) VALUE "x-01x02-x-03x04-".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "COMP-X".
        05 FILLER PIC X(40) VALUE "x123x1234567x1234x12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE "x123x1234567xxxx1234xxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-SHORT".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE "x12xx12".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "BIN-DBL".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".

        05 FILLER PIC X(10) VALUE "BIN-LNG".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x1234x1234".

        05 FILLER PIC X(10) VALUE "COMP-5".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

        05 FILLER PIC X(10) VALUE "CMP-1".
        05 FILLER PIC X(40) VALUE "x1234x1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE "x1234xxx1234".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".

        05 FILLER PIC X(10) VALUE "CMP-2".
        05 FILLER PIC X(40) VALUE "x12345678x12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE "x12345678xxxxxxx12345678".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE " ".
        05 FILLER PIC X(40) VALUE "x12345678xxx12345678".

       01  FILLER REDEFINES TEST-CASES.
           05  FILLER             OCCURS 24 TIMES.
              10  TEST-NAME       PIC X(10).
              10  TEST-RESULTS.
                15  MF-64RESULT     PIC X(40).
                15  IBM-64RESULT    PIC X(40).
                15  C2002-64RESULT  PIC X(40).
                15  MF-32RESULT     PIC X(40).
                15  IBM-32RESULT    PIC X(40).
                15  C2002-32RESULT  PIC X(40).
              10  FILLER REDEFINES TEST-RESULTS.
                15  TEST-RESULT   PIC X(40) OCCURS 6 TIMES.

       01  TESTRECORD             PIC X(40).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC1.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD1          PICTURE S9(2) COMP-4.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC2.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD2          PICTURE S9(4) COMP-4 SYNC .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTREC3.
           10  FILLER             PICTURE X(5).
           10  COMP-FLD3          PICTURE S9(6) COMP-4 SYNC.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECL.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDL          PICTURE S9(2) COMP-4 SYNC LEFT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECR.
           10  FILLER             PICTURE X(5).
           10  COMP-FLDR          PICTURE S9(2) COMP-4 SYNC RIGHT.
           10  FILLER             PICTURE X(5).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECS.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDS      PICTURE S9(4) COMP-4 SYNC .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTRECO.
           10  FILLER             PICTURE X(5).
           10  FILLER OCCURS 3 TIMES.
               15  FILLER         PICTURE X(2).
               15  COMP-FLDO      PICTURE S9(4) COMP-4 .
               15  FILLER         PICTURE X(1).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP.
         05  GRP1.
           10  FILLER             PICTURE X(5).
           10  COM1-FLD1          PICTURE S9(4) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD2          PICTURE S9(6) SYNC COMP-4.
           10  FILLER             PICTURE X(3).
           10  COM1-FLD3          PICTURE S9(18) SYNC COMP-4.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP2 SIGN LEADING SEPARATE.
         05  GRP2-1.
           10  FILLER             PICTURE X(5).
           10  COM2-FLD1          PICTURE S9(4).
           10  FILLER             PICTURE X(3).
           10  COM2-FLD2          PICTURE S9(6) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(3).
           10  COM2-FLD3          PICTURE S9(7).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP3.
         05  GRP3-1.
           10  FILLER             PICTURE X(5).
           10  COM3-FLD1          PICTURE S9(4) COMP-3.
           10  FILLER             PICTURE X(3).
           10  COM3-FLD2          PICTURE S9(6) COMP-3.
           10  FILLER             PICTURE X(3).
         05  GRP3-2.
           10  COM3-FLD3          PICTURE S9(13) COMP-3.

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP4.
         05  GRP4-1.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD1          PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD2          PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
         05  GRP4-2.
           10  COM4-FLD3          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM4-FLD4          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD1          PICTURE S9(13) COMP-4.
           10  FILLER             PICTURE X(1).
           10  COM5-FLD2          PICTURE S9(6) COMP-4.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP5S.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD1         PICTURE S9(13) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).
           10  COM5S-FLD2         PICTURE S9(7) COMP-4 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP6 COMP-3.
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD1          PICTURE S9(13).
           10  FILLER             PICTURE 9(1).
           10  COM6-FLD2          PICTURE S9(6).
           10  FILLER             PICTURE 9(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP7 COMP-1.
           10  COM7-FLD1          .
           10  COM7-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP8 COMP-2.
           10  COM8-FLD1          .
           10  COM8-FLD2          .

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRP9.
         05  GRP9-1 SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD1          PICTURE S9(2).
           10  FILLER             PICTURE X(1).
           10  COM9-FLD2          PICTURE S9(2) SIGN TRAILING SEPARATE.
           10  FILLER             PICTURE X(1).
         05  GRP9-2 SIGN TRAILING SEPARATE.
           10  COM9-FLD3          PICTURE S9(2) SIGN LEADING SEPARATE.
           10  FILLER             PICTURE X(1).
           10  COM9-FLD4          PICTURE S9(2).
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TSTGRPX.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD1          PICTURE X(3) COMP-X SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-FLD2          PICTURE X(7) COMP-X.
           10  FILLER             PICTURE X(1).
           10  COMX-FLT           COMP-1 SYNC.
           10  FILLER             PICTURE X(1).
           10  COMX-DBL           COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BSHORT.
           10  FILLER             PICTURE X(1).
           10  COMS-FLD1          BINARY-SHORT.
           10  FILLER             PICTURE X(2).
           10  COMS-FLD2          BINARY-SHORT SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD1          BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COML-FLD2          BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BDBL.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD1          BINARY-DOUBLE.
           10  FILLER             PICTURE X(1).
           10  COMD-FLD2          BINARY-DOUBLE SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-BLNG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD1         BINARY-LONG.
           10  FILLER             PICTURE X(1).
           10  COMBL-FLD2         BINARY-LONG SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD1          PIC 9(18) COMP-5.
           10  FILLER             PICTURE X(1).
           10  CMP5-FLD2          PIC 9(18) COMP-5 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD1          COMP-1.
           10  FILLER             PICTURE X(1).
           10  CMP1-FLD2          COMP-1 SYNC.
           10  FILLER             PICTURE X(1).

       01  FILLER REDEFINES TESTRECORD.
        02  TST-CMP2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD1          COMP-2.
           10  FILLER             PICTURE X(1).
           10  CMP2-FLD2          COMP-2 SYNC.
           10  FILLER             PICTURE X(1).

       PROCEDURE DIVISION.

           MOVE LENGTH OF TESTPTR TO VLEN.
           IF VLEN EQUAL 8
               MOVE 64     TO BIT-MODE
           ELSE
               MOVE 32     TO BIT-MODE.
           MOVE ALL "x"    TO TESTRECORD.
           MOVE 1 TO TESTMODE.
           MOVE ALL "x"    TO TSTREC2.
           MOVE "22"       TO COMP-FLD2 (1:).
           IF TSTREC2 = 'xxxxxx22'
               MOVE 3 TO TESTMODE.
           MOVE "12345678" TO COML-FLD2 (1:).
           IF COML-FLD2 = 875770417
             MOVE "Little-Endian" TO TESTEND
           ELSE
             MOVE "Big-Endian" TO TESTEND
           END-IF.
           MOVE LENGTH OF COMP-FLD1 TO VLEN.
           IF VLEN = 2
               MOVE 2 TO TESTMODE.
           MOVE ALL "x"    TO TESTRECORD.

           MOVE "COMP-FLD1" TO TESTNAME.
           MOVE "11"        TO COMP-FLD1 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLD2" TO TESTNAME.
           MOVE "22"       TO COMP-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDO" TO TESTNAME.
           MOVE "11"       TO COMP-FLDO (1) (1:2)
           MOVE "22"       TO COMP-FLDO (2) (1:2)
           MOVE "33"       TO COMP-FLDO (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLDS" TO TESTNAME.
           MOVE "11"       TO COMP-FLDS (1) (1:2)
           MOVE "22"       TO COMP-FLDS (2) (1:2)
           MOVE "33"       TO COMP-FLDS (3) (1:2)
           PERFORM CHECK-IT.

           MOVE "COMP-FLD3" TO TESTNAME.
           MOVE "1234678"  TO COMP-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDL" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDL (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-FLDR" TO TESTNAME.
           MOVE "12345678" TO COMP-FLDR (1:).
           PERFORM CHECK-IT.

           MOVE "COM1-FLD" TO TESTNAME.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM2-FLD" TO TESTNAME.
           MOVE "12345678" TO COM2-FLD1 (1:).
           MOVE "12345678" TO COM2-FLD2 (1:).
           MOVE "12345678" TO COM2-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM3-FLD" TO TESTNAME.
           MOVE "12345678" TO COM3-FLD1 (1:).
           MOVE "12345678" TO COM3-FLD2 (1:).
           MOVE "12345678" TO COM3-FLD3 (1:).
           PERFORM CHECK-IT.

           MOVE "COM4-FLD" TO TESTNAME.
           MOVE "12345678" TO COM4-FLD1 (1:).
           MOVE "12345678" TO COM4-FLD2 (1:).
           MOVE "12345678" TO COM4-FLD3 (1:).
           MOVE "12345678" TO COM4-FLD4 (1:).
           PERFORM CHECK-IT.

           MOVE "NOSYNC" TO TESTNAME.
           MOVE "12345678" TO COM5-FLD1 (1:).
           MOVE "12345678" TO COM5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SYNC" TO TESTNAME.
           MOVE "12345678" TO COM5S-FLD1 (1:).
           MOVE "12345678" TO COM5S-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-3" TO TESTNAME.
           MOVE "12345678" TO COM6-FLD1 (1:).
           MOVE "12345678" TO COM6-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-1" TO TESTNAME.
           MOVE "12345678" TO COM7-FLD1 (1:).
           MOVE "12345678" TO COM7-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-2" TO TESTNAME.
           MOVE "12345678" TO COM8-FLD1 (1:).
           MOVE "12345678" TO COM8-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "SIGN L/T" TO TESTNAME.
           MOVE -1 TO COM9-FLD1 .
           MOVE -2 TO COM9-FLD2 .
           MOVE -3 TO COM9-FLD3 .
           MOVE -4 TO COM9-FLD4 .
           PERFORM CHECK-IT.

           MOVE "COMP-X" TO TESTNAME.
           MOVE "12345678" TO COMX-FLD1 (1:).
           MOVE "12345678" TO COMX-FLD2 (1:).
           MOVE "12345678" TO COMX-FLT (1:).
           MOVE "12345678" TO COMX-DBL (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-SHORT" TO TESTNAME.
           MOVE "12345678" TO COMS-FLD1 (1:).
           MOVE "12345678" TO COMS-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-DBL" TO TESTNAME.
           MOVE "12345678" TO COMD-FLD1 (1:).
           MOVE "12345678" TO COMD-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "BIN-LNG" TO TESTNAME.
           MOVE "12345678" TO COMBL-FLD1 (1:).
           MOVE "12345678" TO COMBL-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "COMP-5" TO TESTNAME.
           MOVE "12345678" TO CMP5-FLD1 (1:).
           MOVE "12345678" TO CMP5-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-1" TO TESTNAME.
           MOVE "12345678" TO CMP1-FLD1 (1:).
           MOVE "12345678" TO CMP1-FLD2 (1:).
           PERFORM CHECK-IT.

           MOVE "CMP-2" TO TESTNAME.
           MOVE "12345678" TO CMP2-FLD1 (1:).
           MOVE "12345678" TO CMP2-FLD2 (1:).
           PERFORM CHECK-IT.

           DISPLAY TEST-MODE (TESTMODE)
                   TESTCASE " tests with " TESTFAIL " failed".
           STOP RUN RETURNING 0.

       CHECK-IT SECTION.
       CHECK-01.
           INSPECT TESTRECORD REPLACING TRAILING 'x' BY ' '.
           ADD 1 TO TESTCASE.
           PERFORM VARYING TESTNUM FROM 1 BY 1
                     UNTIL TEST-NAME (TESTNUM) = TESTNAME
                        OR TESTNUM > TESTMAX
              CONTINUE
           END-PERFORM.
           IF TESTNUM > TESTMAX
               DISPLAY TESTNAME " :NOT FOUND"
               DISPLAY "           :   GOT: " TESTRECORD ":"
               ADD 1 TO TESTFAIL
               MOVE ALL "x"    TO TESTRECORD
               GO TO CHECK-EXIT
           END-IF.
           MOVE TEST-RESULT (TESTNUM, TESTMODE) TO TESTRESULT.
           COMPUTE TESTIDX = TESTMODE + 3.
           IF BIT-MODE = 32
           AND TEST-RESULT (TESTNUM, TESTIDX) NOT = SPACES
               MOVE TEST-RESULT (TESTNUM, TESTIDX) TO TESTRESULT.
           IF TESTRESULT = SPACES
               MOVE TEST-RESULT (TESTNUM, 1) TO TESTRESULT.
           IF TESTRESULT NOT = TESTRECORD
               DISPLAY TESTNAME
                       " :FAILED:  Mode " BIT-MODE
                       " " TEST-MODE (TESTMODE)
                       ", Case " TESTCASE ", " TESTEND
               DISPLAY "           :   GOT: " TESTRECORD ":"
               DISPLAY "           :EXPECT: " TESTRESULT ":"
               ADD 1 TO TESTFAIL
           END-IF.
           MOVE ALL "x"    TO TESTRECORD.
       CHECK-EXIT.
           EXIT.

])

AT_CHECK([$COMPILE -w prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[DEFAULT   24 tests with 00 failed
], [])

AT_CLEANUP


AT_SETUP([Group Usage 1])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TESTRECORD.
         02  TSTGRP1 USAGE BINARY.
           05  GRP1-1.
             10  FILLER             PICTURE X(1). 
             10  COM1-FLD1          PICTURE S9(3). 
             10  FILLER             PICTURE X(3). 
             10  COM1-FLD2          PICTURE S9(6). 
           05  GRP1-2 SYNC.
             10  FILLER             PICTURE X(1). 
             10  COM1-FLD3          PICTURE S9(5). 
             10  FILLER             PICTURE X. 
             10  COM1-FLDX          PICTURE X(5). 
       01  TSTGRP2 POINTER.
           05  PTR-1.
           05  GRP2-2 SYNC.
             10  PTR-2.

       PROCEDURE DIVISION.

           MOVE ALL 'x' TO TESTRECORD.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           MOVE "********" TO COM1-FLDX (1:).
           DISPLAY TESTRECORD.
           STOP RUN.
           
])

AT_CHECK([$COMPILE -std=mf -w prog.cob ], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [x12xxx123x123x*****
], [])

AT_CLEANUP


AT_SETUP([Group Usage 2])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  TESTRECORD.
         02  TSTGRP1 USAGE BINARY.
           05  GRP1-1.
             10  FILLER             PICTURE X(1). 
             10  COM1-FLD1          PICTURE S9(3). 
             10  FILLER             PICTURE X(3). 
             10  COM1-FLD2          PICTURE S9(6). 
           05  GRP1-2 SYNC.
             10  FILLER             PICTURE X(1). 
             10  COM1-FLD3          PICTURE S9(5). 
             10  FILLER             PICTURE X. 
             10  COM1-FLDX          PICTURE X(5). 
       01  TSTGRP2 POINTER.
           05  PTR-1.
           05  GRP2-2 SYNC.
             10  PTR-2.

       PROCEDURE DIVISION.

           MOVE ALL 'x' TO TESTRECORD.
           MOVE "12345678" TO COM1-FLD1 (1:).
           MOVE "12345678" TO COM1-FLD2 (1:).
           MOVE "12345678" TO COM1-FLD3 (1:).
           MOVE "********" TO COM1-FLDX (1:).
           DISPLAY TESTRECORD.
           STOP RUN.
           
])

AT_CHECK([$COMPILE -std=mf -w -fibmcomp prog.cob ], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [x12xxx1234xx1234x*****
], [])

AT_CLEANUP


AT_SETUP([MF COMP-5 noibmcomp])
AT_KEYWORDS([NOIBMCOMP])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77  CMP4     PIC 99   COMP-4.
       77  CMP5     PIC 99   COMP-5.
       77  CMP4-4   PIC 9(4) COMP-4.
       77  CMP5-4   PIC 9(4) COMP-5.
       PROCEDURE DIVISION.
           DISPLAY 'LEN PIC 99 COMP-5 is ' LENGTH OF CMP5 " :".
           DISPLAY 'LEN PIC 99 COMP-4 is ' LENGTH OF CMP4 " :".
           DISPLAY 'LEN PIC 9(4) COMP-5 is ' LENGTH OF CMP5-4 " :".
           DISPLAY 'LEN PIC 9(4) COMP-4 is ' LENGTH OF CMP4-4 " :".
           STOP RUN RETURNING 0.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [LEN PIC 99 COMP-5 is 1 :
LEN PIC 99 COMP-4 is 1 :
LEN PIC 9(4) COMP-5 is 2 :
LEN PIC 9(4) COMP-4 is 2 :
], [])

AT_CLEANUP


AT_SETUP([MF COMP-5])
AT_KEYWORDS([IBMCOMP])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       77  CMP4     PIC 99   COMP-4.
       77  CMP5     PIC 99   COMP-5.
       77  CMP4-4   PIC 9(4) COMP-4.
       77  CMP5-4   PIC 9(4) COMP-5.
       PROCEDURE DIVISION.
           DISPLAY 'LEN PIC 99 COMP-5 is ' LENGTH OF CMP5 " :".
           DISPLAY 'LEN PIC 99 COMP-4 is ' LENGTH OF CMP4 " :".
           DISPLAY 'LEN PIC 9(4) COMP-5 is ' LENGTH OF CMP5-4 " :".
           DISPLAY 'LEN PIC 9(4) COMP-4 is ' LENGTH OF CMP4-4 " :".
           STOP RUN RETURNING 0.
])

AT_CHECK([$COMPILE -fibmcomp prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [LEN PIC 99 COMP-5 is 2 :
LEN PIC 99 COMP-4 is 2 :
LEN PIC 9(4) COMP-5 is 2 :
LEN PIC 9(4) COMP-4 is 2 :
], [])

AT_CLEANUP


AT_SETUP([Test HEX String])
AT_KEYWORDS([Numeric])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA  DIVISION.
       WORKING-STORAGE SECTION.
       01  var9      PIC 9(5).
       01  varb      PIC 9(4) COMP-4.
       01  varx REDEFINES varb PIC XX.
          88 MAXVAL VALUE X"7FFF".

       PROCEDURE DIVISION.

           SET MAXVAL TO TRUE.
           MOVE varb TO var9.
           DISPLAY varb " vs " var9.
           MOVE HIGH-VALUES TO varx.
           MOVE varb TO var9.
           DISPLAY varb " vs " var9.

           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [2767 vs 32767
5535 vs 65535
], [])

AT_CHECK([$COMPILE -fnotrunc prog.cob], [0], [], [])

AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [32767 vs 32767
65535 vs 65535
], [])

AT_CLEANUP


AT_SETUP([assorted math])
AT_KEYWORDS([runmisc expression])

# this is a test containing different small reproducers from
# bug reports

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 n pic 99 value 89.
       01 m pic 99 value 0.
       01 variable usage signed-int value 0.
          88 a-one value 1.
          88 a-two value 2.
       PROCEDURE DIVISION.
      *> bug #702, "pow"-call in generated program
           display n(n**0+ 1:) with no advancing.
           display "-"         with no advancing.
           display n(n**m+ 1:) with no advancing.
      *> bug #631 arithmetic handling (optimize code)
           if not a-one and not a-two
              display 'succeeded'
           else
              display 'failed'.
           GOBACK.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[9-9succeeded
], [])

AT_CLEANUP


AT_SETUP([compare numeric DISPLAY SPACE with ZERO])
AT_KEYWORDS([runmisc expression])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  TST-VARS.
           03 TST-NUMBER         PIC  9(6).
           03 TST-NUMBER-SIGNED  PIC S9(6).
           03 TST-DECIMAL        PIC  9(2)V9(4).
           03 TST-DECIMAL-SIGNED PIC S9(2)V9(4).
       77     ZERO-DECIMAL       PIC  9(2)V9(4) VALUE ZERO.
       77     ZERO-NUMBER        PIC  9(6)      VALUE ZERO.

       PROCEDURE DIVISION.
           MOVE SPACES TO TST-VARS

           IF TST-NUMBER > 0
              DISPLAY "TST-NUMBER IS > 0".
           IF TST-NUMBER NOT = 0
              DISPLAY "TST-NUMBER IS NOT 0".
           IF TST-NUMBER < 0
              DISPLAY "TST-NUMBER IS < 0".

           IF TST-NUMBER-SIGNED > 0
              DISPLAY "TST-NUMBER-SIGNED IS > 0".
           IF TST-NUMBER-SIGNED NOT = 0
              DISPLAY "TST-NUMBER-SIGNED IS NOT 0".
           IF TST-NUMBER-SIGNED < 0
              DISPLAY "TST-NUMBER-SIGNED IS < 0".

           IF TST-DECIMAL > 0
              DISPLAY "TST-DECIMAL IS > 0".
           IF TST-DECIMAL NOT = 0
              DISPLAY "TST-DECIMAL IS NOT 0".
           IF TST-DECIMAL < 0
              DISPLAY "TST-DECIMAL IS < 0".

           IF TST-DECIMAL-SIGNED > 0
              DISPLAY "TST-DECIMAL-SIGNED IS > 0".
           IF TST-DECIMAL-SIGNED NOT = 0
              DISPLAY "TST-DECIMAL-SIGNED IS NOT 0".
           IF TST-DECIMAL-SIGNED < 0
              DISPLAY "TST-DECIMAL-SIGNED IS < 0".

           IF TST-NUMBER > ZERO-NUMBER
              DISPLAY "TST-NUMBER IS > ZERO-NUMBER".
           IF TST-NUMBER NOT = ZERO-NUMBER
              DISPLAY "TST-NUMBER IS NOT ZERO-NUMBER".
           IF TST-NUMBER < ZERO-NUMBER
              DISPLAY "TST-NUMBER IS < ZERO-NUMBER".

           IF TST-NUMBER-SIGNED > ZERO-NUMBER
              DISPLAY "TST-NUMBER-SIGNED IS > ZERO-NUMBER".
           IF TST-NUMBER-SIGNED NOT = ZERO-NUMBER
              DISPLAY "TST-NUMBER-SIGNED IS NOT ZERO-NUMBER".
           IF TST-NUMBER-SIGNED < ZERO-NUMBER
              DISPLAY "TST-NUMBER-SIGNED IS < ZERO-NUMBER".

           IF TST-DECIMAL > ZERO-NUMBER
              DISPLAY "TST-DECIMAL IS > ZERO-NUMBER".
           IF TST-DECIMAL NOT = ZERO-NUMBER
              DISPLAY "TST-DECIMAL IS NOT ZERO-NUMBER".
           IF TST-DECIMAL < ZERO-NUMBER
              DISPLAY "TST-DECIMAL IS < ZERO-NUMBER".

           IF TST-DECIMAL-SIGNED > ZERO-NUMBER
              DISPLAY "TST-DECIMAL-SIGNED IS > ZERO-NUMBER".
           IF TST-DECIMAL-SIGNED NOT = ZERO-NUMBER
              DISPLAY "TST-DECIMAL-SIGNED IS NOT ZERO-NUMBER".
           IF TST-DECIMAL-SIGNED < ZERO-NUMBER
              DISPLAY "TST-DECIMAL-SIGNED IS < ZERO-NUMBER".

           IF TST-NUMBER > ZERO-DECIMAL
              DISPLAY "TST-NUMBER IS > ZERO-DECIMAL".
           IF TST-NUMBER NOT = ZERO-DECIMAL
              DISPLAY "TST-NUMBER IS NOT ZERO-DECIMAL".
           IF TST-NUMBER < ZERO-DECIMAL
              DISPLAY "TST-NUMBER IS < ZERO-DECIMAL".

           IF TST-NUMBER-SIGNED > ZERO-DECIMAL
              DISPLAY "TST-NUMBER-SIGNED IS > ZERO-DECIMAL".
           IF TST-NUMBER-SIGNED NOT = ZERO-DECIMAL
              DISPLAY "TST-NUMBER-SIGNED IS NOT ZERO-DECIMAL".
           IF TST-NUMBER-SIGNED < ZERO-DECIMAL
              DISPLAY "TST-NUMBER-SIGNED IS < ZERO-DECIMAL".

           IF TST-DECIMAL > ZERO-DECIMAL
              DISPLAY "TST-DECIMAL IS > ZERO-DECIMAL".
           IF TST-DECIMAL NOT = ZERO-DECIMAL
              DISPLAY "TST-DECIMAL IS NOT ZERO-DECIMAL".
           IF TST-DECIMAL < ZERO-DECIMAL
              DISPLAY "TST-DECIMAL IS < ZERO-DECIMAL".

           IF TST-DECIMAL-SIGNED > ZERO-DECIMAL
              DISPLAY "TST-DECIMAL-SIGNED IS > ZERO-DECIMAL".
           IF TST-DECIMAL-SIGNED NOT = ZERO-DECIMAL
              DISPLAY "TST-DECIMAL-SIGNED IS NOT ZERO-DECIMAL".
           IF TST-DECIMAL-SIGNED < ZERO-DECIMAL
              DISPLAY "TST-DECIMAL-SIGNED IS < ZERO-DECIMAL".

           GOBACK.
])

# dropping "fast compare" does an internal numeric compare, where invalid data
# in USAGE DISPLAY is converted (onlysecond half-byte used) and leading SPACE
# is skipped in general
AT_CHECK([$COMPILE -Wno-constant-expression -fno-fast-compare prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

# with "fast compare" enabled, the same PIC+USAGE leads to memcmp, therefore the
# result differs with invalid data; note: the exact "difference" is unportable
AT_CHECK([$COMPILE -Wno-constant-expression prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0],
[TST-NUMBER IS NOT 0
TST-NUMBER IS < 0
TST-NUMBER IS NOT ZERO-NUMBER
TST-NUMBER IS < ZERO-NUMBER
TST-DECIMAL IS NOT ZERO-DECIMAL
TST-DECIMAL IS < ZERO-DECIMAL
], [])

# result with MF would be:
# TST-NUMBER IS NOT 0
# TST-NUMBER IS < 0
# TST-NUMBER-SIGNED IS NOT 0
# TST-NUMBER-SIGNED IS < 0
# TST-NUMBER IS NOT ZERO-NUMBER
# TST-NUMBER IS < ZERO-NUMBER
# TST-NUMBER-SIGNED IS NOT ZERO-NUMBER
# TST-NUMBER-SIGNED IS < ZERO-NUMBER
# TST-DECIMAL IS NOT ZERO-DECIMAL
# TST-DECIMAL IS < ZERO-DECIMAL
# TST-DECIMAL-SIGNED IS NOT ZERO-DECIMAL
# TST-DECIMAL-SIGNED IS < ZERO-DECIMAL
# CHECKME: Do we want to mimic that with -std=mf?

AT_CLEANUP


AT_SETUP([runtime checks within conditions])
AT_KEYWORDS([runmisc condition expression])

# this serves as a sample what was broken in the initial
# 3.1 release

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 mytab.
          03  VAR                   PIC  9(02) value 1.
          03  VAR2                  PIC  9(02) value 2.
          03                        OCCURS 2.
           05 T15-PRGM              PIC  X(08).
           05 T16-PRGM              PIC  X(08).
          03                        OCCURS 2.
           05 T15-NRGM              PIC  9(04).
           05 T16-NRGM              USAGE BINARY-INT.

       PROCEDURE DIVISION.
      *
           MOVE 'TESTME' TO T16-PRGM (VAR) (VAR2:)
           MOVE T16-PRGM (VAR) (1:VAR2) TO T15-PRGM (VAR)
           IF  T16-PRGM(VAR)
             = T15-PRGM(VAR2)
              DISPLAY 'WRONG RESULT OCCURS'.

           IF  MYTAB(VAR:VAR2)
             = MYTAB(VAR2:VAR)
              DISPLAY 'WRONG RESULT REFMOD'.

           INITIALIZE mytab

           GOBACK.
])
AT_CHECK([$COMPILE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
# note: we mostly are interested in a good codegen here...


AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog2.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       
       01 mytab.
          03  VAR                   PIC  9(02) value 1.
          03  VAR2                  PIC  9(02) value 3.
          03                        OCCURS 2.
           05 T15-PRGM              PIC  X(08).
           05 T16-PRGM              PIC  X(08).
          03                        OCCURS 2.
           05 T15-NRGM              PIC  9(04).
           05 T16-NRGM              USAGE BINARY-INT.
          05 buffer                 PIC X(500).

       PROCEDURE DIVISION.
      *
           IF  T16-PRGM(VAR)
             = T15-PRGM(VAR2)
              DISPLAY 'WRONG RESULT OCCURS'.

           GOBACK.
])
AT_CHECK([$COBC -x prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0], [], [])
AT_CHECK([$COBC -x --debug -o prog2b prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2b], [1], [],
[libcob: prog2.cob:21: error: subscript of 'T15-PRGM' out of bounds: 3
note: maximum subscript for 'T15-PRGM': 2
])
AT_DATA([prog3.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog3.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       
       01 mytab.
          03  VAR                   PIC  9(02) value 1.
          03  VAR2                  PIC  9(02) value 99.
          03                        OCCURS 2.
           05 T15-PRGM              PIC  X(08).
           05 T16-PRGM              PIC  X(08).
          03                        OCCURS 2.
           05 T15-NRGM              PIC  9(04).
           05 T16-NRGM              USAGE BINARY-INT.

       PROCEDURE DIVISION.
              
           IF  MYTAB(VAR:VAR2)
      *>     = MYTAB(VAR2:VAR)   that _should_ work but on x86_64
      *>                         the second line is evaluated first
             = MYTAB(VAR:VAR )
              DISPLAY 'WRONG RESULT REFMOD'.

           GOBACK.
])
AT_CHECK([$COBC -x prog3.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])
AT_CHECK([$COBC -x --debug -o prog3b prog3.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog3b], [1], [],
[libcob: prog3.cob:20: error: length of 'mytab' out of bounds: 99, maximum: 52
])

AT_CLEANUP


AT_SETUP([runtime check: write to internal storage (1)])
AT_KEYWORDS([runmisc CALL bounds exceptions])

# note: this check is likely unportable and therefore will likely be adjusted/skipped,
#       mainly because the memory layout of consecutive variables is not guaranteed;
#       it is expected to raise a crash if C bound checking is enabled
AT_SKIP_IF([test $($COBC --info | $GREP -c sanitize) != 0])

AT_DATA([caller.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    caller.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 var                   PIC  X.
       01 vars.
          03 filler             PIC  X.
          03 vars-field         PIC  X.

       01 varg                  GLOBAL.
          03 filler             PIC  X.
          03 varg-field         PIC  X.
       01 vare                  EXTERNAL.
          03 filler             PIC  X.
          03 vare-field         PIC  X.
       01 varb                  BASED.
          03 filler             PIC  X.
          03 varb-field         PIC  X.
       LINKAGE SECTION.
       01 varl                  PIC  X.
       01 varls.
          03 filler             PIC  X.
          03 varls-field        PIC  X.

       PROCEDURE DIVISION.
      *
           CALL "callee" USING var
      *    without the check this second call would SIGSEGV
           CALL "callee" USING var

      *    the following are mostly in to co-test the codegen
           CALL "callee" USING vars
           CALL "callee" USING varg
           CALL "callee" USING vare
           CALL "callee" USING varb
           CALL "callee" USING varl
           CALL "callee" USING varls
           CALL "callee" USING vars-field
           CALL "callee" USING varg-field
           CALL "callee" USING vare-field
           CALL "callee" USING varb-field
           CALL "callee" USING varls-field

           GOBACK.
])

AT_DATA([callee.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    callee.

       DATA DIVISION.
       LINKAGE SECTION.

       77 var                   PIC  X.
       01 lrec.
          03  lvar                  PIC  X(32).
          03  lvar2                 PIC  X(32).

       PROCEDURE DIVISION USING var.
      *
           SET ADDRESS OF lrec TO ADDRESS OF var
           SET ADDRESS OF lrec DOWN BY 32
           MOVE SPACES TO lrec
           GOBACK.
])

AT_CHECK([$COMPILE -fno-ec=program-arg-mismatch -fmemory-check=pointer caller.cob], [0], [], [])
AT_CHECK([$COMPILE_MODULE -fno-ec=program-arg-mismatch callee.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: caller.cob:30: error: memory violation detected after CALL
])

AT_CHECK([$COMPILE -fno-ec=program-arg-mismatch -fmemory-check=using caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: caller.cob:30: error: memory violation detected for 'var' after CALL
])

AT_CHECK([$COMPILE -fno-ec=program-arg-mismatch -fmemory-check caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: caller.cob:30: error: memory violation detected for 'var' after CALL
])

AT_CHECK([$COMPILE -fno-ec=program-arg-mismatch -fmemory-check=all caller.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./caller], [1], [],
[libcob: caller.cob:30: error: memory violation detected for 'var' after CALL
])

AT_CLEANUP


AT_SETUP([runtime check: write to internal storage (2)])
AT_KEYWORDS([runmisc CALL bounds exceptions])

# PROG A (WS 16 bytes) has its WS overwritten and calls PROG B
# because of the write outside of WS the internal storage is broken
# and the call pointer contains an invalid address
# note: this check is possibly unportable and therefore will likely be adjusted/skipped
#       it is expected to raise a crash if C bound checking is enabled

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID.    prog.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 DUMMY-STORAGE             PIC  X(128).

       PROCEDURE DIVISION.
      *    using the var so cobc cannot easily optimize that out
           IF DUMMY-STORAGE (1:1) <> SPACE  INITIALIZE DUMMY-STORAGE.

      *    We use a simple wrapper to make it _less_ likely that the
      *    following "real test" SIGSEGVs during MOVE
           CALL STATIC "progt".

      *    we don't expect to ever get here - but this creates more
      *    memory space to decrease the likelyness of a SIGSEGV more
           CALL STATIC "dummy".

           GOBACK.
       END PROGRAM prog.

       IDENTIFICATION DIVISION.
       PROGRAM-ID.    progt.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       77 PNT USAGE POINTER EXTERNAL.

       01 REC.
          03  VAR                   PIC  X.
          03  VAR2                  PIC  X.

       LINKAGE SECTION.
       01 LREC.
          03  LVAR                  PIC  X(64).
          03  LVAR2                 PIC  X(64).

       PROCEDURE DIVISION.
      *    using a (not working) call prevents the C compiler
      *    to know that we (do not) change the pointer variable
      *    and therefore disallows it to check
      *    "that points to VAR2, you only have 2 bytes" (done with gcc -O)
           SET PNT TO ADDRESS OF VAR2.
           CALL "notthere" USING PNT ON EXCEPTION CONTINUE.
           SET ADDRESS OF LREC TO PNT.
           MOVE SPACES TO LREC.

           CALL "broken".

           GOBACK.
       END PROGRAM progt.

       IDENTIFICATION DIVISION.
       PROGRAM-ID.    dummy.

       DATA DIVISION.
       WORKING-STORAGE SECTION.

       01 DUMMY-STORAGE             PIC  X(128).

       PROCEDURE DIVISION.
      *    using the var so cobc cannot easily optimize that out
           IF DUMMY-STORAGE (1:1) <> SPACE  INITIALIZE DUMMY-STORAGE.

           GOBACK.
       END PROGRAM dummy.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

# skipping the (nonportable) test - hardened GCC SIGSEGVs on the bad MOVE,
# clang use a different memory layout so we never actually break
# the call-pointers
AT_SKIP_IF([true])

AT_CHECK([$COBCRUN_DIRECT ./prog], [1], [],
[libcob: prog.cob:52: error: memory violation detected after INIT CALL
])

AT_CLEANUP


AT_SETUP([libcob version check])
AT_KEYWORDS([runmisc])

# using a C program here, normally this would be called from old or newer modules
AT_DATA([prog.c], [[
#include <stdio.h>
#include <libcob.h>

#define COUNT_OF(x) (sizeof(x)/sizeof(x[0]))

struct verify_t {
  char *prog, *packver_prog;
  int patchlev_prog;
} verify[] = {
#include "testdata.h"
};

int
main(int argc, char *argv[])
{
  struct verify_t *p;
  for( p=verify; p < verify + COUNT_OF(verify); p++ ) {
    cob_check_version(p->prog, p->packver_prog, p->patchlev_prog);
  }
  return 0;
}
]])

# good cases
AT_DATA([testdata.h], [[
#define TST_STRINGIFY(s)			#s
#define TST_XSTRINGIFY(s)		TST_STRINGIFY (s)
  { "test40", "4.0",    0 },
/*  { "TestMatch1",
		TST_XSTRINGIFY (__LIBCOB_VERSION) "."
		TST_XSTRINGIFY (__LIBCOB_VERSION_MINOR) "."
		TST_XSTRINGIFY (__LIBCOB_VERSION_PATCHLEVEL),
    0}, */
  { "TestMatch2",
		TST_XSTRINGIFY (__LIBCOB_VERSION) "."
		TST_XSTRINGIFY (__LIBCOB_VERSION_MINOR) "."
      "0",
    0},
  { "TestMatch3",
		TST_XSTRINGIFY (__LIBCOB_VERSION) "."
		TST_XSTRINGIFY (__LIBCOB_VERSION_MINOR),
    0 }
]])

AT_CHECK([$COMPILE prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [], [])

AT_DATA([testdata.h], [[
  { "TooSmall1", "1.1",    0 }
]])
AT_CHECK([$COMPILE -o small1 prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./small1 2>small1.log], [1], [], [])
AT_CHECK([$GREP -v "libcob has" small1.log], [0],
[libcob: error: version mismatch
note: TooSmall1 has version 1.1.0
], [])

AT_DATA([testdata.h], [[
  { "TooSmall2", "2.0",    0 }
]])
AT_CHECK([$COMPILE -o small2 prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./small2 2>small2.log], [1], [], [])
AT_CHECK([$GREP -v "libcob has" small2.log], [0],
[libcob: error: version mismatch
note: TooSmall2 has version 2.0.0
], [])

AT_DATA([testdata.h], [[
  { "TooSmall3", "3.4",    0 },
]])
AT_CHECK([$COMPILE -o small3 prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./small3 2>small3.log], [1], [], [])
AT_CHECK([$GREP -v "libcob has" small3.log], [0],
[libcob: error: version mismatch
note: TooSmall3 has version 3.4.0
], [])

AT_DATA([testdata.h], [[
  { "TooHigh2", "4.1",  0 }
]])
AT_CHECK([$COMPILE -o high2 prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./high2 2>high2.log], [1], [], [])
AT_CHECK([$GREP -v "libcob has" high2.log], [0],
[libcob: error: version mismatch
note: TooHigh2 has version 4.1.0
], [])

AT_DATA([testdata.h], [[
  { "TooHigh3", "4.0.1",  2 }
]])
AT_CHECK([$COMPILE -o high3 prog.c], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./high3 2>high3.log], [1], [], [])
AT_CHECK([$GREP -v "libcob has" high3.log], [0],
[libcob: error: version mismatch
note: TooHigh3 has version 4.0.1.2
], [])

AT_CLEANUP


AT_SETUP([Decimal constants and programs in same source])
AT_KEYWORDS([runmisc INITIAL CANCEL CALL])

# this used to cause a SIGSEGV, see bug #917

AT_DATA([prog.cpy], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. :PROG-NAME: :PROG-KIND:.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  X  PIC 9(2) VALUE 42.
       01  Y  PIC 9v9  VALUE 0.1.
       PROCEDURE DIVISION.
       MAIN.
      * ensure that cobc cannot optimize the expression away
           IF FUNCTION CURRENT-DATE = 0
               ADD 1 TO Y.
           IF (X + Y) / 42.1 = 1
               DISPLAY "OK" WITH NO ADVANCING.
           EXIT PROGRAM.
       END PROGRAM :PROG-NAME:.
])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01  X  PIC 9(2) VALUE 0.
       01  Y  PIC 9v9  VALUE 0.1.
       PROCEDURE DIVISION.
       MAIN.
      * ensure that cobc cannot optimize the expression away
           IF FUNCTION CURRENT-DATE = 0
               ADD 1 TO Y.
           CALL "nested_init"
           CALL "nonnested_init"
           CALL "nested_noninit"
           CANCEL "nested_noninit"
           CALL "nonnested_noninit"
           CANCEL "nonnested_noninit"
           IF X + Y + 42.1 <> 0
               DISPLAY "OK" WITH NO ADVANCING.
           STOP RUN.
       COPY prog REPLACING ==:PROG-NAME:== BY ==nested_init==
                           ==:PROG-KIND:== BY ==INITIAL==.
       COPY prog REPLACING ==:PROG-NAME:== BY ==nested_noninit==
                           ==:PROG-KIND:== BY ====.
       END PROGRAM prog.
       COPY prog REPLACING ==:PROG-NAME:== BY ==nonnested_init==
                           ==:PROG-KIND:== BY ==INITIAL==.
       COPY prog REPLACING ==:PROG-NAME:== BY ==nonnested_noninit==
                           ==:PROG-KIND:== BY ====.
])

AT_CHECK([$COMPILE_MODULE prog.cob], [0], [], [])
AT_CHECK([$COBCRUN prog], [0], [OKOKOKOKOK], [])
AT_CLEANUP


AT_SETUP([run profiling])
AT_KEYWORDS([cobc profiling])

AT_DATA([prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID.    prog.
        PROCEDURE      DIVISION.
        1ST SECTION.
        PARA-0001.
            PERFORM PARA-0003.
        PARA-0002.
            CONTINUE.
        PARA-0003.
            GO TO 2ND.
        PARA-0004.
            CONTINUE.
        2ND SECTION.
        PARA-0005.
            PERFORM PARA-0006.
        PARA-0006.
            CONTINUE.
        PARA-0007.
            STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [],
[prog.cob: in section '1ST':
prog.cob: in paragraph 'PARA-0003':
prog.cob:11: warning: GO TO SECTION '2ND'
])

AT_CAPTURE_FILE([prof-prog.csv])

AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE='prof-$b.csv' $COBCRUN_DIRECT ./prog], [0], [], [])

AT_CHECK([$COMPILE -fprof prog.cob], [0], [],
[prog.cob: in section '1ST':
prog.cob: in paragraph 'PARA-0003':
prog.cob:11: warning: GO TO SECTION '2ND'
])

AT_CHECK([COB_PROF_ENABLE=0 COB_PROF_FILE='prof-$b.csv' $COBCRUN_DIRECT ./prog], [0], [], [])

# Specific test for $f, which is an absolute file name
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE='$f-prof.csv' $COBCRUN_DIRECT ./prog], [0], [], [ignore])
AT_CHECK([ls prog$COB_EXE_EXT-prof.csv], [0], [ignore], [])

AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE='prof-$$-$b.csv' COB_PROF_FORMAT=%i,%m,%s,%p,%e,%f,%l,%w,%k,%t,%h,%n,%x $COBCRUN_DIRECT ./prog], [0], [],
[File prof-123456-prog.csv generated
])

# note: The time here is actually the number of times the procedure has
# been run, to avoid any indeterminism in the running time of the
# procedure.

AT_CHECK([cat prof-123456-prog.csv], [0],
[pid,program-id,section,paragraph,entry,file,line,location,kind,time-ns,time,ncalls,%x
123456,prog,,,,prog.cob,4,prog.cob:4,PROGRAM,13000000,0.013 s,1,%x
123456,prog,1ST,,,prog.cob,5,prog.cob:5,SECTION,12000000,0.012 s,1,%x
123456,prog,1ST,PARA-0001,,prog.cob,6,prog.cob:6,PARAGRAPH,11000000,0.011 s,1,%x
123456,prog,1ST,PARA-0002,,prog.cob,8,prog.cob:8,PARAGRAPH,0,0.000 s,0,%x
123456,prog,1ST,PARA-0003,,prog.cob,10,prog.cob:10,PARAGRAPH,1000000,0.001 s,1,%x
123456,prog,1ST,PARA-0004,,prog.cob,12,prog.cob:12,PARAGRAPH,0,0.000 s,0,%x
123456,prog,2ND,,,prog.cob,14,prog.cob:14,SECTION,6000000,0.006 s,1,%x
123456,prog,2ND,PARA-0005,,prog.cob,15,prog.cob:15,PARAGRAPH,3000000,0.003 s,1,%x
123456,prog,2ND,PARA-0006,,prog.cob,17,prog.cob:17,PARAGRAPH,2000000,0.002 s,2,%x
123456,prog,2ND,PARA-0007,,prog.cob,19,prog.cob:19,PARAGRAPH,1000000,0.001 s,1,%x
])

AT_CLEANUP


AT_SETUP([run profiling with no paragraph/section names])
AT_KEYWORDS([cobc profiling])

AT_DATA([prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID.    prog.
        PROCEDURE      DIVISION.
          DISPLAY "HELLO".
          DISPLAY "WORLD".
])

AT_CHECK([$COMPILE -fprof prog.cob])

AT_CAPTURE_FILE([prof.csv])
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog], [0], [HELLO
WORLD
],
[File prof.csv generated
])

AT_CHECK([cat prof.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog,,,,prog.cob:4,PROGRAM,3000000,0.003 s,1
prog,MAIN SECTION,,,prog.cob:5,SECTION,1000000,0.001 s,1
prog,MAIN SECTION,MAIN PARAGRAPH,,prog.cob:5,PARAGRAPH,1000000,0.001 s,1
])

AT_CLEANUP


AT_SETUP([run profiling with no section names])
AT_KEYWORDS([cobc profiling])

AT_DATA([prog.cob], [
        IDENTIFICATION DIVISION.
        PROGRAM-ID.    prog.
        PROCEDURE      DIVISION.
        1ST.
          DISPLAY "HELLO".
        2ND.
          DISPLAY "WORLD".
])

AT_CHECK([$COMPILE -fprof prog.cob])

AT_CAPTURE_FILE([prof.csv])
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog], [0], [HELLO
WORLD
],
[File prof.csv generated
])

AT_CHECK([cat prof.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog,,,,prog.cob:4,PROGRAM,5000000,0.005 s,1
prog,MAIN SECTION,,,prog.cob:5,SECTION,2000000,0.002 s,1
prog,MAIN SECTION,1ST,,prog.cob:5,PARAGRAPH,1000000,0.001 s,1
prog,MAIN SECTION,2ND,,prog.cob:7,PARAGRAPH,1000000,0.001 s,1
])

AT_CLEANUP


AT_SETUP([profiling depth overflow])
AT_KEYWORDS([cobc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       PROCEDURE DIVISION.
       MAIN.
          PERFORM PARA.
          STOP RUN.
       PARA.
          DISPLAY "OK" WITH NO ADVANCING.
])

AT_CHECK([$COMPILE -fprof prog.cob])

AT_CHECK([COB_PROF_MAX_DEPTH=2 COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog], [0], [OK],
[libcob: prog.cob:8: warning: [[cob_prof]] Profiling overflow at 2 calls, aborting profiling.
libcob: prog.cob:8: warning:   Last 10 calls on stack:
libcob: prog.cob:8: warning:   * MAIN at prog.cob:5
libcob: prog.cob:8: warning:   * prog at prog.cob:4
])

AT_CLEANUP


AT_SETUP([run profiling with recursion, entries and CALL])
AT_KEYWORDS([cobc])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog RECURSIVE.
       PROCEDURE DIVISION.
          DISPLAY "HELLO WORLD".
          CALL "entry".
          GOBACK.
          ENTRY "entry".
          CALL "inside-program".
       PROGRAM-ID. inside-program.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 COUNTER PIC 9(4).
       PROCEDURE DIVISION.
       MAIN SECTION.
           MOVE 100 TO COUNTER.
       INSIDE SECTION.
           PERFORM ITER.
           EXIT SECTION.
       ITER.
           IF COUNTER = 0
             DISPLAY "end iter"
             EXIT PARAGRAPH.
           SUBTRACT 1 FROM COUNTER.
           PERFORM INSIDE.
       END PROGRAM inside-program.
       END PROGRAM prog.
])

AT_CHECK([$COMPILE -fprof prog.cob])

AT_CAPTURE_FILE([prof.csv])
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog], [0],
[HELLO WORLD
end iter
],
[File prof.csv generated
])

AT_CHECK([cat prof.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
inside-program,,,,prog.cob:14,PROGRAM,407000000,0.407 s,1
inside-program,MAIN,,,prog.cob:15,SECTION,1000000,0.001 s,1
inside-program,MAIN,MAIN PARAGRAPH,,prog.cob:15,PARAGRAPH,1000000,0.001 s,1
inside-program,INSIDE,,,prog.cob:17,SECTION,804000000,0.804 s,101
inside-program,INSIDE,MAIN PARAGRAPH,,prog.cob:17,PARAGRAPH,403000000,0.403 s,101
inside-program,INSIDE,ITER,,prog.cob:20,PARAGRAPH,401000000,0.401 s,101
prog,,,,prog.cob:4,PROGRAM,419000000,0.419 s,2
prog,MAIN SECTION,,,prog.cob:5,SECTION,417000000,0.417 s,1
prog,MAIN SECTION,MAIN PARAGRAPH,,prog.cob:5,PARAGRAPH,417000000,0.417 s,2
prog,MAIN SECTION,MAIN PARAGRAPH,entry,prog.cob:6,CALL,415000000,0.415 s,1
prog,MAIN SECTION,MAIN PARAGRAPH,entry,prog.cob:8,ENTRY,0,0.000 s,1
prog,MAIN SECTION,MAIN PARAGRAPH,inside-program,prog.cob:9,CALL,409000000,0.409 s,1
])

AT_CLEANUP


AT_SETUP([profiling two modules with CALL])
AT_KEYWORDS([cobc])

AT_DATA([prog1.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog1.
       DATA DIVISION.
       LOCAL-STORAGE SECTION.
       01 COUNTER PIC 9(4).
       01 PARAM PIC 9.
       01 CALL-NAME PIC X(10).
       PROCEDURE DIVISION.
      *>PROG.  test the non-standard "no main paragraph, but
      *>       later using one" for its expected profiling output
           MOVE 'prog2' TO CALL-NAME.
           PERFORM CALL-PROG2
              VARYING COUNTER FROM 0 BY 1
              UNTIL COUNTER = 300.
           GOBACK.
       CALL-PROG2.
           MOVE 1 TO PARAM.
           CALL "prog2" USING PARAM.
           MOVE 2 TO PARAM.
           CALL CALL-NAME USING PARAM.
       END PROGRAM prog1.
])
AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog2.
       DATA DIVISION.
       LINKAGE SECTION.
       01 PARAM PIC 9.
       PROCEDURE DIVISION USING PARAM.
       DISPLAYER SECTION.
           IF PARAM = 1
              DISPLAY "X" NO ADVANCING
           ELSE
              PERFORM OTHER-DISPLAY.
           GOBACK.
       OTHER-DISPLAY SECTION.
           DISPLAY "Y" NO ADVANCING.
       END PROGRAM prog2.
])

AT_CHECK([$COMPILE -fprof prog1.cob])
AT_CHECK([$COMPILE_MODULE prog2.cob])

AT_CAPTURE_FILE([prof.csv])
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog1], [0],
[XYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXY],
[File prof.csv generated
])

AT_CHECK([cat prof.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog1,,,,prog1.cob:9,PROGRAM,1803000000,1.803 s,1
prog1,MAIN SECTION,,,prog1.cob:12,SECTION,3301000000,3.301 s,1
prog1,MAIN SECTION,MAIN PARAGRAPH,,prog1.cob:12,PARAGRAPH,1801000000,1.801 s,1
prog1,MAIN SECTION,CALL-PROG2,,prog1.cob:17,PARAGRAPH,1500000000,1.500 s,300
prog1,MAIN SECTION,CALL-PROG2,prog2,prog1.cob:19,CALL,300000000,0.300 s,300
prog1,MAIN SECTION,CALL-PROG2,(dynamic),prog1.cob:21,CALL,300000000,0.300 s,300
])

# same name sometimes leads to locks - especially on Win32
AT_CHECK([mv prog2.$COB_MODULE_EXT prog2.old.$COB_MODULE_EXT])
AT_CHECK([$COMPILE_MODULE -fprof prog2.cob])

AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./prog1], [0],
[XYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXYXY],
[File prof.csv generated
])

AT_CHECK([cat prof.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog2,,,,prog2.cob:7,PROGRAM,2400000000,2.400 s,600
prog2,DISPLAYER,,,prog2.cob:8,SECTION,1200000000,1.200 s,600
prog2,DISPLAYER,MAIN PARAGRAPH,,prog2.cob:8,PARAGRAPH,1200000000,1.200 s,600
prog2,OTHER-DISPLAY,,,prog2.cob:14,SECTION,300000000,0.300 s,300
prog2,OTHER-DISPLAY,MAIN PARAGRAPH,,prog2.cob:14,PARAGRAPH,300000000,0.300 s,300
prog1,,,,prog1.cob:9,PROGRAM,4803000000,4.803 s,1
prog1,MAIN SECTION,,,prog1.cob:12,SECTION,9301000000,9.301 s,1
prog1,MAIN SECTION,MAIN PARAGRAPH,,prog1.cob:12,PARAGRAPH,4801000000,4.801 s,1
prog1,MAIN SECTION,CALL-PROG2,,prog1.cob:17,PARAGRAPH,4500000000,4.500 s,300
prog1,MAIN SECTION,CALL-PROG2,prog2,prog1.cob:19,CALL,1500000000,1.500 s,300
prog1,MAIN SECTION,CALL-PROG2,(dynamic),prog1.cob:21,CALL,2100000000,2.100 s,300
])

AT_CLEANUP


AT_SETUP([profiling multiple programs])
AT_KEYWORDS([cobc])

AT_DATA([prog1.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog1.
       DATA DIVISION.
       working-storage section.
       01    os-check   pic x(7).
         88 os-is-windows-or-dos values 'WINDOWS' 'FREEDOS'.
       01  callee       pic x(8) value "./prog2".
         88 callee-wdos value ".\prog2".
       PROCEDURE DIVISION.
           accept os-check from environment "COB_ON_CYGWIN".
           if os-check = spaces
             accept os-check from environment "OS".
           if os-check = spaces
             accept os-check from environment "OS_NAME".
           inspect os-check converting "werfdosin" to "WERFDOSIN".
           if os-is-windows-or-dos
             set callee-wdos to true.
           call "SYSTEM" using callee.
           if callee = space
             call 'impossible'.
           GOBACK.
])
AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog2.
       PROCEDURE DIVISION.
       MAIN.
           SET ENVIRONMENT "COB_PROF_FILE" TO "prof2.csv"
           PERFORM PARA 5 TIMES.
           GOBACK.
       PARA.
           CONTINUE.
])
AT_CHECK([$COMPILE_MODULE -fprof prog1.cob])
AT_CHECK([$COMPILE -fprof prog2.cob])

AT_CAPTURE_FILE([prof1.csv])
AT_CAPTURE_FILE([prof2.csv])

AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof1.csv $COBCRUN prog1], [0], [],
[File prof2.csv generated
File prof1.csv generated
])

AT_CHECK([cat prof1.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog1,,,,prog1.cob:10,PROGRAM,5000000,0.005 s,1
prog1,MAIN SECTION,,,prog1.cob:11,SECTION,3000000,0.003 s,1
prog1,MAIN SECTION,MAIN PARAGRAPH,,prog1.cob:11,PARAGRAPH,3000000,0.003 s,1
prog1,MAIN SECTION,MAIN PARAGRAPH,SYSTEM,prog1.cob:19,CALL,1000000,0.001 s,1
prog1,MAIN SECTION,MAIN PARAGRAPH,impossible,prog1.cob:21,CALL,0,0.000 s,0
])

AT_CHECK([cat prof2.csv], [0],
[program-id,section,paragraph,entry,location,kind,time-ns,time,ncalls
prog2,,,,prog2.cob:4,PROGRAM,13000000,0.013 s,1
prog2,MAIN SECTION,,,prog2.cob:5,SECTION,16000000,0.016 s,1
prog2,MAIN SECTION,MAIN,,prog2.cob:5,PARAGRAPH,11000000,0.011 s,1
prog2,MAIN SECTION,PARA,,prog2.cob:9,PARAGRAPH,5000000,0.005 s,5
])

AT_CLEANUP


AT_SETUP([profiling out of test mode])
AT_KEYWORDS([cobc])

AT_DATA([caller.c], [[
#include <stdlib.h>
#include <libcob.h>

#ifndef NULL
#define NULL (void*)0
#endif

int
main (int argc, char **argv)
{
   int i;

   /* portable version from libcob */
   (void)cob_unsetenv("COB_IS_RUNNING_IN_TESTMODE");

   cob_init (argc, argv);

   for (i = 0; i < 300; ++i) {
      cob_call ("callee", 0, NULL);
   }

   cob_tidy ();

   return 0;
}
]])

AT_DATA([callee.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. callee.
       PROCEDURE DIVISION.
       MAIN.
           PERFORM PARA 5 TIMES.
           GOBACK.
       PARA.
           CONTINUE.
])

AT_CHECK([$COMPILE caller.c])
AT_CHECK([$COMPILE_MODULE -fprof callee.cob])

AT_CAPTURE_FILE([prof.csv])
AT_CHECK([COB_PROF_ENABLE=1 COB_PROF_FILE=prof.csv $COBCRUN_DIRECT ./caller], [0], [],
[File prof.csv generated
])

AT_CLEANUP


AT_SETUP([DISPLAY FLOAT])
AT_KEYWORDS([FLOAT-SHORT FLOAT-LONG COMP-1 COMP-2])

# Note: each COBOL environment has a different output format for floats;
# here we only check for internal consistency (support for other
# formats might be considered for addition if widely requested)

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 X  FLOAT-SHORT  VALUE 0.000012345.
       01 Y  FLOAT-LONG   VALUE 0.000012345.
       PROCEDURE DIVISION.
           DISPLAY X SPACE Y WITH NO ADVANCING.
           STOP RUN.
])

AT_CHECK([$COMPILE prog.cob])
AT_CHECK([$COBCRUN_DIRECT ./prog], [0], [1.2345E-5 1.2345E-5], [])

AT_CLEANUP


AT_SETUP([LOW/HIGH-VALUE when using non-native program collating sequence])
AT_KEYWORDS([LOW-VALUE HIGH-VALUE ALPHABET EBCDIC ASCII])

# See bug #948 - Comparison with HIGH-VALUE in presence of collating sequences

AT_DATA([prog0.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-custom.
       SPECIAL-NAMES.
           ALPHABET alpha-custom IS
               HIGH-VALUE QUOTE SPACE LOW-VALUE 'X'.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
      * Note: we use hex values as we want the LOW and HIGH
      * values before the collating sequence is applied
       01 RAW-LV PIC X VALUE X"00".
       01 RAW-HV PIC X VALUE X"FF".
       PROCEDURE DIVISION.
           IF NOT (RAW-HV < QUOTE) THEN
             DISPLAY "RAW-HV > QUOTE" UPON SYSERR
           END-IF.
           IF NOT (QUOTE < SPACE) THEN
             DISPLAY "QUOTE > SPACE" UPON SYSERR
           END-IF.
           IF NOT (SPACE < RAW-LV) THEN
             DISPLAY "SPACE > RAW-LV" UPON SYSERR
           END-IF.
           IF NOT (RAW-LV < "X") THEN
             DISPLAY "RAW-LV > X" UPON SYSERR
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog0.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog0], [0], [], [])

AT_DATA([prog1.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-custom.
       SPECIAL-NAMES.
           ALPHABET alpha-custom IS
               64 THRU 1
               65 THRU 192
               256 THRU 193.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")"
                   WITH NO ADVANCING.
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog1.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog1], [0],
[LOW-VALUE: 063 (064) HIGH-VALUE: 192 (193)], [])

AT_DATA([prog2.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-custom.
       SPECIAL-NAMES.
           ALPHABET alpha-custom IS
               65.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")"
                   WITH NO ADVANCING.
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE prog2.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog2], [0],
[LOW-VALUE: 064 (065) HIGH-VALUE: 255 (256)], [])

AT_DATA([prog3.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-ebcdic.
       SPECIAL-NAMES.
           ALPHABET alpha-ebcdic IS EBCDIC.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")"
                   WITH NO ADVANCING.
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -febcdic-table=ebcdic500_latin1 prog3.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog3], [0],
[LOW-VALUE: 000 (001) HIGH-VALUE: 159 (160)], [])

AT_DATA([prog4.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")"
                   WITH NO ADVANCING.
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=EBCDIC -febcdic-table=ebcdic500_latin1 prog4.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog4], [0],
[LOW-VALUE: 000 (001) HIGH-VALUE: 159 (160)], [])

AT_DATA([prog5.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog1.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-ebcdic.
       SPECIAL-NAMES.
           ALPHABET alpha-ebcdic IS EBCDIC.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "P1 LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")".
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           CALL "prog2".
           STOP RUN.
       END PROGRAM prog1.
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog2.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       OBJECT-COMPUTER. x86,
           PROGRAM COLLATING SEQUENCE IS alpha-ascii.
       SPECIAL-NAMES.
           ALPHABET alpha-ascii IS ASCII.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 LV     PIC X.
       88 IS-LV  VALUE LOW-VALUE.
       01 LV-VAL REDEFINES LV BINARY-CHAR UNSIGNED.
       01 LV-ORD PIC 999.
       01 HV     PIC X.
       88 IS-HV  VALUE HIGH-VALUE.
       01 HV-VAL REDEFINES HV BINARY-CHAR UNSIGNED.
       01 HV-ORD PIC 999.
       PROCEDURE DIVISION.
           MOVE LOW-VALUE TO LV.
           MOVE HIGH-VALUE TO HV.
           MOVE FUNCTION ORD (LV) TO LV-ORD.
           MOVE FUNCTION ORD (HV) TO HV-ORD.
           DISPLAY "P2 LOW-VALUE: " LV-VAL " (" LV-ORD ")"
                 " HIGH-VALUE: " HV-VAL " (" HV-ORD ")"
                   WITH NO ADVANCING.
           IF NOT (LV = LOW-VALUE AND IS-LV)
             DISPLAY "LOW-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT (HV = HIGH-VALUE AND IS-HV)
             DISPLAY "HIGH-VALUE KO" UPON SYSERR
           END-IF.
           IF NOT ("X" > LOW-VALUE AND "X" > LV)
              DISPLAY "X < LOW-VALUE" UPON SYSERR
           END-IF.
           IF NOT ("X" < HIGH-VALUE AND "X" < HV)
              DISPLAY "X > HIGH-VALUE" UPON SYSERR
           END-IF.
           STOP RUN.
       END PROGRAM prog2.
])

AT_CHECK([$COMPILE -febcdic-table=ebcdic500_latin1 prog5.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog5], [0],
[P1 LOW-VALUE: 000 (001) HIGH-VALUE: 159 (160)
P2 LOW-VALUE: 000 (001) HIGH-VALUE: 255 (256)], [])

AT_DATA([prog6.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
       01 IND PIC 9(02).
       01 ENDX PIC X(01).
       PROCEDURE DIVISION.
           INITIALIZE ENDX.
           PERFORM VARYING IND FROM 1 BY 1 UNTIL ENDX = HIGH-VALUE
              DISPLAY IND " " WITH NO ADVANCING
              IF IND = 9
                 MOVE HIGH-VALUE TO ENDX
              END-IF
           END-PERFORM.
           STOP RUN.
])

AT_CHECK([$COMPILE -fdefault-colseq=EBCDIC -febcdic-table=ebcdic500_latin1 prog6.cob], [0], [], [])
AT_CHECK([$COBCRUN_DIRECT ./prog6], [0],
[01 02 03 04 05 06 07 08 09 ], [])

AT_CLEANUP
